<?php
/* 
 * Generated by CRUDigniter v3.2 
 * www.crudigniter.com
 */
 
class Orden_trabajo_model extends CI_Model
{
    function __construct()
    {
        parent::__construct();
    }
    
    /*
     * Get orden_trabajo by orden_trabajo_id
     */
    function get_orden_trabajo($orden_trabajo_id)
    {
        return $this->db->get_where('orden_trabajo',array('orden_trabajo_id'=>$orden_trabajo_id))->row_array();
    }
       function get_orden_trabajo_usuario($usuario_id)
    {
        return $this->db->get_where('usuario',array('usuario_id'=>$usuario_id))->row_array();
    }   
    /*
     * Get all orden_trabajo
     */
     function la_orden_trabajo($ordentrabajo_id)
    {
         
        $orden_trabajo = $this->db->query("
            SELECT
                c.*, u.*, cli.*

            FROM
                orden_trabajo c, usuario u, cliente cli
            WHERE
                c.usuario_id = u.usuario_id and 
                c.cliente_id = cli.cliente_id and
                c.orden_id = ".$ordentrabajo_id."
          

        ")->row_array();

        return $orden_trabajo;
    }

    function get_all_orden_trabajo_100()
    {
         
        $orden_trabajo = $this->db->query("
            SELECT
                c.*, u.*, cli.cliente_nombre

            FROM
                orden_trabajo c, usuario u, cliente cli
            WHERE
                c.usuario_id = u.usuario_id and 
                c.cliente_id = cli.cliente_id
               
            ORDER BY `orden_id` DESC limit 1000

        ")->result_array();

        return $orden_trabajo;
    }

    function buscar_orden_trabajo($parametro)
    {
         
        $orden_trabajo = $this->db->query("
            SELECT
                c.*, u.usuario_nombre, cli.cliente_nombre, v.venta_id, e.estado_id

            FROM
                orden_trabajo c
            LEFT JOIN usuario u on c.usuario_id = u.usuario_id
            LEFT JOIN cliente cli on c.cliente_id = cli.cliente_id 
            LEFT JOIN venta v on c.orden_id=v.orden_id
            LEFT JOIN estado e on c.estado_id=e.estado_id
            WHERE
                 1=1
         
                ".$parametro."
               
            ORDER BY `orden_id` DESC 

        ")->result_array();

        return $orden_trabajo;
    }
   
function get_all_tipo_orden()
    {
         
        $orden_trabajo = $this->db->query("
            SELECT
                *

            FROM
                tipo_orden
         
            ORDER BY `tipoorden_id` ASC 

        ")->result_array();

        return $orden_trabajo;
    }     

 function detalle_ordentrabajo($orden_id)
    {
        $sql = "SELECT d.*, p.*, t.* from detalle_orden d, inventario p, tipo_orden t
               where d.producto_id=p.producto_id and d.orden_id = ".$orden_id." and d.tipoorden_id=t.tipoorden_id 
               order by d.detalleorden_id ASC";
        $result = $this->db->query($sql)->result_array();
        return $result;        
    }       
    /*
     * function to add new orden_trabajo
     */
 function get_detalle_orden_trabajo($usuario_id)
    {
        $sql = "SELECT d.*, p.*, t.* from detalle_orden d, inventario p, tipo_orden t
               where d.producto_id=p.producto_id and d.tipoorden_id=t.tipoorden_id and d.usuario_id = ".$usuario_id." and d.orden_id is null
               order by d.detalleorden_id ASC";
        $result = $this->db->query($sql)->result_array();
        return $result;        
    } 

  

 function crear_orden_trabajo($usuario_id)
    {
        $usuario_id = 1;
        $orden_trabajo_fechahora = "'".date("Y-m-d   H:i:s")."'";
        
        $sql = "insert into orden_trabajo(orden_trabajo_fecha) ".
                "value(".$orden_trabajo_fechahora.")";
        $orden_trabajo = $this->db->query($sql);
        $orden_trabajo_id = $this->db->insert_id();
        return $orden_trabajo_id;        
        
    }

     function normalize_date($date)
    {
        if (!empty($date)) {
            return implode("-", array_reverse(explode("/", $date)));            
        }
        else{
            return "2000-01-01";
        }

    }
    function buscar_cliente($nit)
    {

        $sql = "select * from cliente where cliente_nit = ".$nit." or cliente_ci=".$nit." or cliente_codigo=".$nit;        
        $resultado = $this->db->query($sql)->result_array();
        
        return $resultado;
    }

    function add_orden_trabajo($params)
    {
        $this->db->insert('orden_trabajo',$params);
        return $this->db->insert_id();
    }
    
    /*
     * function to update orden_trabajo
     */
    function update_orden_trabajo($orden_id,$params)
    {
        $this->db->where('orden_id',$orden_id);
        return $this->db->update('orden_trabajo',$params);
    }
    
    function ejecutar($sql)
    {
        $orden_trabajo = $this->db->query($sql);
        return $orden_trabajo;
        
    }
    /*
     * function to delete orden_trabajo
     */
    function delete_orden_trabajo($orden_trabajo_id)
    {
        return $this->db->delete('orden_trabajo',array('orden_trabajo_id'=>$orden_trabajo_id));
    }

    /*
     * function mostrar las ordenes en estado pendientes
     */
    function ordenes_pendientes($condicion)
    {
        $sql = "select o.*,   c.cliente_id,
                c.tipocliente_id,
                c.categoriaclie_id,
                c.cliente_codigo,
                c.cliente_nombre,
                c.cliente_ci,
                c.cliente_direccion,
                c.cliente_telefono,
                c.cliente_celular,
                c.cliente_foto,
                c.cliente_email,
                c.cliente_nombrenegocio,
                c.cliente_aniversario,
                c.cliente_latitud,
                c.cliente_longitud,
                c.cliente_nit,
                c.cliente_razon,
                c.cliente_departamento,
                c.zona_id,
                c.lun,
                c.mar,
                c.mie,
                c.jue,
                c.vie,
                c.sab,
                c.dom,
                e.estado_descripcion, e.estado_color, u.usuario_nombre, u.usuario_imagen
                from
                  orden_trabajo o

                left join cliente c on c.cliente_id = o.cliente_id
                left join estado e on e.estado_id = o.estado_id
                left join usuario u on u.usuario_id = o.usuario_id

                WHERE
                  o.estado_id = 17".$condicion;
        $result = $this->db->query($sql)->result_array();
        
        return $result;
    }
}
