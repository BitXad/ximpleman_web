<?php
/* 
 * Generated by CRUDigniter v3.2 
 * www.crudigniter.com
 */
 
class Objetivo_model extends CI_Model{
    function __construct()
    {
        parent::__construct();
    }

    /*
    *   Obtener objetivos de un usuario
    */
    function get_objetivo($usuario_id){
        $objetivo = $this->db->query( 
            "SELECT * 
            FROM objetivo
            WHERE usuario_id = ".$usuario_id."
            ")->row_array();
        return $objetivo;
    }
    /*
    * Obtener todos los usuarios con objetivos
    */
    function get_usuarios_objetivos(){
        // $usuarios_obejetivo = $this->db->query(
        //     "SELECT u.usuario_nombre, u.`usuario_imagen`, aux.`tipousuario_descripcion`, e.`estado_color`, e.estado_descripcion, o.*
        //     FROM `objetivo` AS o
        //     LEFT JOIN usuario AS u ON o.usuario_id = u.`usuario_id`
        //     LEFT JOIN estado AS e ON o.`estado_id` = e.estado_id
        //     LEFT JOIN (
        //         SELECT u.`usuario_id`, t.tipousuario_descripcion 
        //         FROM usuario AS u, tipo_usuario AS t
        //         WHERE u.`tipousuario_id` = t.`tipousuario_id`
        //     ) AS aux ON o.`usuario_id` = aux.usuario_id
        //     WHERE o.`usuario_id` = u.usuario_id
        //     ORDER BY u.usuario_nombre ASC"
        // )->result_array();
        $usuarios_obejetivo = $this->db->query(
            "SELECT o.usuario_id, u.usuario_nombre
            FROM objetivo AS o, usuario as u
            WHERE o.`usuario_id` = u.usuario_id"
        )->result_array();
        return $usuarios_obejetivo;
    }
    /*
    * Obtener todos los usuarios que no tienen objetivo
    */
    function get_usuarios_sin_objetivos(){
        $usuarios_sin_obejtivos = $this->db->query(
            "SELECT  u.usuario_id ,u.`usuario_nombre`,u.`usuario_imagen`, t.`tipousuario_descripcion`, e.*, o.`objetivo_aceptable`,
                    o.`objetivo_diario`,o.`objetivo_mes`,o.`objetivo_minimo`, o.`objetivo_pedido`, o.`objetivo_pedido_mes`
            FROM usuario AS u
            LEFT JOIN estado AS e ON u.`estado_id` = e.`estado_id`
            LEFT JOIN tipo_usuario AS t ON t.`tipousuario_id` = u.`tipousuario_id`
            LEFT JOIN objetivo AS o ON o.usuario_id = u.usuario_id
            where u.usuario_id not in (SELECT u.`usuario_id`
            FROM usuario AS u
            LEFT JOIN objetivo AS o ON o.usuario_id = u.usuario_id
            LEFT JOIN estado AS e ON u.`estado_id` = e.`estado_id`
            LEFT JOIN tipo_usuario AS t ON t.`tipousuario_id` = u.`tipousuario_id`
            where o.`usuario_id` = u.`usuario_id`) 
            AND e.`estado_id` = 1
            ORDER BY u.usuario_nombre ASC"
        )->result_array();
        return $usuarios_sin_obejtivos;
    }
    /*
    * AÃ±adir o asignar objetivo a usuario
    */
    function add_objetivo($params) {
        $this->db->insert('objetivo',$params);
        return $this->db->insert_id();  
    }
    /*
    * Obtener los objetivos de un usuario
    */
    function get_objetivo_usuario($objetivo_id){
        $objetivo_user = $this->db->query(
            "SELECT o.*, u.usuario_nombre
            FROM objetivo as o, usuario as u
            WHERE o.`usuario_id` = u.`usuario_id`
            AND objetivo_id = ".$objetivo_id.""
        )->row_array();
        return $objetivo_user;
    }
    /*
    * Actualizar objetivo de usuario
    */
    function update_objetivo($objetivo_id,$params)
    {
        $this->db->where('objetivo_id',$objetivo_id);
        return $this->db->update('objetivo',$params);
    }
    /*
    * Obtener la cantidad en Bs de las ventas realizadas en el mes
    */
    function get_ventas_mes(){
        $sql_ventas_mes = "SELECT u.`usuario_nombre`,u.`usuario_imagen`, t.`tipousuario_descripcion`, e.*, o.`objetivo_minimo`,
                                o.`objetivo_aceptable`,o.`objetivo_diario`,o.`objetivo_mes`, SUM(d.detalleven_total) AS total
                        FROM usuario AS u
                        LEFT JOIN objetivo AS o ON o.usuario_id = u.usuario_id
                        LEFT JOIN estado AS e ON u.`estado_id` = e.`estado_id`
                        LEFT JOIN tipo_usuario AS t ON t.`tipousuario_id` = u.`tipousuario_id`
                        LEFT JOIN detalle_venta AS d ON d.`usuario_id` = u.`usuario_id`
                        LEFT JOIN venta AS v ON v.`usuario_id`=o.usuario_id
                        WHERE o.usuario_id = u.usuario_id AND
                        v.venta_id = d.venta_id AND 
                        v.venta_fecha >= '".$fecha_inicial."' AND 
                        v.venta_fecha <= '".$fecha_final."' AND
                        v.usuario_id = u.usuario_id
                        GROUP BY u.usuario_nombre 
                        ORDER BY u.usuario_nombre
                    ";
        $ventas_mes = $this->db->query($sql_ventas)->result_array();
        return $ventas_mes;
    }
    /*
    * Obtener la cantidad en Bs de las ventas realizadas en el dia
    */
    function get_ventas_dia(){
        $sql_ventas_dia = "SELECT sum(d.detalleven_total) AS total, u.usuario_nombre, u.usuario_id
        FROM usuario AS u
        LEFT JOIN objetivo AS o ON o.usuario_id = u.usuario_id
        LEFT JOIN detalle_venta AS d ON u.`usuario_id` = d.`usuario_id`
        LEFT JOIN venta AS v ON u.usuario_id = v.usuario_id
        WHERE o.usuario_id = u.usuario_id AND
        v.venta_id = d.venta_id AND 
        v.venta_fecha >= '2020-12-10' AND 
        v.usuario_id = u.usuario_id
        GROUP BY u.usuario_nombre 
        order by u.usuario_nombre
        ";
        $ventas_dia = $this->db->query($sql_ventas_dia)->result_array();
        return $ventas_dia;
    }
    /*
    * Obtener la cantidad de pedidos realizados del mes
    */
    function get_pedidos_mes(){
        $sql_pedidos_mes = "SELECT if(count(p.`venta_total`)>0,COUNT(p.`venta_total`),0) as pedido_mes, u.usuario_nombre,u.usuario_id
                            FROM venta p
                            LEFT JOIN cliente as c on p.cliente_id = c.cliente_id
                            LEFT JOIN usuario as u on p.entrega_usuarioid = u.usuario_id
                            WHERE  p.entrega_id = 2
                            AND venta_fecha >= '".$fecha_inicial."'
                            AND venta_fecha <= '".$fecha_final."'
                            group by u.`usuario_nombre`
                            order by u.usuario_nombre";
        
        $pedidos_mes = $this->db->query($sql_pedidos_mes)->result_array();
        return $pedidos_mes;
    }
    /*
    * Obtener la cantidad de pedidos realizados del dia
    */
    function get_pedidios_dia(){
        $sql_pedidos_dia = "SELECT if(count(p.`venta_total`)>0,COUNT(p.`venta_total`),0) as pedido_mes, u.usuario_nombre,u.usuario_id
                            FROM venta p
                            LEFT JOIN cliente as c on  p.cliente_id = c.cliente_id
                            LEFT JOIN usuario as u on p.entrega_usuarioid = u.usuario_id
                            WHERE p.entrega_id = 2
                            AND venta_fecha = '2020-12-10'
                            group by u.`usuario_nombre`
                            order by u.usuario_nombre
                            ";
        $pedidos_mes = $this->db->query($sql_pedidos_dia)->result_array();
        return $pedios_mes;
    }

}