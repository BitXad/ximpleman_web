<?php
/* 
 * Generated by CRUDigniter v3.2 
 * www.crudigniter.com
 */
 
class Pensionados_model extends CI_Model
{
    private $session_data = "";
    function __construct()
    {
        parent::__construct();
        
        if ($this->session->userdata('logged_in')) {
            $this->session_data = $this->session->userdata('logged_in');
        }
    }
    
    /*
     * Get promocion by promocion_id
     */
    function get_pensionados($promocion_id)
    {
        $promocion = $this->db->query("
                SELECT 
                  p.*, t.producto_nombre
                FROM
                  promocion p

                LEFT JOIN 
                producto t on t.producto_id = p.producto_id

                WHERE
                promocion_id = ".$promocion_id."
        ",array($promocion_id))->row_array();

        return $promocion;
    }
    
    /*
     * Get all promocion count
     */
    function get_all_pensionados_count()
    {
        $promocion = $this->db->query("
            SELECT
                count(*) as count

            FROM
                `promocion`
        ")->row_array();

        return $promocion['count'];
    }
        
    /*
     * Get all promocion
     */
//    function get_all_pensionados($params = array())
//    {
//        $limit_condition = "";
//        if(isset($params) && !empty($params))
//            $limit_condition = " LIMIT " . $params['offset'] . "," . $params['limit'];
//        
//        $promocion = $this->db->query("
//                SELECT p.*, e.`estado_tipo`,e.`estado_descripcion`,e.`estado_color`,
//                pr.*
//
//                FROM promocion p
//                LEFT JOIN producto pr on pr.producto_id = p.producto_id
//                LEFT JOIN estado e on e.estado_id = p.estado_id
//
//                /*WHERE p.estado_id = 1       */
//                ORDER BY
//                  p.promocion_id DESC
//        ")->result_array();
//
//        return $promocion;
//    }
        
    /*
     * function to add new promocion
     */
    function add_pensionados($params)
    {
        $this->db->insert('promocion',$params);
        return $this->db->insert_id();
    }
    
    /*
     * function to update promocion
     */
    function update_pensionados($promocion_id,$params)
    {
        $this->db->where('promocion_id',$promocion_id);
        return $this->db->update('promocion',$params);
    }
    
    /*
     * function to delete promocion
     */
    function delete_pensionados($promocion_id)
    {
        return $this->db->delete('promocion',array('promocion_id'=>$promocion_id));
    }
    
    /*
     * function to delete promocion
     */
    function get_detalle_pensionados($promocion_id)
    {
        $sql =  "select * from conspromocion where 
                 promocion_id = ".$promocion_id;
        return $this->db->query($sql)->result_array(); 
    }

    /*
     * ejecutar consulta
     */
    function ejecutar($sql)
    {
        $this->db->query($sql);
        return true;
    }
    
    /*
     * Consultar
     */
    function consultar($sql)
    {
        $resultado = $this->db->query($sql)->result_array();
        return $resultado;
    }
    
    /*
     * promociones
     */
    function get_all_pensionados()
    {
        $sql =  "SELECT *
                FROM pensionado p, cliente c, forma_pago f, tipo_transaccion t, estado e
                where
                p.estado_id = 1 and
                p.cliente_id = c.cliente_id and
                p.forma_id = f.forma_id and
                p.tipotrans_id = t.tipotrans_id and
                p.estado_id = e.estado_id";
        return $this->db->query($sql)->result_array(); 
    }
    
    function get_all_detallepensionados()
    {
        $sql =  "SELECT  d.*, pr.producto_nombre, pr.producto_unidad, pr.producto_precio, pr.producto_codigobarra  
                FROM detalle_pensionado d, pensionado p, producto pr
                WHERE p.pensionado_id = d.pensionado_id AND d.producto_id = pr.producto_id";
        return $this->db->query($sql)->result_array(); 
    }
    
    
    function get_all_productos($categoria_id)
    {
        $sql =  "select * from inventario where categoria_id = {$categoria_id}";
        return $this->db->query($sql)->result_array(); 
    }
    
    function get_despachos_dia()
    {
        $sql =  "SELECT cl.cliente_nombre, cl.cliente_ci, c.*, e.estado_descripcion from consumo c, pensionado p, cliente cl, estado e
                where c.consumo_fecha = date(now()) and c.pensionado_id=p.pensionado_id and p.cliente_id = cl.cliente_id and c.estado_id = e.estado_id";
        return $this->db->query($sql)->result_array(); 
    }
    
    function generar_orden($pensionado_id){
        
        $usuario_id = $this->session_data['usuario_id'];
        
        /*
         * estado_id	estado_descripcion	estado_tipo	estado_color
        28	EN PROCESO	3	ffff00
        16	CREDITO	3	1fc4ae
        7	ENTREGADO	3	3e98f9
        6	TERMINADO	3	a781ee
        5	PENDIENTE	3	ffea00
        4	ANULADO	3	666666
         * 
         */
       
        //1. Registrar consumo
        
        $categoria_id = 16; //categoria de productos pensionados
        $consumo_fecha = "date(now())";
        $consumo_hora = "time(now())";
        $consumo_total = 0;
        $tiposerv_id = 1;
        $estado_id = 1;
        
        $sql = "(select if(count(*)>0,count(*) + 1,1) as cantidad from consumo where consumo_fecha = date(now()))";
        $resultado = $this->db->query($sql)->row_array();
        $consumo_numero = $resultado["cantidad"];
        
        $sql = "insert into consumo(consumo_fecha, consumo_hora, consumo_total, pensionado_id, tiposerv_id, estado_id,usuario_id,consumo_numeromesa,consumo_numero) 
                value({$consumo_fecha}, {$consumo_hora}, {$consumo_total}, {$pensionado_id}, {$tiposerv_id}, {$estado_id},{$usuario_id},1,{$consumo_numero})";
        $this->db->query($sql);
        $consumo_id = $this->db->insert_id();
        
        /*
        $sql =  "insert into detalle_consumo(pensionado_id, estado_id, producto_id, detallecons_cantidad, detallepen_id, cliente_id,detallecons_caracteristicas, detallecons_preferencia, consumo_id, detallecons_precio, detallecons_total, detallecons_saldoanterior) 
                SELECT
                    {$pensionado_id}
                    ,5 as estado_id
                    ,pr.producto_id
                    ,1 as consumo_cantidad
                    ,d.detallepen_id
                    ,p.cliente_id
                    ,'' as detallepen_caracteristicas
                    ,'' as detallepen_preferencia
                    ,{$consumo_id}
                    ,detallepen_precio                    
                    ,detallepen_precio
                    ,detallepen_cantidad - detallepen_consumido
                    

                FROM
                  detalle_pensionado d,
                  producto pr,
                  pensionado p
                WHERE
                  p.pensionado_id = {$pensionado_id} and 
                  p.pensionado_id = d.pensionado_id and  
                  d.producto_id = pr.producto_id and 
                  d.detallepen_cantidad > d.detallepen_consumido";
        
        $this->db->query($sql);*/
        
        $sql = "select c.*, t.cliente_nombre, t.cliente_codigo, p.saldo
                from consumo c, conspensionados p, cliente t
                where 
                c.consumo_id = {$consumo_id} and
                c.pensionado_id = p.pensionado_id and
                p.cliente_id = t.cliente_id";

        $consumo =  $this->db->query($sql)->result_array();
        
        $sql = "select d.*, p.producto_nombre, p.producto_codigobarra from detalle_consumo d, producto p
                where 
                d.consumo_id = {$consumo_id} and
                d.producto_id = p.producto_id";
                
        $detalle_consumo =  $this->db->query($sql)->result_array();
        
        $sql =  "select * from inventario where categoria_id = {$categoria_id}";
        $productos_pensionados =  $this->db->query($sql)->result_array(); 
        
        $arreglo = array("consumo"=>$consumo,"detalle_consumo"=>$detalle_consumo,"productos_pensionados"=>$productos_pensionados);
        
        return $arreglo;

    }
    
    function get_consumo($consumo_id)
    {
        $sql =  "SELECT cl.cliente_nombre, cl.cliente_ci, cl.cliente_razon, c.*, e.estado_descripcion, ts.* , u.usuario_nombre 
                from consumo c, pensionado p, cliente cl, estado e, tipo_servicio ts, usuario u
                where c.pensionado_id=p.pensionado_id and p.cliente_id = cl.cliente_id and c.estado_id = e.estado_id and u.usuario_id = c.usuario_id 
                and c.tiposerv_id = ts.tiposerv_id and c.consumo_id = {$consumo_id}";
                //echo $sql;
        return $this->db->query($sql)->result_array(); 
    }
    
    function get_detalle_consumo($consumo_id)
    {
        $sql =  "select dc.*, dc.producto_codigobarra as producto_codigo, p.producto_codigobarra
                from detalle_consumo dc, producto p, estado e 
                where 
                dc.consumo_id = {$consumo_id} and dc.producto_id = p.producto_id and dc.estado_id = e.estado_id";
        return $this->db->query($sql)->result_array(); 
    }
    
    
    function registrar_item($pensionado_id, $cantidadproducto, $producto_id, $consumo_id)
    {
        
        $sql =  "insert into detalle_consumo(pensionado_id, estado_id, producto_id, producto_nombre, producto_codigobarra, detallecons_cantidad, detallepen_id, cliente_id,detallecons_caracteristicas, detallecons_preferencia, consumo_id, detallecons_precio, detallecons_total, detallecons_saldoanterior) 
                SELECT
                    {$pensionado_id} as pensionado_id
                    ,5 as estado_id
                    ,pr.producto_id
                    ,pr.producto_nombre
                    ,pr.producto_codigobarra                    
                    ,{$cantidadproducto} as consumo_cantidad
                    ,d.detallepen_id
                    ,p.cliente_id
                    ,' ' as detallepen_caracteristicas
                    ,' ' as detallepen_preferencia
                    ,{$consumo_id} as consumo_id
                    ,d.detallepen_precio                    
                    ,d.detallepen_precio
                    ,d.detallepen_cantidad - d.detallepen_consumido
                    

                FROM
                  detalle_pensionado d,
                  inventario pr,
                  pensionado p
                WHERE
                  p.pensionado_id = {$pensionado_id} and 
                  d.pensionado_id = {$pensionado_id} and 
                  pr.producto_id = {$producto_id}";
        //echo $sql;
        $this->db->query($sql);
        
        return true; 
    }
    
    function verificar_cantidad($cantidad, $pensionado_id)
    {
        
        $sql =  "select * from conspensionados where saldo>={$cantidad} and pensionado_id = {$pensionado_id}";        
        return $this->db->query($sql)->result_array(); 
    }
    
    
}

