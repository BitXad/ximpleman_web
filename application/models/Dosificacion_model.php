<?php
/* 
 * Generated by CRUDigniter v3.2 
 * www.crudigniter.com
 */
 
class Dosificacion_model extends CI_Model
{
    function __construct()
    {
        parent::__construct();
    }
    
    /*
     * Get dosificacion by dosificacion_id
     */
    function get_dosificacion($dosificacion_id)
    {
        $dosificacion = $this->db->query("
            SELECT
                *
            FROM
                `dosificacion`
            WHERE
                `dosificacion_id` = ?
        ",array($dosificacion_id))->row_array();

        return $dosificacion;
    }
    
    /*
     * Retoran la ultima dosificacion activa
     */
    function get_dosificacion_activa()
    {
        $sql = "select * from dosificacion where estado_id = 1";
        $dosificacion = $this->db->query($sql)->result_array();

        return $dosificacion;
    }

    /*
     * Retoran la ultima dosificacion activa
     */

    /*
     * Get all dosificacion count
     */
    function get_all_dosificacion_count()
    {
        $dosificacion = $this->db->query("
            SELECT
                count(*) as count

            FROM
                `dosificacion`
        ")->row_array();

        return $dosificacion['count'];
    }
        
    /*
     * Get all dosificacion
     */
    function get_all_dosificacion($params = array())
    {
        $limit_condition = "";
        if(isset($params) && !empty($params))
            $limit_condition = " LIMIT " . $params['offset'] . "," . $params['limit'];
        
        $dosificacion = $this->db->query("
            SELECT
                e.`estado_descripcion`,
                em.`empresa_nombre`, d.*

            FROM
                dosificacion d, estado e, empresa em

            WHERE
                d.estado_id = e.estado_id
                and d.empresa_id = em.empresa_id and
                d.dosificacion_fechalimite >= date(now())

            ORDER BY `dosificacion_id` DESC

            " . $limit_condition . "
        ")->result_array();

        return $dosificacion;
    }
        
    /*
     * function to add new dosificacion
     */
    function add_dosificacion($params)
    {
        $this->db->insert('dosificacion',$params);
        return $this->db->insert_id();
    }
    
    /*
     * function to update dosificacion
     */
    function update_dosificacion($dosificacion_id,$params)
    {
        $this->db->where('dosificacion_id',$dosificacion_id);
        return $this->db->update('dosificacion',$params);
    }
    
    /*
     * function to delete dosificacion
     */
    function delete_dosificacion($dosificacion_id)
    {
        return $this->db->delete('dosificacion',array('dosificacion_id'=>$dosificacion_id));
    }
    
    /*
     * Obtiene la dosificacion para notas de entrega de Servicios
     */
    function get_all_dosificacion_servicio()
    {
        $dosificacion = $this->db->query("
            SELECT
                d.`dosificacion_id`, e.`estado_descripcion`,
                em.`empresa_nombre`, d.`dosificacion_leyenda2`,
                d.`dosificacion_leyenda3`, d.`dosificacion_leyenda4`,
                d.`dosificacion_leyenda5`
            FROM
                dosificacion d, estado e, empresa em

            WHERE
                d.estado_id = e.estado_id
                and d.empresa_id = em.empresa_id
                
        ")->row_array();

        return $dosificacion;
    }
    /*
     * Obtiene la dosificacion leyenda 5
     */
    function get_dosificacion_leyenda5()
    {
        $dosificacion = $this->db->query("
            SELECT
                d.`dosificacion_leyenda5`
            FROM
                dosificacion d

            WHERE
                1 = 1
                
        ")->row_array();

        return $dosificacion;
    }
    /*
     * Obtiene la dosificacion leyenda 3
     */
    function get_dosificacion_leyenda3()
    {
        $dosificacion = $this->db->query("
            SELECT
                d.`dosificacion_leyenda3`
            FROM
                dosificacion d

            WHERE
                1 = 1
                
        ")->row_array();

        return $dosificacion;
    }
    
    /*
     * Get this dosificacion
     */
    function get_this_dosificacion()
    {
        $dosificacion = $this->db->query(
            "SELECT d.*, e.`estado_descripcion`,em.`empresa_nombre`,a.actividad_descripcion,
                    ds.docsec_codigoclasificador, ds.docsec_descripcion, tf.tipofac_descripcion
            from dosificacion d 
            left join estado e on d.estado_id = e.estado_id 
            left join empresa em on d.empresa_id = em.empresa_id
            left join actividad a on a.actividad_id = d.dosificacion_actividad
            left join tipo_factura tf on tf.tipofac_codigo = d.tipofac_codigo
            left join documento_sector ds on d.docsec_codigoclasificador = ds.docsec_codigoclasificador
            ORDER BY `dosificacion_id` DESC
        ")->row_array();

        return $dosificacion;
    }
    
    function ejecutar($sql)
    {        
        $this->db->query($sql);
        return true;
        
    }
    /**
     * Retorna todas las leyendas de las actividades que se realizen 
     */
    function get_leyendas_por_actividad($actividadPrincipal, $actividadSecundaria){
        return $this->db->query(
            "SELECT l.* 
            from leyenda l 
            where 
            (l.leyenda_codigoactividad = '$actividadPrincipal'
            or l.leyenda_codigoactividad = '$actividadSecundaria')
            order by l.leyenda_codigoactividad 
        ")->result_array();
    }
    
    /**
     * Recupera la informacion de documento_sector
     */
    function get_documento_sector(){
        return $this->db->query(
            "SELECT ds.* 
            from documento_sector ds
        ")->result_array();
    }

    function get_cuis_puntoventa($punto_venta){
        return $this->db->query(
            "SELECT max(c.cuis_codigo) as cuis_codigo
            from cuis c
            where c.tipopuntoventa_codigo = $punto_venta"
        )->row_array();
    }
}
