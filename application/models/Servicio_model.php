<?php
/* 
 * Generated by CRUDigniter v3.2 
 * www.crudigniter.com
 */
 
class Servicio_model extends CI_Model
{
    function __construct()
    {
        parent::__construct();
    }
    
    /*
     * Get servicio by servicio_id
     */
    function get_servicio($servicio_id)
    {
        $servicio = $this->db->query("
            SELECT
                s.*, u.usuario_nombre, e.usuario_nombre as entregausuario_nombre
            FROM
                `servicio` s
            left join usuario u on s.usuario_id = u.usuario_id
            left join usuario e on s.entregausuario_id = e.usuario_id
            WHERE
                s.`servicio_id` = ?
        ",array($servicio_id))->row_array();

        return $servicio;
    }
    
    function get_servicio_id($cliente_id,$servicio_id)
    {
        $sql = "select s.*, c.* from servicio s
                left join cliente c on c.cliente_id = s.cliente_id
                where servicio_id = ".$servicio_id." and c.cliente_id=".$cliente_id;
                    
        $servicio = $this->db->query($sql,array($servicio_id))->row_array();

        return $servicio;
    }

        
    /*
     * Get all servicio
     */
    function get_all_servicio()
    {
        $servicio = $this->db->query("
            SELECT
                *
            FROM
                servicio s, estado e, tipo_servicio ts, cliente c, usuario i

            WHERE
                s.estado_id = e.estado_id
                and s.tiposerv_id = ts.tiposerv_id
                and s.cliente_id = c.cliente_id
                and s.usuario_id = i.usuario_id
                

            ORDER BY `servicio_id` DESC LIMIT 50
        ")->result_array();

        return $servicio;
    }
        
    /*
     * function to add new servicio
     */
    function add_servicio($params)
    {
        $this->db->insert('servicio',$params);
        return $this->db->insert_id();
    }
    
    /*
     * function to update servicio
     */
    function update_servicio($servicio_id,$params)
    {
        $this->db->where('servicio_id',$servicio_id);
        return $this->db->update('servicio',$params);
    }
    
    /*
     * function to delete servicio
     */
    function delete_servicio($servicio_id)
    {
        return $this->db->delete('servicio',array('servicio_id'=>$servicio_id));
    }
    
    function get_busqueda_servicio_parametro($parametro)
    {
        $servicio = $this->db->query("
            SELECT
                s.*, e.estado_color, e.estado_descripcion, ts.tiposerv_descripcion,
                i.usuario_nombre, c.cliente_nombre, c.cliente_telefono, c.cliente_celular,
                c.cliente_nit, c.cliente_razon, f.factura_id,
                ds.responsable_id,
                ds.detalleserv_id, ds.detalleserv_descripcion, ds.detalleserv_glosa,
                ds.detalleserv_falla, ds.detalleserv_diagnostico, ds.detalleserv_solucion,
                ds.detalleserv_total, ds.detalleserv_acuenta, ds.detalleserv_saldo,
                ds.detalleserv_precioexterno, ds.detalleserv_detalleexterno,
                ds.detalleserv_codigo, ds.estado_id as detallestado_id, ds.servicio_id as esteservicio_id,ds.detalleserv_fpagoacuenta,
                es.estado_color as esteestado_color, es.estado_descripcion as esteestado_descripcion,
                ds.detalleserv_entregadoa, u.usuario_nombre as esteusuario_nombre, fp.forma_nombre, tt.tipotrans_nombre, b.banco_nombre
            FROM
                servicio s
            LEFT JOIN estado e on s.estado_id = e.estado_id
            LEFT JOIN tipo_servicio ts on s.tiposerv_id = ts.tiposerv_id
            LEFT JOIN cliente c on s.cliente_id = c.cliente_id
            LEFT JOIN usuario i on s.usuario_id = i.usuario_id
            LEFT JOIN factura f on s.servicio_id = f.servicio_id
            LEFT JOIN detalle_serv ds on s.servicio_id = ds.servicio_id
            LEFT JOIN estado es on ds.estado_id = es.estado_id
            LEFT JOIN usuario u on ds.responsable_id = u.usuario_id
            LEFT JOIN forma_pago fp on ds.forma_id = fp.forma_id
            LEFT JOIN tipo_transaccion tt on ds.tipotrans_id = tt.tipotrans_id
            left join banco b on ds.banco_id = b.banco_id
            WHERE
               (c.cliente_nombre like '%".$parametro."%' or s.servicio_id = '".$parametro."'
                   or e.estado_descripcion like '%".$parametro."%')
            group by ds.detalleserv_id
            ORDER BY s.servicio_id desc, ds.detalleserv_id desc 
        ")->result_array();

        return $servicio;
    }
    
    function get_busqueda_servicio_filtro($filtro)
    {
        $where = "";
        if($filtro != ""){
            $where = " WHERE ";
        }
        $servicio = $this->db->query("
            SELECT
                s.*, e.estado_color, e.estado_descripcion, ts.tiposerv_descripcion,
                i.usuario_nombre, c.cliente_nombre, c.cliente_telefono, c.cliente_celular,
                c.cliente_nit, c.cliente_razon, f.factura_id,
                ds.responsable_id,
                ds.detalleserv_id, ds.detalleserv_descripcion, ds.detalleserv_glosa,
                ds.detalleserv_falla, ds.detalleserv_diagnostico, ds.detalleserv_solucion,
                ds.detalleserv_total, ds.detalleserv_acuenta, ds.detalleserv_saldo,
                ds.detalleserv_precioexterno, ds.detalleserv_detalleexterno,
                ds.detalleserv_codigo, ds.estado_id as detallestado_id, ds.servicio_id as esteservicio_id,ds.detalleserv_fpagoacuenta,
                es.estado_color as esteestado_color, es.estado_descripcion as esteestado_descripcion,
                ds.detalleserv_entregadoa, u.usuario_nombre as esteusuario_nombre, fp.forma_nombre, tt.tipotrans_nombre
            FROM
                servicio s
            LEFT JOIN estado e on s.estado_id = e.estado_id
            LEFT JOIN tipo_servicio ts on s.tiposerv_id = ts.tiposerv_id
            LEFT JOIN cliente c on s.cliente_id = c.cliente_id
            LEFT JOIN usuario i on s.usuario_id = i.usuario_id
            LEFT JOIN factura f on s.servicio_id = f.servicio_id
            LEFT JOIN detalle_serv ds on s.servicio_id = ds.servicio_id
            LEFT JOIN estado es on ds.estado_id = es.estado_id
            LEFT JOIN usuario u on ds.responsable_id = u.usuario_id
            LEFT JOIN forma_pago fp on ds.forma_id = fp.forma_id
            LEFT JOIN tipo_transaccion tt on ds.tipotrans_id = tt.tipotrans_id
                ".$where." ".$filtro."
            group by ds.detalleserv_id
            ORDER BY s.servicio_id desc, ds.detalleserv_id desc 

        ")->result_array();

        return $servicio;
    }
    
    /*
     * Get servicio by servicio_id
     */
    function get_servicio_tiposervicio($servicio_id)
    {
        $servicio = $this->db->query("
            SELECT
                s.tiposerv_id, s.servicio_direccion, ts.tiposerv_descripcion
            FROM
                servicio s, tipo_servicio ts

            WHERE
                 s.tiposerv_id = ts.tiposerv_id
                and s.servicio_id = ?
        ",array($servicio_id))->row_array();

        return $servicio;
    }
    
    /*
     * Get all servicio de hoy!!!
     */
    function get_all_servicio_now()
    {
        $servicio = $this->db->query("
            SELECT
                *
            FROM
                servicio s, estado e, tipo_servicio ts, cliente c, usuario i

            WHERE
                s.estado_id = e.estado_id
                and s.tiposerv_id = ts.tiposerv_id
                and s.cliente_id = c.cliente_id
                and s.usuario_id = i.usuario_id
                and date(servicio_fecharecepcion) = date(now())

            ORDER BY `servicio_id` DESC LIMIT 50
        ")->result_array();

        return $servicio;
    }
    /*
     * Get all servicios pendientes!!!
     */
    function get_all_servicios_pendientes()
    {
        $servicio = $this->db->query(
            "SELECT
                s.*, e.estado_color, e.estado_descripcion, ts.tiposerv_descripcion,
                i.usuario_nombre, c.cliente_nombre, c.cliente_telefono, c.cliente_celular,
                c.cliente_nit, c.cliente_razon, f.factura_id,
                ds.responsable_id,
                ds.detalleserv_id, ds.detalleserv_descripcion, ds.detalleserv_glosa,
                ds.detalleserv_falla, ds.detalleserv_diagnostico, ds.detalleserv_solucion,
                ds.detalleserv_total, ds.detalleserv_acuenta, ds.detalleserv_saldo,
                ds.detalleserv_precioexterno, ds.detalleserv_detalleexterno,
                ds.detalleserv_codigo, ds.estado_id as detallestado_id, ds.servicio_id as esteservicio_id,ds.detalleserv_fpagoacuenta,
                es.estado_color as esteestado_color, es.estado_descripcion as esteestado_descripcion,
                ds.detalleserv_entregadoa, u.usuario_nombre as esteusuario_nombre, fp.forma_nombre, tt.tipotrans_nombre,
                b.banco_nombre,fp.forma_nombre 
            FROM
                servicio s
            LEFT JOIN estado e on s.estado_id = e.estado_id
            LEFT JOIN tipo_servicio ts on s.tiposerv_id = ts.tiposerv_id
            LEFT JOIN cliente c on s.cliente_id = c.cliente_id
            LEFT JOIN usuario i on s.usuario_id = i.usuario_id
            LEFT JOIN factura f on s.servicio_id = f.servicio_id
            LEFT JOIN detalle_serv ds on s.servicio_id = ds.servicio_id
            LEFT JOIN estado es on ds.estado_id = es.estado_id
            LEFT JOIN usuario u on ds.responsable_id = u.usuario_id
            LEFT JOIN forma_pago fp on ds.forma_id = fp.forma_id
            LEFT JOIN tipo_transaccion tt on ds.tipotrans_id = tt.tipotrans_id
            left join banco b on ds.banco_id = b.banco_id 
            WHERE
                s.estado_id = 5
            group by ds.detalleserv_id
            ORDER BY s.servicio_id desc, ds.detalleserv_id desc 
        ")->result_array();

        return $servicio;
    }
    /*
     * Get all reporte servicios HOY
     */
    function get_all_repservicios()
    {
        /*SELECT
                c.cliente_nombre, s.servicio_id, s.servicio_fecharecepcion, s.servicio_horarecepcion,
                ds.detalleserv_id, s.servicio_total, s.servicio_acuenta, s.servicio_saldo,
                ds.detalleserv_fechaterminado, ds.detalleserv_horaterminado,
                ds.detalleserv_fechaentregado, ds.detalleserv_horaentregado,
                ds.detalleserv_total, ds.detalleserv_acuenta, ds.detalleserv_saldo,
                e.estado_color, e.estado_descripcion, ts.tiposerv_descripcion, ds.detalleserv_descripcion,
                r.usuario_nombre as respusuario_nombre
                
            FROM
                detalle_serv ds
                LEFT JOIN servicio s on ds.servicio_id = s.servicio_id
                LEFT JOIN estado e on ds.estado_id = e.estado_id
                LEFT JOIN usuario r on ds.responsable_id = r.usuario_id
                LEFT JOIN cliente c on s.cliente_id = c.cliente_id
                LEFT JOIN usuario u on ds.usuario_id = u.usuario_id
                LEFT JOIN tipo_servicio ts on s.tiposerv_id = ts.tiposerv_id

            WHERE*/
        $servicio = $this->db->query("
            SELECT
                  c.cliente_nombre, s.servicio_id, s.servicio_fecharecepcion, s.servicio_horarecepcion,
                  ds.detalleserv_id, s.servicio_total, s.servicio_acuenta, s.servicio_saldo,
                  ds.detalleserv_fechaterminado, ds.detalleserv_horaterminado,
                  ds.detalleserv_fechaentregado, ds.detalleserv_horaentregado,
                  ds.detalleserv_total, ds.detalleserv_acuenta, ds.detalleserv_saldo,
                  e.estado_color, e.estado_descripcion, ts.tiposerv_descripcion, ds.detalleserv_descripcion,
                  r.usuario_nombre as respusuario_nombre, ifnull(t1.total_insumo, 0) as total_insumo,
                  ds.detalleserv_precioexterno
              FROM
                  detalle_serv ds
                  LEFT JOIN servicio s on ds.servicio_id = s.servicio_id
                  LEFT JOIN estado e on ds.estado_id = e.estado_id
                  LEFT JOIN usuario r on ds.responsable_id = r.usuario_id
                  LEFT JOIN cliente c on s.cliente_id = c.cliente_id
                  LEFT JOIN usuario u on ds.usuario_id = u.usuario_id
                  LEFT JOIN tipo_servicio ts on s.tiposerv_id = ts.tiposerv_id
                  LEFT JOIN 
                  (SELECT sum(dv.detalleven_total) as total_insumo, dv.detalleserv_id as estedetalleserv_id
                    FROM detalle_venta dv group by dv.detalleserv_id) as t1 on t1.estedetalleserv_id = ds.detalleserv_id
            WHERE
                date(s.servicio_fecharecepcion) = date(now())

            ORDER BY ds.servicio_id       
        ")->result_array();

        return $servicio;
    }
    /*
     * Get all reporte servicios con Filtro
     */
    function get_all_busquedarepservicios($filtro)
    {
        /*SELECT
                c.cliente_nombre, s.servicio_id, s.servicio_fecharecepcion, s.servicio_horarecepcion,
                ds.detalleserv_id, s.servicio_total, s.servicio_acuenta, s.servicio_saldo,
                ds.detalleserv_fechaterminado, ds.detalleserv_horaterminado,
                ds.detalleserv_fechaentregado, ds.detalleserv_horaentregado,
                ds.detalleserv_total, ds.detalleserv_acuenta, ds.detalleserv_saldo,
                e.estado_color, e.estado_descripcion, ts.tiposerv_descripcion, ds.detalleserv_descripcion,
                r.usuario_nombre as respusuario_nombre
                
            FROM
                detalle_serv ds
                LEFT JOIN servicio s on ds.servicio_id = s.servicio_id
                LEFT JOIN estado e on ds.estado_id = e.estado_id
                LEFT JOIN usuario r on ds.responsable_id = r.usuario_id
                LEFT JOIN cliente c on s.cliente_id = c.cliente_id
                LEFT JOIN usuario u on ds.usuario_id = u.usuario_id
                LEFT JOIN tipo_servicio ts on s.tiposerv_id = ts.tiposerv_id*/
        $servicio = $this->db->query("
                
            SELECT
                  c.cliente_nombre, s.servicio_id, s.servicio_fecharecepcion, s.servicio_horarecepcion,
                  ds.detalleserv_id, s.servicio_total, s.servicio_acuenta, s.servicio_saldo,
                  ds.detalleserv_fechaterminado, ds.detalleserv_horaterminado,
                  ds.detalleserv_fechaentregado, ds.detalleserv_horaentregado,
                  ds.detalleserv_total, ds.detalleserv_acuenta, ds.detalleserv_saldo,
                  e.estado_color, e.estado_descripcion, ts.tiposerv_descripcion, ds.detalleserv_descripcion,
                  r.usuario_nombre as respusuario_nombre, ifnull(t1.total_insumo, 0) as total_insumo,
                  ds.detalleserv_precioexterno
              FROM
                  detalle_serv ds
                  LEFT JOIN servicio s on ds.servicio_id = s.servicio_id
                  LEFT JOIN estado e on ds.estado_id = e.estado_id
                  LEFT JOIN usuario r on ds.responsable_id = r.usuario_id
                  LEFT JOIN cliente c on s.cliente_id = c.cliente_id
                  LEFT JOIN usuario u on ds.usuario_id = u.usuario_id
                  LEFT JOIN tipo_servicio ts on s.tiposerv_id = ts.tiposerv_id
                  LEFT JOIN 
                  (SELECT sum(dv.detalleven_total) as total_insumo, dv.detalleserv_id as estedetalleserv_id
                    FROM detalle_venta dv group by dv.detalleserv_id) as t1 on t1.estedetalleserv_id = ds.detalleserv_id
            WHERE
                 ".
                $filtro." 

            ORDER BY ds.detalleserv_fechaentregado asc, ds.detalleserv_horaentregado asc 
        ")->result_array();
        
        return $servicio;
    }
    /*
     * Get servicio by servicio_id y con su estado
     */
    function get_serviciorden_reptec($servicio_id)
    {
        $servicio = $this->db->query("
            SELECT
                s.*, e.estado_descripcion

            FROM
                servicio s, estado e

            WHERE
                 s.estado_id = e.estado_id
                 and s.servicio_id = ?
        ",array($servicio_id))->row_array();

        return $servicio;
    }
    /*
     * Get all reporte servicios con Filtro
     * se lo usa en reporte de movimiento economico de servicios diarios
     */
    function get_all_servicios_dia()
    {
        $servicio = $this->db->query("
            /*SELECT
                c.cliente_nombre, s.servicio_id, d.detalleserv_id, d.estado_id,
                s.servicio_fecharecepcion, s.servicio_horarecepcion,
                d.detalleserv_fechaterminado, d.detalleserv_horaterminado,
                d.detalleserv_fechaentregado, d.detalleserv_horaentregado,
                d.detalleserv_total, d.detalleserv_acuenta, d.detalleserv_saldo,
                d.detalleserv_precioexterno,
                e.estado_descripcion, t.tiposerv_descripcion, s.servicio_direccion,
                d.detalleserv_descripcion, r.usuario_nombre as respnombre,
                p.producto_nombre, dv.detalleven_total as precioinsumo
                
            FROM
                servicio s
            LEFT JOIN cliente c on s.cliente_id = c.cliente_id
            LEFT JOIN detalle_serv d on s.servicio_id = d.servicio_id
            LEFT JOIN estado e on s.estado_id = e.estado_id
            LEFT JOIN tipo_servicio t on s.tiposerv_id = t.tiposerv_id
            LEFT JOIN usuario r on d.responsable_id = r.usuario_id
            LEFT JOIN detalle_venta dv on d.detalleserv_id = dv.detalleserv_id
            LEFT JOIN producto p on dv.producto_id = p.producto_id
           WHERE
                
                 (date(s.servicio_fecharecepcion) = date(NOW())
                 or date(d.detalleserv_fechaentregado) = date(NOW()))
                 and (d.estado_id = 5 or d.estado_id = 7)*/
                 
            SELECT
                  c.cliente_nombre, s.servicio_id, ds.detalleserv_id, ds.estado_id,
                s.servicio_fecharecepcion, s.servicio_horarecepcion,
                ds.detalleserv_fechaterminado, ds.detalleserv_horaterminado,
                ds.detalleserv_fechaentregado, ds.detalleserv_horaentregado,
                ds.detalleserv_total, ds.detalleserv_acuenta, ds.detalleserv_saldo,
                e.estado_descripcion, ts.tiposerv_descripcion, s.servicio_direccion,
                ds.detalleserv_descripcion, r.usuario_nombre as respnombre,
                ifnull(t1.total_insumo, 0) as total_insumo,
                ds.detalleserv_precioexterno
              FROM
                  detalle_serv ds
                  LEFT JOIN servicio s on ds.servicio_id = s.servicio_id
                  LEFT JOIN estado e on ds.estado_id = e.estado_id
                  LEFT JOIN usuario r on ds.responsable_id = r.usuario_id
                  LEFT JOIN cliente c on s.cliente_id = c.cliente_id
                  LEFT JOIN usuario u on ds.usuario_id = u.usuario_id
                  LEFT JOIN tipo_servicio ts on s.tiposerv_id = ts.tiposerv_id
                  LEFT JOIN 
                  (SELECT sum(dv.detalleven_total) as total_insumo, dv.detalleserv_id as estedetalleserv_id
                    FROM detalle_venta dv group by dv.detalleserv_id) as t1 on t1.estedetalleserv_id = ds.detalleserv_id
                WHERE
                 (date(s.servicio_fecharecepcion) = date(NOW())
                 or date(ds.detalleserv_fechaentregado) = date(NOW()))
                 and (ds.estado_id = 5 or ds.estado_id = 7)
        ")->result_array();
        
        return $servicio;
    }
    function get_busqueda_infservicio_parametro($parametro)
    {
        $servicio = $this->db->query("
            
            SELECT
                s.*, e.estado_color, e.estado_descripcion, ts.tiposerv_descripcion,
                u.usuario_nombre, c.cliente_nombre
            FROM
                servicio s, estado e, tipo_servicio ts, cliente c, usuario u

            WHERE
                s.estado_id = e.estado_id
                and(c.cliente_nombre like '%".$parametro."%' or s.servicio_id like '%".$parametro."%'
                   or e.estado_descripcion like '%".$parametro."%')
                and s.tiposerv_id = ts.tiposerv_id
                and s.cliente_id = c.cliente_id
                and s.usuario_id = u.usuario_id

            GROUP BY
                s.servicio_id 
              ORDER By s.servicio_id desc
        ")->result_array();

        return $servicio;
    }
    
    /* muestra detalles de servicio dado una llave unica */
    function get_servicio_fromcodigo($codigo)
    {
        $servicio = $this->db->query("
            select
                d.*, s.servicio_fecharecepcion, s.servicio_horarecepcion, u.usuario_nombre,
                c.cliente_nombre, s.servicio_codseguimiento
            from
                 detalle_serv d
            LEFT JOIN servicio s on d.servicio_id = s.servicio_id
            LEFT JOIN usuario u on d.responsable_id = u.usuario_id
            LEFT JOIN cliente c on s.cliente_id = c.cliente_id
            where
                 d.servicio_id = s.servicio_id
                 and s.servicio_codseguimiento = '".$codigo."'
            order by d.detalleserv_id

        ")->result_array();

        return $servicio;
    }
    
    /* Cantid sdde servicios */
    function get_servicios_hoy()
    {
        $servicio = $this->db->query("select if(count(*)>0,count(*),0) as cantidad_servicios
                    from servicio s
                    where s.servicio_fecharecepcion = DATE(now())")->row_array();

        return $servicio;
    }
    
    /* Servicios proximos a vencer!.. pendientes y en proceso */
    function proximos_avencer()
    {
        $servicio = $this->db->query("
            SELECT
                c.cliente_nombre, s.servicio_id, ds.detalleserv_id, ds.estado_id,
                s.servicio_fecharecepcion, s.servicio_horarecepcion,
                ds.detalleserv_fechaentrega, ds.detalleserv_horaentrega,
                e.estado_descripcion, ts.tiposerv_descripcion, s.servicio_direccion,
                ds.detalleserv_descripcion, r.usuario_nombre as respnombre
            FROM
                detalle_serv ds
            LEFT JOIN servicio s on ds.servicio_id = s.servicio_id
            LEFT JOIN estado e on ds.estado_id = e.estado_id
            LEFT JOIN usuario r on ds.responsable_id = r.usuario_id
            LEFT JOIN cliente c on s.cliente_id = c.cliente_id
            LEFT JOIN usuario u on ds.usuario_id = u.usuario_id
            LEFT JOIN tipo_servicio ts on s.tiposerv_id = ts.tiposerv_id
            WHERE
                ds.estado_id = 5 or ds.estado_id = 28
                order by ds.detalleserv_fechaentrega desc, ds.detalleserv_horaentrega desc
        ")->result_array();
        
        return $servicio;
    }
}
