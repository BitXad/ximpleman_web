<?php
/* 
 * Generated by CRUDigniter v3.2 
 * www.crudigniter.com
 */
 
class Compra_model extends CI_Model
{
    function __construct()
    {
        parent::__construct();
        $this->load->model('Compra_model');
        $this->load->model('Producto_model');
        $this->load->model('Proveedor_model');
       $this->load->model('Inventario_model');
    }
    
    
    /*
     * Get compra by compra_id
     */
   /* function get_compra($compra_id)
    {
        $compra = $this->db->query("
            SELECT
                *

            FROM
                `compra`

            WHERE
                `compra_id` = ?
        ",array($compra_id))->row_array();

        return $compra;
    }
*/

     function join_compra($compra_id)
    {
        $compra = $this->db->query("
            SELECT
                c.*, p.*, t.*, f.*, mo.*

            FROM
                compra c, proveedor p, tipo_transaccion t, forma_pago f, moneda mo

            WHERE
               c.compra_id=? and c.proveedor_id=p.proveedor_id and c.tipotrans_id=t.tipotrans_id and c.forma_id=f.forma_id and c.moneda_id=mo.moneda_id
        ",array($compra_id))->row_array();

        return $compra;
    }
    
     function join_compras($compra_id)
    {
        $compra = $this->db->query("
            SELECT
                c.*, p.*, t.*, f.*, mo.*, u.*

            FROM
                compra c, proveedor p, tipo_transaccion t, forma_pago f, moneda mo, usuario u

            WHERE
                c.proveedor_id=p.proveedor_id and c.tipotrans_id=t.tipotrans_id and c.forma_id=f.forma_id and c.moneda_id=mo.moneda_id and c.usuario_id=u.usuario_id and c.compra_id=".$compra_id."
                ORDER BY `compra_id` DESC
         ")->result_array();

        return $compra;
    }

    function borrartodo($compra_id)
    {
        $compra = $this->db->query("
            DELETE
                
            FROM
                detalle_compra_aux 

            WHERE
            
             compra_id = ".$compra_id."

            
        ");

        return $compra;
    }
    
    function buscarprovedo($parametro)
    {
        $compra = $this->db->query("
            SELECT
                *, c.estado_id as 'elestado'

            FROM
                compra c, estado e, proveedor p, tipo_transaccion t, usuario u

            WHERE
                c.estado_id = e.estado_id
                and c.proveedor_id = p.proveedor_id
                and c.tipotrans_id = t.tipotrans_id
                and c.usuario_id=u.usuario_id
                and (p.proveedor_nombre like '%".$parametro."%' or c.compra_id = '$parametro')

            ORDER BY `compra_id` DESC

            
        ")->result_array();

        return $compra;
    }

    function opciones($title)
  {
        $this->db->like('proveedor_nombre', $title , 'both');
        $this->db->order_by('proveedor_nombre', 'ASC');
        $this->db->limit(10);
        return $this->db->get('proveedor')->result();
    }
    
    
    /*
     * Get all compra count
     */
    function get_all_compra_count()
    {
        $compra = $this->db->query("
            SELECT
                count(*) as count

            FROM
                `compra`
        ")->row_array();

        return $compra['count'];
    }
    
    function numero()
    {
        
        $num = $this->db->query("SELECT * FROM parametros")->result_array();
        return $num;
    }  
    /*
     * Get all compra
     */
     function get_all_compra($params = array()){
        return $this->db->query(
            "SELECT c.*, c.estado_id as 'elestado',
                e.estado_descripcion, e.estado_color,
                p.*,
                tt.*,
                u.*,
                b.banco_nombre,
                fp.forma_nombre 
            from compra c 
            left join estado e on c.estado_id = e.estado_id  
            left join proveedor p on c.proveedor_id  = p.proveedor_id 
            left join tipo_transaccion tt on c.tipotrans_id = tt.tipotrans_id 
            left join usuario u on c.usuario_id = u.usuario_id 
            left join banco b on c.banco_id = b.banco_id 
            left join forma_pago fp on c.forma_id = fp.forma_id 
            where c.compra_fecha = date(now()) 
            ORDER BY `compra_hora` DESC 
        ")->result_array();
    }
     function fechacompras($condicion)
    {
       $compra = $this->db->query(
            "SELECT c.*, c.estado_id as 'elestado',
                e.estado_descripcion, e.estado_color,
                p.*,
                tt.*,
                u.*,
                b.banco_nombre,
                fp.forma_nombre 
            from compra c 
            left join estado e on c.estado_id = e.estado_id  
            left join proveedor p on c.proveedor_id  = p.proveedor_id 
            left join tipo_transaccion tt on c.tipotrans_id = tt.tipotrans_id 
            left join usuario u on c.usuario_id = u.usuario_id 
            left join banco b on c.banco_id = b.banco_id 
            left join forma_pago fp on c.forma_id = fp.forma_id 
            where 1 = 1
            $condicion
            ORDER BY c.compra_fecha DESC, c.compra_hora DESC
        ")->result_array();

        return $compra;
    }

     function fechacompra($condicion)
    {
       $compra = $this->db->query("
            SELECT
                c.*, e.estado_descripcion, p.proveedor_nombre, dc.*, i.*, u.usuario_nombre, t.tipotrans_nombre
            FROM
                compra c, estado e, proveedor p, tipo_transaccion t, detalle_compra dc, producto i, usuario u

            WHERE
                c.estado_id = e.estado_id
                and c.compra_id = dc.compra_id
                and c.usuario_id = u.usuario_id
                and dc.producto_id = i.producto_id
                and c.proveedor_id = p.proveedor_id
                and c.tipotrans_id = t.tipotrans_id
                ".$condicion." 
            ORDER BY compra_fecha, compra_hora DESC 
        ")->result_array();

        return $compra;
    }

    function cambiarfechacompra($fecha,$hora,$compra_id)
    {
         $sql = " UPDATE compra
            SET compra_fecha='".$fecha."', compra_hora='".$hora."'
            WHERE compra_id=".$compra_id;
        $compra = $this->db->query($sql);  
        return $fecha;
    }

    function comprafecha($compra_id)
    {
         $fecha = $this->db->query(" SELECT compra_fecha from compra where compra_id=".$compra_id." ")->result_array();  
        return $fecha;
    }
    function normalize_date($date)
    {
        if (!empty($date)) {
            return implode("-", array_reverse(explode("/", $date)));            
        }
        else{
            return "2000-01-01";
        }

    }
        
    /*
     * function to add new compra
     */
    function add_compra($params)
    {
        $this->db->insert('compra',$params);
        return $this->db->insert_id();
    }

    function add_facturacompra($params)
    {
        $this->db->insert('factura_compra',$params);
        return $this->db->insert_id();
    }

    function update_facturacompra($factura_id,$params)
    {
        $this->db->where('factura_id',$factura_id);
        return $this->db->update('factura_compra',$params);
    }
    
    /*
     * function to update compra
     */
    function update_compra($compra_id,$params)
    {
        $this->db->where('compra_id',$compra_id);
        return $this->db->update('compra',$params);
    }

    function crear_compra($usuario_id)
    {
        
        $estado_id = 1;
        $forma_id = 1;
        $tipotrans_id = 1;
        $proveedor_id = 0;
        $moneda_id = 1;
        $compra_fecha = "now()";
        $compra_hora = "'".date('H:i:s')."'";
        $compra_subtotal = 0;
        $compra_descuento = 0;
        $movil = 1;
        $compra_total = 0;
        $compra_glosa = "''";
        
        $sql = "insert into compra(usuario_id,estado_id,forma_id,tipotrans_id,proveedor_id,moneda_id,compra_fecha,compra_hora,compra_subtotal,compra_descuento,compra_total,compra_glosa,compra_placamovil,documento_respaldo_id) ".
                "value(".$usuario_id.",".$estado_id.",".$forma_id.",".$tipotrans_id.",".$proveedor_id.",".$moneda_id.",".$compra_fecha.",".$compra_hora.",".$compra_subtotal.",".$compra_descuento.",".$compra_total.",".$compra_glosa.",".$movil.",".$proveedor_id.")";
        $compra = $this->db->query($sql);
        $compra_id = $this->db->insert_id();
        return $compra_id;        
        
    }
    function get_credito($compra_id)
    {
        $sql = "SELECT c.* FROM credito c
               WHERE c.compra_id = ".$compra_id."
               ";
        $result = $this->db->query($sql)->row_array();
        return $result;        
    }
    function get_detalle_compra_aux($compra_id)
    {
        $sql = "SELECT d.*, p.*, p.moneda_id as estamoneda_id from detalle_compra_aux d, producto p
               where d.producto_id=p.producto_id and d.compra_id = ".$compra_id."
               order by d.detallecomp_id desc";
        $result = $this->db->query($sql)->result_array();
        return $result;        
    }
    function get_detalle_compra($compra_id)
    {
        $sql = "SELECT d.*, p.* from detalle_compra d, producto p
               where d.producto_id=p.producto_id and d.compra_id = ".$compra_id."
               order by d.detallecomp_id desc";
        $result = $this->db->query($sql)->result_array();
        return $result;        
    }
    function get_all_producto()
    {
        $sql = "select * from producto";
        $result = $this->db->query($sql)->result_array();
        return $result;        
    }
    function get_proveedor_id($compra_id)
    {
        $sql = "select proveedor_id from compra ".
               "where compra_id = ".$compra_id;
        $result = $this->db->query($sql)->result_array();
        return $result;
    }
    
    function detalle_compraux()
    {
        $sql = "select compra_id from detalle_compra_aux ";
        $result = $this->db->query($sql)->result_array();
        return $result;
    }

    function volvermal($compra_id)
    {
        $sql = "UPDATE compra set compra_placamovil = 1
                 WHERE compra_id = ".$compra_id;
        $compra = $this->db->query($sql);                
        return $compra_id;
    }
    function delete_compra($compra_id)
    {
        return $this->db->delete('compra',array('compra_id'=>$compra_id));
    }

    function cambiar_proveedor($compra_id,$proveedor_id)
    {
        $sql = "UPDATE compra set proveedor_id = ".$proveedor_id.
                " WHERE compra_id = ".$compra_id;
        $compra = $this->db->query($sql);                
        return $compra_id;
        
    }

    function get_compra($compra_id)
    {
        $sql = "select p.*, 'NO DEFINIDO' as proveedor_nombre,'NO DEFINIDO' as proveedor_codigo, '0' as proveedor_autorizacion, '0' as proveedor_nit, '0' as proveedor_razon, e.estado_descripcion from compra p, estado e ".
               "where compra_id = ".$compra_id." and p.estado_id = e.estado_id";
        $result = $this->db->query($sql)->result_array();
        return $result;        
    }

    function get_compra_sin_nombre($usuario_id)
    {
         $sql = "SELECT p.*, 'NO DEFINIDO' as proveedor_nombre,'NO DEFINIDO' as proveedor_codigo, '0' as proveedor_autorizacion, '0' as proveedor_nit, '0' as proveedor_razon, e.estado_descripcion from compra p, estado e  where p.usuario_id = ".$usuario_id." and p.estado_id = e.estado_id and p.proveedor_id=0";
        $result = $this->db->query($sql)->result_array();
        return $result;          
    }

    function get_compra_proveedor($compra_id)
    {
        $sql = "select p.*,c.*,e.estado_descripcion from compra p, estado e, proveedor c ".
               "where p.compra_id = ".$compra_id." and p.estado_id = e.estado_id".
                " and p.proveedor_id = c.proveedor_id";
        $result = $this->db->query($sql)->result_array();
        return $result;        
    }

    function get_all_proveedor($usuario_id)
    {
        $sql = "SELECT * from proveedor where estado_id =1";
        $result = $this->db->query($sql)->result_array();
        return $result;        
    }

    function ejecutar($sql)
    {
        $compra = $this->db->query($sql);
        return $compra;
        
    }

    function consultar($sql)
    {
        $compra = $this->db->query($sql)->result_array();
        return $compra;
        
    }

     function getcredito($sql)
    {
        $credito = $this->db->query($sql,array('credito_id'))->row_array();
        return $credito;
        
    }
    function bandera($bandera)
    {
        $bandera = $this->input->post('bandera');
        return $bandera;
    }

    function get_compras_dia()
    {
        $sql = "select if(count(*)>0, count(*), 0) as cantidad_compras, if(sum(compra_totalfinal)>0, sum(compra_totalfinal), 0) as total_compras
                from compra where compra_fecha = date(now()) and tipotrans_id=1";
        $compras = $this->db->query($sql)->result_array();

        return $compras;
    }
     function get_compras_dia_credito()
    {
        $sql = "select if(count(*)>0, count(*), 0) as cantidad_compras, if(sum(compra_totalfinal)>0, sum(compra_totalfinal), 0) as total_compras
                from compra where compra_fecha = date(now()) and tipotrans_id=2";
        $compras = $this->db->query($sql)->result_array();

        return $compras;
    } 

    function ingreso($cant, $producto_costo, $sucursal, $producto){

        $proveedor_id = $this->db->query("
            SELECT
                p.proveedor_id
            FROM
                 proveedor p
            WHERE              
                 p.proveedor_codigo = ".$sucursal."
                
        ")->result_array();

        return $proveedor_id;
        $fecha = "now()";
        $hora = "TIME_FORMAT(NOW(), '%H:%i:%s')";
        $compra = "INSERT INTO compra (proveedor_id, forma_id, tipotrans_id, compra_fecha, compra_hora) VALUES ('$proveedor_id', '1', '4', '$fecha', '$hora')";
        $this->db->query($compra);
        $compra_id = $this->db->insert_id();
        $compra_total = $cant * $producto_costo;
        $detallecomp = "INSERT INTO detalle_compra (compra_id, producto_id, detallecomp_cantidad, detallecomp_costo, detallecomp_total) VALUES ('$compra_id', '$producto', '$cant', '$producto_costo' '$compra_total')";
                        
    } 
    
    function mostrar_historial($producto_id){
        
        $sql = "SELECT 
                    p.proveedor_nombre,
                    c.compra_fecha,
                    d.detallecomp_costo
                  FROM
                    proveedor p,
                    compra c,
                    detalle_compra d
                  WHERE
                    d.producto_id = ".$producto_id." AND 
                    d.compra_id = c.compra_id AND 
                    c.proveedor_id = p.proveedor_id
                  ORDER BY
                    c.compra_fecha DESC";
        return $this->db->query($sql)->result_array();
        
    }
    /*
     * Get compra compra_id
     */
    function get_estacompra($compra_id)
    {
        $compra = $this->db->query("
            SELECT
                *
            FROM
                `compra`
            WHERE
                `compra_id` = ?
        ",array($compra_id))->row_array();
        return $compra;
    }

    /**
     * Add detalle compra aux
     */
    function add_detalle_compra_aux($params){
        $this->db->insert('detalle_compra_aux',$params);
        return $this->db->insert_id();
    }
    
    /* obtiene cantidades de los detalles de compra de un producto!. */
    function mostrar_detallescompraproducto($producto_id){
        $sql = "SELECT 
                    c.compra_id, c.compra_fecha, c.compra_hora, p.proveedor_nombre,
                    d.detallecomp_costo, d.`detallecomp_fechavencimiento`, d.`detallecomp_cantidad`
                  FROM
                    detalle_compra d
                    left join compra c on d.compra_id = c.compra_id
                    left join proveedor p on c.`proveedor_id` = p.`proveedor_id`
                  WHERE
                    d.producto_id = ".$producto_id."
                  ORDER BY
                    c.compra_fecha DESC, c.compra_hora DESC";
        return $this->db->query($sql)->result_array();
    }
    
}

