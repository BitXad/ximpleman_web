<?php
/* 
 * Generated by CRUDigniter v3.2 
 * www.crudigniter.com
 */
 
class Vaciar_tabla extends CI_Controller{
    
    private $sistema;
    function __construct()
    {
        parent::__construct();
        $this->load->model('Vaciar_tabla_model');
        $this->load->model('Sistema_model');
        $this->sistema = $this->Sistema_model->get_sistema();
    }
    
    /* * Listing of vaciar_tabla */
    function index($mensaje = null)
    {
        $data['sistema'] = $this->sistema;
        if($mensaje == null){
            $data['mensaje'] = 6;
        }else{
            $data['mensaje'] = $mensaje;
        }
        //$data['obtener_alltablas'] = $this->Vaciar_tabla_model->get_alltablas();
        $this->load->model('Tablapermiso_model');
        $data['estecodigo'] = $this->Tablapermiso_model->get_all_tablas();
        
        $data['_view'] = 'vaciar_tabla/index';
        $this->load->view('layouts/main',$data);
    }

    /* * Adding a new vaciar_tabla */
    function leerarchivo()
    {
        $data['sistema'] = $this->sistema;
        $estecodigo = $this->input->post('codigo');
        $this->load->model('Tablapermiso_model');
        $codigo = $this->Tablapermiso_model->get_codigo();
        if($estecodigo === $codigo['para_vaciar']){
             /* *********************INICIO imagen***************************** */
            $arch="";
            if (!empty($_FILES['datos']['name']))
            {
                $this->load->library('image_lib');
                $config['upload_path'] = './resources/images/';
                $config['allowed_types'] = '*';
                $config['max_size'] = 0;
                /*$config['max_width'] = 2900;
                $config['max_height'] = 2900;*/

                $new_name = time(); //str_replace(" ", "_", $this->input->post('proveedor_nombre'));
                $config['file_name'] = $new_name; //.$extencion;
                $config['file_ext_tolower'] = TRUE;

                $this->load->library('upload', $config);
                $this->upload->do_upload('datos');

                $img_data = $this->upload->data();
                $extension = $img_data['file_ext'];

                $arch = $new_name.$extension;
                //$query = file_get_contents($config['upload_path'].$arch);
                $res = false;
                $base_url = explode('/', base_url());
                //$directorio = FCPATH.'resources\images\\';
                $directorio = $_SERVER['DOCUMENT_ROOT'].'/'.$base_url[3].'/resources/images/';
                $res = $this->Vaciar_tabla_model->insertar_datos($directorio.$arch);
                if(isset($arch) && !empty($arch)){
                    if(file_exists($directorio.$arch)){
                        unlink($directorio.$arch);
                    }
                }
                $mensaje = 0;
                if($res == true)
                {
                    $mensaje = 1;
                }else{
                    $mensaje = 2;
                }
                /*$data['estecodigo'] = $this->Tablapermiso_model->get_all_tablas();
                $data['_view'] = 'vaciar_tabla/index';
                $this->load->view('layouts/main',$data);*/
                redirect('vaciar_tabla/index/'.$mensaje);
            }else{
                $mensaje = 0;
                /*$data['mensaje'] = 0;
                $data['estecodigo'] = $this->Tablapermiso_model->get_all_tablas();
                $data['_view'] = 'vaciar_tabla/index';
                $this->load->view('layouts/main',$data);*/
                redirect('vaciar_tabla/index/'.$mensaje);
            }
        }else{
                $mensaje = 5;
                /*$data['estecodigo'] = $this->Tablapermiso_model->get_all_tablas();
                $data['_view'] = 'vaciar_tabla/index';
                $this->load->view('layouts/main',$data);*/
                redirect('vaciar_tabla/index/'.$mensaje);
            }
        /* *********************FIN imagen***************************** */
    }
    /*
     * truncar tabla
     */
    function vaciartabla()
    {
        $estecodigo = $this->input->post('codigo');
        $this->load->model('Tablapermiso_model');
        $codigo = $this->Tablapermiso_model->get_codigo();
        if($estecodigo === $codigo['para_vaciar']){
            $all_tabla = $this->Vaciar_tabla_model->get_all_tabla_pvaciar();
            foreach ($all_tabla as $tabla) {
                $res = $this->Vaciar_tabla_model->vaciar_tabla($tabla['tabla_nombre']);
            }
            $mensaje = 3;
            /*$data['estecodigo'] = $this->Tablapermiso_model->get_all_tablas();
            $data['_view'] = 'vaciar_tabla/index';
            $this->load->view('layouts/main',$data);*/
            redirect('vaciar_tabla/index/'.$mensaje);
        }else{
        $mensaje = 5;
        /*$data['estecodigo'] = $this->Tablapermiso_model->get_all_tablas();
        $data['_view'] = 'vaciar_tabla/index';
        $this->load->view('layouts/main',$data);*/
        redirect('vaciar_tabla/index/'.$mensaje);
        }
    }
    /* * guardar tablas seleccionadas * */
    function guardartabla()
    {
        $this->load->model('Tablapermiso_model');
        $all_tablas = $this->Tablapermiso_model->get_all_tablas();
        $i = 0;
        foreach ($all_tablas as $rol) {
            $estoscheck = $this->input->post('tabla'.$i);
            $tabla_id = $this->input->post('tabla_id'.$i);
            if($estoscheck == 1){
                $tabla_asignado = 1;
            }else{
                $tabla_asignado = 0;
            }
            $param = array(
                    'tabla_asignado' => $tabla_asignado,
            );
            $this->Tablapermiso_model->update_tabla($tabla_id, $param);
            $i++;
        }

        redirect('vaciar_tabla');
    }
    /* * guardar tablas seleccionadas * */
    function reasignartabla()
    {
        $estecodigo = $this->input->post('codigo');
        $this->load->model('Tablapermiso_model');
        $codigo = $this->Tablapermiso_model->get_codigo();
        
        if($estecodigo === $codigo['para_vaciar']){
            
            $estenombre = $this->input->post('nombre');
            $es_database = $this->Tablapermiso_model->get_es_estadb($estenombre);
            
            if($es_database == true){
                
                $nombretabla = "tabla";
                $this->Tablapermiso_model->truncar_db($nombretabla);
                $all_tablas = $this->Tablapermiso_model->get_listartablasbd($estenombre);
                $columna = "Tables_in_".$estenombre;
                foreach ($all_tablas as $tabla){
                    $param = array(
                            'tabla_nombre' => $tabla[$columna],
                            'tabla_asignado' => 1,
                        );
                    $tabla_id = $this->Tablapermiso_model->add_tablapermiso($param);
                }
                redirect('vaciar_tabla');
                
            }else{
                
                $mensaje = 4;
                /*$data['estecodigo'] = $this->Tablapermiso_model->get_all_tablas();
                $data['_view'] = 'vaciar_tabla/index';
                $this->load->view('layouts/main',$data);*/
                redirect('vaciar_tabla/index/'.$mensaje);
                
            }
        }else{
            
            $mensaje = 5;
            /*$data['estecodigo'] = $this->Tablapermiso_model->get_all_tablas();
            $data['_view'] = 'vaciar_tabla/index';
            $this->load->view('layouts/main',$data);*/
            redirect('vaciar_tabla/index/'.$mensaje);
            
        }
    }
}
