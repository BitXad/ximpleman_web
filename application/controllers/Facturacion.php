<?php
/* 
 * Generated by CRUDigniter v3.2 
 * www.crudigniter.com
 */
 
class Facturacion extends CI_Controller{
    
    private $parametros;
	
    function __construct()
    {
        parent::__construct();
        $this->load->model([
            'Factura_model',
            'Empresa_model',
            'Parametro_model',
            'Dosificacion_model',
        ]);
        
        $this->load->library('ControlCode');

        $this->load->helper([
            'xml',
            'numeros_helper',// Helper para convertir numeros a letras
            'validacionxmlxsd_helper',
        ]);

        $parametro = $this->Parametro_model->get_parametros();
        $this->parametros = $parametro[0];
		
        
    }
    
    function index(){
        $this->registrar_factura();
    }
    
    function registrar_factura(){//si la venta es facturada
     
        //Primero.- Llenar las tablas factura y detalle factura
        $sql = "insert into factura(
                factura_id
                ,estado_id
                ,venta_id
                ,factura_fechaventa
                ,factura_fecha
                ,factura_hora
                ,factura_subtotal
                ,factura_ice
                ,factura_exento
                ,factura_descuentoparcial
                ,factura_descuento
                ,factura_total
                ,factura_numero
                ,factura_autorizacion
                ,factura_llave
                ,factura_fechalimite
                ,factura_codigocontrol
                ,factura_leyenda1
                ,factura_leyenda2
                ,factura_nit
                ,factura_razonsocial
                ,factura_nitemisor
                ,factura_sucursal
                ,factura_sfc
                ,factura_actividad
                ,cuota_id
                ,credito_id
                ,ingreso_id
                ,servicio_id
                ,usuario_id
                ,tipotrans_id
                ,factura_efectivo
                ,factura_cambio
                ,factura_tokendelegado
                ,factura_ambiente
                ,factura_cuis
                ,factura_cufd
                ,factura_modalidad
                ,factura_codsistema
                ,factura_puntoventa
                ,factura_sectoreconomico
                ,factura_ruta
                ,factura_tamanio
                ,factura_cuf
                ,factura_fechahora
                ,cdi_codigoclasificador
                ,docsec_codigoclasificador
                ,factura_codigoestado
                ,factura_codigorecepcion
                ,factura_transaccion
                ,factura_mensajeslist
                ,factura_codigocliente
                ,factura_codigodescripcion
                ,factura_enviada
                ,factura_leyenda3
                ,factura_leyenda4
                ,factura_tipoemision
                ,factura_excepcion
                ,factura_cafc
                ,factura_giftcard
                ,factura_detalletransaccion
                ,forma_id
                ,factura_complementoci
                ,registroeventos_id
                ,factura_glosa
                ,datos_id)
                
                value(
                 venta_id
                ,forma_id
                ,tipotrans_id
                ,usuario_id
                ,cliente_id
                ,estado_id
                ,venta_fecha
                ,date(now())
                ,time(now())
                ,venta_subtotal
                ,venta_descuentoparcial
                ,venta_descuento
                ,venta_total
                ,venta_efectivo
                ,venta_cambio
                ,venta_glosa
                


                ,venta_tipodoc
                ,tiposerv_id
                ,entrega_id
                ,venta_fechaentrega
                ,venta_horaentrega
                ,venta_numeroventa
                ,venta_numeromesa
                ,entrega_usuarioid
                ,entrega_estadoid
                ,usuarioprev_id
                ,pedido_id
                ,orden_id
                ,banco_id
                ,venta_ice
                ,venta_giftcard
                ,venta_detalletransaccion
                ,venta_tipocambio
                ,detalleserv_id
                
                ) ";
        
        
        
        
                    $dosificacion = $this->Dosificacion_model->get_dosificacion_activa();
                    // PARA NUEVO SISTEMA DE FACTURACION
                    //$parametro = $this->Parametro_model->get_parametros(); replazado por $parametros, variable global
                    
                    $tamanio_hoja = 2;                    
                    if($this->parametros['parametro_tipoimpresora'] == "FACTURADORA"){
                        $tamanio_hoja = 1;
                    }
                    // PARA NUEVO SISTEMA DE FACTURACION
                        
                        $estado_id = 1; 
                        
                        $factura_fechaventa    = $fecha_venta;
                        $factura_fecha         = "date(now())";
                        $factura_hora          =  $hora_venta; //"time(now())";
                        $factura_subtotal = $venta_subtotal;
                        $factura_nit           = $numero_doc_identidad;
                        $factura_razonsocial   = $razon;
                        $factura_ice           = 0;
                        $factura_exento        = 0;
                        $factura_descuentoparcial     = $venta_descuentoparcial;
                        $factura_descuento     = $venta_descuento;
                        $factura_total         = $venta_total;
                        $factura_numero        = $dosificacion[0]['dosificacion_numfact']+1;
                        $factura_autorizacion  = $dosificacion[0]['dosificacion_autorizacion'];
                        $factura_llave         = $dosificacion[0]['dosificacion_llave'];
                        $factura_fechalimite   = $dosificacion[0]['dosificacion_fechalimite'];
                        
                        if ($this->parametros["parametro_tiposistema"]==1)
                            $factura_codigocontrol = $this->codigo_control($factura_llave, $factura_autorizacion, $factura_numero, $numero_doc_identidad,$factura_fechaventa, $factura_total);
                        else
                            $factura_codigocontrol = "-"; 
                                
                        $factura_leyenda1      = $dosificacion[0]['dosificacion_leyenda1'];
                        $factura_leyenda2      = $dosificacion[0]['dosificacion_leyenda2'];
                        $factura_leyenda3      = $dosificacion[0]['dosificacion_leyenda3'];
                        $factura_leyenda4      = $dosificacion[0]['dosificacion_leyenda4'];
                        $factura_leyenda5      = $dosificacion[0]['dosificacion_leyenda5'];
                        $factura_nitemisor     = $dosificacion[0]['dosificacion_nitemisor'];
                        $factura_sucursal      = $dosificacion[0]['dosificacion_sucursal'];
                        $factura_sfc           = $dosificacion[0]['dosificacion_sfc'];
                        $factura_actividad     = $dosificacion[0]['dosificacion_actividad'];
                        $factura_enviada = 0;// 0 = falso
                        
                        if($this->parametros['parametro_tiposistema'] != 1){// Si es diferente a Sistema de facturacion computarizado(1)
                            // facturacion nueva
                            $puntoventa = $this->Usuario_model->get_punto_venta_usuario($usuario_id);
                            $this->load->model('PuntoVenta_model');
                            $punto_venta = $this->PuntoVenta_model->get_puntoventa($puntoventa['puntoventa_codigo']);
                            
                            $cliente_codigo = $this->Cliente_model->get_codigo_cliente($factura_nit, $factura_razonsocial);
                            $factura_tokendelegado   = $dosificacion[0]['dosificacion_tokendelegado'];
                            $factura_ambiente        = $dosificacion[0]['dosificacion_ambiente'];
                            $factura_cuis            = $punto_venta['cuis_codigo']; //$dosificacion[0]['dosificacion_cuis'];
                            $factura_cufd            = $punto_venta['cufd_codigo']; //$dosificacion[0]['dosificacion_cufd'];
                            $factura_modalidad       = $dosificacion[0]['dosificacion_modalidad'];
                            $factura_codsistema      = $dosificacion[0]['dosificacion_codsistema'];
                            $factura_puntoventa      = $punto_venta['puntoventa_codigo']; //$dosificacion[0]['dosificacion_puntoventa'];
                            $factura_sectoreconomico = $dosificacion[0]['dosificacion_sectoreconomico'];
                            $factura_ruta            = $dosificacion[0]['dosificacion_ruta'];
                            $factura_tamanio         = $tamanio_hoja;
                            $tipoDocumentoIdentidad  = $this->input->post('tipo_doc_identidad');
                            $documentoSector = $dosificacion[0]['docsec_codigoclasificador'];
                            
                            $factura_fecha_hora = (new DateTime())->format('Y-m-d\TH:i:s.v');
                            
                            $facturaCufdCodControl = $this->Factura_model->get_cudf_activo($punto_venta['cufd_codigo']); //$dosificacion[0]['dosificacion_cufd']);
                            $factura_codigocliente = $cliente_codigo;
        
    
                            if($registroeventos_codigo>0){ //Si es una factura transcrita con CAFC cambia los parametros para generar la factura
                                
                                $factura_fecha = "'".$fecha_cafc."'";
                                $factura_hora = $hora_cafc;
                                $factura_numero = $numfact_cafc;
                                $factura_cafc = $codigo_cafc;                                    
                                
                                $factura_fecha_hora = $fecha_cafc."T".$hora_cafc.":00.000";
                                
                                $tipo_emision = 2;   
                                $eventos = $this->Venta_model->consultar("select * from registro_eventos where registroeventos_codigo=".$registroeventos_codigo);
                                $cufd_codigocontrol =  $eventos[0]["registroeventos_codigocontrol"];
                                $factura_cufd = $eventos[0]["registroeventos_cufd"];
                                $elregistroeventos_id = $eventos[0]["registroeventos_id"];
                                
                            }else{
                                $factura_cafc = "";
                                $tipo_emision = $this->parametros['parametro_tipoemision'];
                                $cufd_codigocontrol =  trim($facturaCufdCodControl['cufd_codigocontrol']);
                                $elregistroeventos_id = 0;
                            }
                            
                            $cadFechahora = str_replace("-", "", $factura_fecha_hora);
                            $cadFechahora = str_replace("T", "", $cadFechahora);
                            $cadFechahora = str_replace(":", "", $cadFechahora);
                            $cadFechahora = str_replace(".", "", $cadFechahora);
                            $tipo_factura = $dosificacion[0]['tipofac_codigo'];
                            $tipo_documento_sector = $dosificacion[0]['docsec_codigoclasificador'];
                            $pos = $punto_venta['puntoventa_codigo']; //$dosificacion[0]['dosificacion_puntoventa'];

                                                        

                            // LLAMANDO AL HELPER
                            $factura_cuf = generarCuf(trim($factura_nitemisor),
                                                    trim($cadFechahora),
                                                    trim($factura_sucursal),
                                                    trim($factura_modalidad),
                                                    trim($tipo_emision),
                                                    trim($tipo_factura),
                                                    trim($tipo_documento_sector),
                                                    trim($factura_numero),
                                                    trim($pos),
                                                    trim($cufd_codigocontrol));
        
                            $fecha_hora = $factura_fecha_hora;
                            
                        }
                        // PARA NUEVA FACTURACION
                    
                    
                    //$factura_codigocontrol = $this->codigo_control($factura_llave, $factura_autorizacion, $factura_numero, $factura_nit, $factura_fechaventa, $factura_total);
                    
                    //********** INICIO ACTUALIZAR NUMERO DE FACTURA
//                        $sql = "update dosificacion set dosificacion_numfact = ".$factura_numero;
//                        $this->Venta_model->ejecutar($sql);
                        
                    //********** FIN INICIO ACTUALIZAR NUMERO DE FACTURA
                        
                        if($this->parametros['parametro_tiposistema'] == 1){
                            
                            // sistema de facturacion antiguo
                                $sql = "insert into factura(estado_id, venta_id, factura_fechaventa, 
                                factura_fecha, factura_hora, factura_subtotal, 
                                factura_exento, factura_descuentoparcial, factura_descuento, factura_total, 
                                factura_numero, factura_autorizacion, factura_llave, 
                                factura_fechalimite, factura_codigocontrol, factura_leyenda1, factura_leyenda2,
                                factura_nit, factura_razonsocial, factura_nitemisor,factura_sucursal,
                                factura_sfc, factura_actividad, usuario_id, tipotrans_id, 
                                factura_efectivo, factura_cambio,factura_enviada, factura_leyenda3, factura_leyenda4,factura_excepcion,
                                factura_ice, factura_giftcard, factura_detalletransaccion, forma_id, factura_complementoci, factura_glosa) value(".
                                $estado_id.",".$venta_id.",'".$factura_fechaventa."',".
                                $factura_fecha.",'".$factura_hora."',".$factura_subtotal.",".
                                $factura_exento.",".$factura_descuentoparcial.",".$factura_descuento.",".$factura_total.",".
                                $factura_numero.",".$factura_autorizacion.",'".$factura_llave."','".
                                $factura_fechalimite."','".$factura_codigocontrol."','".$factura_leyenda1."','".$factura_leyenda2."','".
                                $factura_nit."','".$factura_razonsocial."','".$factura_nitemisor."','".$factura_sucursal."','".
                                $factura_sfc."','".$factura_actividad."',".$usuario_id.",".$tipo_transaccion.",".
                                $venta_efectivo.",".$venta_cambio.",".$factura_enviada.",'".$factura_leyenda3."','".$factura_leyenda4."',".$codigo_excepcion.",".
                                $venta_ice.",".$venta_giftcard.",'".$venta_detalletransaccion."',".$forma_id.",'".$factura_complementoci."','".$factura_glosa."')";
                        
                                
                        }else{
                            
                                //Sistema de facturacion nuevo
                                $leyendas = $this->Venta_model->consultar("select * from leyenda order by leyenda_codigoactividad");
                                $valor = rand(0,7);
                                $factura_leyenda2 = $leyendas[$valor]["leyenda_descripcion"];
                        
                                $registroeventos_id = 0;
                                if ($tipo_emision == 2){ //1 en linea, 2 fuera de linea 3 masiva    
                                    $factura_leyenda3 =  $factura_leyenda5;
                                    //$factura_cafc = $dosificacion[0]["dosificacion_cafc"];                          
                                    $registroeventos_id = $this->registroeventos_id;
                                    if($elregistroeventos_id > 0){
                                        $registroeventos_id = $elregistroeventos_id;
                                    }

                                }
                                
 
                                
                            // nuevo sistema de facturacion                                
                            $sql = "insert into factura(estado_id, venta_id, factura_fechaventa, 
                                factura_fecha, factura_hora, factura_subtotal, 
                                factura_exento, factura_descuentoparcial, factura_descuento, factura_total, 
                                factura_numero, factura_autorizacion, factura_llave, 
                                factura_fechalimite, factura_codigocontrol, factura_leyenda1, factura_leyenda2,
                                factura_nit, factura_razonsocial, factura_nitemisor, factura_sucursal,
                                factura_sfc, factura_actividad, usuario_id, tipotrans_id,
                                factura_efectivo, factura_cambio, factura_tokendelegado,
                                factura_ambiente, factura_cuis, factura_cufd, factura_modalidad,
                                factura_codsistema, factura_puntoventa, factura_sectoreconomico,
                                factura_ruta, factura_tamanio,factura_cuf,factura_fechahora,cdi_codigoclasificador,
                                docsec_codigoclasificador, factura_codigocliente,factura_enviada, factura_leyenda3, factura_leyenda4,factura_excepcion, factura_tipoemision,
                                factura_ice, factura_giftcard, factura_detalletransaccion, forma_id, factura_complementoci, factura_cafc, registroeventos_id, factura_glosa) value(".
                                $estado_id.",".$venta_id.",'".$factura_fechaventa."',".
                                $factura_fecha.",'".$factura_hora."',".$factura_subtotal.",".
                                $factura_exento.",".$factura_descuentoparcial.",".$factura_descuento.",".$factura_total.",".
                                $factura_numero.",".$factura_autorizacion.",'".$factura_llave."','".
                                $factura_fechalimite."','".$factura_codigocontrol."','".$factura_leyenda1."','".$factura_leyenda2."','".
                                $factura_nit."','".$factura_razonsocial."','".$factura_nitemisor."','".$factura_sucursal."','".
                                $factura_sfc."','".$factura_actividad."',".$usuario_id.",".$tipo_transaccion.",".
                                $venta_efectivo.",".$venta_cambio.",'".$factura_tokendelegado."','".
                                $factura_ambiente."','".$factura_cuis."','".$factura_cufd."','".$factura_modalidad."','".
                                $factura_codsistema."','".$factura_puntoventa."','".$factura_sectoreconomico."','".
                                $factura_ruta."','".$factura_tamanio."','$factura_cuf','$fecha_hora',$tipoDocumentoIdentidad,
                                $documentoSector,'$factura_codigocliente','$factura_enviada'".",'".$factura_leyenda3."','".$factura_leyenda4."',".$codigo_excepcion.",".$tipo_emision.",".
                                $venta_ice.",".$venta_giftcard.",'".$venta_detalletransaccion."',".$forma_id.",'".$factura_complementoci."','".$factura_cafc."',".$registroeventos_id.",'".$factura_glosa."')";
                                    
                        }
                        $factura_id = $this->Venta_model->ejecutar($sql);
                    
                        $sql =  "insert into detalle_factura(
                        producto_id,
                        venta_id,
                        factura_id,
                        detallefact_codigo,
                        detallefact_unidad,
                        detallefact_cantidad,            
                        detallefact_descripcion,
                        detallefact_precio,
                        detallefact_subtotal,
                        detallefact_descuentoparcial,
                        detallefact_descuento,
                        detallefact_total,                
                        detallefact_preferencia,
                        detallefact_caracteristicas,
                        detallefact_unidadfactor)
        
                        (SELECT 
                            producto_id,
                            ".$venta_id." as venta_id,          
                            ".$factura_id." as factura_id,
                            detalleven_codigo,
                            detalleven_unidad,
                            detalleven_cantidad,
                            producto_nombre,          
                            detalleven_precio,
                            detalleven_subtotal,
                            detalleven_descuentoparcial,
                            detalleven_descuento,
                            detalleven_total,
                            detalleven_preferencia,
                            detalleven_caracteristicas,
                            detalleven_unidadfactor
        
                        FROM
                            detalle_venta_aux
                        WHERE 
                            usuario_id=".$usuario_id.")";
                        
                        $this->Factura_model->ejecutar($sql);   
                        
                        
                        //  REGISTRO DE DATO DE FACTURA
                        //*******************************************
                        if($dosificacion[0]['docsec_codigoclasificador'] == 12){
                            $params = array(
                                'datos_codigopais' => $this->input->post('datos_codigopais'),
                                'datos_autorizacionsc' => $this->input->post('datos_autorizacionsc'),
                                'datos_placa' => $this->input->post('datos_placa'),
                                'datos_embase' => $this->input->post('datos_embase'),
                                'cliente_id' => $cliente_id,
                            );

                            $datos_id = $this->Factura_datos_model->add_factura_datos($params);
                            
                            $params = array(
                                'datos_id' => $datos_id,
                            );
                            
                            $this->Factura_model->update_factura($factura_id, $params);
                            
                        }
                        //*******************************************
                        
                        
                        
                        if($this->parametros['parametro_tiposistema'] != 1){// para cualquiera que no sea Sistema de facturacion computarizado SFV (computarizado en linea o electronico)
                        // el parametro uno es para computarizada en linea ojo
                        $computarizada_enlinea = $dosificacion[0]["dosificacion_modalidad"];// 1 para electronica y 2 para computarizada
                        $docsec_codigoclasificador = $dosificacion[0]["docsec_codigoclasificador"]; // 1->compra venta/23->prevalorada.....
                        $factura = $this->Factura_model->get_factura_id($factura_id);
                        $detalle_factura = $this->Detalle_venta_model->get_detalle_factura_id($factura_id);
                        $empresa = $this->Empresa_model->get_empresa(1);
                        
                        $base_url = explode('/', base_url());
                        
                        //********************** GENERANDO ARCHIVO XML ****************
                        $dosificacion_documentosector = $dosificacion[0]["dosificacion_documentosector"];
                        $xml = generarfacturaCompra_ventaXML($computarizada_enlinea, $factura, $detalle_factura, $empresa, $docsec_codigoclasificador, $dosificacion_documentosector);
                        //********************** GENERANDO ARCHIVO XML ****************    

                        $directorio_factura = $_SERVER['DOCUMENT_ROOT'].'/'.$base_url[3].'/resources/xml/';
                        $directorio_esquema = $_SERVER['DOCUMENT_ROOT'].'/'.$base_url[3].'/resources/xml/esquemas/';
                        $xsd = $nombre_archivo.".xsd";
                        $valXSD = new ValidacionXSD();
                        
                        $es_valido = $valXSD->validar($directorio_factura.$nombre_archivo.$factura[0]['factura_id'].".xml",$directorio_esquema.$xsd);

                        if(!$es_valido){

                                print "ERROR: ".$valXSD->mostrarError()." ARCHIVO: ".$directorio_factura.$nombre_archivo.$factura[0]['factura_id'].".xml  XSD: ".$directorio_esquema.$xsd;
                                
                        }else{
                            
                                // COMPRESION XML EN GZIP
                                $datos = implode("", file($directorio_factura.$nombre_archivo.$factura[0]['factura_id'].".xml"));
                                $gzdata = gzencode($datos, 9);
                                $fp = fopen($directorio_factura.$nombre_archivo.$factura[0]['factura_id'].".xml.zip", "w");
                               
                                fwrite($fp, $gzdata);
                                fclose($fp); 

                                //Copiar el archivo .tar al directorio con id del usuario en curso

                                $path = $directorio_factura."envio".$usuario_id;
                                //echo $path;
                                if (!file_exists($path)) {
                                    mkdir($path, 0777, true);
                                }

                                
                            if($tipo_emision == 2){ // Si es emision fuera de linea
                                
                                    $p = new PharData($directorio_factura.$nombre_archivo.$factura[0]['factura_id'].'.tar');
                                    $p[$nombre_archivo.$factura[0]['factura_id'].'.xml'] = $datos;
                                    $p1 = $p->compress(Phar::GZ);

                                    $origen = $directorio_factura.$nombre_archivo.$factura[0]['factura_id'].'.tar';
                                    $destino = $directorio_factura.'envio'.$usuario_id.'/'.$nombre_archivo.$factura[0]['factura_id'].'.tar';
                                    copy($origen, $destino);
                                    
                                
                            }
                            //fin para borrar
                            
                            $handle = fopen($directorio_factura.$nombre_archivo.$factura[0]['factura_id'].".xml.zip", "rb");
                            $contents = fread($handle, filesize($directorio_factura.$nombre_archivo.$factura[0]['factura_id'].".xml.zip"));
                            fclose($handle);
                            $content = base64_encode($contents);
                            $b= unpack("C*",$contents);
        
                            $xml_comprimido = hash_file('sha256',$directorio_factura.$nombre_archivo.$factura[0]['factura_id'].".xml.zip");
                            $dosificacion = $this->Dosificacion_model->get_dosificacion(1);
                            //$wsdl = $dosificacion['dosificacion_factura'];
                            //$token = $dosificacion['dosificacion_tokendelegado'];
//                            $comunicacion = $this->verificar_comunicacion($token,$wsdl);
//                            
//                            if($comunicacion){
                            
                            if( $this->parametros["parametro_tipoemision"] == 1) //Si la emision de la factura es de tipo 1 ONLINE
                            {
  
                                $enviada = $this->mandarFactura($contents, $xml_comprimido);
                                //var_dump($enviada);
                                if($enviada->transaccion){ // Si la factura fue enviada                                    
                                    
                                    $params = array(
                                        'factura_codigodescripcion' => $enviada->codigoDescripcion,
                                        'factura_codigoestado'    => $enviada->codigoEstado,
                                        'factura_codigorecepcion' => $enviada->codigoRecepcion,
                                        'factura_transaccion'    => $enviada->transaccion,
                                        'factura_enviada' => true,//Factura enviada a impuestos, por defecto en false(No fue enviada)
                                    );
                                    $this->Factura_model->update_factura($factura_id, $params);
                                    
                                    //SI TODO SALE BIEN HASTA AQUI ACTUALIZA EN NUMERO DE FACTURA
                                    $sql = "update dosificacion set dosificacion_numfact = ".$factura_numero;
                                    $this->Venta_model->ejecutar($sql);
                                    $res  = array("mensajesList" => $enviada);
                                    echo json_encode($res);
                                    
                                }else{
                                    
                                    $cad = $enviada->mensajesList;
                                    //var_dump($enviada);
                                    //var_dump($cad);
                                    
                                    $mensajecadena = json_encode($enviada->mensajesList);
                                    
                                $codigo = "";
//                                

                                        if (is_array($cad)){

                                            for ($i=0; $i<sizeof($cad); $i++)
                                                $codigo = $codigo." ".$cad[0]->codigo;

                                        }else{
                                            $codigo = $cad->codigo;
                                        }    
                                        
                                        
                                            $params = array(
                                                'factura_codigodescripcion' => $codigo, //$cad->codigo,
                                                'factura_codigoestado' => "NO ENVIADA",//$cod->codigoEstado,
                                                'factura_mensajeslist' => $mensajecadena, //$enviada->mensajesList,
                                                'factura_transaccion'  => $enviada->transaccion,
                                                'factura_enviada' => false,//Factura enviada a impuestos, por defecto en false(No fue enviada)
                                            );

                                            $this->Factura_model->update_factura($factura_id, $params);

                                           echo json_encode($enviada);

                                
                                    
//                                            $params = array(
//                                                'factura_codigodescripcion' => $cad->codigo,
//                                                'factura_codigoestado' => "NO ENVIADA",//$cod->codigoEstado,
//                                                'factura_mensajeslist' => $mensajecadena, //$enviada->mensajesList,
//                                                'factura_transaccion'  => $enviada->transaccion,
//                                                'factura_enviada' => false,//Factura enviada a impuestos, por defecto en false(No fue enviada)
//                                            );
//
//                                            $this->Factura_model->update_factura($factura_id, $params);
//
//                                           echo json_encode($enviada);
                                    
                               
                                
                            }
                                /*
                                $sql = "update dosificacion set
                                        dosificacion_numfact = dosificacion_numfact - (select count(*) as cantidad from factura where factura_id = ".$factura_id." and factura_codigodescripcion <> 'VALIDADA')
                                        where dosificacion_id = 1";
                                echo $sql;
                                $this->Venta_model->ejecutar($sql);*/
                                
                            }else{ //Si la emision de la factura es de tipo 2 OFFLINE
                                //var_dump($registroeventos_codigo."QQWW");
                                //$registroeventos_codigo <= 0 no e s con CAFC e incrementa num. factura
                                if ($registroeventos_codigo <= 0){ 
                                    $sql = "update dosificacion set dosificacion_numfact = ".$factura_numero;
                                    $this->Venta_model->ejecutar($sql);
                                }
                                $res = array("mensajesList" => "No Enviado por  estar en offline");
                                    echo json_encode($res);
                            }
                            
                            $this->pdf_generar($factura_id);
                            
                            //if( $this->parametros["parametro_tipoemision"] == 1){ // solo cuando esta en linea manda correo
                            $email = $this->input->post('cliente_email'); 
                            if($email !=""){
                                $this->enviarcorreo($venta_id, $factura_id, $email,$nombre_archivo);
                            }
                                //}
                            // ******************************
                            //}
//                            }else{
//                                echo json_encode("false");
//                            }
                            
                        }
                        
                        $mandar_enuno = $this->input->post('mandar_enuno');
                        // si esta destiqueado ingresa aqui!; manda factura por factura!......
                        if($mandar_enuno == 0){
                            //Funcion en eventos con cafc
                            if ($registroeventos_codigo > 0){ //$registroeventos_codigo > 0 para que ingrese y envie los archivos con cafc
                                $sqlx = "update factura_contingencia set facturacontingencia_numero =  facturacontingencia_numero + 1";
                                $this->Venta_model->ejecutar($sqlx);

                                $codigo_recepcion = $this->registroEmisionPaquetes($factura_id,$registroeventos_codigo);

                                sleep(1);
                                if ($codigo_recepcion>0){
                                    $this->registroEmisionPaquetes_vacio($codigo_recepcion, $factura_id);
                                }
                            }
                        }elseif($mandar_enuno == 1){
                            //Funcion en eventos con cafc
                            if ($registroeventos_codigo > 0){ //$registroeventos_codigo > 0 para que ingrese y envie los archivos con cafc
                                $sqlx = "update factura_contingencia set facturacontingencia_numero =  facturacontingencia_numero + 1";
                                $this->Venta_model->ejecutar($sqlx);
                            }
                        }
                        // Fin Funcion en eventos con cafc
                        
                    }else{ // para tipo sistema == 1 Facturación Computarizada SFV
                        //********** INICIO ACTUALIZAR NUMERO DE FACTURA
                        $sql = "update dosificacion set dosificacion_numfact = ".$factura_numero;
                        $this->Venta_model->ejecutar($sql);
                        echo json_encode("");
                        //********** FIN INICIO ACTUALIZAR NUMERO DE FACTURA
                    }
                    // $this->ultimaventa(1);
    }
    
}
