<?php
/* 
 * Generated by CRUDigniter v3.2 
 * www.crudigniter.com
 */
 
class Caja extends CI_Controller{
    function __construct()
    {
        parent::__construct();
        $this->load->model('Caja_model');
        
        if ($this->session->userdata('logged_in')) {
            $this->session_data = $this->session->userdata('logged_in');
        }else {
            redirect('', 'refresh');
        }
    } 
    
    /* *****Funcion que verifica el acceso al sistema**** */
    private function acceso($id_rol){
        $rolusuario = $this->session_data['rol'];
        if($rolusuario[$id_rol-1]['rolusuario_asignado'] == 1){
            return true;
        }else{
//            $data['_view'] = 'login/mensajeacceso';
//            $this->load->view('layouts/main',$data);
            return false;
        }
    }     

    /*
     * Listing of caja
     */
    function index()
    {
     

        if($this->acceso(18)){
        //**************** inicio contenido ***************
        $data['rolusuario'] = $this->session_data['rol'];
        $data['tipousuario_id'] = $this->session_data['tipousuario_id'];
        $usuario_id = $this->session_data['usuario_id'];
        
        //$data['venta'] = $this->Venta_model->get_all_venta($params);
            
        if ($this->session_data['tipousuario_id']==1){ // si es administrador mostrar todas la cajas
            
            $data['caja'] = $this->Caja_model->get_all_caja();
            $data['_view'] = 'caja/index';
            $this->load->view('layouts/main',$data);
            
        }else{
            
            $data['caja'] = $this->Caja_model->get_mis_cajas($usuario_id);
            $data['_view'] = 'caja/index';
            $this->load->view('layouts/main',$data);
            
        }
        

        
        //**************** fin contenido ***************
        }        
        
        
        
        
    
    }

    /*
     * Adding a new caja
     */
    function add()
    {   
        
//        if(isset($_POST) && count($_POST) > 0)     
//        {   
//            $params = array(
//				'caja_apertura' => $this->input->post('caja_apertura'),
//				'caja_fechaapertura' => $this->input->post('caja_fechaapertura'),
//				'caja_horaapertura' => $this->input->post('caja_horaapertura'),
//				'caja_cierre' => $this->input->post('caja_cierre'),
//				'caja_horacierre' => $this->input->post('caja_horacierre'),
//				'caja_fechacierre' => $this->input->post('caja_fechacierre'),
//				'caja_diferencia' => $this->input->post('caja_diferencia'),
//            );
//            
//            $caja_id = $this->Caja_model->add_caja($params);
//            redirect('caja/index');
//        }
//        else
//        {            
//            $data['_view'] = 'caja/add';
//            $this->load->view('layouts/main',$data);
//        }
    }  
    
    function apertura_caja()
    {   

        //$data['tipousuario_id'] = $this->session_data['tipousuario_id'];
        $usuario_id = $this->session_data['usuario_id'];
        
        if(isset($_POST) && count($_POST) > 0)     
        {   
            
            $sql = "select * from caja where caja_fechaapertura = date(now()) and usuario_id = ".$usuario_id;
            $res = $this->Caja_model->consultar($sql);
            
            if(sizeof($res)>0){
//                echo "<script type='javascript'> alert('EL USUARIO: Ya registro su apertura de caja...!'); </script>";

                redirect('caja/index');
            }
            else{
                
                $caja_apertura = $this->input->post('caja_apertura');
                $caja_fechaapertura = "date(now())";
                $caja_horaapertura = "time(now())";
                $caja_diferencia = "0";

                $sql = "insert into caja(caja_apertura,caja_fechaapertura,caja_horaapertura,caja_diferencia,usuario_id) value(".
                        $caja_apertura.",".
                        $caja_fechaapertura.",".
                        $caja_horaapertura.",".
                        $caja_diferencia.",".
                        $usuario_id.")";
                
                $this->Caja_model->ejecutar($sql);
                redirect('caja/index');
                
            }
            
        }
        else
        {            
            $data['_view'] = 'caja/apertura';
            $this->load->view('layouts/main',$data);
        }
        
    }
    
    function verificar_apertura()
    {   

        //$data['tipousuario_id'] = $this->session_data['tipousuario_id'];
        $usuario_id = $this->session_data['usuario_id'];
                    
        $sql = "select * from caja where caja_fechaapertura = date(now()) and usuario_id = ".$usuario_id;
        $res = $this->Caja_model->consultar($sql);

        echo json_encode($res);

    }
    
    function registrar_apertura()
    {   

        $tipousuario_id = $this->session_data['tipousuario_id'];
        $usuario_id = $this->session_data['usuario_id'];
                    

        
        
        $caja_apertura = $this->input->post('caja_apertura');
        
        $caja_fechaapertura = "date(now())";
        $caja_horaapertura = "time(now())";
        $caja_diferencia = "0";

        $sql = "insert into caja(caja_apertura,caja_fechaapertura,caja_horaapertura,caja_diferencia,usuario_id) value(".
                $caja_apertura.",".
                $caja_fechaapertura.",".
                $caja_horaapertura.",".
                $caja_diferencia.",".
                $usuario_id.")";

        $this->Caja_model->ejecutar($sql);
                
        echo json_encode(true);

    }
    
    function mostrar_cajas()
    {   

        $tipousuario_id = $this->session_data['tipousuario_id'];
        $usuario_id = $this->session_data['usuario_id'];
                
        if ($tipousuario_id==1){
            
            $sql = "select * from caja where caja_fechaapertura = date(now())";
            
        }else{
            
            $sql = "select * from caja where caja_fechaapertura = date(now()) and usuario_id = ".$usuario_id;
            
        }

        $res = $this->Caja_model->consultar($sql);
                
        echo json_encode($res);

    }

    /*
     * Editing a caja
     */
    function edit($caja_id)
    {   
        // check if the caja exists before trying to edit it
        $data['caja'] = $this->Caja_model->get_caja($caja_id);
        
        if(isset($data['caja']['caja_id']))
        {
            if(isset($_POST) && count($_POST) > 0)     
            {   
                $params = array(
					'caja_apertura' => $this->input->post('caja_apertura'),
					'caja_fechaapertura' => $this->input->post('caja_fechaapertura'),
					'caja_horaapertura' => $this->input->post('caja_horaapertura'),
					'caja_cierre' => $this->input->post('caja_cierre'),
					'caja_horacierre' => $this->input->post('caja_horacierre'),
					'caja_fechacierre' => $this->input->post('caja_fechacierre'),
					'caja_diferencia' => $this->input->post('caja_diferencia'),
                );

                $this->Caja_model->update_caja($caja_id,$params);            
                redirect('caja/index');
            }
            else
            {
                $data['_view'] = 'caja/edit';
                $this->load->view('layouts/main',$data);
            }
        }
        else
            show_error('The caja you are trying to edit does not exist.');
    } 

    /*
     * Deleting caja
     */
    function remove($caja_id)
    {
        $caja = $this->Caja_model->get_caja($caja_id);

        // check if the caja exists before trying to delete it
        if(isset($caja['caja_id']))
        {
            $this->Caja_model->delete_caja($caja_id);
            redirect('caja/index');
        }
        else
            show_error('The caja you are trying to delete does not exist.');
    }
    
}
