<?php
/* 
 * Generated by CRUDigniter v3.2 
 * www.crudigniter.com
 */
 
class Caja extends CI_Controller{
    
    private $caja_id = 0;
    private $sistema;
    private $parametros;
    
    function __construct()
    {
        parent::__construct();
        $this->load->model('Caja_model');
        $this->load->model('Moneda_model');
        $this->load->model('Venta_model');
        $this->load->model('Detalle_venta_model');
        $this->load->model('Empresa_model');
        $this->load->model('Parametro_model');
        $this->load->model('Usuario_model');
        if ($this->session->userdata('logged_in')) {
            $this->session_data = $this->session->userdata('logged_in');
        }else {
            redirect('', 'refresh');
        }
        
        //*********** Administracion de caja *********
        $usuario_id = $this->session_data['usuario_id'];
        $caja = $this->Caja_model->get_caja_usuario($usuario_id);

        if (!sizeof($caja)>0){ // si la caja no esta iniciada
            //iniciar caja y dejarla en pendiente
            $this->caja_id = 0;
        }else{
            $this->caja_id = $caja[0]["caja_id"];

        }
        //*********** FIN Administracion de caja *********
        $this->load->model('Sistema_model');
        $this->sistema = $this->Sistema_model->get_sistema();
        $parametro = $this->Parametro_model->get_parametros();
        $this->parametros = $parametro[0];
        
    }
    /* *****Funcion que verifica el acceso al sistema**** */
    private function acceso($id_rol){
        $data['sistema'] = $this->sistema;
        
        $rolusuario = $this->session_data['rol'];
        if($rolusuario[$id_rol-1]['rolusuario_asignado'] == 1){
            return true;
        }else{
            $data['_view'] = 'login/mensajeacceso';
            $this->load->view('layouts/main',$data);
        }
    }

    /*
     * Listing of caja
     */
    function index()
    {
        $data['parametro'] =  $this->parametros;
        $data['sistema'] = $this->sistema;
        $data['caja'] = $this->Caja_model->get_all_caja();
        
        $data['_view'] = 'caja/index';
        $this->load->view('layouts/main',$data);
    }

    /*
     * Adding a new caja
     */
    function add()
    {
        $data['parametro'] =  $this->parametros;
        $data['sistema'] = $this->sistema;
        $this->load->library('form_validation');
        $this->form_validation->set_rules('caja_apertura','Apertura','trim|required', array('required' => 'Este Campo no debe ser vacio'));
        $this->form_validation->set_rules('caja_fechaapertura','Fecha Apertura','trim|required', array('required' => 'Este Campo no debe ser vacio'));
        $this->form_validation->set_rules('caja_horaapertura','Hora Apertura','trim|required', array('required' => 'Este Campo no debe ser vacio'));
        $usuario_id = $this->session_data['usuario_id'];
        $this->load->model('Parametro_model');
        $data['all_parametro'] = $this->Parametro_model->get_parametros();
        
        if($this->form_validation->run())     
        {
            $estado = 30;
            $params = array(
                'estado_id' => $estado,
                'moneda_id' => $data['all_parametro'][0]['moneda_id'],
                'usuario_id' => $usuario_id,
                'caja_apertura' => $this->input->post('caja_apertura'),
                'caja_fechaapertura' => $this->input->post('caja_fechaapertura'),
                'caja_horaapertura' => $this->input->post('caja_horaapertura'),
                /*'caja_cierre' => $this->input->post('caja_cierre'),
                'caja_horacierre' => $this->input->post('caja_horacierre'),
                'caja_fechacierre' => $this->input->post('caja_fechacierre'),*/
                'caja_diferencia' => $this->input->post('caja_diferencia'),
                'caja_corte1000' => $this->input->post('caja_corte1000'),
                'caja_corte500' => $this->input->post('caja_corte500'),
                'caja_corte200' => $this->input->post('caja_corte200'),
                'caja_corte100' => $this->input->post('caja_corte100'),
                'caja_corte50' => $this->input->post('caja_corte50'),
                'caja_corte20' => $this->input->post('caja_corte20'),
                'caja_corte10' => $this->input->post('caja_corte10'),
                'caja_corte5' => $this->input->post('caja_corte5'),
                'caja_corte2' => $this->input->post('caja_corte2'),
                'caja_corte1' => $this->input->post('caja_corte1'),
                'caja_corte050' => $this->input->post('caja_corte050'),
                'caja_corte020' => $this->input->post('caja_corte020'),
                'caja_corte010' => $this->input->post('caja_corte010'),
                'caja_corte005' => $this->input->post('caja_corte005'),
                /*'caja_efectivo' => $this->input->post('caja_efectivo'),
                'caja_credito' => $this->input->post('caja_credito'),
                'caja_transacciones' => $this->input->post('caja_transacciones'),*/
                /*'caja_imagen1000' => $this->input->post('caja_imagen1000'),
                'caja_imagen500' => $this->input->post('caja_imagen500'),
                'caja_imagen200' => $this->input->post('caja_imagen200'),
                'caja_imagen100' => $this->input->post('caja_imagen100'),
                'caja_imagen50' => $this->input->post('caja_imagen50'),
                'caja_imagen20' => $this->input->post('caja_imagen20'),
                'caja_imagen10' => $this->input->post('caja_imagen10'),
                'caja_imagen5' => $this->input->post('caja_imagen5'),
                'caja_imagen2' => $this->input->post('caja_imagen2'),
                'caja_imagen1' => $this->input->post('caja_imagen1'),
                'caja_imagen020' => $this->input->post('caja_imagen020'),
                'caja_imagen050' => $this->input->post('caja_imagen050'),
                'caja_imagen010' => $this->input->post('caja_imagen010'),
                'caja_imagen005' => $this->input->post('caja_imagen005'),*/
            );
            
            $caja_id = $this->Caja_model->add_caja($params);
            redirect('caja/index');
        }
        else
        {
            /*$this->load->model('Estado_model');
            $data['all_estado'] = $this->Estado_model->get_all_estado();
            
            $this->load->model('Moneda_model');
            $data['all_moneda'] = $this->Moneda_model->get_all_moneda();
            
            $this->load->model('Usuario_model');
            $data['all_usuario'] = $this->Usuario_model->get_all_usuario();
            */
            $data['_view'] = 'caja/add';
            $this->load->view('layouts/main',$data);
        }
    }  

    /*
     * Editing a caja
     */
    function edit($caja_id)
    {
        $data['sistema'] = $this->sistema;
        // check if the caja exists before trying to edit it
        $data['caja'] = $this->Caja_model->get_caja($caja_id);
        $data['parametro'] =  $this->parametros;
        
        if(isset($data['caja']['caja_id']))
        {
            if(isset($_POST) && count($_POST) > 0)     
            {
                $params = array(
                    'estado_id' => $this->input->post('estado_id'),
                    'moneda_id' => $this->input->post('moneda_id'),
                    'usuario_id' => $this->input->post('usuario_id'),
                    'caja_apertura' => $this->input->post('caja_apertura'),
                    'caja_fechaapertura' => $this->input->post('caja_fechaapertura'),
                    'caja_horaapertura' => $this->input->post('caja_horaapertura'),
                    'caja_cierre' => $this->input->post('caja_cierre'),
                    'caja_horacierre' => $this->input->post('caja_horacierre'),
                    'caja_fechacierre' => $this->input->post('caja_fechacierre'),
                    'caja_diferencia' => $this->input->post('caja_diferencia'),
                    'caja_corte1000' => $this->input->post('caja_corte1000'),
                    'caja_corte500' => $this->input->post('caja_corte500'),
                    'caja_corte200' => $this->input->post('caja_corte200'),
                    'caja_corte100' => $this->input->post('caja_corte100'),
                    'caja_corte50' => $this->input->post('caja_corte50'),
                    'caja_corte20' => $this->input->post('caja_corte20'),
                    'caja_corte10' => $this->input->post('caja_corte10'),
                    'caja_corte5' => $this->input->post('caja_corte5'),
                    'caja_corte2' => $this->input->post('caja_corte2'),
                    'caja_corte1' => $this->input->post('caja_corte1'),
                    'caja_corte050' => $this->input->post('caja_corte050'),
                    'caja_corte020' => $this->input->post('caja_corte020'),
                    'caja_corte010' => $this->input->post('caja_corte010'),
                    'caja_corte005' => $this->input->post('caja_corte005'),
                    'caja_efectivo' => $this->input->post('caja_efectivo'),
                    'caja_credito' => $this->input->post('caja_credito'),
                    'caja_transacciones' => $this->input->post('caja_transacciones'),
                );
                $this->Caja_model->update_caja($caja_id,$params);            
                redirect('caja/index');
            }else{
                $this->load->model('Estado_model');
                $tipo = 8;
                $data['all_estado'] = $this->Estado_model->get_estado_tipo($tipo);

                $this->load->model('Moneda_model');
                $data['all_moneda'] = $this->Moneda_model->get_all_moneda();

                $this->load->model('Usuario_model');
                $data['all_usuario'] = $this->Usuario_model->get_all_usuario_activo();

                $data['_view'] = 'caja/edit';
                $this->load->view('layouts/main',$data);
            }
        }
        else
            show_error('The caja you are trying to edit does not exist.');
    } 

    /*
     * Deleting caja
     */
    function remove($caja_id)
    {
        $data['sistema'] = $this->sistema;
        $caja = $this->Caja_model->get_caja($caja_id);

        // check if the caja exists before trying to delete it
        if(isset($caja['caja_id']))
        {
            $this->Caja_model->delete_caja($caja_id);
            redirect('caja/index');
        }
        else
            show_error('The caja you are trying to delete does not exist.');
    }

    /*
     * Aperturar Caja
     */
    function abrir_caja()
    {
        $monto_caja = $this->input->post("monto_caja");
        $caja_id = $this->input->post("caja_id");
        
        $sql = "update caja set caja_apertura = ".$monto_caja.", caja_fechaapertura = date(now()), ".
                "caja_horaapertura = time(now()) where caja_id = ".$caja_id;
        
        $this->Caja_model->ejecutar($sql);
        echo json_encode($sql);
        //echo json_encode(true);
        
    }
    
    /*
     * Aperturar Caja
     */
    function abrir_lacaja()
    {
        $caja_apertura = $this->input->post("monto_caja");
        if(trim($caja_apertura) == ""){
            echo json_encode("no");
        }else{        
            $caja_id = $this->input->post("caja_id");
            $fecha_aper = date('Y-m-d');
            $hora_aper  = date('H:i:s');
            $params = array(
                'estado_id' => 30,
                'caja_apertura' => $this->input->post('monto_caja'),
                'caja_fechaapertura' => $fecha_aper,
                'caja_horaapertura' => $hora_aper,
            );
            $this->Caja_model->update_caja($caja_id,$params);
            echo json_encode("ok");
        }
    }
    /*
     * cierre de una caja
     */
    function cierre_caja($caja_id)
    {
        $data['sistema'] = $this->sistema;
        $data['parametro'] =  $this->parametros;
        
        $this->load->library('form_validation');
        $this->form_validation->set_rules('caja_cierre','Cierre','trim|required', array('required' => 'Este Campo no debe ser vacio'));
        $this->form_validation->set_rules('caja_fechacierre','Fecha de Cierre','trim|required', array('required' => 'Este Campo no debe ser vacio'));
        $this->form_validation->set_rules('caja_horacierre','Hora de Cierre','trim|required', array('required' => 'Este Campo no debe ser vacio'));
        $usuario_id = $this->session_data['usuario_id'];
        
        $caja = $this->Caja_model->get_caja_usuario($usuario_id);
        
        if($caja_id == $caja[0]["caja_id"]){
        
            //$this->load->model('Parametro_model');
            $data['all_parametro'] = $this->parametros;

            $data['usuario_id'] = $usuario_id;
            $data['usuario_nombre'] = $this->session_data['usuario_nombre'];
            $data['moneda'] = $this->Moneda_model->get_moneda(2); //Obtener moneda extragera        
            $data['tipousuario_id'] = $this->session_data['tipousuario_id'];
            $data['caja'] = $this->Caja_model->get_caja($caja_id);

            if($this->form_validation->run())     
            {
                $estado = 31;
                $params = array(
                    'estado_id' => $estado,
                    /*'moneda_id' => $data['all_parametro'][0]['moneda_id'],
                    'usuario_id' => $usuario_id,
                    'caja_apertura' => $this->input->post('caja_apertura'),
                    'caja_fechaapertura' => $this->input->post('caja_fechaapertura'),
                    'caja_horaapertura' => $this->input->post('caja_horaapertura'),*/
                    'caja_transacciones' => $this->input->post('saldo_caja'),
                    'caja_cierre' => $this->input->post('caja_cierre'),
                    'caja_horacierre' => $this->input->post('caja_horacierre'),
                    'caja_fechacierre' => $this->input->post('caja_fechacierre'),
                    'caja_diferencia' => $this->input->post('caja_diferencia'),
                    'caja_corte1000' => $this->input->post('caja_corte1000'),
                    'caja_corte500' => $this->input->post('caja_corte500'),
                    'caja_corte200' => $this->input->post('caja_corte200'),
                    'caja_corte100' => $this->input->post('caja_corte100'),
                    'caja_corte50' => $this->input->post('caja_corte50'),
                    'caja_corte20' => $this->input->post('caja_corte20'),
                    'caja_corte10' => $this->input->post('caja_corte10'),
                    'caja_corte5' => $this->input->post('caja_corte5'),
                    'caja_corte2' => $this->input->post('caja_corte2'),
                    'caja_corte1' => $this->input->post('caja_corte1'),
                    'caja_corte050' => $this->input->post('caja_corte050'),
                    'caja_corte020' => $this->input->post('caja_corte020'),
                    'caja_corte010' => $this->input->post('caja_corte010'),
                    'caja_corte005' => $this->input->post('caja_corte005'),
                    'caja_efectivo' => $this->input->post('caja_efectivo'),
                    'caja_credito' => $this->input->post('caja_credito'),


                    /*'caja_imagen1000' => $this->input->post('caja_imagen1000'),
                    'caja_imagen500' => $this->input->post('caja_imagen500'),
                    'caja_imagen200' => $this->input->post('caja_imagen200'),
                    'caja_imagen100' => $this->input->post('caja_imagen100'),
                    'caja_imagen50' => $this->input->post('caja_imagen50'),
                    'caja_imagen20' => $this->input->post('caja_imagen20'),
                    'caja_imagen10' => $this->input->post('caja_imagen10'),
                    'caja_imagen5' => $this->input->post('caja_imagen5'),
                    'caja_imagen2' => $this->input->post('caja_imagen2'),
                    'caja_imagen1' => $this->input->post('caja_imagen1'),
                    'caja_imagen020' => $this->input->post('caja_imagen020'),
                    'caja_imagen050' => $this->input->post('caja_imagen050'),
                    'caja_imagen010' => $this->input->post('caja_imagen010'),
                    'caja_imagen005' => $this->input->post('caja_imagen005'),*/
                );

                $this->Caja_model->update_caja($caja_id, $params);
               
                ////redirect('caja/reporte_caja/'.$caja_id);
                redirect('reportes/reportecaja/');
                
            }else{
                /*$this->load->model('Estado_model');
                $data['all_estado'] = $this->Estado_model->get_all_estado();

                $this->load->model('Moneda_model');
                $data['all_moneda'] = $this->Moneda_model->get_all_moneda();

                $this->load->model('Usuario_model');
                $data['all_usuario'] = $this->Usuario_model->get_all_usuario();
                */
                $data['_view'] = 'caja/cierre_caja';
                $this->load->view('layouts/main',$data);
            }
        }
        else{
            if(isset($caja[0]["caja_id"]))    
                redirect("caja/cierre_caja/".$caja[0]["caja_id"]);
            else 
                redirect('admin/dashb');
        }
    }
    
    function registrar_bitacora(){
        
        $data['sistema'] = $this->sistema;
        //$bitacoracaja_fecha = $this->input->post("bitacoracaja_fecha");
        //$bitacoracaja_hora = $this->input->post("");
        $bitacoracaja_evento = $this->input->post("bitacoracaja_evento");
        $usuario_id = $this->session_data['usuario_id'];
        $bitacoracaja_montoreg = $this->input->post("bitacoracaja_montoreg");
        $bitacoracaja_montocaja = $this->input->post("bitacoracaja_montocaja");
        $bitacoracaja_tipo = $this->input->post("bitacoracaja_tipo");        
        
        
        $sql = "insert into bitacora_caja(bitacoracaja_fecha, bitacoracaja_hora, bitacoracaja_evento, 
                usuario_id, bitacoracaja_montoreg, bitacoracaja_montocaja, bitacoracaja_tipo, caja_id) value(date(now()),time(now())".
                ",'".$bitacoracaja_evento."',".$usuario_id.",".
                $bitacoracaja_montoreg.",".$bitacoracaja_montocaja.",".$bitacoracaja_tipo.",".$this->caja_id.")";
        
        $this->Caja_model->ejecutar($sql);
        
        return json_encode(true);
    }
    
    
    function reporte_caja($caja_id){
        
        $data['sistema'] = $this->sistema;
        $usuario_id = $this->session_data['usuario_id'];
        
        $data['caja'] = $this->Caja_model->get_caja_id($caja_id);
        
        $data['empresa'] = $this->Empresa_model->get_empresa(1);        
        $data['page_title'] = "Cierre de Caja";

        //$data['parametro'] = $this->Parametro_model->get_parametros();
        $data['parametro'] =  $this->parametros;
        $data['moneda'] = $this->Moneda_model->get_moneda($data['parametro']['moneda_id']);
   
        $this->load->helper('numeros_helper'); // Helper para convertir numeros a letras

        
                $data['_view'] = 'caja/reportecaja_boucher';
                $this->load->view('layouts/main',$data);
    }
    /*
     * cierre de una caja
     */
    function cierre_cajadmin($caja_id)
    {
        $data['sistema'] = $this->sistema;
        $this->load->library('form_validation');
        $this->form_validation->set_rules('caja_cierre','Cierre','trim|required', array('required' => 'Este Campo no debe ser vacio'));
        $this->form_validation->set_rules('caja_fechacierre','Fecha de Cierre','trim|required', array('required' => 'Este Campo no debe ser vacio'));
        $this->form_validation->set_rules('caja_horacierre','Hora de Cierre','trim|required', array('required' => 'Este Campo no debe ser vacio'));
        $usuario_id = $this->session_data['usuario_id'];
        
        $caja = $this->Caja_model->get_caja_usuarioadmin($caja_id);
        
        if($caja_id == $caja["caja_id"]){
        
//            $this->load->model('Parametro_model');
//            $data['all_parametro'] = $this->Parametro_model->get_parametros();
            $data['all_parametro'] =  $this->parametros;

            $data['usuario_id'] = $caja['usuario_id'];
            
            $usuario_caja = $this->Usuario_model->get_usuario($data['usuario_id']);
            $data['usuario_nombre'] = $usuario_caja['usuario_nombre'];
            //$data['usuario_nombre'] = $this->session_data['usuario_nombre'];
            $data['moneda'] = $this->Moneda_model->get_moneda(2); //Obtener moneda extragera        
            $data['tipousuario_id'] = $this->session_data['tipousuario_id'];
            $data['caja'] = $caja; //$this->Caja_model->get_caja($caja_id);

            if($this->form_validation->run())     
            {
                $estado = 31;
                $params = array(
                    'estado_id' => $estado,
                    /*'moneda_id' => $data['all_parametro'][0]['moneda_id'],
                    'usuario_id' => $usuario_id,
                    'caja_apertura' => $this->input->post('caja_apertura'),
                    'caja_fechaapertura' => $this->input->post('caja_fechaapertura'),
                    'caja_horaapertura' => $this->input->post('caja_horaapertura'),*/
                    'caja_transacciones' => $this->input->post('saldo_caja'),
                    'caja_cierre' => $this->input->post('caja_cierre'),
                    'caja_horacierre' => $this->input->post('caja_horacierre'),
                    'caja_fechacierre' => $this->input->post('caja_fechacierre'),
                    'caja_diferencia' => $this->input->post('caja_diferencia'),
                    'caja_corte1000' => $this->input->post('caja_corte1000'),
                    'caja_corte500' => $this->input->post('caja_corte500'),
                    'caja_corte200' => $this->input->post('caja_corte200'),
                    'caja_corte100' => $this->input->post('caja_corte100'),
                    'caja_corte50' => $this->input->post('caja_corte50'),
                    'caja_corte20' => $this->input->post('caja_corte20'),
                    'caja_corte10' => $this->input->post('caja_corte10'),
                    'caja_corte5' => $this->input->post('caja_corte5'),
                    'caja_corte2' => $this->input->post('caja_corte2'),
                    'caja_corte1' => $this->input->post('caja_corte1'),
                    'caja_corte050' => $this->input->post('caja_corte050'),
                    'caja_corte020' => $this->input->post('caja_corte020'),
                    'caja_corte010' => $this->input->post('caja_corte010'),
                    'caja_corte005' => $this->input->post('caja_corte005'),
                    'caja_efectivo' => $this->input->post('caja_efectivo'),
                    'caja_credito' => $this->input->post('caja_credito'),

                    
                );

                $this->Caja_model->update_caja($caja_id, $params);
                redirect('caja/reporte_caja/'.$caja_id);
                
            }else{
                
                $data['_view'] = 'caja/cierre_cajadmin';
                $this->load->view('layouts/main',$data);
            }
        }
        else{
            if(isset($caja["caja_id"]))    
                redirect("caja/cierre_cajadmin/".$caja["caja_id"]);
            else 
                redirect('admin/dashb');
        }
    }
}
