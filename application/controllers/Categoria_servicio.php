<?php
/* 
 * Generated by CRUDigniter v3.2 
 * www.crudigniter.com
 */
 
class Categoria_servicio extends CI_Controller{
    private $session_data = "";
    private $sistema;
    
    function __construct()
    {
        parent::__construct();
        $this->load->model('Categoria_servicio_model');
        if ($this->session->userdata('logged_in')) {
            $this->session_data = $this->session->userdata('logged_in');
        }else {
            redirect('', 'refresh');
        }
        $this->load->model('Sistema_model');
        $this->sistema = $this->Sistema_model->get_sistema();
    } 
    /* *****Funcion que verifica el acceso al sistema**** */
    private function acceso($id_rol){
        $data['sistema'] = $this->sistema;
        $rolusuario = $this->session_data['rol'];
        if($rolusuario[$id_rol-1]['rolusuario_asignado'] == 1){
            return true;
        }else{
            $data['_view'] = 'login/mensajeacceso';
            $this->load->view('layouts/main',$data);
        }
    }
    /*
     * Listing of categoria_servicio
     */
    function index()
    {
        $data['sistema'] = $this->sistema;
        if($this->acceso(119)){
            $data['page_title'] = "Categoria Servicio";
            $data['categoria_servicio'] = $this->Categoria_servicio_model->get_all_categoria_servicio();

            $data['_view'] = 'categoria_servicio/index';
            $this->load->view('layouts/main',$data);
        }
    }

    /*
     * Adding a new categoria_servicio
     */
    function add()
    {
        $data['sistema'] = $this->sistema;
        if($this->acceso(119)){
            $data['page_title'] = "Categoria Servicio";
            $this->load->library('form_validation');
            $this->form_validation->set_rules('catserv_descripcion','Categoria Servicio Descripcion','trim|required', array('required' => 'Este Campo no debe ser vacio'));
            if($this->form_validation->run())     
            {
                //Estado ACTIVO por defecto
                $estado_id = 1;
                $params = array(
                    'catserv_descripcion' => $this->input->post('catserv_descripcion'),
                    'estado_id' => $estado_id,
                );

                $catserv_id = $this->Categoria_servicio_model->add_categoria_servicio($params);
                redirect('categoria_servicio/index');
            }
            else
            {
                $data['_view'] = 'categoria_servicio/add';
                $this->load->view('layouts/main',$data);
            }
        }
    }  

    /*
     * Editing a categoria_servicio
     */
    function edit($catserv_id)
    {
        $data['sistema'] = $this->sistema;
        if($this->acceso(119)){
            $data['page_title'] = "Categoria Servicio";
            // check if the categoria_servicio exists before trying to edit it
            $data['categoria_servicio'] = $this->Categoria_servicio_model->get_categoria_servicio($catserv_id);

            if(isset($data['categoria_servicio']['catserv_id']))
            {
                $this->load->library('form_validation');
                $this->form_validation->set_rules('catserv_descripcion','Categoria Servicio Descripcion','trim|required', array('required' => 'Este Campo no debe ser vacio'));
                if($this->form_validation->run())
                {   
                    $params = array(
                        'catserv_descripcion' => $this->input->post('catserv_descripcion'),
                        'estado_id' => $this->input->post('estado_id'),
                    );

                    $this->Categoria_servicio_model->update_categoria_servicio($catserv_id,$params);            
                    redirect('categoria_servicio/index');
                }
                else
                {
                    $this->load->model('Estado_model');
                    $data['all_estado'] = $this->Estado_model->get_all_estado_activo_inactivo();
                    $data['_view'] = 'categoria_servicio/edit';
                    $this->load->view('layouts/main',$data);
                }
            }
            else
                show_error('The categoria_servicio you are trying to edit does not exist.');
        }
    } 

    /*
     * Deleting categoria_servicio
     */
    function remove($catserv_id)
    {
        $data['sistema'] = $this->sistema;
        if($this->acceso(119)){
            $categoria_servicio = $this->Categoria_servicio_model->get_categoria_servicio($catserv_id);

            // check if the categoria_servicio exists before trying to delete it
            if(isset($categoria_servicio['catserv_id']))
            {
                $this->Categoria_servicio_model->delete_categoria_servicio($catserv_id);
                redirect('categoria_servicio/index');
            }
            else
                show_error('The categoria_servicio you are trying to delete does not exist.');
        }
    }
    
    /*
     * Listing of categoria_servicio
     */
    function catserv_detalle($catserv_id)
    {
        $data['sistema'] = $this->sistema;
        if($this->acceso(119)){
            $data['page_title'] = "Categoria Servicio";
            $nombre = $this->Categoria_servicio_model->get_categoria_servicio($catserv_id);
            $data['nombre'] = $nombre['catserv_descripcion'];
            $this->load->model('Subcategoria_servicio_model');
            $data['all_subcategoria'] = $this->Subcategoria_servicio_model->get_all_subcategoria_de_categoria2($catserv_id);
            $data['_view'] = 'categoria_servicio/catserv_detalle';
            $this->load->view('layouts/main',$data);
        }
    }
    /*
     * Listing of categoria_servicio
     */
    function getcatserv_detalle()
    {
        if($this->acceso(119)){
            $datos = $this->Categoria_servicio_model->get_all_categoria_servicio();
            echo json_encode($datos);
        }
    }
     /*
     * obtiene las sub-categorias de una categoria
     */
    function obtenersubcatserv($catserv_id)
    {
        if($this->acceso(119)){
            $this->load->model('Subcategoria_servicio_model');
            $datos = $this->Subcategoria_servicio_model->get_all_subcategoria_de_categoria2($catserv_id);
            echo json_encode($datos);
        }
    }
}
