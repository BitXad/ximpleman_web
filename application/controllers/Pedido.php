<?php
/* 
 * Generated by CRUDigniter v3.2 
 * www.crudigniter.com
 */
 
class Pedido extends CI_Controller{
    function __construct()
    {
        parent::__construct();
        $this->load->model('Empresa_model');
        $this->load->model('Pedido_model');
        $this->load->model('Producto_model');
        $this->load->model('Estado_model');
        $this->load->model('Tipo_transaccion_model');
        $this->load->model('Forma_pago_model');
        $this->load->model('Tipo_transaccion_model');
        $this->load->model('Venta_model');
        $this->load->model('Usuario_model');
        if ($this->session->userdata('logged_in')) {
            $this->session_data = $this->session->userdata('logged_in');
        }else {
            redirect('', 'refresh');
        }
        
    }
    private function acceso($id_rol){
        $rolusuario = $this->session_data['rol'];
        if($rolusuario[$id_rol-1]['rolusuario_asignado'] == 1){
            return true;
        }else{
            $data['_view'] = 'login/mensajeacceso';
            $this->load->view('layouts/main',$data);
        }
    } 

    /*
     * Listing of pedido
     */
    function index()
    {
        
        if($this->acceso(30)) {
                
        //**************** inicio contenido ***************            
        $usuario_id = $this->session_data['usuario_id'];
        $usuario_nombre = $this->session_data['usuario_nombre'];
        $tipousuario_id = $this->session_data['tipousuario_id'];
        
//        $params['limit'] = RECORDS_PER_PAGE; 
//        $params['offset'] = ($this->input->get('per_page')) ? $this->input->get('per_page') : 0;
//        
//        $config = $this->config->item('pagination');
//        $config['base_url'] = site_url('pedido/index?');
//        $config['total_rows'] = $this->Pedido_model->get_all_pedido_count();
//        $this->pagination->initialize($config);
        
        
        $data['page_title'] = "Pedidos";
        $data['usuario'] = $this->Usuario_model->get_todos_usuario();
        $data['tipo_transaccion'] = $this->Tipo_transaccion_model->get_all_tipo();
        $data['usuario_id'] = $usuario_id;
        $data['tipousuario_id'] = $tipousuario_id;
        $data['usuario_nombre'] = $usuario_nombre;
        $data['usuarios'] = $this->Venta_model->get_usuarios();
        
        $filtro = $this->input->post('filtro');
        
        if ($filtro == null){
            $data['pedido'] = $this->Pedido_model->get_pedidos(" and date(p.pedido_fecha) = date(now())");
        }
        else{
            $data['pedido'] = $this->Pedido_model->get_pedidos($filtro);            
        }
        
        $data['pedidosn'] = $this->Pedido_model->get_pedido_sin_nombre($usuario_id);
        $data['estado'] = $this->Estado_model->get_tipo_estado(5);
        
        $data['_view'] = 'pedido/index';
        $this->load->view('layouts/main',$data);
        
        		
        //**************** fin contenido ***************
        			}
        			       
        
    }
    /*
     * Listing of pedido
     */
    function nota_pedido($pedido_id)
    {
        
        if($this->acceso(32)) {
        //**************** inicio contenido ***************            
        $usuario_id = $this->session_data['usuario_id'];
        $empresa_id = 1;
        
        $data['page_title'] = "Nota de Pedido";
        $data['pedido'] = $data['pedido'] = $this->Pedido_model->get_pedido_id($pedido_id);
        $data['empresa'] = $data['empresa'] = $this->Empresa_model->get_empresa($empresa_id);
        
        $data['_view'] = 'pedido/nota_pedido';
        $this->load->view('layouts/main',$data);
        
        		
        //**************** fin contenido ***************
        			}
        		
    }
    /*
     * Listing of pedido
     */
    function mostrar_pedidos()
    {
        if($this->acceso(30)) {
        //**************** inicio contenido ***************            
        
        $usuario_id = $this->session_data['usuario_id'];

        if ($this->input->is_ajax_request()) {
            
            $filtro = $this->input->post('filtro');
            
            if ($filtro == null){
                $result = $this->Pedido_model->get_pedidos(" and date(p.pedido_fecha) = date(now()) and p.usuario_id=".$usuario_id);
            }
            else{
                $result = $this->Pedido_model->get_pedidos($filtro);            
            }

           echo json_encode($result);
            
        }
        else
        {                 
                    show_404();
        }  
        		
        //**************** fin contenido ***************
        			}
        			
    }

    /*
     * Registrar pedido
     */
    function crearpedido()
    {
        
        if($this->acceso(31)) {
        //**************** inicio contenido ***************            
        $usuario_id = $this->session_data['usuario_id'];
        
        //Registrar Pedido
        $pedido_id = $this->Pedido_model->crear_pedido($usuario_id);        
        redirect('pedido/pedidoabierto/'.$pedido_id);
        
        		
        //**************** fin contenido ***************
        			}
        			        
    }
    

    /*
     * Registrar pedido
     */
    function pedidoabierto($pedido_id)
    {
        if($this->acceso(30)) {
        //**************** inicio contenido ***************            
        
        $data['page_title'] = "Pedidos";
        $usuario_id = $this->session_data['usuario_id'];
        
//        $usuarioped_id = $pedido[0]['usuario_id'];
        
//        if ($usuario_id == $usuarioped_id){
            
        $pedido = $this->Pedido_model->get_cliente_id($pedido_id);
        
        if(sizeof($pedido)>0)        
            $cliente_id = $pedido[0]['cliente_id'];
        else
            $cliente_id = 0;
        
        
            if ($cliente_id == 0) //si el pedido aun no fue registrado a un cliente
            {    $data['pedido'] = $this->Pedido_model->get_pedido($pedido_id,$usuario_id); }
            else
            {    $data['pedido'] = $this->Pedido_model->get_pedido_cliente($pedido_id,$usuario_id); }

            $data['pedido_id'] = $pedido_id;
           // $data['detalle_pedido'] = $this->Pedido_model->get_detalle_pedido($pedido_id);
            $data['cliente'] = $this->Pedido_model->get_all_cliente($usuario_id);
            $data['tipo_transaccion'] = $this->Tipo_transaccion_model->get_all_tipo();

            $data['_view'] = 'pedido/pedidoabierto';
            $this->load->view('layouts/main',$data);            
                    
//        }
//        else{
//        
//            
//        }
//                          		
        //**************** fin contenido ***************
        			}
        			     
    }

    /*
     * Registrar pedido abierto
     */
    function detalle_pedido()
    {
        
           if($this->acceso(30)) {
        //**************** inicio contenido ***************    
        if ($this->input->is_ajax_request()) {
             
            
           $pedido_id = $this->input->post('pedido_id');
           $detalle_pedido = $this->Pedido_model->get_detalle_pedido($pedido_id);            
           echo json_encode($detalle_pedido);
            
        }
        else
        {                 
            show_404();
        }  
        		
        //**************** fin contenido ***************
        			}
        			      
    }

    /*
     * Pasar un pedido a ventas
     */
    function pasaraventas($pedido_id,$cliente_id)
    {
        if($this->acceso(30)) {
        //**************** inicio contenido ***************    
        $usuario_id = $this->session_data['usuario_id'];
                
        $sql = "insert into detalle_venta_aux(
            producto_id,
            venta_id,
            
            detalleven_codigo,
            detalleven_cantidad,
            detalleven_unidad,
            detalleven_costo,
            detalleven_precio,
            detalleven_subtotal,
            detalleven_descuento,
            detalleven_total,
            detalleven_caracteristicas,
            detalleven_preferencia,
            detalleven_comision,
            detalleven_tipocambio,
            usuario_id,
            producto_nombre,
            producto_unidad,
            producto_marca,
            categoria_id,
            producto_codigobarra

            
            )
            
            (select 
            d.producto_id,
            0 as venta_id,
            d.detalleped_codigo,
            d.detalleped_cantidad,
            d.detalleped_unidad,
            d.detalleped_costo,
            d.detalleped_precio,
            d.detalleped_subtotal,
            d.detalleped_descuento,
            d.detalleped_total,
            '' as caracteristicas,
            d.detalleped_preferencia,
            d.detalleped_comision,
            1 as tipocambio,
            e.usuario_id,
            p.producto_nombre,
            p.producto_unidad,
            p.producto_marca,
            p.categoria_id,
            p.producto_codigobarra

            from detalle_pedido d, pedido e,usuario u, producto p
            where p.producto_id = d.producto_id and e.pedido_id =".$pedido_id." and d.pedido_id = e.pedido_id and e.usuario_id = u.usuario_id)";
        
        $this->Pedido_model->ejecutar($sql);
        return true;
        		
        //**************** fin contenido ***************
        			}
        			         
    }
    /*
     * Pasar un pedido a ventas
     */
    function datoscliente()
    {
        if($this->acceso(30)) {
        //**************** inicio contenido ***************    
        if ($this->input->is_ajax_request()) {
            
            $cliente_id = $this->input->post('cliente_id');
            $sql = "select * from cliente where cliente_id = ".$cliente_id;
            $datosx = $this->Pedido_model->consultar($sql);

           echo json_encode($datosx);
            
        }
        else
        {                 
                    show_404();
        }  
        		
        //**************** fin contenido ***************
        			}
        			
    }
    
    function finalizarpedido()
    {
        
       if($this->acceso(30)) {
        //**************** inicio contenido ***************    
        $usuario_id = $this->session_data['usuario_id'];     
        $estado_id = 3;

        $tipotrans_id = $this->input->post('tipo_transaccion');
        $pedido_fecha = "now()";
        $pedido_id = $this->input->post('pedido_id');
        $pedido_subtotal = $this->input->post('pedido_subtotal');
        $pedido_descuento = $this->input->post('pedido_descuento');
        $pedido_total = $this->input->post('pedido_totalfinal');
        $pedido_glosa = $this->input->post('pedido_glosa');
        
        $pedido_latitud = $this->input->post('latitud');
        $pedido_longitud = $this->input->post('longitud');
        
        $fechahora = $this->input->post('fechahora_entrega');
        
//        $dato = '2011-07-12 10:35:27';
        $fecha = date('Y-m-d',strtotime($fechahora)); 
        $hora = date('H:i:s',strtotime($fechahora));          
        //$pedido_horaentrega = $this->input->post('pedido_horaentrega');
                
        $sql = "update pedido set "
                ."usuario_id = ".$usuario_id
                .",estado_id = 11"
                .",tipotrans_id = ".$tipotrans_id
                .",pedido_fecha = now()"
                .",pedido_subtotal = ".$pedido_subtotal
                .",pedido_descuento = ".$pedido_descuento
                .",pedido_total = ".$pedido_total
                .",pedido_glosa = '".$pedido_glosa."'"
                .",pedido_fechaentrega = '".$fecha."'"
                .",pedido_horaentrega = '".$hora."'"
                .",pedido_latitud = '".$pedido_latitud."'"
                .",pedido_longitud = '".$pedido_longitud."'"
                ."  where pedido_id=".$pedido_id;        

        $this->Pedido_model->ejecutar($sql);

        $sql = "update inventario i, detalle_pedido d set 
                i.existencia = i.existencia - d.detalleped_cantidad 
                where d.pedido_id = ".$pedido_id." and i.producto_id = d.producto_id";
        $this->Pedido_model->ejecutar($sql);
        
        redirect('pedido');
        		
        //**************** fin contenido ***************
        			}
        			         
    }

    /*
     * Registrar pedido
     */
    function ingresarproducto()
    {
       if($this->acceso(30)) {
        //**************** inicio contenido ***************            $usuario_id = 1;    
        
        
        $pedido_id = $this->input->post('pedido_id');
        $producto_id = $this->input->post('producto_id');
        $cantidad = $this->input->post('cantidad'); 
        $descuento = $this->input->post('descuento'); 
        $preferencia = $this->input->post('preferencia'); 
        $precio = $this->input->post('precio'); 
            
                
        $sql = "insert into detalle_pedido(
                pedido_id,
                producto_id,
                detalleped_codigo,
                detalleped_foto,
                detalleped_nombre,
                detalleped_unidad,
                detalleped_costo,
                detalleped_cantidad,
                detalleped_precio,
                detalleped_descuento,
                detalleped_subtotal,
                detalleped_total,
                detalleped_preferencia
                )
                (
                select
                ".$pedido_id.",
                producto_id,
                producto_codigo,
                producto_foto,
                producto_nombre,
                producto_unidad,
                producto_costo,
                ".$cantidad.",
                ".$precio." - ".$descuento.",
                 0,
                ".$cantidad." * (".$precio." - ".$descuento."),
                ".$cantidad." * (".$precio." - ".$descuento."),
                '".$preferencia."'
                from producto where producto_id = ".$producto_id."
                )";
        $this->Pedido_model->ejecutar($sql);
        redirect('pedido/pedidoabierto/'.$pedido_id);
        		
        //**************** fin contenido ***************
        			}
        			          
        
    }

    /*
     * Adding a new pedido
     */
    function add()
    {   
        
        if($this->acceso(31)) {
        //**************** inicio contenido ***************  
                
        if(isset($_POST) && count($_POST) > 0)     
        {   
            $params = array(
				'estado_id' => $this->input->post('estado_id'),
				'cliente_id' => $this->input->post('cliente_id'),
				'pedido_fecha' => $this->input->post('pedido_fecha'),
				'pedido_subtotal' => $this->input->post('pedido_subtotal'),
				'pedido_descuento' => $this->input->post('pedido_descuento'),
				'pedido_total' => $this->input->post('pedido_total'),
				'pedido_glosa' => $this->input->post('pedido_glosa'),
				'pedido_fechaentrega' => $this->input->post('pedido_fechaentrega'),
				'pedido_horaentrega' => $this->input->post('pedido_horaentrega'),
            );
            
            $pedido_id = $this->Pedido_model->add_pedido($params);
            redirect('pedido/index');
        }
        else
        {
			$this->load->model('Estado_model');
			$data['all_estado'] = $this->Estado_model->get_all_estado();

			$this->load->model('Cliente_model');
			$data['all_cliente'] = $this->Cliente_model->get_all_cliente();
            $data['page_title'] = "Pedido";
            $data['_view'] = 'pedido/add';
            $this->load->view('layouts/main',$data);
        }
        		
        //**************** fin contenido ***************
        			}
        			          
    }  

    /*
     * Editing a pedido
     */
    function edit($pedido_id)
    {   
        if($this->acceso(33)) {
        //**************** inicio contenido ***************    
        // check if the pedido exists before trying to edit it
        $data['pedido'] = $this->Pedido_model->get_pedido($pedido_id);
        
        if(isset($data['pedido']['pedido_id']))
        {
            if(isset($_POST) && count($_POST) > 0)     
            {   
                $params = array(
					'estado_id' => $this->input->post('estado_id'),
					'cliente_id' => $this->input->post('cliente_id'),
					'pedido_fecha' => $this->input->post('pedido_fecha'),
					'pedido_subtotal' => $this->input->post('pedido_subtotal'),
					'pedido_descuento' => $this->input->post('pedido_descuento'),
					'pedido_total' => $this->input->post('pedido_total'),
					'pedido_glosa' => $this->input->post('pedido_glosa'),
					'pedido_fechaentrega' => $this->input->post('pedido_fechaentrega'),
					'pedido_horaentrega' => $this->input->post('pedido_horaentrega'),
                );

                $this->Pedido_model->update_pedido($pedido_id,$params);            
                redirect('pedido/index');
            }
            else
            {
				$this->load->model('Estado_model');
				$data['all_estado'] = $this->Estado_model->get_all_estado();

				$this->load->model('Cliente_model');
				$data['all_cliente'] = $this->Cliente_model->get_all_cliente();
                $data['page_title'] = "Pedido";
                $data['_view'] = 'pedido/edit';
                $this->load->view('layouts/main',$data);
            }
        }
        else
            show_error('The pedido you are trying to edit does not exist.');
        
        		
        //**************** fin contenido ***************
        			}
        			      
        
    } 

    /*
     * Deleting pedido
     */
    function remove($pedido_id)
    {
        if($this->acceso(34)) {
        //**************** inicio contenido ***************    
        
        if($pedido_id>0)
        {
            $this->Pedido_model->delete_pedido($pedido_id);
            redirect('pedido/index');
        }
        else
            show_error('El pedido que intenta eliminar, no existe..!');
        
        		
        //**************** fin contenido ***************
        			}
        			    
    }
    
    function pedido_a_ventas(){
        
           if($this->acceso(30)) {
        //**************** inicio contenido ***************    
        $usuario_id = $this->session_data['usuario_id'];
        
        if ($this->input->is_ajax_request()){
            
            $pedido_id = $this->input->post('pedido_id');
            
            $sql = "insert into venta(forma_id, tipotrans_id, usuario_id, cliente_id, moneda_id, estado_id, 
            venta_fecha, venta_hora, venta_subtotal, venta_descuento, venta_total, venta_efectivo, 
            venta_cambio, venta_glosa, venta_comision, venta_tipocambio, detalleserv_id)

            (select 1 as forma_id,tipotrans_id, ".$usuario_id.", cliente_id, 1 as moneda_id, 1 as estado_id, 
            date(now()) as venta_fecha, time(now()) as venta_hora, pedido_subtotal as venta_subtotal, pedido_descuento as venta_descuento, pedido_total as venta_total, pedido_total as venta_efectivo, 
            1 as venta_cambio, pedido_glosa as venta_glosa, 0 as venta_comision,1 as venta_tipocambio,'' as  detalleserv_id
            from pedido
            where pedido_id=".$pedido_id." ) ";            
            $venta_id = $this->Pedido_model->ejecutar($sql);
                 
            $sql = "insert into detalle_venta
                    (producto_id, venta_id, moneda_id, detalleven_codigo, detalleven_cantidad, 
                    detalleven_unidad, detalleven_costo, detalleven_precio, detalleven_subtotal, detalleven_descuento, 
                    detalleven_total, detalleven_caracteristicas, detalleven_preferencia, detalleven_comision, 
                    detalleven_tipocambio, usuario_id)
                    (select
                    producto_id, ".$venta_id." as venta_id, 1 as moneda_id, detalleped_codigo, detalleped_cantidad,
                    detalleped_unidad, detalleped_costo, detalleped_precio, detalleped_subtotal, detalleped_descuento,
                    detalleped_total,'' as detalleven_caracteristicas, detalleped_preferencia, detalleped_comision,
                    1 as detalleven_tipocambio, ".$usuario_id."
                    from detalle_pedido
                    where pedido_id = ".$pedido_id.")";
            $detalleven_id = $this->Pedido_model->modificar($sql);
            
            
            
            //actualizar el estado de la del pedido
            $sql = "update pedido set estado_id = 13 where pedido_id = ".$pedido_id; //como vendido y entregado
            echo $sql;
            
            $pedido_idx = $this->Pedido_model->modificar($sql);

        }
        		
        //**************** fin contenido ***************
        			}
        			         
    }
    
    
    function anular_pedido(){
        
            if($this->acceso(34)) {
        //**************** inicio contenido ***************    
        $usuario_id = $this->session_data['usuario_id'];
        
        if ($this->input->is_ajax_request()){
            
            $pedido_id = $this->input->post('pedido_id');
            
            $sql = "update detalle_pedido set 
                     detalleped_costo = 0
                    ,detalleped_cantidad = 0
                    ,detalleped_precio = 0
                    ,detalleped_descuento = 0
                    ,detalleped_subtotal = 0
                    ,detalleped_total = 0
                    ,detalleped_comision = 0 
                     where pedido_id = ".$pedido_id;      
            //echo $sql;
            $this->Pedido_model->modificar($sql);
                 
            $sql = "update pedido set
                     estado_id = 15
                    ,pedido_subtotal = 0
                    ,pedido_descuento = 0
                    ,pedido_total = 0 
                    where pedido_id = ".$pedido_id;
            echo $sql;
            $this->Pedido_model->modificar($sql);
            
        }
        		
        //**************** fin contenido ***************
        			}
        			      
    }
    

    /*
     * Eliminar item de detalle
     */
    function eliminaritem($detalleped_id)
    {
        if($this->acceso(30)) {
        //**************** inicio contenido ***************                            

        $sql = "delete from detalle_pedido where detalleped_id = ".$detalleped_id;
        $this->Pedido_model->ejecutar($sql);
        return true;
            		
        //**************** fin contenido ***************
        }
       
        		         
    }

    /*
     * Eliminar todos los items
     */
    function eliminartodo($pedido_id)
    {
        if($this->acceso(30)) {
        //**************** inicio contenido ***************            
       
        $usuario_id = $this->session_data['usuario_id'];
        $sql = "delete from detalle_pedido where pedido_id = ".$pedido_id;
        $this->Pedido_model->ejecutar($sql);
        return true;
            		
        		
        //**************** fin contenido ***************
        			}
        			
        
    }
    /*
     * incrementar cantidad de productos en el detalle
     */
    function incrementar()
    {
        if($this->acceso(30)) {
        //**************** inicio contenido ***************            
         
        
        $detalleped_id = $this->input->post('detalleped_id');
        $cantidad = $this->input->post('cantidad');
        $descuento = 0;
        
            $sql = "update detalle_pedido set detalleped_cantidad = detalleped_cantidad + ".$cantidad.
                    ", detalleped_subtotal = detalleped_precio * (detalleped_cantidad)".
                    ", detalleped_descuento = ".$descuento.
                    ", detalleped_total = (detalleped_precio - ".$descuento.")*(detalleped_cantidad)".
                    "  where detalleped_id = ".$detalleped_id;
            
        $this->Pedido_model->ejecutar($sql);
        return true;
        
            		
        //**************** fin contenido ***************
        			}
        			
        
    }

    /*
     * reduce la cantidad de productos en el detalle
     */
    function reducir()
    {
        if($this->acceso(30)) {
        //**************** inicio contenido ***************    
        
        
        $detalleped_id = $this->input->post('detalleped_id');
        $cantidad = $this->input->post('cantidad');
        $descuento = 0;
        
                    
            $sql = "update detalle_pedido set detalleped_cantidad = detalleped_cantidad - ".$cantidad.
                    ", detalleped_subtotal = detalleped_precio * (detalleped_cantidad)".
                    ", detalleped_descuento = ".$descuento.
                    ", detalleped_total = (detalleped_precio - ".$descuento.")*(detalleped_cantidad)".
                    "  where detalleped_id = ".$detalleped_id;
            
        $this->Pedido_model->ejecutar($sql);
        return true;
            		
        //**************** fin contenido ***************
        			}
        			
        
    }

    function mapa_pedido()        
    {

        //control de sesion
//        if ($this->session->userdata('perfil')=='PREVENDEDOR'){
            
        if($this->acceso(30)) {
        //**************** inicio contenido ***************  
        
            $data['page_title'] = "Mapa de Pedidos";
            $usuario_id = $this->session_data['usuario_id']; //$this->session->userdata('id_usu');
            
            $data['all_pedido'] = $this->Pedido_model->get_mis_pedidos($usuario_id);
            //$data['puntos_referencia'] = $this->Puntos_referencia_model->get_all_puntos_referencia();
            $data['_view'] = 'pedido/mapapedidos';
            
            $this->load->view('layouts/main',$data);
            
        //**************** fin contenido ***************
        			}
        	         
//        }
//        else{ redirect('login'); }
        
    }

    function mapa_entregas()
    {

        //control de sesion
//        if ($this->session->userdata('perfil')=='PREVENDEDOR'){
            
       if($this->acceso(30)) {
        //**************** inicio contenido ***************  
        
            $data['page_title'] = "Mapa de Entregas";
            $usuario_id = $this->session_data['usuario_id']; //$this->session->userdata('id_usu');
            
            $data['all_pedido'] = $this->Pedido_model->get_mis_pedidos($usuario_id);
            //$data['puntos_referencia'] = $this->Puntos_referencia_model->get_all_puntos_referencia();
            $data['_view'] = 'pedido/mapaentregas';
            
            $this->load->view('layouts/main',$data);
            
        //**************** fin contenido ***************
        			}
        		
                    
//        }
//        else{ redirect('login'); }
        
    }
    
}
