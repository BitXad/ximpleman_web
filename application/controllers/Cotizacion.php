<?php
/* 
 * Generated by CRUDigniter v3.2 
 * www.crudigniter.com
 */
 
class Cotizacion extends CI_Controller{
    function __construct()
    {
        parent::__construct();
        $this->load->model('Cotizacion_model');
         $this->load->helper('numeros');    
    } 


      
    /*
     * Listing of cotizacion
     */
    function index()
    {
           if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']<=3) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
            $usuario_id = $session_data['usuario_id'];
        $data['cotizacion'] = $this->Cotizacion_model->get_all_cotizacion();
        
        $data['_view'] = 'cotizacion/index';
        $this->load->view('layouts/main',$data);
            }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }

function creacotizacion()
    {
       
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']<=3) {
                $usuario_id = $session_data['usuario_id'];
        $cotizacion_id = $this->Cotizacion_model->crear_cotizacion($usuario_id);        
        redirect('cotizacion/add/'.$cotizacion_id);
            }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }
    /*
     * Adding a new cotizacion
     */
    function add($cotizacion_id)
    {   

        
          if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']<=3) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
            $usuario_id = $session_data['usuario_id'];
            $data['cotizacion_id'] = $cotizacion_id; 
            $this->load->model('Detalle_cotizacion_model');
            $data['detalle_cotizacion'] = $this->Cotizacion_model->get_detalle_cotizacion($cotizacion_id);
           $this->load->model('Producto_model');
            //$data['producto'] = $this->Producto_model->get_all_productos();  
            $data['cotizacion'] = $this->Cotizacion_model->get_cotizacion($cotizacion_id);     
            $data['_view'] = 'cotizacion/add';
            $this->load->view('layouts/main',$data);
       
            }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }

 function cotizarecibo($cotizacion_id)
    {   

        
          if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']<=3) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
            $usuario_id = $session_data['usuario_id'];
            $data['cotizacion_id'] = $cotizacion_id;
            $this->load->model('Empresa_model');
            $data['empresa'] = $this->Empresa_model->get_empresa(1);
            $this->load->model('Detalle_cotizacion_model');
            $data['detalle_cotizacion'] = $this->Cotizacion_model->get_detalle_cotizacion($cotizacion_id);
            $data['usuario'] = $this->Cotizacion_model->get_cotizacion_usuario($usuario_id);  
            $data['cotizacion'] = $this->Cotizacion_model->get_cotizacion($cotizacion_id);     
            $data['_view'] = 'cotizacion/cotiza';
            $this->load->view('layouts/main',$data);
       
            }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }

function detallecotizacion()
    {
    

         if ($this->input->is_ajax_request()) {  
        $cotizacion_id = $this->input->post('cotizacion_id');
        $datos = $this->Cotizacion_model->get_detalle_cotizacion($cotizacion_id);
     if(isset($datos)){
                        echo json_encode($datos);
                    }else echo json_encode(null);
    }
        else
        {                 
                    show_404();
        }          
     
    
    }    
function insertarproducto()
    {   
       

        if ($this->input->is_ajax_request()) {
        $cotizacion_id = $this->input->post('cotizacion_id');
        $descripcion = $this->input->post('descripcion');
        $producto_id = $this->input->post('producto_id');
        $cantidad = $this->input->post('cantidad'); 
        $descuento = $this->input->post('descuento'); 
        $producto_precio = $this->input->post('producto_precio');
        
        $descripcion = "'".$descripcion."'";

       $sql = "INSERT into detalle_cotizacion(
                
                producto_id,
                detallecot_descripcion,
                detallecot_precio,
                detallecot_cantidad,
                detallecot_descuento,
                detallecot_subtotal,
                detallecot_total,
                cotizacion_id
                            
                )
                (
                SELECT
                
                producto_id,
                ".$descripcion.",
                ".$producto_precio.",
                ".$cantidad.",
                ".$descuento.",
                ".$cantidad." * ".$producto_precio.",
                (".$cantidad." * ".$producto_precio.") - ".$descuento.",
                ".$cotizacion_id."
                
                from producto where producto_id = ".$producto_id."
                )";
              
        $this->Cotizacion_model->ejecutar($sql);
        $datos = $this->Cotizacion_model->get_detalle_cotizacion($cotizacion_id);
     if(isset($datos)){
                        echo json_encode($datos);
                    }else echo json_encode(null);
    }
        else
        {                 
                    show_404();
        }          
    }

    function updateDetallecot()
    {
      
        
         if ($this->input->is_ajax_request()) {
        $detallecot_id = $this->input->post('detallecot_id');
        
        $caracteristica = $this->input->post('caracteristica');
        $cotizacion_id = $this->input->post('cotizacion_id');
       // $descripcion = $this->input->post('descripcion');
        $producto_id = $this->input->post('producto_id');
        $cantidad = $this->input->post('cantidad'); 
        $descuento = $this->input->post('descuento'); 
        $producto_precio = $this->input->post('precio');
        
        $descripcion = "'".$descripcion."'";
        $caracteristica = "'".$caracteristica."'";
       
       $cot = "UPDATE detalle_cotizacion
                SET
                detallecot_caracteristica = ".$caracteristica.",
               
                detallecot_precio = ".$producto_precio.",
                detallecot_cantidad = ".$cantidad.",
                detallecot_descuento = ".$descuento.",
                detallecot_subtotal = ".$cantidad." * ".$producto_precio.",
                detallecot_total = (".$cantidad." * ".$producto_precio.") - ".$descuento."
                        
                WHERE producto_id = ".$producto_id." and detallecot_id = ".$detallecot_id."
            ";

    
        $this->Cotizacion_model->ejecutar($cot);
        $datos = $this->Cotizacion_model->get_detalle_cotizacion($cotizacion_id);
          if(isset($datos)){
                        echo json_encode($datos);
                    }else echo json_encode(null);
    }
        else
        {                 
                    show_404();
        }          
    }

    function quitar($detallecot_id)
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']<=3) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        //**************** inicio contenido ***************        
        
        $sql = "delete from detalle_cotizacion where detallecot_id = ".$detallecot_id;
        $this->Cotizacion_model->ejecutar($sql);
        
        return true;
                    
        //**************** fin contenido ***************
                    }
                    else{ redirect('alerta'); }
        } else { redirect('', 'refresh'); }
        
    }
    /*
     * Editing a cotizacion
     */
    function edit($cotizacion_id)
    {   
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']<=3) {
                $usuario_id = $session_data['usuario_id'];
        // check if the cotizacion exists before trying to edit it
        $data['cotizacion'] = $this->Cotizacion_model->get_cotizacion($cotizacion_id);
        
        if(isset($data['cotizacion']['cotizacion_id']))
        {
            if(isset($_POST) && count($_POST) > 0)     
            {   
                $fechacot = $this->input->post('cotizacion_fecha');
                $fecha = $this->Cotizacion_model->normalize_date($fechacot);

                $params = array(
					'cotizacion_fecha' => $fecha,
					'cotizacion_validez' => $this->input->post('cotizacion_validez'),
					'cotizacion_formapago' => $this->input->post('cotizacion_formapago'),
					'cotizacion_tiempoentrega' => $this->input->post('cotizacion_tiempoentrega'),
					'usuario_id' => $usuario_id,
					'cotizacion_total' => $this->input->post('cotizacion_total'),
                    'cotizacion_glosa' => $this->input->post('cotizacion_glosa'),
                    'cotizacion_cliente' => $this->input->post('cotizacion_cliente'),
                );



                $this->Cotizacion_model->update_cotizacion($cotizacion_id,$params);            
                 redirect('cotizacion/add/'.$cotizacion_id);
            }
            else
            {
                $data['_view'] = 'cotizacion/edit';
                $this->load->view('layouts/main',$data);
            }
        }
        else
            show_error('The cotizacion you are trying to edit does not exist.');
            }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }

    function finalizar($cotizacion_id)
    {   
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']<=3) {
                $usuario_id = $session_data['usuario_id'];
        // check if the cotizacion exists before trying to edit it
        $data['cotizacion'] = $this->Cotizacion_model->get_cotizacion($cotizacion_id);
        
        if(isset($data['cotizacion']['cotizacion_id']))
        {
            if(isset($_POST) && count($_POST) > 0)     
            {   
                $fechacot = $this->input->post('cotizacion_fecha');
                $fecha = $this->Cotizacion_model->normalize_date($fechacot);

                $params = array(
                    'cotizacion_fecha' => $fecha,
                    'cotizacion_validez' => $this->input->post('cotizacion_validez'),
                    'cotizacion_formapago' => $this->input->post('cotizacion_formapago'),
                    'cotizacion_tiempoentrega' => $this->input->post('cotizacion_tiempoentrega'),
                    'usuario_id' => $usuario_id,
                    'cotizacion_total' => $this->input->post('cotizacion_total'),
                     'cotizacion_glosa' => $this->input->post('cotizacion_glosa'),
                     'cotizacion_cliente' => $this->input->post('cotizacion_cliente')
                );



                $this->Cotizacion_model->update_cotizacion($cotizacion_id,$params);            
                 redirect('cotizacion/index');
            }
            else
            {
                $data['_view'] = 'cotizacion/edit';
                $this->load->view('layouts/main',$data);
            }
        }
        else
            show_error('The cotizacion you are trying to edit does not exist.');
            }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }
    /*
     * Deleting cotizacion
     */
    function remove($cotizacion_id)
    {
        $cotizacion = $this->Cotizacion_model->get_cotizacion($cotizacion_id);

        // check if the cotizacion exists before trying to delete it
        if(isset($cotizacion['cotizacion_id']))
        {
            $this->Cotizacion_model->delete_cotizacion($cotizacion_id);
            redirect('cotizacion/index');
        }
        else
            show_error('The cotizacion you are trying to delete does not exist.');
    }
    
}
