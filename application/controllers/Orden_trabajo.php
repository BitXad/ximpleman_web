<?php
/* 
 * Generated by CRUDigniter v3.2 
 * www.crudigniter.com
 */
 
class Orden_trabajo extends CI_Controller{
    private $session_data = "";
    function __construct()
    {
        parent::__construct();
        $this->load->model('Orden_trabajo_model');
        $this->load->helper('numeros');
        if ($this->session->userdata('logged_in')) {
            $this->session_data = $this->session->userdata('logged_in');
        }else {
            redirect('', 'refresh');
        }
    } 
    /* *****Funcion que verifica el acceso al sistema**** */
    private function acceso($id_rol){
        $rolusuario = $this->session_data['rol'];
        if($rolusuario[$id_rol-1]['rolusuario_asignado'] == 1){
            return true;
        }else{
            $data['_view'] = 'login/mensajeacceso';
            $this->load->view('layouts/main',$data);
        }
    }
    /*
     * Listing of Orden_trabajo
     */
    function index()
    {
        if($this->acceso(36)){
            $data['page_title'] = "Orden de Trabajo";
            $data['rol'] = $this->session_data['rol'];
            $data['orden_trabajo'] = $this->Orden_trabajo_model->get_all_orden_trabajo();

            $data['_view'] = 'orden_trabajo/index';
            $this->load->view('layouts/main',$data);
        }
    }

    
    /*
     * Adding a new Orden_trabajo
     */
    function nuevo()
    {
        if($this->acceso(37)){
            $data['page_title'] = "Orden de Trabajo";
            $data['usuario_id'] = $this->session_data['usuario_id'];
            //$data['Orden_trabajo_id'] = $orden_trabajo; 
            //$data['detalle_orden'] = $this->Orden_trabajo_model->get_detalle_orden_trabajo($usuario_id);     
            $data['_view'] = 'orden_trabajo/add';
            $this->load->view('layouts/main',$data);
       
        }
    }

    function add()
    {
        if($this->acceso(37)){
            
        $usuario_id = $this->session_data['usuario_id'];
        $data['usuario_id'] = $this->session_data['usuario_id'];
        $fecha = date("Y-m-d");
        $hora = date("H:i:s");
        $this->load->library('form_validation');
        $this->form_validation->set_rules('numero','Orden Numero','required');
           if($this->form_validation->run())     
        {   
            $params = array(
                'orden_numero' => $this->input->post('numero'),
                'orden_fecha' => $fecha,
                'orden_hora' => $hora,
                'orden_fechaentrega' => $this->input->post('orden_trabajo_fecha'),
                'orden_total' => $this->input->post('total'),
                'orden_acuenta' => $this->input->post('cuenta'),
                'orden_saldo' => $this->input->post('saldo'),
                'orden_observacion' => $this->input->post('nota'),
                'cliente_id' => $this->input->post('cliente_id'),
                'usuario_id' => $usuario_id,
            );
            
             $orden_id = $this->Orden_trabajo_model->add_orden_trabajo($params);

            $actualizar = "UPDATE detalle_orden set orden_id=".$orden_id." where usuario_id=".$usuario_id." and orden_id is null ";
            $this->db->query($actualizar);
            redirect('orden_trabajo/index');
        }
        else
        {            
            $data['_view'] = 'orden_trabajo/add';
            $this->load->view('layouts/main',$data);
        }
       
        }
    }

    function editar($orden_trabajo)
    {
        if($this->acceso(37)){
            $data['page_title'] = "Orden de Trabajo";
            $data['usuario_id'] = $this->session_data['usuario_id'];
            //$data['Orden_trabajo_id'] = $orden_trabajo; 
            //$data['detalle_orden'] = $this->Orden_trabajo_model->get_detalle_orden_trabajo($usuario_id);     
            $data['_view'] = 'orden_trabajo/add';
            $this->load->view('layouts/main',$data);
       
        }
    }

    function ordenrecibo($orden_trabajo)
    {
        if($this->acceso(36)){
            $data['page_title'] = "Orden de Trabajo";
            $this->load->model('Empresa_model');
            $data['empresa'] = $this->Empresa_model->get_empresa(1);
            $data['detalle_orden_trabajo'] = $this->Orden_trabajo_model->detalle_ordentrabajo($orden_trabajo);
            $data['Orden_trabajo'] = $this->Orden_trabajo_model->la_orden_trabajo($orden_trabajo);     
            $data['_view'] = 'orden_trabajo/recibo';
            $this->load->view('layouts/main',$data);
       
        }
    }
    function recibo($orden_trabajo)
    {
        if($this->acceso(36)){
            $data['page_title'] = "Orden de Trabajo";
            $usuario_id = $this->session_data['usuario_id'];
            $data['Orden_trabajo_id'] = $orden_trabajo;
            $this->load->model('Empresa_model');
            $data['empresa'] = $this->Empresa_model->get_empresa(1);
            $this->load->model('Detalle_Orden_trabajo_model');
            $data['detalle_Orden_trabajo'] = $this->Orden_trabajo_model->get_detalle_orden_trabajo($orden_trabajo);
            $data['usuario'] = $this->Orden_trabajo_model->get_Orden_trabajo_usuario($usuario_id);  
            $data['Orden_trabajo'] = $this->Orden_trabajo_model->get_Orden_trabajo($orden_trabajo);     
            $data['_view'] = 'Orden_trabajo/recibo';
            $this->load->view('layouts/main',$data);
       
        }
    }

    function detalle_orden_trabajo()
    {
        if ($this->input->is_ajax_request()) {  
            $usuario_id = $this->session_data['usuario_id'];
        
        $datos = $this->Orden_trabajo_model->get_detalle_orden_trabajo($usuario_id);
     if(isset($datos)){
                        echo json_encode($datos);
                    }else echo json_encode(null);
    }
        else
        {                 
                    show_404();
        }          
     
    
    }    
    function insertarproducto()
    {
        if ($this->input->is_ajax_request()) {
        $usuario_id = $this->input->post('usuario_id');
        
        $producto_id = $this->input->post('producto_id');
        $cantidad = $this->input->post('cantidad'); 
        $ancho = $this->input->post('ancho'); 
        $largo = $this->input->post('largo');
        $producto_precio = $this->input->post('producto_precio');
        $factor = $this->input->post('producto_factor');
        $total = $this->input->post('total');
        $nuevacan = $cantidad * $factor;
        //$nuevoprec = $

       $sql = "INSERT into detalle_orden(
                
                producto_id,
                usuario_id,
                detalleorden_cantidad,
                detalleorden_ancho,
                detalleorden_largo,
                detalleorden_total,
                detalleorden_precio,
                detalleorden_preciototal
                            
                )
                (
                SELECT
                
                producto_id,
                ".$usuario_id.",
                ".$cantidad.",
                ".$ancho.",
                ".$largo.",
                ".$total.",
                ".$producto_precio.",
                (".$nuevacan." * ".$producto_precio." * ".$total.")
                
                from producto where producto_id = ".$producto_id."
                )";
              
        $this->Orden_trabajo_model->ejecutar($sql);
        $datos = $this->Orden_trabajo_model->get_detalle_orden_trabajo($usuario_id);
     if(isset($datos)){
                        echo json_encode($datos);
                    }else echo json_encode(null);
    }
        else
        {                 
                    show_404();
        }          
    }

    function updateDetalleorden()
    {
        if ($this->input->is_ajax_request()) {
        $usuario_id = $this->input->post('usuario_id');
        
        $detalleorden_id = $this->input->post('detalleorden_id');
       // $descripcion = $this->input->post('descripcion');
        
        $cantidad = $this->input->post('cantidad'); 
         
        $producto_precio = $this->input->post('precio');
        $ancho = $this->input->post('ancho');
        $largo = $this->input->post('largo');
        $total = $ancho*$largo;
        
       
       
       $cot = "UPDATE detalle_orden
                SET
                
                detalleorden_precio = ".$producto_precio.",
                detalleorden_cantidad = ".$cantidad.",
                detalleorden_ancho = ".$ancho.",
                detalleorden_largo = ".$largo.",
                detalleorden_total = ".$total.",
                detalleorden_preciototal = (".$cantidad." * ".$producto_precio.") * ".$total."
                        
                WHERE detalleorden_id = ".$detalleorden_id."
            ";

    
        $this->Orden_trabajo_model->ejecutar($cot);
       }
         
    }

    function quitar($detalleorden_id)
    {
        if($this->acceso(40)){
        //**************** inicio contenido ***************        
        
        $sql = "delete from detalle_orden where detalleorden_id = ".$detalleorden_id;
        $this->Orden_trabajo_model->ejecutar($sql);
        
        return true;
                    
        //**************** fin contenido ***************
        }
    }
    /*
     * Editing a Orden_trabajo
     */
    function edit($orden_trabajo)
    {
        if($this->acceso(38)){
            $data['page_title'] = "Orden de Trabajo";
            $usuario_id = $this->session_data['usuario_id'];
            $data['Orden_trabajo'] = $this->Orden_trabajo_model->get_Orden_trabajo($orden_trabajo);

            if(isset($data['Orden_trabajo']['Orden_trabajo_id']))
            {
                if(isset($_POST) && count($_POST) > 0)     
                {   
                    $fechacot = $this->input->post('Orden_trabajo_fecha');
                    $fecha = $this->Orden_trabajo_model->normalize_date($fechacot);

                    $params = array(
                                            'Orden_trabajo_fecha' => $fecha,
                                            'Orden_trabajo_validez' => $this->input->post('Orden_trabajo_validez'),
                                            'Orden_trabajo_formapago' => $this->input->post('Orden_trabajo_formapago'),
                                            'Orden_trabajo_tiempoentrega' => $this->input->post('Orden_trabajo_tiempoentrega'),
                                            'usuario_id' => $usuario_id,
                                            'Orden_trabajo_total' => $this->input->post('Orden_trabajo_total'),
                        'Orden_trabajo_glosa' => $this->input->post('Orden_trabajo_glosa'),
                        'Orden_trabajo_cliente' => $this->input->post('Orden_trabajo_cliente'),
                        'Orden_trabajo_lugarentrega' => $this->input->post('Orden_trabajo_lugarentrega'),
                        'Orden_trabajo_chequenombre' => $this->input->post('Orden_trabajo_chequenombre'),
                    );



                    $this->Orden_trabajo_model->update_Orden_trabajo($orden_trabajo,$params);            
                     redirect('Orden_trabajo/add/'.$orden_trabajo);
                }
                else
                {
                    $data['_view'] = 'Orden_trabajo/edit';
                    $this->load->view('layouts/main',$data);
                }
            }
            else
                show_error('The Orden_trabajo you are trying to edit does not exist.');
            }
    }

    function finalizar($orden_trabajo)
    {   
        if($this->acceso(36)){
            $data['page_title'] = "Orden de Trabajo";
            $usuario_id = $this->session_data['usuario_id'];
            // check if the Orden_trabajo exists before trying to edit it
            $data['Orden_trabajo'] = $this->Orden_trabajo_model->get_Orden_trabajo($orden_trabajo);

            if(isset($data['Orden_trabajo']['Orden_trabajo_id']))
            {
                if(isset($_POST) && count($_POST) > 0)     
                {   
                    $fechacot = $this->input->post('Orden_trabajo_fecha');
                    $fecha = $this->Orden_trabajo_model->normalize_date($fechacot);

                    $params = array(
                        'Orden_trabajo_fecha' => $fecha,
                        'Orden_trabajo_validez' => $this->input->post('Orden_trabajo_validez'),
                        'Orden_trabajo_formapago' => $this->input->post('Orden_trabajo_formapago'),
                        'Orden_trabajo_tiempoentrega' => $this->input->post('Orden_trabajo_tiempoentrega'),
                        'usuario_id' => $usuario_id,
                        'Orden_trabajo_total' => $this->input->post('Orden_trabajo_total'),
                        'Orden_trabajo_glosa' => $this->input->post('Orden_trabajo_glosa'),
                        'Orden_trabajo_cliente' => $this->input->post('Orden_trabajo_cliente'),
                        'Orden_trabajo_lugarentrega' => $this->input->post('Orden_trabajo_lugarentrega'),
                        'Orden_trabajo_chequenombre' => $this->input->post('Orden_trabajo_chequenombre')
                    );



                    $this->Orden_trabajo_model->update_Orden_trabajo($orden_trabajo,$params);            
                     redirect('Orden_trabajo/index');
                }
                else
                {
                    $data['_view'] = 'Orden_trabajo/edit';
                    $this->load->view('layouts/main',$data);
                }
            }
            else
                show_error('The Orden_trabajo you are trying to edit does not exist.');
        }
    }
    /*
     * Deleting Orden_trabajo
     */
    function remove($orden_trabajo)
    {
        if($this->acceso(40)){
            $Orden_trabajo = $this->Orden_trabajo_model->get_Orden_trabajo($orden_trabajo);

            // check if the Orden_trabajo exists before trying to delete it
            if(isset($Orden_trabajo['Orden_trabajo_id']))
            {
                $this->Orden_trabajo_model->delete_Orden_trabajo($orden_trabajo);
                redirect('Orden_trabajo/index');
            }
            else
                show_error('The Orden_trabajo you are trying to delete does not exist.');
        }
    }

    /*
     * Ordenes de trabajo pendientes
     */
    function ordenes_pendientes()
    {
        if($this->acceso(40)){
            
            $condicion = $this->input->post('filtro');
            
            $resultado = $this->Orden_trabajo_model->ordenes_pendientes($condicion);
            
            echo json_encode($resultado);
            
        }
    }
    

    /*
     * Pasar un pedido a ventas
     */
    function pasaraventas($pedido_id,$cliente_id)
    {
        if($this->acceso(40)) {
        //**************** inicio contenido ***************    
        $usuario_id = $this->session_data['usuario_id'];
                
        $sql = "delete from detalle_venta_aux where usuario_id = ".$usuario_id;
        $this->Pedido_model->ejecutar($sql);
        
        $sql = "insert into detalle_venta_aux(
            producto_id,
            venta_id,
            
            detalleven_codigo,
            detalleven_cantidad,
            detalleven_unidad,
            detalleven_costo,
            detalleven_precio,
            detalleven_subtotal,
            detalleven_descuento,
            detalleven_total,
            detalleven_caracteristicas,
            detalleven_preferencia,
            detalleven_comision,
            detalleven_tipocambio,
            usuario_id,
            producto_nombre,
            producto_unidad,
            producto_marca,
            categoria_id,
            producto_codigobarra,
            existencia
            )
            
            (select 
            d.producto_id,
            0 as venta_id,
            d.detalleped_codigo,
            d.detalleped_cantidad,
            d.detalleped_unidad,
            d.detalleped_costo,
            d.detalleped_precio,
            d.detalleped_subtotal,
            d.detalleped_descuento,
            d.detalleped_total,
            '' as caracteristicas,
            d.detalleped_preferencia,
            d.detalleped_comision,
            1 as tipocambio,
            ".$usuario_id.",
            p.producto_nombre,
            p.producto_unidad,
            p.producto_marca,
            p.categoria_id,
            p.producto_codigobarra,
            p.existencia

            from detalle_orden d, orden e,usuario u, consinventario p
            where p.producto_id = d.producto_id and e.pedido_id =".$pedido_id." and d.pedido_id = e.pedido_id and e.usuario_id = u.usuario_id)";
       
        
        $this->Pedido_model->ejecutar($sql);
        return true;
        		
        //**************** fin contenido ***************
        }
        			         
    }
    
    
}
