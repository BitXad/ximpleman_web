<?php/*  * Generated by CRUDigniter v3.2  * www.crudigniter.com */ class Reportes extends CI_Controller{    function __construct()    {        parent::__construct();        $this->load->model('Reporte_ing_egr_model');        $this->load->model('Ingreso_model');        $this->load->model('Empresa_model');         if ($this->session->userdata('logged_in')) {            $this->session_data = $this->session->userdata('logged_in');        }else {            redirect('', 'refresh');        }    }     private function acceso($id_rol){        $rolusuario = $this->session_data['rol'];        if($rolusuario[$id_rol-1]['rolusuario_asignado'] == 1){            return true;        }else{            $data['_view'] = 'login/mensajeacceso';            $this->load->view('layouts/main',$data);        }    }    /*     * Listing of cliente     */    function index()    {        if ($this->session->userdata('logged_in')) {            $session_data = $this->session->userdata('logged_in');            if($session_data['tipousuario_id']==1) {                $data = array(                    'page_title' => 'Admin >> Mi Cuenta'                );        $this->load->model('Empresa_model');        $data['all_empresa'] = $this->Empresa_model->get_all_empresa();        $this->load->model('Usuario_model');        $data['all_usuario'] = $this->Usuario_model->get_all_usuario_activo();        $data['_view'] = 'reportes/index';        $this->load->view('layouts/main',$data);        }            else{                redirect('alerta');            }        } else {            redirect('', 'refresh');        }    }    function graficas()    {                       $data['empresa'] = $this->Empresa_model->get_all_empresa();        $data['_view'] = 'reportes/graficas';        $this->load->view('layouts/main',$data);                    redirect('', 'refresh');    } public function getUltimoDiaMes($elAnio,$elMes) {     return date("d",(mktime(0,0,0,$elMes+1,1,$elAnio)-1));    }function mes($anio,$mes){        $primer_dia=1;        $ultimo_dia=$this->getUltimoDiaMes($anio,$mes);        $fecha_inicial=date("Y-m-d H:i:s", strtotime($anio."-".$mes."-".$primer_dia) );        $fecha_final=date("Y-m-d H:i:s", strtotime($anio."-".$mes."-".$ultimo_dia) );        $fechas = "SELECT compra_fecha, round(compra_totalfinal,2) as compra_totalfinal FROM compra where compra.compra_fecha >= '".$anio."-".$mes."-01' and  compra.compra_fecha <= '".$anio."-".$mes."-31' ";        $result= $this->db->query($fechas)->result_array();        $fechasven = "SELECT venta_fecha, round(venta_total,2) as venta_total FROM venta where venta.venta_fecha >= '".$anio."-".$mes."-01' and  venta.venta_fecha <= '".$anio."-".$mes."-31' ";        $resultven= $this->db->query($fechasven)->result_array();        //$result=$data['result'];        $ct=count($result);        for($d=1;$d<=$ultimo_dia;$d++){            $registros[$d]=0;            $registrosven[$d]=0;             }        foreach($result as $res){        $diasel=intval(date("d",strtotime($res['compra_fecha']) ) );                $suma=$res['compra_totalfinal'];                $registros[$diasel]+=$suma;            }        foreach($resultven as $resven){        $diaselven=intval(date("d",strtotime($resven['venta_fecha']) ) );                $sumave=$resven['venta_total'];               $registrosven[$diaselven]+=$sumave;            }        $data=array("totaldias"=>$ultimo_dia, "registrosdia" =>$registros, "registrosven" =>$registrosven);        echo   json_encode($data);        /*$anio = $this->input->post('anio');   1555891200        $mes = $this->input->post('fecha2'); */        }function torta($anio,$mes){                               $ventausuario = "SELECT COUNT(DISTINCT usuario_id) as 'distusu' FROM venta where venta.venta_fecha >= '".$anio."-".$mes."-01' and  venta.venta_fecha <= '".$anio."-".$mes."-30' ";        $usve = $this->db->query($ventausuario)->row_array();        $numusu=$usve['distusu'];        $id_usuarios = "SELECT DISTINCT v.usuario_id, u.usuario_nombre FROM venta v, usuario u where v.venta_fecha >= '".$anio."-".$mes."-01' and  v.venta_fecha <= '".$anio."-".$mes."-31' and v.usuario_id=u.usuario_id ";        $usuarios= $this->db->query($id_usuarios)->result_array();        $totalventas = "SELECT  usuario_id, SUM(venta_total) as 'totalventas' FROM venta where venta.venta_fecha >= '".$anio."-".$mes."-01' and  venta.venta_fecha <= '".$anio."-".$mes."-31' GROUP BY usuario_id";        $tove= $this->db->query($totalventas)->result_array();                        foreach($tove as $tve){        $ususel=intval($tve['usuario_id']);                $suma=round($tve['totalventas'],2);                $registros[$ususel]=$suma;            }                                     $data=array("totaltipos"=>$numusu, "tipos" =>$usuarios, "numerodepubli" =>$registros);        echo   json_encode($data);                }    /*     * Reporte de Ingresos y Salidas     */    function buscarlosreportes()    {        if($this->acceso(76)){        if ($this->input->is_ajax_request()) {            $fecha1 = $this->input->post('fecha1');               $fecha2 = $this->input->post('fecha2');             $usuario = $this->input->post('usuario_id');             $valfecha1 = "";            $valfecha2 = "";            $usuario_id = "";            if(!($fecha1 == null || empty($fecha1)) && !($fecha2 == null || empty($fecha2))){                $valfecha1 = $fecha1;                $valfecha2 = $fecha2;            }elseif(!($fecha1 == null || empty($fecha1)) && ($fecha2 == null || empty($fecha2))){                $valfecha1 = $fecha1;                $valfecha2 = $fecha1;            }elseif(($fecha1 == null || empty($fecha1)) && !($fecha2 == null || empty($fecha2))) {                $valfecha1 = $fecha2;                $valfecha2 = $fecha2;            }else{                $fecha1 = null;                $fecha2 = null;            }            if($usuario >  0){                $usuario_id = $usuario;            }else{                $usuario_id = 0;            }                        $datos = $this->Reporte_ing_egr_model->get_reportes($valfecha1, $valfecha2, $usuario_id);            echo json_encode($datos);        }           else        {                             show_404();        }                }                }    /*     * Menu de Reportes de Compras     */    function comprareportes()    {        if($this->acceso(1)){        $data['_view'] = 'reportes/comprareportes';        $this->load->view('layouts/main',$data);        }                }    /*     * Menu de Reportes de Ventas     */    function ventareportes()    {        if($this->acceso(1)){        $data['_view'] = 'reportes/ventareportes';        $this->load->view('layouts/main',$data);        }              }    /*     * Menu de Reportes de Servicios     */    function servicioreportes()    {        if($this->acceso(1)){        $data['_view'] = 'reportes/servicioreportes';        $this->load->view('layouts/main',$data);        }    }        function planillacaja()    {        if($this->acceso(1)){                $this->load->model('Empresa_model');                $data['all_empresa'] = $this->Empresa_model->get_all_empresa();                $this->load->model('Usuario_model');                $data['all_usuario'] = $this->Usuario_model->get_all_usuario_activo();        /*                $fecha1  = Date("Y-m-d");                $fecha2  = $fecha1;                $data['ingresos'] = $this->Reporte_ing_egr_model->get_reportes($fecha1, $fecha2);        */                $data['_view'] = 'reportes/planillacaja';                $this->load->view('layouts/main',$data);        }               }        function reptotaling_efectivo()    {        if($this->acceso(1)){        if ($this->input->is_ajax_request()) {            $fecha1 = $this->input->post('fecha1');               $fecha2 = $this->input->post('fecha2');             $usuario = $this->input->post('usuario_id');             $valfecha1 = "";            $valfecha2 = "";            $usuario_id = "";            if(!($fecha1 == null || empty($fecha1)) && !($fecha2 == null || empty($fecha2))){                $valfecha1 = $fecha1;                $valfecha2 = $fecha2;            }elseif(!($fecha1 == null || empty($fecha1)) && ($fecha2 == null || empty($fecha2))){                $valfecha1 = $fecha1;                $valfecha2 = $fecha1;            }elseif(($fecha1 == null || empty($fecha1)) && !($fecha2 == null || empty($fecha2))) {                $valfecha1 = $fecha2;                $valfecha2 = $fecha2;            }else{                $fecha1 = null;                $fecha2 = null;            }            if($usuario >  0){                $usuario_id = $usuario;            }else{                $usuario_id = 0;            }                        $datos = $this->Reporte_ing_egr_model->get_reptotaling_efectivo($valfecha1, $valfecha2, $usuario_id);            echo json_encode($datos);        }           else        {                             show_404();        }                }              }    /* ************************Reporte total de ventas*******************************+ */    function reptotal_ventas()    {       if($this->acceso(1)){        if ($this->input->is_ajax_request()) {            $fecha1 = $this->input->post('fecha1');               $fecha2 = $this->input->post('fecha2');             $usuario = $this->input->post('usuario_id');             $valfecha1 = "";            $valfecha2 = "";            $usuario_id = "";            if(!($fecha1 == null || empty($fecha1)) && !($fecha2 == null || empty($fecha2))){                $valfecha1 = $fecha1;                $valfecha2 = $fecha2;            }elseif(!($fecha1 == null || empty($fecha1)) && ($fecha2 == null || empty($fecha2))){                $valfecha1 = $fecha1;                $valfecha2 = $fecha1;            }elseif(($fecha1 == null || empty($fecha1)) && !($fecha2 == null || empty($fecha2))) {                $valfecha1 = $fecha2;                $valfecha2 = $fecha2;            }else{                $fecha1 = null;                $fecha2 = null;            }            if($usuario >  0){                $usuario_id = $usuario;            }else{                $usuario_id = 0;            }                        $datos = $this->Reporte_ing_egr_model->get_reptotal_ventas($valfecha1, $valfecha2, $usuario_id);            echo json_encode($datos);        }           else        {                             show_404();        }                }               }    /* ************************Reporte total de cobros de Creditos*******************************+ */    function reptotal_cobroscredito()    {        if($this->acceso(1)){        if ($this->input->is_ajax_request()) {            $fecha1 = $this->input->post('fecha1');               $fecha2 = $this->input->post('fecha2');             $usuario = $this->input->post('usuario_id');             $valfecha1 = "";            $valfecha2 = "";            $usuario_id = "";            if(!($fecha1 == null || empty($fecha1)) && !($fecha2 == null || empty($fecha2))){                $valfecha1 = $fecha1;                $valfecha2 = $fecha2;            }elseif(!($fecha1 == null || empty($fecha1)) && ($fecha2 == null || empty($fecha2))){                $valfecha1 = $fecha1;                $valfecha2 = $fecha1;            }elseif(($fecha1 == null || empty($fecha1)) && !($fecha2 == null || empty($fecha2))) {                $valfecha1 = $fecha2;                $valfecha2 = $fecha2;            }else{                $fecha1 = null;                $fecha2 = null;            }            if($usuario >  0){                $usuario_id = $usuario;            }else{                $usuario_id = 0;            }                        $datos = $this->Reporte_ing_egr_model->get_reptotal_cobroscredito($valfecha1, $valfecha2, $usuario_id);            echo json_encode($datos);        }           else        {                             show_404();        }                }               }    /* ************Reporte total de Egreso de efectivo******************************* */    function reptotal_egresoefectivo()    {        if($this->acceso(1)){        if ($this->input->is_ajax_request()) {            $fecha1 = $this->input->post('fecha1');               $fecha2 = $this->input->post('fecha2');             $usuario = $this->input->post('usuario_id');             $valfecha1 = "";            $valfecha2 = "";            $usuario_id = "";            if(!($fecha1 == null || empty($fecha1)) && !($fecha2 == null || empty($fecha2))){                $valfecha1 = $fecha1;                $valfecha2 = $fecha2;            }elseif(!($fecha1 == null || empty($fecha1)) && ($fecha2 == null || empty($fecha2))){                $valfecha1 = $fecha1;                $valfecha2 = $fecha1;            }elseif(($fecha1 == null || empty($fecha1)) && !($fecha2 == null || empty($fecha2))) {                $valfecha1 = $fecha2;                $valfecha2 = $fecha2;            }else{                $fecha1 = null;                $fecha2 = null;            }            if($usuario >  0){                $usuario_id = $usuario;            }else{                $usuario_id = 0;            }                        $datos = $this->Reporte_ing_egr_model->get_reptotalegr_efectivo($valfecha1, $valfecha2, $usuario_id);            echo json_encode($datos);        }           else        {                             show_404();        }                }              }        /* ************Reporte total de Egreso de Compras******************************* */    function reptotal_egresocompra()    {        if($this->acceso(1)){        if ($this->input->is_ajax_request()) {            $fecha1 = $this->input->post('fecha1');               $fecha2 = $this->input->post('fecha2');             $usuario = $this->input->post('usuario_id');             $valfecha1 = "";            $valfecha2 = "";            $usuario_id = "";            if(!($fecha1 == null || empty($fecha1)) && !($fecha2 == null || empty($fecha2))){                $valfecha1 = $fecha1;                $valfecha2 = $fecha2;            }elseif(!($fecha1 == null || empty($fecha1)) && ($fecha2 == null || empty($fecha2))){                $valfecha1 = $fecha1;                $valfecha2 = $fecha1;            }elseif(($fecha1 == null || empty($fecha1)) && !($fecha2 == null || empty($fecha2))) {                $valfecha1 = $fecha2;                $valfecha2 = $fecha2;            }else{                $fecha1 = null;                $fecha2 = null;            }            if($usuario >  0){                $usuario_id = $usuario;            }else{                $usuario_id = 0;            }                        $datos = $this->Reporte_ing_egr_model->get_reptotalegr_compras($valfecha1, $valfecha2, $usuario_id);            echo json_encode($datos);        }           else        {                             show_404();        }                }                }        function reportesformapago()    {        if($this->acceso(1)){        if ($this->input->is_ajax_request()) {            $fecha1 = $this->input->post('fecha1');               $fecha2 = $this->input->post('fecha2');             $usuario = $this->input->post('usuario_id');             $formapago = $this->input->post('formapago');             $valfecha1 = "";            $valfecha2 = "";            $usuario_id = "";            if(!($fecha1 == null || empty($fecha1)) && !($fecha2 == null || empty($fecha2))){                $valfecha1 = $fecha1;                $valfecha2 = $fecha2;            }elseif(!($fecha1 == null || empty($fecha1)) && ($fecha2 == null || empty($fecha2))){                $valfecha1 = $fecha1;                $valfecha2 = $fecha1;            }elseif(($fecha1 == null || empty($fecha1)) && !($fecha2 == null || empty($fecha2))) {                $valfecha1 = $fecha2;                $valfecha2 = $fecha2;            }else{                $fecha1 = null;                $fecha2 = null;            }            if($usuario >  0){                $usuario_id = $usuario;            }else{                $usuario_id = 0;            }                        if($formapago == 2){                $datos = $this->Reporte_ing_egr_model->get_repdebito_ventas($valfecha1, $valfecha2, $usuario_id);                echo json_encode($datos);            }elseif($formapago == 3){                $datos = $this->Reporte_ing_egr_model->get_reptransban_ventas($valfecha1, $valfecha2, $usuario_id);                echo json_encode($datos);            }elseif($formapago == 4){                $datos = $this->Reporte_ing_egr_model->get_reptarjcredito_ventas($valfecha1, $valfecha2, $usuario_id);                echo json_encode($datos);            }elseif($formapago == 5){                $datos = $this->Reporte_ing_egr_model->get_repcheque_ventas($valfecha1, $valfecha2, $usuario_id);                echo json_encode($datos);            }        }           else        {                             show_404();        }                }                }        function egresorep()    {        if($this->acceso(1)){        $data['usuario_nombre'] = $session_data['usuario_nombre'];        $data['usuario_id'] = $session_data['usuario_id'];        $this->load->model('Empresa_model');        $data['all_empresa'] = $this->Empresa_model->get_all_empresa();                $data['_view'] = 'reportes/egresorep';        $this->load->view('layouts/main',$data);        }                }        function reportegreso()    {        if($this->acceso(1)){        if ($this->input->is_ajax_request()) {            $fecha1 = $this->input->post('fecha1');               $fecha2 = $this->input->post('fecha2');             $usuario = $this->input->post('usuario_id');             $valfecha1 = "";            $valfecha2 = "";            $usuario_id = "";            if(!($fecha1 == null || empty($fecha1)) && !($fecha2 == null || empty($fecha2))){                $valfecha1 = $fecha1;                $valfecha2 = $fecha2;            }elseif(!($fecha1 == null || empty($fecha1)) && ($fecha2 == null || empty($fecha2))){                $valfecha1 = $fecha1;                $valfecha2 = $fecha1;            }elseif(($fecha1 == null || empty($fecha1)) && !($fecha2 == null || empty($fecha2))) {                $valfecha1 = $fecha2;                $valfecha2 = $fecha2;            }else{                $fecha1 = null;                $fecha2 = null;            }            if($usuario >  0){                $usuario_id = $usuario;            }else{                $usuario_id = 0;            }                        $datos = $this->Reporte_ing_egr_model->get_egresoreportes($valfecha1, $valfecha2, $usuario_id);            echo json_encode($datos);        }           else        {                             show_404();        }                }               }     function ingresorep()    {        if($this->acceso(1)){        $data['usuario_nombre'] = $session_data['usuario_nombre'];        $data['usuario_id'] = $session_data['usuario_id'];        $this->load->model('Empresa_model');        $data['all_empresa'] = $this->Empresa_model->get_all_empresa();                $data['_view'] = 'reportes/ingresorep';        $this->load->view('layouts/main',$data);        }                }    function reporteingreso()    {        if($this->acceso(1)){        if ($this->input->is_ajax_request()) {            $fecha1 = $this->input->post('fecha1');               $fecha2 = $this->input->post('fecha2');             $usuario = $this->input->post('usuario_id');             $valfecha1 = "";            $valfecha2 = "";            $usuario_id = "";            if(!($fecha1 == null || empty($fecha1)) && !($fecha2 == null || empty($fecha2))){                $valfecha1 = $fecha1;                $valfecha2 = $fecha2;            }elseif(!($fecha1 == null || empty($fecha1)) && ($fecha2 == null || empty($fecha2))){                $valfecha1 = $fecha1;                $valfecha2 = $fecha1;            }elseif(($fecha1 == null || empty($fecha1)) && !($fecha2 == null || empty($fecha2))) {                $valfecha1 = $fecha2;                $valfecha2 = $fecha2;            }else{                $fecha1 = null;                $fecha2 = null;            }            if($usuario >  0){                $usuario_id = $usuario;            }else{                $usuario_id = 0;            }                        $datos = $this->Reporte_ing_egr_model->get_ingresoreportes($valfecha1, $valfecha2, $usuario_id);            echo json_encode($datos);        }           else        {                             show_404();        }                }                }    /* reporte ingrso/egreso individual */    function reportepersonal()    {        if($this->acceso(1)){        $this->load->model('Empresa_model');        $data['all_empresa'] = $this->Empresa_model->get_all_empresa();        $data['usuario_nombre'] = $session_data['usuario_nombre'];        $data['usuario_id'] = $session_data['usuario_id'];        $data['_view'] = 'reportes/reportepersonal';        $this->load->view('layouts/main',$data);        }               }    }    