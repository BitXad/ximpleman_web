<?php
/* 
 * Generated by CRUDigniter v3.2 
 * www.crudigniter.com
 */
 
class Servicio extends CI_Controller{
    function __construct()
    {
        parent::__construct();
        $this->load->model('Servicio_model');
        $this->load->helper('numeros');
    } 
    
    /*
     * Listing of servicio
     */
    function index($es = null)
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        //$data['servicio'] = $this->Servicio_model->get_all_servicios_pendientes();
        $data['a']=$es;
        
        $this->load->model('Estado_model');
        $data['all_estado'] = $this->Estado_model->get_all_estado_servicio();
        
        $this->load->model('Empresa_model');
        $data['all_empresa'] = $this->Empresa_model->get_all_empresa();
        
        
        /*$this->load->model('Categoria_trabajo_model');
        $data['all_categoria_trabajo'] = $this->Categoria_trabajo_model->get_all_categoria_trabajo();*/
        
        $this->load->model('Categoria_servicio_model');
        $data['all_categoria_servicio'] = $this->Categoria_servicio_model->get_all_categoria_servicio_asc();
        
        $this->load->model('Parametro_model');
	$data['all_parametro'] = $this->Parametro_model->get_all_parametro();
        
        $data['_view'] = 'servicio/index';
        $this->load->view('layouts/main',$data);
        }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }

    function add()
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        $this->load->library('form_validation');

		$this->form_validation->set_rules('servicio_saldo','Servicio Saldo','required');
		
	if($this->form_validation->run())     
        {
            $usuario_id = $session_data['usuario_id'];
            
            date_default_timezone_set('America/La_Paz');
            $fecha_res = date('Y-m-d');
            $hora_res = date('H:i:s');
            
            $params = array(
                                'estado_id' => $this->input->post('estado_id'),
				'tiposerv_id' => $this->input->post('tiposerv_id'),
				'cliente_id' => $this->input->post('cliente_id'),
				'usuario_id' => $usuario_id,
				'servicio_fecharecepcion' => $fecha_res,
				'servicio_horarecepcion' => $hora_res,
				'servicio_total' => $this->input->post('servicio_total'),
				'servicio_acuenta' => $this->input->post('servicio_acuenta'),
				'servicio_saldo' => $this->input->post('servicio_saldo'),
            );
            
            $servicio_id = $this->Servicio_model->add_servicio($params);
            redirect('detalle_serv/detalle_nuevo/'.$servicio_id);
        }
        else
        {
            $this->load->model('Estado_model');
            $data['all_estado'] = $this->Estado_model->get_all_estado();

            $this->load->model('Tipo_servicio_model');
            $data['all_tipo_servicio'] = $this->Tipo_servicio_model->get_all_tipo_servicio_id1();

            $this->load->model('Cliente_model');
            $data['all_cliente_activo'] = $this->Cliente_model->get_all_cliente_id1();

//			$this->load->model('Usuario_model');
//			$data['all_usuario'] = $this->Usuario_model->get_all_usuario();
            
            $data['_view'] = 'servicio/add';
            $this->load->view('layouts/main',$data);
        }
        }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }
    
    /*
     * Editing a servicio
     */
    function edit($servicio_id)
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        // check if the servicio exists before trying to edit it
        $data['servicio'] = $this->Servicio_model->get_servicio($servicio_id);
        
        if(isset($data['servicio']['servicio_id']))
        {
            if(isset($_POST) && count($_POST) > 0)     
            {
                $usuario_id = $session_data['usuario_id'];
                $params = array(
					'estado_id' => $this->input->post('estado_id'),
					'tiposerv_id' => $this->input->post('tiposerv_id'),
					'cliente_id' => $this->input->post('cliente_id'),
					'usuario_id' => $usuario_id,
					'servicio_fecharecepcion' => $this->input->post('servicio_fecharecepcion'),
					'servicio_horarecepcion' => $this->input->post('servicio_horarecepcion'),
					'servicio_total' => $this->input->post('servicio_total'),
					'servicio_acuenta' => $this->input->post('servicio_acuenta'),
					'servicio_saldo' => $this->input->post('servicio_saldo'),
                );

                $this->Servicio_model->update_servicio($servicio_id,$params);            
                redirect('servicio/index');
            }
            else
            {
                $data['_view'] = 'servicio/edit';
                $this->load->view('layouts/main',$data);
            }
        }
        else
            show_error('The servicio you are trying to edit does not exist.');
        }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    } 

    /*
     * Deleting servicio
     */
    function remove($servicio_id)
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
        $servicio = $this->Servicio_model->get_servicio($servicio_id);

        // check if the servicio exists before trying to delete it
        if(isset($servicio['servicio_id']))
        {
            $this->Servicio_model->delete_servicio($servicio_id);
            redirect('servicio/index');
        }
        else
            show_error('The servicio you are trying to delete does not exist.');
        }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }
    
    /*
     * Añadir nuevo servicio y un cliente nuevo
     */
    function nuevo_servicio_cliente($cliente_id)
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        // verifica si existe este cliente con el id ingresado antes de registrar un nuevo servicio
        $this->load->model('Cliente_model');
        $data['cliente'] = $this->Cliente_model->get_cliente($cliente_id);
        
        if(isset($data['cliente']['cliente_id']))
        {
            $this->load->library('form_validation');

		$this->form_validation->set_rules('servicio_saldo','Servicio Saldo','required');
		
	    if($this->form_validation->run())     
        {   
            $usuario_id = $session_data['usuario_id'];
            date_default_timezone_set('America/La_Paz');
            $fecha_res = date('Y-m-d');
            $hora_res = date('H:i:s');
            $params = array(
				'estado_id' => $this->input->post('estado_id'),
                                'tiposerv_id' => $this->input->post('tiposerv_id'),
				'cliente_id' => $this->input->post('cliente_id'),
				'usuario_id' => $usuario_id,
				'servicio_fecharecepcion' => $fecha_res,
				'servicio_horarecepcion' => $hora_res,
				'servicio_total' => $this->input->post('servicio_total'),
				'servicio_acuenta' => $this->input->post('servicio_acuenta'),
				'servicio_saldo' => $this->input->post('servicio_saldo'),
				
            );
            
            $servicio_id = $this->Servicio_model->add_servicio($params);
            redirect('detalle_serv/detalle_nuevo/'.$servicio_id);
        }
        else
        {
                        $this->load->model('Tipo_servicio_model');
			$data['all_tipo_servicio'] = $this->Tipo_servicio_model->get_all_tipo_servicio_id1();
                        
            $data['_view'] = 'servicio/nuevo_servicio_cliente';
            $this->load->view('layouts/main',$data);
        }
        }else
            show_error('The servicio you are trying to edit does not exist.');
        }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }
    
    /* *************Al añadir nuevo servicio; se crea un nuevo servicio con estos parametros**************  */
    function crearservicio()
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
        $estado_id = 5; // este valor (PENDIENTE) esta definido en la tabla Estado
        $usuario_id = $session_data['usuario_id'];
        $tiposerv_id = 1; //este valor (Servicio Normal) esta definido en la tabla tipo_servicio
        //$cliente_id = 0; //cliente 0 que es un cliente no definido
        
        date_default_timezone_set('America/La_Paz');
        $fecha_res = date('Y-m-d');
        $hora_res = date('H:i:s');
        $params = array(
                        'estado_id' => $estado_id,
                        'usuario_id' => $usuario_id,
                        'tiposerv_id' => $tiposerv_id,
                        'servicio_fecharecepcion' => $fecha_res,
                        'servicio_horarecepcion' => $hora_res,
        );
        
        $servicio_id = $this->Servicio_model->add_servicio($params);
        redirect('servicio/serviciocreado/'.$servicio_id);
        }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }
    /*
     * Crea un Nuevo SERVICIO en donde se puede registrar productos para
     * dar amntenimineto, reparar, diagnosticar...
     */
    function serviciocreado($servicio_id, $a = null)
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        $data['a'] = $a;
        $this->load->library('form_validation');

		$this->form_validation->set_rules('servicio_saldo','Servicio Saldo','required');
		
	if($this->form_validation->run())     
        {
            $usuario_id = $session_data['usuario_id'];
            
            date_default_timezone_set('America/La_Paz');
            $fecha_res = date('Y-m-d');
            $hora_res = date('H:i:s');
            
            $params = array(
                                'estado_id' => $this->input->post('estado_id'),
				'tiposerv_id' => $this->input->post('tiposerv_id'),
				'cliente_id' => $this->input->post('cliente_id'),
				'usuario_id' => $usuario_id,
				'servicio_fecharecepcion' => $fecha_res,
				'servicio_horarecepcion' => $hora_res,
				'servicio_total' => $this->input->post('servicio_total'),
				'servicio_acuenta' => $this->input->post('servicio_acuenta'),
				'servicio_saldo' => $this->input->post('servicio_saldo'),
            );
            
            $servicio_id = $this->Servicio_model->add_servicio($params);
            redirect('detalle_serv/detalle_nuevo/'.$servicio_id);
        }
        else
        {
            $data['servicio'] = $this->Servicio_model->get_servicio($servicio_id);
            
            $this->load->model('Cliente_model');
	    $data['cliente'] = $this->Cliente_model->get_cliente($data['servicio']['cliente_id']);
	    $data['all_cliente_activo'] = $this->Cliente_model->get_all_cliente_id1();
            
            $this->load->model('Usuario_model');
	    $data['usuario'] = $this->Usuario_model->get_usuario($data['servicio']['usuario_id']);
            /*
            $this->load->model('Detalle_serv_model');
	    $data['detalle_serv'] = $this->Detalle_serv_model->get_detalle_serv_all($servicio_id);
            */
            $this->load->model('Categoria_servicio_model');
	    $data['all_categoria_servicio'] = $this->Categoria_servicio_model->get_all_categoria_servicio_id1();
            
            $this->load->model('Subcategoria_servicio_model');
	    $data['all_subcategoria_servicio'] = $this->Subcategoria_servicio_model->get_all_subcategoria_servicio_id1();
            
            $this->load->model('Responsable_model');
	    $data['all_responsable'] = $this->Responsable_model->get_all_responsable();
                
            $this->load->model('Tipo_servicio_model');
	    $data['tipo_servicio'] = $this->Tipo_servicio_model->get_tipo_servicio($data['servicio']['tiposerv_id']);
	    $data['all_tipo_servicio'] = $this->Tipo_servicio_model->get_all_tipo_servicio_id1();
            
            $this->load->model('Categoria_trabajo_model');
	    $data['all_categoria_trabajo'] = $this->Categoria_trabajo_model->get_all_categoria_trabajo_id1();
            
            $this->load->model('Tiempo_uso_model');
	    $data['all_tiempo_uso'] = $this->Tiempo_uso_model->get_all_tiempo_uso_id1();
            
            $this->load->model('Procedencia_model');
	    $data['all_procedencia'] = $this->Procedencia_model->get_all_procedencia_id1();
            
            $this->load->model('Parametro_model');
	    $data['all_parametro'] = $this->Parametro_model->get_all_parametro();
            
            $data['_view'] = 'servicio/serviciocreado';
            $this->load->view('layouts/main',$data);
        }
        }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }
    
    /*
     * Asigna un cliente a un servicio determinado
     */
    function asignarcliente($servicio_id)
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
                
                if ($this->input->is_ajax_request()){
                    $data['servicio'] = $this->Servicio_model->get_servicio($servicio_id);
                    if(isset($data['servicio']['servicio_id']))
                    {
                        $cliente_id = $this->input->post('cliente_id');
                        $params = array(
					'cliente_id' => $cliente_id,
                        );
                        $this->Servicio_model->update_servicio($servicio_id,$params);
                        $this->load->model('Cliente_model');
	                $datos = $this->Cliente_model->get_cliente($cliente_id);
                        echo json_encode($datos);
                    }else{
                        echo json_encode("noexiste");
                    }
                }
                else
                {                 
                    show_404();
                }
        }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }
    
    /*
     * Asigna un tipo de servicio a un servicio determinado
     */
    function asignartiposervicio($servicio_id)
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
                
                if ($this->input->is_ajax_request()){
                    $tiposerv_id = $this->input->post('tiposerv_id');   
                    $direccion = $this->input->post('direccion');
                    $params = array(
			'tiposerv_id' => $tiposerv_id,
			'servicio_direccion' => $direccion,
                    );
                    $this->Servicio_model->update_servicio($servicio_id,$params);
                    $datos = $this->Servicio_model->get_servicio_tiposervicio($servicio_id);
                    echo json_encode($datos);
                }
                else
                {                 
                    show_404();
                }
                
            }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }
    
    function buscardetalleservicio($servicio_id)
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
            if(isset($_POST) && count($_POST) > 0)     
            {
                $data['servicio'] = $this->Servicio_model->get_servicio($servicio_id);
                $palabra =  $this->input->post('buscar_palabra');

                //$this->Servicio_model->update_servicio($servicio_id,$params);
                //redirect('servicio/buscardetalleservicio/'.$servicio_id);
                $data['_view'] = 'servicio/buscardetalleservicio/'.$servicio_id;
                $this->load->view('layouts/main',$data);
            }
            else
            {
                redirect('servicio/serviciocreado/'.$servicio_id);
            }
            }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }
    
    
    /*
     * viene de serview
     * *************Deja en cero todos los montos del servicio ($servicio_id)
     * *************y a todos sus detalles de servicio que sean de este servicio**************
     */
    function anularserviciodet($servicio_id)
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
        $estado_id = 4; // este valor esta definido en la tabla Estado
        $usuario_id = $session_data['usuario_id'];
        
//        date_default_timezone_set('America/La_Paz');
//        $fecha_res = date('Y-m-d');
//        $hora_res = date('H:i:s');
        
        $params = array(
                        'servicio_total' => 0,
                        'servicio_acuenta' => 0,
                        'servicio_saldo' => 0,
                        'estado_id' => $estado_id,
        );
        $detparams = array(
                        'detalleserv_total' => 0,
                        'detalleserv_acuenta' => 0,
                        'detalleserv_saldo' => 0,
                        'estado_id' => $estado_id,
        );
        
        $this->load->model('Detalle_serv_model');
	$this->Detalle_serv_model->anular_detalle_serv($servicio_id, $detparams);
        
        $this->Servicio_model->update_servicio($servicio_id,$params);
        echo json_encode("ok");
        //redirect('servicio/serview/'.$servicio_id);
        }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }
    
    function serview($servicio_id, $a = null)
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        $data['a'] = $a;
        $data['servicio'] = $this->Servicio_model->get_servicio($servicio_id);
            
            $this->load->model('Cliente_model');
	    $data['cliente'] = $this->Cliente_model->get_cliente($data['servicio']['cliente_id']);
	    //$data['all_cliente_activo'] = $this->Cliente_model->get_all_cliente_id1();
            
            $this->load->model('Usuario_model');
	    $data['usuario'] = $this->Usuario_model->get_usuario($data['servicio']['usuario_id']);
            
            $this->load->model('Tipo_servicio_model');
	    $data['tipo_servicio'] = $this->Tipo_servicio_model->get_tipo_servicio($data['servicio']['tiposerv_id']);
            
            $this->load->model('Detalle_serv_model');
	    $data['detalle_serv'] = $this->Detalle_serv_model->get_detalle_serv_all($servicio_id);
            
            $this->load->model('Parametro_model');
	    $data['all_parametro'] = $this->Parametro_model->get_all_parametro();
            
        $data['_view'] = 'servicio/serview';
        $this->load->view('layouts/main',$data);
        }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }
    /* 
     * viene de servicio
     * *************Deja en cero todos los montos del servicio ($servicio_id)
     * *************y a todos sus detalles de servicio que sean de este servicio**************
     */
    function anularserv($servicio_id)
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
        $estado_id = 4; // este valor esta definido en la tabla Estado
        $usuario_id = $session_data['usuario_id'];
        

        $params = array(
                        'servicio_total' => 0,
                        'servicio_acuenta' => 0,
                        'servicio_saldo' => 0,
                        'estado_id' => $estado_id,
        );
        $detparams = array(
                        'detalleserv_total' => 0,
                        'detalleserv_acuenta' => 0,
                        'detalleserv_saldo' => 0,
                        'estado_id' => $estado_id,
        );
        
        $this->load->model('Detalle_serv_model');
	$this->Detalle_serv_model->anular_detalle_serv($servicio_id, $detparams);
        
        $this->Servicio_model->update_servicio($servicio_id,$params);
        echo json_encode("ok");
        //redirect('servicio');
        }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }
    /*
     * Funcion para buscar(dado una categoria) y redibujar las subcategorias 
     */
    function fetch_data()
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
 
//        if(isset($this->input->post('catserv_id')))
//        {
            $catserv_id = $this->input->post('catserv_id');
            $this->load->model('Subcategoria_servicio_model');
            $res = $this->Subcategoria_servicio_model->get_all_subcategoria_de_categoria($catserv_id);
            echo json_encode($res);
            }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }
    /*
     * Funcion que busca un servicio dado un codigo determinado
     */
    function buscarporcod()
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
        if(isset($_POST) && count($_POST) > 0)     
        {
            $servicio_id = $this->input->post('servicio_id');
            $res = $this->Servicio_model->get_servicio($servicio_id);
            if(isset($res) && !is_null($res)){
                redirect('servicio/serview/'.$servicio_id);
            }else{
            redirect('servicio/index/1');
            }
        }
        else
        {
            redirect('servicio/index/1');
        }
        }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }
    /*
     * Anula un detalle (detalleserv_id) de un Servicio
     */
    function anulardetalle($servicio_id, $detalleserv_id)
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
        $estado_id = 4; // este valor esta definido en la tabla Estado = ANULADO
        $this->load->model('Detalle_serv_model');
        $detparams = array(
                        'detalleserv_total' => 0,
                        'detalleserv_acuenta' => 0,
                        'detalleserv_saldo' => 0,
                        'estado_id' => $estado_id,
        );
	$this->Detalle_serv_model->update_detalle_serv($detalleserv_id, $detparams);
        
        $res_ids = $this->Detalle_serv_model->get_ids_estado_detalle_serv($servicio_id);
        $cont = 0;
        foreach($res_ids as $ids)
        {
            if($ids['estado_id'] == $estado_id){
                $cont++;
            }
        }
        if($cont == count($res_ids)){
            $params = array(
                        'estado_id' => $estado_id,
            );
            $this->Servicio_model->update_servicio($servicio_id,$params);
        }

        $data['resultado'] = $this->Detalle_serv_model->sumarmontos($servicio_id);
        $total = $data['resultado']['total'];
        $acuenta = $data['resultado']['acuenta'];
        $saldo = $data['resultado']['saldo'];
        $sumparams = array(
                            'servicio_total' => $total,
                            'servicio_acuenta' => $acuenta,
                            'servicio_saldo' => $saldo,
        );

        $this->Servicio_model->update_servicio($servicio_id,$sumparams);
        echo json_encode("ok");
        }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }
    /*
    * buscar servicios
    */
    function buscarservicios()
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
                
                

        if ($this->input->is_ajax_request()) {
            
            $parametro = $this->input->post('filtro');   
            
            if ($parametro!=""){
            $datos = $this->Servicio_model->get_busqueda_servicio_parametro($parametro);
            //$datos = $this->Inventario_model->get_inventario_bloque();
            echo json_encode($datos);
            }else{
                $datos = $this->Servicio_model->get_all_servicios_pendientes();
            echo json_encode($datos);
            }
        }
        else
        {                 
            show_404();
        }
        }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }
    
    function boletarecepcion_boucher($servicio_id)
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        
            $data['servicio'] = $this->Servicio_model->get_servicio($servicio_id);
            
            $this->load->model('Cliente_model');
	    $data['cliente'] = $this->Cliente_model->get_cliente($data['servicio']['cliente_id']);
//	    $data['all_cliente_activo'] = $this->Cliente_model->get_all_cliente_id1();
            
            $this->load->model('Usuario_model');
	    $data['usuario'] = $this->Usuario_model->get_usuario($data['servicio']['usuario_id']);
            
            $this->load->model('Detalle_serv_model');
	    $data['detalle_serv'] = $this->Detalle_serv_model->get_detalle_serv_all($servicio_id);
            
            $empresa_id = 1;
            $this->load->model('Empresa_model');
	    $data['empresa'] = $this->Empresa_model->get_empresa($empresa_id);

            $this->load->model('Dosificacion_model');
	    $data['all_dosificacion'] = $this->Dosificacion_model->get_all_dosificacion_servicio();
            
            $data['_view'] = 'servicio/boletarecepcion_boucher';
            $this->load->view('layouts/main',$data);
        }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }
    
    function boletarecepcion($servicio_id)
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        
            $data['servicio'] = $this->Servicio_model->get_servicio($servicio_id);
            
            $this->load->model('Cliente_model');
	    $data['cliente'] = $this->Cliente_model->get_cliente($data['servicio']['cliente_id']);
//	    $data['all_cliente_activo'] = $this->Cliente_model->get_all_cliente_id1();
            
            $this->load->model('Usuario_model');
	    $data['usuario'] = $this->Usuario_model->get_usuario($data['servicio']['usuario_id']);
            
            $this->load->model('Detalle_serv_model');
	    $data['detalle_serv'] = $this->Detalle_serv_model->get_detalle_serv_all($servicio_id);
            
            $empresa_id = 1;
            $this->load->model('Empresa_model');
	    $data['empresa'] = $this->Empresa_model->get_empresa($empresa_id);

            $this->load->model('Dosificacion_model');
	    $data['all_dosificacion'] = $this->Dosificacion_model->get_all_dosificacion_servicio();
            
            $data['_view'] = 'servicio/boletarecepcion';
            $this->load->view('layouts/main',$data);
        }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }
    /*
     * muestra el detalle de un servicio a un usuario CLIENTE
     */
    function verservdet($servicio_id)
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==5) {
                $data = array(
                    'page_title' => 'Cliente >> Mi Cuenta'
                );
             $data['servicio'] = $this->Servicio_model->get_servicio($servicio_id);
            
            $this->load->model('Cliente_model');
	    $data['cliente'] = $this->Cliente_model->get_cliente($data['servicio']['cliente_id']);
	    $data['all_cliente_activo'] = $this->Cliente_model->get_all_cliente_id1();
            
            $this->load->model('Usuario_model');
	    $data['usuario'] = $this->Usuario_model->get_usuario($data['servicio']['usuario_id']);
            
            $this->load->model('Detalle_serv_model');
	    $data['detalle_serv'] = $this->Detalle_serv_model->get_detalle_serv_all($servicio_id);
            
            $this->load->model('Categoria_servicio_model');
	    $data['all_categoria_servicio'] = $this->Categoria_servicio_model->get_all_categoria_servicio_id1();
                
            $this->load->model('Responsable_model');
	    $data['all_responsable'] = $this->Responsable_model->get_all_responsable();
                
            $this->load->model('Tipo_servicio_model');
	    $data['tipo_servicio'] = $this->Tipo_servicio_model->get_tipo_servicio($data['servicio']['tiposerv_id']);
	    $data['all_tipo_servicio'] = $this->Tipo_servicio_model->get_all_tipo_servicio_id1();
            
            
            $this->load->model('Subcategoria_servicio_model');
	    $data['all_subcategoria_servicio'] = $this->Subcategoria_servicio_model->get_all_subcategoria_servicio_id1();
            
            $this->load->model('Categoria_trabajo_model');
	    $data['all_categoria_trabajo'] = $this->Categoria_trabajo_model->get_all_categoria_trabajo_id1();
            
            $this->load->model('Tiempo_uso_model');
	    $data['all_tiempo_uso'] = $this->Tiempo_uso_model->get_all_tiempo_uso_id1();
            
            $this->load->model('Procedencia_model');
	    $data['all_procedencia'] = $this->Procedencia_model->get_all_procedencia_id1();


            $this->load->model('Estado_model');
			$data['all_estado'] = $this->Estado_model->get_all_estado();

            
        $data['_view'] = 'servicio/verservdet';
        $this->load->view('layouts/main',$data);
        }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }
    
    /*
    * buscar servicios por fechas
    */
    function buscarserviciosfecha()
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
                
        if ($this->input->is_ajax_request()) {
            
            $filtro = $this->input->post('filtro');   
            
            //if ($filtro!=""){
            $datos = $this->Servicio_model->get_busqueda_servicio_filtro($filtro);
            //$datos = $this->Inventario_model->get_inventario_bloque();
            echo json_encode($datos);
            /*}
            else echo json_encode(null);*/
        }
        else
        {                 
            show_404();
        }
        }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }
    
    /*
     * obtenemos los detalles de un determinado servicio
    */
    function getdetalleservicio($servicio_id)
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
                
                if ($this->input->is_ajax_request()){
                    $data['servicio'] = $this->Servicio_model->get_servicio($servicio_id);
                    if(isset($data['servicio']['servicio_id']))
                    {
                        $this->load->model('Detalle_serv_model');
	                $datos = $this->Detalle_serv_model->get_detalle_serv_all($servicio_id);
                        echo json_encode($datos);
                    }else{
                        echo json_encode("noexiste");
                    }
                }
                else
                {                 
                    show_404();
                }
        }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }
    
    /*
     * Obtiene los datos de un servicio; lo que recupera son los montos
     */
    function getmontoservicio($servicio_id)
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
                
                if ($this->input->is_ajax_request()){
                   $datos = $this->Servicio_model->get_servicio($servicio_id);
                    echo json_encode($datos);
                }
                else
                {                 
                    show_404();
                }
        }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }
    /* **********Obtiene todos los insumos usados en un determinado detalle de servicio*************** */
    function obtenerinsumosusados($detalleserv_id)
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
                
                $this->load->model('Detalle_venta_model');
                $datos = $this->Detalle_venta_model->get_all_insumo_usado($detalleserv_id);
                echo json_encode($datos);
            }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }
    /*
     * Reporte de los servicios por fechas
     */
    function repserviciofechas($es = null)
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        $data['servicio'] = $this->Servicio_model->get_all_repservicios();
        $data['a']=$es;
        
        $this->load->model('Empresa_model');
        $data['empresa'] = $this->Empresa_model->get_all_empresa();
        
        $this->load->model('Estado_model');
        $data['all_estado'] = $this->Estado_model->get_all_estado_servicio();
        
        $this->load->model('Usuario_model');
        $data['all_usuario'] = $this->Usuario_model->get_all_usuario();
        
        $this->load->model('Responsable_model');
        $data['all_responsable'] = $this->Responsable_model->get_all_responsable();
        
        $this->load->model('Cliente_model');
        $data['all_cliente'] = $this->Cliente_model->get_all_cliente();
        
        
        $data['_view'] = 'servicio/repserviciofechas';
        $this->load->view('layouts/main',$data);
        }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }
    /*
     * Reporte de los servicios por fechas
     */
    function buscarrepservicioall()
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
                if ($this->input->is_ajax_request()){
                    $filtro = $this->input->post('filtro');
                    $datos = $this->Servicio_model->get_all_busquedarepservicios($filtro);
                    echo json_encode($datos);
                }
                else
                {                 
                    show_404();
                }
                
        
            }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }
    /*
     * Lista de Servicios para Informes Tecnicos
     */
    function repinftecservicio()
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        $data['servicio'] = $this->Servicio_model->get_all_servicios_pendientes();
        
        $this->load->model('Estado_model');
        $data['all_estado'] = $this->Estado_model->get_all_estado_servicio();
        
        $data['_view'] = 'servicio/repinftecservicio';
        $this->load->view('layouts/main',$data);
        }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }
    /*
     * Boleta de impresion de informe tecnico de un Servicio
     */
    function boletainftecservicio($servicio_id)
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
               $contitulo = $this->input->post('contitulo'.$servicio_id);
               if(isset($contitulo)){
                   $data['sintitulo']= 1;
               }
            $data['servicio'] = $this->Servicio_model->get_servicio($servicio_id);
            
            $this->load->model('Cliente_model');
	    $data['cliente'] = $this->Cliente_model->get_cliente($data['servicio']['cliente_id']);
            
            $this->load->model('Detalle_serv_model');
	    $data['detalle_serv'] = $this->Detalle_serv_model->get_detalle_serv_all($servicio_id);
            
            $empresa_id = 1;
            $this->load->model('Empresa_model');
	    $data['empresa'] = $this->Empresa_model->get_empresa($empresa_id);
            
            $data['_view'] = 'servicio/boletainftecservicio';
            $this->load->view('layouts/main',$data);
        }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }
    /*
     * Lista de detalles de servicio para Informes Tecnicos
     */

    function repinftecdetalleserv($es = null)
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        $data['servicio'] = $this->Servicio_model->get_all_repservicios();
        $data['a']=$es;
        
        $this->load->model('Empresa_model');
        $data['empresa'] = $this->Empresa_model->get_all_empresa();
        
        $this->load->model('Estado_model');
        $data['all_estado'] = $this->Estado_model->get_all_estado_servicio();
        
        $this->load->model('Usuario_model');
        $data['all_usuario'] = $this->Usuario_model->get_all_usuario();
        
        $this->load->model('Responsable_model');
        $data['all_responsable'] = $this->Responsable_model->get_all_responsable();
        
        $this->load->model('Cliente_model');
        $data['all_cliente'] = $this->Cliente_model->get_all_cliente();
        
        
        $data['_view'] = 'servicio/repinftecdetalleserv';
        $this->load->view('layouts/main',$data);
        }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }
    /*
     * Boleta de impresion de informe tecnico de un detalle de Servicio
     */
    function boletainftecdetalleserv($detalleserv_id)
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
       
                $contitulo = $this->input->post('contitulo'.$detalleserv_id);
               if(isset($contitulo)){
                   $data['sintitulo']= 1;
               }
            $this->load->model('Detalle_serv_model');
	    $data['detalle_serv'] = $this->Detalle_serv_model->get_detalle_servinf($detalleserv_id);
            
            $data['servicio'] = $this->Servicio_model->get_servicio($data['detalle_serv']['servicio_id']);
            
            $this->load->model('Cliente_model');
	    $data['cliente'] = $this->Cliente_model->get_cliente($data['servicio']['cliente_id']);
            
            
            
            $empresa_id = 1;
            $this->load->model('Empresa_model');
	    $data['empresa'] = $this->Empresa_model->get_empresa($empresa_id);
            
            $data['_view'] = 'servicio/boletainftecdetalleserv';
            $this->load->view('layouts/main',$data);
        }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }
    /*
     * Boleta de impresion de orden de SERVICIO
     */
    function boletacomprobanteserv($servicio_id)
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
               $contitulo = $this->input->post('contitulo'.$servicio_id);
               if(isset($contitulo)){
                   $data['sintitulo']= 1;
               }
               $data['usuario'] = $session_data['usuario_nombre'];
            $data['servicio'] = $this->Servicio_model->get_serviciorden_reptec($servicio_id);
            
            $this->load->model('Cliente_model');
	    $data['cliente'] = $this->Cliente_model->get_cliente($data['servicio']['cliente_id']);
            
            $this->load->model('Tipo_servicio_model');
	    $data['tipo_servicio'] = $this->Tipo_servicio_model->get_tipo_servicio($data['servicio']['tiposerv_id']);
            
            $this->load->model('Detalle_serv_model');
	    $data['detalle_serv'] = $this->Detalle_serv_model->get_detalle_serv_all($servicio_id);
            
            $this->load->model('Dosificacion_model');
	    $data['dosificacion5'] = $this->Dosificacion_model->get_dosificacion_leyenda5();
	    $data['dosificacion3'] = $this->Dosificacion_model->get_dosificacion_leyenda3();
            
            $empresa_id = 1;
            $this->load->model('Empresa_model');
	    $data['empresa'] = $this->Empresa_model->get_empresa($empresa_id);
            
            $data['_view'] = 'servicio/boletacomprobanteserv';
            $this->load->view('layouts/main',$data);
        }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }
    /*
    * buscar servicios pendientes
    */
    function buscarserviciospendientes()
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
        if ($this->input->is_ajax_request()) {
            
            $datos = $this->Servicio_model->get_all_servicios_pendientes();
            echo json_encode($datos);
        }
        else
        {                 
            show_404();
        }
        }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }
    /*
     * Reporte de los servicios diario
     */
    function repserviciodiario()
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        $data['servicio'] = $this->Servicio_model->get_all_repservicios();
        
        $this->load->model('Empresa_model');
        $data['empresa'] = $this->Empresa_model->get_all_empresa();
        
       /* $this->load->model('Estado_model');
        $data['all_estado'] = $this->Estado_model->get_all_estado_servicio();
        */
        $this->load->model('Usuario_model');
        $data['all_usuario'] = $this->Usuario_model->get_all_usuario();
        
        $this->load->model('Responsable_model');
        $data['all_responsable'] = $this->Responsable_model->get_all_responsable();
        
        $this->load->model('Cliente_model');
        $data['all_cliente'] = $this->Cliente_model->get_all_cliente();
        
        
        $data['_view'] = 'servicio/repserviciodiario';
        $this->load->view('layouts/main',$data);
        }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }
    /*
    * buscar servicios del dia
    */
    function buscardetalleserv_dia()
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
        if ($this->input->is_ajax_request()) {
            
            $datos = $this->Servicio_model->get_all_servicios_dia();
            echo json_encode($datos);
        }
        else
        {                 
            show_404();
        }
        }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }
    /* **********Obtiene Precio de un detalle de venta*************** */
    function obtener_preciosinsumosusados($detalleserv_id)
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
                
                $this->load->model('Detalle_venta_model');
                $datos = $this->Detalle_venta_model->get_costototal_insumos_usados($detalleserv_id);
                echo json_encode($datos);
            }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }
}