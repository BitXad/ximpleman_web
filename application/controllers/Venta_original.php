<?php
/* 
 * Generated by CRUDigniter v3.2 
 * www.crudigniter.com.
 */
require_once(APPPATH.'libraries/vendor/autoload.php');
use Dompdf\Dompdf;
use Dompdf\Options;

class Venta extends CI_Controller{
    
    private $caja_id = 0;
    private $parametros;
    private $empresa;
    private $registroeventos_id = 0;
    private $dosificacion;
    private $nombre_archivo;
    private $sistema;
    //private $puntodeventa = 0;
    
    function __construct()
    {
        parent::__construct();
        $this->load->model([
            'Venta_model',
            'Sincronizacion_model',
            'Inventario_model',
            'Pedido_model',
            'Tipo_transaccion_model',
            'Forma_pago_model',
            'Pedido_model',
            'Tipo_cliente_model',
            'Dosificacion_model',
            'Factura_model',
            'Empresa_model',
            'Detalle_venta_model',
            'Parametro_model',
            'Estado_model',
            'Usuario_model',
            'Cliente_model',
            'Tipo_servicio_model',
            'Preferencia_model',
            'Credito_model',
            'Categoria_clientezona_model',
            'Promocion_model',
            'Modelo_contrato_model',
            'Mesa_model',
            'Moneda_model',
            'Banco_model',
            'Caja_model',
            'Eventos_significativos_model',
            'Emision_paquetes_model',
            'Sistema_model',
            'Factura_datos_model',
        ]);
        

        $this->load->library('ControlCode');        
        $this->load->helper('xml');
        $this->load->helper('validacionxmlxsd_helper');
        $this->load->helper('numeros_helper');
        
        //Carga los parametros en una variable global
        
        $this->sistema = $this->Sistema_model->get_sistema();
        
        $parametro = $this->Parametro_model->get_parametros();
        $this->parametros = $parametro[0];
        
        $dosificacion = $this->Dosificacion_model->get_dosificacion(1);
        $this->dosificacion = $dosificacion;
        $this->nombre_archivo = $this->dosificacion["dosificacion_documentosector"];
        
        
        $empresa = $this->Empresa_model->get_empresa(1);
        $this->empresa = $empresa[0];
        
        $this->puntodeventa =  0; //Colcoar la variable respectiva

        if ($this->session->userdata('logged_in')) {
            $this->session_data = $this->session->userdata('logged_in');
        }else {
            redirect('', 'refresh');
        }
        
        //***************** seleccionare punto de venta ***********
        $usuario_id = $this->session_data['usuario_id'];
        $puntoventa = $this->Usuario_model->get_punto_venta_usuario($usuario_id);
                
        $evento = $this->Eventos_significativos_model->get_evento_vigente($puntoventa["puntoventa_codigo"]);
        $this->registroeventos_id = $evento["registroeventos_id"];
        
        //***************** fin seleccionare punto de venta ***********
        
        //*********** Administracion de caja *********
                $usuario_id = $this->session_data['usuario_id'];
                $caja = $this->Caja_model->get_caja_usuario($usuario_id);
                
                if (!sizeof($caja)>0){ // si la caja no esta iniciada
                    //iniciar caja y dejarla en pendiente
                    $this->caja_id = 0;
                }else{
                    $this->caja_id = $caja[0]["caja_id"];
                    
                }
                
                
        //*********** FIN Administracion de caja *********
        
    }
    /* *****Funcion que verifica el acceso al sistema**** */
    private function acceso($id_rol){
        
        $rolusuario = $this->session_data['rol'];
        if($rolusuario[$id_rol-1]['rolusuario_asignado'] == 1){
            return true;
        }else{
//            $data['_view'] = 'login/mensajeacceso';
//            $this->load->view('layouts/main',$data);
            return false;
        }
    } 

    /*
     * Listing of venta
     */
    function index()
    {

        if($this->acceso(18)){
        //**************** inicio contenido ***************
        $data['sistema'] = $this->sistema;
        $data['rolusuario'] = $this->session_data['rol'];
        $data['tipousuario_id'] = $this->session_data['tipousuario_id'];
        $data['dosificacion'] = $this->dosificacion;
        //$data['venta'] = $this->Venta_model->get_all_venta($params);
        $data['page_title'] = $this->sistema["sistema_moduloventas"]." del dia";
        $data['docs_identidad'] = $this->Sincronizacion_model->getall_docs_ident();  
//        $data['parametro'] = $this->Parametro_model->get_parametros();
        $data['parametro'] = $this->parametros;
        $data['moneda'] = $this->Moneda_model->get_moneda(2); //Obtener moneda extragera
        $data['estado'] = $this->Estado_model->get_tipo_estado(1);
        $data['usuario'] = $this->Venta_model->get_usuarios();
        $data['modelos_c'] = $this->Modelo_contrato_model->get_all_modelo_contrato();

        $sql = "select * from usuario where usuario_id = ".$this->session_data['usuario_id'];
        $x = $this->Venta_model->consultar($sql);
        
        $puntoventa = $x[0]["puntoventa_codigo"]; //$this->session_data['tipopuntoventa_codigo'];
        
        $data['eventos'] = $this->Eventos_significativos_model->consultar("select * from registro_eventos where estado_id = 1 and registroeventos_puntodeventa = ".$puntoventa);
        $dosificacion = $this->Dosificacion_model->get_all_dosificacion();
        if(sizeof($dosificacion)>0){
            $data['dosificado'] = 1;
        }else{
            $data['dosificado'] = 0;
        }
        
        $data['_view'] = 'venta/index';
        $this->load->view('layouts/main',$data);
        
        //**************** fin contenido ***************
		}
        
    }

    function ventas()
    {    
        
        if($this->acceso(12)){
        //**************** inicio contenido ***************     
        $data['sistema'] = $this->sistema;
        $data['rolusuario'] = $this->session_data['rol'];
        $usuario_id = $this->session_data['usuario_id'];
        $tipousuario_id = $this->session_data['tipousuario_id'];        
        $punto_venta = $this->session_data['puntoventa_codigo'];        

        $data['page_title'] = $this->sistema["sistema_moduloventas"];
        $data['dosificacion'] = $this->Dosificacion_model->get_all_dosificacion();
        $data['pedidos'] = $this->Pedido_model->get_pedidos_activos();
        
        if($data['dosificacion'][0]['docsec_codigoclasificador'] == 23){
            $data['cliente'] = $this->Venta_model->get_cliente_inicialprevalorada();
        }else{
            $data['cliente'] = $this->Venta_model->get_cliente_inicial();
        }
        
        if($data['dosificacion'][0]['docsec_codigoclasificador'] == 12){
            $sql = "select * from pais order by pais_descripcion";
            $data['paises'] = $this->Venta_model->consultar($sql);
        }
        
        $data['zonas'] = $this->Categoria_clientezona_model->get_all_categoria_clientezona();
        $data['categoria_producto'] = $this->Venta_model->get_categoria_producto();
        $data['tipo_transaccion'] = $this->Tipo_transaccion_model->get_all_tipo();
        $data['forma_pago'] = $this->Forma_pago_model->get_all_forma();
        $data['tipo_cliente'] = $this->Tipo_cliente_model->get_all_tipo_cliente();
        $data['tipo_servicio'] = $this->Tipo_servicio_model->get_all_tipo_servicio();
        $data['parametro'] =  $this->parametros;//$this->Parametro_model->get_parametros();
        $data['moneda'] = $this->Moneda_model->get_moneda(2); //Obtener moneda extragera
        $data['usuario'] = $this->Usuario_model->get_all_usuario_activo();
        $data['preferencia'] = $this->Preferencia_model->get_producto_preferencia();
        $data['promociones'] = $this->Promocion_model->get_promociones();
        $data['mesas'] = $this->Mesa_model->get_all_mesa();
        $data['usuario_id'] = $usuario_id;
        $data['bancos'] = $this->Banco_model->getall_bancosact_asc();
        $data['docs_identidad'] = $this->Sincronizacion_model->getall_docs_ident();
        $data['tipousuario_id'] = $tipousuario_id;
//        $data['eventos'] = $this->Venta_model->consultar("select * from registro_eventos where estado_id=1");
        $data['eventos'] = $this->Eventos_significativos_model->get_mis_eventos();
        $data['empresa_email'] = $this->empresa["empresa_email"];
        $data['almacenes'] = $this->Inventario_model->get_almacenes();
        $data['empresa'] = $this->Empresa_model->get_empresa(1);
        
        $user = $this->Venta_model->consultar("select * from usuario where usuario_id = ".$usuario_id);
        $data['puntoventa_codigo'] = $user[0]["puntoventa_codigo"];
        
        $data['eventos_significativos'] = $this->Eventos_significativos_model->get_all_codigos();
        $data['empresa_email'] = $this->empresa["empresa_email"];
        
        $sql ="select * from cufd where cufd_id = (select MAX(cufd_id) from cufd where cufd_puntodeventa = ".$punto_venta.") and cufd_puntodeventa = ".$punto_venta;        
        //echo $sql;
        $data['cufd'] = $this->Venta_model->consultar($sql);
        
        $sql = "SELECT  i.producto_id, i.`producto_nombre`, i.`producto_codigo`, i.`producto_precio`, i.producto_codigosin, i.producto_codigounidadsin
                FROM
                  inventario i
                WHERE
                  i.producto_codigosin = 0 or  i.producto_codigosin is null or
                  i.producto_codigounidadsin = 0 or i.producto_codigosin is null";
        $data['productos_homologados'] = $this->Venta_model->consultar($sql);

        
        //$data['venta'] = $this->Venta_model->get_all_venta($usuario_id);
        
        $data['_view'] = 'venta/ventas';
        $this->load->view('layouts/main',$data);
        		
        //**************** fin contenido ***************
        }        
    }
    
    function ventas_cliente($cliente_id)
    {    
        
        if($this->acceso(12)){
        //**************** inicio contenido ***************        
        $data['sistema'] = $this->sistema;
        $data['rolusuario'] = $this->session_data['rol'];
        $usuario_id = $this->session_data['usuario_id'];
        $tipousuario_id = $this->session_data['tipousuario_id'];        
        $punto_venta = $this->session_data['puntoventa_codigo'];        

        $data['page_title'] = $this->sistema["sistema_moduloventas"];
        $data['dosificacion'] = $this->Dosificacion_model->get_all_dosificacion();
        $data['pedidos'] = $this->Pedido_model->get_pedidos_activos();
        
        $cliente_array = $this->Cliente_model->get_cliente_by_id($cliente_id);
        if(sizeof($cliente_array)>0)
        {
            $data['cliente'] = $cliente_array;
        }
        else
        {
            $data['cliente'] = $this->Venta_model->get_cliente_inicial();
            
        }        
        
        $data['zonas'] = $this->Categoria_clientezona_model->get_all_categoria_clientezona();
        $data['categoria_producto'] = $this->Venta_model->get_categoria_producto();
        $data['tipo_transaccion'] = $this->Tipo_transaccion_model->get_all_tipo();
        $data['forma_pago'] = $this->Forma_pago_model->get_all_forma();
        $data['tipo_cliente'] = $this->Tipo_cliente_model->get_all_tipo_cliente();
        $data['tipo_servicio'] = $this->Tipo_servicio_model->get_all_tipo_servicio();
        $data['parametro'] =  $this->parametros;//$this->Parametro_model->get_parametros();
        $data['moneda'] = $this->Moneda_model->get_moneda(2); //Obtener moneda extragera
        $data['usuario'] = $this->Usuario_model->get_all_usuario_activo();
        $data['preferencia'] = $this->Preferencia_model->get_producto_preferencia();
        $data['promociones'] = $this->Promocion_model->get_promociones();
        $data['mesas'] = $this->Mesa_model->get_all_mesa();
        $data['usuario_id'] = $usuario_id;
        $data['bancos'] = $this->Banco_model->getall_bancosact_asc();
        $data['docs_identidad'] = $this->Sincronizacion_model->getall_docs_ident();
        $data['tipousuario_id'] = $tipousuario_id;
//        $data['eventos'] = $this->Venta_model->consultar("select * from registro_eventos where estado_id=1");
        $data['eventos'] = $this->Eventos_significativos_model->get_mis_eventos();
        $data['empresa_email'] = $this->empresa["empresa_email"];
        $data['almacenes'] = $this->Inventario_model->get_almacenes();
        $data['empresa'] = $this->Empresa_model->get_empresa(1);
        
        $user = $this->Venta_model->consultar("select * from usuario where usuario_id = ".$usuario_id);
        $data['puntoventa_codigo'] = $user[0]["puntoventa_codigo"];
        
        $data['eventos_significativos'] = $this->Eventos_significativos_model->get_all_codigos();
        $data['empresa_email'] = $this->empresa["empresa_email"];
        
        $sql ="select * from cufd where cufd_id = (select MAX(cufd_id) from cufd where cufd_puntodeventa = ".$punto_venta.") and cufd_puntodeventa = ".$punto_venta;        
        //echo $sql;
        $data['cufd'] = $this->Venta_model->consultar($sql);
        
        $sql = "SELECT  i.producto_id, i.`producto_nombre`, i.`producto_codigo`, i.`producto_precio`, i.producto_codigosin, i.producto_codigounidadsin
                FROM
                  inventario i
                WHERE
                  i.producto_codigosin = 0 or  i.producto_codigosin is null or
                  i.producto_codigounidadsin = 0 or i.producto_codigosin is null";
        $data['productos_homologados'] = $this->Venta_model->consultar($sql);
        //$data['venta'] = $this->Venta_model->get_all_venta($usuario_id);
        
        $data['_view'] = 'venta/ventas';
        $this->load->view('layouts/main',$data);
        		
        //**************** fin contenido ***************
        }       
        
    }

    function ingresar_detalle()
    {       
        if($this->acceso(12)||$this->acceso(30)){ // 12 ventas 30 pedidos
        //**************** inicio contenido ***************        
  
        $usuario_id = $this->session_data['usuario_id'];
        $data['sistema'] = $this->sistema;
        $producto_id = $this->input->post('producto_id');
        $cantidad = $this->input->post('cantidad');
        $existencia = $this->input->post('existencia');
        $datos1 = $this->input->post('datos1');
        $agrupado = $this->input->post('agrupado');
        $detalleven_id = $this->input->post('detalleven_id');
        $serie = $this->input->post('preferencias');
        $descuento = $this->input->post('descuento');
        $descuentoparcial = $this->input->post('descuentoparcial');
        $precio_por_cantidad = 1;
        
        //consulta para registrar del detalle venta
        $sql1 = "insert into detalle_venta_aux(venta_id,moneda_id,producto_id,detalleven_codigo,detalleven_cantidad,detalleven_unidad,detalleven_costo,detalleven_precio,detalleven_subtotal, ".
                "detalleven_descuentoparcial,detalleven_descuento, detalleven_total,detalleven_caracteristicas,detalleven_preferencia,detalleven_comision,detalleven_tipocambio,usuario_id,existencia,".
                "producto_nombre, producto_unidad, producto_marca, categoria_id, producto_codigobarra,
                detalleven_envase,detalleven_nombreenvase,detalleven_costoenvase,detalleven_precioenvase,
                detalleven_cantidadenvase,detalleven_garantiaenvase,detalleven_devueltoenvase,detalleven_montodevolucion,
                detalleven_prestamoenvase, detalleven_fechavenc,detalleven_unidadfactor, preferencia_id, clasificador_id, detalleven_tc) ".
                " value(".$datos1.")";
        
        //si el producto ya esta registrado, solo actualizara la cantidad y total
        $sql2 = "update detalle_venta_aux set detalleven_cantidad = detalleven_cantidad + ".$cantidad.
                ", detalleven_subtotal = detalleven_precio * (detalleven_cantidad)".
                ", detalleven_descuentoparcial = ".$descuentoparcial.
                ", detalleven_descuento = ".$descuento.
                ", detalleven_total = round( (detalleven_precio - ".$descuentoparcial.")*(detalleven_cantidad) ,2)".
                ", detalleven_cantidadenvase = if(detalleven_envase=1,detalleven_cantidad,0) ".
                //", detalleven_preferencia = concat(detalleven_preferencia,', $serie')".
                "  where producto_id = ".$producto_id." and usuario_id = ".$usuario_id;
        
        $descuento = 0;
        
        //verificando si la cantidad que se estan ingresando al detalle no excede el limite del inventario
        $sql = "select if(sum(detalleven_cantidad)+".$cantidad.">".$existencia.",1,0) as resultado from detalle_venta_aux where producto_id = ".$producto_id;
        $resultado = $this->Venta_model->consultar($sql);
        
        $existe = 0;
        
        if ($resultado[0]['resultado']==0){ //si la cantidad aun es menor al inventario
            if($agrupado==1){
                $existe = $this->Venta_model->existe($producto_id,$usuario_id);
                if ($existe){
                    $sql = $sql2; 
                    $existe = 1;
                    $detalleven_id = $this->Venta_model->ejecutar($sql);
                }
                else{
                    // insertar cantidad
                    $sql = $sql1;
                    $existe = 0;
                    $this->Venta_model->ejecutar($sql);
                    
                }                
            }else{ //si no registraran datos agrupados   
                if ($detalleven_id>0){ //si exl producto existe en el detalle
                    //si el producto ya esta registrado, solo actualizara la cantidad y total
                    $sql2 = "update detalle_venta_aux set detalleven_cantidad = detalleven_cantidad + ".$cantidad.
                            ", detalleven_subtotal = detalleven_precio * (detalleven_cantidad)".
                            ", detalleven_descuento = ".$descuento.
                            ", detalleven_total = (detalleven_precio - ".$descuento.")*(detalleven_cantidad)".
                            ", detalleven_cantidadenvase = if(detalleven_envase=1,detalleven_cantidad,0) ".
                            "  where detalleven_id = ".$detalleven_id;
                    $sql = $sql2;
                    
                    $this->Venta_model->ejecutar($sql);
                }
                else{
                    
                    $sql = $sql1;
                    $detalleven_id = $this->Venta_model->ejecutar($sql);
                }
            }
          
                                
            if($this->parametros['parametro_rangoprecios'] == 1){ //si la venta es por cantidad
                
                $sql = "update detalle_venta_aux d, rango_precios r
                        set 
                        d.detalleven_precio = r.rango_precio,
                        d.`detalleven_descuentoparcial` = r.rango_descuento
                        where
                        r.producto_id = 217 and d.detalleven_cantidad >= r.rango_desde and d.detalleven_cantidad <= r.rango_hasta";
                $detalleven_id = $this->Venta_model->ejecutar($sql);
                
            }
            
            
            $result = 1;    
            echo '[{"cliente_id":"'.$result.'"}]';
            
        }
        else { $result = 0;  echo '[{"cliente_id":"'.$result.'"}]';}
            
        //**************** fin contenido ***************
        }
             
               
    }

    function eliminardetalle()
    {       
        if($this->acceso(12)){
        //**************** inicio contenido ***************       
        
        $usuario_id = $this->session_data['usuario_id'];
        
            
        //**************** bitacora caja ********************
        // NO ES NECESARIA ESTA FUNCION PORQUE ES PARTE DE LA FINALIZACION DEL PROCESO DE VENTAS
//        $bitacoracaja_fecha = "date(now())";
//        $bitacoracaja_hora = "time(now())";
//        $bitacoracaja_evento = "(select concat('ELIMINACION TOTAL PRODUCTOS EN VENTAS, CANT: ',count(*),', TOTAL: ',sum(detalleven_cantidad * detalleven_precio)) from detalle_venta_aux where usuario_id = ".$usuario_id.")";
//        //$usuario_id = esta mas arriba;
//        $bitacoracaja_montoreg = 0;
//        $bitacoracaja_montocaja = 0;
//        $bitacoracaja_tipo = 2; //2 operaciones sobre ventas
//        
//        
//        $sql = "insert into bitacora_caja(bitacoracaja_fecha, bitacoracaja_hora, bitacoracaja_evento, 
//                usuario_id, bitacoracaja_montoreg, bitacoracaja_montocaja, bitacoracaja_tipo) value(".
//                $bitacoracaja_fecha.",".$bitacoracaja_hora.",".$bitacoracaja_evento.",".
//                $usuario_id.",".$bitacoracaja_montoreg.",".$bitacoracaja_montocaja.",".$bitacoracaja_tipo.")";
//        $this->Venta_model->ejecutar($sql);
        
        //****************** fin bitacora caja *************** 
        
        $sql =  "delete from detalle_venta_aux where usuario_id=".$usuario_id;
        $this->Venta_model->ejecutar($sql);
        return true;
    
            		
        //**************** fin contenido ***************
        }
        		   
        
    }
    
    function codigo_control($dosificacion_llave, $dosificacion_autorizacion, $dosificacion_numfact, $nit,$fecha_trans, $monto)
    {
        // var_dump(isset($dosificacion_llave) ? "si dosificacion_llave":"no dosificacion_llave");
        // var_dump(isset($dosificacion_autorizacion) ? "si dosificacion_autorizacion":"no dosificacion_autorizacion");
        // var_dump(isset($dosificacion_numfact) ? "si dosificacion_numfact":"no dosificacion_numfact");
        // var_dump(isset($nit) ? "si nit":"no nit");
        // var_dump(isset($fecha_trans) ? "si fecha_trans":"no fecha_trans");
        // var_dump(isset($monto) ? "si monto":"no monto");

        //include 'ControlCode.php';

        $code = $this->controlcode->generate(
                                                $dosificacion_autorizacion,//Numero de autorizacion
                                                $dosificacion_numfact,//Numero de factura
                                                $nit,//Número de Identificación Tributaria o Carnet de Identidad
                                                str_replace('-','',$fecha_trans),//fecha de transaccion de la forma AAAAMMDD
                                                $monto,//Monto de la transacción
                                                $dosificacion_llave//Llave de dosificación
                                            );        
         return $code;
    }
    // Borrar
    function sumar_2segundos($factura_fecha_hora){
        $fechaAuxiliar = strtotime( "+10 seconds" ,strtotime($factura_fecha_hora));  
        $factura_fecha_hora_mod = date('Y-m-d\TH:i:s.v' , $fechaAuxiliar );
        return $factura_fecha_hora_mod;
    }
    // Borrar
    // 
    // borrar llamada a la funcion sumar_2segundos() en la linea 725 y descomentar la linea 724
    
    function registrarventa() // registra la venta y genera la factura
    {
        if($this->acceso(12)){
        //**************** inicio contenido ***************   
            //$factura_fecha_hora = '2022-07-03 13:17:10.000';//borrar
            //$factura_fecha_hora = (new DateTime())->format('Y-m-d\TH:i:s.v');
            //for($numero = 1;$numero <= 2;$numero++){ //borrar el for, mantener su contenido
                $data['sistema'] = $this->sistema;
                $usuario_id = $this->session_data['usuario_id'];
                
                $porcentaje = 0;
                // $factura_id = 0;
                
                $tipo_transaccion = $this->input->post('tipo_transaccion'); // recuperamos la consulta sql enviada mediante JS
                $cuotas = $this->input->post('cuotas'); // recuperamos la consulta sql enviada mediante JS
                $cuota_inicial = $this->input->post('cuota_inicial'); // recuperamos la consulta sql enviada mediante JS
                $venta_subtotal = $this->input->post('venta_subtotal'); // recuperamos la consulta sql enviada mediante JS
                $venta_total = $this->input->post('venta_total'); // recuperamos la consulta sql enviada mediante JS
                $credito_interes = $this->input->post('credito_interes'); // interes por ventas
                $pedido_id = $this->input->post('pedido_id'); // interes por ventas
                $numero_doc_identidad = $this->input->post('nit'); // nit del cliente
                $razon = $this->input->post('razon'); // nit del cliente
                $fecha_venta  = $this->input->post('venta_fecha'); // fecha de la venta
                $hora_venta = $this->input->post('venta_hora'); // hora de la venta
                $venta_descuento = $this->input->post('venta_descuento'); // descuento de la venta
                $venta_descuentoparcial = $this->input->post('venta_descuentoparcial'); // descuento de la venta
                $usuarioprev_id = $this->input->post('usuarioprev_id'); // descuento de la venta
                $orden_id = $this->input->post('orden_id'); // Orden de trabajo        
                $venta_efectivo = $this->input->post('venta_efectivo'); // efectivo cancelado
                $venta_cambio = $this->input->post('venta_cambio'); // Cambio devuelto  
                $cuota_fecha_i = $fecha_venta == '' ? date('Y-m-d') : $fecha_venta;
                $facturado = $this->input->post('facturado'); // si la venta es facturada
                $tipo_doc_identidad = $this->input->post('tipo_doc_identidad');
                $codigo_excepcion = $this->input->post('codigo_excepcion');
                $venta_detalletransaccion = $this->input->post('venta_detalletransaccion');
                $venta_giftcard = $this->input->post('venta_giftcard');
                $venta_ice = $this->input->post('venta_ice');
                $forma_id = $this->input->post('forma_id');
                $factura_complementoci = $this->input->post('factura_complementoci');
                $basededatos = $this->input->post('select_almacen'); //Selecciona la base de datos del almacen
                
                $fecha_cafc = $this->input->post('fecha_cafc');
                $hora_cafc = $this->input->post('hora_cafc');
                $numfact_cafc = $this->input->post('numfact_cafc');
                $codigo_cafc = $this->input->post('codigo_cafc');
                $registroeventos_codigo = $this->input->post('registroeventos_codigo');
                $modalidad    = $this->input->post('dosificacion_modalidad');
                $parametro_tipoemision    = $this->input->post('parametro_tipoemision');
                $venta_glosa    = $this->input->post('venta_glosa');
                $cliente_id    = $this->input->post('cliente_id');
                $factura_glosa    = $venta_glosa;
                
                //  DATOS  ADICIONALES FACTURA
                //********************************************************
                
                //$datos_placa    = $this->input->post('datos_placa');
                //$datos_embase    = $this->input->post('datos_embase');
                //$datos_codigopais    = $this->input->post('datos_codigopais');
                //$datos_autorizacionsc    = $this->input->post('datos_autorizacionsc');
                
                //********************************************************
                
                
                
                
                
                $dosificacion = $this->Dosificacion_model->get_all_dosificacion();
                $nombre_archivo =  $dosificacion[0]["dosificacion_documentosector"];
               
                if($dosificacion[0]["docsec_codigoclasificador"] == 23){
                    //$cliente_nombre = "'S/N'";
                    $razon = "S/N";
                    $tipo_doc_identidad = 5;
                    $numero_doc_identidad = 0;
                }
                
                //echo "modalidad: ".$parametro_tipoemision." * codigo excepcion: ".$codigo_excepcion;
                //Modificar la excepcion en caso de ser fuera de linea
                
                if($parametro_tipoemision == 2){ //1 en liena * 2 fuera de liena   
                    
                    if($tipo_doc_identidad == 5){ //5 si es NIT
                        $codigo_excepcion = 1;
                    }
                    else{
                        $codigo_excepcion = 0; 
                    }
                }
                
                
                //******** ACTUALIZAR LA TABLA detalle_Venta_aux
                
                $sql = "update detalle_venta_aux set
                        detalleven_descuento = ((detalleven_total - (detalleven_descuentoparcial * detalleven_cantidad))/".$venta_subtotal." * ".$venta_descuento.")/detalleven_cantidad
                        where usuario_id = ".$usuario_id;               
                $this->Venta_model->ejecutar($sql);// ejecutamos la consulta para registrar la venta y recuperamos venta_id
                
                
                //******** REGISTRA LA TABLA VENTA
                $cad = $this->input->post('cad'); // recuperamos la consulta sql enviada mediante JS para el insert en la venta
                $sql = "insert into venta(forma_id,tipotrans_id,usuario_id,cliente_id,moneda_id,".
                       "estado_id,venta_fecha,venta_hora,venta_subtotal,venta_descuentoparcial,venta_descuento,venta_total,".
                       "venta_efectivo,venta_cambio,venta_glosa,venta_comision,venta_tipocambio,detalleserv_id,".
                       "venta_tipodoc, tiposerv_id, entrega_id,venta_numeromesa, venta_numeroventa,usuarioprev_id,pedido_id, orden_id, entrega_estadoid,banco_id,".
                       "venta_ice, venta_giftcard, venta_detalletransaccion ) value(".$cad.")";
                $venta_id = $this->Venta_model->ejecutar($sql);// ejecutamos la consulta para registrar la venta y recuperamos venta_id
                
                    
                $sql =  "insert into detalle_venta
                (producto_id,
                  venta_id,
                  moneda_id,
                  detalleven_codigo,
                  detalleven_cantidad,
                  detalleven_unidad,
                  detalleven_costo,
                  detalleven_precio,
                  detalleven_subtotal,
                  detalleven_descuentoparcial,
                  detalleven_descuento,
                  detalleven_total,
                  detalleven_caracteristicas,
                  detalleven_preferencia,
                  detalleven_comision,
                  detalleven_tipocambio,
                  detalleven_envase,
                  detalleven_nombreenvase,
                  detalleven_costoenvase,
                  detalleven_precioenvase,
                  detalleven_cantidadenvase,
                  detalleven_garantiaenvase,
                  detalleven_devueltoenvase,
                  detalleven_fechadevolucion,
                  detalleven_horadevolucion,
                  detalleven_montodevolucion,
                  detalleven_prestamoenvase,
                  detalleven_fechavenc,
                  usuario_id,
                  factura_id,
                  clasificador_id,
                  detalleven_unidadfactor,
                  preferencia_id,
                  detalleven_tc
                )
        
                (SELECT 
                  producto_id,
                  ".$venta_id." as venta_id,
                  moneda_id,
                  detalleven_codigo,
                  detalleven_cantidad,
                  detalleven_unidad,
                  detalleven_costo,
                  detalleven_precio,
                  detalleven_subtotal,
                  detalleven_descuentoparcial,
                  detalleven_descuento,
                  /*detalleven_subtotal - ((detalleven_descuentoparcial + detalleven_subtotal)* detalleven_cantidad),*/
                  /*detalleven_subtotal - (detalleven_descuentoparcial * detalleven_cantidad),*/
                  detalleven_total,
                  detalleven_caracteristicas,
                  detalleven_preferencia,
                  detalleven_comision,
                  detalleven_tipocambio,
                    detalleven_envase,
                    detalleven_nombreenvase,
                    detalleven_costoenvase,
                    detalleven_precioenvase,
                    detalleven_cantidadenvase,
                    detalleven_garantiaenvase,
                    detalleven_devueltoenvase,
                    detalleven_fechadevolucion,
                    detalleven_horadevolucion,
                    detalleven_montodevolucion,
                    detalleven_prestamoenvase,
                    detalleven_fechavenc,
                    usuario_id,
                    0 as factura_id,
                    clasificador_id,
                    detalleven_unidadfactor,
                    preferencia_id,
                    detalleven_tc
                    
                FROM
                  detalle_venta_aux
                WHERE 
                  usuario_id=".$usuario_id.")";
                
                //$sqldetalle = $sql;
                //echo $sql;
                $this->Venta_model->ejecutar($sql);// cargar los productos del detalle_aux al detalle_venta
                
                
                //************* reducir inventario
                
                $this->Inventario_model->reducir_inventario_aux($usuario_id);
                
          
                if($tipo_transaccion == 2){ //Si la transaccion es a credito
                
                    //$credito_id =  
                    $estado_id =  8; //8 pendiente 9 cancelado
                    $compra_id =  0;
                    $venta_id =  $venta_id;
                    $credito_monto =  $venta_total - $cuota_inicial;
                    $credito_cuotainicial =  $cuota_inicial;
                    $credito_interesproc =  $credito_interes;
                    // $credito_interesmonto =  $venta_total * $venta_interes; //revisar
                    $credito_interesmonto =  $venta_total * 0; //revisar
                    $credito_numpagos =  $cuotas;
                    $credito_fechalimite =  "date_add(date(now()), INTERVAL +1 WEEK)";
                    // $credito_fecha = date('Y-m-d');
                    $credito_fecha = $fecha_venta;
                    // $time = time();
                    $credito_hora =  date("H:i:s");
                    $credito_tipo = 1; // 1- ventas 2 - compras
                 
                    $cuotas       = $this->input->post('cuotas');
                    $interes       = $this->input->post('interes');
                    $modalidad    = $this->input->post('modalidad');
                    $dia_pago     = $this->input->post('dia_pago');
                    $fecha_inicio = $this->input->post('fecha_inicio');
                    $numcuota = $cuotas; //numero de cuotas
                    
                    $intervalo = $modalidad == "MENSUAL" ? 'month':'week';
                    // if ($modalidad == "MENSUAL") $intervalo = 'month'; //si los pagos son mensuales
                    // else $intervalo = 'week'; //si los pagos son semanales
                    
                        // $cuota_numcuota = 1;
                    $cuota_fechalimite = date('Y-m-d', strtotime("$credito_fecha +$numcuota $intervalo"));
                        // for ($i=1; $i <= $numcuota; $i++) { // ciclo para llenar las cuotas
                        //     $cuota_numcuota = $i;
                            
                        //     $cuota_fechalimitex = (time() + ($intervalo * $i * 24 * 60 * 60 ));
                            // if ($modalidad == "MENSUAL") 
                            //     $cuota_fechalimite = date('Y-m-'.$dia_pago, $cuota_fechalimitex);
                            // else 
                            //     $cuota_fechalimite = date('Y-m-d', $cuota_fechalimitex); 
        
                        // }
                    $credito_fechalimite = $cuota_fechalimite;
                    $metodo_frances = $this->input->post('metodo_frances');
                    $metodo = "";
                    if($metodo_frances == "true"){
                        $metodo = "FRANCES";
                    }
                    $sql = "insert  into credito(estado_id,compra_id,venta_id,credito_monto,credito_cuotainicial,credito_interesproc,credito_interesmonto,credito_numpagos,credito_fechalimite,credito_fecha,credito_hora,credito_tipo, credito_metodo) value(".
                            $estado_id.",".$compra_id.",".$venta_id.",".$credito_monto.",".$credito_cuotainicial.",".$credito_interesproc.",".$credito_interesmonto.",".$credito_numpagos.",'".$credito_fechalimite."','".$credito_fecha."','".$credito_hora."',".$credito_tipo.", '".$metodo."')";
                    $credito_id = $this->Venta_model->ejecutar($sql);// cargar los productos del detalle_aux al detalle_venta
        
                    
                    $estado_id =  8; //8 pendiente 9 cancelado
                    $cuota_numcuota = 1;
                    $cuota_capital = $venta_total - $cuota_inicial;
                    $cuota_interes = ($venta_total - $cuota_inicial)*($credito_interes/100);
                    $cuota_moradias = 0;
                    $cuota_multa = 0;
                    $cuota_subtotal =  $venta_total - $cuota_inicial;
                    $cuota_descuento = 0;
                    $cuota_total = $venta_total - $cuota_inicial+$cuota_interes;
                    
                    $cuota_cancelado = 0;
                    $cuota_fecha = "'1900-01-01'";
                    $cuota_hora = "'00:00'";
                    $cuota_numercibo =  0;
                    $cuota_saldo = $venta_total - $cuota_inicial;
                    $cuota_glosa = "''";
                    $cuota_saldocredito = $venta_total - $cuota_inicial;
                         
                    $dias_mora = 0;
                    $multa = 0;
                    $descuento = 0;
                    $cancelado = 0;
                    $credito_monto = $venta_total - $cuota_inicial;
                    
                    $patron = ($numcuota*0.5) + 0.5;
                    $cuota_capital = ($credito_monto)/$numcuota;   // bien         
                    $fijo = $patron * $credito_monto * ($credito_interes/100/$numcuota);
                    $cuota_subtotal = $fijo + $cuota_capital + $dias_mora + $multa;
                    $total = $cuota_subtotal - $descuento;
                    $saldo_deudor = $credito_monto;
                    
                    $siguiente= 0;
                    // $cuota_fechalimite = $fecha_inicio;
                   
                   // $fecha_inicio = date('YYYY', $fecha_inicio)."-".date('MM', $fecha_inicio)."-".$dia_pago;
                    
                    // $cuota_fechalimite = $fecha_inicio;
                    $cuota_fecha_i = $fecha_inicio;
                    $anio = date("Y",strtotime($cuota_fecha_i));
                    $month = date("m",strtotime($cuota_fecha_i));
                        
                    $cuota_fecha_i = "$anio-$month-$dia_pago";
                    
                    if($metodo_frances == "true"){
                        
                        $Co = $credito_monto;
                        $i  = $credito_interes;
                        $n  = $cuotas;
                        $Ci = $Co;
                        $Ii = 0;
                        $Ai = 0;
                        //$a = $Co*($i/(1-(1+$i) ** (-$n)));
                        $a = $Co*($i/(1-(pow((1+$i),-$n))));
                        
                        for($k = 1; $k <= $cuotas; $k++){
                            $cuota_numcuota = $k;
                            
                            $cuota_fechalimitex = date('Y-m-d', strtotime("$cuota_fecha_i +$k $intervalo"));
                            $cuota_fechalimite = $cuota_fechalimitex;
                            
                            $Ii = $Ci*$i;
                            $Ai = $a-$Ii;
                            $cuota_subtotal = $Ai + $Ii + $dias_mora + $multa;
                            $total = $cuota_subtotal - $descuento;
                            $params = array(
                                'credito_id' => $credito_id,
                                'usuario_id' => $usuario_id,
                                'estado_id' => $estado_id,
                                'cuota_numcuota' => $cuota_numcuota,
                                'cuota_capital' => $Ai,
                                'cuota_interes' => $Ii,
                                'cuota_moradias' => $dias_mora,
                                'cuota_multa' => $multa,
                                'cuota_subtotal' => $cuota_subtotal,
                                'cuota_descuento' => $descuento,
                                'cuota_total' => $total,
                                'cuota_fechalimite' => $cuota_fechalimite,
                                'cuota_cancelado' => $cancelado,
                                'cuota_saldo' => $Ci,
                            );
                            $this->load->model('Cuotum_model');
                            $cuotum_id = $this->Cuotum_model->add_cuotum($params);
                            $Ci = $Ci-$Ai;
                        }
                    }else{
                        for ($j=1; $j <= $numcuota; $j++) { // ciclo para llenar las cuotas
                            $cuota_numcuota = $j;
                            
                            // $cuota_fechalimitex = (time() + ($jntervalo * $j * 24 * 60 * 60 ));
                            $cuota_fechalimitex = date('Y-m-d', strtotime("$cuota_fecha_i +$j $intervalo"));
                            
                            $cuota_fechalimite = $cuota_fechalimitex;
                            
                            $cuota ="insert into cuota (credito_id,usuario_id,estado_id,cuota_numcuota,cuota_capital,cuota_interes,cuota_moradias,cuota_multa,cuota_descuento,cuota_cancelado,cuota_total,cuota_subtotal,cuota_fechalimite,cuota_saldo) VALUES (".
                                    $credito_id.",".$usuario_id.",".$estado_id.",".$cuota_numcuota.",".$cuota_capital.",".$fijo.",".
                                    $dias_mora.",".$multa.",".$descuento.",".$cancelado.",".$total.",".$cuota_subtotal.",'".$cuota_fechalimite."',".$saldo_deudor.")";
                          
                            $this->Venta_model->ejecutar($cuota);
        
        //                    $saldo_deudor = $cuota_total - $cuota_capital;
        //                    $cuota_total = $saldo_deudor;
                            $saldo_deudor = $saldo_deudor - $cuota_capital;
                            //$cuota_total = $saldo_deudor;
                        }
                    }
                    
                }
                    
                
                if($pedido_id > 0)
                {
                    $sql = "update pedido set estado_id = 13  where pedido_id = ".$pedido_id;
                    $this->Venta_model->ejecutar($sql);
                }
                
//************************************************************************************
//          TRASPASOS
//************************************************************************************

                if($tipo_transaccion==4){
                 
                    $estado_id = 36; //estado pendiente
                    $tipotrans_id = $tipo_transaccion;
                    //$usuario_id = $usuario_id;
                    $moneda_id = 1;
                    $proveedor_id = 1; //Por defecto debe ser el 
                    //$forma_id
                    $compra_fecha = "date(now())";
                    $compra_hora = "time(now())";
                    $compra_subtotal = $venta_subtotal;
                    $compra_descuento = $venta_descuentoparcial;
                    $compra_descglobal = $venta_descuento;
                    $compra_total = $venta_subtotal;
                    $compra_totalfinal = $venta_total;
                    $compra_efectivo = $venta_total;
                    $compra_cambio = 0;
                    $compra_glosa = "''";
                    $compra_tipocambio = 1;
                    $compra_numdoc = $venta_id;
                    $documento_respaldo_id = "1";
                    $compra_caja = 0;
                    $compra_codcontrol = "''";
                    $banco_id = 0;
                    
                    $sql = "insert into compra(estado_id, tipotrans_id, usuario_id, moneda_id, proveedor_id, forma_id, compra_fecha, compra_hora,"
                            . " compra_subtotal, compra_descuento, compra_descglobal, compra_total, compra_totalfinal, compra_efectivo, "
                            . "compra_cambio, compra_glosa, compra_tipocambio,compra_numdoc, documento_respaldo_id, compra_caja, compra_codcontrol, banco_id) value(".
                           $estado_id.",".$tipotrans_id.",".$usuario_id.",".$moneda_id.",".$proveedor_id.",".$forma_id.",".
                           $compra_fecha.",".$compra_hora.",".$compra_subtotal.",".$compra_descuento.",".$compra_descglobal.",".
                           $compra_total.",".$compra_totalfinal.",".$compra_efectivo.",".$compra_cambio.",".$compra_glosa.",".
                           $compra_tipocambio.",".$compra_numdoc.",".$documento_respaldo_id.",".$compra_caja.",".
                           $compra_codcontrol.",".$banco_id.")";
                    
                    $compra_id =  $this->Venta_model->ejecutar_base($sql,$basededatos);
                    //echo "compra_id: ".$compra_id;
                    
                    $this->traspaso($compra_id, $basededatos);
                    
                }
                
//************************************************************************************                
                
                        
                
                if($facturado=="true"){//si la venta es facturada
   
                    
                    $dosificacion = $this->Dosificacion_model->get_dosificacion_activa();
                    // PARA NUEVO SISTEMA DE FACTURACION
                    //$parametro = $this->Parametro_model->get_parametros(); replazado por $parametros, variable global
                    
                    $tamanio_hoja = 2;                    
                    if($this->parametros['parametro_tipoimpresora'] == "FACTURADORA"){
                        $tamanio_hoja = 1;
                    }
                    // PARA NUEVO SISTEMA DE FACTURACION
                        
                        $estado_id = 1; 
                        
                        $factura_fechaventa    = $fecha_venta;
                        $factura_fecha         = "date(now())";
                        $factura_hora          =  $hora_venta; //"time(now())";
                        $factura_subtotal = $venta_subtotal;
                        $factura_nit           = $numero_doc_identidad;
                        $factura_razonsocial   = $razon;
                        $factura_ice           = 0;
                        $factura_exento        = 0;
                        $factura_descuentoparcial     = $venta_descuentoparcial;
                        $factura_descuento     = $venta_descuento;
                        $factura_total         = $venta_total;
                        $factura_numero        = $dosificacion[0]['dosificacion_numfact']+1;
                        $factura_autorizacion  = $dosificacion[0]['dosificacion_autorizacion'];
                        $factura_llave         = $dosificacion[0]['dosificacion_llave'];
                        $factura_fechalimite   = $dosificacion[0]['dosificacion_fechalimite'];
                        
                        if ($this->parametros["parametro_tiposistema"]==1)
                            $factura_codigocontrol = $this->codigo_control($factura_llave, $factura_autorizacion, $factura_numero, $numero_doc_identidad,$factura_fechaventa, $factura_total);
                        else
                            $factura_codigocontrol = "-"; 
                                
                        $factura_leyenda1      = $dosificacion[0]['dosificacion_leyenda1'];
                        $factura_leyenda2      = $dosificacion[0]['dosificacion_leyenda2'];
                        $factura_leyenda3      = $dosificacion[0]['dosificacion_leyenda3'];
                        $factura_leyenda4      = $dosificacion[0]['dosificacion_leyenda4'];
                        $factura_leyenda5      = $dosificacion[0]['dosificacion_leyenda5'];
                        $factura_nitemisor     = $dosificacion[0]['dosificacion_nitemisor'];
                        $factura_sucursal      = $dosificacion[0]['dosificacion_sucursal'];
                        $factura_sfc           = $dosificacion[0]['dosificacion_sfc'];
                        $factura_actividad     = $dosificacion[0]['dosificacion_actividad'];
                        $factura_enviada = 0;// 0 = falso
                        
                        if($this->parametros['parametro_tiposistema'] != 1){// Si es diferente a Sistema de facturacion computarizado(1)
                            // facturacion nueva
                            $puntoventa = $this->Usuario_model->get_punto_venta_usuario($usuario_id);
                            $this->load->model('PuntoVenta_model');
                            $punto_venta = $this->PuntoVenta_model->get_puntoventa($puntoventa['puntoventa_codigo']);
                            
                            $cliente_codigo = $this->Cliente_model->get_codigo_cliente($factura_nit, $factura_razonsocial);
                            $factura_tokendelegado   = $dosificacion[0]['dosificacion_tokendelegado'];
                            $factura_ambiente        = $dosificacion[0]['dosificacion_ambiente'];
                            $factura_cuis            = $punto_venta['cuis_codigo']; //$dosificacion[0]['dosificacion_cuis'];
                            $factura_cufd            = $punto_venta['cufd_codigo']; //$dosificacion[0]['dosificacion_cufd'];
                            $factura_modalidad       = $dosificacion[0]['dosificacion_modalidad'];
                            $factura_codsistema      = $dosificacion[0]['dosificacion_codsistema'];
                            $factura_puntoventa      = $punto_venta['puntoventa_codigo']; //$dosificacion[0]['dosificacion_puntoventa'];
                            $factura_sectoreconomico = $dosificacion[0]['dosificacion_sectoreconomico'];
                            $factura_ruta            = $dosificacion[0]['dosificacion_ruta'];
                            $factura_tamanio         = $tamanio_hoja;
                            $tipoDocumentoIdentidad  = $this->input->post('tipo_doc_identidad');
                            $documentoSector = $dosificacion[0]['docsec_codigoclasificador'];
                            
                            $factura_fecha_hora = (new DateTime())->format('Y-m-d\TH:i:s.v');
                            
                            $facturaCufdCodControl = $this->Factura_model->get_cudf_activo($punto_venta['cufd_codigo']); //$dosificacion[0]['dosificacion_cufd']);
                            $factura_codigocliente = $cliente_codigo;
        
    
                            if($registroeventos_codigo>0){ //Si es una factura transcrita con CAFC cambia los parametros para generar la factura
                                
                                $factura_fecha = "'".$fecha_cafc."'";
                                $factura_hora = $hora_cafc;
                                $factura_numero = $numfact_cafc;
                                $factura_cafc = $codigo_cafc;                                    
                                
                                $factura_fecha_hora = $fecha_cafc."T".$hora_cafc.":00.000";
                                
                                $tipo_emision = 2;   
                                $eventos = $this->Venta_model->consultar("select * from registro_eventos where registroeventos_codigo=".$registroeventos_codigo);
                                $cufd_codigocontrol =  $eventos[0]["registroeventos_codigocontrol"];
                                $factura_cufd = $eventos[0]["registroeventos_cufd"];
                                $elregistroeventos_id = $eventos[0]["registroeventos_id"];
                                
                            }else{
                                $factura_cafc = "";
                                $tipo_emision = $this->parametros['parametro_tipoemision'];
                                $cufd_codigocontrol =  trim($facturaCufdCodControl['cufd_codigocontrol']);
                                $elregistroeventos_id = 0;
                            }
                            
                            $cadFechahora = str_replace("-", "", $factura_fecha_hora);
                            $cadFechahora = str_replace("T", "", $cadFechahora);
                            $cadFechahora = str_replace(":", "", $cadFechahora);
                            $cadFechahora = str_replace(".", "", $cadFechahora);
                            $tipo_factura = $dosificacion[0]['tipofac_codigo'];
                            $tipo_documento_sector = $dosificacion[0]['docsec_codigoclasificador'];
                            $pos = $punto_venta['puntoventa_codigo']; //$dosificacion[0]['dosificacion_puntoventa'];

                                                        

                            // LLAMANDO AL HELPER
                            $factura_cuf = generarCuf(trim($factura_nitemisor),
                                                    trim($cadFechahora),
                                                    trim($factura_sucursal),
                                                    trim($factura_modalidad),
                                                    trim($tipo_emision),
                                                    trim($tipo_factura),
                                                    trim($tipo_documento_sector),
                                                    trim($factura_numero),
                                                    trim($pos),
                                                    trim($cufd_codigocontrol));
        
                            $fecha_hora = $factura_fecha_hora;
                            
                        }
                        // PARA NUEVA FACTURACION
                    
                    
                    //$factura_codigocontrol = $this->codigo_control($factura_llave, $factura_autorizacion, $factura_numero, $factura_nit, $factura_fechaventa, $factura_total);
                    
                    //********** INICIO ACTUALIZAR NUMERO DE FACTURA
//                        $sql = "update dosificacion set dosificacion_numfact = ".$factura_numero;
//                        $this->Venta_model->ejecutar($sql);
                        
                    //********** FIN INICIO ACTUALIZAR NUMERO DE FACTURA
                        
                        if($this->parametros['parametro_tiposistema'] == 1){
                            
                            // sistema de facturacion antiguo
                                $sql = "insert into factura(estado_id, venta_id, factura_fechaventa, 
                                factura_fecha, factura_hora, factura_subtotal, 
                                factura_exento, factura_descuentoparcial, factura_descuento, factura_total, 
                                factura_numero, factura_autorizacion, factura_llave, 
                                factura_fechalimite, factura_codigocontrol, factura_leyenda1, factura_leyenda2,
                                factura_nit, factura_razonsocial, factura_nitemisor,factura_sucursal,
                                factura_sfc, factura_actividad, usuario_id, tipotrans_id, 
                                factura_efectivo, factura_cambio,factura_enviada, factura_leyenda3, factura_leyenda4,factura_excepcion,
                                factura_ice, factura_giftcard, factura_detalletransaccion, forma_id, factura_complementoci, factura_glosa) value(".
                                $estado_id.",".$venta_id.",'".$factura_fechaventa."',".
                                $factura_fecha.",'".$factura_hora."',".$factura_subtotal.",".
                                $factura_exento.",".$factura_descuentoparcial.",".$factura_descuento.",".$factura_total.",".
                                $factura_numero.",".$factura_autorizacion.",'".$factura_llave."','".
                                $factura_fechalimite."','".$factura_codigocontrol."','".$factura_leyenda1."','".$factura_leyenda2."','".
                                $factura_nit."','".$factura_razonsocial."','".$factura_nitemisor."','".$factura_sucursal."','".
                                $factura_sfc."','".$factura_actividad."',".$usuario_id.",".$tipo_transaccion.",".
                                $venta_efectivo.",".$venta_cambio.",".$factura_enviada.",'".$factura_leyenda3."','".$factura_leyenda4."',".$codigo_excepcion.",".
                                $venta_ice.",".$venta_giftcard.",'".$venta_detalletransaccion."',".$forma_id.",'".$factura_complementoci."','".$factura_glosa."')";
                        
                                
                        }else{
                            
                                //Sistema de facturacion nuevo
                                $leyendas = $this->Venta_model->consultar("select * from leyenda order by leyenda_codigoactividad");
                                $valor = rand(0,7);
                                $factura_leyenda2 = $leyendas[$valor]["leyenda_descripcion"];
                        
                                $registroeventos_id = 0;
                                if ($tipo_emision == 2){ //1 en linea, 2 fuera de linea 3 masiva    
                                    $factura_leyenda3 =  $factura_leyenda5;
                                    //$factura_cafc = $dosificacion[0]["dosificacion_cafc"];                          
                                    $registroeventos_id = $this->registroeventos_id;
                                    if($elregistroeventos_id > 0){
                                        $registroeventos_id = $elregistroeventos_id;
                                    }

                                }
                                
 
                                
                            // nuevo sistema de facturacion                                
                            $sql = "insert into factura(estado_id, venta_id, factura_fechaventa, 
                                factura_fecha, factura_hora, factura_subtotal, 
                                factura_exento, factura_descuentoparcial, factura_descuento, factura_total, 
                                factura_numero, factura_autorizacion, factura_llave, 
                                factura_fechalimite, factura_codigocontrol, factura_leyenda1, factura_leyenda2,
                                factura_nit, factura_razonsocial, factura_nitemisor, factura_sucursal,
                                factura_sfc, factura_actividad, usuario_id, tipotrans_id,
                                factura_efectivo, factura_cambio, factura_tokendelegado,
                                factura_ambiente, factura_cuis, factura_cufd, factura_modalidad,
                                factura_codsistema, factura_puntoventa, factura_sectoreconomico,
                                factura_ruta, factura_tamanio,factura_cuf,factura_fechahora,cdi_codigoclasificador,
                                docsec_codigoclasificador, factura_codigocliente,factura_enviada, factura_leyenda3, factura_leyenda4,factura_excepcion, factura_tipoemision,
                                factura_ice, factura_giftcard, factura_detalletransaccion, forma_id, factura_complementoci, factura_cafc, registroeventos_id, factura_glosa) value(".
                                $estado_id.",".$venta_id.",'".$factura_fechaventa."',".
                                $factura_fecha.",'".$factura_hora."',".$factura_subtotal.",".
                                $factura_exento.",".$factura_descuentoparcial.",".$factura_descuento.",".$factura_total.",".
                                $factura_numero.",".$factura_autorizacion.",'".$factura_llave."','".
                                $factura_fechalimite."','".$factura_codigocontrol."','".$factura_leyenda1."','".$factura_leyenda2."','".
                                $factura_nit."','".$factura_razonsocial."','".$factura_nitemisor."','".$factura_sucursal."','".
                                $factura_sfc."','".$factura_actividad."',".$usuario_id.",".$tipo_transaccion.",".
                                $venta_efectivo.",".$venta_cambio.",'".$factura_tokendelegado."','".
                                $factura_ambiente."','".$factura_cuis."','".$factura_cufd."','".$factura_modalidad."','".
                                $factura_codsistema."','".$factura_puntoventa."','".$factura_sectoreconomico."','".
                                $factura_ruta."','".$factura_tamanio."','$factura_cuf','$fecha_hora',$tipoDocumentoIdentidad,
                                $documentoSector,'$factura_codigocliente','$factura_enviada'".",'".$factura_leyenda3."','".$factura_leyenda4."',".$codigo_excepcion.",".$tipo_emision.",".
                                $venta_ice.",".$venta_giftcard.",'".$venta_detalletransaccion."',".$forma_id.",'".$factura_complementoci."','".$factura_cafc."',".$registroeventos_id.",'".$factura_glosa."')";
                                    
                        }
                        $factura_id = $this->Venta_model->ejecutar($sql);
                    
                        $sql =  "insert into detalle_factura(
                        producto_id,
                        venta_id,
                        factura_id,
                        detallefact_codigo,
                        detallefact_unidad,
                        detallefact_cantidad,            
                        detallefact_descripcion,
                        detallefact_precio,
                        detallefact_subtotal,
                        detallefact_descuentoparcial,
                        detallefact_descuento,
                        detallefact_total,                
                        detallefact_preferencia,
                        detallefact_caracteristicas,
                        detallefact_unidadfactor)
        
                        (SELECT 
                            producto_id,
                            ".$venta_id." as venta_id,          
                            ".$factura_id." as factura_id,
                            detalleven_codigo,
                            detalleven_unidad,
                            detalleven_cantidad,
                            producto_nombre,          
                            detalleven_precio,
                            detalleven_subtotal,
                            detalleven_descuentoparcial,
                            detalleven_descuento,
                            detalleven_total,
                            detalleven_preferencia,
                            detalleven_caracteristicas,
                            detalleven_unidadfactor
        
                        FROM
                            detalle_venta_aux
                        WHERE 
                            usuario_id=".$usuario_id.")";
                        
                        $this->Factura_model->ejecutar($sql);   
                        
                        
                        //  REGISTRO DE DATO DE FACTURA
                        //*******************************************
                        if($dosificacion[0]['docsec_codigoclasificador'] == 12){
                            $params = array(
                                'datos_codigopais' => $this->input->post('datos_codigopais'),
                                'datos_autorizacionsc' => $this->input->post('datos_autorizacionsc'),
                                'datos_placa' => $this->input->post('datos_placa'),
                                'datos_embase' => $this->input->post('datos_embase'),
                                'cliente_id' => $cliente_id,
                            );

                            $datos_id = $this->Factura_datos_model->add_factura_datos($params);
                            
                            $params = array(
                                'datos_id' => $datos_id,
                            );
                            
                            $this->Factura_model->update_factura($factura_id, $params);
                            
                        }
                        //*******************************************
                        
                        
                        
                        if($this->parametros['parametro_tiposistema'] != 1){// para cualquiera que no sea Sistema de facturacion computarizado SFV (computarizado en linea o electronico)
                        // el parametro uno es para computarizada en linea ojo
                        $computarizada_enlinea = $dosificacion[0]["dosificacion_modalidad"];// 1 para electronica y 2 para computarizada
                        $docsec_codigoclasificador = $dosificacion[0]["docsec_codigoclasificador"]; // 1->compra venta/23->prevalorada.....
                        $factura = $this->Factura_model->get_factura_id($factura_id);
                        $detalle_factura = $this->Detalle_venta_model->get_detalle_factura_id($factura_id);
                        $empresa = $this->Empresa_model->get_empresa(1);
                        
                        $base_url = explode('/', base_url());
                        
                        //********************** GENERANDO ARCHIVO XML ****************
                        $dosificacion_documentosector = $dosificacion[0]["dosificacion_documentosector"];
                        $xml = generarfacturaCompra_ventaXML($computarizada_enlinea, $factura, $detalle_factura, $empresa, $docsec_codigoclasificador, $dosificacion_documentosector);
                        //********************** GENERANDO ARCHIVO XML ****************    

                        $directorio_factura = $_SERVER['DOCUMENT_ROOT'].'/'.$base_url[3].'/resources/xml/';
                        $directorio_esquema = $_SERVER['DOCUMENT_ROOT'].'/'.$base_url[3].'/resources/xml/esquemas/';
                        $xsd = $nombre_archivo.".xsd";
                        $valXSD = new ValidacionXSD();
                        
                        $es_valido = $valXSD->validar($directorio_factura.$nombre_archivo.$factura[0]['factura_id'].".xml",$directorio_esquema.$xsd);

                        if(!$es_valido){

                                print "ERROR: ".$valXSD->mostrarError()." ARCHIVO: ".$directorio_factura.$nombre_archivo.$factura[0]['factura_id'].".xml  XSD: ".$directorio_esquema.$xsd;
                                
                        }else{
                            
                                // COMPRESION XML EN GZIP
                                $datos = implode("", file($directorio_factura.$nombre_archivo.$factura[0]['factura_id'].".xml"));
                                $gzdata = gzencode($datos, 9);
                                $fp = fopen($directorio_factura.$nombre_archivo.$factura[0]['factura_id'].".xml.zip", "w");
                               
                                fwrite($fp, $gzdata);
                                fclose($fp); 

                                //Copiar el archivo .tar al directorio con id del usuario en curso

                                $path = $directorio_factura."envio".$usuario_id;
                                //echo $path;
                                if (!file_exists($path)) {
                                    mkdir($path, 0777, true);
                                }

                                
                            if($tipo_emision == 2){ // Si es emision fuera de linea
                                
                                    $p = new PharData($directorio_factura.$nombre_archivo.$factura[0]['factura_id'].'.tar');
                                    $p[$nombre_archivo.$factura[0]['factura_id'].'.xml'] = $datos;
                                    $p1 = $p->compress(Phar::GZ);

                                    $origen = $directorio_factura.$nombre_archivo.$factura[0]['factura_id'].'.tar';
                                    $destino = $directorio_factura.'envio'.$usuario_id.'/'.$nombre_archivo.$factura[0]['factura_id'].'.tar';
                                    copy($origen, $destino);
                                    
                                
                            }
                            //fin para borrar
                            
                            $handle = fopen($directorio_factura.$nombre_archivo.$factura[0]['factura_id'].".xml.zip", "rb");
                            $contents = fread($handle, filesize($directorio_factura.$nombre_archivo.$factura[0]['factura_id'].".xml.zip"));
                            fclose($handle);
                            $content = base64_encode($contents);
                            $b= unpack("C*",$contents);
        
                            $xml_comprimido = hash_file('sha256',$directorio_factura.$nombre_archivo.$factura[0]['factura_id'].".xml.zip");
                            $dosificacion = $this->Dosificacion_model->get_dosificacion(1);
                            //$wsdl = $dosificacion['dosificacion_factura'];
                            //$token = $dosificacion['dosificacion_tokendelegado'];
//                            $comunicacion = $this->verificar_comunicacion($token,$wsdl);
//                            
//                            if($comunicacion){
                            
                            if( $this->parametros["parametro_tipoemision"] == 1) //Si la emision de la factura es de tipo 1 ONLINE
                            {
  
                                $enviada = $this->mandarFactura($contents, $xml_comprimido);
                                //var_dump($enviada);
                                if($enviada->transaccion){ // Si la factura fue enviada                                    
                                    
                                    $params = array(
                                        'factura_codigodescripcion' => $enviada->codigoDescripcion,
                                        'factura_codigoestado'    => $enviada->codigoEstado,
                                        'factura_codigorecepcion' => $enviada->codigoRecepcion,
                                        'factura_transaccion'    => $enviada->transaccion,
                                        'factura_enviada' => true,//Factura enviada a impuestos, por defecto en false(No fue enviada)
                                    );
                                    $this->Factura_model->update_factura($factura_id, $params);
                                    
                                    //SI TODO SALE BIEN HASTA AQUI ACTUALIZA EN NUMERO DE FACTURA
                                    $sql = "update dosificacion set dosificacion_numfact = ".$factura_numero;
                                    $this->Venta_model->ejecutar($sql);
                                    $res  = array("mensajesList" => $enviada);
                                    echo json_encode($res);
                                    
                                }else{
                                    
                                    $cad = $enviada->mensajesList;
                                    //var_dump($enviada);
                                    //var_dump($cad);
                                    
                                    $mensajecadena = json_encode($enviada->mensajesList);
                                    
                                $codigo = "";
//                                

                                        if (is_array($cad)){

                                            for ($i=0; $i<sizeof($cad); $i++)
                                                $codigo = $codigo." ".$cad[0]->codigo;

                                        }else{
                                            $codigo = $cad->codigo;
                                        }    
                                        
                                        
                                            $params = array(
                                                'factura_codigodescripcion' => $codigo, //$cad->codigo,
                                                'factura_codigoestado' => "NO ENVIADA",//$cod->codigoEstado,
                                                'factura_mensajeslist' => $mensajecadena, //$enviada->mensajesList,
                                                'factura_transaccion'  => $enviada->transaccion,
                                                'factura_enviada' => false,//Factura enviada a impuestos, por defecto en false(No fue enviada)
                                            );

                                            $this->Factura_model->update_factura($factura_id, $params);

                                           echo json_encode($enviada);

                                
                                    
//                                            $params = array(
//                                                'factura_codigodescripcion' => $cad->codigo,
//                                                'factura_codigoestado' => "NO ENVIADA",//$cod->codigoEstado,
//                                                'factura_mensajeslist' => $mensajecadena, //$enviada->mensajesList,
//                                                'factura_transaccion'  => $enviada->transaccion,
//                                                'factura_enviada' => false,//Factura enviada a impuestos, por defecto en false(No fue enviada)
//                                            );
//
//                                            $this->Factura_model->update_factura($factura_id, $params);
//
//                                           echo json_encode($enviada);
                                    
                               
                                
                            }
                                /*
                                $sql = "update dosificacion set
                                        dosificacion_numfact = dosificacion_numfact - (select count(*) as cantidad from factura where factura_id = ".$factura_id." and factura_codigodescripcion <> 'VALIDADA')
                                        where dosificacion_id = 1";
                                echo $sql;
                                $this->Venta_model->ejecutar($sql);*/
                                
                            }else{ //Si la emision de la factura es de tipo 2 OFFLINE
                                //var_dump($registroeventos_codigo."QQWW");
                                //$registroeventos_codigo <= 0 no e s con CAFC e incrementa num. factura
                                if ($registroeventos_codigo <= 0){ 
                                    $sql = "update dosificacion set dosificacion_numfact = ".$factura_numero;
                                    $this->Venta_model->ejecutar($sql);
                                }
                                $res = array("mensajesList" => "No Enviado por  estar en offline");
                                    echo json_encode($res);
                            }
                            
                            $this->pdf_generar($factura_id);
                            
                            //if( $this->parametros["parametro_tipoemision"] == 1){ // solo cuando esta en linea manda correo
                            $email = $this->input->post('cliente_email'); 
                            if($email !=""){
                                $this->enviarcorreo($venta_id, $factura_id, $email,$nombre_archivo);
                            }
                                //}
                            // ******************************
                            //}
//                            }else{
//                                echo json_encode("false");
//                            }
                            
                        }
                        
                        $mandar_enuno = $this->input->post('mandar_enuno');
                        // si esta destiqueado ingresa aqui!; manda factura por factura!......
                        if($mandar_enuno == 0){
                            //Funcion en eventos con cafc
                            if ($registroeventos_codigo > 0){ //$registroeventos_codigo > 0 para que ingrese y envie los archivos con cafc
                                $sqlx = "update factura_contingencia set facturacontingencia_numero =  facturacontingencia_numero + 1";
                                $this->Venta_model->ejecutar($sqlx);

                                $codigo_recepcion = $this->registroEmisionPaquetes($factura_id,$registroeventos_codigo);

                                sleep(1);
                                if ($codigo_recepcion>0){
                                    $this->registroEmisionPaquetes_vacio($codigo_recepcion, $factura_id);
                                }
                            }
                        }elseif($mandar_enuno == 1){
                            //Funcion en eventos con cafc
                            if ($registroeventos_codigo > 0){ //$registroeventos_codigo > 0 para que ingrese y envie los archivos con cafc
                                $sqlx = "update factura_contingencia set facturacontingencia_numero =  facturacontingencia_numero + 1";
                                $this->Venta_model->ejecutar($sqlx);
                            }
                        }
                        // Fin Funcion en eventos con cafc
                        
                    }else{ // para tipo sistema == 1 Facturación Computarizada SFV
                        //********** INICIO ACTUALIZAR NUMERO DE FACTURA
                        $sql = "update dosificacion set dosificacion_numfact = ".$factura_numero;
                        $this->Venta_model->ejecutar($sql);
                        echo json_encode("");
                        //********** FIN INICIO ACTUALIZAR NUMERO DE FACTURA
                    }
                    // $this->ultimaventa(1);
                }
                
                if($orden_id > 0){
                    
                    $sql = "update orden_trabajo set estado_id = 18  where orden_id = ".$orden_id;
                    $this->Venta_model->ejecutar($sql);
                    $proceso_fechaproceso = "now()";
                    $contador = 1;
                    $detalle = "SELECT detalleorden_id from detalle_orden where orden_id=".$orden_id." ";
                    $detalle_orden = $this->db->query($detalle)->result_array();
                    
                    foreach ($detalle_orden as $det) {
                    
                        $prisql = "insert into proceso_orden(orden_id,estado,estado_id,usuario_id,proceso_fechaproceso,proceso_fechaterminado,detalleorden_id) value(".$orden_id.",17,26,0,".$proceso_fechaproceso.",".$proceso_fechaproceso.",".$det['detalleorden_id'].")";
                        $primid = $this->Venta_model->ejecutar($prisql); 

                        for ($contador = 18; $contador<=23; $contador++){


                            $estado = $contador;
                            $estado_id = 24;

                            $sql = "insert into proceso_orden(orden_id,estado,estado_id,usuario_id,detalleorden_id) value(".
                                    $orden_id.",".$estado.",".$estado_id.",0,".$det['detalleorden_id'].")";
                            $id = $this->Venta_model->ejecutar($sql);              

                        }  
                    }

                }   
                if($facturado=="false" && $tipo_transaccion == 2){
                    echo json_encode("");
                }
        }

        //**************** fin contenido ***************
        //}
               
        
    }
   
    
    
    function traspaso($compra_id,$basededatos){
        
        $data['sistema'] = $this->sistema;
        $usuario_id = $this->session_data['usuario_id'];
        $sql = "select * from detalle_venta_aux where usuario_id = ".$usuario_id;
        
        $detalle_compra = $this->Venta_model->consultar($sql);
        
        foreach($detalle_compra as $detalle){
            
            $params = array(
                
                'compra_id' => $compra_id,
                'producto_id' => $detalle['producto_id'],
                'detallecomp_codigo' => $detalle['detalleven_codigo'],
                'detallecomp_cantidad' => $detalle['detalleven_cantidad'],
                'detallecomp_unidad' => $detalle['detalleven_unidad'],
                'detallecomp_costo' => $detalle['detalleven_costo'],
                'detallecomp_precio' => $detalle['detalleven_precio'],
                'detallecomp_subtotal' => $detalle['detalleven_subtotal'],
                'detallecomp_descuento' => $detalle['detalleven_descuentoparcial'],
                'detallecomp_total' => $detalle['detalleven_total'],
                'detallecomp_descglobal' => $detalle['detalleven_descuento'],
                'detallecomp_fechavencimiento' => $detalle['detalleven_fechavenc'],
                'detallecomp_tipocambio' => 1,
                
            );
            
            $detalle_compra_id = $this->Venta_model->ejecutar_base_parametros($params,$basededatos);
            
        }
        
    }
    
    
 /* 
 */
    function buscarcodigo()  
    {   

            $cantidad = 1;        
            $codigo = $this->input->post('codigo');
            $producto = $this->Inventario_model->get_inventario_codigo($codigo);
            
            if (sizeof($producto)>0){ //si encontro el producto por el codigo de producto
                
                echo json_encode($producto);
           
            }
            else
            {
            
                $producto = $this->Inventario_model->get_inventario_codigo_factor($codigo);                
                echo json_encode($producto);
                
            }            

    }
    
    
 /* 
 */
    function buscar_placa()  
    {   

      
            $numeroplaca = $this->input->post('numeroplaca');
            $sql = "select * from cliente c, factura_datos f
                    WHERE c.cliente_id = f.cliente_id and f.datos_placa =  '{$numeroplaca}'";
            $placas = $this->Venta_model->consultar($sql);
            
            
            if (sizeof($placas)>0){ //si encontro el producto por el codigo de producto
                
                echo json_encode($placas);
           
            }
            else
            {            
                // = $this->Inventario_model->get_inventario_codigo_factor($codigo);                
                echo json_encode(false);
                
            }            

    }

    function buscar_serie(){  
        
        if($this->input->is_ajax_request()){
            $serie = $this->input->post('serie');
            $vendido = $this->Detalle_venta_model->get_venta_serie($serie);
            // var_dump($vendido);
            if(sizeof($vendido) == 0){//si se encontro una venta con el numero de serie
                $producto = $this->Inventario_model->get_inventario_serie($serie);
                if (sizeof($producto)<=0){
                    $producto = $this->Inventario_model->get_inventario_codigo_factor($producto['producto_codigo']);
                }
                echo json_encode($producto);
            }else{
                echo json_encode($vendido);
            }
        }
    }

    

    function generar_factura() //Genera factura depues de realizar una venta
    {  
        if($this->acceso(12)){
        //**************** inicio contenido ***************        

            //$dosificacion = $this->Dosificacion_model->get_dosificacion_activa();
            $dosificacion = $this->Dosificacion_model->get_dosificacion(1);

            $usuario_id = $this->session_data['usuario_id'];
            
            
            //********** parametros para la generacion de factura *************            
            
            $nit_factura = $this->input->post('nit');
            $razon_social = $this->input->post('razon_social');
            $fecha_venta = $this->input->post('fecha_venta');
            $detallefact_descripcion = $this->input->post('detalle_factura');
            $unidad = $this->input->post('detalle_unidad');
            $cantidad = $this->input->post('detalle_cantidad');
            $precio = $this->input->post('detalle_precio');            
            
            $llave_foranea = $this->input->post('llave_foranea');            
            $llave_valor = $this->input->post('llave_valor');            
            $codigo_excepcion = 0;            
            
            $tipotrans_id = 1;            
            
            if ($llave_foranea=="venta_id"){
                $venta_id = $llave_valor;
            }
            else{
                $venta_id = 0;
            }
            
            
            
//            $nit_factura = "5152377019";
//            $razon_social = "LOZANO SRL";
//            $fecha_venta = "2019-05-22";            
//            $detallefact_descripcion = "CUOTA POR CREDITO Nº 445";
//            $unidad = "CUOTA";
//            $cantidad = 1;
//            $precio = 385.90; 
            
            $monto_factura = $cantidad * $precio;
            
            
            
            //********** fin parametros para la generacion de factura *************

//            $nit = "51523773019";
//            $razon_social = "PEALEZ SRL";
//            $fecha_venta = "PEALEZ SRL";
//            $detalle_factura = "Pago por mercaderia";
//            $monto_factura = "Pago por mercaderia";
                        
            $numero_factura = $dosificacion["dosificacion_numfact"]+1;
            $estado_id = 1;
            
            //$venta_id = $this->input->post('venta_id');
            
            $factura_fechaventa = $fecha_venta;
            $factura_fecha = "date(now())";
            $factura_hora = "time(now())";
            $factura_subtotal = $monto_factura;
            $factura_ice = 0;
            $factura_exento = 0;
            $factura_descuentoparcial = 0;
            $factura_descuento = 0;
            $factura_total = $monto_factura;
            $factura_numero = $numero_factura;
            $factura_autorizacion = $dosificacion["dosificacion_autorizacion"];
            $factura_llave = $dosificacion["dosificacion_llave"];
            $factura_fechalimite = $dosificacion["dosificacion_fechalimite"];
            $factura_leyenda1 = $dosificacion["dosificacion_leyenda1"];
            $factura_leyenda2 = $dosificacion["dosificacion_leyenda2"];
            $factura_leyenda3 = $dosificacion["dosificacion_leyenda3"];
            $factura_leyenda4 = $dosificacion["dosificacion_leyenda4"];
            $factura_cafc = $dosificacion["dosificacion_cafc"];
            $factura_nit = $nit_factura;
            $factura_razonsocial = $razon_social;
            $factura_nitemisor = $dosificacion["dosificacion_nitemisor"];
            $factura_sucursal = $dosificacion["dosificacion_sucursal"];
            $factura_sfc = $dosificacion["dosificacion_sfc"];
            $factura_actividad = $dosificacion["dosificacion_actividad"];
            
            $factura_efectivo = $factura_total;
            $factura_cambio = 0;
          
            $factura_codigocontrol = $this->codigo_control($factura_llave, $factura_autorizacion, $factura_numero, $factura_nit, $factura_fechaventa, $factura_total);

            //********** INICIO ACTUALIZAR NUMERO DE FACTURA
            $sql = "update dosificacion set dosificacion_numfact = ".$factura_numero;
            $this->Venta_model->ejecutar($sql);
            //********** FIN ACTUALIZAR NUMERO DE FACTURA
            
            $sql = "insert into factura(estado_id, factura_fechaventa, 
                    factura_fecha, factura_hora, factura_subtotal, 
                    factura_ice, factura_exento, factura_descuentoparcial, factura_descuento, factura_total, 
                    factura_numero, factura_autorizacion, factura_llave, 
                    factura_fechalimite, factura_codigocontrol, factura_leyenda1, factura_leyenda2,
                    factura_nit, factura_razonsocial, factura_nitemisor, factura_sucursal, factura_sfc, factura_actividad, usuario_id,".$llave_foranea.",
                    factura_efectivo, factura_cambio, tipotrans_id, factura_leyenda3, factura_leyenda4, factura_excepcion) value(".
                    $estado_id.",'".$factura_fechaventa."',".
                    $factura_fecha.",".$factura_hora.",".$factura_subtotal.",".
                    $factura_ice.",".$factura_exento.",".$factura_descuentoparcial.",".$factura_descuento.",".$factura_total.",".
                    $factura_numero.",".$factura_autorizacion.",'".$factura_llave."','".
                    $factura_fechalimite."','".$factura_codigocontrol."','".$factura_leyenda1."','".$factura_leyenda2."','".
                    $factura_nit."','".$factura_razonsocial."','".$factura_nitemisor."','".
                    $factura_sucursal."','".$factura_sfc."','".$factura_actividad."',".$usuario_id.",".$llave_valor.",".
                    $factura_efectivo.",".$factura_cambio.",".$tipotrans_id.",'".$factura_leyenda3."','".$factura_leyenda4."',".$codigo_excepcion.")";
            $factura_id = $this->Venta_model->ejecutar($sql);


            $producto_id = 0;
            $detallefact_codigo = "-";
            $detallefact_cantidad = $cantidad;
            $detallefact_precio = $precio;
            $detallefact_subtotal =  $monto_factura;
            $detallefact_descuentoparcial = 0; //generacion de factura no tiene descuento parcial
            $detallefact_descuento = 0; //generacion de factura no tiene descuento general
            $detallefact_total = $monto_factura;
            $detallefact_preferencia =  "";
            $detallefact_caracteristicas = "";
            
            $sql =  "insert into detalle_factura(
             producto_id,
            venta_id,
            factura_id,
            detallefact_codigo,
            detallefact_unidad,
            detallefact_cantidad,            
            detallefact_descripcion,
            detallefact_precio,
            detallefact_subtotal,
            detallefact_descuentoparcial,
            detallefact_descuento,
            detallefact_total,                
            detallefact_preferencia,
            detallefact_caracteristicas)
            
            value(
            ".$producto_id.",
            ".$venta_id.",
            ".$factura_id.",
            '".$detallefact_codigo."',
            '".$unidad."',
            ".$detallefact_cantidad.",            
            '".$detallefact_descripcion."',
            ".$detallefact_precio.",
            ".$detallefact_subtotal.",
            ".$detallefact_descuentoparcial.",
            ".$detallefact_descuento.",
            ".$detallefact_total.",                
            '".$detallefact_preferencia."',
            '".$detallefact_caracteristicas."')";

            $this->Venta_model->ejecutar($sql);           
            
            
            if($venta_id>0){
                $sql = "update venta set venta_tipodoc = 1 where venta_id = ".$venta_id;
                $this->Venta_model->ejecutar($sql);
            }
            echo json_encode($factura_id);
        //**************** fin contenido ***************
        }
    }
        
    
    /*
     * Adding a new venta
     */
    function add()
    {   
        
        if($this->acceso(12)){
        //**************** inicio contenido ***************        
        $data['sistema'] = $this->sistema;
        if(isset($_POST) && count($_POST) > 0)     
        {   
            $params = array(
				'forma_id' => $this->input->post('forma_id'),
				'tipotrans_id' => $this->input->post('tipotrans_id'),
				'usuario_id' => $this->input->post('usuario_id'),
				'cliente_id' => $this->input->post('cliente_id'),
				'moneda_id' => $this->input->post('moneda_id'),
				'estado_id' => $this->input->post('estado_id'),
				'venta_fecha' => $this->input->post('venta_fecha'),
				'venta_hora' => $this->input->post('venta_hora'),
				'venta_subtotal' => $this->input->post('venta_subtotal'),
				'venta_descuento' => $this->input->post('venta_descuento'),
				'venta_total' => $this->input->post('venta_total'),
				'venta_efectivo' => $this->input->post('venta_efectivo'),
				'venta_cambio' => $this->input->post('venta_cambio'),
				'venta_glosa' => $this->input->post('venta_glosa'),
				'venta_comision' => $this->input->post('venta_comision'),
				'venta_tipocambio' => $this->input->post('venta_tipocambio'),
            );
            
            $venta_id = $this->Venta_model->add_venta($params);
            redirect('venta/index');
        }
        else
        {
            $this->load->model('Forma_pago_model');
            $data['all_forma_pago'] = $this->Forma_pago_model->get_all_forma_pago();

            $this->load->model('Tipo_transaccion_model');
            $data['all_tipo_transaccion'] = $this->Tipo_transaccion_model->get_all_tipo_transaccion();

            $this->load->model('Cliente_model');
            $data['all_cliente'] = $this->Cliente_model->get_all_cliente();
            $data['all_cliente'] = $this->Cliente_model->get_all_cliente();

            $this->load->model('Moneda_model');
            $data['all_moneda'] = $this->Moneda_model->get_all_moneda();

            $this->load->model('Estado_model');
            $data['all_estado'] = $this->Estado_model->get_all_estado();
            
            $data['_view'] = 'venta/add';
            $this->load->view('layouts/main',$data);
        }
      		
        //**************** fin contenido ***************
        }			      
        
    }  

    /*
     * Editing a venta
     */
function edit($venta_id){  
    
        if($this->acceso(19)){
            
        //**************** inicio contenido ***************      
        $data['sistema'] = $this->sistema;
        $usuario_id = $this->session_data['usuario_id'];
        // check if the venta exists before trying to edit it
        $venta = $this->Venta_model->get_venta($venta_id);
        
        $data['venta'] = $venta;//$this->Venta_model->get_venta($venta_id);
        $cliente_id = $venta["cliente_id"];
       
        //echo "Cliente: ".$cliente_id;
        if(isset($data['venta']['venta_id']))
        {
            if(isset($_POST) && count($_POST) > 0)     
            {
                $tipotrans_id = $this->input->post('tipotrans_id');
                $venta_fecha = implode("-", array_reverse(explode("/", $this->input->post('venta_fecha'))));
                $params = array(
                    'forma_id' => $this->input->post('forma_id'),
                    'tipotrans_id' => $this->input->post('tipotrans_id'),
                    'usuario_id' => $this->input->post('usuario_id'),
                    'cliente_id' => $this->input->post('cliente_id'),
                    'moneda_id' => $this->input->post('moneda_id'),
                    'estado_id' => $this->input->post('estado_id'),
                    'venta_fecha' => $venta_fecha,
                    'venta_hora' => $this->input->post('venta_hora'),
                    'venta_subtotal' => $this->input->post('venta_subtotal'),
                    'venta_descuento' => $this->input->post('venta_descuento'),
                    'venta_total' => $this->input->post('venta_total'),
                    'venta_efectivo' => $this->input->post('venta_efectivo'),
                    'venta_cambio' => $this->input->post('venta_cambio'),
                    'venta_glosa' => $this->input->post('venta_glosa'),
                    'venta_comision' => $this->input->post('venta_comision'),
                    'venta_tipocambio' => $this->input->post('venta_tipocambio'),
                );

                if ($tipotrans_id == 1)
                {
                    $credito = $this->Credito_model->get_credito_id($venta['venta_id']);
                    if (isset($credito)) {
                    $this->Venta_model->eliminar_credito($credito['credito_id']);
                    }
                    
                }
                
                if ($tipotrans_id == 2 || $tipotrans_id == 3)
                {

                        $fecha_inicio = $venta_fecha;
                        //$credito_id =  
                        $estado_id =  8; //8 pendiente 9 cancelado
                        $compra_id =  0;
                        //$venta_id =  $venta_id;
                        $credito_monto =  $venta['venta_total'];
                        $credito_cuotainicial =  0;
                        $credito_interesproc =  0;
                        $credito_interesmonto =  0; //revisar
                        $credito_numpagos =  1;
                        $credito_fechalimite =  "date_add(date(now()), INTERVAL +1 WEEK)";
                        $credito_fecha = $venta['venta_fecha'];
                        $time = time();
                        $credito_hora =  date("H:i:s", $time);
                        $credito_tipo = 1; // 1- ventas 2 - compras
                        $venta_total = $credito_monto;
                        $cuota_inicial = 0;
                        $credito_interes = 0;
//                        $cuotas       = $this->input->post('cuotas');
//                        $interes       = $this->input->post('interes');
                        $modalidad    = "MENSUAL";//$this->input->post('modalidad');
//                        $dia_pago     = $this->input->post('dia_pago');
//                        $fecha_inicio = $this->input->post('fecha_inicio');


                        $sql = "insert  into credito(estado_id,compra_id,venta_id,credito_monto,credito_cuotainicial,credito_interesproc,credito_interesmonto,credito_numpagos,credito_fechalimite,credito_fecha,credito_hora,credito_tipo) value(".
                                $estado_id.",".$compra_id.",".$venta_id.",".$credito_monto.",".$credito_cuotainicial.",".$credito_interesproc.",".
                                $credito_interesmonto.",".$credito_numpagos.",'".$credito_fechalimite."','".$credito_fecha."','".$credito_hora."',".$credito_tipo.")";
                        $credito_id = $this->Venta_model->ejecutar($sql);// cargar los productos del detalle_aux al detalle_venta


                        $estado_id =  8; //8 pendiente 9 cancelado
                        $cuota_numcuota = 1;
                        $cuota_capital = 0; //$venta_total - $cuota_inicial;
                        $cuota_interes = ($venta_total - $cuota_inicial)*($credito_interes/100);
                        $cuota_moradias = 0;
                        $cuota_multa = 0;
                        $cuota_subtotal =  $venta_total - $cuota_inicial;
                        $cuota_descuento = 0;
                        $cuota_total = $venta_total - $cuota_inicial+$cuota_interes;

                        $cuota_cancelado = 0;
                        $cuota_fecha = "'1900-01-01'";
                        $cuota_hora = "'00:00'";
                        $cuota_numercibo =  0;
                        $cuota_saldo = $venta_total - $cuota_inicial;
                        $cuota_glosa = "''";
                        $cuota_saldocredito = $venta_total - $cuota_inicial;

                        $credito_id = $this->db->insert_id();

                        $dias_mora = 0;
                        $multa = 0;
                        $descuento = 0;
                        $cancelado = 0;
                        $credito_monto = $venta_total - $cuota_inicial;
                        
                        $numcuota = 1;//$cuotas; //numero de cuotas
                        $patron = ($numcuota*0.5) + 0.5;
                        $cuota_capital = ($credito_monto)/$numcuota;   // bien         
                        $fijo = $patron * $credito_monto * ($credito_interes/100/$numcuota);
                        $cuota_subtotal = $fijo + $cuota_capital + $dias_mora + $multa;
                        $total = $cuota_subtotal - $descuento;
                        $saldo_deudor = $credito_monto;

                        $siguiente= 0;
                        $cuota_fechalimite = $fecha_inicio;

                        $cuota_fechalimite = $fecha_inicio;


                        if ($modalidad == "MENSUAL") $intervalo = 30; //si los pagos son mensuales
                        else $intervalo = 7; //si los pagos son semanales


                        for ($i=1; $i <= $numcuota; $i++) { // ciclo para llenar las cuotas
                            $cuota_numcuota = $i;

//                            $cuota_fechalimitex = (time() + ($intervalo * $i * 24 * 60 * 60 ));
//                            if ($modalidad == "MENSUAL") 
//                                $cuota_fechalimite = date('Y-m-'.$dia_pago, $cuota_fechalimitex);
//                            else 
//                                $cuota_fechalimite = date('Y-m-d', $cuota_fechalimitex); 
                            $cuota_fechalimite = $credito_fechalimite; 

                            $cuota ="insert into cuota (credito_id,usuario_id,estado_id,cuota_numcuota,cuota_capital,cuota_interes,cuota_moradias,cuota_multa,cuota_descuento,cuota_cancelado,cuota_total,cuota_subtotal,cuota_fechalimite,cuota_saldo) VALUES (".
                                    $credito_id.",".$usuario_id.",".$estado_id.",".$cuota_numcuota.",".$cuota_capital.",".$fijo.",".
                                    $dias_mora.",".$multa.",".$descuento.",".$cancelado.",".$total.",".$cuota_subtotal.",'".$cuota_fechalimite."',".$saldo_deudor.")";

                            $this->Venta_model->ejecutar($cuota);
                            $saldo_deudor = $saldo_deudor - $cuota_capital;
                        }
                    
                }//fin de tipotrans
                

                $this->Venta_model->update_venta($venta_id,$params);            
                redirect('venta/index');
            }
            else
            {
                $this->load->model('Forma_pago_model');
                $data['all_forma_pago'] = $this->Forma_pago_model->get_all_forma_pago();

                $this->load->model('Tipo_transaccion_model');
                $data['all_tipo_transaccion'] = $this->Tipo_transaccion_model->get_all_tipo_transaccion();

                $this->load->model('Cliente_model');
                $data['all_cliente'] = $this->Cliente_model->get_cliente_by_id($cliente_id);

                $this->load->model('Moneda_model');
                $data['all_moneda'] = $this->Moneda_model->get_all_moneda();

                $this->load->model('Usuario_model');
                $data['all_usuario'] = $this->Usuario_model->get_all_usuario();
                
                $this->load->model('Estado_model');
                $data['all_estado'] = $this->Estado_model->get_all_estado_activo_inactivo();

                $data['_view'] = 'venta/edit';
                $this->load->view('layouts/main',$data);
            }
        }
        else
            show_error('The venta you are trying to edit does not exist.');
            
        //**************** fin contenido ***************
        }
        			
    } 
    
    function buscar_venta()
    {   
        if($this->acceso(19)){
        //**************** inicio contenido ***************      
            $data['page_title'] = "Buscar venta";        
            $data['_view'] = 'venta/buscar_venta';
            $this->load->view('layouts/main',$data);
         
        }
        			
    } 
    
    /*
     * Deleting venta
     */
    
    function nota_venta($venta_id)
    {
        $data['sistema'] = $this->sistema;
        $data['venta'] = $this->Detalle_venta_model->get_venta($venta_id);
        $data['detalle_venta'] = $this->Detalle_venta_model->get_detalle_venta($venta_id);        
        $data['empresa'] = $this->Empresa_model->get_empresa(1);        
        $data['page_title'] = "Nota de venta";        
        
        $data['_view'] = 'venta/nota_venta';
        $this->load->view('layouts/main',$data);    
       
    }
    
    /*
     * Modulo paramodificar una venta
     */
    
    function modificar_venta($venta_id)
    {
        
        
        if($this->acceso(20)){
        //**************** inicio contenido ***************      

        $data['sistema'] = $this->sistema;   
        $data['rolusuario'] = $this->session_data['rol'];
        $usuario_id = $this->session_data['usuario_id'];
        $tipousuario_id = $this->session_data['tipousuario_id'];        
        
        // check if the venta exists before trying to edit it
        $venta = $this->Venta_model->get_venta($venta_id);
        
        $data['venta'] = $venta;//$this->Venta_model->get_venta($venta_id);
        $cliente_id = $venta["cliente_id"];       
        $data['page_title'] = "Modificar Venta";
        
        //$cliente = $this->Cliente_model->get_cliente_by_id($cliente_id);
        //$data['cliente'] = $cliente;
        $data['dosificacion'] = $this->Dosificacion_model->get_all_dosificacion();
//        $data['pedidos'] = $this->Pedido_model->get_pedidos_activos();
        $cliente = $this->Cliente_model->get_cliente_by_id($cliente_id);
        $data['cliente'] = $cliente;
        $data['zonas'] = $this->Categoria_clientezona_model->get_all_categoria_clientezona();
        $data['categoria_producto'] = $this->Venta_model->get_categoria_producto();
        $data['tipo_transaccion'] = $this->Tipo_transaccion_model->get_all_tipo();
        $data['forma_pago'] = $this->Forma_pago_model->get_all_forma();
        $data['tipo_cliente'] = $this->Tipo_cliente_model->get_all_tipo_cliente();
        $data['tipo_servicio'] = $this->Tipo_servicio_model->get_all_tipo_servicio();
        $data['parametro'] =  $this->parametros;//$this->Parametro_model->get_parametros();
        $data['moneda'] = $this->Moneda_model->get_moneda(2); //Obtener moneda extragera
        $data['usuario'] = $this->Usuario_model->get_all_usuario_activo();
        $data['preferencia'] = $this->Preferencia_model->get_producto_preferencia();
        $data['promociones'] = $this->Promocion_model->get_promociones();
        $data['mesas'] = $this->Mesa_model->get_all_mesa();
        $data['usuario_id'] = $usuario_id;
        $data['bancos'] = $this->Banco_model->getall_bancosact_asc();
        $data['docs_identidad'] = $this->Sincronizacion_model->getall_docs_ident();
        $data['tipousuario_id'] = $tipousuario_id;
        $data['eventos'] = $this->Venta_model->consultar("select * from registro_eventos where estado_id=1");
        $data['empresa_email'] = $this->empresa["empresa_email"];
        
        $user = $this->Venta_model->consultar("select * from usuario where usuario_id = ".$usuario_id);
        $data['puntoventa_codigo'] = $user[0]["puntoventa_codigo"];
        
        $data['eventos_significativos'] = $this->Eventos_significativos_model->get_all_codigos();
        
            
        //**************** inicio contenido ***************     
                
       
        $data['venta_id'] = $venta_id;
        $data['venta'] = $this->Detalle_venta_model->get_venta($venta_id);
        
        $detalle_venta = $this->Detalle_venta_model->cargar_detalle_venta($venta_id, $usuario_id);        
        $data['detalle_venta'] = $detalle_venta;        
        
        $data['empresa'] = $this->Empresa_model->get_empresa(1);        

        

        //**************** bitacora caja
        $cont = sizeof($detalle_venta);
        $prec_total = 0;
        
        foreach($detalle_venta as $d){
            $prec_total += $d['detalleven_precio'] * $d['detalleven_cantidad'];
        }
                
        $bitacoracaja_evento = "MODIFICAR VENTA Nº 00".$venta_id." CLIENTE:".$cliente[0]['cliente_nombre']."| PROD.: ".$cont." | PREC.TOT.: ".$prec_total;
        $bitacoracaja_tipo = 2;
        
        $sql = "insert into bitacora_caja(bitacoracaja_fecha, bitacoracaja_hora, bitacoracaja_evento, 
                usuario_id, bitacoracaja_montoreg, bitacoracaja_montocaja, bitacoracaja_tipo, caja_id) value(date(now()),time(now())".
                ",'".$bitacoracaja_evento."',".$usuario_id.",0,0,".$bitacoracaja_tipo.",".$this->caja_id.")";
        
        $this->Venta_model->ejecutar($sql);
        //****************** fin bitacora caja

        
        if($venta['tipotrans_id'] == 2){
            $data['credito'] = $this->Credito_model->get_credito_id($venta_id);
        }
    
        
        $data['_view'] = 'venta/modificar_venta';
        $this->load->view('layouts/main',$data);    
  
        //**************** fin contenido ***************
        }
               
        
    }
    
    function modificar_detalle()
    {
        if($this->acceso(12)){
            //**************** inicio contenido ***************
            $usuario_id = $this->session_data['usuario_id'];
            $data['sistema'] = $this->sistema;
            $venta_id = $this->input->post('venta_id');
            $cliente_id = $this->input->post('cliente_id');
            $forma_id = $this->input->post('forma_pago');
            $tipotrans_id = $this->input->post('tipo_transaccion');
            $elusuario_id = $this->input->post('usuario_id');
            $venta_fecha = $this->input->post('venta_fecha');
            $venta_subtotal = $this->input->post('venta_subtotal');
            $venta_descuento = $this->input->post('venta_descuento');
            //$venta_descuentoparcial = $this->input->post('venta_descuentoparcial'); // descuento de la venta
            $venta_total = $this->input->post('venta_total');
            //$venta_total = $venta_total - $venta_descuento;
            $venta_efectivo = $this->input->post('venta_efectivo');
            $venta_cambio = $this->input->post('venta_cambio');

            $modificar_credito = $this->input->post('modificar_credito');
            $credito_id = $this->input->post('credito_id');
            $cuotas = $this->input->post('cuotas');
            $cuota_inicial = $this->input->post('cuota_inicial');
            $credito_interes = $this->input->post('credito_interes');
            $modalidad = $this->input->post('modalidad');
            $dia_pago = $this->input->post('dia_pago');
            $fecha_inicio = $this->input->post('fecha_inicio');
            $metodo_frances = $this->input->post('metodo_frances');
            $banco_id = $this->input->post('banco_id');
            $venta_giftcard = $this->input->post('venta_giftcard');
            $venta_ice = $this->input->post('venta_ice');
            $venta_detalletransaccion = $this->input->post('venta_detalletransaccion');
            $venta_glosa = $this->input->post('venta_glosa');

            $porcentaje = 0;

            $sql = "update detalle_venta_aux set
                    detalleven_descuento = ((detalleven_total - (detalleven_descuentoparcial * detalleven_cantidad))/".$venta_subtotal." * ".$venta_descuento.")/detalleven_cantidad
                    where usuario_id = ".$usuario_id;                
            $this->Venta_model->ejecutar($sql);// ejecutamos la consulta para registrar la venta y recuperamos venta_id

            $sql = "delete from detalle_venta where venta_id = ".$venta_id;
            $this->Venta_model->ejecutar($sql);

            if(($venta_total+$venta_descuento)>0)
                $porcentaje = $venta_descuento / ($venta_total+$venta_descuento);
            else
                $porcentaje = 0;
         
            
            $sql =  "insert into detalle_venta
                (producto_id,
                  venta_id,
                  moneda_id,
                  detalleven_codigo,
                  detalleven_cantidad,
                  detalleven_unidad,
                  detalleven_costo,
                  detalleven_precio,
                  detalleven_subtotal,
                  detalleven_descuentoparcial,
                  detalleven_descuento,
                  detalleven_total,
                  detalleven_caracteristicas,
                  detalleven_preferencia,
                  detalleven_comision,
                  detalleven_tipocambio,
                  detalleven_envase,
                  detalleven_nombreenvase,
                  detalleven_costoenvase,
                  detalleven_precioenvase,
                  detalleven_cantidadenvase,
                  detalleven_garantiaenvase,
                  detalleven_devueltoenvase,
                  detalleven_fechadevolucion,
                  detalleven_horadevolucion,
                  detalleven_montodevolucion,
                  detalleven_prestamoenvase,
                  detalleven_fechavenc,
                  usuario_id,
                  factura_id,
                  clasificador_id,
                  detalleven_unidadfactor,
                  preferencia_id,
                  detalleven_tc
                )
        
                (SELECT 
                  producto_id,
                  ".$venta_id." as venta_id,
                  moneda_id,
                  detalleven_codigo,
                  detalleven_cantidad,
                  detalleven_unidad,
                  detalleven_costo,
                  detalleven_precio,
                  detalleven_subtotal,
                  detalleven_descuentoparcial,
                  detalleven_descuento,                  
                  detalleven_total,
                  detalleven_caracteristicas,
                  detalleven_preferencia,
                  detalleven_comision,
                  detalleven_tipocambio,
                    detalleven_envase,
                    detalleven_nombreenvase,
                    detalleven_costoenvase,
                    detalleven_precioenvase,
                    detalleven_cantidadenvase,
                    detalleven_garantiaenvase,
                    detalleven_devueltoenvase,
                    detalleven_fechadevolucion,
                    detalleven_horadevolucion,
                    detalleven_montodevolucion,
                    detalleven_prestamoenvase,
                    detalleven_fechavenc,
                    usuario_id,
                    0 as factura_id,
                    clasificador_id,
                    detalleven_unidadfactor,
                    preferencia_id,
                    detalleven_tc
                  
                FROM
                  detalle_venta_aux
                WHERE 
                  usuario_id=".$usuario_id.")";
            //echo $sql;
            $this->Venta_model->ejecutar($sql);
        
            $sql = "update venta set ".
                    "cliente_id = ".$cliente_id.
                    ",venta_fecha = '".$venta_fecha."'".
                    ",venta_subtotal = ".$venta_subtotal.
                    //",venta_descuentoparcial = ".$venta_descuentoparcial.
                    ",venta_descuento = ".$venta_descuento.
                    ",venta_total = ".($venta_total).
                    ",venta_efectivo = ".$venta_efectivo.
                    ",venta_glosa = ".$venta_glosa.
                    ",venta_cambio = ".$venta_cambio.
                    ",tipotrans_id = ".$tipotrans_id.                
                    ",forma_id = ".$forma_id.              
                    ",banco_id = '".$banco_id."'".
                    " where venta_id = ".$venta_id;
            //echo $sql;
            $this->Venta_model->ejecutar($sql);        

            //**************** bitacora caja ********************

            $bitacoracaja_fecha = "date(now())";
            $bitacoracaja_hora = "time(now())";
            $bitacoracaja_evento = "(select concat('FINALIZAR MODIFICACION EN VENTA Nº: 00','".$venta_id."','| CLIENTE ID: ','".$cliente_id."', '| CANT: ',count(*),'| NUEVO TOTAL: ',sum(detalleven_cantidad * detalleven_precio)) from detalle_venta_aux where usuario_id = ".$usuario_id.")";
            //$usuario_id = esta mas arriba;
            $bitacoracaja_montoreg = 0;
            $bitacoracaja_montocaja = 0;
            $bitacoracaja_tipo = 2; //2 operaciones sobre ventas


            $sql = "insert into bitacora_caja(bitacoracaja_fecha, bitacoracaja_hora, bitacoracaja_evento, 
                    usuario_id, bitacoracaja_montoreg, bitacoracaja_montocaja, bitacoracaja_tipo, caja_id) value(".
                    $bitacoracaja_fecha.",".$bitacoracaja_hora.",".$bitacoracaja_evento.",".
                    $usuario_id.",".$bitacoracaja_montoreg.",".$bitacoracaja_montocaja.",".$bitacoracaja_tipo.",".$this->caja_id.")";
            //echo $sql;
            $this->Venta_model->ejecutar($sql);
            //****************** fin bitacora caja *************** 

            $sql = "delete from detalle_venta_aux where usuario_id = ".$usuario_id;
            $this->Venta_model->ejecutar($sql);                
        
            if($tipotrans_id==2){ //si el tipo de transaccion es credito

                if($credito_id>0){ //si la venta a modificar es a credito!.
                    //echo $modificar_credito."kKKK";
                    if($modificar_credito == "true"){ //verificamos si se da la orden de modificar los valores del credito
                        //eliminar los datos del credito
                        $sql = "delete from cuota where credito_id=".$credito_id;
                        $this->Venta_model->ejecutar($sql);

                        //Generar credito
                        $sql = "delete from credito where venta_id=".$venta_id;
                        $this->Venta_model->ejecutar($sql);

                        //Generar detalle del credito
                        //$credito_id =  
                        $estado_id =  8; //8 pendiente 9 cancelado
                        $compra_id =  0;
                        $venta_id =  $venta_id;
                        $credito_monto =  $venta_total - $cuota_inicial;
                        $credito_cuotainicial =  $cuota_inicial;
                        $credito_interesproc =  $credito_interes;
                        $credito_interesmonto =  $venta_total * $venta_interes; //revisar
                        $credito_numpagos =  $cuotas;
                        $credito_fechalimite =  "date_add(date(now()), INTERVAL +1 WEEK)";
                        $credito_fecha = $venta_fecha;
                        // $time = time();
                        $credito_hora =  date("H:i:s");
                        $credito_tipo = 1; // 1- ventas 2 - compras

                        $cuotas       = $this->input->post('cuotas');
                        $interes       = $this->input->post('interes');
                        $modalidad    = $this->input->post('modalidad');
                        $dia_pago     = $this->input->post('dia_pago');
                        $fecha_inicio = $this->input->post('fecha_inicio');
                        $numcuota = $cuotas; //numero de cuotas

                        $intervalo = $modalidad == "MENSUAL" ? 'month': 'week'; 

                            $cuota_numcuota = 1;

                            $cuota_fechalimite = date('Y-m-d', strtotime("$credito_fecha +$numcuota $intervalo"));

                            $credito_fechalimite = $cuota_fechalimite;
                        $metodo_frances = $this->input->post('metodo_frances');
                        $metodo = "";
                        if($metodo_frances == "true"){
                            $metodo = "FRANCES";
                        }
                        $sql = "insert  into credito(estado_id,compra_id,venta_id,credito_monto,credito_cuotainicial,credito_interesproc,credito_interesmonto,credito_numpagos,credito_fechalimite,credito_fecha,credito_hora,credito_tipo, credito_metodo) value(
                                $estado_id,$compra_id,$venta_id,$credito_monto,$credito_cuotainicial,$credito_interesproc,$credito_interesmonto,$credito_numpagos,'$credito_fechalimite','$credito_fecha','$credito_hora',$credito_tipo, '$metodo')";
                        echo $sql;
                        $credito_id = $this->Venta_model->ejecutar($sql);// cargar los productos del detalle_aux al detalle_venta


                        $estado_id =  8; //8 pendiente 9 cancelado
                        $cuota_numcuota = 1;
                        $cuota_capital = $venta_total - $cuota_inicial;
                        $cuota_interes = ($venta_total - $cuota_inicial)*($credito_interes/100);
                        $cuota_moradias = 0;
                        $cuota_multa = 0;
                        $cuota_subtotal =  $venta_total - $cuota_inicial;
                        $cuota_descuento = 0;
                        $cuota_total = $venta_total - $cuota_inicial+$cuota_interes;

                        $cuota_cancelado = 0;
                        $cuota_fecha = "'1900-01-01'";
                        $cuota_hora = "'00:00'";
                        $cuota_numercibo =  0;
                        $cuota_saldo = $venta_total - $cuota_inicial;
                        $cuota_glosa = "''";
                        $cuota_saldocredito = $venta_total - $cuota_inicial;


                        $dias_mora = 0;
                        $multa = 0;
                        $descuento = 0;
                        $cancelado = 0;
                        $credito_monto = $venta_total - $cuota_inicial;

                        $patron = ($numcuota*0.5) + 0.5;
                        $cuota_capital = ($credito_monto)/$numcuota;   // bien         
                        $fijo = $patron * $credito_monto * ($credito_interes/100/$numcuota);
                        $cuota_subtotal = $fijo + $cuota_capital + $dias_mora + $multa;
                        $total = $cuota_subtotal - $descuento;
                        $saldo_deudor = $credito_monto;

                        $siguiente= 0;
                        $cuota_fechalimite = $fecha_inicio;

                       // $fecha_inicio = date('YYYY', $fecha_inicio)."-".date('MM', $fecha_inicio)."-".$dia_pago;

                        $cuota_fechalimite = $fecha_inicio;
                        $cuota_fecha_i = $fecha_inicio;
                        if($metodo_frances == "true"){
                            $Co = $credito_monto;
                            $i  = $credito_interes;
                            $n  = $cuotas;
                            $Ci = $Co;
                            $Ii = 0;
                            $Ai = 0;
                            //$a = $Co*($i/(1-(1+$i) ** (-$n)));
                            $a = $Co*($i/(1-(pow((1+$i),-$n))));
                            for($k = 1; $k <= $cuotas; $k++){
                                $cuota_numcuota = $k;

                                $cuota_fechalimitex = date('Y-m-d', strtotime("$cuota_fecha_i +$k $intervalo"));
                                $cuota_fechalimite = $cuota_fechalimitex;

                                $Ii = $Ci*$i;
                                $Ai = $a-$Ii;
                                $cuota_subtotal = $Ai + $Ii + $dias_mora + $multa;
                                $total = $cuota_subtotal - $descuento;
                                $params = array(
                                    'credito_id' => $credito_id,
                                    'usuario_id' => $usuario_id,
                                    'estado_id' => $estado_id,
                                    'cuota_numcuota' => $cuota_numcuota,
                                    'cuota_capital' => $Ai,
                                    'cuota_interes' => $Ii,
                                    'cuota_moradias' => $dias_mora,
                                    'cuota_multa' => $multa,
                                    'cuota_subtotal' => $cuota_subtotal,
                                    'cuota_descuento' => $descuento,
                                    'cuota_total' => $total,
                                    'cuota_fechalimite' => $cuota_fechalimite,
                                    'cuota_cancelado' => $cancelado,
                                    'cuota_saldo' => $Ci,
                                );
                                $this->load->model('Cuotum_model');
                                $cuotum_id = $this->Cuotum_model->add_cuotum($params);
                                $Ci = $Ci-$Ai;
                            }
                        }else{
                            for ($i=1; $i <= $numcuota; $i++) { // ciclo para llenar las cuotas
                                $cuota_numcuota = $i;
                                $cuota_fechalimite = date('Y-m-d', strtotime("$credito_fecha +$i $intervalo"));

                                $cuota ="insert into cuota (credito_id,usuario_id,estado_id,cuota_numcuota,cuota_capital,cuota_interes,cuota_moradias,cuota_multa,cuota_descuento,cuota_cancelado,cuota_total,cuota_subtotal,cuota_fechalimite,cuota_saldo) VALUES (".
                                        $credito_id.",".$usuario_id.",".$estado_id.",".$cuota_numcuota.",".$cuota_capital.",".$fijo.",".
                                        $dias_mora.",".$multa.",".$descuento.",".$cancelado.",".$total.",".$cuota_subtotal.",'".$cuota_fechalimite."',".$saldo_deudor.")";
                                $this->Venta_model->ejecutar($cuota);

            //                    $saldo_deudor = $cuota_total - $cuota_capital;
            //                    $cuota_total = $saldo_deudor;
                                $saldo_deudor = $saldo_deudor - $cuota_capital;
                                //$cuota_total = $saldo_deudor;
                            }
                        }

                    }
                }else{ //si no tenia credito; y la modificación es a CREDITO, se genera un nuevo credito para esa venta!.
                    //eliminar los datos del credito
                    $sql = "delete from cuota where credito_id=".$credito_id;
                    $this->Venta_model->ejecutar($sql);

                    //Generar credito
                    $sql = "delete from credito where venta_id=".$venta_id;
                    $this->Venta_model->ejecutar($sql);

                    //Generar detalle del credito
                    //$credito_id =  
                    $estado_id =  8; //8 pendiente 9 cancelado
                    $compra_id =  0;
                    $venta_id =  $venta_id;
                    $credito_monto =  $venta_total - $cuota_inicial;
                    $credito_cuotainicial =  $cuota_inicial;
                    $credito_interesproc =  $credito_interes;
                    $credito_interesmonto =  $venta_total * $venta_interes; //revisar
                    $credito_numpagos =  $cuotas;
                    $credito_fechalimite =  "date_add(date(now()), INTERVAL +1 WEEK)";
                    $credito_fecha = $venta_fecha;
                    // $time = time();
                    $credito_hora =  date("H:i:s");
                    $credito_tipo = 1; // 1- ventas 2 - compras

                    $cuotas       = $this->input->post('cuotas');
                    $interes       = $this->input->post('interes');
                    $modalidad    = $this->input->post('modalidad');
                    $dia_pago     = $this->input->post('dia_pago');
                    $fecha_inicio = $this->input->post('fecha_inicio');
                    $numcuota = $cuotas; //numero de cuotas

                    $intervalo = $modalidad == "MENSUAL" ? 'month': 'week'; 

                    $cuota_numcuota = 1;

                    $cuota_fechalimite = date('Y-m-d', strtotime("$credito_fecha +$numcuota $intervalo"));

                    $credito_fechalimite = $cuota_fechalimite;
                    $metodo_frances = $this->input->post('metodo_frances');
                    $metodo = "";
                    if($metodo_frances == "true"){
                        $metodo = "FRANCES";
                    }
                    $sql = "insert  into credito(estado_id,compra_id,venta_id,credito_monto,credito_cuotainicial,credito_interesproc,credito_interesmonto,credito_numpagos,credito_fechalimite,credito_fecha,credito_hora,credito_tipo, credito_metodo) value(
                            $estado_id,$compra_id,$venta_id,$credito_monto,$credito_cuotainicial,$credito_interesproc,$credito_interesmonto,$credito_numpagos,'$credito_fechalimite','$credito_fecha','$credito_hora',$credito_tipo, '$metodo')";
                    echo $sql;
                    $credito_id = $this->Venta_model->ejecutar($sql);// cargar los productos del detalle_aux al detalle_venta


                    $estado_id =  8; //8 pendiente 9 cancelado
                    $cuota_numcuota = 1;
                    $cuota_capital = $venta_total - $cuota_inicial;
                    $cuota_interes = ($venta_total - $cuota_inicial)*($credito_interes/100);
                    $cuota_moradias = 0;
                    $cuota_multa = 0;
                    $cuota_subtotal =  $venta_total - $cuota_inicial;
                    $cuota_descuento = 0;
                    $cuota_total = $venta_total - $cuota_inicial+$cuota_interes;

                    $cuota_cancelado = 0;
                    $cuota_fecha = "'1900-01-01'";
                    $cuota_hora = "'00:00'";
                    $cuota_numercibo =  0;
                    $cuota_saldo = $venta_total - $cuota_inicial;
                    $cuota_glosa = "''";
                    $cuota_saldocredito = $venta_total - $cuota_inicial;


                    $dias_mora = 0;
                    $multa = 0;
                    $descuento = 0;
                    $cancelado = 0;
                    $credito_monto = $venta_total - $cuota_inicial;

                    $patron = ($numcuota*0.5) + 0.5;
                    $cuota_capital = ($credito_monto)/$numcuota;   // bien         
                    $fijo = $patron * $credito_monto * ($credito_interes/100/$numcuota);
                    $cuota_subtotal = $fijo + $cuota_capital + $dias_mora + $multa;
                    $total = $cuota_subtotal - $descuento;
                    $saldo_deudor = $credito_monto;

                    $siguiente= 0;
                    $cuota_fechalimite = $fecha_inicio;

                   // $fecha_inicio = date('YYYY', $fecha_inicio)."-".date('MM', $fecha_inicio)."-".$dia_pago;

                    $cuota_fechalimite = $fecha_inicio;
                    $cuota_fecha_i = $fecha_inicio;
                    if($metodo_frances == "true"){
                        $Co = $credito_monto;
                        $i  = $credito_interes;
                        $n  = $cuotas;
                        $Ci = $Co;
                        $Ii = 0;
                        $Ai = 0;
                        //$a = $Co*($i/(1-(1+$i) ** (-$n)));
                        $a = $Co*($i/(1-(pow((1+$i),-$n))));
                        for($k = 1; $k <= $cuotas; $k++){
                            $cuota_numcuota = $k;

                            $cuota_fechalimitex = date('Y-m-d', strtotime("$cuota_fecha_i +$k $intervalo"));
                            $cuota_fechalimite = $cuota_fechalimitex;

                            $Ii = $Ci*$i;
                            $Ai = $a-$Ii;
                            $cuota_subtotal = $Ai + $Ii + $dias_mora + $multa;
                            $total = $cuota_subtotal - $descuento;
                            $params = array(
                                'credito_id' => $credito_id,
                                'usuario_id' => $usuario_id,
                                'estado_id' => $estado_id,
                                'cuota_numcuota' => $cuota_numcuota,
                                'cuota_capital' => $Ai,
                                'cuota_interes' => $Ii,
                                'cuota_moradias' => $dias_mora,
                                'cuota_multa' => $multa,
                                'cuota_subtotal' => $cuota_subtotal,
                                'cuota_descuento' => $descuento,
                                'cuota_total' => $total,
                                'cuota_fechalimite' => $cuota_fechalimite,
                                'cuota_cancelado' => $cancelado,
                                'cuota_saldo' => $Ci,
                            );
                            $this->load->model('Cuotum_model');
                            $cuotum_id = $this->Cuotum_model->add_cuotum($params);
                            $Ci = $Ci-$Ai;
                        }
                    }else{
                        for ($i=1; $i <= $numcuota; $i++) { // ciclo para llenar las cuotas
                            $cuota_numcuota = $i;
                            $cuota_fechalimite = date('Y-m-d', strtotime("$credito_fecha +$i $intervalo"));

                            $cuota ="insert into cuota (credito_id,usuario_id,estado_id,cuota_numcuota,cuota_capital,cuota_interes,cuota_moradias,cuota_multa,cuota_descuento,cuota_cancelado,cuota_total,cuota_subtotal,cuota_fechalimite,cuota_saldo) VALUES (".
                                    $credito_id.",".$usuario_id.",".$estado_id.",".$cuota_numcuota.",".$cuota_capital.",".$fijo.",".
                                    $dias_mora.",".$multa.",".$descuento.",".$cancelado.",".$total.",".$cuota_subtotal.",'".$cuota_fechalimite."',".$saldo_deudor.")";
                            $this->Venta_model->ejecutar($cuota);

        //                    $saldo_deudor = $cuota_total - $cuota_capital;
        //                    $cuota_total = $saldo_deudor;
                            $saldo_deudor = $saldo_deudor - $cuota_capital;
                            //$cuota_total = $saldo_deudor;
                        }
                    }
                }

            }else{
                if($credito_id>0){ //si la transaccion era a credito eliminar el credito
                    $sql = "delete from cuota where credito_id=".$credito_id;
                    $this->Venta_model->ejecutar($sql);

                    $sql = "delete from credito where credito_id=".$credito_id;
                    $this->Venta_model->ejecutar($sql);                
                }
            }
            
            echo json_encode("");
        }
    }
    
    
    function remove($venta_id)
    {
        
        if($this->acceso(12)){
        //**************** inicio contenido ***************     
        $data['sistema'] = $this->sistema;
        $venta = $this->Venta_model->get_venta($venta_id);

        // check if the venta exists before trying to delete it
        if(isset($venta['venta_id']))
        {
            $this->Venta_model->delete_venta($venta_id);
            redirect('venta/index');
        }
        else
            show_error('The venta you are trying to delete does not exist.');
            		
        //**************** fin contenido ***************
        }
        			
    }

    /*
     * Eliminar item de detalle
     */
    function eliminaritem($detalleven_id)
    {
        if($this->acceso(12)){
        //**************** inicio contenido ***************        

        $sql = "delete from detalle_venta_aux where detalleven_id = ".$detalleven_id;
        $this->Venta_model->ejecutar($sql);
        return true;
            		
        //**************** fin contenido ***************
        }
        			
    }

    /*
     * Eliminar todos los items
     */
    function eliminartodo()
    {
        if($this->acceso(12)){
        //**************** inicio contenido ***************  
            
        //************ inicio bitacora 
        $data['sistema'] = $this->sistema;   
        $usuario_id = $this->session_data['usuario_id'];        
        $bitacoracaja_fecha = "date(now())";
        $bitacoracaja_hora = "time(now())";
        $bitacoracaja_evento = "(select concat('QUITAR TODOS LOS PRODUCTOS EN VENTAS CANT: ',count(*),'| TOTAL: ',sum(detalleven_cantidad * detalleven_precio)) from detalle_venta_aux where usuario_id = ".$usuario_id.")";
        $bitacoracaja_montoreg = 0;
        $bitacoracaja_montocaja = 0;
        $bitacoracaja_tipo = 2; //2 operaciones sobre ventas
        
        
        $sql = "insert into bitacora_caja(bitacoracaja_fecha, bitacoracaja_hora, bitacoracaja_evento, 
                usuario_id, bitacoracaja_montoreg, bitacoracaja_montocaja, bitacoracaja_tipo, caja_id) value(".
                $bitacoracaja_fecha.",".$bitacoracaja_hora.",".$bitacoracaja_evento.",".
                $usuario_id.",".$bitacoracaja_montoreg.",".$bitacoracaja_montocaja.",".$bitacoracaja_tipo.",".$this->caja_id.")";
        $this->Venta_model->ejecutar($sql);
        //************ fin botacora bitacora     
        
        
        $sql = "delete from detalle_venta_aux where usuario_id = ".$usuario_id;
        $this->Venta_model->ejecutar($sql);
        return true;
            		
        //**************** fin contenido ***************
        }
        			
        
    }

    /*
     * Eliminar todos los items
     */
    function cancelar_cambios()
    {
        if($this->acceso(12)){
        //**************** inicio contenido ***************
                
                
        $usuario_id = $this->session_data['usuario_id'];
        $sql = "delete from detalle_venta_aux where usuario_id = ".$usuario_id;
        $this->Venta_model->ejecutar($sql);
        
        redirect('venta');
            		
        //**************** fin contenido ***************
        }
        			
        
    }
    /*
     * incrementar cantidad de productos en el detalle
     */
    function incrementar()
    {
        if($this->acceso(12)||$this->acceso(30)){ // 12 ventas 30 pedidos
        //**************** inicio contenido ***************        
        
        $detalleven_id = $this->input->post('detalleven_id');
        $cantidad = $this->input->post('cantidad');
        $descuento = 0;
        
            $sql = "update detalle_venta_aux set detalleven_cantidad = detalleven_cantidad + ".$cantidad.
                    ", detalleven_subtotal = detalleven_precio * (detalleven_cantidad)".
                    ", detalleven_descuentoparcial = ".$descuento.
                    ", detalleven_descuento = ".$descuento.
                    ", detalleven_total = (detalleven_precio - ".$descuento.")*(detalleven_cantidad)".
                    "  where detalleven_id = ".$detalleven_id;
            
        $this->Venta_model->ejecutar($sql);
        return true;
        
            		
        //**************** fin contenido ***************
        }
        			
        
    }
    /*
     * incrementar cantidad de productos en el detalle
     */
    function incrementar_detalle()
    {
        if($this->acceso(12)||$this->acceso(30)){ // 12 ventas 30 pedidos
        //**************** inicio contenido ***************        
        
        $detalleven_id = $this->input->post('detalleven_id');
        $cantidad = $this->input->post('cantidad');
        $venta_id = $this->input->post('venta_id');
        $descuento = 0;
        
            $sql = "update detalle_venta set detalleven_cantidad = detalleven_cantidad + ".$cantidad.
                    ", detalleven_subtotal = detalleven_precio * (detalleven_cantidad)".
                    ", detalleven_descuentoparcial = ".$descuento.
                    ", detalleven_descuento = ".$descuento.
                    ", detalleven_total = (detalleven_precio - ".$descuento.")*(detalleven_cantidad)".
                    "  where detalleven_id = ".$detalleven_id;
            
        $this->Venta_model->ejecutar($sql);
        
        $this->actualizar_tabla_venta($venta_id);
        
        return true;
        
            		
        //**************** fin contenido ***************
        }
        			
        
    }

    /*
     * reduce la cantidad de productos en el detalle
     */
    function reducir()
    {
      
        if($this->acceso(12)||$this->acceso(30)){ // 12 ventas 30 pedidos
        //**************** inicio contenido ***************
        
        
        $detalleven_id = $this->input->post('detalleven_id');
        $cantidad = $this->input->post('cantidad');
        $descuentoparcial = $this->input->post('descuentoparcial');
        $descuento = 0;
        
            $sql = "update detalle_venta_aux set detalleven_cantidad = detalleven_cantidad - ".$cantidad.
                    ", detalleven_subtotal = detalleven_precio * (detalleven_cantidad)".
                    ", detalleven_descuentoparcial = ".$descuentoparcial.
                    ", detalleven_descuento = ".$descuento.
                    ", detalleven_total = (detalleven_precio - ".$descuentoparcial.")*(detalleven_cantidad)".
                    "  where detalleven_id = ".$detalleven_id." and detalleven_cantidad > 1";
            
        $this->Venta_model->ejecutar($sql);
        return true;
            		
        //**************** fin contenido ***************
        }
        			
        
    }


    /*
     * reduce la cantidad de productos en el detalle
     */
    function reducir_detalle()
    {
      
        if($this->acceso(12)||$this->acceso(30)){ // 12 ventas 30 pedidos
        //**************** inicio contenido ***************
        
        
        $detalleven_id = $this->input->post('detalleven_id');
        $cantidad = $this->input->post('cantidad');
        $venta_id = $this->input->post('venta_id');
        $descuento = 0;
        
            $sql = "update detalle_venta set detalleven_cantidad = detalleven_cantidad - ".$cantidad.
                    ", detalleven_subtotal = detalleven_precio * (detalleven_cantidad)".
                    ", detalleven_descuentoparcial = ".$descuento.
                    ", detalleven_descuento = ".$descuento.
                    ", detalleven_total = (detalleven_precio - ".$descuento.")*(detalleven_cantidad)".
                    "  where detalleven_id = ".$detalleven_id;
            
        $this->Venta_model->ejecutar($sql);
        
        $this->actualizar_tabla_venta($venta_id);
        
        
        return true;
            		
        //**************** fin contenido ***************
        }
        			
        
    }

    /*
     * Buscar Cliente
     */
    function buscarcliente()
    {
        if($this->acceso(12)){
        //**************** inicio contenido ***************
        
                if ($this->input->is_ajax_request()) {       
                    
                    $nit = $this->input->post('nit');                    
                    $datos = $this->Venta_model->buscar_cliente($nit);
                    echo json_encode($datos);                        

                }
                else
                {                 
                            show_404();
                }  
        		
        //**************** fin contenido ***************
        }
                
               
    }
    /*
     * Mostrar detalle de venta
     */
    function detalleventa()
    {

        //if($this->acceso(12)){
        //**************** inicio contenido ***************
        
        
        $usuario_id = $this->session_data['usuario_id'];
        
        if ($this->input->is_ajax_request()) {

            //$sql = "select * from detalle_venta_aux where usuario_id=".$usuario_id;
            //$datos = $this->Venta_model->consultar($sql);
            $datos = $this->Venta_model->get_detalle_aux($usuario_id);
            
            echo json_encode($datos);
            
        }
        else
        {                 
                    show_404();
        }  
        		
        //**************** fin contenido ***************
        //}
        			
               
    }

    /*
     * incrementar cantidad de productos en el detalle
     */
    function actualizarprecio()
    {
     
        //if($this->acceso(12)){
        //**************** inicio contenido *************** 
      
        $decimales = $this->parametros["parametro_decimales"];
        if ($this->input->is_ajax_request()) {
            $precio = $this->input->post('precio');
            $cantidad = $this->input->post('cantidad');
            $descuentoparcial = $this->input->post('descuentoparcial');
            $detalleven_id = $this->input->post('detalleven_id');
            $descuento = '0';
        
            $sql = "update detalle_venta_aux set detalleven_cantidad =  ".$cantidad.
                    ", detalleven_precio = ".$precio.
                    ", detalleven_subtotal = detalleven_precio * (detalleven_cantidad)".
                    ", detalleven_descuentoparcial = ".$descuentoparcial.
                    ", detalleven_descuento = ".$descuento.
                    ", detalleven_total = round((detalleven_precio - ".$descuento." - ".$descuentoparcial." )*(detalleven_cantidad) , {$decimales})".
                    "  where detalleven_id = ".$detalleven_id;
            
        $this->Venta_model->ejecutar($sql);
        return true;
            
        }
        else
        {                 
                    show_404();
        }  

        //**************** fin contenido ***************
        //}
    }
    
/*
* buscar productos desde ventas
*/
function buscarproductos(){
    
    if ($this->input->is_ajax_request()) {
        $busqueda_serie = $this->input->post('busqueda_serie');
        $parametro = $this->input->post('parametro');   
        if ($parametro!=""){
            
            if (!$busqueda_serie) {
                $datos = $this->Inventario_model->get_inventario_parametro($parametro);            
            }else{
                $datos = $this->Inventario_model->get_inventario_for_serie($parametro);
            }
            echo json_encode($datos);
        }else{
            echo json_encode(null);
        }
    }else{                 
        show_404();
    }   
}
    
/*
* buscar productos por categoria de productos
*/
function buscarcategorias()
{
        //**************** inicio contenido ***************   
   
        $usuario_id = $this->session_data['usuario_id'];

        if ($this->input->is_ajax_request()) {
            
            $parametro = $this->input->post('parametro');   
            
            if ($parametro!=""){
            $datos = $this->Inventario_model->get_inventario_categoria($parametro);            
            //$datos = $this->Inventario_model->get_inventario_bloque();
                echo (json_encode($datos));
            }
            else echo json_encode(null);
        }
        else
        {                 
            show_404();
        }      
        		
        //**************** fin contenido ***************
              
}
    
/*
* buscar productos por categoria de productos
*/
function buscarsubcategorias()
{
        //**************** inicio contenido ***************   
   
        $usuario_id = $this->session_data['usuario_id'];

        if ($this->input->is_ajax_request()) {
            
            $parametro = $this->input->post('parametro');   
            
            if ($parametro!=""){
            $datos = $this->Inventario_model->get_inventario_subcategoria($parametro);            
            //$datos = $this->Inventario_model->get_inventario_bloque();
            echo json_encode($datos);
            }
            else echo json_encode(null);
        }
        else
        {                 
            show_404();
        }      
        		
        //**************** fin contenido ***************
              
}

function buscarcotizar()
{
        $usuario_id = $this->session_data['usuario_id'];

        if ($this->input->is_ajax_request()) {
            
            $parametro = $this->input->post('parametro');   
            
            if ($parametro!=""){
            $datos = $this->Inventario_model->get_inventario_coti($parametro);            
            //$datos = $this->Inventario_model->get_inventario_bloque();
            echo json_encode($datos);
            }
            else echo json_encode(null);
        }
        else
        {                 
            show_404();
        }              
}
    
/*
* Registrar cliente
*/
function registrarcliente()
{
        if(($this->acceso(12)==true)||($this->acceso(30)==true)){
        //**************** inicio contenido ***************    
    
        if ($this->input->is_ajax_request()) {
            
            $cliente_nit = "'".$this->input->post('nit')."'";
            $cliente_razon = "'".$this->input->post('razon')."'";
            $cliente_telefono = "'".$this->input->post('telefono')."'";
            $tipocliente_id = $this->input->post('tipocliente_id');
            
            $cliente_nombre =  "'".$this->input->post('cliente_nombre')."'";
            $cliente_ci =  "'".$this->input->post('cliente_ci')."'";
            $cliente_nombrenegocio =  "'".$this->input->post('cliente_nombrenegocio')."'";
            $cliente_codigo =  "'".$this->input->post('cliente_codigo')."'";

            $cliente_direccion =  "'".$this->input->post('cliente_direccion')."'";
            $cliente_departamento =  "'".$this->input->post('cliente_departamento')."'";
            $cliente_celular =  "'".$this->input->post('cliente_celular')."'";
            $zona_id =  $this->input->post('zona_id');
            $tipo_doc_identidad =  $this->input->post('tipo_doc_identidad');
            $cliente_email =  "'".$this->input->post('cliente_email')."'";
            $cliente_complementoci =  "'".$this->input->post('cliente_complementoci')."'";
            $cliente_excepcion = $this->input->post('cliente_excepcion');
            
            $cliente_ci = $cliente_nit;
            $cliente_nombre = $cliente_razon;
            $sql = "insert cliente(tipocliente_id,categoriaclie_id,cliente_nombre,cliente_ci,cliente_nit,
                    cliente_razon,cliente_telefono,estado_id,usuario_id,
                    cliente_nombrenegocio, cliente_codigo, cliente_direccion, cliente_departamento,
                    cliente_celular, zona_id, cdi_codigoclasificador, cliente_email, cliente_complementoci,
                    cliente_excepcion) value(".$tipocliente_id.",1,".$cliente_nombre.",".$cliente_ci.",".$cliente_nit.",".
                    $cliente_razon.",".$cliente_telefono.",1,0,".
                   $cliente_nombrenegocio.",".$cliente_codigo.",".$cliente_direccion.",".$cliente_departamento.",".
                   $cliente_celular.",".$zona_id.",".$tipo_doc_identidad.",".$cliente_email.",".$cliente_complementoci.
                    ",".$cliente_excepcion.")";
//            echo $sql;
            $datos = $this->Venta_model->registrarcliente($sql);
            echo json_encode($datos);
            
        }
        else
        {                 
            show_404();
        }   
        
        		
        //**************** fin contenido ***************
        			}
        		
}
    
/*
* Registrar cliente
*/
function modificarcliente()
{
        if($this->acceso(12)||$this->acceso(30)){
        //**************** inicio contenido ***************    
    
        if ($this->input->is_ajax_request()) {
            
            $cliente_nit = $this->input->post('nit');    
            
            if($cliente_nit == null) $cliente_nit = "0";
            
            $cliente_razon = "'".$this->input->post('razon')."'";
            $cliente_telefono = "'".$this->input->post('telefono')."'";
            $cliente_id = $this->input->post('cliente_id');
            $cliente_nombre =  "'".$this->input->post('cliente_nombre')."'";
            $tipo_doc_identidad = $this->input->post('tipo_doc_identidad');
            $cliente_nit = "'".$cliente_nit."'";
            
            $tipocliente_id = $this->input->post('tipocliente_id');
            
            $cliente_nombre =  "'".$this->input->post('cliente_nombre')."'";
            $cliente_ci =  "'".$this->input->post('cliente_ci')."'";
            $cliente_nombrenegocio =  "'".$this->input->post('cliente_nombrenegocio')."'";
            $cliente_codigo =  "'".$this->input->post('cliente_codigo')."'";

            $cliente_direccion =  "'".$this->input->post('cliente_direccion')."'";
            $cliente_departamento =  "'".$this->input->post('cliente_departamento')."'";
            $cliente_celular =  "'".$this->input->post('cliente_celular')."'";
            $cliente_email   =  "'".$this->input->post('cliente_email')."'";
            $zona_id = $this->input->post('zona_id');
            $cdi_codigoclasificador = $tipo_doc_identidad; //$this->input->post('cdi_codigoclasificador'); el JS no evnia esta variable
            $cliente_complementoci =  "'".$this->input->post('cliente_complementoci')."'";
            $cliente_excepcion = $this->input->post('cliente_excepcion');
            $dosificacion = $this->Dosificacion_model->get_all_dosificacion();
            if($dosificacion[0]["docsec_codigoclasificador"] == 23){
                $cliente_nombre = "'S/N'";
                $cliente_razon = "'S/N'";
                $cdi_codigoclasificador = 5;
                $cliente_nit = "'0'";
                $cliente_codigo =  "'N/A'";
            }
            if ($cliente_id>0){
                $sql = "update cliente set ".
                        " cliente_nombre = ".$cliente_nombre.
    //                    ",cliente_ci = ".$cliente_ci.
                        ",cliente_nit = ".$cliente_nit.
                        ",cliente_razon = ".$cliente_razon.
                        ",cliente_telefono = ".$cliente_telefono.
                        ",tipocliente_id = ".$tipocliente_id.
                        
                        ",cliente_nombre= ".$cliente_nombre.
                        ",cliente_ci = ".$cliente_ci.
                        ",cliente_nombrenegocio = ".$cliente_nombrenegocio.
                        ",cliente_codigo = ".$cliente_codigo.
                        
                        ",cliente_direccion= ".$cliente_direccion.
                        ",cliente_departamento = ".$cliente_departamento.
                        ",cliente_celular = ".$cliente_celular.
                        ",cliente_email = ".$cliente_email.
                        ",cdi_codigoclasificador = '$cdi_codigoclasificador'".
                        ",zona_id = ".$zona_id.
                        ",cliente_excepcion = ".$cliente_excepcion.
                        ",cliente_complementoci = ".$cliente_complementoci." where cliente_id = ".$cliente_id;
                //echo $sql;
                $datos = $this->Venta_model->modificarcliente($sql);            
                echo  '[{"cliente_id":'.$cliente_id.'}]';
            }
            else{
                //si el cliente ingresa con nit 0 se debe
                $cliente_nit = str_replace("'","",$cliente_nit);
                $datos = $this->Venta_model->buscar_cliente($cliente_nit); 
                
                if (sizeof($datos)>0){
                    $cliente_id = $datos[0]["cliente_id"];

                    $sql = "update cliente set ".
                            " cliente_nombre = ".$cliente_nombre.
                            ",cliente_nit = ".$cliente_nit.
                            ",cliente_razon = ".$cliente_razon.
                            ",cliente_telefono = ".$cliente_telefono.
                            ",cliente_email = ".$cliente_email.
                            ",cliente_excepcion = ".$cliente_excepcion.
                            ",cliente_codigo = ".$cliente_codigo.
                            " where cliente_id = ".$cliente_id;

                    $datos = $this->Venta_model->modificarcliente($sql);   
                    echo  '[{"cliente_id":'.$cliente_id.'}]';
                }
                else{
                        $cliente_ci = $cliente_nit;
                        $cliente_nombre = $cliente_razon;
                        $sql = "insert cliente(tipocliente_id,categoriaclie_id,cliente_nombre,cliente_ci,cliente_nit,cliente_razon,cliente_telefono,estado_id,usuario_id, cliente_email, cliente_excepcion) value(1,1,".
                               $cliente_nombre.",".$cliente_ci.",".$cliente_nit.",".$cliente_razon.",".$cliente_telefono.",1,0,".$cliente_email.",".$cliente_excepcion.")";

                        $datos = $this->Venta_model->registrarcliente($sql);
                        echo json_encode($datos);
 
                }
                
            }
//echo json_encode(true);
            
        }
        else
        {                 
            show_404();
        }   		
        //**************** fin contenido ***************
        			}
        			
}


/*************** funcion para mostrar la vista de la factura******************/
function ultimaventa($tipo){
    
    if($this->acceso(12)||$this->acceso(30)){
        
            //**************** inicio contenido ***************    
        $venta = $this->Venta_model->ultima_venta();
        $venta_tipodoc = $venta[0]['venta_tipodoc'];
        $venta_id = $venta[0]['venta_id'];

        if ($venta_tipodoc==1){ 
            redirect('factura/imprimir_factura/'.$venta_id."/".$tipo);
            //redirect('factura/factura_boucher/'.$venta_id);

        }
        else{
            redirect('factura/imprimir_recibo/'.$venta_id);
            //redirect('factura/recibo_boucher/'.$venta_id);        
        }

           //**************** fin contenido ***************
    }
            
}

/*************** funcion para mostrar la vista de la factura******************/
function ultimorecibo(){
    
    if($this->acceso(12)||$this->acceso(30)){
    //**************** inicio contenido ***************    
    
                
    $venta = $this->Venta_model->ultima_venta();
    $venta_tipodoc = $venta[0]['venta_tipodoc'];
    $venta_id = $venta[0]['venta_id'];
    

     redirect('factura/imprimir_recibo/'.$venta_id);
        //redirect('factura/recibo_boucher/'.$venta_id);        
 
        
       //**************** fin contenido ***************
        }
            
}

function ultimagarantia(){
    
    if($this->acceso(12)||$this->acceso(30)){
    //**************** inicio contenido ***************    
    
                
    $venta = $this->Venta_model->ultima_venta();
    $venta_tipodoc = $venta[0]['venta_tipodoc'];
    $venta_id = $venta[0]['venta_id'];
    

     redirect('factura/certificado_garantia/'.$venta_id);
        //redirect('factura/recibo_boucher/'.$venta_id);        
 
        
       //**************** fin contenido ***************
        }
            
}

function ultimacomanda(){
    
       if($this->acceso(12)){
        //**************** inicio contenido ***************    
    
                
    $venta = $this->Venta_model->ultima_venta();
    $venta_tipodoc = $venta[0]['venta_tipodoc'];
    $venta_id = $venta[0]['venta_id'];
    
        redirect('factura/comanda_boucher/'.$venta_id);

       //**************** fin contenido ***************
        }
            
}

function eliminar_venta($venta_id){

        if($this->acceso(12)){
            
        $data['sistema'] = $this->sistema;    
        //**************** bitacora caja       
        $venta = $this->Detalle_venta_model->get_venta($venta_id);
        $cliente = $this->Cliente_model->get_cliente($venta[0]['cliente_id']);
        $sql =  "select count(*) from detalle_venta where venta_id = ".$venta[0]['venta_id'];
        $cont = $this->Venta_model->consultar($sql);
        
        $prec_total = $venta[0]['venta_total'];
        
        
        $bitacoracaja_evento = "ELIMINAR VENTA Nº 00".$venta_id." CLIENTE:".$cliente[0]['cliente_nombre']."| PROD.: ".$cont." | PREC.TOT.: ".$prec_total;
        $bitacoracaja_tipo = 2;
        
        $sql = "insert into bitacora_caja(bitacoracaja_fecha, bitacoracaja_hora, bitacoracaja_evento, 
                usuario_id, bitacoracaja_montoreg, bitacoracaja_montocaja, bitacoracaja_tipo, caja_id) value(date(now()),time(now())".
                ",'".$bitacoracaja_evento."',".$usuario_id.",0,0,".$bitacoracaja_tipo.",".$this->caja_id.")";
        
        $this->Venta_model->ejecutar($sql);
        //****************** fin bitacora caja
    
            
            
        //**************** inicio contenido ***************       
    
            
            $sql = "update inventario i, detalle_venta d"
                    ." set i.existencia = i.existencia + d.detalleven_cantidad"
                    ." where d.venta_id = ".$venta_id." and d.producto_id = i.producto_id ";
            $this->Venta_model->ejecutar($sql);    

            $sql =  "delete from detalle_venta where venta_id = ".$venta_id;
            $this->Venta_model->ejecutar($sql);

            $sql =  "delete from venta where venta_id = ".$venta_id;
            $this->Venta_model->ejecutar($sql);

            $sql =  "delete from cuota where credito_id = (select credito_id from credito where venta_id = ".$venta_id." ) ";
            $this->Venta_model->ejecutar($sql);

            $sql =  "delete from credito where venta_id = ".$venta_id;
            $this->Venta_model->ejecutar($sql);

            redirect('venta/index');
            
       //**************** fin contenido ***************
        			}
        			              
}

function anular_venta($venta_id){

        if($this->acceso(22)){
            
        $data['sistema'] = $this->sistema;   
        //**************** bitacora caja
        $usuario_id = $this->session_data['usuario_id'];
        $venta = $this->Detalle_venta_model->get_venta($venta_id);
        $cliente = $this->Cliente_model->get_cliente($venta[0]['cliente_id']);
        $sql =  "select count(*) as cantidad from detalle_venta where venta_id = ".$venta[0]['venta_id'];
        $contx = $this->Venta_model->consultar($sql);
        $cont = $contx[0]['cantidad'];
        
        $prec_total = $venta[0]['venta_total'];
        
        
        $bitacoracaja_evento = "ANULAR VENTA Nº 00".$venta_id." CLIENTE: ".$cliente['cliente_nombre']."| PROD.: ".$cont." | PREC.TOT.: ".$prec_total;
        $bitacoracaja_tipo = 2;
        
        $sql = "insert into bitacora_caja(bitacoracaja_fecha, bitacoracaja_hora, bitacoracaja_evento, 
                usuario_id, bitacoracaja_montoreg, bitacoracaja_montocaja, bitacoracaja_tipo, caja_id) value(date(now()),time(now())".
                ",'".$bitacoracaja_evento."',".$usuario_id.",0,0,".$bitacoracaja_tipo.",".$this->caja_id.")";
        
        $this->Venta_model->ejecutar($sql);
        //****************** fin bitacora caja
          
            
            
            
        //**************** inicio contenido ***************   
            
    
    //$sql =  "delete from detalle_venta where venta_id = ".$venta_id;
    $sql =  "update detalle_venta set detalleven_cantidad = 0, detalleven_precio = 0, detalleven_total = 0 where venta_id = ".$venta_id;
    $this->Venta_model->ejecutar($sql);
            
    //$sql =  "delete from venta where venta_id = ".$venta_id;
    $sql =  "update venta set venta_subtotal = 0, venta_descuento = 0, venta_total = 0, venta_efectivo = 0, venta_cambio = 0, estado_id = 3 where venta_id = ".$venta_id;
    $this->Venta_model->ejecutar($sql);
    
    //$sql =  "delete from cuota where credito_id = (select credito_id from credito where venta_id = ".$venta_id." ) ";
    $sql =  "update cuota  set
            cuota_numcuota = 0
            ,cuota_capital = 0
            ,cuota_interes = 0
            ,cuota_moradias = 0
            ,cuota_multa = 0
            ,cuota_subtotal = 0
            ,cuota_descuento = 0
            ,cuota_total = 0
            ,cuota_cancelado = 0
            ,cuota_numercibo = 0
            ,cuota_saldo = 0
            ,estado_id = 27
            ,cuota_saldocredito = 0
             where credito_id = (select credito_id from credito where venta_id = ".$venta_id." ) ";
    $this->Venta_model->ejecutar($sql);
        
    $sql =  "update credito set
            estado_id = 27
            ,credito_monto = 0
            ,credito_cuotainicial = 0
            ,credito_interesproc = 0
            ,credito_interesmonto = 0
            ,credito_numpagos = 0
            ,credito_tipointeres = 0
            where venta_id = ".$venta_id;
    $this->Venta_model->ejecutar($sql);
            
    $sql =  "update pedido set estado_id = 11 where pedido_id = (select v.pedido_id from venta v where v.venta_id = ".$venta_id.")";
    $this->Venta_model->ejecutar($sql);
//    
    
    $this->Inventario_model->actualizar_inventario(); 
    redirect('venta/index');
    
    //**************** fin contenido ***************
    }
                              
    
}

    /*
     * Mostrar ventas
     */
    function mostrar_ventas()
    {
        //**************** inicio contenido ***************   

        $usuario_id = $this->session_data['usuario_id'];

        $data['sistema'] = $this->sistema;   

        if ($this->input->is_ajax_request()) {
            
            if($this->parametros['parametro_tiposistema'] == 1){// Si es diferente a Sistema de facturacion computarizado(1)
            
                $filtro = $this->input->post('filtro');

                if ($filtro == null){
                    $result = $this->Venta_model->get_ventas(" and v.venta_fecha = date(now())");
                }
                else{
                    $result = $this->Venta_model->get_ventas($filtro);            
                }
                
            }
            else{
            
                $filtro = $this->input->post('filtro');

                if ($filtro == null){
                    $result = $this->Venta_model->get_ventas_enlinea(" and v.venta_fecha = date(now())");
                }
                else{
                    $result = $this->Venta_model->get_ventas_enlinea($filtro);            
                }
                
                
                
            }
            
            echo json_encode($result);
           
            
        }
        else
        {                 
                    show_404();
        }    
       //**************** fin contenido ***************
        			     
    }
    
  function busquedacombi()
    {
        if($this->acceso(144)){
            
            $data['sistema'] = $this->sistema;   

            //**************** inicio contenido ***************   
            $config = $this->config->item('pagination');
            $config['total_rows'] = $this->Venta_model->get_all_venta_count();
            $this->pagination->initialize($config);
            $this->load->model('Usuario_model');
            $this->load->model('Detalle_venta_model');
            $filtro = $this->input->post('filtro');
            if ($filtro == null){
               //$data['venta'] = $this->Venta_model->get_all_ventas($params);
            }
            else{
                 $data['venta'] = $this->Venta_model->get_busqueda($filtro);            
            }

            $data['all_usuario'] = $this->Usuario_model->get_all_usuactivo();
            $data['empresa'] = $this->Empresa_model->get_empresa(1); 
            
            $data['parametro'] = $this->Parametro_model->get_parametros();
            $data['moneda'] = $this->Moneda_model->get_moneda(2); //Obtener moneda extragera
            $data['lamoneda'] = $this->Moneda_model->getalls_monedasact_asc();
            
            $data['_view'] = 'venta/combinados';
            $this->load->view('layouts/main',$data);
            //**************** fin contenido ***************
        }
    }

    function comision()
    {
        if($this->acceso(143)){
            
            //**************** inicio contenido ***************
            $data['sistema'] = $this->sistema;   

            $this->load->model('Usuario_model');
            //$this->load->model('Detalle_venta_model');
            $filtro = $this->input->post('filtro');
            if ($filtro == null){
               //$data['venta'] = $this->Venta_model->get_all_venta(1);
            }
            else{
                 $data['venta'] = $this->Venta_model->get_busqueda($filtro);            
            }
            
            $data['parametro'] = $this->Parametro_model->get_parametros();
            $data['moneda'] = $this->Moneda_model->get_moneda(2); //Obtener moneda extragera
            $data['lamoneda'] = $this->Moneda_model->getalls_monedasact_asc();
            
            $data['all_usuario'] = $this->Usuario_model->get_all_usuario();
            $data['_view'] = 'venta/comisiones';
            $this->load->view('layouts/main',$data);
            //**************** fin contenido ***************
        }
    }
    
    function buscarporvendedores()
    {
            //**************** inicio contenido ***************          

            if ($this->input->is_ajax_request()) {

                $filtro = $this->input->post('filtro');   

                if ($filtro!=""){
                $datos = $this->Venta_model->get_busqueda($filtro);            

                echo json_encode($datos);
                }
                else echo json_encode(null);
            }
            else
            {                 
                show_404();
            }              

           //**************** fin contenido ***************
                         

    }

    
    function actualizar_tabla_venta($venta_id)
    {

        //actualizar los totales
        $sql = "select if(sum(x.detalleven_subtotal)>0,sum(x.detalleven_subtotal),0) as subtotal,"
                . "if(sum(x.detalleven_descuento)>0,sum(x.detalleven_descuento),0) as descuento, "
                . "if(sum(x.detalleven_total)>0, sum(x.detalleven_total),0) as total "
                . " from detalle_venta x where x.venta_id = ".$venta_id;                    
        $resultado = $this->Venta_model->consultar($sql);

        //echo json_encode($resultado);

        $subtotal = $resultado[0]['subtotal'];
        $descuento = $resultado[0]['descuento'];
        $total = $resultado[0]['total'];

        $sql = "update venta set "
                . " venta_subtotal = ".$subtotal
                . ",venta_descuento = ".$descuento
                . ",venta_total = ".$total
                ." where venta_id = ".$venta_id;
        $this->Venta_model->ejecutar($sql);        
        
        return true;
        
    }
    
    function eliminar_producto_vendido($detalleven_id)
    {
           if($this->acceso(12)||$this->acceso(30)){ //12 ventas o 30 pedidos
            //**************** inicio contenido ***************          

            if ($this->input->is_ajax_request()) {

                //Obtener el detalle de la venta a eliminar
                $sql = "select * from detalle_venta where detalleven_id = ".$detalleven_id;
                $resultado = $this->Venta_model->consultar($sql);
                
                if (sizeof($resultado)>0){ // si el detalle existe
                    
                    
                    $producto_id = $resultado[0]['producto_id'];
                    $cantidad = $resultado[0]['detalleven_cantidad'];
                    $venta_id = $resultado[0]['venta_id'];
                    
                    //eliminar el detalle de la venta
                    $sql = "delete from detalle_venta where detalleven_id = ".$detalleven_id;                    
                    $this->Venta_model->ejecutar($sql);

                    //retornamos la cantidad al inventario
                    $sql = "update inventario set existencia = existencia + ".$cantidad;
                    $this->Venta_model->ejecutar($sql);

                    $this->actualizar_tabla_venta($venta_id);
                 
                    
                }
                
                return true;
                
            }
            else
            {                 
                show_404();
            }              

           //**************** fin contenido ***************
                }
                      

    }
    
    

    /*
     * Verificar las ventas
     */
    function verificar_ventas()
    {
        //**************** inicio contenido ***************   

        $usuario_id = $this->session_data['usuario_id'];

        
        if ($this->input->is_ajax_request()) {
            
            $filtro = $this->input->post('filtro');
            
            if ($filtro == null){
                $result = $this->Venta_model->mostrar_ventas(" and v.venta_fecha = date(now())");
            }
            else{
                $result = $this->Venta_model->mostrar_ventas($filtro);            
            }

           echo json_encode($result);
            
        }
        else
        {                 
                    show_404();
        }    
       //**************** fin contenido ***************
        			       
    }       

    function costo_cero()
    {       
         if($this->acceso(15)){
        //**************** inicio contenido ***************       
        
        //************ inicio bitacora 
            
        $usuario_id = $this->session_data['usuario_id'];
        
        $bitacoracaja_fecha = "date(now())";
        $bitacoracaja_hora = "time(now())";
        $bitacoracaja_evento = "(select concat('COSTO CERO CANT PROD.: ',count(*),'| TOTAL: ',sum(detalleven_cantidad * detalleven_precio)) from detalle_venta_aux where usuario_id = ".$usuario_id.")";
        $bitacoracaja_montoreg = 0;
        $bitacoracaja_montocaja = 0;
        $bitacoracaja_tipo = 2; //2 operaciones sobre ventas
        
        
        $sql = "insert into bitacora_caja(bitacoracaja_fecha, bitacoracaja_hora, bitacoracaja_evento, 
                usuario_id, bitacoracaja_montoreg, bitacoracaja_montocaja, bitacoracaja_tipo, caja_id) value(".
                $bitacoracaja_fecha.",".$bitacoracaja_hora.",".$bitacoracaja_evento.",".
                $usuario_id.",".$bitacoracaja_montoreg.",".$bitacoracaja_montocaja.",".$bitacoracaja_tipo.",".$this->caja_id.")";
        $this->Venta_model->ejecutar($sql);
        //************ fin botacora bitacora     
        
        
        $sql =  "UPDATE
                detalle_venta_aux
              SET
                detalleven_costo = 0,
                detalleven_precio = 0,
                detalleven_subtotal = 0,
                detalleven_descuentoparcial = 0,
                detalleven_descuento = 0,
                detalleven_total = 0
              WHERE
                usuario_id = ".$usuario_id;
        $this->Venta_model->ejecutar($sql);
        return true;
    
            		
        //**************** fin contenido ***************
        			}
        		   
        
    }
        
    function cantidad_en_detalle()
    {       
        if($this->acceso(12)||$this->acceso(30)){ //12 ventas o 30 pedidos
        //**************** inicio contenido ***************       
        
        $usuario_id = $this->session_data['usuario_id'];
        
        $producto_id = $this->input->post('producto_id');
        
        $sql =  "select if(sum(detalleven_cantidad)>0,sum(detalleven_cantidad),0) as cantidad from detalle_venta_aux "
                . " where producto_id =".$producto_id." and usuario_id = ".$usuario_id;
        
        $resultado = $this->Venta_model->consultar($sql);
        echo json_encode($resultado);
    
            		
        //**************** fin contenido ***************
        }
    }
        
    function cantidad_en_detalle_otros()
    {       
          if($this->acceso(12)||$this->acceso(30)){ //12 ventas o 30 pedidos
        //**************** inicio contenido ***************       
        
        $usuario_id = $this->session_data['usuario_id'];
        
        $producto_id = $this->input->post('producto_id');
        
        $sql =  "select if(sum(detalleven_cantidad)>0,sum(detalleven_cantidad),0) as cantidad from detalle_venta_aux "
                . " where producto_id =".$producto_id." and usuario_id <>".$usuario_id;
        
        $resultado = $this->Venta_model->consultar($sql);
        echo json_encode($resultado);
    
            		
        //**************** fin contenido ***************
        			}	
    }
        


    function existencia()
    {       
         if($this->acceso(12)||$this->acceso(30)){ //12 ventas o 30 pedidos
        //**************** inicio contenido ***************       
        
        $usuario_id = $this->session_data['usuario_id'];
        
        $producto_id = $this->input->post('producto_id');
        
//        $sql =  "select existencia from inventario "
//                . " where producto_id =".$producto_id;
        
        $sql =  "select existencia from detalle_venta_aux "
                . " where producto_id =".$producto_id." and usuario_id = ".$usuario_id;
        
        $resultado = $this->Venta_model->consultar($sql);
        echo json_encode($resultado);
    
            		
        //**************** fin contenido ***************
        			}
        			
    }        

    function precio_costo()
    {       
         if($this->acceso(16)){
        //**************** inicio contenido ***************       
        
        //************ inicio bitacora 
            
        $usuario_id = $this->session_data['usuario_id'];
        
        $bitacoracaja_fecha = "date(now())";
        $bitacoracaja_hora = "time(now())";
        $bitacoracaja_evento = "(select concat('PRECIO COSTO CANT PROD.: ',count(*),'| TOTAL: ',sum(detalleven_cantidad * detalleven_precio)) from detalle_venta_aux where usuario_id = ".$usuario_id.")";
        $bitacoracaja_montoreg = 0;
        $bitacoracaja_montocaja = 0;
        $bitacoracaja_tipo = 2; //2 operaciones sobre ventas
        
        
        $sql = "insert into bitacora_caja(bitacoracaja_fecha, bitacoracaja_hora, bitacoracaja_evento, 
                usuario_id, bitacoracaja_montoreg, bitacoracaja_montocaja, bitacoracaja_tipo,caja_id) value(".
                $bitacoracaja_fecha.",".$bitacoracaja_hora.",".$bitacoracaja_evento.",".
                $usuario_id.",".$bitacoracaja_montoreg.",".$bitacoracaja_montocaja.",".$bitacoracaja_tipo.",".$this->caja_id.")";
        $this->Venta_model->ejecutar($sql);
        //************ fin botacora bitacora   
        
        $sql =  "UPDATE
                detalle_venta_aux d, inventario i
              SET
               
                d.detalleven_precio = i.producto_costo,
                d.detalleven_costo = i.producto_costo,
                d.detalleven_subtotal = d.detalleven_costo * d.detalleven_cantidad,
                d.detalleven_descuentoparcial = 0,
                d.detalleven_descuento = 0,
                d.detalleven_total = d.detalleven_costo * d.detalleven_cantidad
              WHERE                
                d.usuario_id = ".$usuario_id.
                " and d.producto_id = i.producto_id";
        $this->Venta_model->ejecutar($sql);
        return true;
    
            		
        //**************** fin contenido ***************
        			}
        			 
        
    }

    function buscar_clientes()
    {       

        //**************** inicio contenido ***************       
        
        $usuario_id = $this->session_data['usuario_id'];
        $parametro = $this->input->post('parametro');
        
        $sql =  "select c.*, t.tipocliente_descripcion, t.tipocliente_montodesc,t.tipocliente_porcdesc  from cliente  c".
                " left join tipo_cliente t on t.tipocliente_id = c.tipocliente_id ".
                " where ".
                " c.cliente_razon like '%".$parametro."%'".
                " or c.cliente_nombre like '%".$parametro."%'".
                " or c.cliente_codigo like '%".$parametro."%'".
                " or c.cliente_nit like '%".$parametro."%'";
        //echo $sql;
        $resultado = $this->Venta_model->consultar($sql);
        echo json_encode($resultado);
    
            		
        //**************** fin contenido ***************
        			
        		
    }
        
    function seleccionar_cliente($cliente_id){
        if($this->acceso(12)){
            //**************** inicio contenido ***************       
            $usuario_id = $this->session_data['usuario_id'];
            
//               $sql =  "select * from cliente where ".
//                       " cliente_id = ".$cliente_id;
            
            $sql = "SELECT c.cliente_id ,c.cliente_nit ,c.cliente_razon ,c.cliente_telefono ,c.cliente_nombre ,c.cliente_ci ,c.cliente_nombrenegocio ,c.cliente_codigo ,
                    c.tipocliente_id ,c.cliente_direccion ,c.cliente_departamento ,c.cliente_celular, c.cliente_email, c.cliente_complementoci, c.zona_id,
                    ifnull(c.cdi_codigoclasificador, 5) as cdi_codigoclasificador,t.tipocliente_descripcion, t.tipocliente_montodesc,t.tipocliente_porcdesc
                    from cliente c
                    left join tipo_cliente t on t.tipocliente_id = c.tipocliente_id
                    where 
                    c.cliente_id = '$cliente_id'";

            //echo "revisar: ".$sql;
            $resultado = $this->Venta_model->consultar($sql);
            echo json_encode($resultado);
            //**************** fin contenido ***************
        }
    }
        
    function registrar_caracteristicas(){
       if($this->acceso(12)){
               //**************** inicio contenido ***************       

               $usuario_id = $this->session_data['usuario_id'];
               
               $detalleven_id = $this->input->post('detalleven_id');
               $detalleven_preferencia = $this->input->post('preferencia');
               $detalleven_caracteristicas = $this->input->post('caracteristicas');
               $costo = $this->input->post('costo');
               $check = $this->input->post('check');
               $cantidadenvase = $this->input->post('cantidadenvase');
               $garantia = $this->input->post('garantia');
               $fecha_vencimiento = $this->input->post('fecha_vencimiento');
               
               $sql =  "update detalle_venta_aux set ".
                       " detalleven_preferencia = '".$detalleven_preferencia."'".
                       " ,detalleven_caracteristicas = '".$detalleven_caracteristicas."'".
                       " ,detalleven_fechavenc = '".$fecha_vencimiento."'".                       
                       " ,detalleven_costo = ".$costo.                       
                       " ,detalleven_devueltoenvase = 0".
                       " ,detalleven_montodevolucion = 0".
                       " ,detalleven_cantidadenvase = if(".$check."=1,".$cantidadenvase.",0)".
                       " ,detalleven_garantiaenvase = if(".$check."=1,".$garantia.",0)".                       
                       " ,detalleven_prestamoenvase = if(".$check."=1,1,0)".                       
                       " where detalleven_id = ".$detalleven_id;
               //echo $sql;
               $resultado = $this->Venta_model->ejecutar($sql);
               //echo json_encode($resultado);
               return true; 

               //**************** fin contenido ***************
                                       }
                                          
        
    }
  
        
    function verificar_detalle($monto){
        if($this->acceso(12)){
               //**************** inicio contenido ***************       

               $usuario_id = $this->session_data['usuario_id'];
               
               
               $sql =  "SELECT 
                        if(round(sum(detalleven_total), 2) = round(".$monto.", 2), 1, 0) AS resultado
                      FROM
                        detalle_venta_aux
                      WHERE
                        usuario_id =".$usuario_id;
               
               $resultado = $this->Venta_model->consultar($sql);
               echo json_encode($resultado);


               //**************** fin contenido ***************
        }
                                                   
        
    }    
        
    function guardar_preferencia(){
       //if($this->acceso(12)){
               //**************** inicio contenido ***************       
            $preferencia = $this->input->post('preferencia');
            $detalleven_id = $this->input->post('detalleven_id');
               
            $sql = "update detalle_venta_aux set detalleven_preferencia = '".$preferencia."'".
              " where detalleven_id = ".$detalleven_id;           
           //echo $sql;                  
            
           $resultado = $this->Venta_model->ejecutar($sql);
            echo true;

               //**************** fin contenido ***************
         //                              }
        
    }    
        
    function asignar_inventario(){
        //if($this->acceso(12)){
        //**************** inicio contenido ***************       

            $usuario_vendedor = $this->session_data['usuario_id'];
            $usuario_id = $this->input->post('usuario_id');
            $moneda_tc = $this->input->post('moneda_tc');


            $sql =  "delete from inventario_usuario where inventario_fecha = date(now()) and usuario_id = ".$usuario_id;
            $this->Venta_model->ejecutar($sql);
            
            $sql =  "insert into inventario_usuario
                    (producto_id,inventario_costo, inventario_fecha,inventario_hora,inventario_cantidad,inventario_ventas, inventario_pedidos,inventario_devoluciones,inventario_saldo,usuario_id,moneda_tc)
                    (select producto_id,detalleven_costo, date(now()),time(now()), detalleven_cantidad , 0, 0, 0, detalleven_cantidad, ".$usuario_id.", ".$moneda_tc." 
                    from detalle_venta_aux where usuario_id=".$usuario_vendedor.")";
            $this->Venta_model->ejecutar($sql);
            
            echo json_encode(TRUE);


        //**************** fin contenido ***************
        //}
    }   

    function numero_ventas(){
        //if($this->acceso(12)){
        //**************** inicio contenido ***************       

            $usuario_vendedor = $this->session_data['usuario_id'];
            $usuario_id = $this->input->post('usuario_id');


            $sql =  "select count(*)+1 as cantidad from venta where venta_fecha = date(now())";
            $res = $this->Venta_model->consultar($sql);
            
                        
            echo json_encode($res);


        //**************** fin contenido ***************        
    }   
    

    function ejecutar_consulta(){
        //if($this->acceso(12)){
        //**************** inicio contenido ***************       

//            $usuario_vendedor = $this->session_data['usuario_id'];
//            $usuario_id = $this->input->post('usuario_id');

            $sql = $this->input->post('sql');
            $this->Venta_model->ejecutar($sql);
            
                        
            echo json_encode(1);


        //**************** fin contenido ***************        
    }   
    
    function ejecutar_cambiarcantidad(){
        //if($this->acceso(12)){
        //**************** inicio contenido ***************       

//            $usuario_vendedor = $this->session_data['usuario_id'];
//            $usuario_id = $this->input->post('usuario_id');

            $sql = $this->input->post('sql');
            $this->Venta_model->ejecutar($sql);
            
            if($this->parametros['parametro_rangoprecios'] == 1){ //si la venta es por cantidad
                
                $sql = "update detalle_venta_aux d, rango_precios r
                        set 
                        d.detalleven_precio = r.rango_precio,
                        d.`detalleven_descuentoparcial` = r.rango_descuento
                        where
                        r.producto_id = 217 and d.detalleven_cantidad >= r.rango_desde and d.detalleven_cantidad <= r.rango_hasta";
                $detalleven_id = $this->Venta_model->ejecutar($sql);
                
            }
                        
            echo json_encode(1);


        //**************** fin contenido ***************        
    }   
    
    //Muestra la lista de vencimientos
    function vencimientos()
    {
        
        if($this->acceso(30)) {
            
            $data['sistema'] = $this->sistema;   

            //**************** inicio contenido ***************            
            $usuario_id = $this->session_data['usuario_id'];
            $usuario_nombre = $this->session_data['usuario_nombre'];
            $tipousuario_id = $this->session_data['tipousuario_id'];

            $rolusuario = $this->session_data['rol'];

            $data['esrol'] = $rolusuario[33-1]['rolusuario_asignado'];
            $data['esrolconsolidar'] = $rolusuario[35-1]['rolusuario_asignado'];
            $data['empresa'] = $this->Empresa_model->get_empresa(1); 

            $data['page_title'] = "Vencimientos"
                    . "";
            $data['usuario'] = $this->Usuario_model->get_todos_usuario(); // para el select
            $data['usuario_id'] = $usuario_id; //el usuario logueado

            $data['tipousuario_id'] = $tipousuario_id; 
            $data['usuario_nombre'] = $usuario_nombre;

            $data['estado'] = $this->Estado_model->get_tipo_estado(5);

            $data['_view'] = 'venta/vencimientos';
            $this->load->view('layouts/main',$data);
            //**************** fin contenido ***************
        }    
    }
    
    function lista_vencimientos(){
        
        if($this->acceso(12)){
        //**************** inicio contenido ***************       
        
            $fecha_desde = $this->input->post("fecha_desde");
            $fecha_hasta = $this->input->post("fecha_hasta");
            $usuario_id = $this->input->post("usuario_id");

            $resultado = $this->Venta_model->get_vencimientos($fecha_desde,$fecha_hasta,$usuario_id);
            echo json_encode($resultado);
        }
        else
        {
            $data['_view'] = 'login/mensajeacceso';
            $this->load->view('layouts/main',$data);
        }
        
   }

    //Muestra la lista de vencimientos
    function prestamos(){
        
        if($this->acceso(30)) {
            
            //**************** inicio contenido ***************
            $data['sistema'] = $this->sistema;   

            $usuario_id = $this->session_data['usuario_id'];
            $usuario_nombre = $this->session_data['usuario_nombre'];
            $tipousuario_id = $this->session_data['tipousuario_id'];

            $rolusuario = $this->session_data['rol'];

            $data['esrol'] = $rolusuario[33-1]['rolusuario_asignado'];
            $data['esrolconsolidar'] = $rolusuario[35-1]['rolusuario_asignado'];
            $data['empresa'] = $this->Empresa_model->get_empresa(1); 

            $data['page_title'] = "Envases y Prestamos"
                    . "";
            $data['usuario'] = $this->Usuario_model->get_todos_usuario(); // para el select
            //$data['tipo_transaccion'] = $this->Tipo_transaccion_model->get_all_tipo(); //para el select
            $data['usuario_id'] = $usuario_id; //el usuario logueado

            $data['tipousuario_id'] = $tipousuario_id; 
            $data['usuario_nombre'] = $usuario_nombre;

            $data['estado'] = $this->Estado_model->get_tipo_estado(5);
            
            $data['parametro'] = $this->Parametro_model->get_parametros();
            
            $data['moneda'] = $this->Moneda_model->get_moneda(2); //Obtener moneda extragera
            $data['lamoneda'] = $this->Moneda_model->getalls_monedasact_asc();
            
            $data['_view'] = 'venta/prestamos';
            $this->load->view('layouts/main',$data);
            //**************** fin contenido ***************
            
        }    
    }

    //Muestra la lista de vencimientos
    function envases_prestados($producto_id)
    {
        
        if($this->acceso(30)) {
                
            //**************** inicio contenido ***************  
            $data['sistema'] = $this->sistema;
            $usuario_id = $this->session_data['usuario_id'];
            $usuario_nombre = $this->session_data['usuario_nombre'];
            $tipousuario_id = $this->session_data['tipousuario_id'];

            $rolusuario = $this->session_data['rol'];

            $data['esrol'] = $rolusuario[33-1]['rolusuario_asignado'];
            $data['esrolconsolidar'] = $rolusuario[35-1]['rolusuario_asignado'];
            $data['empresa'] = $this->Empresa_model->get_empresa(1); 

            $data['page_title'] = "Envases y Prestamos";
            //$data['usuario'] = $this->Usuario_model->get_todos_usuario(); // para el select
            //$data['tipo_transaccion'] = $this->Tipo_transaccion_model->get_all_tipo(); //para el select

            $data['prestamos'] = $this->Venta_model->get_envasesprestados($producto_id); // para el select

            $data['usuario_id'] = $usuario_id; //el usuario logueado        
            $data['tipousuario_id'] = $tipousuario_id; 
            $data['usuario_nombre'] = $usuario_nombre;



            //$data['pedidosn'] = $this->Pedido_model->get_pedido_sin_nombre($usuario_id);
            $data['estado'] = $this->Estado_model->get_tipo_estado(5);

            $data['_view'] = 'venta/envases_prestados';
            $this->load->view('layouts/main',$data);
            //**************** fin contenido ***************
        }    
    }

    //Muestra la lista de vencimientos
    function inventario_envases()
    {
            if($this->acceso(30)) {
                
            //**************** inicio contenido ***************
            $data['sistema'] = $this->sistema;
            $usuario_id = $this->session_data['usuario_id'];
            $usuario_nombre = $this->session_data['usuario_nombre'];
            $tipousuario_id = $this->session_data['tipousuario_id'];

            $rolusuario = $this->session_data['rol'];

            $data['esrol'] = $rolusuario[33-1]['rolusuario_asignado'];
            $data['esrolconsolidar'] = $rolusuario[35-1]['rolusuario_asignado'];
            $data['empresa'] = $this->Empresa_model->get_empresa(1); 

            $rolusuario = $this->session_data['rol'];


            $data['empresa'] = $this->Empresa_model->get_empresa(1); 

            $data['page_title'] = "Inventario de Envases";

            $data['usuario'] = $this->Usuario_model->get_todos_usuario(); // para el select
            //$data['tipo_transaccion'] = $this->Tipo_transaccion_model->get_all_tipo(); //para el select

            $data['usuario_id'] = $usuario_id; //el usuario logueado        
            $data['tipousuario_id'] = $tipousuario_id; 
            $data['usuario_nombre'] = $usuario_nombre;
            //$this->load->model('Parametro_model');
            $data['parametro'] = $this->Parametro_model->get_parametros();
            //$this->load->model('Moneda_model');
            $data['moneda'] = $this->Moneda_model->get_moneda(2); //Obtener moneda extragera
            $data['lamoneda'] = $this->Moneda_model->getalls_monedasact_asc();
            $data['_view'] = 'venta/inventario_envases';
            $this->load->view('layouts/main',$data);
            //**************** fin contenido ***************
            
        }    
    }

    //Muestra la lista de vencimientos
    function buscar_inventarioenvases(){
        
        $data['sistema'] = $this->sistema;
        if($this->acceso(12)){
        //**************** inicio contenido ***************
            $resultado = $this->Venta_model->buscar_inventarioenvases();
            echo json_encode($resultado);
        }
        else
        {
            $data['_view'] = 'login/mensajeacceso';
            $this->load->view('layouts/main',$data);
        }
        
    }

    //Muestra la lista de vencimientos
    function buscar_inventario(){
        
        $data['sistema'] = $this->sistema;
        if($this->acceso(12)){
        //**************** inicio contenido ***************       

            $resultado = $this->Venta_model->get_prestamos($fecha_desde,$fecha_hasta,$usuario_id);
            
            echo json_encode($resultado);
        }
        else
        {
            $data['_view'] = 'login/mensajeacceso';
            $this->load->view('layouts/main',$data);
        }
        
   }   
    
    function lista_prestamos(){
        
        $data['sistema'] = $this->sistema;
        if($this->acceso(12)){
        //**************** inicio contenido ***************       
            
            $fecha_desde = $this->input->post("fecha_desde");
            $fecha_hasta = $this->input->post("fecha_hasta");
            $usuario_id = $this->input->post("usuario_id");
            $tipo_prestamo = $this->input->post("tipo_prestamo");
            $kardex = $this->input->post("kardex");
            $producto_id = $this->input->post("producto_id");
            
            if($kardex == 0){
                if ($tipo_prestamo==1)
                    $resultado = $this->Venta_model->get_prestamos($fecha_desde,$fecha_hasta,$usuario_id);
                else
                    $resultado = $this->Venta_model->get_devoluciones($fecha_desde,$fecha_hasta,$usuario_id);
            }
            else{
                    $resultado = $this->Venta_model->get_kardex($producto_id);
            }
            
            echo json_encode($resultado);
        }
        else
        {
            $data['_view'] = 'login/mensajeacceso';
            $this->load->view('layouts/main',$data);
        }
        
   }   

   function registrar_devolucion(){
        
       $data['sistema'] = $this->sistema;
        if($this->acceso(12)){
        //**************** inicio contenido ***************       
            $usuario_id = $this->session_data['usuario_id'];
            $detalleven_id = $this->input->post("detalleven_id");
            $cantidad = $this->input->post("detalleven_cantidadenvase");
            $garantia = $this->input->post("detalleven_garantiaenvase");

            $sql = "update detalle_venta set".
                    " detalleven_devueltoenvase = ".$cantidad.
                    ",detalleven_montodevolucion = ".$garantia.
                    ",detalleven_fechadevolucion = date(now()) ".
                    ",detalleven_horadevolucion = time(now()) ".
                    ",detalleven_usuario_id = ".$usuario_id.
                    " where detalleven_id = ".$detalleven_id;
            
            $this->Venta_model->ejecutar($sql);
            return true;
        }
        else
        {
            $data['_view'] = 'login/mensajeacceso';
            $this->load->view('layouts/main',$data);
        }
        
   }
   
   
   /* genera factura desde el index de ventas  */
    function generar_factura_detalle_aux()
    {
        if($this->acceso(12)){
            //$dosificacion = $this->Dosificacion_model->get_dosificacion_activa();
            $dosificacion = $this->Dosificacion_model->get_dosificacion(1);
            // PARA NUEVA FACTURACION
            //$parametro = $this->Parametro_model->get_parametros(); Se cambio por $parametros, variable global
            $empresa = $this->Empresa_model->get_empresa(1);
            $tamanio_hoja = 2;
            if($this->parametros['parametro_tipoimpresora'] == "FACTURADORA"){
                $tamanio_hoja = 1;
            }
            // PARA NUEVA FACTURACION
            
            $usuario_id = $this->session_data['usuario_id'];
            
            $venta_id = $this->input->post('venta_id');
            
            //RECUPERAR DATOS DE LA VENTA PARA INGRESAR A FACTURA
            $sql = "select * from factura where venta_id = ".$venta_id;
            $venta = $this->Venta_model->consultar($sql);
            
            $nit_factura = $this->input->post('numeroDocumento');
            $razon_social = $this->input->post('razon');
            
            $monto_factura = $this->input->post('monto_factura');
            
            $numero_factura = $dosificacion["dosificacion_numfact"]+1;
            $estado_id = 1;
            $fecha_venta = date('Y-m-d');
            $factura_fechaventa = $fecha_venta;
            $factura_fecha = "date(now())";
            $factura_hora = "time(now())";
            $factura_subtotal = $venta[0]["venta_subtotal"];//$monto_factura;
            $tipotrans_id = $venta[0]["tipotrans_id"]; //tipo de transaccion
            $forma_id = $venta[0]["forma_id"];//Forma de pago
            $factura_ice = 0;
            $factura_exento = 0;
            $factura_descuentoparcial = $venta[0]["venta_descuentoparcial"];
            $factura_descuento = $venta[0]["venta_descuento"];
            $factura_total = $venta[0]["venta_total"]; //$monto_factura;
            $factura_numero = $numero_factura;
            $factura_autorizacion = $dosificacion["dosificacion_autorizacion"];
            $factura_llave = $dosificacion["dosificacion_llave"];
            $factura_fechalimite = $dosificacion["dosificacion_fechalimite"];
            $factura_leyenda1 = $dosificacion["dosificacion_leyenda1"];
            $factura_leyenda2 = $dosificacion["dosificacion_leyenda2"];
            $factura_leyenda3 = $dosificacion["dosificacion_leyenda3"];
            $factura_leyenda4 = $dosificacion["dosificacion_leyenda4"];
            $factura_leyenda5 = $dosificacion["dosificacion_leyenda5"];
            $factura_nit = $nit_factura;
            $factura_razonsocial = $razon_social;
            $factura_nitemisor = $dosificacion["dosificacion_nitemisor"];
            $factura_sucursal = $dosificacion["dosificacion_sucursal"];
            $factura_sfc = $dosificacion["dosificacion_sfc"];
            $factura_actividad = $dosificacion["dosificacion_actividad"];
            $codigo_excepcion = 0;
            
            // PARA NUEVA FACTURACION
            if($this->parametros['parametro_tiposistema'] != 1){
                $cliente_codigo = $this->Cliente_model->get_codigo_cliente($nit_factura, $razon_social);
                $factura_tokendelegado   = $dosificacion['dosificacion_tokendelegado'];
                $factura_ambiente        = $dosificacion['dosificacion_ambiente'];
                $factura_cuis            = $dosificacion['dosificacion_cuis'];
                $factura_cufd            = $dosificacion['dosificacion_cufd'];
                $factura_modalidad       = $dosificacion['dosificacion_modalidad'];
                $factura_codsistema      = $dosificacion['dosificacion_codsistema'];
                $factura_puntoventa      = $dosificacion['dosificacion_puntoventa'];
                $factura_sectoreconomico = $dosificacion['dosificacion_sectoreconomico'];
                $factura_ruta            = $dosificacion['dosificacion_ruta'];
                $factura_tamanio         = $tamanio_hoja;
                $tipoDocumentoIdentidad  = $this->input->post('tipoDocumento');
                $documentoSector = $dosificacion['docsec_codigoclasificador'];
                $factura_fecha_hora = (new DateTime())->format('Y-m-d\TH:i:s.v');
                $facturaCufdCodControl = $this->Factura_model->get_cudf_activo($dosificacion['dosificacion_cufd']);
                $factura_clientecodigo = $cliente_codigo;
                //$fecha_hora_aux = date("YmdHis".substr((string)microtime(), 1, 4), strtotime($factura_fecha_hora));
            
                //$fecha_hora = "$anio$mes$dia$hora$min$seg$mseg";
                /*$anio = date("Y", strtotime($factura_fecha_hora));
                $mes  = date("m", strtotime($factura_fecha_hora));
                $dia  = date("d", strtotime($factura_fecha_hora));
                $hora = date("H", strtotime($factura_fecha_hora));
                $min  = date("i", strtotime($factura_fecha_hora));
                $seg  = date("s", strtotime($factura_fecha_hora));
                $miliseg1  = date(substr((string)microtime(), 1, 4), strtotime($factura_fecha_hora));
                $miliseg = str_replace(".", "", $miliseg1);
                echo $miliseg."WW";
                $fecha_hora = "$anio$mes$dia$hora$min$seg$miliseg";*/
                
                //$fecha_hora = str_replace(".", "", $fecha_hora_aux);
                $cadFechahora = str_replace("-", "", $factura_fecha_hora);
                $cadFechahora = str_replace("T", "", $cadFechahora);
                $cadFechahora = str_replace(":", "", $cadFechahora);
                $cadFechahora = str_replace(".", "", $cadFechahora);
                //echo $cadFechahora."QWE";
                //$fecha_hora = str_replace(".", "", $fecha_hora_aux);
                $tipo_emision = $this->parametros['parametro_tipoemision']; //Especifica si es linea o fuera de linea
                $tipo_factura = $dosificacion['tipofac_codigo'];
                $tipo_documento_sector = $dosificacion['docsec_codigoclasificador'];
                $pos = $dosificacion['dosificacion_puntoventa'];
                /*
                echo "Fecha que se guarda :".$factura_fecha_hora."<br>";
                echo "Fecha hora para cuf :".$fecha_hora."<br>";
                echo "Nit :".$factura_nitemisor."<br>";
                echo "fecha hora :".$fecha_hora."<br>";
                echo "Sucursal :".$factura_sucursal."<br>";
                echo "Modalidad :".$factura_modalidad."<br>";
                echo "tipo Emision :".$tipo_emision."<br>";
                echo "Tipo Factura :".$tipo_factura."<br>";
                echo "Tipo Doc Sector :".$tipo_documento_sector."<br>";
                echo "Factura numero :".$factura_numero."<br>";
                echo "Pos :".$pos."<br>";
                echo "Cod Control :".$facturaCufdCodControl['cufd_codigocontrol']."<br><br><br><br>";
                */
                // LLAMANDO AL HELPER
                $factura_cuf = generarCuf(trim($factura_nitemisor),
                                        trim($cadFechahora),
                                        trim($factura_sucursal),
                                        trim($factura_modalidad),
                                        trim($tipo_emision),
                                        trim($tipo_factura),
                                        trim($tipo_documento_sector),
                                        trim($factura_numero),
                                        trim($pos),
                                        trim($facturaCufdCodControl['cufd_codigocontrol']));
                
        
                $fecha_hora = $factura_fecha_hora;
            }
            // PARA NUEVA FACTURACION
            $factura_efectivo = $factura_total;
            $factura_cambio = 0;
            
            $factura_codigocontrol = $this->codigo_control($factura_llave, $factura_autorizacion, $factura_numero, $factura_nit, $factura_fechaventa, $factura_total);
            
            $sql = "update dosificacion set dosificacion_numfact = ".$factura_numero;
            $this->Venta_model->ejecutar($sql);
            
            
            if($this->parametros['parametro_tiposistema'] == 1){ //1 = istema de facturacion computarizado
                // antiguo sistema de facturacion
                $sql = "insert into factura(estado_id, factura_fechaventa, 
                        factura_fecha, factura_hora, factura_subtotal, 
                        factura_ice, factura_exento, factura_descuentoparcial,factura_descuento, factura_total, 
                        factura_numero, factura_autorizacion, factura_llave, 
                        factura_fechalimite, factura_codigocontrol, factura_leyenda1, factura_leyenda2,
                        factura_nit, factura_razonsocial, factura_nitemisor, factura_sucursal, factura_sfc, factura_actividad, usuario_id, venta_id,
                        factura_efectivo, factura_cambio, tipotrans_id, factura_leyenda3, factura_leyenda4, forma_id) value(".
                        $estado_id.",'".$factura_fechaventa."',".
                        $factura_fecha.",".$factura_hora.",".$factura_subtotal.",".
                        $factura_ice.",".$factura_exento.",".$factura_descuentoparcial.",".$factura_descuento.",".$factura_total.",".
                        $factura_numero.",".$factura_autorizacion.",'".$factura_llave."','".    
                        $factura_fechalimite."','".$factura_codigocontrol."','".$factura_leyenda1."','".$factura_leyenda2."','".
                        $factura_nit."','".$factura_razonsocial."','".$factura_nitemisor."','".
                        $factura_sucursal."','".$factura_sfc."','".$factura_actividad."',".$usuario_id.",".$venta_id.",".
                        $factura_efectivo.",".$factura_cambio.",".$tipotrans_id.",'".$factura_leyenda1."','".$factura_leyenda2."',".$forma_id.")";
            }else{
                
                        $leyendas = $this->Venta_model->consultar("select * from leyenda");
                        $valor = rand(0,7);
                        $factura_leyenda2 = $leyendas[$valor]["leyenda_descripcion"];
                   
                        if ($tipo_emision==2){    
                          $factura_leyenda3 =  $factura_leyenda5;
                          $factura_cafc = $dosificacion['dosificacion_ruta'];
                        }else{
                            $factura_cafc = "";
                        }
                        
                // nuevo sistema de facturacion
                $sql = "insert into factura(estado_id,forma_id, factura_fechaventa, 
                        factura_fecha, factura_hora, factura_subtotal, 
                        factura_ice, factura_exento, factura_descuentoparcial, factura_descuento, factura_total, 
                        factura_numero, factura_autorizacion, factura_llave, 
                        factura_fechalimite, factura_codigocontrol, factura_leyenda1, factura_leyenda2,
                        factura_nit, factura_razonsocial, factura_nitemisor, factura_sucursal, factura_sfc, factura_actividad, usuario_id, venta_id,
                        factura_efectivo, factura_cambio, tipotrans_id, factura_tokendelegado,
                        factura_ambiente, factura_cuis, factura_cufd, factura_modalidad,
                        factura_codsistema, factura_puntoventa, factura_sectoreconomico,
                        factura_ruta, factura_tamanio,factura_cuf,factura_fechahora,cdi_codigoclasificador,
                        docsec_codigoclasificador, factura_codigocliente, factura_leyenda1, factura_leyenda2, factura_excepcion, forma_id, factura_cafc) value(".
                        $estado_id.",".$forma_id.",'".$factura_fechaventa."',".
                        $factura_fecha.",".$factura_hora.",".$factura_subtotal.",".
                        $factura_ice.",".$factura_exento.",".$factura_descuentoparcial.",".$factura_descuento.",".$factura_total.",".
                        $factura_numero.",".$factura_autorizacion.",'".$factura_llave."','".
                        $factura_fechalimite."','".$factura_codigocontrol."','".$factura_leyenda1."','".$factura_leyenda2."','".
                        $factura_nit."','".$factura_razonsocial."','".$factura_nitemisor."','".
                        $factura_sucursal."','".$factura_sfc."','".$factura_actividad."',".$usuario_id.",".$venta_id.",".
                        $factura_efectivo.",".$factura_cambio.",".$tipotrans_id.",'".$factura_tokendelegado."','".
                        $factura_ambiente."','".$factura_cuis."','".$factura_cufd."','".$factura_modalidad."','".
                        $factura_codsistema."','".$factura_puntoventa."','".$factura_sectoreconomico."','".
                        $factura_ruta."','".$factura_tamanio."','$factura_cuf','$fecha_hora',$tipoDocumentoIdentidad,$documentoSector,'$factura_clientecodigo'".
                        ",'".$factura_leyenda3."','".$factura_leyenda4."',".$codigo_excepcion.",".$forma_id.",'".$factura_cafc."')";
            }


            $factura_id = $this->Venta_model->ejecutar($sql);
            
            $this->load->model('Detalle_factura_aux_model');
            $all_detalle_factura_aux = $this->Detalle_factura_aux_model->getall_detalle_factura_aux($venta_id);
            
            foreach($all_detalle_factura_aux as $detalle_fact){
                $params = array(
                    'producto_id' => $detalle_fact['producto_id'],
                    'venta_id' => $detalle_fact['venta_id'],
                    'factura_id' => $factura_id,
                    'detallefact_cantidad' => $detalle_fact['detallefact_cantidad'],
                    'detallefact_codigo' => $detalle_fact['detallefact_codigo'],
                    'detallefact_unidad' => $detalle_fact['detallefact_unidad'],
                    'detallefact_descripcion' => $detalle_fact['detallefact_descripcion'],
                    'detallefact_precio' => $detalle_fact['detallefact_precio'],
                    'detallefact_subtotal' => $detalle_fact['detallefact_subtotal'],
                    'detallefact_descuentoparcial' => $detalle_fact['detallefact_descuentoparcial'],
                    'detallefact_descuento' => $detalle_fact['detallefact_descuento'],
                    'detallefact_total' => $detalle_fact['detallefact_total'],
                    'detallefact_preferencia' => $detalle_fact['detallefact_preferencia'],
                    'detallefact_caracteristicas' => $detalle_fact['detallefact_caracteristicas'],
                    'usuario_id' => $usuario_id,
                );
                $detallefact_id = $this->Detalle_factura_aux_model->add_detalle_factura_aux($params);
            }
                        
            $this->Detalle_factura_aux_model->delete_detalleventa_factura_aux($venta_id);
            
            if($venta_id>0){
                $sql = "update venta set venta_tipodoc = 1 where venta_id = ".$venta_id;
                $this->Venta_model->ejecutar($sql);
            }
            if($this->parametros['parametro_tiposistema'] != 1){// para cualquiera que no sea Sistema de facturacion computarizado (computarizado en linea o electronico)
                // el parametro uno es para computarizada en linea ojo
                // $computarizada_enlinea = 1;
                $computarizada_enlinea = $this->parametros['parametro_tiposistema'];
                $factura = $this->Factura_model->get_factura_id($factura_id);
                $detalle_factura = $this->Detalle_venta_model->get_detalle_factura_id($factura_id);
                $empresa = $this->Empresa_model->get_empresa(1);
                
                $xml = generarfacturaCompra_ventaXML($computarizada_enlinea, $factura, $detalle_factura, $empresa);

                $base_url = explode('/', base_url());
                //$doc_xml = site_url("resources/xml/$archivoXml.xml");
                $directorio_factura = $_SERVER['DOCUMENT_ROOT'].'/'.$base_url[3].'/resources/xml/';
                $xsd = $this->nombre_archivo.".xsd";
                $valXSD = new ValidacionXSD();
                
                if(!$valXSD->validar("$directorio_factura/".$this->nombre_archivo.$factura[0]['factura_id']."xml",$directorio_factura.$xsd)){
                    // echo "No ingreso";
                    print $valXSD->mostrarError();
                }else{
                    // COMPRESION XML EN GZIP
                    $datos = implode("", file($directorio_factura.$this->nombre_archivo.$factura[0]['factura_id'].".xml"));
                    $gzdata = gzencode($datos, 9);
                    $fp = fopen($directorio_factura.$this->nombre_archivo.$factura[0]['factura_id'].".xml.zip", "w");
                    // $xml_gzip = fopen($directorio_factura.$this->nombre_archivo.$factura[0]['factura_id'].".xml.zip", "r");
                    fwrite($fp, $gzdata);
                    fclose($fp);
                    
                    
                    if($tipo_emision == 2){
                        $p = new PharData($directorio_factura.$this->nombre_archivo.$factura[0]['factura_id'].'.tar');
                        $p[$this->nombre_archivo.$factura[0]['factura_id'].'.xml'] = $datos;
                        $p1 = $p->compress(Phar::GZ);
                    }
                    
                    $handle = fopen($directorio_factura.$this->nombre_archivo.$factura[0]['factura_id'].".xml.zip", "rb");
                    $contents = fread($handle, filesize($directorio_factura.$this->nombre_archivo.$factura[0]['factura_id'].".xml.zip"));
                    fclose($handle);

                    
                    $xml_comprimido = hash_file('sha256',$directorio_factura.$this->nombre_archivo.$factura[0]['factura_id'].".xml.zip");

                    $dosificacion = $this->Dosificacion_model->get_dosificacion(1);
                    $wsdl = $dosificacion['dosificacion_factura'];
                    $token = $dosificacion['dosificacion_tokendelegado'];
                    $comunicacion = $this->verificar_comunicacion($token,$wsdl);
                    
                    if($comunicacion){
                        $enviada = $this->mandarFactura($contents, $xml_comprimido);
                        //var_dump($enviada->transaccion);
                        //var_dump($enviada);
                        if($enviada->transaccion){
                            $params = array(
                                'factura_codigodescripcion' => $enviada->codigoDescripcion,
                                'factura_codigoestado'    => $enviada->codigoEstado,
                                'factura_codigorecepcion' => $enviada->codigoRecepcion,
                                'factura_transaccion'    => $enviada->transaccion,
                            );
                            $this->Factura_model->update_factura($factura_id, $params);
                        }else{
                            $cad = $enviada->mensajesList;
                            //var_dump($cad);
//                            $mensajecadena = "";
//                            foreach ($cad as $c) {
//                                $mensajecadena .= $c.";";
//                            }
//                            
                            $mensajecadena = "";
                            foreach ($cad as $c) {
                                $mensajecadena .= $c->codigo.", ".$c->descripcion." | ";
                            }
                            $params = array(
                                'factura_codigodescripcion' => $enviada->codigoDescripcion,
                                'factura_codigoestado' => $enviada->codigoEstado,
                                'factura_mensajeslist' => $mensajecadena, //$enviada->mensajesList,
                                'factura_transaccion'  => $enviada->transaccion,
                            );
                            $this->Factura_model->update_factura($factura_id, $params);
                        }
                    }
                    
                }
            }
        
            echo json_encode($factura_id);
        //**************** fin contenido ***************
        }
    }
    
    function array_to_xml($array_to_xml, &$xml) {
        foreach($array_to_xml as $key => $value) {
            if(is_array($value)) {
                if(!is_numeric($key)){
                    $subnode = $xml->addChild("$key");
                    $this->array_to_xml($value, $subnode);
                }else{
                    $subnode = $xml->addChild("$value");
                    $this->array_to_xml($value, $subnode);
                }
            }else {
                $xml->addChild("$key",htmlspecialchars("$value"));
            }
        }
        return $xml;
    }

    /* genera factura desde el index de servicios con sus detalles */
    function generar_factura_detalle_servicio()
    {
        if($this->acceso(12)){
            //$dosificacion = $this->Dosificacion_model->get_dosificacion_activa();
            $dosificacion = $this->Dosificacion_model->get_dosificacion(1);

            $usuario_id = $this->session_data['usuario_id'];
            
            //$venta_id = $this->input->post('venta_id');
            
            $nit_factura = $this->input->post('nit');
            $razon_social = $this->input->post('razon_social');
            
            $llave_foranea = $this->input->post('llave_foranea');            
            $llave_valor = $this->input->post('llave_valor');
            
            $tipotrans_id = 1;
            if ($llave_foranea=="venta_id"){
                $venta_id = $llave_valor;
            }
            else{
                $venta_id = 0;
            }
            $monto_factura = $this->input->post('detalle_precio');
            
            $numero_factura = $dosificacion["dosificacion_numfact"]+1;
            $estado_id = 1;
            $fecha_venta = date('Y-m-d');
            $factura_fechaventa = $fecha_venta;
            $factura_fecha = "date(now())";
            $factura_hora = "time(now())";
            $factura_subtotal = $monto_factura;
            $factura_ice = 0;
            $factura_exento = 0;
            $factura_descuentoparcial = 0;
            $factura_descuento = 0;
            $factura_total = $monto_factura;
            $factura_numero = $numero_factura;
            $factura_autorizacion = $dosificacion["dosificacion_autorizacion"];
            $factura_llave = $dosificacion["dosificacion_llave"];
            $factura_fechalimite = $dosificacion["dosificacion_fechalimite"];
            $factura_leyenda1 = $dosificacion["dosificacion_leyenda1"];
            $factura_leyenda2 = $dosificacion["dosificacion_leyenda2"];
            $factura_leyenda3 = $dosificacion["dosificacion_leyenda3"];
            $factura_leyenda4 = $dosificacion["dosificacion_leyenda4"];
            $factura_nit = $nit_factura;
            $factura_razonsocial = $razon_social;
            $factura_nitemisor = $dosificacion["dosificacion_nitemisor"];
            $factura_sucursal = $dosificacion["dosificacion_sucursal"];
            $factura_sfc = $dosificacion["dosificacion_sfc"];
            $factura_actividad = $dosificacion["dosificacion_actividad"];
            
            $factura_efectivo = $factura_total;
            $factura_cambio = 0;
          
            $factura_codigocontrol = $this->codigo_control($factura_llave, $factura_autorizacion, $factura_numero, $factura_nit, $factura_fechaventa, $factura_total);
            
            $sql = "update dosificacion set dosificacion_numfact = ".$factura_numero;
            $this->Venta_model->ejecutar($sql);
            
            $sql = "insert into factura(estado_id, forma_id, factura_fechaventa, 
                    factura_fecha, factura_hora, factura_subtotal, 
                    factura_ice, factura_exento, factura_descuentoparcial, factura_descuento, factura_total, 
                    factura_numero, factura_autorizacion, factura_llave, 
                    factura_fechalimite, factura_codigocontrol, factura_leyenda1, factura_leyenda2,
                    factura_nit, factura_razonsocial, factura_nitemisor, factura_sucursal, factura_sfc, factura_actividad, usuario_id, ".$llave_foranea.",
                    factura_efectivo, factura_cambio, tipotrans_id, factura_leyenda3, factura_leyenda4) value(".
                    $estado_id.",".$forma_id.",'".$factura_fechaventa."',".
                    $factura_fecha.",".$factura_hora.",".$factura_subtotal.",".
                    $factura_ice.",".$factura_exento.",".$factura_descuentoparcial.",".$factura_descuento.",".$factura_total.",".
                    $factura_numero.",".$factura_autorizacion.",'".$factura_llave."','".
                    $factura_fechalimite."','".$factura_codigocontrol."','".$factura_leyenda1."','".$factura_leyenda2."','".
                    $factura_nit."','".$factura_razonsocial."','".$factura_nitemisor."','".
                    $factura_sucursal."','".$factura_sfc."','".$factura_actividad."',".$usuario_id.",".$llave_valor.",".
                    $factura_efectivo.",".$factura_cambio.",".$tipotrans_id.",'".$factura_leyenda3."','".$factura_leyenda4."')";

            $factura_id = $this->Venta_model->ejecutar($sql);
            
            $this->load->model('Detalle_serv_model');
            $all_detalle_servicio_factura = $this->Detalle_serv_model->get_thisdetalle_serv_forfactura($llave_valor);
            //$all_detalle_factura_aux = $this->Detalle_factura_aux_model->getall_detalle_factura_aux($venta_id);
            $parametro_serviciofact = $this->input->post('parametro_serviciofact');
            $detalle_servfact = "";
            foreach($all_detalle_servicio_factura as $detalle_fact){
                if($parametro_serviciofact == 1){
                    $detalle_servfact = $detalle_fact['detalleserv_solucion'];
                }elseif($parametro_serviciofact == 2){
                    $detalle_servfact = $detalle_fact['detalleserv_descripcion'];
                }elseif($parametro_serviciofact == 3){
                    $detalle_servfact = $detalle_fact['detalleserv_solucion'].", ".$detalle_fact['detalleserv_descripcion'];
                }elseif($parametro_serviciofact == 4){
                    $detalle_servfact = $detalle_fact['detalleserv_descripcion'].", ".$detalle_fact['detalleserv_solucion'];
                }
                $params = array(
                'producto_id' => 0,
                'venta_id' => 0,
                'factura_id' => $factura_id,
                'detallefact_cantidad' => 1,
                'detallefact_codigo' => '',
                'detallefact_unidad' => 'UNIDAD',
                'detallefact_descripcion' => $detalle_servfact,
                'detallefact_precio' => $detalle_fact['detalleserv_total'],
                'detallefact_subtotal' => $detalle_fact['detalleserv_total'],
                'detallefact_descuento' => 0,
                'detallefact_total' => $detalle_fact['detalleserv_total'],
                'detallefact_preferencia' => '',
                'detallefact_caracteristicas' => '',
                'usuario_id' => $usuario_id,
            );
                
            $this->load->model('Detalle_factura_aux_model');
            $detallefact_id = $this->Detalle_factura_aux_model->add_detalle_factura_aux($params);
            }
                        
            if($venta_id>0){
                $sql = "update venta set venta_tipodoc = 1 where venta_id = ".$venta_id;
                $this->Venta_model->ejecutar($sql);
            }
            
            echo json_encode($factura_id);
      
        //**************** fin contenido ***************
        }
    }
    function modificar_usuariovendedor()
    {
        if ($this->input->is_ajax_request()) {
            
            $esteusuario_id = $this->input->post('esteusuario_id');   
            $venta_id = $this->input->post('venta_id');   
            if ($esteusuario_id!=""){
                $params = array(
                    'usuario_id' => $esteusuario_id,
                );
                $this->Venta_model->update_venta($venta_id, $params);
                echo json_encode("ok");
            }
            else echo json_encode(null);
        }else{                 
            show_404();
        }              
    }
    
    function modificar_precios()
    {
        if ($this->input->is_ajax_request()) {
            
            $producto_id = $this->input->post('producto_id');
            $producto_costo = $this->input->post('producto_costo');
            $producto_precio = $this->input->post('producto_precio');
            

//            $sql = "update producto set producto_costo = ".$producto_costo.", producto_precio = ".$producto_precio.
//                    " where producto_id = ".$producto_id;
//            $this->Venta_model->ejecutar($sql);
            
            $sql = "update producto set producto_costo = ".$producto_costo.", producto_precio = ".$producto_precio.
                    " where producto_id = ".$producto_id;
            $this->Venta_model->ejecutar($sql);
            
            $sql = "update inventario set producto_costo = ".$producto_costo.", producto_precio = ".$producto_precio.
                    " where producto_id = ".$producto_id;
            $this->Venta_model->ejecutar($sql);
            
            echo json_encode("true");
            
        }else{                 
            show_404();
        }              
    }
    
    function clasificador_producto(){
        
        $producto_id = $this->input->post('producto_id');
//        $detallecomp_id = $this->input->post('detallecomp_id');
//        
        $sql = "select * from clasificador c, clasificador_producto t
                where                 
                t.producto_id = ".$producto_id." and c.clasificador_id = t.clasificador_id ";
        
        $resultado = $this->Venta_model->consultar($sql);
        echo json_encode($resultado);  
        
    }

    function registrar_clasificador(){
        
        $clasificador_id = $this->input->post('clasificador_id');
        $detalleven_id = $this->input->post('detalleven_id');
        
        $sql = "update detalle_venta_aux set clasificador_id = ".$clasificador_id.
               " where detalleven_id = ".$detalleven_id;
        
        $this->Venta_model->ejecutar($sql);
        echo json_encode(true);  
        
    }

    function seleccionar_tipocliente(){
        
        $tipocliente_id = $this->input->post('tipocliente_id');
        
        $sql = "select * from tipo_cliente where tipocliente_id = ".$tipocliente_id;
        
        $resultado = $this->Venta_model->consultar($sql);
        echo json_encode($resultado);  
        
    }

    function detalle_composicion(){
        
        $detalleven_id = $this->input->post('detalleven_id');
        
        $sql = "select d.*, p.producto_nombre, p.producto_codigobarra from detalle_composicion_aux d, inventario p
                where  d.producto_id = p.producto_id and detalleven_id = ".$detalleven_id;
        
        $resultado = $this->Venta_model->consultar($sql);
        echo json_encode($resultado);  
        
    }
    /* modifica la fecha y hora de venta!.. */
    function modificar_fechahora()
    {
        if ($this->input->is_ajax_request()) {
            $venta_id = $this->input->post('venta_id');   
            $la_fecha = $this->input->post('la_fecha');   
            $la_hora  = $this->input->post('la_hora');
            $params = array(
                'venta_fecha' => $la_fecha,
                'venta_hora' => $la_hora,
            );
            $this->Venta_model->update_venta($venta_id, $params);
            echo json_encode("ok");
        }else{                 
            show_404();
        }              
    }
    
    function registrar_puntos()
    {
        if ($this->input->is_ajax_request()) {
            $cliente_id = $this->input->post('cliente_id');   
            $venta_total = $this->input->post('venta_total');
            $esteparametro = $this->Parametro_model->get_parametros();
            $cliente = $this->Cliente_model->get_cliente($cliente_id);
            $puntos = $cliente['cliente_puntos']+($esteparametro[0]['parametro_puntos']*$venta_total);
            $params = array(
                'cliente_puntos' => $puntos,
            );
            $this->Cliente_model->update_cliente($cliente_id, $params);
            echo json_encode("ok");
        }else{                 
            show_404();
        }              
    }
    /**
     * Enviar factura a impuestos
     */
    function mandarFactura($el_archivo, $hash_archivo){
        
        static $array;
        // $sincronizacion_id = $this->input->post('codigo_sincronizar');
        if(!isset($array['dosificacion'])){
            
            $dosificacion_id = 1;
            $dosificacion = $this->Dosificacion_model->get_dosificacion($dosificacion_id);
            $array['dosificacion'] = $dosificacion;
            
        }else{
            $dosificacion = $array['dosificacion'];
        }

        
        if ($dosificacion['docsec_codigoclasificador']==1 )
               $wsdl = $dosificacion['dosificacion_factura'];
        
        //*************************************************************************
        //       SERVICIOS FACTURACION ELECTRONICA
        //*************************************************************************
        $documentos_sector = array(2,6,8,11,12,16,17,23,39,51);
            
        if ($dosificacion['dosificacion_modalidad']==1){ //Electronica en linea
            
            
            
            if (in_array($dosificacion['docsec_codigoclasificador'], $documentos_sector))  
                $wsdl = $dosificacion['dosificacion_glpelectronica'];
            

            
            if ($dosificacion['docsec_codigoclasificador']==13)
                $wsdl = $dosificacion['dosificacion_facturaservicios'];
            
            
            if ($dosificacion['docsec_codigoclasificador']==15)
                $wsdl = $dosificacion['dosificacion_entidadesfinancieras'];
            
            if ($dosificacion['docsec_codigoclasificador']==22)
                $wsdl = $dosificacion['dosificacion_telecomunicaciones'];
            
            
        }
        
        //*************************************************************************
        //       SERVICIOS FACTURACION COMPUTARIZADA
        //*************************************************************************        
        if ($dosificacion['dosificacion_modalidad']==2){ // Computarizada en linea
            
            if (in_array($dosificacion['docsec_codigoclasificador'], $documentos_sector))  
                $wsdl = $dosificacion['dosificacion_facturaglp'];

            if ($dosificacion['docsec_codigoclasificador']==13)
                $wsdl = $dosificacion['dosificacion_facturaservicios'];
                        
            if ($dosificacion['docsec_codigoclasificador']==15)
                $wsdl = $dosificacion['dosificacion_facturaservicios'];
        
            if ($dosificacion['docsec_codigoclasificador']==22 )
                $wsdl = $dosificacion['dosificacion_telecomunicaciones'];
            
            
            
        }
        
        
        $token = $dosificacion['dosificacion_tokendelegado'];

        $usuario_id = $this->session_data['usuario_id'];
        $puntoventa = $this->Usuario_model->get_punto_venta_usuario($usuario_id);
        $this->load->model('PuntoVenta_model');
        $punto_venta = $this->PuntoVenta_model->get_puntoventa($puntoventa['puntoventa_codigo']);
        /*$comunicacion = $this->verificar_comunicacion($token,$wsdl);
        if($comunicacion){*/
        

                        
            $fecha_envio = date('Y-m-d\TH:i:s.v');
            $parametros = ["SolicitudServicioRecepcionFactura" => [
                "codigoAmbiente"        => $dosificacion['dosificacion_ambiente'],   // Producción: 1 Pruebas y Piloto: 2
                "codigoDocumentoSector" => $dosificacion['docsec_codigoclasificador'], //documento_sector: para compra y venta es 1
                "codigoEmision"         =>  "1", //$dosificacion['dosificacion_ambiente'],   //Describe si la emisión se realizó en línea. El valor permitido es: Online: 1
                "codigoModalidad"       => $dosificacion['dosificacion_modalidad'],  //Uno (1) Electrónica  y dos (2) Computarizada en línea
                "codigoPuntoVenta"      => $punto_venta['puntoventa_codigo'], //$dosificacion['dosificacion_puntoventa'], //se realiza utilizando un punto de venta. Caso contrario enviar 0.
                "codigoSistema"         => $dosificacion['dosificacion_codsistema'],
                "codigoSucursal"        => $dosificacion['dosificacion_codsucursal'],
                "cufd"                  => $punto_venta['cufd_codigo'], //$dosificacion['dosificacion_cufd'],
                "cuis"                  => $punto_venta['cuis_codigo'], //$dosificacion['dosificacion_cuis'],
                "nit"                   => $dosificacion['dosificacion_nitemisor'],
                "tipoFacturaDocumento"  => $dosificacion['tipofac_codigo'], //1 con derecho a credito fiscal / 2 Sin derecho a credito fiscal
                "archivo"               => $el_archivo,
                "fechaEnvio"            => $fecha_envio,
                "hashArchivo"           => $hash_archivo,
            ]];
        
//                echo  
//                "wsdl: ".$wsdl."<br>".
//                "codigoAmbiente: "        .$dosificacion['dosificacion_ambiente']."<br>".   // Producción: 1 Pruebas y Piloto: 2
//                "codigoDocumentoSector: " .$dosificacion['docsec_codigoclasificador']."<br>". //documento_sector: para compra y venta es 1
//                "codigoEmision: "         .  "1"."<br>". //$dosificacion['dosificacion_ambiente']."<br>".   //Describe si la emisión se realizó en línea. El valor permitido es: Online: 1
//                "codigoModalidad: "       . $dosificacion['dosificacion_modalidad']."<br>".  //Uno (1) Electrónica  y dos (2) Computarizada en línea
//                "codigoPuntoVenta: "      . $punto_venta['puntoventa_codigo']."<br>". //$dosificacion['dosificacion_puntoventa']."<br>". //se realiza utilizando un punto de venta. Caso contrario enviar 0.
//                "codigoSistema: "         . $dosificacion['dosificacion_codsistema']."<br>".
//                "codigoSucursal: "        . $dosificacion['dosificacion_codsucursal']."<br>".
//                "cufd: "                  . $punto_venta['cufd_codigo']."<br>". //$dosificacion['dosificacion_cufd']."<br>".
//                "cuis: "                  . $punto_venta['cuis_codigo']."<br>". //$dosificacion['dosificacion_cuis']."<br>".
//                "nit: "                   . $dosificacion['dosificacion_nitemisor']."<br>".
//                "tipoFacturaDocumento: "  . $dosificacion['tipofac_codigo']."<br>".
//                "archivo: "               . $el_archivo."<br>".
//                "fechaEnvio: "            . $fecha_envio."<br>".
//                "hashArchivo: "           . $hash_archivo;    
//            
            //var_dump($parametros);
        //}
        
        try{
            
            $opts = array(
                'http' => array(
                    'header' => "apiKey: TokenApi $token"
                )
            );
            //var_dump($wsdl);
            //var_dump($opts);

            $context = stream_context_create($opts);
            $cliente = new \SoapClient($wsdl, [
                'stream_context'    => $context,
                'cache_wsdl'        => WSDL_CACHE_NONE,
                'compression'       => SOAP_COMPRESSION_ACCEPT | SOAP_COMPRESSION_GZIP | SOAP_COMPRESSION_DEFLATE,    
            ]);

            //var_dump($parametros);    
            $resultado = $cliente->recepcionFactura($parametros);
            //var_dump($resultado);
            
            $mensaje = $resultado->RespuestaServicioFacturacion;
            return $mensaje;
            
        }catch(Exception $e){
            var_dump("FALLA: No se realizo la sincronizacion");
            return false;
        }

    }

    function verificar_comunicacion($token,$wsdl){
        
        try{
            $opts = array(
                'http' => array(
                    'header' => "apiKey: TokenApi $token"
                )
            );

            $context = stream_context_create($opts);
            $cliente = new \SoapClient($wsdl, [
                'stream_context'    => $context,
                'cache_wsdl'        => WSDL_CACHE_NONE,
                'compression'       => SOAP_COMPRESSION_ACCEPT | SOAP_COMPRESSION_GZIP | SOAP_COMPRESSION_DEFLATE,    
            ]);
            
            $resultados = $cliente->verificarComunicacion();

            $transaccion = $resultados->return->transaccion; //
            return $transaccion;
        }catch(Exception $e){
            return false;
        }
    }

    /* envia correo  a cliente */
    function enviarcorreo($venta_id, $factura_id, $email_destino, $nombre_archivo){
        
        $this->load->library('email');
        $this->email->set_newline("\r\n");
        $this->load->model('Configuracion_email_model');
        $configuracion = $this->Configuracion_email_model->get_configuracion_email(1);

        $config['protocol'] = $configuracion['email_protocolo'];
        $config['smtp_host'] = $configuracion['email_host'];
        $config['smtp_port'] = $configuracion['email_puerto'];
        $config['smtp_user'] = $configuracion['email_usuario'];
        $config['smtp_pass'] = $configuracion['email_clave'];
        $config['smtp_from_name'] = $configuracion['email_nombre'];
        $config['priority'] = $configuracion['email_prioridad'];
        $config['charset'] = $configuracion['email_charset'];
        $config['smtp_crypto'] = $configuracion['email_encriptacion'];
        $config['wordwrap'] = TRUE;
        $config['newline'] = "\r\n";
        $config['mailtype'] = $configuracion['email_tipo'];
        $email_copia = '';

        $this->email->initialize($config);

        $this->email->from($config['smtp_user'], $config['smtp_from_name']);
        $this->email->to($email_destino);
        $this->email->cc($configuracion['email_copia']);
//            $this->email->bcc($attributes['cc']);
        $this->email->subject("Factura Digital, gracias por comprar, vuelva pronto");
        $base_url = explode('/', base_url());
        $directorio_factura = $_SERVER['DOCUMENT_ROOT'].'/'.$base_url[3].'/resources/xml/archivos/';
        $this->email->attach($directorio_factura.$nombre_archivo.$factura_id.".xml");
        $this->email->attach($directorio_factura.$nombre_archivo.$factura_id.".pdf");
        $html = "<html>";
        $html = "<head>";
        $html = "<link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css' integrity='sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M' crossorigin='anonymous'>";
        $html = "</head>";
        $html = "<body>";

        $html .= "<div class='container' style='font-family: Arial'>";
        $html .= "<div class='col-md-2' style='background:gray;'></div>";

        $html .= "<div class='col-md-10'>";
        $html .= "<center>";
        $html .= "<h3>Facturacion Electronica</h3>";
        $html .= " ";
        $html .= "<h4>Estimado Usuario</h4>";
        $html .= "<br>";
        //$html .= $configuracion['email_cabecera'];
        $html .= "Le informamos que su factura electrónica se encuentra disponible para verlo en el siguiente enlace: <br>";
        $direccion = base_url("tufactura/verfactura/".md5($venta_id));
        $html .= "<br><a href='".$direccion."' class='btn btn-info btn-sm' > Ver factura electronica</a>";
        $html .= "<br>Tambien le enviamos los archivos en formato PDF y XML adjuntos";
        $html .= "<br>";
        //$html .= "<br><a href='".$direccion."' class='btn btn-info btn-sm' > Activar mi Cuenta</a>";
//            $html .= "<form method='get' action='/".$direccion."'>";
//            $html .= "<button type='submit'>Activar mi Cuenta</button>";
//            $html .= "</form>";

        $html .= "<br>";
        $html .= "<br>";

        //$html .= $configuracion['email_pie'];
        $html .= "<br>";
        $html .= "<br>";
        //$html .= "<br><a href='".$direccion."' class='btn btn-info btn-sm'>".$direccion."</a>";

        $html .= "</center>";
        $html .= "</div>";

        $html .= "<div class='col-md-2'></div>";            
        $html .= "</div>";

        $html .= "</body>";
        $html .= "</html>";


        $this->email->message($html);

        if($this->email->send()) {
            return true;        
        } else {
            return false;
        }
    }

    
    function email(){

        $to = $this->input->post('empresa_email');
        $from = $this->input->post('froemail');
        $subject = $this->input->post('nomemail');
        $message = $this->input->post('mensaje12');
        $headers = "From: ".$from."";

        mail($to, $subject, $message, $headers);

        redirect('website/index/1');
            
    }    
    
    
    function verificar_cufd(){
        
        $usuario_id = $this->session_data['usuario_id'];
        $puntoventa = $this->Usuario_model->get_punto_venta_usuario($usuario_id);
        $sql ="select * from cufd where cufd_fechavigencia>=now() and cufd_puntodeventa = ".$puntoventa['puntoventa_codigo'];
        $cufd = $this->Venta_model->consultar($sql);
        
        if(sizeof($cufd)>0){
            echo json_encode(true);
        }
        else{
            echo json_encode(false);
        }

    }
    
    function enviarfactura_porcorreo(){
        
        if ($this->input->is_ajax_request()) {
            $this->load->library('email');
            $this->email->set_newline("\r\n");
            $this->load->model('Configuracion_email_model');
            $configuracion = $this->Configuracion_email_model->get_configuracion_email(1);
            
            $venta_id = $this->input->post('venta_id');
            $factura_id = $this->input->post('factura_id');
            $email_destino = $this->input->post('elcorreo');
            
            $config['protocol'] = $configuracion['email_protocolo'];
            $config['smtp_host'] = $configuracion['email_host'];
            $config['smtp_port'] = $configuracion['email_puerto'];
            $config['smtp_user'] = $configuracion['email_usuario'];
            $config['smtp_pass'] = $configuracion['email_clave'];
            $config['smtp_from_name'] = $configuracion['email_nombre'];
            $config['priority'] = $configuracion['email_prioridad'];
            $config['charset'] = $configuracion['email_charset'];
            $config['smtp_crypto'] = $configuracion['email_encriptacion'];
            $config['wordwrap'] = TRUE;
            $config['newline'] = "\r\n";
            $config['mailtype'] = $configuracion['email_tipo'];
            $email_copia = '';

            $this->email->initialize($config);

            $this->email->from($config['smtp_user'], $config['smtp_from_name']);
            $this->email->to($email_destino);
            $this->email->cc($configuracion['email_copia']);
    //            $this->email->bcc($attributes['cc']);
            $this->email->subject("Factura Digital, gracias por comprar, vuelva pronto");
            $base_url = explode('/', base_url());
            $directorio_factura = $_SERVER['DOCUMENT_ROOT'].'/'.$base_url[3].'/resources/xml/';
            $this->email->attach($directorio_factura.$this->nombre_archivo.$factura_id.".xml");
            $this->email->attach($directorio_factura.$this->nombre_archivo.$factura_id.".pdf");
            $html = "<html>";
            $html = "<head>";
            $html = "<link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css' integrity='sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M' crossorigin='anonymous'>";
            $html = "</head>";
            $html = "<body>";

            $html .= "<div class='container' style='font-family: Arial'>";
            $html .= "<div class='col-md-2' style='background:gray;'></div>";

            $html .= "<div class='col-md-10'>";
            $html .= "<center>";
            $html .= "<h3>Facturacion Electronica</h3>";
            $html .= " ";
            $html .= "<h4>Estimado Usuario</h4>";
            $html .= "<br>";
            //$html .= $configuracion['email_cabecera'];
            $html .= "Le informamos que su factura electrónica se encuentra disponible para verlo en el siguiente enlace: <br>";
            $direccion = base_url("tufactura/verfactura/".md5($venta_id));
            $html .= "<br><a href='".$direccion."' class='btn btn-info btn-sm' > Ver factura electronica</a>";
            $html .= "<br>Tambien le enviamos los archivos en formato PDF y XML adjuntos";
            $html .= "<br>";
            //$html .= "<br><a href='".$direccion."' class='btn btn-info btn-sm' > Activar mi Cuenta</a>";
    //            $html .= "<form method='get' action='/".$direccion."'>";
    //            $html .= "<button type='submit'>Activar mi Cuenta</button>";
    //            $html .= "</form>";

            $html .= "<br>";
            $html .= "<br>";

            //$html .= $configuracion['email_pie'];
            $html .= "<br>";
            $html .= "<br>";
            //$html .= "<br><a href='".$direccion."' class='btn btn-info btn-sm'>".$direccion."</a>";

            $html .= "</center>";
            $html .= "</div>";

            $html .= "<div class='col-md-2'></div>";            
            $html .= "</div>";

            $html .= "</body>";
            $html .= "</html>";


            $this->email->message($html);

            if($this->email->send()) {
                $resultado = true;        
            } else {
                $resultado = false;
            }
            
            echo json_encode($resultado);
        }else{                 
            show_404();
        }              
    }
    
    /** registra emision de paquetes (solicitud de recepcion de paquetes) fuera de linea con CAFC
     * esto para un solo archivo al momento de fianalizar la venta e indicar que es con CAFC */
    function registroEmisionPaquetes($factura_id,$codigo_evento){
            if (in_array($dosificacion['docsec_codigoclasificador'], $documentos_sector))  
                
        try{
            if ($this->input->is_ajax_request()) {

                
                $dosificacion_id = 1;
                $dosificacion = $this->Dosificacion_model->get_dosificacion(1);
                
                //$wsdl = $dosificacion['dosificacion_factura'];
                if ($dosificacion['docsec_codigoclasificador']==1)
                   $wsdl = $dosificacion['dosificacion_factura'];

                if ($dosificacion['dosificacion_modalidad']==1){ //Electronica en linea
                    
                    $documentos_sector = array(23,39,11);
                    
                    if (in_array($dosificacion['docsec_codigoclasificador'], $documentos_sector))
                        $wsdl = $dosificacion['dosificacion_glpelectronica'];
                }
                
                if ($dosificacion['dosificacion_modalidad']==2){ // Computarizada en linea
                                        
                    $documentos_sector = array(23,39,11);
                    
                    if (in_array($dosificacion['docsec_codigoclasificador'], $documentos_sector))
                        $wsdl = $dosificacion['dosificacion_facturaglp'];
                }
                
                $token = $dosificacion['dosificacion_tokendelegado'];
                $opts = array(
                      'http' => array(
                           'header' => "apiKey: TokenApi $token",
                      )
                );
                $context = stream_context_create($opts);

                $cliente = new \SoapClient($wsdl, [
                      'stream_context' => $context,
                      'cache_wsdl' => WSDL_CACHE_NONE,
                      'compression' => SOAP_COMPRESSION_ACCEPT | SOAP_COMPRESSION_GZIP | SOAP_COMPRESSION_DEFLATE,

                      // other options
                ]);
                
                $base_url = explode('/', base_url());
                //$doc_xml = site_url("resources/xml/$archivoXml.xml");
                $directorio_factura = $_SERVER['DOCUMENT_ROOT'].'/'.$base_url[3].'/resources/xml/';
                
                $nom_archivo =  $this->nombre_archivo.$factura_id.".tar.gz";  //$this->input->post("nombre_archivo");                
                
                $handle = fopen($directorio_factura.$nom_archivo, "rb");
                $contents = fread($handle, filesize($directorio_factura.$nom_archivo));
                fclose($handle);
                
                $xml_comprimido = hash_file('sha256',$directorio_factura.$nom_archivo);
                $has_archivo = $xml_comprimido;
                
                $usuario_id = $this->session_data['usuario_id'];
                $puntoventa = $this->Usuario_model->get_punto_venta_usuario($usuario_id);
                $this->load->model('PuntoVenta_model');
                $punto_venta = $this->PuntoVenta_model->get_puntoventa($puntoventa['puntoventa_codigo']);
                $tipo_emision = 2;//1 offline
                $fecha_hora = (new DateTime())->format('Y-m-d\TH:i:s.v');
                $parametros = ["SolicitudServicioRecepcionPaquete" => [
                    "codigoAmbiente" => $dosificacion['dosificacion_ambiente'],
                    "codigoPuntoVenta"    => $punto_venta['puntoventa_codigo'], //$dosificacion['dosificacion_puntoventa'],
                    "codigoSistema"        => $dosificacion['dosificacion_codsistema'],
                    "codigoSucursal"       => $dosificacion['dosificacion_sucursal'],
                    "nit"              => $dosificacion['dosificacion_nitemisor'],
                    "codigoDocumentoSector"=> $dosificacion['docsec_codigoclasificador'],
                    "codigoEmision"  => $tipo_emision,
                    "codigoModalidad"     => $dosificacion['dosificacion_modalidad'],
                    "cufd"              => $punto_venta['cufd_codigo'], //$dosificacion['dosificacion_cufd'],
                    "cuis"              => $punto_venta['cuis_codigo'], //$dosificacion['dosificacion_cuis'],
                    "tipoFacturaDocumento" => $dosificacion['tipofac_codigo'],
                    "archivo" => $contents, //$dosificacion['dosificacion_cuis'],
                    "fechaEnvio"=>$fecha_hora, //$dosificacion['dosificacion_cuis'],
                    "hashArchivo"=>$has_archivo, //$dosificacion['dosificacion_cuis'],
                    "cafc"               => $dosificacion['dosificacion_cafc'],
                    "cantidadFacturas"     => 1, //$dosificacion['dosificacion_nitemisor'],
                    "codigoEvento"         => $codigo_evento, //$dosificacion['dosificacion_nitemisor']
                ]];
                
                $fecha_hora1 = (new DateTime())->format('Y-m-d H:i:s');
                //var_dump($parametros);
                $resultado = $cliente->recepcionPaqueteFactura($parametros);
                $res = $resultado->RespuestaServicioFacturacion;
                
                if($res->codigoDescripcion == "PENDIENTE"){
                    $params = array(
                        'recpaquete_codigodescripcion' => $res->codigoDescripcion,
                        'recpaquete_codigoestado' => $res->codigoEstado,
                        'recpaquete_codigorecepcion' => $res->codigoRecepcion,
                        'recpaquete_transaccion' => $res->transaccion,
                        'recpaquete_fechahora' => $fecha_hora1,
                        'codigo_evento' => $codigo_evento,
                        'factura_id' => $factura_id,
                    );
                }else{
                    $cad = $res->mensajesList;
                            $mensajecadena = "";
                            foreach ($cad as $c) {
                                $mensajecadena .= $c.";";
                            }
                    $params = array(
                        'recpaquete_codigodescripcion' => $res->codigoDescripcion,
                        'recpaquete_codigoestado' => $res->codigoEstado,
                        //'recpaquete_codigorecepcion' => $res->codigoRecepcion,
                        'recpaquete_mensajeslist' => $mensajecadena,
                        'recpaquete_fechahora' => $fecha_hora1,
                        'codigo_evento' => $codigo_evento,
                        'factura_id' => $factura_id,
                    );
                }
                $recpaquete_id = $this->Emision_paquetes_model->add_recepcionpaquetes($params);
                
               // echo json_encode($res);
                
                return $res->codigoRecepcion;
                
            }else{                 
                show_404();
            }
                
                
        }catch (Exception $e){
            echo    'Ocurrio algo inesperado; revisar datos!.';
        }
        return 0;
    }
    
    /** Una vez echa la solicitud de recepcion ode paquetes, se manda aa validar el paquete.
     *  todo esto lo  hace al finalizar una venta con CAFC!. */
    function registroEmisionPaquetes_vacio($codigo_recepcion,$factura_id){
        
        try{
  
                
                $dosificacion_id = 1;
                $dosificacion = $this->Dosificacion_model->get_dosificacion(1);
                
                //$wsdl = $dosificacion['dosificacion_factura'];
                if ($dosificacion['docsec_codigoclasificador']==1)
                    $wsdl = $dosificacion['dosificacion_factura'];

                if ($dosificacion['dosificacion_modalidad']==1){ //Electronica en linea
                    
                    $documentos_sector = array(23,39,11);
                    
                    if (in_array($dosificacion['docsec_codigoclasificador'], $documentos_sector))
                        $wsdl = $dosificacion['dosificacion_glpelectronica'];
                }
                
                if ($dosificacion['dosificacion_modalidad']==2){ // Computarizada en linea
                                        
                    $documentos_sector = array(23,39,11);
                    
                    if (in_array($dosificacion['docsec_codigoclasificador'], $documentos_sector))
                        $wsdl = $dosificacion['dosificacion_facturaglp'];
                }
                
                $token = $dosificacion['dosificacion_tokendelegado'];
                $opts = array(
                      'http' => array(
                           'header' => "apiKey: TokenApi $token",
                      )
                );
                $context = stream_context_create($opts);

                $cliente = new \SoapClient($wsdl, [
                      'stream_context' => $context,
                      'cache_wsdl' => WSDL_CACHE_NONE,
                      'compression' => SOAP_COMPRESSION_ACCEPT | SOAP_COMPRESSION_GZIP | SOAP_COMPRESSION_DEFLATE,
                ]);
                
                $base_url = explode('/', base_url());

                $directorio_factura = $_SERVER['DOCUMENT_ROOT'].'/'.$base_url[3].'/resources/xml/';
                
//                $codigo_recepcion =  $this->input->post("codigo_recepcion");
//                $factura_id =  $this->input->post("factura_id");
                
                $usuario_id = $this->session_data['usuario_id'];
                $puntoventa = $this->Usuario_model->get_punto_venta_usuario($usuario_id);
                $this->load->model('PuntoVenta_model');
                $punto_venta = $this->PuntoVenta_model->get_puntoventa($puntoventa['puntoventa_codigo']);
                $tipo_emision = 2; //1 offline

                $parametros = ["SolicitudServicioValidacionRecepcionPaquete" => [
                    "codigoAmbiente" => $dosificacion['dosificacion_ambiente'],
                    "codigoPuntoVenta"    => $punto_venta['puntoventa_codigo'], //$dosificacion['dosificacion_puntoventa'],
                    "codigoSistema"        => $dosificacion['dosificacion_codsistema'],
                    "codigoSucursal"       => $dosificacion['dosificacion_sucursal'],
                    "nit"              => $dosificacion['dosificacion_nitemisor'],
                    "codigoDocumentoSector"=> $dosificacion['docsec_codigoclasificador'],
                    "codigoEmision"  => $tipo_emision,
                    "codigoModalidad"     => $dosificacion['dosificacion_modalidad'],
                    "cufd"              => $punto_venta['cufd_codigo'], //$dosificacion['dosificacion_cufd'],
                    "cuis"              => $punto_venta['cuis_codigo'], //$dosificacion['dosificacion_cuis'],
                    "tipoFacturaDocumento" => $dosificacion['tipofac_codigo'],
                    "codigoRecepcion"         => $codigo_recepcion, //$dosificacion['dosificacion_nitemisor']
                ]];
                
                $fecha_hora1 = (new DateTime())->format('Y-m-d H:i:s');
                //var_dump($parametros);
                $resultado = $cliente->validacionRecepcionPaqueteFactura($parametros);
                $res = $resultado->RespuestaServicioFacturacion;
                //var_dump($res);
                $recepcion_paquete = $this->Emision_paquetes_model->getcod_recepcionpaquetes($res->codigoRecepcion);
                if($res->codigoDescripcion == "VALIDADA"){
                    $params = array(
                        'recpaquete_codigodescripcion' => $res->codigoDescripcion,
                        'recpaquete_codigoestado' => $res->codigoEstado,
                    );
                    $sql = "update factura set factura_codigodescripcion ='VALIDADA', factura_enviada = 2  where factura_id='".$factura_id."'";
                    $this->Venta_model->ejecutar($sql);
                    
                }elseif($res->codigoDescripcion == "OBSERVADA"){
                    $cad = $res->mensajesList;
                    $mensajecadena = json_encode($cad);
                    
                    /*foreach ($cad as $c) {
                        $mensajecadena .= $c.";";
                    }*/
                    $params = array(
                        'recpaquete_codigodescripcion' => $res->codigoDescripcion,
                        'recpaquete_codigoestado' => $res->codigoEstado,
                        'recpaquete_mensajeslist' => $mensajecadena,
                    );
                }
                $this->Emision_paquetes_model->update_recepcionpaquetes($recepcion_paquete['recpaquete_id'],$params);
                
                echo json_encode($res);
                //echo $res;
                //print_r($resultado);
                //$lresptransaccion = $resultado->RespuestaListaEventos->transaccion;

                
        }catch (Exception $e){
            echo 'Ocurrio algo inesperado; revisar datos!.'.$e;
        }
    }    
        

    function enviar_facturas($registroeventos_id){
    
        try{
            
                //los datos del evento
                $sql = "SELECT * FROM registro_eventos WHERE registroeventos_id = ".$registroeventos_id;
                $evento = $this->Venta_model->consultar($sql);
                $sql = "select * from factura where registroeventos_id = ".$registroeventos_id;
                $facturas = $this->Venta_model->consultar($sql);
                
//            if ($this->input->is_ajax_request()) {
                $dosificacion_id = 1;
                $dosificacion = $this->Dosificacion_model->get_dosificacion(1);
                
                    $wsdl = $dosificacion['dosificacion_factura'];
                $token = $dosificacion['dosificacion_tokendelegado'];
                $opts = array(
                      'http' => array(
                           'header' => "apiKey: TokenApi $token",
                      )
                );
                $context = stream_context_create($opts);

                $cliente = new \SoapClient($wsdl, [
                      'stream_context' => $context,
                      'cache_wsdl' => WSDL_CACHE_NONE,
                      'compression' => SOAP_COMPRESSION_ACCEPT | SOAP_COMPRESSION_GZIP | SOAP_COMPRESSION_DEFLATE,

                      // other options
                ]);
                
                $nom_archivo = "facturas_eventos".$registroeventos_id.".tar.gz";  //$this->input->post("nombre_archivo");
                $codigo_evento = $evento[0]["registroeventos_codigo"]; //$this->input->post("codigo_evento"); 
                $cantotalf   = sizeof($facturas);  //$this->input->post("cantotalf");
                $fact_enviar =  $this->input->post("fact_aenviar");
                
                $usar_fact_enviar = $fact_enviar;
                $rescant = $cantotalf/500;
                $cont = 1;
                
                
                $base_url = explode('/', base_url());
                //$doc_xml = site_url("resources/xml/$archivoXml.xml");
                $directorio_factura = $_SERVER['DOCUMENT_ROOT'].'/'.$base_url[3].'/resources/xml/';
               
                
                    // COMPRESION XML EN GZIP
                    $datos = implode("", file($directorio_factura.$this->nombre_archivo.$factura[0]['factura_id'].".xml"));
                    $gzdata = gzencode($datos, 9);
                    $fp = fopen($directorio_factura.$this->nombre_archivo.$factura[0]['factura_id'].".xml.zip", "w");
                    // $xml_gzip = fopen($directorio_factura.$this->nombre_archivo.$factura[0]['factura_id'].".xml.zip", "r");
                    fwrite($fp, $gzdata);
                    fclose($fp);

                    //Copiar el archivo .tar al directorio con id del usuario en curso

                    $path = $directorio_factura."envio".$usuario_id;
                    //echo $path;
                    if (!file_exists($path)) {
                        mkdir($path, 0777, true);
                    }

                    //para borrar comprime en tar-gz
                    //$eltipo_emision = $this->parametros['parametro_tipoemision'];
                    if($tipo_emision == 2){ // Si es emision fuera de linea

                        $p = new PharData($directorio_factura.$this->nombre_archivo.$factura[0]['factura_id'].'.tar');
                        $p[$this->nombre_archivo.$factura[0]['factura_id'].'.xml'] = $datos;
                        $p1 = $p->compress(Phar::GZ);

                    }

                foreach($facturas as $fact){
                    
                        $p = new PharData($directorio_factura.$this->nombre_archivo.$factura[0]['factura_id'].'.tar');
                        $p[$this->nombre_archivo.$factura[0]['factura_id'].'.xml'] = $datos;
                        $p1 = $p->compress(Phar::GZ);
                                
                    
                }
                
                while($rescant >0){
                    
                    $p = new PharData($directorio_factura.$nom_archivo.$cont.'.tar');
                    $numf = 0;
                    foreach($usar_fact_enviar as $f){
                        if($numf == 500){
                            break;
                        }else{
                            if(file_exists($directorio_factura.$this->nombre_archivo.$f.".pdf")){
                                $datos = implode("", file($directorio_factura.$this->nombre_archivo.$f.".xml"));
                                $p[$this->nombre_archivo.$f.'.xml'] = $datos;
                                unset($usar_fact_enviar[$f]);
                            }
                        }
                        $numf++;
                    }

                    $p1 = $p->compress(Phar::GZ);
                    
                    $handle = fopen($directorio_factura.$nom_archivo.$cont, "rb");
                    $contents = fread($handle, filesize($directorio_factura.$nom_archivo.$cont));
                    fclose($handle);

                    $xml_comprimido = hash_file('sha256',$directorio_factura.$nom_archivo.$cont);
                    $has_archivo = $xml_comprimido;

                    $usuario_id = $this->session_data['usuario_id'];
                    $puntoventa = $this->Usuario_model->get_punto_venta_usuario($usuario_id);
                    $this->load->model('PuntoVenta_model');
                    $punto_venta = $this->PuntoVenta_model->get_puntoventa($puntoventa['puntoventa_codigo']);
                    $tipo_emision = 2;//1 offline
                    $fecha_hora = (new DateTime())->format('Y-m-d\TH:i:s.v');
                    $parametros = ["SolicitudServicioRecepcionPaquete" => [
                        "codigoAmbiente" => $dosificacion['dosificacion_ambiente'],
                        "codigoPuntoVenta"    => $punto_venta['puntoventa_codigo'], //$dosificacion['dosificacion_puntoventa'],
                        "codigoSistema"        => $dosificacion['dosificacion_codsistema'],
                        "codigoSucursal"       => $dosificacion['dosificacion_sucursal'],
                        "nit"              => $dosificacion['dosificacion_nitemisor'],
                        "codigoDocumentoSector"=> $dosificacion['docsec_codigoclasificador'],
                        "codigoEmision"  => $tipo_emision,
                        "codigoModalidad"     => $dosificacion['dosificacion_modalidad'],
                        "cufd"              => $punto_venta['cufd_codigo'], //$dosificacion['dosificacion_cufd'],
                        "cuis"              => $punto_venta['cuis_codigo'], //$dosificacion['dosificacion_cuis'],
                        "tipoFacturaDocumento" => $dosificacion['tipofac_codigo'],
                        "archivo" => $contents, //$dosificacion['dosificacion_cuis'],
                        "fechaEnvio"=>$fecha_hora, //$dosificacion['dosificacion_cuis'],
                        "hashArchivo"=>$has_archivo, //$dosificacion['dosificacion_cuis'],
                        "cafc"               => $dosificacion['dosificacion_cafc'],
                        "cantidadFacturas"     => $numf, //1, //$dosificacion['dosificacion_nitemisor'],
                        "codigoEvento"         => $codigo_evento, //$dosificacion['dosificacion_nitemisor']
                    ]];

                    $fecha_hora1 = (new DateTime())->format('Y-m-d H:i:s');
                    //var_dump($parametros);
                    $resultado = $cliente->recepcionPaqueteFactura($parametros);
                    $res = $resultado->RespuestaServicioFacturacion;
                    $factura_id = "0";
                    if($res->codigoDescripcion == "PENDIENTE"){
                        $params = array(
                            'recpaquete_codigodescripcion' => $res->codigoDescripcion,
                            'recpaquete_codigoestado' => $res->codigoEstado,
                            'recpaquete_codigorecepcion' => $res->codigoRecepcion,
                            'recpaquete_transaccion' => $res->transaccion,
                            'recpaquete_fechahora' => $fecha_hora1,
                            'codigo_evento' => $codigo_evento,
                            'factura_id' => $factura_id,
                        );
                    }else{
                        $cad = $res->mensajesList;
                                $mensajecadena = "";
                                foreach ($cad as $c) {
                                    $mensajecadena .= $c.";";
                                }
                        $params = array(
                            'recpaquete_codigodescripcion' => $res->codigoDescripcion,
                            'recpaquete_codigoestado' => $res->codigoEstado,
                            //'recpaquete_codigorecepcion' => $res->codigoRecepcion,
                            'recpaquete_mensajeslist' => $mensajecadena,
                            'recpaquete_fechahora' => $fecha_hora1,
                            'codigo_evento' => $codigo_evento,
                            'factura_id' => $factura_id,
                        );
                    }
                    $recpaquete_id = $this->Emision_paquetes_model->add_recepcionpaquetes($params);

                    $datos[] = $res;
                    $rescant--;
                    $cont++;
                }
                
                
                echo json_encode($datos);
//            }else{
//                show_404();
//            }
        }catch (Exception $e){
            echo 'Ocurrio algo inesperado; revisar datos!.';
        }
    }    
 /*   function enviar_facturas($registroeventos_id){
    
        try{
            
                //los datos del evento
                $sql = "SELECT * FROM registro_eventos WHERE registroeventos_id = ".$registroeventos_id;
                $evento = $this->Venta_model->consultar($sql);
                $sql = "select * from factura where registroeventos_id = ".$registroeventos_id;
                $facturas = $this->Venta_model->consultar($sql);
                
//            if ($this->input->is_ajax_request()) {
                $dosificacion_id = 1;
                $dosificacion = $this->Dosificacion_model->get_dosificacion(1);
                
                $wsdl = $dosificacion['dosificacion_factura'];                
                $token = $dosificacion['dosificacion_tokendelegado'];
                $opts = array(
                      'http' => array(
                           'header' => "apiKey: TokenApi $token",
                      )
                );
                $context = stream_context_create($opts);

                $cliente = new \SoapClient($wsdl, [
                      'stream_context' => $context,
                      'cache_wsdl' => WSDL_CACHE_NONE,
                      'compression' => SOAP_COMPRESSION_ACCEPT | SOAP_COMPRESSION_GZIP | SOAP_COMPRESSION_DEFLATE,

                      // other options
                ]);
                
                $nom_archivo = "facturas_eventos".$registroeventos_id.".tar.gz";  //$this->input->post("nombre_archivo");
                $codigo_evento = $evento[0]["registroeventos_codigo"]; //$this->input->post("codigo_evento"); 
                $cantotalf   = sizeof($facturas);  //$this->input->post("cantotalf");
                $fact_enviar =  $this->input->post("fact_aenviar");
                
                $usar_fact_enviar = $fact_enviar;
                $base_url = explode('/', base_url());
                $directorio_factura = $_SERVER['DOCUMENT_ROOT'].'/'.$base_url[3].'/resources/xml/';
                $rescant = $cantotalf/500;
                $cont = 1;
                
                while($rescant >0){
                    
                    $p = new PharData($directorio_factura.$nom_archivo.$cont.'.tar');
                    $numf = 0;
                    foreach($usar_fact_enviar as $f){
                        if($numf == 500){
                            break;
                        }else{
                            if(file_exists($directorio_factura.$this->nombre_archivo.$f.".pdf")){
                                $datos = implode("", file($directorio_factura.$this->nombre_archivo.$f.".xml"));
                                $p[$this->nombre_archivo.$f.'.xml'] = $datos;
                                unset($usar_fact_enviar[$f]);
                            }
                        }
                        $numf++;
                    }

                    $p1 = $p->compress(Phar::GZ);
                    
                    $handle = fopen($directorio_factura.$nom_archivo.$cont, "rb");
                    $contents = fread($handle, filesize($directorio_factura.$nom_archivo.$cont));
                    fclose($handle);

                    $xml_comprimido = hash_file('sha256',$directorio_factura.$nom_archivo.$cont);
                    $has_archivo = $xml_comprimido;

                    $usuario_id = $this->session_data['usuario_id'];
                    $puntoventa = $this->Usuario_model->get_punto_venta_usuario($usuario_id);
                    $this->load->model('PuntoVenta_model');
                    $punto_venta = $this->PuntoVenta_model->get_puntoventa($puntoventa['puntoventa_codigo']);
                    $tipo_emision = 2;//1 offline
                    $fecha_hora = (new DateTime())->format('Y-m-d\TH:i:s.v');
                    $parametros = ["SolicitudServicioRecepcionPaquete" => [
                        "codigoAmbiente" => $dosificacion['dosificacion_ambiente'],
                        "codigoPuntoVenta"    => $punto_venta['puntoventa_codigo'], //$dosificacion['dosificacion_puntoventa'],
                        "codigoSistema"        => $dosificacion['dosificacion_codsistema'],
                        "codigoSucursal"       => $dosificacion['dosificacion_sucursal'],
                        "nit"              => $dosificacion['dosificacion_nitemisor'],
                        "codigoDocumentoSector"=> $dosificacion['docsec_codigoclasificador'],
                        "codigoEmision"  => $tipo_emision,
                        "codigoModalidad"     => $dosificacion['dosificacion_modalidad'],
                        "cufd"              => $punto_venta['cufd_codigo'], //$dosificacion['dosificacion_cufd'],
                        "cuis"              => $punto_venta['cuis_codigo'], //$dosificacion['dosificacion_cuis'],
                        "tipoFacturaDocumento" => $dosificacion['tipofac_codigo'],
                        "archivo" => $contents, //$dosificacion['dosificacion_cuis'],
                        "fechaEnvio"=>$fecha_hora, //$dosificacion['dosificacion_cuis'],
                        "hashArchivo"=>$has_archivo, //$dosificacion['dosificacion_cuis'],
                        "cafc"               => $dosificacion['dosificacion_cafc'],
                        "cantidadFacturas"     => $numf, //1, //$dosificacion['dosificacion_nitemisor'],
                        "codigoEvento"         => $codigo_evento, //$dosificacion['dosificacion_nitemisor']
                    ]];

                    $fecha_hora1 = (new DateTime())->format('Y-m-d H:i:s');
                    //var_dump($parametros);
                    $resultado = $cliente->recepcionPaqueteFactura($parametros);
                    $res = $resultado->RespuestaServicioFacturacion;
                    $factura_id = "0";
                    if($res->codigoDescripcion == "PENDIENTE"){
                        $params = array(
                            'recpaquete_codigodescripcion' => $res->codigoDescripcion,
                            'recpaquete_codigoestado' => $res->codigoEstado,
                            'recpaquete_codigorecepcion' => $res->codigoRecepcion,
                            'recpaquete_transaccion' => $res->transaccion,
                            'recpaquete_fechahora' => $fecha_hora1,
                            'codigo_evento' => $codigo_evento,
                            'factura_id' => $factura_id,
                        );
                    }else{
                        $cad = $res->mensajesList;
                                $mensajecadena = "";
                                foreach ($cad as $c) {
                                    $mensajecadena .= $c.";";
                                }
                        $params = array(
                            'recpaquete_codigodescripcion' => $res->codigoDescripcion,
                            'recpaquete_codigoestado' => $res->codigoEstado,
                            //'recpaquete_codigorecepcion' => $res->codigoRecepcion,
                            'recpaquete_mensajeslist' => $mensajecadena,
                            'recpaquete_fechahora' => $fecha_hora1,
                            'codigo_evento' => $codigo_evento,
                            'factura_id' => $factura_id,
                        );
                    }
                    $recpaquete_id = $this->Emision_paquetes_model->add_recepcionpaquetes($params);

                    
                    
                    $datos[] = $res;
                    $rescant--;
                    $cont++;
                }
                
                
                echo json_encode($datos);
//            }else{
//                show_404();
//            }
        }catch (Exception $e){
            echo 'Ocurrio algo inesperado; revisar datos!.';
        }
    }    */
    
    function comprimir(){
        
        $base_url = explode('/', base_url());  //convierte un cadena en array
        //$doc_xml = site_url("resources/xml/$archivoXml.xml");
        $directorio_factura = $_SERVER['DOCUMENT_ROOT'].'/'.$base_url[3].'/resources/xml/';

        echo $directorio_factura;

        // COMPRESION XML EN GZIP
//            $gzdata = gzencode($datos, 9); 
//        
//        $fp = fopen($directorio_factura."prueba.xml.zip", "w");
//        
//        // $xml_gzip = fopen($directorio_factura.$this->nombre_archivo.$factura[0]['factura_id'].".xml.zip", "r");
//        fwrite($fp, $gzdata);
//        fclose($fp);
        
        $p = new PharData($directorio_factura.'prueba.tar');
        $datos = implode("", file($directorio_factura."compra_venta235.xml")); //convierte un array en cadena y asignamos a datos
        $datos2 = implode("", file($directorio_factura."compra_venta236.xml")); //convierte un array en cadena y asignamos a datos
        $datos3 = implode("", file($directorio_factura."compra_venta237.xml")); //convierte un array en cadena y asignamos a datos
        $p['compra_venta235.xml'] = $datos;
        $p['compra_venta236.xml'] = $datos2;
        $p['compra_venta237.xml'] = $datos3;
        $p->compress(Phar::GZ);
        
       // echo "tar -czf ".$directorio_factura."envio18/backup.tar.gz ".$directorio_factura;
        //exec("tar -czf ".$directorio_factura."envio18/backup.tar.gz ".$directorio_factura);
    }
    
    
    function facturas_contingencia(){
        
        $usuario_id = $this->session_data['usuario_id'];
        $puntoventa = $this->Usuario_model->get_punto_venta_usuario($usuario_id);
        
        $codigo_evento = $this->input->post("codigo_evento");
        
        $dosificacion_id = 1;
        $dosificacion = $this->Dosificacion_model->get_dosificacion(1);
                
        $sql = "select * from factura_contingencia where facturacontingencia_cafc = '".$dosificacion["dosificacion_cafc"]."'";
        
        $sql = "select f.*,r.* from factura_contingencia f, registro_eventos r 
                where 
                f.facturacontingencia_cafc = '".$dosificacion["dosificacion_cafc"]."' and
                r.registroeventos_codigo = ".$codigo_evento.
                " and r.registroeventos_puntodeventa = ".$puntoventa["puntoventa_codigo"];
        
        //echo $sql;     
        $factura_contingecia = $this->Venta_model->consultar($sql);
      
        echo json_encode($factura_contingecia);
        


    }
        
    function actualizar_numerofactura(){
        
        $sql = "update dosificacion set dosificacion_numfact = dosificacion_numfact - 1";        
        $this->Venta_model->ejecutar($sql);
      
        echo json_encode("ok");
        
    }
    
    function pdf_generar($factura_id){
        if($this->parametros["parametro_tipoimpresora"]=="FACTURADORA"){
            if($this->dosificacion["docsec_codigoclasificador"] == 23){
                $this->pdf_factura_boucher_prev($factura_id);
            }else{
                $this->pdf_factura_boucher($factura_id);
            }
        }else{
            if($this->dosificacion["docsec_codigoclasificador"] == 23){
                $this->pdf_factura_carta_prev($factura_id);
            }else{
                $this->pdf_factura_carta($factura_id);
            }
        }
    }
    
    function pdf_factura_boucher($factura_id){
        
        $decimales = $this->parametros["parametro_decimales"];
        $dos_decimales = 2;
        $factura = $this->Factura_model->get_factura_id($factura_id);
        $detalle_factura = $this->Detalle_venta_model->get_detalle_factura_id($factura_id);
        $empresa = $this->Empresa_model->get_empresa(1);
        //$parametros = $this->Parametro_model->get_parametros();
        $usuario_id = $this->session_data['usuario_id'];
        $nombre_archivo = $this->nombre_archivo;
        $micad = "";
        $micad .= "<!DOCTYPE html>"; 
        $micad .= "<html>"; 
        $micad .= "    <head>";
        $micad .= "        <style type='text/css'>";
        $micad .= "  p {";
        $micad .= "      font-family: Arial;";
        $micad .= "      font-size: 8pt;";
        $micad .= "      line-height: 80%;";   /*esta es la propiedad para el interlineado*/
        $micad .= "      color: #000;";
        $micad .= "      padding: 10px;";
        $micad .= "  }";
        $micad .= "  div {";
        $micad .= "      margin-top: 0px;";
        $micad .= "      margin-right: 0px;";
        $micad .= "      margin-bottom: 0px;";
        $micad .= "      margin-left: 0px;";
        $micad .= "      margin: 0px;";
        $micad .= "  }";
        $micad .= "  table{";
        $micad .= "      width : 7cm;";
        $micad .= "      margin : 0 0 0px 0;";
        $micad .= "      padding : 0 0 0 0;";
        $micad .= "      border-spacing : 0 0;";
        $micad .= "      border-collapse : collapse;";
        $micad .= "      font-family: Arial;";
        $micad .= "      font-size: 8pt;";
        $micad .= "      td{";
        $micad .= "          border:hidden;";
        $micad .= "      }";
        $micad .= "  }";
        $micad .= "  td#comentario {";
        $micad .= "      vertical-align : bottom;";
        $micad .= "      border-spacing : 0;";
        $micad .= "  }";
        $micad .= "  div#content {";
        $micad .= "      background : #ddd;";
        $micad .= "      font-size : 8px;";
        $micad .= "      margin : 0 0 0 0;";
        $micad .= "      padding : 0 0px 0 0px;";
        $micad .= "  }";
        $micad .= "       </style>"; 
        $micad .= "   </head>";
        $tipo_factura = $this->parametros["parametro_altofactura"]; //15 tamaño carta  
        $ancho = $this->parametros["parametro_anchofactura"]."cm"; 
        $margen_izquierdo = $this->parametros["parametro_margenfactura"]."cm"; 
        $micad .= "  <body style='width: ".$ancho."'>"; 
        $micad .= "  <table class='table'>";
        $micad .= "    <tr>";
        $micad .= "        <td style='padding: 0; width: ".$margen_izquierdo."'></td>";
        $micad .= "        <td style='padding: 0;'>";
        $micad .= "            <table class='table' style='width: ".$ancho."'>";
        $micad .= "                <tr>";
        $micad .= "                    <td style='padding: 0;' colspan='4'>";
        $micad .= "                        <table style='width: ".$ancho."' style='font-family: Arial'>";
        $micad .= "                            <tr>";
        $micad .= "                                <td class='text-center' style='padding-bottom: 5px;'><center>";
        $micad .= "                                     ";
                                                       
        $opc = $factura[0]['docsec_codigoclasificador'];
        if($opc == 12){ //Comercializacion de hidrocarburos
            $datos_factura = $this->Factura_datos_model->get_factura_datos($factura[0]['datos_id']);
        }
        //$opc = 1; // Valor solo declarado para actualzar emavra
        $subtitulo_factura = "CON DERECHO A CR&Eacute;DITO FISCAL";
        switch($opc){
            
            default: $titulo1 = "FACTURA";
                    break;
                    
            case 2: $titulo1 = "FACTURA DE ALQUILER";
                    break;
                
            case 8: $titulo1 = "FACTURA TASA CERO - VENTA DE LIBROS O TRANSPORTE DE CARGA INTERNACIONAL";
                    $subtitulo_factura = "SIN DERECHO A CR&Eacute;DITO FISCAL";
                    break;
                
                
        }
                                                       
                                                    //   $tipo = 1;
                                                    //if ($tipo==1) $subtitulo = "CON DERECHO A CRÉDITO FISCAL"; //$subtitulo = "ORIGINAL";
                                                    //else $subtitulo = "CON DERECHO A CRÉDITO FISCAL"; //$subtitulo = "COPIA";";
        $micad .= "                                    <span style='font-weight: bold !important'>".$titulo1."</span><br>";
        $micad .= "                                    <span style='font-weight: bold !important'>".$subtitulo_factura."</span><br>";
        $micad .=                                       $empresa[0]['empresa_nombre']."<br>";
        if($empresa[0]['empresa_eslogan'] !="" && $empresa[0]['empresa_eslogan'] != null){
            $micad .=                                       $empresa[0]['empresa_eslogan']."<br>";
        }
                                                    if(isset($empresa[0]['empresa_propietario']) && ($empresa[0]['empresa_propietario']!="")){
        $micad .= "                                       DE: ".$empresa[0]['empresa_propietario']."<br>";
                                                    }
                                                    if($factura[0]['factura_sucursal']==0){
        $micad .= "                                            CASA MATRIZ";
                                                    }else{
        $micad .= "                                            SUCURSAL ".$factura[0]['factura_sucursal'];
                                                    }
        $micad .= "                                    <br>Nº PUNTO DE VENTA ".$factura[0]['factura_puntoventa']."<br>";
        $micad .=                                     $empresa[0]['empresa_direccion']."<br>";
        $micad .= "                                    Tel. ".$empresa[0]['empresa_telefono']."<br>";
        $micad .=                                     $empresa[0]['empresa_ubicacion']."<br>";
        $micad .= "                                ";
        $micad .= "                                </center></td>";
        $micad .= "                            </tr>";
        $micad .= "                        </table>";
        $micad .= "                        <table style='width:".$ancho."  font-family: Arial'>";
        $micad .= "                            <tr style='border-top-style: dashed; border-top-width: 1px;'>";
        $micad .= "                                <td><center><span style='font-weight: bold !important'>NIT:</span> ".$factura[0]['factura_nitemisor']."</center></td>";
        $micad .= "                            </tr>";
//                                        $micad .= "                            <tr>";
//                                        $micad .= "                                <td class='text-center'><center>".$factura[0]['factura_nitemisor']."</center></td>";
//                                        $micad .= "                            </tr>";
        $micad .= "                            <tr>";
        $micad .= "                                <td><center><span style='font-weight: bold !important'>FACTURA Nº:</span> ".$factura[0]['factura_numero']."</center></td>";
        $micad .= "                            </tr>";
//                                        $micad .= "                            <tr>";
//                                        $micad .= "                                <td class='text-center'><center>".$factura[0]['factura_numero']."</center></td>";
//                                        $micad .= "                            </tr>";
        $micad .= "                            <tr>";
        $micad .= "                                <td><center><span style='font-weight: bold !important'>CÓD. AUTORIZACIÓN</span></center></td>";
        $micad .= "                            </tr>";
        $micad .= "                            <tr>";
        $micad .= "                                <td class='text-center'><div style='word-wrap: break-word; width: ".$ancho."' ><center>".$factura[0]['factura_cuf']."</center></div></td>";
        $micad .= "                            </tr>";
        $micad .= "                        </table>";
        $micad .= "                    </td>";
        $micad .= "                </tr>";
        $micad .= "                <tr>";
        $micad .= "                    <td colspan='4' style='padding: 0;'>";
        $micad .= "                        <table style='width: ".$ancho."' >";
        $micad .= "                            <tr style='border-top-style: dashed; border-top-width: 1px;'>";
        $micad .= "                                <td style='padding: 0; white-space: nowrap; text-align: right; font-weight: bold !important'>NOMBRE/RAZ&Oacute;N SOCIAL: </td>";
        $micad .= "                                <td style='padding: 0; padding-left: 3px'>".$factura[0]['factura_razonsocial']."</td>";
        $micad .= "                            </tr>";
        $micad .= "                            <tr>";
        $micad .= "                                <td style='padding: 0; text-align: right; font-weight: bold !important'>NIT/CI/CEX: </td>";
        $micad .= "                                <td style='padding: 0; padding-left: 3px'>".$factura[0]['factura_nit']."  ";
                                               if($factura[0]['cdi_codigoclasificador']!=5){
        $micad .=                                  $factura[0]["cliente_complementoci"];
                                               }
        $micad .= "                                </td>";
        $micad .= "                            </tr>";
        $micad .= "                            <tr>";
        $micad .= "                                <td style='padding: 0; text-align: right; font-weight: bold !important'>COD. CLIENTE: </td><!-- PONER CODIGO DE CLIENTE -->";
        $micad .= "                                <td style='padding: 0; padding-left: 3px'>".$factura[0]['factura_codigocliente']."</b><br></td>";
        $micad .= "                            </tr>";
        
        $linea_recortada = "style='border-bottom-style: dashed; border-bottom-width: 1px;'";
        if($opc == 12){
            $linea_recortada = "";
        }
        
        $micad .= "                            <tr ".$linea_recortada.">";
        $micad .= "                                <td style='padding: 0; text-align: right; font-weight: bold !important'>FECHA DE EMISI&Oacute;N: </td>";
        $micad .= "                                <td style='padding: 0; padding-left: 3px'>";
                                                    $fecha = new DateTime($factura[0]['factura_fecha']);
                                                    $fecha_d_m_a = $fecha->format('d/m/Y');
        $micad .=                                   $fecha_d_m_a." ".$factura[0]['factura_hora'];
        $micad .= "                                </td>";
        $micad .= "                            </tr>";
                            
                            if($opc == 12){
        $micad .= "                   <tr>";
        $micad .= "                       <td style='padding: 0; text-align: right; font-weight: bold'>PLACA/B-SISA/VIN:</td>";
        $micad .= "                       <td style='padding: 0; padding-left: 3px'>".$datos_factura['datos_placa']."<br></td>";
        $micad .= "                   </tr>";
        $micad .= "                   <tr style='border-bottom-style: dashed; border-bottom-width: 1px;'>";
        $micad .= "                       <td style='padding: 0; text-align: right; font-weight: bold !important'>TIPO ENVASE:</td>";
        $micad .= "                       <td style='padding: 0; padding-left: 3px'>".$datos_factura['datos_embase']."<br></td>";
        $micad .= "                   </tr>";
                            }
        $micad .= "                        </table>";
        $micad .= "                    </td>";
        $micad .= "                </tr>";
        $micad .= "                <tr>";
        $micad .= "                    <td colspan='4' align='center' style='padding: 0; font-weight: bold !important'>DETALLE</td>";
        $micad .= "                </tr>";
        $micad .= "                <tr>";
        $micad .= "                    <td colspan='4' style='padding: 0'>";
        $micad .= "                        <table style='width: ".$ancho."'>";
                                            $cont = 0;
                                            $cantidad = 0;
                                            $total_descuento = 0;
                                            $total_final = 0;
                                            $total_subtotal = 0;
                                            $mostrarice = 0;
                                            $ice = 0;
                                            if($factura[0]['estado_id']<>3){
                                                foreach($detalle_factura as $d){;
                                                    $cont = $cont+1;
                                                    $cantidad += $d['detallefact_cantidad'];
                                                    $total_descuento += $d['detallefact_descuento']; 
                                                    $total_final += $d['detallefact_total']; 
        $micad .= "                            <tr>";
        $micad .= "                                <td colspan='3' style='font-size: 7pt; padding: 0;'>";
        $micad .= "                                <span style='font-weight: bold !important'>";
        $micad .=                                     $d['detallefact_codigo']." - ".$d['detallefact_descripcion'];
                                                    if($d['detallefact_preferencia']!='' && $d['detallefact_preferencia']!='null' && $d['detallefact_preferencia']!='-' ){
        $micad .=                                       " ".$d['detallefact_preferencia'];
                                                    }
                                                    if($d['detallefact_caracteristicas']!= '' && $d['detallefact_caracteristicas']!= null && $d['detallefact_caracteristicas']!='-' ){
        $micad .= "                                        <br>".nl2br($d['detallefact_caracteristicas']);
                                                    }
        $micad .= "                                </span>";
                                                    if ($d['detallefact_unidadfactor'] != "-" && $d['detallefact_unidadfactor'] != ""){
        $micad .= "                                      <br><span style='font-size: 10px'>Unidad de Medida: [".$d['detallefact_unidadfactor']."]</span>";
                                                    }
        $micad .= "                                ";
        $micad .= "                                </td>";
        //$micad .= "                                <td colspan='2'></td>";
        $micad .= "                            </tr>";
        $micad .= "                            <tr>";
        $micad .= "                                <td style='font-size: 8pt; padding: 0;'>";
        $micad .=                                     number_format($d['detallefact_cantidad'],$decimales,'.',',')." X ";
        $micad .=                                     number_format($d['detallefact_precio'],$decimales,'.',',')." - ";
        $micad .=                                     number_format($d['detallefact_descuentoparcial']*$d['detallefact_cantidad'],$decimales,'.',','); //." + "; //."0.00 +  0.00";
                                                    if ($mostrarice==1){
        $micad .= "                                         + ".number_format($d['detallefact_ice'],$decimales,'.',',')." + ";
        $micad .=                                         number_format($d['detallefact_iceesp'],$decimales,'.',',');
                                                    }
        $micad .= "                                </td>";
        $micad .= "                                <td style='width: 0.5cm !important;'></td>";
        $micad .= "                                <td align='right' style='font-size: 8pt; padding: 0;'>". number_format($d['detallefact_subtotal'] - ($d['detallefact_descuentoparcial']*$d['detallefact_cantidad']),$decimales,'.',',')."</td>";
        $micad .= "                            </tr>";
                                                }
                                            }
        $micad .= "                    </table>";
        $micad .= "                    </td>";
        $micad .= "                </tr>";
            $total_final_factura = $factura[0]['factura_subtotal']; 
            $factura_total = $factura[0]['factura_total'] - $factura[0]['factura_giftcard'];
            
            //Un artículo de la Ley Financial 317 para la gestión 2013 establece que por la presentación de facturas por consumo 
            //de diésel y gasolina, el crédito fiscal del IVA será sólo del 70% del valor de la compra, 
            //mientras que el 30% restante pasará a apoyar al Tesoro General de la Nación (TGN) 
            /*if($factura[0]['docsec_codigoclasificador'] == 12){
                $factura_total = $factura_total * 0.70;
            }*/
            if ($factura[0]['docsec_codigoclasificador']==12){ 

                $importe_base_iva = $factura_total * 0.70;

            }else{

                $importe_base_iva = $factura_total;
            }
                                 
                                
                                
                                
        $micad .= "                <tr>";
        $micad .= "                    <td colspan='4' style='padding: 0'>";
        $micad .= "                        <table style='width: ".$ancho."; font-size: 8pt !important' >";
        $micad .= "                            <tr style='border-top-style: dotted; border-top-width: 1px;'>";
        $micad .= "                                <td class='text-right' style='text-align: right'>SUBTOTAL Bs</td>";
        $micad .= "                                <td></td>";
        $micad .= "                                <td class='text-right' style='text-align: right'>".number_format($total_final_factura,$dos_decimales,'.',',')."</td>";
        $micad .= "                            </tr>";
        $micad .= "                            <tr>";
        $micad .= "                                <td class='text-right' style='text-align: right'>DESCUENTO Bs</td>";
        $micad .= "                                <td style='width: 1cm !important;'></td>";
        $micad .= "                                <td class='text-right' style='text-align: right'>".number_format($factura[0]['factura_descuento'],$dos_decimales,'.',',')."</td>";
        $micad .= "                            </tr>";
        $micad .= "                            <tr>";
        
        $elbold = "";
        if($factura[0]['docsec_codigoclasificador']==8){
            $elbold = "font-weight: bold !important";
        }
        
        $micad .= "                                <td style='text-align: right; ".$elbold."'>TOTAL Bs</td>";
        $micad .= "                                <td></td>";
        $micad .= "                                <td style='text-align: right; ".$elbold."'>".number_format($factura[0]['factura_total'],$dos_decimales,'.',',')."</td>";
        $micad .= "                            </tr>";
        
        if($factura[0]['docsec_codigoclasificador']!=2 && $factura[0]['docsec_codigoclasificador']!=39 && $factura[0]['docsec_codigoclasificador']!=51 && $factura[0]['docsec_codigoclasificador']!=12){ //Si es diferente de alquiler de bienes y venta gn/glp, Hidrocarburos
            
        $micad .= "                            <tr>";
        $micad .= "                                <td class='text-right text-bold' style='text-align: right'>MONTO GIFT CARD Bs</td>";
        $micad .= "                                <td></td>";
        $micad .= "                                <td class='text-right text-bold' style='text-align: right'>".number_format($factura[0]['factura_giftcard'],$dos_decimales,'.',',')."</td>";
        $micad .= "                            </tr>";
        }
        
        if ($mostrarice==1){
                                                    
            $micad .= "                            <tr>";
            $micad .= "                                <td class='text-right' style='text-align: right'>TOTAL ICE ESPEC&Iacute;FICO Bs</td>";
            $micad .= "                                <td></td>";
            $micad .= "                                <td class='text-right' style='text-align: right'>".number_format($ice,$dos_decimales,'.',','); //number_format($factura[0]['factura_ice'],$decimales,'.',',');
            $micad .= "                                </td>";
            $micad .= "                            </tr>";
            $micad .= "                            <tr>";
            $micad .= "                                <td class='text-right' style='text-align: right'>TOTAL ICE PORCENTUAL Bs</td>";
            $micad .= "                                <td></td>";
            $micad .= "                                <td class='text-right' style='text-align: right'> ".number_format($ice,$dos_decimales,'.',','); //number_format($factura[0]['factura_iceesp'],$decimales,'.',',');
            $micad .= "                                </td>";
            $micad .= "                            </tr>";
        
        }
        if($mostrarice==1 || $factura[0]['docsec_codigoclasificador']==8){                        
            $micad .= "                            <tr>";
            $micad .= "                                <td style='text-align: right; font-weight: bold !important'>MONTO A PAGAR Bs</td>";
            $micad .= "                                <td></td>";
            $micad .= "                                <td style='text-align: right; font-weight: bold !important'>".number_format($factura_total,$dos_decimales,'.',',')."</td>";
            $micad .= "                            </tr>";
        }
                
        
        if($factura[0]['docsec_codigoclasificador']!=8){ //Mostrar si no es Factura tasa cero
            //******************************************************
            $elimporte =  "IMPORTE BASE CR&Eacute;DITO FISCAL";
            if($opc == 12){ //Comercializacion de hidrocarburos
                $elimporte =  "IMPORTE BASE C/F MONTO LEY 317";
            } 
            
            $micad .= "                            <tr>";
            $micad .= "                                <td style='text-align: right; font-weight: bold !important'>".$elimporte."</td>";
            $micad .= "                                <td></td>";
            $micad .= "                                <td style='text-align: right; font-weight: bold !important'>".number_format($importe_base_iva,$dos_decimales,'.',',')."</td>";
            $micad .= "                            </tr>";
            
        }
        
        $micad .= "                            <tr style='border-bottom-style: dashed; border-bottom-width: 1px;'>";
        $micad .= "                                <td colspan='3' style='padding-left: 3px; padding-bottom: 5px; font-size: 10px;'>";
        $micad .= "                                    <br>";
        $micad .= "                                    SON: ".num_to_letras($factura_total,' Bolivianos');
        $micad .= "                                </td>";
        $micad .= "                            </tr>";
        $micad .= "                        </table>";
        $micad .= "                    </td>";
        $micad .= "                </tr>";
        $micad .= "                <tr>";
        $micad .= "                    <td class='text-center' style='padding: 0; padding-top: 5px;' colspan='4'>";
        $micad .= "                    <center>";
        $micad .= "                        <span style='font-size: 8.5pt'><p>".$factura[0]['factura_leyenda1']."</p></span>";
        $micad .= "                        <span style='font-size: 8pt !important;'><div style='line-height: 1.1;'>".$factura[0]['factura_leyenda2']."</div></span>";
        $micad .= "                        <span style='font-size: 6.5pt !important'><p style='padding-bottom: 0px'>".$factura[0]['factura_leyenda3']."</p></span>";
        $micad .= "                        <span style='font-size: 6.5pt !important'><p style='padding-bottom: 0px'>".$factura[0]['factura_leyenda4']."</p></span>";
        /*$micad .= "                        <span style='font-size: 6.5pt !important'>";
                                           if ($factura[0]['factura_tipoemision']==2){
        $micad .= "                            <p style='padding-bottom: 0px'><b>Este documento es la representación gráfica de un Documento Fiscal Digital emitido fuera de linea, verifique su envio con su proveedor o en la página web www.impuestos.gob.bo</b></p>";
                                           }
        $micad .= "                        </span>";*/
        $micad .= "                    </center>";
        $micad .= "                    </td>";   
        $micad .= "                </tr>";
        $micad .= "                <tr>";
        $micad .= "                    <td style='padding: 0; padding-top: 10px' colspan='4'>";
        $micad .= "                        <center>";
                $this->load->library('ciqrcode');
                $num_fact      = $factura[0]['factura_numero'];
                $nit_emisor    = $factura[0]['factura_nitemisor'];
                $ruta      = $factura[0]['factura_ruta'];
                $cuf       = $factura[0]['factura_cuf'];
                $tamanio   = $factura[0]['factura_tamanio'];
                $cadenaQR = $ruta.'nit='.$nit_emisor.'&cuf='.$cuf.'&numero='.$num_fact.'&t='.$tamanio;
                 //hacemos configuraciones
                $params['data'] = $cadenaQR;//$this->random(30);
                $params['level'] = 'H';
                $params['size'] = 5;
                $params['savename'] = FCPATH.'resources/images/qrcode'.$usuario_id.'.png'; //base_url('resources/images/qrcode.png'); //FCPATH.'resourcces\images\qrcode.png'; 
                $this->ciqrcode->generate($params);
                $base_url = explode('/', base_url());
                                                            $directorio_factura = $_SERVER['DOCUMENT_ROOT'].'/'.$base_url[3].'/resources/';
                                                            $codigoqr = $directorio_factura.'/images/qrcode'.$usuario_id.'.png';
                                                            $path = $codigoqr;
                                                            $type = pathinfo($path, PATHINFO_EXTENSION);
                                                            $data = file_get_contents($path);
                                                            $elcodigoqrbase64 = 'data:image/' . $type . ';base64,' . base64_encode($data);
        $micad .= "                            <img src='".$elcodigoqrbase64."' width='100' height='100' alt='Codigo QR'>"; 
        //$micad .= "                            <img src='".$codigoqr."' width='100' height='100'>";
        $micad .= "                        </center>";
        $micad .= "                    </td>";
        $micad .= "                </tr>";
        $micad .= "            </table>";
        $micad .= "        </td>";
        $micad .= "    </tr>";
        $micad .= "</table>";
        $micad .= "</body>"; 
        $micad .= "</html>";

        $dompdf = new Dompdf();
        $options = new Options();

        $options->set(array(
        'isRemoteEnabled' => true
        ));
        $dompdf->setOptions($options);
        
        if($this->parametros['parametro_tipoimpresora'] == "FACTURADORA"){
            $ancho = $this->parametros["parametro_anchofactura"];
            $elancho = (($ancho+2)*28.34645669291);
            $dompdf->set_paper(array(0, 0, $elancho, 841), 'portrait');
        }
        //$dompdf = new Dompdf(); 
        $dompdf->loadHtml($micad); 
        $dompdf->render(); 
        //salida al navegador 
        //$dompdf->stream(); 
        $base_url = explode('/', base_url()); 
        $directorio_factura = $_SERVER['DOCUMENT_ROOT'].'/'.$base_url[3].'/resources/xml/'; 
        $output = $dompdf->output(); 
        file_put_contents($directorio_factura.$nombre_archivo.$factura[0]['factura_id'].'.pdf', $output); 
        /* F I N  generar el pdf */ 

        //if( $this->parametros["parametro_tipoemision"] == 1){ // solo cuando esta en linea manda correo
            /*$email = $this->input->post('cliente_email'); 
            if($email !=""){
                $this->enviarcorreo($venta_id, $factura_id, $email,$nombre_archivo);

            }*/
    }
    
    function pdf_factura_boucher_prev($factura_id){
        
        $decimales = $this->parametros["parametro_decimales"];
        $factura = $this->Factura_model->get_factura_id($factura_id);
        $detalle_factura = $this->Detalle_venta_model->get_detalle_factura_id($factura_id);
        $empresa = $this->Empresa_model->get_empresa(1);
        //$parametros = $this->Parametro_model->get_parametros();
        $usuario_id = $this->session_data['usuario_id'];
        $nombre_archivo = $this->nombre_archivo;
        $micad = "";
        $micad .= "<!DOCTYPE html>"; 
        $micad .= "<html>"; 
        $micad .= "    <head>";
        $micad .= "        <style type='text/css'>";
        $micad .= "  p {";
        $micad .= "      font-family: Arial;";
        $micad .= "      font-size: 8pt;";
        $micad .= "      line-height: 80%;";   /*esta es la propiedad para el interlineado*/
        $micad .= "      color: #000;";
        $micad .= "      padding: 10px;";
        $micad .= "  }";
        $micad .= "  div {";
        $micad .= "      margin-top: 0px;";
        $micad .= "      margin-right: 0px;";
        $micad .= "      margin-bottom: 0px;";
        $micad .= "      margin-left: 0px;";
        $micad .= "      margin: 0px;";
        $micad .= "  }";
        $micad .= "  table{";
        $micad .= "      width : 7cm;";
        $micad .= "      margin : 0 0 0px 0;";
        $micad .= "      padding : 0 0 0 0;";
        $micad .= "      border-spacing : 0 0;";
        $micad .= "      border-collapse : collapse;";
        $micad .= "      font-family: Arial;";
        $micad .= "      font-size: 8pt;";
        $micad .= "      td{";
        $micad .= "          border:hidden;";
        $micad .= "      }";
        $micad .= "  }";
        $micad .= "  td#comentario {";
        $micad .= "      vertical-align : bottom;";
        $micad .= "      border-spacing : 0;";
        $micad .= "  }";
        $micad .= "  div#content {";
        $micad .= "      background : #ddd;";
        $micad .= "      font-size : 8px;";
        $micad .= "      margin : 0 0 0 0;";
        $micad .= "      padding : 0 0px 0 0px;";
        $micad .= "  }";
        $micad .= "       </style>"; 
        $micad .= "   </head>";
        $tipo_factura = $this->parametros["parametro_altofactura"]; //15 tamaño carta  
        $ancho = $this->parametros["parametro_anchofactura"]."cm"; 
        $margen_izquierdo = $this->parametros["parametro_margenfactura"]."cm"; 
        $micad .= "  <body style='width: ".$ancho."'>"; 
        $micad .= "  <table class='table'>";
        $micad .= "    <tr>";
        $micad .= "        <td style='padding: 0; width: ".$margen_izquierdo."'></td>";
        $micad .= "        <td style='padding: 0;'>";
        $micad .= "            <table class='table' style='width: ".$ancho."'>";
        $micad .= "                <tr>";
        $micad .= "                    <td style='padding: 0;' colspan='4'>";
        $micad .= "                        <table style='width: ".$ancho."' style='font-family: Arial'>";
        $micad .= "                            <tr>";
        $micad .= "                                <td class='text-center' style='padding-bottom: 5px;'><center>";
        $micad .= "                                     ";
                                                       $titulo1 = "FACTURA";
                                                       $tipo = 1;
                                                    if ($tipo==1) $subtitulo = "CON DERECHO A CRÉDITO FISCAL"; //$subtitulo = "ORIGINAL";
                                                    else $subtitulo = "CON DERECHO A CRÉDITO FISCAL"; //$subtitulo = "COPIA";";
        $micad .= "                                    ".$titulo1."<br>";
        $micad .= "                                    ".$subtitulo."<br>";
        $micad .=                                       $empresa[0]['empresa_nombre']."<br>";
        $micad .=                                       $empresa[0]['empresa_eslogan']."<br>";
                                                    if(isset($empresa[0]['empresa_propietario']) && ($empresa[0]['empresa_propietario']!="")){
        $micad .= "                                       DE: ".$empresa[0]['empresa_propietario']."<br>";
                                                    }
                                                    if($factura[0]['factura_sucursal']==0){
        $micad .= "                                            CASA MATRIZ";
                                                    }else{
        $micad .= "                                            SUCURSAL ".$factura[0]['factura_sucursal'];
                                                    }
        $micad .= "                                    <br>Nº PUNTO DE VENTA ".$factura[0]['factura_puntoventa']."<br>";
        $micad .=                                     $empresa[0]['empresa_direccion']."<br>";
        $micad .= "                                    Tel. ".$empresa[0]['empresa_telefono']."<br>";
        $micad .=                                     $empresa[0]['empresa_ubicacion']."<br>";
        $micad .= "                                ";
        $micad .= "                                </center></td>";
        $micad .= "                            </tr>";
        $micad .= "                        </table>";
        $micad .= "                        <table style='width:".$ancho."  font-family: Arial'>";
        $micad .= "                            <tr style='border-top-style: dashed; border-top-width: 1px;'>";
        $micad .= "                                <td class='text-center'><center>NIT: ".$factura[0]['factura_nitemisor']."</center></td>";
        $micad .= "                            </tr>";
//                                        $micad .= "                            <tr>";
//                                        $micad .= "                                <td class='text-center'><center>".$factura[0]['factura_nitemisor']."</center></td>";
//                                        $micad .= "                            </tr>";
        $micad .= "                            <tr>";
        $micad .= "                                <td class='text-center'><center>FACTURA Nº: ".$factura[0]['factura_numero']."</center></td>";
        $micad .= "                            </tr>";
//                                        $micad .= "                            <tr>";
//                                        $micad .= "                                <td class='text-center'><center>".$factura[0]['factura_numero']."</center></td>";
//                                        $micad .= "                            </tr>";
        $micad .= "                            <tr>";
        $micad .= "                                <td class='text-center'><center>CÓD. AUTORIZACIÓN</center></td>";
        $micad .= "                            </tr>";
        $micad .= "                            <tr>";
        $micad .= "                                <td class='text-center'><div style='word-wrap: break-word; width: ".$ancho."' ><center>".$factura[0]['factura_cuf']."</center></div></td>";
        $micad .= "                            </tr>";
        $micad .= "                        </table>";
        $micad .= "                    </td>";
        $micad .= "                </tr>";
        $micad .= "                <tr>";
        $micad .= "                    <td colspan='4' style='padding: 0;'>";
        $micad .= "                        <table style='width: ".$ancho."' >";
        $micad .= "                            <tr style='border-top-style: dashed; border-top-width: 1px;'>";
        $micad .= "                                <td class='text-right text-bold' style='padding: 0; white-space: nowrap; text-align: right'>NOMBRE/RAZ&Oacute;N SOCIAL: </td>";
        $micad .= "                                <td style='padding: 0; padding-left: 3px'>".$factura[0]['factura_razonsocial']."</td>";
        $micad .= "                            </tr>";
        $micad .= "                            <tr>";
        $micad .= "                                <td class='text-right text-bold' style='padding: 0; text-align: right'>NIT/CI/CEX: </td>";
        $micad .= "                                <td style='padding: 0; padding-left: 3px'>".$factura[0]['factura_nit']."  ";
                                               if($factura[0]['cdi_codigoclasificador']!=5){
        $micad .=                                  $factura[0]["cliente_complementoci"];
                                               }
        $micad .= "                                </td>";
        $micad .= "                            </tr>";
        $micad .= "                            <tr>";
        $micad .= "                                <td class='text-right text-bold' style='padding: 0; text-align: right'>COD. CLIENTE: </td><!-- PONER CODIGO DE CLIENTE -->";
        $micad .= "                                <td style='padding: 0; padding-left: 3px'>".$factura[0]['factura_codigocliente']."</b><br></td>";
        $micad .= "                            </tr>";
        $micad .= "                            <tr style='border-bottom-style: dashed; border-bottom-width: 1px;'>";
        $micad .= "                                <td class='text-right text-bold' style='padding: 0; text-align: right'>FECHA DE EMISI&Oacute;N: </td>";
        $micad .= "                                <td style='padding: 0; padding-left: 3px'>";
                                                    $fecha = new DateTime($factura[0]['factura_fecha']);
                                                    $fecha_d_m_a = $fecha->format('d/m/Y');
        $micad .=                                   $fecha_d_m_a." ".$factura[0]['factura_hora'];
        $micad .= "                                </td>";
        $micad .= "                            </tr>";
        $micad .= "                        </table>";
        $micad .= "                    </td>";
        $micad .= "                </tr>";
        $micad .= "                <tr>";
        $micad .= "                    <td colspan='4' align='center' style='padding: 0;'>DETALLE</td>";
        $micad .= "                </tr>";
        $micad .= "                <tr>";
        $micad .= "                    <td colspan='4' style='padding: 0'>";
        $micad .= "                        <table style='width: ".$ancho."'>";
                                            $cont = 0;
                                            $cantidad = 0;
                                            $total_descuento = 0;
                                            $total_final = 0;
                                            $total_subtotal = 0;
                                            $mostrarice = 0;
                                            $ice = 0;
                                            if($factura[0]['estado_id']<>3){
                                                foreach($detalle_factura as $d){;
                                                    $cont = $cont+1;
                                                    $cantidad += $d['detallefact_cantidad'];
                                                    $total_descuento += $d['detallefact_descuento']; 
                                                    $total_final += $d['detallefact_total']; 
        $micad .= "                            <tr>";
        $micad .= "                                <td class=-text-bold' colspan='0' style='font-size: 8pt; padding: 0;'>";
        $micad .= "                                ";
        $micad .=                                     $d['detallefact_codigo']." - ".$d['detallefact_descripcion'];
                                                    if ($d['detallefact_unidadfactor'] != "-" && $d['detallefact_unidadfactor'] != ""){
        $micad .= "                                      [".$d['detallefact_unidadfactor']."]";
                                                    }
                                                    if(isset($d['detallefact_preferencia']) && $d['detallefact_preferencia']!='null' && $d['detallefact_preferencia']!='-' ){
        $micad .=                                       $d['detallefact_preferencia'];
                                                    }
                                                    if(isset($d['detallefact_caracteristicas']) && $d['detallefact_caracteristicas']!='null' && $d['detallefact_caracteristicas']!='-' ){
        $micad .= "                                        <br>".nl2br($d['detallefact_caracteristicas']);
                                                    }
        $micad .= "                                ";
        $micad .= "                                </td>";
        $micad .= "                                <td colspan='2'></td>";
        $micad .= "                            </tr>";
        $micad .= "                            <tr>";
        $micad .= "                                <td style='font-size: 8pt; padding: 0;'>";
        $micad .=                                     number_format($d['detallefact_cantidad'],$decimales,'.',',')." X ";
        $micad .=                                     number_format($d['detallefact_precio'],$decimales,'.',',')." - ";
        $micad .=                                     number_format($d['detallefact_descuentoparcial']*$d['detallefact_cantidad'],$decimales,'.',','); //." + "; //."0.00 +  0.00";
                                                    /*if ($mostrarice==1){
        $micad .= "                                         + ".number_format($d['detallefact_ice'],$decimales,'.',',')." + ";
        $micad .=                                         number_format($d['detallefact_iceesp'],$decimales,'.',',');
                                                    }*/
        $micad .= "                                </td>";
        $micad .= "                                <td style='width: 0.5cm !important;'></td>";
        $micad .= "                                <td align='right' style='font-size: 8pt; padding: 0;'>". number_format($d['detallefact_subtotal'] - ($d['detallefact_descuentoparcial']*$d['detallefact_cantidad']),$decimales,'.',',')."</td>";
        $micad .= "                            </tr>";
                                                }
                                            }
        $micad .= "                    </table>";
        $micad .= "                    </td>";
        $micad .= "                </tr>";
                                $total_final_factura = $factura[0]['factura_subtotal']; 
                                $factura_total = $factura[0]['factura_total'] - $factura[0]['factura_giftcard'];
        $micad .= "                <tr>";
        $micad .= "                    <td colspan='4' style='padding: 0'>";
        $micad .= "                        <table style='width: ".$ancho."; font-size: 8pt !important' >";
        /*$micad .= "                            <tr style='border-top-style: dotted; border-top-width: 1px;'>";
        $micad .= "                                <td class='text-right' style='text-align: right'>SUBTOTAL Bs</td>";
        $micad .= "                                <td></td>";
        $micad .= "                                <td class='text-right' style='text-align: right'>".number_format($total_final_factura,$decimales,'.',',')."</td>";
        $micad .= "                            </tr>";
        $micad .= "                            <tr>";
        $micad .= "                                <td class='text-right' style='text-align: right'>DESCUENTO Bs</td>";
        $micad .= "                                <td style='width: 1cm !important;'></td>";
        $micad .= "                                <td class='text-right' style='text-align: right'>".number_format($factura[0]['factura_descuento'],$decimales,'.',',')."</td>";
        $micad .= "                            </tr>";
        $micad .= "                            <tr>";
        $micad .= "                                <td class='text-right' style='text-align: right'>TOTAL Bs</td>";
        $micad .= "                                <td></td>";
        $micad .= "                                <td class='text-right' style='text-align: right'>".number_format($factura[0]['factura_total'],$decimales,'.',',')."</td>";
        $micad .= "                            </tr>";
        $micad .= "                            <tr>";
        $micad .= "                                <td class='text-right text-bold' style='text-align: right'>MONTO GIFT CARD Bs</td>";
        $micad .= "                                <td></td>";
        $micad .= "                                <td class='text-right text-bold' style='text-align: right'>".number_format($factura[0]['factura_giftcard'],$decimales,'.',',')."</td>";
        $micad .= "                            </tr>";
                                                if ($mostrarice==1){
        $micad .= "                            <tr>";
        $micad .= "                                <td class='text-right' style='text-align: right'>TOTAL ICE ESPEC&Iacute;FICO Bs</td>";
        $micad .= "                                <td></td>";
        $micad .= "                                <td class='text-right' style='text-align: right'>".number_format($ice,$decimales,'.',','); //number_format($factura[0]['factura_ice'],$decimales,'.',',');
        $micad .= "                                </td>";
        $micad .= "                            </tr>";
        $micad .= "                            <tr>";
        $micad .= "                                <td class='text-right' style='text-align: right'>TOTAL ICE PORCENTUAL Bs</td>";
        $micad .= "                                <td></td>";
        $micad .= "                                <td class='text-right' style='text-align: right'> ".number_format($ice,$decimales,'.',','); //number_format($factura[0]['factura_iceesp'],$decimales,'.',',');
        $micad .= "                                </td>";
        $micad .= "                            </tr>";
                                                }*/
        $micad .= "                            <tr style='border-top-style: dotted; border-top-width: 1px;'>";
        $micad .= "                                <td class='text-right text-bold' style='text-align: right'>TOTAL Bs</td>";
        $micad .= "                                <td></td>";
        $micad .= "                                <td class='text-right text-bold' style='text-align: right'>".number_format($factura_total,$decimales,'.',',')."</td>";
        $micad .= "                            </tr>";
        $micad .= "                            <tr>";
        $micad .= "                                <td class='text-right text-bold' style='text-align: right'>IMPORTE BASE CR&Eacute;DITO FISCAL Bs</td>";
        $micad .= "                                <td></td>";
        $micad .= "                                <td class='text-right text-bold' style='text-align: right'>".number_format($factura_total,$decimales,'.',',')."</td>";
        $micad .= "                            </tr>";
        $micad .= "                            <tr style='border-bottom-style: dashed; border-bottom-width: 1px;'>";
        $micad .= "                                <td colspan='3' style='padding-left: 3px; padding-bottom: 5px; font-size: 10px;'>";
        $micad .= "                                    <br>";
        $micad .= "                                    SON: ".num_to_letras($factura_total,' Bolivianos');
        $micad .= "                                </td>";
        $micad .= "                            </tr>";
        $micad .= "                        </table>";
        $micad .= "                    </td>";
        $micad .= "                </tr>";
        $micad .= "                <tr>";
        $micad .= "                    <td class='text-center' style='padding: 0; padding-top: 5px;' colspan='4'>";
        $micad .= "                    <center>";
        $micad .= "                        <span style='font-size: 8.5pt'><p>".$factura[0]['factura_leyenda1']."</p></span>";
        $micad .= "                        <span style='font-size: 8pt !important;'><div style='line-height: 1.1;'>".$factura[0]['factura_leyenda2']."</div></span>";
        $micad .= "                        <span style='font-size: 6.5pt !important'><p style='padding-bottom: 0px'>".$factura[0]['factura_leyenda3']."</p></span>";
        $micad .= "                        <span style='font-size: 6.5pt !important'><p style='padding-bottom: 0px'>".$factura[0]['factura_leyenda4']."</p></span>";
        /*$micad .= "                        <span style='font-size: 6.5pt !important'>";
                                           if ($factura[0]['factura_tipoemision']==2){
        $micad .= "                            <p style='padding-bottom: 0px'><b>Este documento es la representación gráfica de un Documento Fiscal Digital emitido fuera de linea, verifique su envio con su proveedor o en la página web www.impuestos.gob.bo</b></p>";
                                           }
        $micad .= "                        </span>";*/
        $micad .= "                    </center>";
        $micad .= "                    </td>";   
        $micad .= "                </tr>";
        $micad .= "                <tr>";
        $micad .= "                    <td style='padding: 0; padding-top: 10px' colspan='4'>";
        $micad .= "                        <center>";
                $this->load->library('ciqrcode');
                $num_fact      = $factura[0]['factura_numero'];
                $nit_emisor    = $factura[0]['factura_nitemisor'];
                $ruta      = $factura[0]['factura_ruta'];
                $cuf       = $factura[0]['factura_cuf'];
                $tamanio   = $factura[0]['factura_tamanio'];
                $cadenaQR = $ruta.'nit='.$nit_emisor.'&cuf='.$cuf.'&numero='.$num_fact.'&t='.$tamanio;
                 //hacemos configuraciones
                $params['data'] = $cadenaQR;//$this->random(30);
                $params['level'] = 'H';
                $params['size'] = 5;
                $params['savename'] = FCPATH.'resources/images/qrcode'.$usuario_id.'.png'; //base_url('resources/images/qrcode.png'); //FCPATH.'resourcces\images\qrcode.png'; 
                $this->ciqrcode->generate($params);
                $base_url = explode('/', base_url());
                                                            $directorio_factura = $_SERVER['DOCUMENT_ROOT'].'/'.$base_url[3].'/resources/';
                                                            $codigoqr = $directorio_factura.'/images/qrcode'.$usuario_id.'.png';
                                                            $path = $codigoqr;
                                                            $type = pathinfo($path, PATHINFO_EXTENSION);
                                                            $data = file_get_contents($path);
                                                            $elcodigoqrbase64 = 'data:image/' . $type . ';base64,' . base64_encode($data);
        $micad .= "                            <img src='".$elcodigoqrbase64."' width='100' height='100' alt='Codigo QR'>"; 
        //$micad .= "                            <img src='".$codigoqr."' width='100' height='100'>";
        $micad .= "                        </center>";
        $micad .= "                    </td>";
        $micad .= "                </tr>";
        $micad .= "            </table>";
        $micad .= "        </td>";
        $micad .= "    </tr>";
        $micad .= "</table>";
        $micad .= "</body>"; 
        $micad .= "</html>";

        $dompdf = new Dompdf();
        $options = new Options();

        $options->set(array(
        'isRemoteEnabled' => true
        ));
        $dompdf->setOptions($options);
        
        if($this->parametros['parametro_tipoimpresora'] == "FACTURADORA"){
            $ancho = $this->parametros["parametro_anchofactura"];
            $elancho = (($ancho+2)*28.34645669291);
            $dompdf->set_paper(array(0, 0, $elancho, 841), 'portrait');
        }
        //$dompdf = new Dompdf(); 
        $dompdf->loadHtml($micad); 
        $dompdf->render(); 
        //salida al navegador 
        //$dompdf->stream(); 
        $base_url = explode('/', base_url()); 
        $directorio_factura = $_SERVER['DOCUMENT_ROOT'].'/'.$base_url[3].'/resources/xml/'; 
        $output = $dompdf->output(); 
        file_put_contents($directorio_factura.$nombre_archivo.$factura[0]['factura_id'].'.pdf', $output); 
        /* F I N  generar el pdf */ 

        //if( $this->parametros["parametro_tipoemision"] == 1){ // solo cuando esta en linea manda correo
            /*$email = $this->input->post('cliente_email'); 
            if($email !=""){
                $this->enviarcorreo($venta_id, $factura_id, $email,$nombre_archivo);

            }*/
    }
    /*  8: Factura tasa 0
     * 12: Factura Comercializacion de hidrocarburos
     * 51: Factura Engarrafadoras
     */
    function pdf_factura_carta($factura_id){
        
        //Facturas compra venta
        //Facturas alquiler bienes inmueble
        $decimales = $this->parametros["parametro_decimales"];
        $dos_decimales = 2;
        $factura = $this->Factura_model->get_factura_id($factura_id);
        $detalle_factura = $this->Detalle_venta_model->get_detalle_factura_id($factura_id);
        $empresa = $this->Empresa_model->get_empresa(1);
        //$parametros = $this->Parametro_model->get_parametros();
        $usuario_id = $this->session_data['usuario_id'];
        $nombre_archivo = $this->nombre_archivo;
        
        $micad = ""; 
        $micad .= "<!DOCTYPE html>"; 
        $micad .= "<html>"; 
        $micad .= "    <head>"; 
        //$micad .= "    <link rel='stylesheet' href='".base_url()."resources/css/bootstrap.min.css'>"; 
        $micad .= "        <style type='text/css'>"; 
        $micad .= "            @font-face {";
        $micad .= "                font-family : 'Arial' !important;";
                        $base_url = explode('/', base_url());
                        $directorio_factura = $_SERVER['DOCUMENT_ROOT'].'/'.$base_url[3].'/resources/';
        $micad .= "                 src: url('".$directorio_factura."fonts/arial.ttf') format('truetype');";
        $micad .= "            }";
        $micad .= "           p {"; 
        $micad .= "               font-family: Arial;"; 
        $micad .= "               font-size: 7pt;"; 
        $micad .= "               line-height: 120%;"; 
        $micad .= "               color: #000;"; 
        $micad .= "               padding: 10px;"; 
        $micad .= "           }"; 

        $micad .= "           div {"; 
        $micad .= "         margin-top: 0px;"; 
        $micad .= "           margin-right: 0px;"; 
        $micad .= "           margin-bottom: 0px;"; 
        $micad .= "           margin-left: 0px;"; 
        $micad .= "            margin: 0px;"; 
        $micad .= "           }"; 


        $micad .= "          table{"; 
        $micad .= "          width : 7cm;"; 
        $micad .= "           margin : 0 0 0px 0;"; 
        $micad .= "          padding : 0 0 0 0;"; 
        $micad .= "          border-spacing : 0 0;"; 
        $micad .= "          border-collapse : collapse;"; 
        $micad .= "          font-family: Arial;"; 
        $micad .= "          font-size: 7pt;  "; 

        $micad .= "          }"; 

        $micad .= "          .table-condensed tr td{"; 
        $micad .= "               border:1px solid black;"; 
        $micad .= "           }"; 

        $micad .= "           td#comentario {"; 
        $micad .= "               vertical-align : bottom;"; 
        $micad .= "               border-spacing : 0;"; 
        $micad .= "           }"; 
        $micad .= "          div#content {"; 
        $micad .= "            background : #ddd;"; 
        $micad .= "            font-size : 7px;"; 
        $micad .= "            margin : 0 0 0 0;"; 
        $micad .= "            padding : 0 5px 0 5px;"; 
        $micad .= "            border-left : 1px solid #aaa;"; 
        $micad .= "           border-right : 1px solid #aaa;"; 
        $micad .= "           border-bottom : 1px solid #aaa;"; 
        $micad .= "           }"; 
        $micad .= "       </style>"; 

        $micad .= "   </head>"; 
        $tipo_factura = $this->parametros["parametro_altofactura"]; //15 tamaño carta  
        $ancho = $this->parametros["parametro_anchofactura"]; 
        $margen_izquierdo = $this->parametros["parametro_margenfactura"]."cm"; 
        $micad .= "    <body style='width: ".$ancho."cm;'>"; 
        $micad .= "    <table class='table' style='width: ".$ancho."cm; margin-top: 20px;'>"; 
        $micad .= "        <tr>"; 
        $micad .= "           <td style='padding: 0; width: ".$margen_izquierdo."'></td>"; 
        $micad .= "            <td class='borde_pagina' style='padding: 0;'>"; 
        $micad .= "        <table class='table' style='margin-top: 20px;'>"; 
        $micad .= "        <tr>"; 
        $micad .= "        <td style='padding: 0; width: ".$margen_izquierdo."'></td>"; 
        $micad .= "        <td class='borde_pagina' style='padding: 0;'>"; 
        $micad .= "        <table class='table' style='width: ".$ancho."cm; padding: 0;' >"; 
        $micad .= "            <tr>"; 
        $micad .= "            <td>"; 
        $micad .= "            <table style='width: 100%; margin: 0;' >"; 
        $micad .= "            <tr>"; 
        $micad .= "                <td  style='width: ".round($ancho/3,2)."cm; padding: 0; line-height: 9px;'>"; 
        $micad .= "                    <center>"; 
        $micad .= "                            <div><font size='2' face='Arial'>".$empresa[0]['empresa_nombre']."</font></div>"; 
                                                if ($empresa[0]['empresa_eslogan'] != "" && $empresa[0]['empresa_eslogan'] != null){
        $micad .= "                                 <div><font size='1' face='Arial'><small>".$empresa[0]['empresa_eslogan']."</small></font><div>"; 
                                                }
        $micad .= "                            <div>"; 
        $micad .= "                            <font size='1' face='Arial'>"; 
        $micad .= "                            <small style='display:inline-block;margin-top: 0px;'>"; 
        $micad .= "                                "; 
                                                if($factura[0]['factura_sucursal']==0){ 
        $micad .= "                                            <div>CASA MATRIZ</div>"; 
                                                }else{ 
        $micad .= "                                            <div>SUCURSAL ".$factura[0]['factura_sucursal']."</div>"; 
                                                }
        $micad .= "                                Nº PUNTO DE VENTA ".$factura[0]['factura_puntoventa']."<br>"; 
        $micad .=                                 $empresa[0]['empresa_direccion']."<br>"; 
        $micad .= "                                Teléfono: ".$empresa[0]['empresa_telefono']."<br>"; 
        $micad .=                                 $empresa[0]['empresa_ubicacion']; 
        $micad .= "                            </small>"; 
        $micad .= "                            </font>"; 
        $micad .= "                            </div>"; 
        $micad .= "                    </center>"; 
        $micad .= "                </td>"; 
        $micad .= "                <td style='width: ".round($ancho/3,2)."cm; padding:0;line-height: 9px;'>"; 
        $micad .= "                </td>"; 
        $micad .= "                <td style='width: ".round($ancho/3,2)."cm;  padding: 0; line-height: 10px;'>"; 
        $micad .= "                    <table style='width: ".round($ancho/3,2)."cm; word-wrap: break-word; max-width: 6cm; padding:0; border-bottom: #0000eb'>"; 
        $micad .= "                        <tr>"; 
        $micad .= "                            <td style='font-family: arial; font-size: 8pt; -webkit-print-color-adjust: exact; white-space: nowrap; vertical-align: text-top;'  class='autoColor'>NIT: </td>"; 
        $micad .= "                            <td style='font-family: arial; font-size: 8pt; -webkit-print-color-adjust: exact; padding-left: 5px;'> ".$factura[0]['factura_nitemisor']."</td>"; 
        $micad .= "                        </tr>"; 
        $micad .= "                        <tr>"; 
        $micad .= "                            <td style='font-family: arial; font-size: 8pt; -webkit-print-color-adjust: exact; white-space: nowrap; vertical-align: text-top;'  class='autoColor'>FACTURA Nº: </td>"; 
        $micad .= "                            <td style='font-family: arial; font-size: 8pt; -webkit-print-color-adjust: exact; padding-left: 5px;'>".$factura[0]['factura_numero']."</td>"; 
        $micad .= "                        </tr>"; 
        $micad .= "                        <tr>"; 
        $micad .= "                            <td style='font-family: arial; font-size: 8pt; -webkit-print-color-adjust: exact; white-space: nowrap; vertical-align: text-top;'  class='autoColor'>CÓD AUTORIZACIÓN: </td>"; 
        $micad .= "                            <td style='font-family: arial; font-size: 8pt; padding-left: 5px; max-width: 3cm'><div style='word-wrap: break-word !important; padding=0px'>".$factura[0]['factura_cuf']."</div></td>"; 
        $micad .= "                        </tr>"; 
        $micad .= "                    </table>"; 
        $micad .= "                </td>"; 
        $micad .= "            </tr>"; 
                        $fecha = new DateTime($factura[0]['factura_fecha']);  
                        $fecha_d_m_a = $fecha->format('d/m/Y'); 
        $micad .= "            <tr style='padding: 0;'>"; 
        $micad .= "                <td colspan='3' style='padding: 0; font-family: Arial'>"; 
        $micad .= "                    <center style='margin-bottom:15px'>"; 
        
        
        $opc = $this->dosificacion["docsec_codigoclasificador"];
        if($opc == 12){ //Comercializacion de hidrocarburos
            $datos_factura = $this->Factura_datos_model->get_factura_datos($factura[0]['datos_id']);
        }
       // echo "opc: ".$opc;
        $subtitulo_factura = "Con Derecho a Cr&eacute;dito Fiscal";
        switch($opc){
            
                    
            case 1: $micad .= "<font size='4' face='arial'>FACTURA</font> <br>";
                    break;                
            case 2: $micad .= "<font size='4' face='arial'>FACTURA DE ALQUILER</font> <br>";
                    break;
            case 3: $micad .= "<font size='4' face='arial'>FACTURA</font> <br>";
                    break;
            case 4: $micad .= "<font size='4' face='arial'>FACTURA</font> <br>";
                    break;                
            case 5: $micad .= "<font size='4' face='arial'>FACTURA</font> <br>";
                    break;
                
            case 8: $micad .= "<font size='4' face='arial'>FACTURA TASA CERO - VENTA DE LIBROS O TRANSPORTE DE CARGA INTERNACIONAL</font> <br>";
                    $subtitulo_factura = "Sin Derecho a Cr&eacute;dito Fiscal";
                    break;
                
            case 23: $micad .= "<font size='4' face='arial'>FACTURA</font> <br>";
                    break;
                
            default: $micad .= "<font size='4' face='arial'>FACTURA</font> <br>";
                    break;
                
        }
        
        
        $micad .= "                        <font size='1' face='arial'>(".$subtitulo_factura.")</font> <br>"; 
        $micad .= "                    </center>"; 
        $micad .= "                </td>"; 
        $micad .= "            </tr>"; 
        $micad .= "            <tr>"; 
        $micad .= "                <td colspan='2'>";
        //$micad .= "                    <div style='display: inline-block; float:left; width:70%'>"; 
        $micad .= "                        <table style='word-wrap: break-word; width: 100%; padding:0; border-bottom: #0000eb;'>"; 
        $micad .= "                            <tr>"; 
        $micad .= "                                <td style='font-family: arial; font-size: 8pt; -webkit-print-color-adjust: exact; white-space: nowrap; vertical-align:text-top;width:20px;'  class='autoColor'>Fecha:</td>"; 
        $micad .= "                                <td style='font-family: arial; font-size: 8pt; -webkit-print-color-adjust: exact; padding-left: 3px;white-space: normal;'>".$fecha_d_m_a." ".$factura[0]['factura_hora']."</td>"; 
        $micad .= "                            </tr>"; 
        $micad .= "                            <tr>"; 
        $micad .= "                                <td style=' font-family: arial; font-size: 8pt; -webkit-print-color-adjust: exact; white-space: nowrap; vertical-align:text-top; ' class='autoColor'>Nombre/Razón Social:</td>"; 
        $micad .= "                                <td style='font-family: arial; font-size: 8pt; -webkit-print-color-adjust: exact; padding-left: 3px;white-space: normal;'>".$factura[0]['factura_razonsocial']."</td>"; 
        $micad .= "                            </tr>";
        if($opc == 12){ //Comercializacion de hidrocarburos
            $micad .= "                        <tr>"; 
            $micad .= "                            <td style=' font-family: arial; font-size: 8pt; -webkit-print-color-adjust: exact; white-space: nowrap; vertical-align:text-top; ' class='autoColor'>Placa/B-Sisa/Vin:</td>"; 
            $micad .= "                            <td style='font-family: arial; font-size: 8pt; -webkit-print-color-adjust: exact; padding-left: 3px;white-space: normal;'>".$datos_factura['datos_placa']."</td>"; 
            $micad .= "                        </tr>";
        }
        $micad .= "                        </table>"; 
        //$micad .= "                    </div>"; 
        $micad .= "                </td>"; 
        $micad .= "                <td>"; 
        //$micad .= "                    <div style='display: inline-block; float:left; width:30%'>"; 
        $micad .= "                        <table style='word-wrap: break-word; width: 100%; padding:0; border-bottom: #0000eb;'>"; 
        $micad .= "                            <tr>"; 
        $micad .= "                                <td style='font-family: arial; font-size: 8pt; -webkit-print-color-adjust: exact; white-space: nowrap; vertical-align:text-top;width:20px; ' class='autoColor'>NIT/CI/CEX:</td>"; 
        $micad .= "                                <td style='font-family: arial; font-size: 8pt; -webkit-print-color-adjust: exact; padding-left: 3px;white-space: normal;'>".$factura[0]['factura_nit']."  ";
                                                    if ($factura[0]['cdi_codigoclasificador']!=5){
        $micad .=                                        $factura[0]["cliente_complementoci"];
                                                    }
        $micad .= "</td>"; 
        $micad .= "                            </tr>"; 
        $micad .= "                            <tr>"; 
        $micad .= "                                <td style='font-family: arial; font-size: 8pt; -webkit-print-color-adjust: exact; white-space: nowrap; vertical-align:text-top;'  class='autoColor'>Cod. Cliente:</td>"; 
        $micad .= "                                <td style='font-family: arial; font-size: 8pt; -webkit-print-color-adjust: exact; padding-left: 3px;white-space: normal;'>".$factura[0]['factura_codigocliente']."</td>"; 
        $micad .= "                            </tr>";
        if($opc == 12){ //Comercializacion de hidrocarburos
            $micad .= "                        <tr>"; 
            $micad .= "                            <td style='font-family: arial; font-size: 8pt; -webkit-print-color-adjust: exact; white-space: nowrap; vertical-align:text-top;'  class='autoColor'>Tipo Envase:</td>"; 
            $micad .= "                            <td style='font-family: arial; font-size: 8pt; -webkit-print-color-adjust: exact; padding-left: 3px;white-space: normal;'>".$datos_factura['datos_embase']."</td>"; 
            $micad .= "                        </tr>"; 
        }

        if($factura[0]['docsec_codigoclasificador']==2){
                $micad .= "                            <tr>"; 
                $micad .= "                                <td style='font-family: arial; font-size: 8pt; -webkit-print-color-adjust: exact; white-space: nowrap; vertical-align:text-top;'  class='autoColor'>Periodo Facturado:</td>"; 
                $micad .= "                                <td style='font-family: arial; font-size: 8pt; -webkit-print-color-adjust: exact; padding-left: 3px;white-space: normal;'>".$factura[0]['factura_glosa']."</td>"; 
                $micad .= "                            </tr>";
        }
        
        $micad .= "                        </table>"; 
        //$micad .= "                    </div>"; 
        $micad .= "                </td>"; 
        $micad .= "            </tr>"; 
        $micad .= "            </table>";
        $micad .= "            <br>";
        $micad .= "            </td>"; 
        $micad .= "            </tr>"; 
                         $mostrarice = 0; //sin ice  
        $micad .= "            <tr>"; 
        $micad .= "                <td>"; 

        $colorCelda = "style='padding: 0; background-color: #aaa !important; -webkit-print-color-adjust: exact;'";

        $micad .= "                    <table class='table-condensed'  style='width: 100%; margin: 0;' >"; 
        $micad .= "                        <tr  style=' font-family: arial; border: 1px solid black '>"; 
        
        if($factura[0]['docsec_codigoclasificador']==2){
            $micad .= "                            <td align='center' ".$colorCelda.">C&Oacute;DIGO<br> SERVICIO</td>"; 
        }else{
            $micad .= "                            <td align='center' ".$colorCelda.">C&Oacute;DIGO<br> PRODUCTO</td>"; 
        }
        
        $micad .= "                            <td align='center' ".$colorCelda.">CANTIDAD</td>"; 
        $micad .= "                            <td align='center' ".$colorCelda.">UNIDAD <br>DE MEDIDA</td>"; 
        $micad .= "                            <td align='center' ".$colorCelda.">DESCRIPCI&Oacute;N</td>"; 
        $micad .= "                            <td align='center' ".$colorCelda.">PRECIO<br> UNITARIO</td>"; 
        $micad .= "                            <td align='center' ".$colorCelda.">DESCUENTO</td>"; 
                                    if ($mostrarice==1){ 
        $micad .= "                            <td align='center' ".$colorCelda.">ICE %</td>"; 
        $micad .= "                            <td align='center' ".$colorCelda.">ICE ESP.</td>"; 
                                    } 
        $micad .= "                            <td align='center' ".$colorCelda.">SUBTOTAL</td>"; 
        $micad .= "                        </tr>"; 
                                    $cont = 0; 
                                    $cantidad = 0; 
                                    $total_descuentoparcial = 0; 
                                    $total_descuento = 0; 
                                    $total_final = 0; 
                                    $total_subtotal = 0; 
                                    $ice = 0.00; 
                                    if ($factura[0]['estado_id']<>3){  
                                        foreach($detalle_factura as $d){ 
                                            $cont = $cont+1; 
                                            $cantidad += $d['detallefact_cantidad']; 
                                            $sub_total = $d['detallefact_subtotal']; 
                                            $total_subtotal += $sub_total; 
                                            $total_descuentoparcial += $d['detallefact_descuentoparcial'] * $d['detallefact_cantidad'];  
                                            $total_descuento += $d['detallefact_descuento'];  
                                            $total_final += $d['detallefact_total'];  
        $micad .= "                        <tr style='border: 1px solid black'>"; 
        $micad .= "                            <td align='left' style='padding: 0; padding-left:3px;'><font style='size:7px; font-family: arial'>".$d['detallefact_codigo']."</font></td>"; 
        $micad .= "                            <td align='right' style='padding: 0; padding-right:3px;'><font style='size:7px; font-family: arial'>".number_format($d['detallefact_cantidad'],$decimales,'.',',')."</font></td>"; 
        $micad .= "                            <td align='left' style='padding: 0; padding-left:3px;'><font style='size:7px; font-family: arial'><center>".$d['producto_unidad']."</center></font></td>"; 
        $micad .= "                            <td colspan='1' style='padding: 0; line-height: 10px;'>"; 
        $micad .= "                                <font style='size:7px; font-family: arial; padding-left:3px'> "; 
        $micad .=                                     $d['detallefact_descripcion']; 
                                            if(isset($d['detallefact_preferencia']) && $d['detallefact_preferencia']!='null' && $d['detallefact_preferencia']!='-' ) { 
        $micad .=                                         $d['detallefact_preferencia']; 
                                            } 
                                            if(isset($d['detallefact_caracteristicas']) && $d['detallefact_caracteristicas']!='null' && $d['detallefact_caracteristicas']!='-' ){ 
        $micad .= "                                        <br>".nl2br($d['detallefact_caracteristicas']); 
                                            } 
        $micad .= "                                </font>"; 
        $micad .= "                            </td>"; 
        $micad .= "                            <td align='right' style='padding: 0; padding-right: 3px;'><font style='size:7px; font-family: arial'>".number_format($d['detallefact_precio'],$decimales,'.',',')."</font></td>"; 
        $micad .= "                            <td align='right' style='padding-right: 3px;'>".number_format($d['detallefact_descuentoparcial']*$d['detallefact_cantidad'],$decimales,'.',',')."</td>"; 
                                    if($mostrarice==1){ 
        $micad .= "                                <td align='right' style='padding-right: 3px;'>".number_format($ice,$decimales,'.',',')."</td>"; 
        $micad .= "                                <td align='right' style='padding: 0; padding-right: 3px;'><font style='size:7px; font-family: arial'>".number_format($ice,$decimales,'.',',')."</font></td>"; 
                                    } 
        $micad .= "                            <td align='right' style='padding: 0; padding-right: 3px;'><font style='size:7px; font-family: arial'>".number_format($d['detallefact_subtotal'] - ($d['detallefact_descuentoparcial']*$d['detallefact_cantidad']) ,$decimales,'.',',')."</font></td>"; 
        $micad .= "                        </tr>"; 
                             }} 
                                $total_final_factura = $factura[0]['factura_subtotal']; 
                                $factura_total = $factura[0]['factura_total'] - $factura[0]['factura_giftcard'];
                                $span = ($mostrarice==1)? 3: 2; 
                                
                            if ($factura[0]['docsec_codigoclasificador']==12){ 
                                    
                                    $importe_base_iva = $factura_total * 0.70;
                                    
                                }else{
                                    
                                    $importe_base_iva = $factura_total;
                                }
                                 
                                
        $micad .= "                    <!-------------- SUB TOTAL ---------->"; 
        $micad .= "                    <tr>"; 
        $micad .= "                        <td style='padding:0; border-left: none !important;border-bottom: none !important;' colspan='4' rowspan='6'>SON: ".num_to_letras($factura_total,' Bolivianos')."</td>"; 
        $micad .= "                        <td style='padding:0; padding-right: 3px;' colspan='".$span."' align='right'>SUBTOTAL Bs</td>"; 
        $micad .= "                        <td style='padding:0; padding-right: 3px;' align='right'>".number_format($total_final_factura,$dos_decimales,'.',',')."</td>"; 
        $micad .= "                    </tr>"; 
        $micad .= "                    <!-------------- DESCUENTO ---------->"; 
        $micad .= "                    <tr>"; 
        $micad .= "                        <td style='padding:0; padding-right: 3px;' colspan='".$span."' align='right'>DESCUENTO Bs</td>"; 
        $micad .= "                        <td style='padding:0; padding-right: 3px;' align='right'>".number_format($factura[0]['factura_descuento'],$dos_decimales,'.',',')."</td>"; 
        $micad .= "                    </tr>"; 
        $micad .= "                    <!-------------- DECUENTO GLOBAL ---------->"; 
                             //if($factura[0]['factura_descuento']>0){ 
        /*$micad .= "                        <!--<tr>"; 
        $micad .= "                            <td style='padding:0; padding-right: 3px;' colspan='".$span."' align='right'>(-)DESCUENTO GLOBAL Bs</td>"; 
        $micad .= "                            <td style='padding:0; padding-right: 3px;' align='right'>".number_format($factura[0]['factura_descuento'],$dos_decimales,'.',',')."</td>";
        $micad .= "                        </tr>--> */ 
                             //} 
        $micad .= "                    <!-------------- FACTURA TOTAL ---------->"; 
        $micad .= "                    <tr>"; 
        $micad .= "                        <td class='text-bold' style='padding:0; padding-right: 3px;' colspan='".$span."' align='right'>TOTAL Bs</td>"; 
        $micad .= "                        <td class='text-bold' style='padding:0; padding-right: 3px;' align='right'>".number_format($factura[0]['factura_total'] ,$dos_decimales,'.',',')."</td>"; 
        $micad .= "                    </tr>"; 
        
        if($factura[0]['docsec_codigoclasificador']!=2 && $factura[0]['docsec_codigoclasificador']!=39 && $factura[0]['docsec_codigoclasificador']!=51 && $factura[0]['docsec_codigoclasificador']!=12){ //Si es diferente de alquiler de bienes y venta gn/glp, Hidrocarburos
        
          $micad .= "                          <!-------------- FACTURA GIFTA CARD ---------->";
          
          $micad .= "      <tr>";
          $micad .= "          <td style='padding:0; padding-right: 3px;' colspan='".$span."' align='right'>MONTO GIFT CARD Bs</td>";
          $micad .= "          <td style='padding:0; padding-right: 3px;' align='right'>".number_format($factura[0]['factura_giftcard'] ,$dos_decimales,'.',',')."</td>";
          $micad .= "      </tr>";
          
        }  
          
        $micad .= "                    <!-------------- ICE / ICE ESPECIFICO ---------->"; 
        
        if($mostrarice==1){
        $micad .= "                    <tr>"; 
        $micad .= "                        <td style='padding:0; padding-right: 3px;' colspan='".$span."' align='right'>(-) TOTAL ICE ESPEC&Iacute;FICO Bs</td>"; 
        $micad .= "                        <td style='padding:0; padding-right: 3px;' align='right'>".number_format($ice,$dos_decimales,'.',',')."</td>"; 
        $micad .= "                    </tr>"; 
        $micad .= "                    <tr>"; 
        $micad .= "                        <td style='padding:0; padding-right: 3px;' colspan='".$span."' align='right'>(-) TOTAL ICE PORCENTUAL Bs</td>"; 
        $micad .= "                        <td style='padding:0; padding-right: 3px;' align='right'>".number_format($ice,$dos_decimales,'.',',')."</td>"; 
        $micad .= "                    </tr>"; 
                             } 
                             
        $micad .= "                                             <!-------------- MONTO A PAGAR ---------->";
        
        if($mostrarice==1 || $factura[0]['docsec_codigoclasificador']==8){ // Mostrar si es factura con ICE o Tasa Cero
        $micad .= "    <tr>           ";
        $micad .= "        <td style='padding:0; padding-right: 3px;' colspan='".$span."' align='right'>MONTO A PAGAR Bs</td>";
        $micad .= "        <td style='padding:0; padding-right: 3px;' align='right'>".number_format($factura_total,$dos_decimales,'.',',')."</td>";
        $micad .= "    </tr>";
        }
        
        if($factura[0]['docsec_codigoclasificador']!=8){ //Mostrar si no es Factura tasa cero
            
        $micad .= "                    <!-------------- IMPORTE BASE CREDITO FISCAL ---------->"; 
        $micad .= "                    <tr>"; 
        
        
        //Un artículo de la Ley Financial 317 para la gestión 2013 establece que por la presentación de facturas por consumo 
        //de diésel y gasolina, el crédito fiscal del IVA será sólo del 70% del valor de la compra, 
        //mientras que el 30% restante pasará a apoyar al Tesoro General de la Nación (TGN) 
        if($factura[0]['docsec_codigoclasificador'] == 12){
            $factura_total = $factura_total * 0.70;
        }
        //******************************************************
        $elimporte =  "IMPORTE BASE CR&Eacute;DITO FISCAL";
        if($opc == 12){ //Comercializacion de hidrocarburos
            $elimporte =  "IMPORTE BASE C/F MONTO LEY 317";
        }        
        $micad .= "                        <td class='text-bold' style='padding:0; padding-right: 3px;' colspan='".$span."' align='right'>".$elimporte."</td>"; 
        $micad .= "                        <td class='text-bold' style='padding:0; padding-right: 3px;' align='right'>".number_format($importe_base_iva ,$dos_decimales,'.',',')."</td>"; 
        $micad .= "                    </tr>";
        
        }
        
        $micad .= "                </table>"; 
        $micad .= "            </td>"; 
        $micad .= "        </tr>"; 
        $micad .= "        <tr>"; 
        $micad .= "            <td style='padding-top: 0px; padding-bottom: 0px;'>"; 
        $micad .= "                <table style='width: 100%; margin-top: 25px;'>"; 
        $micad .= "                    <tr>"; 
        $micad .= "                       <td style='float: left;width: 78%;'>"; 
        //$micad .= "                <div style='width: 100%; margin-top: 25px;'>"; 
        //$micad .= "                    <div style='float: left;width: 78%;'>"; 
        $micad .= "                        <center style='width:100%;'>"; 
        $micad .=                             $factura[0]['factura_leyenda1']."<br><br>"; 
        $micad .= "                            <font face='Arial' size='1'>".$factura[0]['factura_leyenda2']; 
        $micad .= "                            </font><br><br>"; 
        $micad .=                             $factura[0]['factura_leyenda3']."<br><br>"; 
        $micad .=                                 $factura[0]['factura_leyenda4']; 

        $micad .= "                        </center>"; 
        //$micad .= "                    </div>"; 
        $micad .= "                        </td>";
        $micad .= "                        <td style='float: right;width: 80px;'>"; 
        //$micad .= "                    <div style='float: right;width: 80px;'>"; 
        //$micad .= "                        <figure>";


             //generamos el código qr
        //$this->load->helper('numeros_helper'); // Helper para convertir numeros a letras
                //Generador de Codigo QR
                        //cargamos la librerí­a	
                 $this->load->library('ciqrcode');
                 //$nit_emisor    = $factura[0]['factura_nitemisor'];
                $num_fact      = $factura[0]['factura_numero'];
                //$autorizacion  = $factura[0]['factura_autorizacion'];
                //$fecha_factura = $factura[0]['factura_fechaventa'];
                //$total         = $factura[0]['factura_total'];
                //$codcontrol    = $factura[0]['factura_codigocontrol'];
                //$nit           = $factura[0]['factura_nit'];
                 $nit_emisor    = $factura[0]['factura_nitemisor'];
                 $ruta      = $factura[0]['factura_ruta'];
                    $cuf       = $factura[0]['factura_cuf'];
                    $tamanio   = $factura[0]['factura_tamanio'];
                         $cadenaQR = $ruta.'nit='.$nit_emisor.'&cuf='.$cuf.'&numero='.$num_fact.'&t='.$tamanio;
                 //hacemos configuraciones
                 $params['data'] = $cadenaQR;//$this->random(30);
                 $params['level'] = 'H';
                 $params['size'] = 5;
                 $params['savename'] = FCPATH.'resources/images/qrcode'.$usuario_id.'.png'; //base_url('resources/images/qrcode.png'); //FCPATH.'resourcces\images\qrcode.png'; 
                $this->ciqrcode->generate($params);
                                                $base_url = explode('/', base_url());
                    $directorio_factura = $_SERVER['DOCUMENT_ROOT'].'/'.$base_url[3].'/resources/';
                    $codigoqr = $directorio_factura.'/images/qrcode'.$usuario_id.'.png';
                    $path = $codigoqr;
                    $type = pathinfo($path, PATHINFO_EXTENSION);
                    $data = file_get_contents($path);
                    $elcodigoqrbase64 = 'data:image/' . $type . ';base64,' . base64_encode($data);
        $micad .= "                            <img src='".$elcodigoqrbase64."' width='80' height='80' alt='Codigo QR'>"; 
        //$micad .= "                        </figure>"; 
        //$micad .= "                    </div>"; 
        //$micad .= "                </div>"; 
        $micad .= "                      </td>"; 
        $micad .= "                   </tr>"; 
        $micad .= "                </table>"; 
        $micad .= "            </td>"; 
        $micad .= "        </tr>";                                        
        $micad .= "    </table>"; 
        $micad .= "</td>"; 
        $micad .= "</tr>"; 
        $micad .= "</table>"; 
        $micad .= "</body>"; 
        $micad .= "</html>"; 

        $dompdf = new Dompdf();
        $options = new Options();

        $options->set(array(
            'isRemoteEnabled' => true
        ));
        $dompdf->setOptions($options);
        
        if($this->parametros['parametro_tipoimpresora'] == "FACTURADORA"){
            $ancho = $this->parametros["parametro_anchofactura"];
            $elancho = (($ancho+2)*28.34645669291);
            $dompdf->set_paper(array(0, 0, $elancho, 841), 'portrait');
        }
        //$dompdf = new Dompdf(); 
        $dompdf->loadHtml($micad); 
        $dompdf->render(); 
        //salida al navegador 
        //$dompdf->stream(); 
        $base_url = explode('/', base_url()); 
        $directorio_factura = $_SERVER['DOCUMENT_ROOT'].'/'.$base_url[3].'/resources/xml/'; 
        $output = $dompdf->output(); 
        file_put_contents($directorio_factura.$nombre_archivo.$factura[0]['factura_id'].'.pdf', $output); 
        //file_put_contents($directorio_factura."PRUEBAPDF".$factura[0]['factura_id'].'.pdf', $output); 
        /* F I N  generar el pdf */ 

         /*   $email = $this->input->post('cliente_email'); 
            if($email !=""){
                $this->enviarcorreo($venta_id, $factura_id, $email,$nombre_archivo);

            }*/
    }
    
    function pdf_factura_carta_prev($factura_id){
        
        $decimales = $this->parametros["parametro_decimales"];
        $factura = $this->Factura_model->get_factura_id($factura_id);
        $detalle_factura = $this->Detalle_venta_model->get_detalle_factura_id($factura_id);
        $empresa = $this->Empresa_model->get_empresa(1);
        //$parametros = $this->Parametro_model->get_parametros();
        $usuario_id = $this->session_data['usuario_id'];
        $nombre_archivo = $this->nombre_archivo;
        
        $micad = ""; 
        $micad .= "<!DOCTYPE html>"; 
        $micad .= "<html>"; 
        $micad .= "    <head>"; 
        //$micad .= "    <link rel='stylesheet' href='".base_url()."resources/css/bootstrap.min.css'>"; 
        $micad .= "        <style type='text/css'>"; 
        $micad .= "            @font-face {";
        $micad .= "                font-family : 'Arial' !important;";
                        $base_url = explode('/', base_url());
                        $directorio_factura = $_SERVER['DOCUMENT_ROOT'].'/'.$base_url[3].'/resources/';
        $micad .= "                 src: url('".$directorio_factura."fonts/arial.ttf') format('truetype');";
        $micad .= "            }";
        $micad .= "           p {"; 
        $micad .= "               font-family: Arial;"; 
        $micad .= "               font-size: 7pt;"; 
        $micad .= "               line-height: 120%;"; 
        $micad .= "               color: #000;"; 
        $micad .= "               padding: 10px;"; 
        $micad .= "           }"; 

        $micad .= "           div {"; 
        $micad .= "         margin-top: 0px;"; 
        $micad .= "           margin-right: 0px;"; 
        $micad .= "           margin-bottom: 0px;"; 
        $micad .= "           margin-left: 0px;"; 
        $micad .= "            margin: 0px;"; 
        $micad .= "           }"; 


        $micad .= "          table{"; 
        $micad .= "          width : 7cm;"; 
        $micad .= "           margin : 0 0 0px 0;"; 
        $micad .= "          padding : 0 0 0 0;"; 
        $micad .= "          border-spacing : 0 0;"; 
        $micad .= "          border-collapse : collapse;"; 
        $micad .= "          font-family: Arial;"; 
        $micad .= "          font-size: 7pt;  "; 

        $micad .= "          }"; 

        $micad .= "          .table-condensed tr td{"; 
        $micad .= "               border:1px solid black;"; 
        $micad .= "           }"; 

        $micad .= "           td#comentario {"; 
        $micad .= "               vertical-align : bottom;"; 
        $micad .= "               border-spacing : 0;"; 
        $micad .= "           }"; 
        $micad .= "          div#content {"; 
        $micad .= "            background : #ddd;"; 
        $micad .= "            font-size : 7px;"; 
        $micad .= "            margin : 0 0 0 0;"; 
        $micad .= "            padding : 0 5px 0 5px;"; 
        $micad .= "            border-left : 1px solid #aaa;"; 
        $micad .= "           border-right : 1px solid #aaa;"; 
        $micad .= "           border-bottom : 1px solid #aaa;"; 
        $micad .= "           }"; 
        $micad .= "       </style>"; 

        $micad .= "   </head>"; 
        $tipo_factura = $this->parametros["parametro_altofactura"]; //15 tamaño carta  
        $ancho = $this->parametros["parametro_anchofactura"]; 
        $margen_izquierdo = $this->parametros["parametro_margenfactura"]."cm"; 
        $micad .= "    <body style='width: ".$ancho."cm;'>"; 
        $micad .= "    <table class='table' style='width: ".$ancho."cm; margin-top: 20px;'>"; 
        $micad .= "        <tr>"; 
        $micad .= "           <td style='padding: 0; width: ".$margen_izquierdo."'></td>"; 
        $micad .= "            <td class='borde_pagina' style='padding: 0;'>"; 
        $micad .= "        <table class='table' style='margin-top: 20px;'>"; 
        $micad .= "        <tr>"; 
        $micad .= "        <td style='padding: 0; width: ".$margen_izquierdo."'></td>"; 
        $micad .= "        <td class='borde_pagina' style='padding: 0;'>"; 
        $micad .= "        <table class='table' style='width: ".$ancho."cm; padding: 0;' >"; 
        $micad .= "            <tr>"; 
        $micad .= "            <td>"; 
        $micad .= "            <table style='width: 100%; margin: 0;' >"; 
        $micad .= "            <tr>"; 
        $micad .= "                <td  style='width: ".round($ancho/3,2)."cm; padding: 0; line-height: 9px;'>"; 
        $micad .= "                    <center>"; 
        $micad .= "                            <font size='2' face='Arial'>".$empresa[0]['empresa_nombre']."</font><br>"; 
                                                if ($empresa[0]['empresa_eslogan'] != "" && $empresa[0]['empresa_eslogan'] != null){
        $micad .= "                                    <font size='1' face='Arial'><small>".$empresa[0]['empresa_eslogan']."</small></font><br>"; 
                                                }

        $micad .= "                            <font size='1' face='Arial'>"; 
        $micad .= "                            <small style='display:inline-block;margin-top: 0px;'>"; 
        $micad .= "                                "; 
                                                if($factura[0]['factura_sucursal']==0){ 
        $micad .= "                                            CASA MATRIZ<br>"; 
                                                }else{ 
        $micad .= "                                            SUCURSAL ".$factura[0]['factura_sucursal']."<br>"; 
                                                }
        $micad .= "                                Nº PUNTO DE VENTA ".$factura[0]['factura_puntoventa']."<br>"; 
        $micad .=                                 $empresa[0]['empresa_direccion']."<br>"; 
        $micad .= "                                Teléfono: ".$empresa[0]['empresa_telefono']."<br>"; 
        $micad .=                                 $empresa[0]['empresa_ubicacion']; 
        $micad .= "                            </small>"; 
        $micad .= "                            </font>"; 
        $micad .= "                    </center>"; 
        $micad .= "                </td>"; 
        $micad .= "                <td style='width: ".round($ancho/3,2)."cm; padding:0;line-height: 9px;'>"; 
        $micad .= "                </td>"; 
        $micad .= "                <td style='width: ".round($ancho/3,2)."cm;  padding: 0; line-height: 10px;'>"; 
        $micad .= "                    <table style='width: ".round($ancho/3,2)."cm; word-wrap: break-word; max-width: 6cm; padding:0; border-bottom: #0000eb'>"; 
        $micad .= "                        <tr>"; 
        $micad .= "                            <td style='font-family: arial; font-size: 8pt; -webkit-print-color-adjust: exact; white-space: nowrap; vertical-align: text-top;'  class='autoColor'>NIT: </td>"; 
        $micad .= "                            <td style='font-family: arial; font-size: 8pt; -webkit-print-color-adjust: exact; padding-left: 5px;'> ".$factura[0]['factura_nitemisor']."</td>"; 
        $micad .= "                        </tr>"; 
        $micad .= "                        <tr>"; 
        $micad .= "                            <td style='font-family: arial; font-size: 8pt; -webkit-print-color-adjust: exact; white-space: nowrap; vertical-align: text-top;'  class='autoColor'>FACTURA Nº: </td>"; 
        $micad .= "                            <td style='font-family: arial; font-size: 8pt; -webkit-print-color-adjust: exact; padding-left: 5px;'>".$factura[0]['factura_numero']."</td>"; 
        $micad .= "                        </tr>"; 
        $micad .= "                        <tr>"; 
        $micad .= "                            <td style='font-family: arial; font-size: 8pt; -webkit-print-color-adjust: exact; white-space: nowrap; vertical-align: text-top;'  class='autoColor'>CÓD AUTORIZACIÓN: </td>"; 
        $micad .= "                            <td style='font-family: arial; font-size: 8pt; padding-left: 5px; max-width: 3cm'><div style='word-wrap: break-word !important; padding=0px'>".$factura[0]['factura_cuf']."</div></td>"; 
        $micad .= "                        </tr>"; 
        $micad .= "                    </table>"; 
        $micad .= "                </td>"; 
        $micad .= "            </tr>"; 
                        $fecha = new DateTime($factura[0]['factura_fecha']);  
                        $fecha_d_m_a = $fecha->format('d/m/Y'); 
        $micad .= "            <tr style='padding: 0;'>"; 
        $micad .= "                <td colspan='3' style='padding: 0; font-family: Arial'>"; 
        $micad .= "                    <center style='margin-bottom:15px'>"; 
        $micad .= "                        <font size='4' face='arial'>FACTURA</font> <br>"; 
        $micad .= "                        <font size='1' face='arial'>(Con Derecho a Cr&eacute;dito Fiscal)</font> <br>"; 
        $micad .= "                    </center>"; 
        $micad .= "                </td>"; 
        $micad .= "            </tr>"; 
        $micad .= "            <tr>"; 
        $micad .= "                <td colspan='2'>";
        //$micad .= "                    <div style='display: inline-block; float:left; width:70%'>"; 
        $micad .= "                        <table style='word-wrap: break-word; width: 100%; padding:0; border-bottom: #0000eb;'>"; 
        $micad .= "                            <tr>"; 
        $micad .= "                                <td style='font-family: arial; font-size: 8pt; -webkit-print-color-adjust: exact; white-space: nowrap; vertical-align:text-top;width:20px;'  class='autoColor'>Fecha:</td>"; 
        $micad .= "                                <td style='font-family: arial; font-size: 8pt; -webkit-print-color-adjust: exact; padding-left: 3px;white-space: normal;'>".$fecha_d_m_a." ".$factura[0]['factura_hora']."</td>"; 
        $micad .= "                            </tr>"; 
        $micad .= "                            <tr>"; 
        $micad .= "                                <td style=' font-family: arial; font-size: 8pt; -webkit-print-color-adjust: exact; white-space: nowrap; vertical-align:text-top; ' class='autoColor'>Nombre/Razón Social:</td>"; 
        $micad .= "                                <td style='font-family: arial; font-size: 8pt; -webkit-print-color-adjust: exact; padding-left: 3px;white-space: normal;'>".$factura[0]['factura_razonsocial']."</td>"; 
        $micad .= "                            </tr>"; 
        $micad .= "                        </table>"; 
        //$micad .= "                    </div>"; 
        $micad .= "                </td>"; 
        $micad .= "                <td>"; 
        //$micad .= "                    <div style='display: inline-block; float:left; width:30%'>"; 
        $micad .= "                        <table style='word-wrap: break-word; width: 100%; padding:0; border-bottom: #0000eb;'>"; 
        $micad .= "                            <tr>"; 
        $micad .= "                                <td style='font-family: arial; font-size: 8pt; -webkit-print-color-adjust: exact; white-space: nowrap; vertical-align:text-top;width:20px; ' class='autoColor'>NIT/CI/CEX:</td>"; 
        $micad .= "                                <td style='font-family: arial; font-size: 8pt; -webkit-print-color-adjust: exact; padding-left: 3px;white-space: normal;'>".$factura[0]['factura_nit']."  ";
                                                    if ($factura[0]['cdi_codigoclasificador']!=5){
        $micad .=                                        $factura[0]["cliente_complementoci"];
                                                    }
        $micad .= "</td>"; 
        $micad .= "                            </tr>"; 
        $micad .= "                            <tr>"; 
        $micad .= "                                <td style='font-family: arial; font-size: 8pt; -webkit-print-color-adjust: exact; white-space: nowrap; vertical-align:text-top;'  class='autoColor'>Cod. Cliente:</td>"; 
        $micad .= "                                <td style='font-family: arial; font-size: 8pt; -webkit-print-color-adjust: exact; padding-left: 3px;white-space: normal;'>".$factura[0]['factura_codigocliente']."</td>"; 
        $micad .= "                            </tr>"; 
        $micad .= "                        </table>"; 
        //$micad .= "                    </div>"; 
        $micad .= "                </td>"; 
        $micad .= "            </tr>"; 
        $micad .= "            </table>";
        $micad .= "            <br>";
        $micad .= "            </td>"; 
        $micad .= "            </tr>"; 
                         $mostrarice = 0; //sin ice  
        $micad .= "            <tr>"; 
        $micad .= "                <td>"; 

        $colorCelda = "style='padding: 0; background-color: #aaa !important; -webkit-print-color-adjust: exact;'";

        $micad .= "                    <table class='table-condensed'  style='width: 100%; margin: 0;' >"; 
        $micad .= "                        <tr  style=' font-family: arial; border: 1px solid black '>"; 
        $micad .= "                            <td align='center' ".$colorCelda.">C&Oacute;DIGO<br> PRODUCTO/SERVICIO</td>"; 
        $micad .= "                            <td align='center' ".$colorCelda.">CANTIDAD</td>"; 
        $micad .= "                            <td align='center' ".$colorCelda.">UNIDAD <br>DE MEDIDA</td>"; 
        $micad .= "                            <td align='center' ".$colorCelda.">DESCRIPCI&Oacute;N</td>"; 
        $micad .= "                            <td align='center' ".$colorCelda.">PRECIO<br> UNITARIO</td>"; 
        $micad .= "                            <td align='center' ".$colorCelda.">DESCUENTO</td>"; 
                                    /*if ($mostrarice==1){ 
        $micad .= "                            <td align='center' ".$colorCelda.">ICE %</td>"; 
        $micad .= "                            <td align='center' ".$colorCelda.">ICE ESP.</td>"; 
                                    }*/ 
        $micad .= "                            <td align='center' ".$colorCelda.">SUBTOTAL</td>"; 
        $micad .= "                        </tr>"; 
                                    $cont = 0; 
                                    $cantidad = 0; 
                                    $total_descuentoparcial = 0; 
                                    $total_descuento = 0; 
                                    $total_final = 0; 
                                    $total_subtotal = 0; 
                                    $ice = 0.00; 
                                    if ($factura[0]['estado_id']<>3){  
                                        foreach($detalle_factura as $d){ 
                                            $cont = $cont+1; 
                                            $cantidad += $d['detallefact_cantidad']; 
                                            $sub_total = $d['detallefact_subtotal']; 
                                            $total_subtotal += $sub_total; 
                                            $total_descuentoparcial += $d['detallefact_descuentoparcial'] * $d['detallefact_cantidad'];  
                                            $total_descuento += $d['detallefact_descuento'];  
                                            $total_final += $d['detallefact_total'];  
        $micad .= "                        <tr style='border: 1px solid black'>"; 
        $micad .= "                            <td align='left' style='padding: 0; padding-left:3px;'><font style='size:7px; font-family: arial'>".$d['detallefact_codigo']."</font></td>"; 
        $micad .= "                            <td align='right' style='padding: 0; padding-right:3px;'><font style='size:7px; font-family: arial'>".number_format($d['detallefact_cantidad'],$decimales,'.',',')."</font></td>"; 
        $micad .= "                            <td align='left' style='padding: 0; padding-left:3px;'><font style='size:7px; font-family: arial'><center>".$d['producto_unidad']."</center></font></td>"; 
        $micad .= "                            <td colspan='1' style='padding: 0; line-height: 10px;'>"; 
        $micad .= "                                <font style='size:7px; font-family: arial; padding-left:3px'> "; 
        $micad .=                                     $d['detallefact_descripcion']; 
                                            if(isset($d['detallefact_preferencia']) && $d['detallefact_preferencia']!='null' && $d['detallefact_preferencia']!='-' ) { 
        $micad .=                                         $d['detallefact_preferencia']; 
                                            } 
                                            if(isset($d['detallefact_caracteristicas']) && $d['detallefact_caracteristicas']!='null' && $d['detallefact_caracteristicas']!='-' ){ 
        $micad .= "                                        <br>".nl2br($d['detallefact_caracteristicas']); 
                                            } 
        $micad .= "                                </font>"; 
        $micad .= "                            </td>"; 
        $micad .= "                            <td align='right' style='padding: 0; padding-right: 3px;'><font style='size:7px; font-family: arial'>".number_format($d['detallefact_precio'],$decimales,'.',',')."</font></td>"; 
        $micad .= "                            <td align='right' style='padding-right: 3px;'>".number_format($d['detallefact_descuentoparcial']*$d['detallefact_cantidad'],$decimales,'.',',')."</td>"; 
                                    /*if($mostrarice==1){ 
        $micad .= "                                <td align='right' style='padding-right: 3px;'>".number_format($ice,$decimales,'.',',')."</td>"; 
        $micad .= "                                <td align='right' style='padding: 0; padding-right: 3px;'><font style='size:7px; font-family: arial'>".number_format($ice,$decimales,'.',',')."</font></td>"; 
                                    } */
        $micad .= "                            <td align='right' style='padding: 0; padding-right: 3px;'><font style='size:7px; font-family: arial'>".number_format($d['detallefact_subtotal'] - ($d['detallefact_descuentoparcial']*$d['detallefact_cantidad']) ,$decimales,'.',',')."</font></td>"; 
        $micad .= "                        </tr>"; 
                             }} 
                                $total_final_factura = $factura[0]['factura_subtotal']; 
                                $factura_total = $factura[0]['factura_total'] - $factura[0]['factura_giftcard'];
                                $span = 2; //($mostrarice==1)? 3: 2; 
        /*$micad .= "                    <!-------------- SUB TOTAL ---------->"; 
        $micad .= "                    <tr>"; 
        $micad .= "                        <td style='padding:0; border-left: none !important;border-bottom: none !important;' colspan='4' rowspan='6'>SON: ".num_to_letras($factura_total,' Bolivianos')."</td>"; 
        $micad .= "                        <td style='padding:0; padding-right: 3px;' colspan='".$span."' align='right'>SUBTOTAL Bs</td>"; 
        $micad .= "                        <td style='padding:0; padding-right: 3px;' align='right'>".number_format($total_final_factura,$decimales,'.',',')."</td>"; 
        $micad .= "                    </tr>"; 
        $micad .= "                    <!-------------- DESCUENTO ---------->"; 
        $micad .= "                    <tr>"; 
        $micad .= "                        <td style='padding:0; padding-right: 3px;' colspan='".$span."' align='right'>(-)DESCUENTO Bs</td>"; 
        $micad .= "                        <td style='padding:0; padding-right: 3px;' align='right'>".number_format($factura[0]['factura_descuento'],$decimales,'.',',')."</td>"; 
        $micad .= "                    </tr>"; 
        $micad .= "                    <!-------------- DECUENTO GLOBAL ---------->"; 
                             //if($factura[0]['factura_descuento']>0){ 
        /*$micad .= "                        <!--<tr>"; 
        $micad .= "                            <td style='padding:0; padding-right: 3px;' colspan='".$span."' align='right'>(-)DESCUENTO GLOBAL Bs</td>"; 
        $micad .= "                            <td style='padding:0; padding-right: 3px;' align='right'>".number_format($factura[0]['factura_descuento'],$decimales,'.',',')."</td>";
        $micad .= "                        </tr>--> */ 
                             //} 
       /* $micad .= "                    <!-------------- FACTURA TOTAL ---------->"; 
        $micad .= "                    <tr>"; 
        $micad .= "                        <td style='padding:0; padding-right: 3px;' colspan='".$span."' align='right'>TOTAL Bs</td>"; 
        $micad .= "                        <td style='padding:0; padding-right: 3px;' align='right'>".number_format($factura[0]['factura_total'] ,$decimales,'.',',')."</td>"; 
        $micad .= "                    </tr>"; 
          $micad .= "                          <!-------------- FACTURA GIFTA CARD ---------->";
          $micad .= "      <tr>";
          $micad .= "          <td style='padding:0; padding-right: 3px;' colspan='".$span."' align='right'>MONTO GIFT CARD Bs</td>";
          $micad .= "          <td style='padding:0; padding-right: 3px;' align='right'>".number_format($factura[0]['factura_giftcard'] ,$decimales,'.',',')."</td>";
          $micad .= "      </tr>";
        $micad .= "                    <!-------------- ICE / ICE ESPECIFICO ---------->"; 
        */
                            /*if($mostrarice==1){
        $micad .= "                    <tr>"; 
        $micad .= "                        <td style='padding:0; padding-right: 3px;' colspan='".$span."' align='right'>(-) TOTAL ICE ESPEC&Iacute;FICO Bs</td>"; 
        $micad .= "                        <td style='padding:0; padding-right: 3px;' align='right'>".number_format($ice,$decimales,'.',',')."</td>"; 
        $micad .= "                    </tr>"; 
        $micad .= "                    <tr>"; 
        $micad .= "                        <td style='padding:0; padding-right: 3px;' colspan='".$span."' align='right'>(-) TOTAL ICE PORCENTUAL Bs</td>"; 
        $micad .= "                        <td style='padding:0; padding-right: 3px;' align='right'>".number_format($ice,$decimales,'.',',')."</td>"; 
        $micad .= "                    </tr>"; 
                             } */
        $micad .= "                                             <!-------------- MONTO A PAGAR ---------->";
        $micad .= "    <tr>           ";
        $micad .= "        <td style='padding:0; border-left: none !important;border-bottom: none !important;' colspan='4' rowspan='6'>SON: ".num_to_letras($factura_total,' Bolivianos')."</td>"; 
        $micad .= "        <td style='padding:0; padding-right: 3px;' colspan='".$span."' align='right'>TOTAL Bs</td>";
        $micad .= "        <td style='padding:0; padding-right: 3px;' align='right'>".number_format($factura_total,$decimales,'.',',')."</td>";
        $micad .= "    </tr>";
        $micad .= "                    <!-------------- IMPORTE BASE CREDITO FISCAL ---------->"; 
        $micad .= "                    <tr>"; 
        $micad .= "                        <td style='padding:0; padding-right: 3px;' colspan='".$span."' align='right'>IMPORTE BASE CR&Eacute;DITO FISCAL</td>"; 
        $micad .= "                        <td style='padding:0; padding-right: 3px;' align='right'>".number_format($factura_total ,$decimales,'.',',')."</td>"; 
        $micad .= "                    </tr>"; 
        $micad .= "                </table>"; 
        $micad .= "            </td>"; 
        $micad .= "        </tr>"; 
        $micad .= "        <tr>"; 
        $micad .= "            <td style='padding-top: 0px; padding-bottom: 0px;'>"; 
        $micad .= "                <table style='width: 100%; margin-top: 25px;'>"; 
        $micad .= "                    <tr>"; 
        $micad .= "                       <td style='float: left;width: 78%;'>"; 
        //$micad .= "                <div style='width: 100%; margin-top: 25px;'>"; 
        //$micad .= "                    <div style='float: left;width: 78%;'>"; 
        $micad .= "                        <center style='width:100%;'>"; 
        $micad .=                             $factura[0]['factura_leyenda1']."<br><br>"; 
        $micad .= "                            <font face='Arial' size='1'>".$factura[0]['factura_leyenda2']; 
        $micad .= "                            </font><br><br>"; 
        $micad .=                             $factura[0]['factura_leyenda3']."<br><br>"; 
        $micad .=                                 $factura[0]['factura_leyenda4']; 

        $micad .= "                        </center>"; 
        //$micad .= "                    </div>"; 
        $micad .= "                        </td>";
        $micad .= "                        <td style='float: right;width: 80px;'>"; 
        //$micad .= "                    <div style='float: right;width: 80px;'>"; 
        //$micad .= "                        <figure>";


             //generamos el código qr
        //$this->load->helper('numeros_helper'); // Helper para convertir numeros a letras
                //Generador de Codigo QR
                        //cargamos la librerí­a	
                 $this->load->library('ciqrcode');
                 //$nit_emisor    = $factura[0]['factura_nitemisor'];
                $num_fact      = $factura[0]['factura_numero'];
                //$autorizacion  = $factura[0]['factura_autorizacion'];
                //$fecha_factura = $factura[0]['factura_fechaventa'];
                //$total         = $factura[0]['factura_total'];
                //$codcontrol    = $factura[0]['factura_codigocontrol'];
                //$nit           = $factura[0]['factura_nit'];
                 $nit_emisor    = $factura[0]['factura_nitemisor'];
                 $ruta      = $factura[0]['factura_ruta'];
                    $cuf       = $factura[0]['factura_cuf'];
                    $tamanio   = $factura[0]['factura_tamanio'];
                         $cadenaQR = $ruta.'nit='.$nit_emisor.'&cuf='.$cuf.'&numero='.$num_fact.'&t='.$tamanio;
                 //hacemos configuraciones
                 $params['data'] = $cadenaQR;//$this->random(30);
                 $params['level'] = 'H';
                 $params['size'] = 5;
                 $params['savename'] = FCPATH.'resources/images/qrcode'.$usuario_id.'.png'; //base_url('resources/images/qrcode.png'); //FCPATH.'resourcces\images\qrcode.png'; 
                $this->ciqrcode->generate($params);
                                                $base_url = explode('/', base_url());
                    $directorio_factura = $_SERVER['DOCUMENT_ROOT'].'/'.$base_url[3].'/resources/';
                    $codigoqr = $directorio_factura.'/images/qrcode'.$usuario_id.'.png';
                    $path = $codigoqr;
                    $type = pathinfo($path, PATHINFO_EXTENSION);
                    $data = file_get_contents($path);
                    $elcodigoqrbase64 = 'data:image/' . $type . ';base64,' . base64_encode($data);
        $micad .= "                            <img src='".$elcodigoqrbase64."' width='80' height='80' alt='Codigo QR'>"; 
        //$micad .= "                        </figure>"; 
        //$micad .= "                    </div>"; 
        //$micad .= "                </div>"; 
        $micad .= "                      </td>"; 
        $micad .= "                   </tr>"; 
        $micad .= "                </table>"; 
        $micad .= "            </td>"; 
        $micad .= "        </tr>";                                        
        $micad .= "    </table>"; 
        $micad .= "</td>"; 
        $micad .= "</tr>"; 
        $micad .= "</table>"; 
        $micad .= "</body>"; 
        $micad .= "</html>"; 

        $dompdf = new Dompdf();
        $options = new Options();

        $options->set(array(
            'isRemoteEnabled' => true
        ));
        $dompdf->setOptions($options);
        
        if($this->parametros['parametro_tipoimpresora'] == "FACTURADORA"){
            $ancho = $this->parametros["parametro_anchofactura"];
            $elancho = (($ancho+2)*28.34645669291);
            $dompdf->set_paper(array(0, 0, $elancho, 841), 'portrait');
        }
        //$dompdf = new Dompdf(); 
        $dompdf->loadHtml($micad); 
        $dompdf->render(); 
        //salida al navegador 
        //$dompdf->stream(); 
        $base_url = explode('/', base_url()); 
        $directorio_factura = $_SERVER['DOCUMENT_ROOT'].'/'.$base_url[3].'/resources/xml/'; 
        $output = $dompdf->output(); 
        file_put_contents($directorio_factura.$nombre_archivo.$factura[0]['factura_id'].'.pdf', $output); 
        //file_put_contents($directorio_factura."PRUEBAPDF".$factura[0]['factura_id'].'.pdf', $output); 
        /* F I N  generar el pdf */ 

         /*   $email = $this->input->post('cliente_email'); 
            if($email !=""){
                $this->enviarcorreo($venta_id, $factura_id, $email,$nombre_archivo);

            }*/
    }
    
    function simular_evento(){
        
        $sql = "select * from simulacion_evento";
        $resultado = $this->Venta_model->consultar($sql);
        echo json_encode($resultado);
    }
    
    /** fue creada para verificar cuantos items(productos) hay en detalle
     *  es para el documento sector prevalorada(23) que solo admite un item */
    function verificaritem_endetalle()
    {
        $usuario_id = $this->session_data['usuario_id'];
        
        $sql = "select count(*) as cantidad from detalle_venta_aux where usuario_id = ".$usuario_id;
        $resultado = $this->Venta_model->consultar($sql);
        $res = $resultado[0]['cantidad'];
        $respuesta = "";
        if($res == 0){
            $respuesta = "ok";
        }elseif($res == 1){
            $respuesta = "ok";
        }else{
            $respuesta = "no";
        }
        echo json_encode($respuesta);
    }
    
    /*************** funcion para mostrar la vista de la ultima factura en PDF******************/
    function ultimaventapdf(){
        
        
        if($this->acceso(12)||$this->acceso(30)){
            $venta = $this->Venta_model->ultima_venta();
            $venta_tipodoc = $venta[0]['venta_tipodoc'];
            $venta_id = $venta[0]['venta_id'];

            if ($venta_tipodoc==1){
                $sql = "select factura_id from factura where venta_id = ".$venta[0]['venta_id'];
                $resultado = $this->Venta_model->consultar($sql);
                $dosificacion = $this->Dosificacion_model->get_all_dosificacion();
                
                $base_url = explode('/', base_url());
                    $directorio_factura = $_SERVER['DOCUMENT_ROOT'].'/'.$base_url[3].'/resources/xml/';
                    $nombre_archivo = $dosificacion[0]['dosificacion_documentosector'].$resultado[0]['factura_id'].'.pdf';
                      if(file_exists($directorio_factura.$nombre_archivo)){
                          redirect('resources/xml/'.$dosificacion[0]['dosificacion_documentosector'].$resultado[0]['factura_id'].'.pdf');
                      }
            }
        }
        
    }
    /*************** funcion para mostrar la vista de la factura en PDF******************/
    function facturaventapdf($factura_id){
        
        if($this->acceso(12)||$this->acceso(30)){
                $dosificacion = $this->Dosificacion_model->get_all_dosificacion();
                $base_url = explode('/', base_url());
                    $directorio_factura = $_SERVER['DOCUMENT_ROOT'].'/'.$base_url[3].'/resources/xml/';
                    $nombre_archivo = $dosificacion[0]['dosificacion_documentosector'].$factura_id.'.pdf';
                      if(file_exists($directorio_factura.$nombre_archivo)){
                          redirect('resources/xml/'.$dosificacion[0]['dosificacion_documentosector'].$factura_id.'.pdf');
                      }
            //}
        }

    }
    

    /*
     * Obtener el producto pen base al id
     */
    function get_producto_id()
    {
        //**************** inicio contenido ***************   
        
        if ($this->input->is_ajax_request()) {
            
            $producto_id = $this->input->post('producto_id');            
            $result = $this->Venta_model->get_producto_id($producto_id);
            
            echo json_encode($result);
            
        }
        else
        {                 
                    show_404();
        }    
       //**************** fin contenido ***************
        			       
    }       
    
}