<?php
/* 
 * Generated by CRUDigniter v3.2 
 * www.crudigniter.com
 */
 
class Cambio_producto extends CI_Controller{
    function __construct()
    {
        parent::__construct();
        $this->load->model('Cambio_producto_model');
        $this->load->model('Producto_model');
          $this->load->model('Inventario_model');
    } 

    /*
     * Listing of cambio_producto
     */
     

    
    function index()
    {   
        
           if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
            $usuario_id = $session_data['usuario_id'];
           

        $this->load->model('Detalle_venta_model');
        $data['detalle_venta'] = $this->Detalle_venta_model->get_all_detalle_ventas();
        $this->load->model('Detalle_compra_model');
        $data['detalle_compra'] = $this->Detalle_compra_model->get_all_detalle_compras();
        $data['cambio_producto'] = $this->Cambio_producto_model->get_all_cambio_producto();
        $data['_view'] = 'cambio_producto/index';
        $this->load->view('layouts/main',$data);
            }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }

    /*
     * Adding a new cambio_producto
     */
function devolverproducto()
    {   
       
        
          if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
                $usuario_id = $session_data['usuario_id'];
        $cambio_producto_id = $this->input->post('cambio_producto_id');
        $producto_id = $this->input->post('producto_id');
        $cantidad = $this->input->post('cantidad'); 
        $descuento = $this->input->post('descuento'); 
        $producto_costo = $this->input->post('producto_costo');
        $producto_precio = $this->input->post('producto_precio');
        
        
       $sql = "INSERT into detalle_compra(
                
                producto_id,
                detallecomp_codigo,
                detallecomp_unidad,
                detallecomp_costo,
                detallecomp_cantidad,
                detallecomp_precio,
                detallecomp_descuento,
                detallecomp_subtotal,
                detallecomp_total,
                cambio_id              
                )
                (
                SELECT
                
                producto_id,
                producto_codigo,
                producto_unidad,
                ".$producto_costo.",
                ".$cantidad.",
                ".$producto_precio.",
                ".$descuento.",
                ".$cantidad." * ".$producto_precio.",
                (".$cantidad." * ".$producto_precio.") - ".$descuento.",
                ".$cambio_producto_id."
                
                from producto where producto_id = ".$producto_id."
                )";

                $pro = "UPDATE producto
                SET
                      
                producto_costo = ".$producto_costo.",
                producto_precio = ".$producto_precio."
                      
                WHERE producto_id = ".$producto_id."
                ";

        $this->Cambio_producto_model->ejecutar($pro);
        $this->Cambio_producto_model->ejecutar($sql);
         redirect('cambio_producto/add/'.$cambio_producto_id);
            }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }
    function crearcambio()
    {
        
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {    
                $usuario_id = $session_data['usuario_id'];
        $cambio_producto_id = $this->Cambio_producto_model->crear_cambio($usuario_id);        
        redirect('cambio_producto/add/'.$cambio_producto_id);
            }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
        
    }
    function entradas()
{
        $usuario_id = 1;

        if ($this->input->is_ajax_request()) {
            
            $parametro = $this->input->post('parametro');   
            
            if ($parametro!=""){
            $datos = $this->Inventario_model->get_inventario_coti($parametro);            
            //$datos = $this->Inventario_model->get_inventario_bloque();
            echo json_encode($datos);
            }
            else echo json_encode(null);
        }
        else
        {                 
            show_404();
        }              
}

 function salidas()
{
        $usuario_id = 1;

        if ($this->input->is_ajax_request()) {
            
            $parametro = $this->input->post('parametro');   
            
            if ($parametro!=""){
            $datos = $this->Inventario_model->get_inventario_coti($parametro);            
            //$datos = $this->Inventario_model->get_inventario_bloque();
            echo json_encode($datos);
            }
            else echo json_encode(null);
        }
        else
        {                 
            show_404();
        }              
}
     function addee()
    {   
        if(isset($_POST) && count($_POST) > 0)     
        {   
            $params = array(
                'cambio_producto_fecha' => $this->input->post('cambio_producto_fecha'),
                'detallecomp_id' => $this->input->post('detallecomp_id'),
                'detallevent_id' => $this->input->post('detallevent_id'),
                'cambio_egreso' => $this->input->post('cambio_egreso'),
                'cambio_ingreso' => $this->input->post('cambio_ingreso'),
            );
            
            $cambio_producto_id = $this->Cambio_producto_model->add_cambio_producto($params);
            redirect('cambio_producto/index');
        }
        else
        {            
            $data['_view'] = 'cambio_producto/add';
            $this->load->view('layouts/main',$data);
        }
    }  

    function add($cambio_producto_id)
    {   
         
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
            $usuario_id = $session_data['usuario_id'];
        
            $data['cambio_producto'] = $this->Cambio_producto_model->get_cambio_producto($cambio_producto_id);
            $this->load->model('Detalle_compra_model');
            $data['cambio_producto_id'] = $cambio_producto_id;
             $this->load->model('Detalle_compra_model');
            $data['detalle_compra'] = $this->Cambio_producto_model->get_detalle_compra($cambio_producto_id);
             $this->load->model('Detalle_venta_model');
            $data['detalle_venta'] = $this->Cambio_producto_model->get_detalle_venta($cambio_producto_id);
          
            $this->load->model('Producto_model');
            $data['inventario'] = $this->Producto_model->get_all_productos();       
            $data['_view'] = 'cambio_producto/add';
            $this->load->view('layouts/main',$data);
         
            }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }
     function anular($cambio_producto_id)
    {   
       
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
             $usuario_id = $session_data['usuario_id'];
        
            $data['cambio_producto'] = $this->Cambio_producto_model->get_cambio_producto($cambio_producto_id);
            $this->load->model('Detalle_compra_model');
            $data['cambio_producto_id'] = $cambio_producto_id;
             $this->load->model('Detalle_compra_model');
            $data['detalle_compra'] = $this->Cambio_producto_model->get_detalle_compra($cambio_producto_id);
             $this->load->model('Detalle_venta_model');
            $data['detalle_venta'] = $this->Cambio_producto_model->get_detalle_venta($cambio_producto_id);
          
            $this->load->model('Inventario_model');
            //$this->load->model('Producto_model');
            //$data['inventario'] = $this->Producto_model->get_all_productos();    
            $data['inventario'] = $this->Inventario_model->get_inventario();
            $data['_view'] = 'cambio_producto/anular';
            $this->load->view('layouts/main',$data);
         
            }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }

     function anulacion($cambio_producto_id)
    {
       
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {  
                 $usuario_id = $session_data['usuario_id'];
      //  $cambio_producto_id = $this->input->post('cambio_producto_id');
        $comp = "UPDATE detalle_compra
                SET
                detallecomp_cantidad = 0,               
                detallecomp_descuento = 0,
                detallecomp_subtotal = 0,
                detallecomp_total = 0                       
                WHERE cambio_id = ".$cambio_producto_id."
                ";

        $this->Cambio_producto_model->ejecutar($comp);

        $vent = "UPDATE detalle_venta
                SET
                detalleven_cantidad = 0,               
                detalleven_descuento = 0,
                detalleven_subtotal = 0,
                detalleven_total = 0                       
                WHERE cambio_id = ".$cambio_producto_id."
                ";

        $this->Cambio_producto_model->ejecutar($vent);

        $sql = "UPDATE cambio_producto
                    SET
                
                cambio_egreso = 0,
                cambio_ingreso = 0
                
                WHERE cambio_producto_id = ".$cambio_producto_id."
                    ";
                    $this->Cambio_producto_model->ejecutar($sql);

         redirect('cambio_producto/index');
            }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }
    function entregarproducto()
    {   
       
        
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
                $usuario_id = $session_data['usuario_id'];
        $cambio_producto_id = $this->input->post('cambio_producto_id');
        $producto_id = $this->input->post('producto_id');
        $cantidad = $this->input->post('cantidad'); 
        $descuento = $this->input->post('descuento'); 
        $producto_costo = $this->input->post('producto_costo');
        $producto_precio = $this->input->post('producto_precio');
        
        
       $sql = "INSERT into detalle_venta(
                
                producto_id,
                detalleven_codigo,
                detalleven_unidad,
                detalleven_costo,
                detalleven_cantidad,
                detalleven_precio,
                detalleven_descuento,
                detalleven_subtotal,
                detalleven_total,
                cambio_id              
                )
                (
                SELECT
                
                producto_id,
                producto_codigo,
                producto_unidad,
                ".$producto_costo.",
                ".$cantidad.",
                ".$producto_precio.",
                ".$descuento.",
                ".$cantidad." * ".$producto_precio.",
                (".$cantidad." * ".$producto_precio.") - ".$descuento.",
                ".$cambio_producto_id."
                
                from producto where producto_id = ".$producto_id."
                )";

                $pro = "UPDATE producto
                SET
                      
                producto_costo = ".$producto_costo.",
                producto_precio = ".$producto_precio."
                      
                WHERE producto_id = ".$producto_id."
                ";

        $this->Cambio_producto_model->ejecutar($pro);
        $this->Cambio_producto_model->ejecutar($sql);
         redirect('cambio_producto/add/'.$cambio_producto_id);
            }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }

    /*
     * Editing a cambio_producto
     */
    function edit($cambio_producto_id)
    {   
        // check if the cambio_producto exists before trying to edit it
        $data['cambio_producto'] = $this->Cambio_producto_model->get_cambio_producto($cambio_producto_id);
        
        if(isset($data['cambio_producto']['cambio_producto_id']))
        {
            if(isset($_POST) && count($_POST) > 0)     
            {   
                $params = array(
					'producto_id' => $this->input->post('producto_id'),
					'detallecomp_id' => $this->input->post('detallecomp_id'),
					'detalleven_id' => $this->input->post('detalleven_id'),
                );

                $this->Cambio_producto_model->update_cambio_producto($cambio_producto_id,$params);            
                redirect('cambio_producto/index');
            }
            else
            {
                $data['_view'] = 'cambio_producto/edit';
                $this->load->view('layouts/main',$data);
            }
        }
        else
            show_error('The cambio_producto you are trying to edit does not exist.');
    } 

    function fincambio($cambio_producto_id)
{
    
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']==1) {
                $usuario_id = $session_data['usuario_id'];
    $cambio_producto = $this->Cambio_producto_model->get_cambio_producto($cambio_producto_id);
     $params = array(
                'cambio_producto_fecha' => date('Y-m-d   H:i:s'),
                'cambio_egreso' => $this->input->post('cambio_egreso'),
                'cambio_ingreso' => $this->input->post('cambio_ingreso'),
                'usuario_id' => $usuario_id,
                );

                $this->Cambio_producto_model->update_cambio_producto($cambio_producto_id,$params);            
                 redirect('cambio_producto/index');
 }
            else{
                redirect('alerta');
            }
        } else {
            redirect('', 'refresh');
        }
    }
    /*
     * Deleting cambio_producto
     */
    function remove($cambio_producto_id)
    {
        $cambio_producto = $this->Cambio_producto_model->get_cambio_producto($cambio_producto_id);

        // check if the cambio_producto exists before trying to delete it
        if(isset($cambio_producto['cambio_producto_id']))
        {
            $this->Cambio_producto_model->delete_cambio_producto($cambio_producto_id);
            redirect('cambio_producto/index');
        }
        else
            show_error('The cambio_producto you are trying to delete does not exist.');
    }
    
}
