<?php
/* 
 * Generated by CRUDigniter v3.2 
 * www.crudigniter.com
 */
 
class Modelo_contrato extends CI_Controller{
    
    private $sistema;
    function __construct()
    {
        parent::__construct();
        $this->load->model('Modelo_contrato_model');
        $this->load->model('Empresa_model');
        $this->load->model('Detalle_venta_model');
        $this->load->model('Estado_model');
        $this->load->model('Parametro_model');
        if ($this->session->userdata('logged_in')) {
            $this->session_data = $this->session->userdata('logged_in');
        }else {
            redirect('', 'refresh');
        }
        $this->load->model('Sistema_model');
        $this->sistema = $this->Sistema_model->get_sistema();
    }
    private function acceso($id_rol){
        
        $data['sistema'] = $this->sistema;
        $rolusuario = $this->session_data['rol'];
        if($rolusuario[$id_rol-1]['rolusuario_asignado'] == 1){
            return true;
        }else{
            $data['_view'] = 'login/mensajeacceso';
            $this->load->view('layouts/main',$data);
        }
    }

    /*
     * Listing of modelo_contrato
     */
    function index()
    {
        $data['sistema'] = $this->sistema;
        if($this->acceso(11)) {
            $data['modelo_contrato'] = $this->Modelo_contrato_model->get_all_modelo_contrato();

            $data['_view'] = 'modelo_contrato/index';
            $this->load->view('layouts/main',$data);
        }
    }

    /*
     * Adding a new modelo_contrato
     */
    function add()
    {
        $data['sistema'] = $this->sistema;
        if($this->acceso(12)) {
            $data['_view'] = 'modelo_contrato/add';
            $this->load->view('layouts/main',$data);
        }
    }  

    /*
     * Editing a modelo_contrato
     */
    function edit($modeloc_id)
    {
        $data['sistema'] = $this->sistema;
        if($this->acceso(13)) {
            // check if the modelo_contrato exists before trying to edit it
            $data['modelo_contrato'] = $this->Modelo_contrato_model->get_modelo_contrato($modeloc_id);
            $data['all_estado'] = $this->Estado_model->get_tipo_estado(1);
            if(isset($data['modelo_contrato']['modcontrato_id'])){
                $data['_view'] = 'modelo_contrato/edit';
                $this->load->view('layouts/main',$data);
            }
            else
                show_error('The modelo_contrato you are trying to edit does not exist.');
        }
    }
    /* registrar nuevo modelo de contrato */
    function registrar_modelocontrato(){
        
        $data['sistema'] = $this->sistema;
        if($this->input->is_ajax_request()){
            $empresa = $this->Empresa_model->get_this_empresa(1);
            $empresa_id = $empresa['empresa_id'];
            $estado_id = 1;
            $fecha = date('Y-m-d');
            $params = array(
                'empresa_id' => $empresa_id ,
                'estado_id' => $estado_id,
                'modcontrato_nombre' => $this->input->post('nombre_contrato'),
                'modcontrato_contrato' => $this->input->post('modeloc_parte1'),
                'modcontrato_fecha' => $fecha,
            );
            $modeloc_id = $this->Modelo_contrato_model->add_modelo_contrato($params);
            echo json_encode("ok");
        }else{
            show_404();
        }
    }   
    /* modificar modelo de contrato */
    function modificar_modelocontrato(){
        
        $data['sistema'] = $this->sistema;
        if($this->input->is_ajax_request()){
            $modeloc_id = $this->input->post('modcontrato_id');
            $params = array(
                'estado_id' => $this->input->post('estado_id'),
                'modcontrato_nombre' => $this->input->post('modcontrato_nombre'),
                'modcontrato_contrato' => $this->input->post('modcontrato_contrato'),
            );
            $this->Modelo_contrato_model->update_modelo_contrato($modeloc_id,$params);
            echo json_encode("ok");
        }else{                 
            show_404();
            }
    }
    /**
     * Generá el contrato con los datos del primer contrato registrado en el sistema
     */
    function generar_contrato($venta_id, $modcontrato_id = 1, $cambiar_contrato = 0){
        
        $data['sistema'] = $this->sistema;
        if($this->acceso(21)){
            $data['modelo_contratos'] = $this->Modelo_contrato_model->get_all_modelo_contrato();
            // $usuario_id = $this->session_data['usuario_id'];
            $data['tipousuario_id'] = $this->session_data['tipousuario_id'];
            $venta = $this->Detalle_venta_model->get_venta($venta_id);
            $data['detalle_venta'] = $this->Detalle_venta_model->get_detalle_venta($venta_id);        
            $data['empresa'] = $this->Empresa_model->get_empresa(1);        
            $data['venta'] = $venta;
            $data['page_title'] = "Contrato";
            $data['parametro'] = $this->Parametro_model->get_parametros();
            $contrato = $this->Modelo_contrato_model->get_modelo_contrato($modcontrato_id);
            $comandos = array(
                "#cliente_nombre#",
                "#cliente_ci#",
                "#zona_lote#",
                "#manzano_lote#",
                "#numero_lote#",
                "#superficie_lote#",
                "#precio_total#",
                "#cuota_inicial#",
                "#cuota_saldo#",
                "#numero_cuotas#",
                "#cuota_mes#",
                "#fecha_venta#",
                "#cuota_dia#",
                "#nombre_usuario#",
                "#carnet_usuario#"
            );
            $datos = $this->Modelo_contrato_model->get_datosContrato($venta_id);
            $this->load->helper('numeros_helper'); // Helper para convertir numeros a letras
            setlocale(LC_TIME, 'es_ES', 'Spanish_Spain', 'Spanish');
            // $fecha = date('F j, Y', $venta[0]['venta_fecha']);
            $fecha = $venta[0]['venta_fecha'];
            $semana = ['Lunes','Martes','Miércoles','Jueves','Viernes','Sábado','Domingo'];
            $dia_semana = (strftime('%u',strtotime($fecha)))-1;
            $fecha = strftime('%d %B %Y',strtotime($fecha));
            $fecha = "{$semana[$dia_semana]} $fecha";
            $d = array(
                $datos['cliente_nombre'],
                $datos['cliente_ci'],
                $datos['categoria_nombre'],
                $datos['subcategoria_nombre'],
                $datos['producto_nombre'],
                $datos['producto_caracteristicas'],
                // $datos['producto_colnorte'],   // "*colindancia_norte*",
                // $datos['producto_colsur'],   // "*colindancia_sur*",
                // $datos['producto_coleste'],   // "*colindancia_este*",
                // $datos['producto_coloeste'],   // "*colindancia_oeste*",
                "{$datos['venta_total']} ".num_to_letras($datos['venta_total'],' Dolares'),
                "{$datos['credito_cuotainicial']} ".num_to_letras($datos['credito_cuotainicial'],' Dolares'),
                "{$datos['credito_monto']} ".num_to_letras($datos['credito_monto'],' Dolares'),
                $datos['credito_numpagos'],
                "{$datos['cuota_total']} ".num_to_letras($datos['cuota_total'],' Dolares'),
                $fecha,
                date("d"),
                $datos['usuario_nombre'],
                $datos['usuario_ci']
            );
            $data['contrato'] = $this->reemplazar_contrato($contrato,$comandos,$d);
            // var_dump($data['contrato']);
            if($cambiar_contrato == 0){
                $data['_view'] = 'modelo_contrato/contrato';
                $this->load->view('layouts/main',$data);
            }else{
                return $data['contrato'];
            }
        }
    }

    function reemplazar_contrato($contrato, $comandos,$datos){
        
        $data['sistema'] = $this->sistema;
        for ($i=0; $i < sizeof($comandos); $i++) {
            $contrato = str_replace("{$comandos[$i]}", "{$datos[$i]}",$contrato);
        }
        return $contrato;
    }

    function cambiar_contrato(){
        
        $data['sistema'] = $this->sistema;
        if($this->input->is_ajax_request()){
            $contrato_id = $this->input->post('contrato');
            $venta_id = $this->input->post('venta_id');
            $cambiar_contrato = 1;
            $datos = $this->generar_contrato($venta_id, $contrato_id, $cambiar_contrato);
            echo json_encode($datos);
        }else{
            show_404();
        }
    }
}
