<?php
/* 
 * Generated by CRUDigniter v3.2 
 * www.crudigniter.com
 */
 
class Website extends CI_Controller{
    function __construct()
    {
        parent::__construct();
        $this->load->model('Pagina_web_model');
        $this->load->model('Producto_model');
        $this->load->model('Parametro_model');
        $this->load->model('Inventario_model');
        $this->load->model('Categoria_producto_model');
        $this->load->helper('cookie');
    }            

    function index($idioma_id)
    {
        
        //$idioma_id = 1; //1 - español
        $data['idioma_id'] = $idioma_id;
        $data['pagina_web'] = $this->Pagina_web_model->get_pagina($idioma_id);
        $data['menu_cabecera'] = $this->Pagina_web_model->get_menu_cabecera($idioma_id);
        $data['menu_principal'] = $this->Pagina_web_model->get_menu_principal($idioma_id);
        $data['menu_item'] = $this->Pagina_web_model->get_menu_item($idioma_id);
        $data['slider'] = $this->Pagina_web_model->get_slider(1,$idioma_id); //tipo 1
        $data['seccion1'] = $this->Pagina_web_model->get_seccion(1,$idioma_id); //seccion 1
        $data['seccion2'] = $this->Pagina_web_model->get_seccion(2,$idioma_id); //seccion 2
        $data['seccion3'] = $this->Pagina_web_model->get_seccion(3,$idioma_id); //seccion 3        
        $data['ofertasemanal'] = $this->Pagina_web_model->get_oferta_semanal(); //seccion 3
        $data['ofertasdia'] = $this->Pagina_web_model->get_oferta_dia(); //seccion 3
        $data['slider2'] = $this->Pagina_web_model->get_slider(2,$idioma_id); //tipo 2
        $data['categorias'] = $this->Categoria_producto_model->get_all_categoria_producto(); //tipo 2
        $data['parametro'] = $this->Parametro_model->get_parametros();
        //$data['mapa'] = $this->Mapa_model->get_mapa(1); //mapa
        
//        $data['_view'] = 'pagina_web/index';
//        $this->load->view('layouts/main',$data);        
        
        $data['_view'] = 'website';
//        $this->load->view('layouts/login',$data);
        $this->load->view('web/index',$data);
    }

    function email(){

            $to = $this->input->post('empresa_email');
            $from = $this->input->post('froemail');
            $subject = $this->input->post('nomemail');
            $message = $this->input->post('mensaje12');
            $headers = "From: ".$from."";
             
            mail($to, $subject, $message, $headers);
                
            redirect('website/index/1');
    }

    function esp()
    {                
        $this->index(1);
    }
    function eng()
    {                
        $this->index(2);
        //site_url('website/index/2');
    }
    /* * buscar productos en web SIN ACCESO!! */
    function webbuscar_productos()
    {
        if($this->input->is_ajax_request()){
            $parametro = $this->input->post('parametro');
            $datos = $this->Producto_model->get_busqueda_productos($parametro);
            echo json_encode($datos);
        }
        else
        {                 
            show_404();
        }
    }

    function webbuscar_categoria($categoria_id)
    {
        if($this->input->is_ajax_request()){
                        
            $datos = $this->Producto_model->get_busqueda_categoria($categoria_id);
            echo json_encode($datos);
        }
        else
        {                 
            show_404();
        }
    }
    
    function webbuscar_categoria_bloque($categoria_id)
    {
        if($this->input->is_ajax_request()){
                        
            $pagina = $this->input->post('pagina');
            $bloque = $this->input->post('bloque');
            
            $desde = ($pagina * $bloque) - ($bloque-1);
            $hasta = ($pagina * $bloque);
            
            $sql = "select * from inventario "
                    . " where categoria_id = ".$categoria_id
                    . " order by producto_nombre limit ".$desde.",".$hasta;
            
            $datos = $this->Inventario_model->consultar();
            echo json_encode($datos);
        }
        else
        {                 
            show_404();
        }
    }
    
    function single($idioma_id,$producto_id)
    {
        
        //$idioma_id = 1; //1 - español
        $data['pagina_web'] = $this->Pagina_web_model->get_pagina($idioma_id);
        $data['menu_cabecera'] = $this->Pagina_web_model->get_menu_cabecera($idioma_id);
        $data['menu_principal'] = $this->Pagina_web_model->get_menu_principal($idioma_id);
        $data['menu_item'] = $this->Pagina_web_model->get_menu_item($idioma_id);
        $data['slider'] = $this->Pagina_web_model->get_slider(1,$idioma_id); //tipo 1
        $data['seccion1'] = $this->Pagina_web_model->get_seccion(1,$idioma_id); //seccion 1
        $data['seccion2'] = $this->Pagina_web_model->get_seccion(2,$idioma_id); //seccion 2
        $data['seccion3'] = $this->Pagina_web_model->get_seccion(3,$idioma_id); //seccion 3        
        $data['ofertasemanal'] = $this->Pagina_web_model->get_oferta_semanal(); //seccion 3
        $data['ofertasdia'] = $this->Pagina_web_model->get_oferta_dia(); //seccion 3
        $data['slider2'] = $this->Pagina_web_model->get_slider(2,$idioma_id); //tipo 2

        $data['producto'] = $this->Pagina_web_model->get_producto($producto_id);
        
//        $data['_view'] = 'pagina_web/index';
//        $this->load->view('layouts/main',$data);        
        
        $data['_view'] = 'website';
//        $this->load->view('layouts/login',$data);
        $this->load->view('web/single',$data);
    }


    function insertarproducto()
    {

        if ($this->input->is_ajax_request()) {
        $producto_id = $this->input->post('producto_id');
        $cantidad = $this->input->post('cantidad'); 
        $descuento = $this->input->post('descuento'); 
        $producto_precio = $this->input->post('producto_precio');
        $cliente = $this->input->post('cliente');

       $existe = "SELECT producto_id from carrito WHERE producto_id=". $producto_id." and cliente_id='".$cliente."' ";
        $exis=$this->db->query($existe)->row_array();
        if ($exis['producto_id'] > 0) {
         $sumar="UPDATE carrito
          SET carrito_cantidad=carrito_cantidad+".$cantidad.",
              carrito_subtotal = carrito_subtotal+(".$cantidad." * carrito_precio),
              carrito_total = carrito_total+(".$cantidad." * carrito_precio) - ".$descuento*$cantidad."  
              WHERE producto_id = ".$producto_id." ";
         $this->db->query($sumar);
       }else{

        $sql = "INSERT into carrito(
                
                producto_id,
                cliente_id,
                carrito_precio,
                carrito_costo,
                carrito_cantidad,
                carrito_descuento,
                carrito_subtotal,
                carrito_total
                            
                )
                (
                SELECT
                
                producto_id,
                '".$cliente."',
                ".$producto_precio.",
                producto_costo,
                ".$cantidad.",
                ".$descuento.",
                ".$cantidad." * ".$producto_precio.",
                (".$cantidad." * ".$producto_precio.") - ".$descuento."

                from producto where producto_id = ".$producto_id."
                )";
              
        $this->db->query($sql);

       }

    }          
    }

    function cantidad()
    {

        if ($this->input->is_ajax_request()) {
        $producto_id = $this->input->post('producto_id');
        $cantidad = $this->input->post('cantidad'); 
        $descuento = $this->input->post('descuento'); 
        $producto_precio = $this->input->post('producto_precio');

         $sumar="UPDATE carrito
          SET carrito_cantidad = ".$cantidad.",
              carrito_subtotal = (".$cantidad." * carrito_precio),
              carrito_total = (".$cantidad." * carrito_precio) - ".$descuento*$cantidad."  
              WHERE producto_id = ".$producto_id." ";
         $this->db->query($sumar);
       }
   }

function carrito(){
    $cliente = $this->input->post('cliente');
    $datos = $this->Pagina_web_model->get_carrito($cliente);
     if(isset($datos)){
                        echo json_encode($datos);
                    }else { echo json_encode(null); } 
    }


function sesioncliente(){
    $login = $this->input->post('login');
    $clave = $this->input->post('clave');
    $ipe = $this->input->post('ipe');

    $resultado = "SELECT * from cliente WHERE cliente_codigo='".$login."' AND cliente_codigo = '".$clave."' ";
    $result=$this->db->query($resultado)->row_array();
    if ($result){
    $clienteid=$result['cliente_id'];
    $update="UPDATE carrito
              SET cliente_id = '".$clienteid."' 
              WHERE cliente_id = '".$ipe."' ";
    $this->db->query($update);

    setcookie("cliente_id", $clienteid, time() + (3600 * 24), "/");
    return true;
}else{
    show_404();
}
}

function getcliente(){
        $cliente = $this->input->post('cliente');
    $datos = $this->Pagina_web_model->get_cliente($cliente);
     if(isset($datos)){
                        echo json_encode($datos);
                    }else { echo json_encode(null); } 
    }

    function quitar(){
        $producto_id = $this->input->post('producto_id');
    $sql = "DELETE FROM carrito
            WHERE producto_id=".$producto_id." ";
    $this->db->query($sql);
    return true;
    }


function venta_online(){
    //renovar datos de cliente
    $nit = $this->input->post('nit');
    $razon = $this->input->post('razon');
    $telefono = $this->input->post('telefono');
    $direccion = $this->input->post('direccion');
    //datos para venta online
    $forma = $this->input->post('forma');
    $cliente = $this->input->post('cliente');
    $subtotal = $this->input->post('subtotal');
    $descuento = $this->input->post('descuento');
    $total = $this->input->post('total');
    $tipo_servicio = $this->input->post('tipo_servicio');

    $fecha = "now()";
    $hora = "'".date('H:i:s')."'";

    $updatecli = "UPDATE cliente SET cliente_nit='".$nit."', cliente_razon='".$razon."', cliente_telefono='".$telefono."',cliente_direccion='".$direccion."' WHERE cliente_id=".$cliente." ";
    $this->db->query($updatecli);
    $venta = "INSERT INTO venta_online
        (forma_id,
          tipotrans_id,
          cliente_id,
          moneda_id,
          estado_id,
          venta_fecha,
          venta_hora,
          venta_subtotal,
          venta_descuento,
          venta_total,
          venta_tipodoc,
          tiposerv_id,
          entrega_id
        )
        VALUES
        (".$forma.",          
          1,
          ".$cliente.",
          1,
          1,
          ".$fecha.",
          ".$hora.",
          ".$subtotal.",
          ".$descuento.",
          ".$total.",
          1,
          ".$tipo_servicio.",
          1          
          )"
        ;
        
        $this->db->query($venta);
        $venta_id = $this->db->insert_id();

    $detalle =  "INSERT INTO detalle_ventaonline
        (producto_id,
          venta_id,
          moneda_id,
          detalleven_codigo,
          detalleven_cantidad,
          detalleven_unidad,
          detalleven_costo,
          detalleven_precio,
          detalleven_subtotal,
          detalleven_descuento,
          detalleven_total,
          detalleven_caracteristicas,
          detalleven_comision,
          detalleven_tipocambio,
            detalleven_envase,
            detalleven_nombreenvase,
            detalleven_costoenvase,
            detalleven_precioenvase
        )


        (SELECT 
          c.producto_id,
          ".$venta_id.",
          1,
          producto_codigo,
          carrito_cantidad,
          producto_unidad,
          carrito_costo,
          carrito_precio,
          carrito_subtotal,
          carrito_descuento,
          carrito_total,
          producto_caracteristicas,
          producto_comision,
          producto_tipocambio,
            producto_envase,
            producto_nombreenvase,
            producto_costoenvase,
            producto_precioenvase
        FROM
          carrito c,producto p
          WHERE c.cliente_id=".$cliente." and c.producto_id=p.producto_id)"
        ;
        $this->db->query($detalle); 

        $borrar_carrito = "DELETE FROM carrito WHERE cliente_id='".$cliente."' ";
        $this->db->query($borrar_carrito);
        
}

}
