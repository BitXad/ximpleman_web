<?php
/* 
 * Generated by CRUDigniter v3.2 
 * www.crudigniter.com
 */
 
class Website extends CI_Controller{
    function __construct()
    {
        parent::__construct();
        $this->load->model('Pagina_web_model');
        $this->load->model('Producto_model');
        $this->load->model('Categoria_producto_model');
    }            

    function index($idioma_id)
    {
        
        //$idioma_id = 1; //1 - español
        $data['idioma_id'] = $idioma_id;
        $data['pagina_web'] = $this->Pagina_web_model->get_pagina($idioma_id);
        $data['menu_cabecera'] = $this->Pagina_web_model->get_menu_cabecera($idioma_id);
        $data['menu_principal'] = $this->Pagina_web_model->get_menu_principal($idioma_id);
        $data['menu_item'] = $this->Pagina_web_model->get_menu_item($idioma_id);
        $data['slider'] = $this->Pagina_web_model->get_slider(1,$idioma_id); //tipo 1
        $data['seccion1'] = $this->Pagina_web_model->get_seccion(1,$idioma_id); //seccion 1
        $data['seccion2'] = $this->Pagina_web_model->get_seccion(2,$idioma_id); //seccion 2
        $data['seccion3'] = $this->Pagina_web_model->get_seccion(3,$idioma_id); //seccion 3        
        $data['ofertasemanal'] = $this->Pagina_web_model->get_oferta_semanal(); //seccion 3
        $data['ofertasdia'] = $this->Pagina_web_model->get_oferta_dia(); //seccion 3
        $data['slider2'] = $this->Pagina_web_model->get_slider(2,$idioma_id); //tipo 2
        $data['categorias'] = $this->Categoria_producto_model->get_all_categoria_producto(); //tipo 2
        //$data['mapa'] = $this->Mapa_model->get_mapa(1); //mapa
        
//        $data['_view'] = 'pagina_web/index';
//        $this->load->view('layouts/main',$data);        
        
        $data['_view'] = 'website';
//        $this->load->view('layouts/login',$data);
        $this->load->view('web/index',$data);
    }

    function email(){

            $to = $this->input->post('empresa_email');
            $from = $this->input->post('froemail');
            $subject = $this->input->post('nomemail');
            $message = $this->input->post('mensaje12');
            $headers = "From: ".$from."";
             
            mail($to, $subject, $message, $headers);
                
            redirect('website/index/1');
    }

    function esp()
    {                
        $this->index(1);
    }
    function eng()
    {                
        $this->index(2);
        //site_url('website/index/2');
    }
    /* * buscar productos en web SIN ACCESO!! */
    function webbuscar_productos()
    {
        if($this->input->is_ajax_request()){
            $parametro = $this->input->post('parametro');
            $datos = $this->Producto_model->get_busqueda_productos($parametro);
            echo json_encode($datos);
        }
        else
        {                 
            show_404();
        }
    }

    function webbuscar_categoria($categoria_id)
    {
        if($this->input->is_ajax_request()){
            
            $datos = $this->Producto_model->get_busqueda_categoria($categoria_id);
            echo json_encode($datos);
        }
        else
        {                 
            show_404();
        }
    }
    function single($idioma_id,$producto_id)
    {
        
        //$idioma_id = 1; //1 - español
        $data['pagina_web'] = $this->Pagina_web_model->get_pagina($idioma_id);
        $data['menu_cabecera'] = $this->Pagina_web_model->get_menu_cabecera($idioma_id);
        $data['menu_principal'] = $this->Pagina_web_model->get_menu_principal($idioma_id);
        $data['menu_item'] = $this->Pagina_web_model->get_menu_item($idioma_id);
        $data['slider'] = $this->Pagina_web_model->get_slider(1,$idioma_id); //tipo 1
        $data['seccion1'] = $this->Pagina_web_model->get_seccion(1,$idioma_id); //seccion 1
        $data['seccion2'] = $this->Pagina_web_model->get_seccion(2,$idioma_id); //seccion 2
        $data['seccion3'] = $this->Pagina_web_model->get_seccion(3,$idioma_id); //seccion 3        
        $data['ofertasemanal'] = $this->Pagina_web_model->get_oferta_semanal(); //seccion 3
        $data['ofertasdia'] = $this->Pagina_web_model->get_oferta_dia(); //seccion 3
        $data['slider2'] = $this->Pagina_web_model->get_slider(2,$idioma_id); //tipo 2

        $data['producto'] = $this->Pagina_web_model->get_producto($producto_id);
        
//        $data['_view'] = 'pagina_web/index';
//        $this->load->view('layouts/main',$data);        
        
        $data['_view'] = 'website';
//        $this->load->view('layouts/login',$data);
        $this->load->view('web/single',$data);
    }


    function insertarproducto()
    {

        if ($this->input->is_ajax_request()) {
        $producto_id = $this->input->post('producto_id');
        $cantidad = $this->input->post('cantidad'); 
        $descuento = $this->input->post('descuento'); 
        $producto_precio = $this->input->post('producto_precio');
        $findip = $this->input->post('myip');

       $existe = "SELECT producto_id from carrito WHERE producto_id=". $producto_id." ";
        $exis=$this->db->query($existe)->row_array();
        if ($exis['producto_id'] > 0) {
         $sumar="UPDATE carrito
          SET carrito_cantidad=carrito_cantidad+".$cantidad.",
              carrito_subtotal = carrito_subtotal+(".$cantidad." * carrito_precio),
              carrito_total = carrito_total+(".$cantidad." * carrito_precio) - ".$descuento*$cantidad."  
              WHERE producto_id = ".$producto_id." ";
         $this->db->query($sumar);
       }else{

        $sql = "INSERT into carrito(
                
                producto_id,
                cliente_id,
                carrito_precio,
                carrito_costo,
                carrito_cantidad,
                carrito_descuento,
                carrito_subtotal,
                carrito_total
                            
                )
                (
                SELECT
                
                producto_id,
                '".$findip."',
                ".$producto_precio.",
                producto_costo,
                ".$cantidad.",
                ".$descuento.",
                ".$cantidad." * ".$producto_precio.",
                (".$cantidad." * ".$producto_precio.") - ".$descuento."

                from producto where producto_id = ".$producto_id."
                )";
              
        $this->db->query($sql);

       }

    }          
    }

    function cantidad()
    {

        if ($this->input->is_ajax_request()) {
        $producto_id = $this->input->post('producto_id');
        $cantidad = $this->input->post('cantidad'); 
        $descuento = $this->input->post('descuento'); 
        $producto_precio = $this->input->post('producto_precio');

         $sumar="UPDATE carrito
          SET carrito_cantidad = ".$cantidad.",
              carrito_subtotal = (".$cantidad." * carrito_precio),
              carrito_total = (".$cantidad." * carrito_precio) - ".$descuento*$cantidad."  
              WHERE producto_id = ".$producto_id." ";
         $this->db->query($sumar);
       }
   }

function carrito(){
    $cliente = $this->input->post('cliente');
    $datos = $this->Pagina_web_model->get_carrito($cliente);
     if(isset($datos)){
                        echo json_encode($datos);
                    }else { echo json_encode(null); } 
    }

}
