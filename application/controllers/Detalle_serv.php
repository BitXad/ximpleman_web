<?php
/* 
 * Generated by CRUDigniter v3.2 
 * www.crudigniter.com
 */
 
class Detalle_serv extends CI_Controller{
    
    private $session_data = "";
    private $sistema;
    function __construct()
    {
        parent::__construct();
        $this->load->library('ControlCode'); // para generar codigo
        $this->load->model('Detalle_serv_model');
        if ($this->session->userdata('logged_in')) {
            $this->session_data = $this->session->userdata('logged_in');
        }else {
            redirect('', 'refresh');
        }
        $this->load->model('Sistema_model');
        $this->sistema = $this->Sistema_model->get_sistema();
    }
    /* *****Funcion que verifica el acceso al sistema**** */
    private function acceso($id_rol){
        
        $data['sistema'] = $this->sistema;
        $rolusuario = $this->session_data['rol'];
        if($rolusuario[$id_rol-1]['rolusuario_asignado'] == 1){
            return true;
        }else{
            $data['_view'] = 'login/mensajeacceso';
            $this->load->view('layouts/main',$data);
        }
    }

    /*
     * Deleting detalle_serv AL CREAR(REGISTRAR un servicio)
     */
    function remove($servicio_id, $detalleserv_id)
    {
        $data['sistema'] = $this->sistema;
        if($this->acceso(83)){
            $detalle_serv = $this->Detalle_serv_model->get_detalle_serv($detalleserv_id);

            // check if the detalle_serv exists before trying to delete it
            if(isset($detalle_serv['detalleserv_id']))
            {
                $this->load->model('Detalle_venta_model');
                $detalle_venta = $this->Detalle_venta_model->get_all_detalle_ventas_servicio($detalleserv_id);
              /*  if(isset($detalle_venta['detalleven_id']))
                {*/
                    $this->load->model('Inventario_model');
                    foreach ($detalle_venta as $detalle) {
                        $this->Inventario_model->incrementar_inventario($detalle['detalleven_cantidad'], $detalle['producto_id']);
                        $this->Detalle_venta_model->delete_detalle_venta($detalle['detalleven_id']);
                    }

               // }
                $this->Detalle_serv_model->delete_detalle_serv($detalleserv_id);
                echo json_encode("ok");
            }
            else
                show_error('El detalle_serv que intentas borrar no existe.');
        }
    }
    /*
     * elimina un detalle y lo manda de nuevo a ver detalle serv.
     */
    function removedet($servicio_id, $detalleserv_id)
    {
        $data['sistema'] = $this->sistema;
        if($this->acceso(83)){
            $detalle_serv = $this->Detalle_serv_model->get_detalle_serv($detalleserv_id);

            // check if the detalle_serv exists before trying to delete it
            if(isset($detalle_serv['detalleserv_id']))
            {
                $this->load->model('Detalle_venta_model');
                $detalle_venta = $this->Detalle_venta_model->get_all_detalle_ventas_servicio($detalleserv_id);
              /*  if(isset($detalle_venta['detalleven_id']))
                {*/
                    $this->load->model('Inventario_model');
                    foreach ($detalle_venta as $detalle) {
                        $this->Inventario_model->incrementar_inventario($detalle['detalleven_cantidad'], $detalle['producto_id']);
                        $this->Detalle_venta_model->delete_detalle_venta($detalle['detalleven_id']);
                    }

               // }
                $this->Detalle_serv_model->delete_detalle_serv($detalleserv_id);
                echo json_encode("ok");
                //redirect('servicio/serview/'.$servicio_id);
            }
            else
                show_error('El detalle_serv que intentas borrar no existe.');
        }
    }
    
    function detalle_nuevo($servicio_id)
    {
        $data['sistema'] = $this->sistema;
        if($this->acceso(69)){
            $data['page_title'] = "Detalle de Servicio";
        $this->load->model('Servicio_model');
        $data['servicio'] = $this->Servicio_model->get_servicio($servicio_id);
        
        if(isset($data['servicio']['servicio_id']))
        {
            $this->load->library('form_validation');

	    $this->form_validation->set_rules('detalleserv_descripcion','Detalle Servicio Descripcion','required');
	    $this->form_validation->set_rules('detalleserv_codigo','Detalle Servicio Codigo','required');
	    $this->form_validation->set_rules('detalleserv_falla','Detalle Servicio Falla','required');
            
	    if($this->form_validation->run())     
            {
                
                $fecha_entrega = $this->Detalle_serv_model->normalize_date($this->input->post('detalleserv_fechaentrega'));
                $hora_entrega = date("H:i:s", strtotime($this->input->post('detalleserv_horaentrega')));
            
                $params = array(
                                    'estado_id' => $this->input->post('estado_id'),
                                    'responsable_id' => $this->input->post('responsable_id'),
                                    'usuario_id' => $this->input->post('usuario_id'),
                                    'catserv_id' => $this->input->post('catserv_id'),
                                    'servicio_id' => $servicio_id,
                                    'detalleserv_descripcion' => $this->input->post('detalleserv_descripcion'),
                                    'detalleserv_codigo' => $this->input->post('detalleserv_codigo'),
                                    'detalleserv_falla' => $this->input->post('detalleserv_falla'),
                                    'detalleserv_diagnostico' => $this->input->post('detalleserv_diagnostico'),
                                    'detalleserv_solucion' => $this->input->post('detalleserv_solucion'),
                                    'detalleserv_glosa' => $this->input->post('detalleserv_glosa'),
                                    'detalleserv_total' => $this->input->post('detalleserv_total'),
                                    'detalleserv_acuenta' => $this->input->post('detalleserv_acuenta'),
                                    'detalleserv_saldo' => $this->input->post('detalleserv_saldo'),
//                                    'detalleserv_fechaterminado' => $this->input->post('detalleserv_fechaterminado'),
//                                    'detalleserv_horaterminado' => $this->input->post('detalleserv_horaterminado'),
                                    'detalleserv_fechaentrega' => $fecha_entrega,
                                    'detalleserv_horaentrega' => $hora_entrega,
                                    'detalleserv_insumo' => $this->input->post('detalleserv_insumo'),
                );

                $detalle_serv_id = $this->Detalle_serv_model->add_detalle_serv($params);
                $mas_params = array('detalleserv_codigo' =>'SRV-'.$servicio_id.'-DSRV'.$detalle_serv_id);
                $this->Detalle_serv_model->update_detalle_serv($detalle_serv_id, $mas_params);
                redirect('detalle_serv/index');
            }
            else
            {
                $this->load->model('Cliente_model');
                $data['cliente'] = $this->Cliente_model->get_cliente($data['servicio']['cliente_id']);
                
                $this->load->model('Categoria_servicio_model');
		$data['all_categoria_servicio'] = $this->Categoria_servicio_model->get_all_categoria_servicio_id1();
                
                $this->load->model('Responsable_model');
		$data['all_responsable'] = $this->Responsable_model->get_all_responsable();
                
                $data['_view'] = 'detalle_serv/detalle_nuevo';
                $this->load->view('layouts/main',$data);
            }
        }
        else
            show_error('The detalle_serv you are trying to edit does not exist.');
        }
    }
    /*
     *  *********************Crea un nuevo detalle para un servicio*******************************
     */
    function nuevodetalle($servicio_id)
    {
        $data['sistema'] = $this->sistema;
        
        if($this->acceso(70)){
            
        $this->load->model('Servicio_model');
        $data['servicio'] = $this->Servicio_model->get_servicio($servicio_id);
        
        if(isset($data['servicio']['servicio_id']))
        {
            $this->load->library('form_validation');

	    //$this->form_validation->set_rules('detalleserv_descripcion','Detalle Servicio Descripcion','required');
	    //$this->form_validation->set_rules('detalleserv_codigo','Detalle Servicio Codigo','required');
	    $this->form_validation->set_rules('detalleserv_falla','Detalle Servicio Falla','required');
	    $this->form_validation->set_rules('responsable_id','Responsable del Detalle','required');
            
	    if($this->form_validation->run())     
            {
                //$fecha_entrega = $this->Detalle_serv_model->normalize_date($this->input->post('detalleserv_fechaentrega'));
                $hora_entrega = date("H:i:s", strtotime($this->input->post('detalleserv_horaentrega')));
            
                $usuario_id = $this->session_data['usuario_id'];
                //estado 5 por que es PENDIENTE para Servicios en la BD
                $estado_id = 5;
                $catserv_id = $this->input->post('catserv_id');
                $subcatserv_id = $this->input->post('subcatserv_id');
                
                $inputotal = $this->input->post('detalleserv_total'); 
                $inputacuenta = $this->input->post('detalleserv_acuenta');
                $inputsaldo = $this->input->post('detalleserv_saldo');
                $masdescripcion = $this->input->post('textcatproducto')." ".$this->input->post('textmarcadescripcion')." ".$this->input->post('detalleserv_descripcion');
                $facuenta = date('Y-m-d H:i:s');
                $esreclamo = $this->input->post('detalleserv_reclamo');
                if(isset($esreclamo)){
                    $esreclamo = "si";
                }else{
                    $esreclamo = "no";
                }
                $params = array(
                    'estado_id' => $estado_id,
                    'responsable_id' => $this->input->post('responsable_id'),
                    'usuario_id' => $usuario_id,
                    'servicio_id' => $servicio_id,
                    'catserv_id' => $catserv_id,
                    'subcatserv_id' => $subcatserv_id,
                    'cattrab_id' => $this->input->post('cattrab_id'),
                    'tiempouso_id' => $this->input->post('tiempouso_id'),
                    'procedencia_id' => $this->input->post('procedencia_id'),
                    'detalleserv_descripcion' => $masdescripcion,
                    'detalleserv_reclamo' => $esreclamo,
                    'detalleserv_falla' => $this->input->post('detalleserv_falla'),
                    'detalleserv_diagnostico' => $this->input->post('detalleserv_diagnostico'),
                    'detalleserv_solucion' => $this->input->post('detalleserv_solucion'),
                    'detalleserv_pesoentrada' => $this->input->post('detalleserv_pesoentrada'),
                    'detalleserv_glosa' => $this->input->post('detalleserv_glosa'),
                    'detalleserv_total' => $inputotal,
                    'detalleserv_acuenta' => $inputacuenta,
                    'detalleserv_saldo' => $inputsaldo,
//                                    'detalleserv_fechaterminado' => $this->input->post('detalleserv_fechaterminado'),
//                                    'detalleserv_horaterminado' => $this->input->post('detalleserv_horaterminado'),
                    'detalleserv_fpagoacuenta' => $facuenta,
                    'usuariopacuenta_id' => $usuario_id,
                    'detalleserv_fechaentrega' => $this->input->post('detalleserv_fechaentrega'),
                    'detalleserv_horaentrega' => $hora_entrega,
                    'detalleserv_insumo' => $this->input->post('detalleserv_insumo'),
                );
                $detalle_serv_id = $this->Detalle_serv_model->add_detalle_serv($params);

                /*$facuenta = date('Y-m-d H:i:s');
                if($inputacuenta >0)
                {
                    $detparam = array(
                                'detalleserv_fpagoacuenta' => $facuenta,
                                'usuariopacuenta_id' => $usuario_id,
                    );

                    $this->Detalle_serv_model->update_detalle_serv($detalle_serv_id, $detparam);
                
                }*/
                //$subcatserv_id = $this->input->post('subcatserv_id');
                $this->load->model('Categoria_servicio_model');
		$data['categoria_servicio'] = $this->Categoria_servicio_model->get_categoria_servicio($catserv_id);
                
                $this->load->model('Subcategoria_servicio_model');
		$subcatserv = $this->Subcategoria_servicio_model->get_subcategoria_servicio($subcatserv_id);
                $codigodet = "";
                //para generar el codigo de un detalle(producto) de servicio
                if($data['categoria_servicio']['catserv_id'] == 0){
                    $codigodet = $detalle_serv_id;
                }else{
                    $res = str_replace(' ', '', $data['categoria_servicio']['catserv_descripcion']);
                    //$res = strtok($data['categoria_servicio']['catserv_descripcion'], " ");
                    $codigodet = $codigodet.substr($res,0,2);
                    /*while($res !== false){
                        $codigodet = $codigodet.substr($res,0,1);
                        $res = strtok(" ");
                    }*/

                    $codigodet = $codigodet.$detalle_serv_id;
                    //$codigodet = $codigodet.$subcatserv['subcatserv_descripcion'].$detalle_serv_id;
                }
                $mas_params = array('detalleserv_codigo' =>$codigodet);
                $this->Detalle_serv_model->update_detalle_serv($detalle_serv_id, $mas_params);

                $data['resultado'] = $this->Detalle_serv_model->sumarmontos($servicio_id);
                $total = $data['resultado']['total'];
                $acuenta = $data['resultado']['acuenta'];
                $saldo = $data['resultado']['saldo'];
                $sumparams = array(
                                    'servicio_total' => $total,
                                    'servicio_acuenta' => $acuenta,
                                    'servicio_saldo' => $saldo,
                );

                $this->load->model('Servicio_model');
                $this->Servicio_model->update_servicio($servicio_id,$sumparams);            
                
                $data['servicio'] = $this->Servicio_model->get_servicio($servicio_id);
        
                echo json_encode("ok");
                //redirect('servicio/serviciocreado/'.$servicio_id);
            }
            else
            {
                echo json_encode("faltadatos");
                //redirect('servicio/serviciocreado/'.$servicio_id);
            }
        }
        else
            echo json_encode("noexiste");
        }
    }
    /*
     *  *********************Crea un nuevo detalle para un servicio SIN modificar su codigo*******************************
     */
    function nuevodetalle1($servicio_id)
    {
        $data['sistema'] = $this->sistema;
        
        if($this->acceso(69)){
            
        $this->load->model('Servicio_model');
        $data['servicio'] = $this->Servicio_model->get_servicio($servicio_id);
        
        if(isset($data['servicio']['servicio_id']))
        {
            $this->load->library('form_validation');

	    $this->form_validation->set_rules('detalleserv_descripcion','Detalle Servicio Descripcion','required');
	    //$this->form_validation->set_rules('detalleserv_codigo','Detalle Servicio Codigo','required');
	    $this->form_validation->set_rules('detalleserv_falla','Detalle Servicio Falla','required');
            
	    if($this->form_validation->run())     
            {
                //$fecha_entrega = $this->Detalle_serv_model->normalize_date($this->input->post('detalleserv_fechaentrega'));
                $fecha_entrega = $this->input->post('detalleserv_fechaentrega');
                $hora_entrega = date("H:i:s", strtotime($this->input->post('detalleserv_horaentrega')));
                //
                $estado_id = 5;
                $usuario_id = $this->session_data['usuario_id'];
                $catserv_id = $this->input->post('catserv_id');
                $subcatserv_id = $this->input->post('subcatserv_id');
                
                $inputotal = $this->input->post('detalleserv_total'); 
                $inputacuenta = $this->input->post('detalleserv_acuenta');
                $inputsaldo = $this->input->post('detalleserv_saldo');
                $esreclamo = $this->input->post('detalleserv_reclamo');
                if(isset($esreclamo)){
                    $esreclamo = "si";
                }else{
                    $esreclamo = "no";
                }
                $params = array(
                                    'estado_id' => $estado_id,
                                    'responsable_id' => $this->input->post('responsable_id'),
                                    'usuario_id' => $usuario_id,
                                    'servicio_id' => $servicio_id,
                                    'catserv_id' => $catserv_id,
                                    'subcatserv_id' => $subcatserv_id,
                                    'cattrab_id' => $this->input->post('cattrab_id'),
                                    'tiempouso_id' => $this->input->post('tiempouso_id'),
                                    'procedencia_id' => $this->input->post('procedencia_id'),
                                    'detalleserv_codigo' => $this->input->post('detalleserv_codigo'),
                                    'detalleserv_descripcion' => $this->input->post('detalleserv_descripcion'),
                                    'detalleserv_reclamo' => $esreclamo,
                                    'detalleserv_falla' => $this->input->post('detalleserv_falla'),
                                    'detalleserv_diagnostico' => $this->input->post('detalleserv_diagnostico'),
                                    'detalleserv_solucion' => $this->input->post('detalleserv_solucion'),
                                    'detalleserv_pesoentrada' => $this->input->post('detalleserv_pesoentrada'),
                                    'detalleserv_glosa' => $this->input->post('detalleserv_glosa'),
                                    'detalleserv_total' => $inputotal,
                                    'detalleserv_acuenta' => $inputacuenta,
                                    'detalleserv_saldo' => $inputsaldo,
//                                    'detalleserv_fechaterminado' => $this->input->post('detalleserv_fechaterminado'),
//                                    'detalleserv_horaterminado' => $this->input->post('detalleserv_horaterminado'),
                                    'detalleserv_fechaentrega' => $fecha_entrega,
                                    'detalleserv_horaentrega' => $hora_entrega,
                                    'detalleserv_insumo' => $this->input->post('detalleserv_insumo'),
                );
                $detalle_serv_id = $this->Detalle_serv_model->add_detalle_serv($params);

                $facuenta = date('Y-m-d H:i:s');
                if($inputacuenta >0)
                {
                    $detparam = array(
                                'detalleserv_fpagoacuenta' => $facuenta,
                                'usuariopacuenta_id' => $usuario_id,
                    );
                    $this->Detalle_serv_model->update_detalle_serv($detalle_serv_id, $detparam);
                }
                
                $data['resultado'] = $this->Detalle_serv_model->sumarmontos($servicio_id);
                $total = $data['resultado']['total'];
                $acuenta = $data['resultado']['acuenta'];
                $saldo = $data['resultado']['saldo'];
                $sumparams = array(
                                    'servicio_total' => $total,
                                    'servicio_acuenta' => $acuenta,
                                    'servicio_saldo' => $saldo,
                );

                $this->load->model('Servicio_model');
                $this->Servicio_model->update_servicio($servicio_id,$sumparams);            
                
                $data['servicio'] = $this->Servicio_model->get_servicio($servicio_id);
        
                redirect('servicio/serviciocreado/'.$servicio_id);
            }
            else
            {
                redirect('servicio/serviciocreado/'.$servicio_id);
            }
        }
        else
            show_error('El Servicio que al que intenta registrar un detalle no existe');
        }
    }
    /*
     * Funcion Que busca el detalle de un producto, atravez de su codigo
     */
    function buscardetalleserv($servicio_id)
    {
        $data['sistema'] = $this->sistema;
        if($this->acceso(69)){
            $data['page_title'] = "Detalle de Servicio";
        // check if the servicio exists before trying to edit it
        $this->load->model('Servicio_model');
        $data['servicio'] = $this->Servicio_model->get_servicio($servicio_id);
        
        if(isset($data['servicio']['servicio_id']))
        {
	    if(isset($_POST) && count($_POST) > 0)     
            {
                $codigo = $this->input->post('codigo');
                
                $res = $this->Detalle_serv_model->buscar_detalle_serv_codigo($codigo);
                if(isset($res) && !empty($res))
                {
//                    $data['_view'] = 'detalle_serv/kardex_detalle';
//                    $this->load->view('layouts/main',$data);
                    //$codcodigo = urlencode($codigo);
                    redirect('detalle_serv/kardex_detalle/'.$servicio_id.'/'.$codigo);
                }else{
                    redirect('servicio/serviciocreado/'.$servicio_id."/no");
                }
            }else{
                $data['_view'] = 'servicio/serviciocreado/'.$servicio_id;
                $this->load->view('layouts/main',$data);
            }
        }else{
            show_error('El servicio al cual desea añadir o ver un producto existente, no existe');
        }
        }
    }
    
    function kardex_detalle($servicio_id, $codigo)
    {
        $data['sistema'] = $this->sistema;
        
        if($this->acceso(74)){
            
            $data['page_title'] = "Kardex Detalle de Servicio";
            $data['codigo'] = $codigo;
            //$rescodigo = str_replace("%20", " ", $codigo);
            $data['detalle_serv'] = $this->Detalle_serv_model->buscar_detalle_serv_codigo($codigo);



            $this->load->model('Servicio_model');
            $data['servicio'] = $this->Servicio_model->get_servicio($servicio_id);

            $this->load->model('Categoria_servicio_model');
            $data['all_categoria_servicio'] = $this->Categoria_servicio_model->get_all_categoria_servicio_id1();
            if(isset($data['detalle_serv'][0]['catserv_id'])){
                $data['categoria_servicio'] = $this->Categoria_servicio_model->get_categoria_servicio($data['detalle_serv'][0]['catserv_id']);
            }

            $this->load->model('Subcategoria_servicio_model');
            $data['all_subcategoria_servicio'] = $this->Subcategoria_servicio_model->get_all_subcategoria_servicio_id1();

            $this->load->model('Usuario_model');
            $data['all_responsable'] = $this->Usuario_model->get_all_usuario_tecnicoresponsable_ok();

            $this->load->model('Categoria_trabajo_model');
            $data['all_categoria_trabajo'] = $this->Categoria_trabajo_model->get_all_categoria_trabajo_id1();

            $this->load->model('Tiempo_uso_model');
            $data['all_tiempo_uso'] = $this->Tiempo_uso_model->get_all_tiempo_uso_id1();

            $this->load->model('Procedencia_model');
            $data['all_procedencia'] = $this->Procedencia_model->get_all_procedencia_id1();

            $this->load->model('Parametro_model');
            $data['parametro'] = $this->Parametro_model->get_parametro_servicio();

            $data['_view'] = 'detalle_serv/kardex_detalle';
            $this->load->view('layouts/main',$data);
        }
    }
    
    /*
     * *************Deja en cero los montos de este detalle de servicio ($detalleserv_id)
     * *************y recalcula los valores del servicio **************
     */
    function anulardetalleserv($servicio_id, $detalleserv_id)
    {
        $data['sistema'] = $this->sistema;
        
        if($this->acceso(82)){
            
        $estado_id = 4; // este valor esta definido en la tabla Estado
        $usuario_id = $this->session_data['usuario_id'];
        
        $this->load->model('Categoria_insumo_model');
        $this->load->model('Detalle_venta_model');
        $insumos_usados = $this->Categoria_insumo_model->get_all_insumos_usados($detalleserv_id);
        foreach($insumos_usados as $insumo){
            $detalleventa = array(
                'detalleven_cantidad' => 0,
                'detalleven_unidad' => 0,
                'detalleven_costo' => 0,
                'detalleven_precio' => 0,
                'detalleven_descuento' => 0,
                'detalleven_total' => 0,
                'detalleven_preferencia' => "-",
                'detalleven_caracteristicas' => "",
                'detalleven_comision' => 0,
            );
            $this->Detalle_venta_model->update_detalle_venta($insumo['detalleven_id'], $detalleventa);
        }
        $detparams = array(
                        'detalleserv_total' => 0,
                        'detalleserv_acuenta' => 0,
                        'detalleserv_saldo' => 0,
                        'estado_id' => $estado_id,
                        'usuario_id' => $usuario_id,
        );
        $this->Detalle_serv_model->update_detalle_serv($detalleserv_id,$detparams);
        
        $res_ids = $this->Detalle_serv_model->get_ids_estado_detalle_serv($servicio_id);
        $this->load->model('Servicio_model');
        $cont = 0;
        foreach($res_ids as $ids)
        {
            if($ids['estado_id'] == $estado_id){
                $cont++;
            }
        }
        if($cont == count($res_ids)){
            $params = array(
                        'estado_id' => $estado_id,
            );

            $this->Servicio_model->update_servicio($servicio_id,$params);
        }
                        
        $resultado = $this->Detalle_serv_model->sumarmontos($servicio_id);
        $total = $resultado['total'];
        $acuenta = $resultado['acuenta'];
        $saldo = $resultado['saldo'];
        $sumparams = array(
                            'servicio_total' => $total,
                            'servicio_acuenta' => $acuenta,
                            'servicio_saldo' => $saldo,
        );


        $this->Servicio_model->update_servicio($servicio_id,$sumparams);            
                
        echo json_encode("ok");
        }
    }
    /*
     *  *********************Modifica el detalle cuando se esta añadiendo mas detalles, no modifica el codigo*******************************
     */
    function modificardetalle($servicio_id, $detalleserv_id)
    {
        $data['sistema'] = $this->sistema;
        
        if($this->acceso(86)){
            
            $data['page_title'] = "Detalle de Servicio";
        $this->load->model('Servicio_model');
        $data['servicio'] = $this->Servicio_model->get_servicio($servicio_id);
        
        if(isset($_POST) && count($_POST) > 0)     
        {
            $this->load->library('form_validation');

	    $this->form_validation->set_rules('detalleserv_descripcion','Detalle Servicio Descripcion','required');
	    //$this->form_validation->set_rules('detalleserv_codigo','Detalle Servicio Codigo','required');
	    $this->form_validation->set_rules('detalleserv_falla','Detalle Servicio Falla','required');
            
	    if($this->form_validation->run())     
            {
                $estado_id = $this->input->post('estado_id');
                //$fecha_entrega = $this->Detalle_serv_model->normalize_date($this->input->post('detalleserv_fechaentrega'));
                $hora_entrega = date("H:i:s", strtotime($this->input->post('detalleserv_horaentrega')));
            
                $usuario_id = $this->session_data['usuario_id'];
                $inputacuenta = $this->input->post('detalleserv_acuenta');
                $inputsaldo = $this->input->post('detalleserv_saldo');
                $catserv_id = $this->input->post('catserv_id');
                $subcatserv_id = $this->input->post('subcatserv_id');
                $esreclamo = $this->input->post('detalleserv_reclamo');
                if(isset($esreclamo)){
                    $esreclamo = "si";
                }else{
                    $esreclamo = "no";
                }
                $params = array(
                                    'estado_id' => $estado_id,
                                    'responsable_id' => $this->input->post('responsable_id'),
                                    'usuario_id' => $usuario_id,
                                    'servicio_id' => $servicio_id,
                                    'catserv_id' => $catserv_id,
                                    'subcatserv_id' => $subcatserv_id,
                                    'cattrab_id' => $this->input->post('cattrab_id'),
                                    'tiempouso_id' => $this->input->post('tiempouso_id'),
                                    'procedencia_id' => $this->input->post('procedencia_id'),
                                    //'detalleserv_codigo' => $this->input->post('detalleserv_codigo'),
                                    'detalleserv_descripcion' => $this->input->post('detalleserv_descripcion'),
                                    'detalleserv_reclamo' => $esreclamo,
                                    'detalleserv_falla' => $this->input->post('detalleserv_falla'),
                                    'detalleserv_diagnostico' => $this->input->post('detalleserv_diagnostico'),
                                    'detalleserv_solucion' => $this->input->post('detalleserv_solucion'),
                                    'detalleserv_pesoentrada' => $this->input->post('detalleserv_pesoentrada'),
                                    'detalleserv_glosa' => $this->input->post('detalleserv_glosa'),
                                    'detalleserv_total' => $this->input->post('detalleserv_total'),
                                    'detalleserv_acuenta' => $inputacuenta,
                                    'detalleserv_saldo' => $inputsaldo,
//                                    'detalleserv_fechaterminado' => $this->input->post('detalleserv_fechaterminado'),
//                                    'detalleserv_horaterminado' => $this->input->post('detalleserv_horaterminado'),
                                    'detalleserv_fechaentrega' => $this->input->post('detalleserv_fechaentrega'),
                                    'detalleserv_horaentrega' => $hora_entrega,
                                    'detalleserv_insumo' => $this->input->post('detalleserv_insumo'),
                );

                $this->Detalle_serv_model->update_detalle_serv($detalleserv_id,$params);
                
                $this->load->model('Servicio_model');
                
                $res_ids = $this->Detalle_serv_model->get_ids_estado_detalle_serv($servicio_id);
                // 4 es el estado de ANULADO
                if($estado_id == 4)
                {
                    $this->load->model('Categoria_insumo_model');
                    $this->load->model('Detalle_venta_model');
                    $insumos_usados = $this->Categoria_insumo_model->get_all_insumos_usados($detalleserv_id);
                    foreach($insumos_usados as $insumo){
                        $detalleventa = array(
                            'detalleven_cantidad' => 0,
                            'detalleven_unidad' => 0,
                            'detalleven_costo' => 0,
                            'detalleven_precio' => 0,
                            'detalleven_descuento' => 0,
                            'detalleven_total' => 0,
                            'detalleven_preferencia' => "-",
                            'detalleven_caracteristicas' => "",
                            'detalleven_comision' => 0,
                        );
                        $this->Detalle_venta_model->update_detalle_venta($insumo['detalleven_id'], $detalleventa);
                    }
                    
                    $detparams = array(
                                    'estado_id' => $estado_id,
                    );
                    $this->Detalle_serv_model->update_detalle_serv($detalleserv_id, $detparams);

                    $cont = 0;
                    foreach($res_ids as $ids)
                    {
                        if($ids['estado_id'] == $estado_id){
                            $cont++;
                        }
                    }
                    if($cont == count($res_ids)){
                        $params = array(
                                    'estado_id' => $estado_id,
                        );
                        
                        $this->Servicio_model->update_servicio($servicio_id,$params);
                    }

                    $detparams = array(
                                    'detalleserv_total' => 0,
                                    'detalleserv_acuenta' => 0,
                                    'detalleserv_saldo' => 0,
                    );

                    $this->Detalle_serv_model->anular_detalle_serv($detalleserv_id, $detparams);

                    $data['resultado'] = $this->Detalle_serv_model->sumarmontos($servicio_id);
                    $total = $data['resultado']['total'];
                    $acuenta = $data['resultado']['acuenta'];
                    $saldo = $data['resultado']['saldo'];
                    $sumparams = array(
                                        'servicio_total' => $total,
                                        'servicio_acuenta' => $acuenta,
                                        'servicio_saldo' => $saldo,
                    );

                    $this->Servicio_model->update_servicio($servicio_id,$sumparams);
                    redirect('servicio/serviciocreado/'.$servicio_id);
                    
                }elseif($estado_id == 7){ //el 7 representa a ENTREGADO
                    $estado_credid = 16;
                    $fecha_finalizacion = date('Y-m-d');
                    $hora_finalizacion = date('H:i:s');
                    $fechahora = date('Y-m-d H:i:s');
                    if($inputacuenta > 0)
                    {
                        $detparams = array(
                                'detalleserv_fpagoacuenta' => $fechahora,
                                'usuariopacuenta_id' => $usuario_id,
                        );
                        $this->Detalle_serv_model->update_detalle_serv($detalleserv_id, $detparams);

                    }
                    $detparams = array(
                            'estado_id' => $estado_id,
                            'detalleserv_fechaentregado' => $fecha_finalizacion,
                            'detalleserv_horaentregado' => $hora_finalizacion,
                    );
                    $this->Detalle_serv_model->update_detalle_serv($detalleserv_id, $detparams);
                    
                    if($inputsaldo > 0)
                    {
                        $salparams = array(
                                'detalleserv_fpagosaldo' => $fechahora,
                                'usuariopsaldo_id' => $usuario_id,
                        );
                        $this->Detalle_serv_model->update_detalle_serv($detalleserv_id, $salparams);
                    }
                    $cont = 0;
                    foreach($res_ids as $ids)
                    {
                        if($ids['estado_id'] == $estado_id || $ids['estado_id'] == $estado_credid){
                            $cont++;
                        }
                    }
                    if($cont == count($res_ids)){
                        $params = array(
                                    'estado_id' => $estado_id,
                                    'servicio_fechafinalizacion' => $fecha_finalizacion,
                                    'servicio_horafinalizacion' => $hora_finalizacion,
                        );
                        $this->Servicio_model->update_servicio($servicio_id,$params);
                    }
                    $data['resultado'] = $this->Detalle_serv_model->sumarmontos($servicio_id);
                    
                    $total = $data['resultado']['total'];
                    $acuenta = $data['resultado']['acuenta'];
                    $saldo = $data['resultado']['saldo'];
                    $sumparams = array(
                                    'servicio_total' => $total,
                                    'servicio_acuenta' => $acuenta,
                                    'servicio_saldo' => $saldo,
                    );

                    $this->Servicio_model->update_servicio($servicio_id,$sumparams);
                    
                    redirect('servicio/serviciocreado/'.$servicio_id);
                    
                }elseif($estado_id == 6 || $estado_id == 5)
                { //5 --> PENDIENTE; 6-->TERMINADO
                    $detparams = array(
                                    'estado_id' => $estado_id,
                    );
                    $this->Detalle_serv_model->update_detalle_serv($detalleserv_id, $detparams);

                    $cont = 0;
                    foreach($res_ids as $ids)
                    {
                        if($ids['estado_id'] == $estado_id){
                            $cont++;
                        }
                    }
                    if($cont == count($res_ids)){
                        $params = array(
                                    'estado_id' => $estado_id,
                        );
                        $this->Servicio_model->update_servicio($servicio_id,$params);
                    }
                    if($estado_id == 6 ){
                        $fecha_terminado = date('Y-m-d');
                        $hora_terminado = date('H:i:s');
                        $paramsdet = array(
                                    'detalleserv_fechaterminado' => $fecha_terminado,
                                    'detalleserv_horaterminado' => $hora_terminado,
                        );
                        $this->Detalle_serv_model->update_detalle_serv($detalleserv_id,$paramsdet);
                    }
                    $data['resultado'] = $this->Detalle_serv_model->sumarmontos($servicio_id);
                    $total = $data['resultado']['total'];
                    $acuenta = $data['resultado']['acuenta'];
                    $saldo = $data['resultado']['saldo'];
                    $sumparams = array(
                                    'servicio_total' => $total,
                                    'servicio_acuenta' => $acuenta,
                                    'servicio_saldo' => $saldo,
                    );

                    $this->Servicio_model->update_servicio($servicio_id,$sumparams);
                    redirect('servicio/serviciocreado/'.$servicio_id);
                }elseif($estado_id == 16){
                    //este estado es CREDITO
        $estado_terminadoid = 7; // estado ENTREGADO
        $credito_monto = $inputsaldo;
        
            /* **********INICIO  poner en credito************* */
            //8 = pendiente de Creditos
            $estadocredito_id = 8;
            $una_semana = time() + (7 * 24 * 60 * 60);
            $credito_fechalimite = date('Y-m-d', $una_semana);
            $credito_fecha = date("Y-m-d");
            $credito_hora = date("H:i:s");
            $cadcredito = array(
                'estado_id' => $estadocredito_id,
                'compra_id' => 0,
                'venta_id' => 0,
                'servicio_id' => $servicio_id,
                'credito_monto' => $credito_monto,
                'credito_cuotainicial' => 0,
                'credito_interesproc' => 0,
                'credito_interesmonto' => 0,
                'credito_numpagos' => 1,
                'credito_fechalimite' => $credito_fechalimite,
                'credito_fecha' => $credito_fecha,
                'credito_hora' => $credito_hora,
                'credito_tipo' => 1,
            );
            $this->load->model('Credito_model');
            $credito_id = $this->Credito_model->add_credito($cadcredito);
            $usuario_id = $this->session_data['usuario_id'];
            $cadcuota = array(
                'credito_id' => $credito_id,
                'usuario_id' => $usuario_id,
                'estado_id' => $estadocredito_id,
                'cuota_numcuota' => 1,
                'cuota_capital' => $credito_monto,
                'cuota_interes' => 0,
                'cuota_moradias' => 0,
                'cuota_multa' => 0,
                'cuota_subtotal' => $credito_monto,
                'cuota_descuento' => 0,
                'cuota_total' => $credito_monto,
                'cuota_fechalimite' => $credito_fechalimite,
                'cuota_cancelado' => 0,
                'cuota_saldo' => $credito_monto,
                
            );
            $this->load->model('Cuotum_model');
            $cuota_id = $this->Cuotum_model->add_cuotum($cadcuota);
            /* **********F I N  poner en credito************* */
            $cad = array(
                    'estado_id' => $estado_id,
                );
            $this->Detalle_serv_model->update_detalle_serv($detalleserv_id,$cad);
            
            $res_ids = $this->Detalle_serv_model->get_ids_estado_detalle_serv($servicio_id);
            $cont = 0;
            foreach ($res_ids as $ids)
            {
                if($ids['estado_id'] == $estado_id || $ids['estado_id'] == $estado_terminadoid){
                    $cont++;
                }
            }
            if($cont == count($res_ids)){
                $params = array(
                            'estado_id' => $estado_terminadoid,
                );
                $this->load->model('Servicio_model');
                $this->Servicio_model->update_servicio($servicio_id,$params);
            }
             redirect('servicio/serviciocreado/'.$servicio_id);
                }elseif($estado_id == 28){
                    $detparams = array(
                                    'estado_id' => $estado_id,
                    );
                    $this->Detalle_serv_model->update_detalle_serv($detalleserv_id, $detparams);

                    $cont = 0;
                    foreach($res_ids as $ids)
                    {
                        if($ids['estado_id'] == $estado_id){
                            $cont++;
                        }
                    }
                    if($cont == count($res_ids)){
                        $params = array(
                                    'estado_id' => $estado_id,
                        );
                        $this->Servicio_model->update_servicio($servicio_id,$params);
                    }
                    redirect('servicio/serviciocreado/'.$servicio_id);
                }
            }
            else
            {
                redirect('servicio/serviciocreado/'.$servicio_id);
            }
        }else
        {
            $data['detalle_serv'] = $this->Detalle_serv_model->get_detalle_serv($detalleserv_id);
            
            $this->load->model('Categoria_servicio_model');
	    $data['all_categoria_servicio'] = $this->Categoria_servicio_model->get_all_categoria_servicio_id1();
            
            $this->load->model('Subcategoria_servicio_model');
	    $data['all_subcategoria_servicio'] = $this->Subcategoria_servicio_model->get_all_subcategoria_servicio_id1();
            /*
            $this->load->model('Responsable_model');
	    $data['all_responsable'] = $this->Responsable_model->get_all_responsable();
            */
            $this->load->model('Usuario_model');
	    $data['all_responsable'] = $this->Usuario_model->get_all_usuario_tecnicoresponsable_ok();
            
            $this->load->model('Tipo_servicio_model');
	    $data['tipo_servicio'] = $this->Tipo_servicio_model->get_tipo_servicio($data['servicio']['tiposerv_id']);
	    $data['all_tipo_servicio'] = $this->Tipo_servicio_model->get_all_tipo_servicio_id1();
            
            $this->load->model('Categoria_trabajo_model');
	    $data['all_categoria_trabajo'] = $this->Categoria_trabajo_model->get_all_categoria_trabajo_id1();
            
            $this->load->model('Tiempo_uso_model');
	    $data['all_tiempo_uso'] = $this->Tiempo_uso_model->get_all_tiempo_uso_id1();
            
            $this->load->model('Procedencia_model');
	    $data['all_procedencia'] = $this->Procedencia_model->get_all_procedencia_id1();

            $this->load->model('Estado_model');
	    $data['all_estado'] = $this->Estado_model->get_all_estado_servicio();
            
            $data['_view'] = 'detalle_serv/modificardetalle';
            $this->load->view('layouts/main',$data);
        }
        }
    }
    /*
     *  *********************Modifica el detalle cuando se va a ver un servicio, no mmodifica el codigo*******************************
     */
    function modificarmidetalle($servicio_id, $detalleserv_id)
    {
        $data['sistema'] = $this->sistema;
        
        if($this->acceso(86)){
            $data['page_title'] = "Detalle de Servicio";
        $this->load->model('Servicio_model');
        $data['servicio'] = $this->Servicio_model->get_servicio($servicio_id);
        
        if(isset($_POST) && count($_POST) > 0)     
        {
            $this->load->library('form_validation');

	    $this->form_validation->set_rules('detalleserv_descripcion','Detalle Servicio Descripcion','required');
	    //$this->form_validation->set_rules('detalleserv_codigo','Detalle Servicio Codigo','required');
	    $this->form_validation->set_rules('detalleserv_falla','Detalle Servicio Falla','required');
            
	    if($this->form_validation->run())     
            {
                $estado_id = $this->input->post('estado_id');
                //$fecha_entrega = $this->Detalle_serv_model->normalize_date($this->input->post('detalleserv_fechaentrega'));
                $hora_entrega = date("H:i:s", strtotime($this->input->post('detalleserv_horaentrega')));
            
                $usuario_id = $this->session_data['usuario_id'];
                $inputacuenta = $this->input->post('detalleserv_acuenta');
                $inputsaldo = $this->input->post('detalleserv_saldo');
                $catserv_id = $this->input->post('catserv_id');
                $subcatserv_id = $this->input->post('subcatserv_id');
                $esreclamo = $this->input->post('detalleserv_reclamo');
                if(isset($esreclamo)){
                    $esreclamo = "si";
                }else{
                    $esreclamo = "no";
                }
                $params = array(
                                    'estado_id' => $estado_id,
                                    'responsable_id' => $this->input->post('responsable_id'),
                                    'usuario_id' => $usuario_id,
                                    'servicio_id' => $servicio_id,
                                    'catserv_id' => $catserv_id,
                                    'subcatserv_id' => $subcatserv_id,
                                    'cattrab_id' => $this->input->post('cattrab_id'),
                                    'tiempouso_id' => $this->input->post('tiempouso_id'),
                                    'procedencia_id' => $this->input->post('procedencia_id'),
                                    //'detalleserv_codigo' => $this->input->post('detalleserv_codigo'),
                                    'detalleserv_descripcion' => $this->input->post('detalleserv_descripcion'),
                                    'detalleserv_reclamo' => $esreclamo,
                                    'detalleserv_falla' => $this->input->post('detalleserv_falla'),
                                    'detalleserv_diagnostico' => $this->input->post('detalleserv_diagnostico'),
                                    'detalleserv_solucion' => $this->input->post('detalleserv_solucion'),
                                    'detalleserv_pesoentrada' => $this->input->post('detalleserv_pesoentrada'),
                                    'detalleserv_glosa' => $this->input->post('detalleserv_glosa'),
                                    'detalleserv_total' => $this->input->post('detalleserv_total'),
                                    'detalleserv_acuenta' => $inputacuenta,
                                    'detalleserv_saldo' => $inputsaldo,
//                                    'detalleserv_fechaterminado' => $this->input->post('detalleserv_fechaterminado'),
//                                    'detalleserv_horaterminado' => $this->input->post('detalleserv_horaterminado'),
                                    'detalleserv_fechaentrega' => $this->input->post('detalleserv_fechaentrega'),
                                    'detalleserv_horaentrega' => $hora_entrega,
                                    //'detalleserv_insumo' => $this->input->post('detalleserv_insumo'),
                );

                $this->Detalle_serv_model->update_detalle_serv($detalleserv_id,$params);
                
                $this->load->model('Servicio_model');
                
                $res_ids = $this->Detalle_serv_model->get_ids_estado_detalle_serv($servicio_id);
                // 4 es el estado de ANULADO
                if($estado_id == 4)
                {
                    $this->load->model('Categoria_insumo_model');
                    $this->load->model('Detalle_venta_model');
                    $insumos_usados = $this->Categoria_insumo_model->get_all_insumos_usados($detalleserv_id);
                    foreach($insumos_usados as $insumo){
                        $detalleventa = array(
                            'detalleven_cantidad' => 0,
                            'detalleven_unidad' => 0,
                            'detalleven_costo' => 0,
                            'detalleven_precio' => 0,
                            'detalleven_descuento' => 0,
                            'detalleven_total' => 0,
                            'detalleven_preferencia' => "-",
                            'detalleven_caracteristicas' => "",
                            'detalleven_comision' => 0,
                        );
                        $this->Detalle_venta_model->update_detalle_venta($insumo['detalleven_id'], $detalleventa);
                    }
                    $detparams = array(
                                    'estado_id' => $estado_id,
                    );
                    $this->Detalle_serv_model->update_detalle_serv($detalleserv_id, $detparams);
                    
                    $cont = 0;
                    foreach($res_ids as $ids)
                    {
                        if($ids['estado_id'] == $estado_id){
                            $cont++;
                        }
                    }
                    if($cont == count($res_ids)){
                        $params = array(
                                    'estado_id' => $estado_id,
                        );
                        $this->Servicio_model->update_servicio($servicio_id,$params);
                    }

                    $detparams = array(
                                    'detalleserv_total' => 0,
                                    'detalleserv_acuenta' => 0,
                                    'detalleserv_saldo' => 0,
                    );

                    $this->Detalle_serv_model->anular_detalle_serv($detalleserv_id, $detparams);

                    $data['resultado'] = $this->Detalle_serv_model->sumarmontos($servicio_id);
                    $total = $data['resultado']['total'];
                    $acuenta = $data['resultado']['acuenta'];
                    $saldo = $data['resultado']['saldo'];
                    $sumparams = array(
                                        'servicio_total' => $total,
                                        'servicio_acuenta' => $acuenta,
                                        'servicio_saldo' => $saldo,
                    );

                    $this->Servicio_model->update_servicio($servicio_id,$sumparams);
                    redirect('servicio/serview/'.$servicio_id);
                    
                }elseif($estado_id == 7){ //el 7 representa a ENTREGADO
                    $estado_credid = 16;
                    $fecha_finalizacion = date('Y-m-d');
                    $hora_finalizacion = date('H:i:s');
                    $fechahora = date('Y-m-d H:i:s');
                    if($inputacuenta > 0)
                    {
                        $detparams = array(
                                'detalleserv_fpagoacuenta' => $fechahora,
                                'usuariopacuenta_id' => $usuario_id,
                        );
                        $this->Detalle_serv_model->update_detalle_serv($detalleserv_id, $detparams);

                    }
                    $detparams = array(
                            'estado_id' => $estado_id,
                            'detalleserv_fechaentregado' => $fecha_finalizacion,
                            'detalleserv_horaentregado' => $hora_finalizacion,
                    );
                    $this->Detalle_serv_model->update_detalle_serv($detalleserv_id, $detparams);
                    
                    if($inputsaldo > 0)
                    {
                        $salparams = array(
                                'detalleserv_fpagosaldo' => $fechahora,
                                'usuariopsaldo_id' => $usuario_id,
                        );
                        $this->Detalle_serv_model->update_detalle_serv($detalleserv_id, $salparams);
                    }
                    $cont = 0;
                    foreach($res_ids as $ids)
                    {
                        if($ids['estado_id'] == $estado_id || $ids['estado_id'] == $estado_credid){
                            $cont++;
                        }
                    }
                    if($cont == count($res_ids)){
                        $params = array(
                                    'estado_id' => $estado_id,
                                    'servicio_fechafinalizacion' => $fecha_finalizacion,
                                    'servicio_horafinalizacion' => $hora_finalizacion,
                        );
                        $this->Servicio_model->update_servicio($servicio_id,$params);
                    }
                    $data['resultado'] = $this->Detalle_serv_model->sumarmontos($servicio_id);
                    
                    $total = $data['resultado']['total'];
                    $acuenta = $data['resultado']['acuenta'];
                    $saldo = $data['resultado']['saldo'];
                    $sumparams = array(
                                    'servicio_total' => $total,
                                    'servicio_acuenta' => $acuenta,
                                    'servicio_saldo' => $saldo,
                    );

                    $this->Servicio_model->update_servicio($servicio_id,$sumparams);
                    
                    redirect('servicio/serview/'.$servicio_id);
                    
                }elseif($estado_id == 6 || $estado_id == 5)
                { //5 --> PENDIENTE; 6-->TERMINADO
                    $detparams = array(
                                    'estado_id' => $estado_id,
                    );
                    $this->Detalle_serv_model->update_detalle_serv($detalleserv_id, $detparams);
                    
                    $res_ids = $this->Detalle_serv_model->get_ids_estado_detalle_serv($servicio_id);
                    $cont = 0;
                    foreach($res_ids as $ids)
                    {
                        if($ids['estado_id'] == $estado_id){
                            $cont++;
                        }
                    }
                    if($cont == count($res_ids)){
                        $params = array(
                                    'estado_id' => $estado_id,
                        );
                        
                        $this->Servicio_model->update_servicio($servicio_id,$params);
                    }
                    if($estado_id == 6 ){
                        $fecha_terminado = date('Y-m-d');
                        $hora_terminado = date('H:i:s');
                        $paramsdet = array(
                                    'detalleserv_fechaterminado' => $fecha_terminado,
                                    'detalleserv_horaterminado' => $hora_terminado,
                        );
                        $this->Detalle_serv_model->update_detalle_serv($detalleserv_id,$paramsdet);
                    }
                    $data['resultado'] = $this->Detalle_serv_model->sumarmontos($servicio_id);
                    $total = $data['resultado']['total'];
                    $acuenta = $data['resultado']['acuenta'];
                    $saldo = $data['resultado']['saldo'];
                    $sumparams = array(
                                    'servicio_total' => $total,
                                    'servicio_acuenta' => $acuenta,
                                    'servicio_saldo' => $saldo,
                    );

                    $this->Servicio_model->update_servicio($servicio_id,$sumparams);
                    redirect('servicio/serview/'.$servicio_id);
                }elseif($estado_id == 16){
                    //este estado es CREDITO
        $estado_terminadoid = 7; // estado ENTREGADO
        $credito_monto = $inputsaldo;
        
            /* **********INICIO  poner en credito************* */
            //8 = pendiente de Creditos
            $estadocredito_id = 8;
            $una_semana = time() + (7 * 24 * 60 * 60);
            $credito_fechalimite = date('Y-m-d', $una_semana);
            $credito_fecha = date("Y-m-d");
            $credito_hora = date("H:i:s");
            $cadcredito = array(
                'estado_id' => $estadocredito_id,
                'compra_id' => 0,
                'venta_id' => 0,
                'servicio_id' => $servicio_id,
                'credito_monto' => $credito_monto,
                'credito_cuotainicial' => 0,
                'credito_interesproc' => 0,
                'credito_interesmonto' => 0,
                'credito_numpagos' => 1,
                'credito_fechalimite' => $credito_fechalimite,
                'credito_fecha' => $credito_fecha,
                'credito_hora' => $credito_hora,
                'credito_tipo' => 1,
            );
            $this->load->model('Credito_model');
            $credito_id = $this->Credito_model->add_credito($cadcredito);
            $usuario_id = $this->session_data['usuario_id'];
            $cadcuota = array(
                'credito_id' => $credito_id,
                'usuario_id' => $usuario_id,
                'estado_id' => $estadocredito_id,
                'cuota_numcuota' => 1,
                'cuota_capital' => $credito_monto,
                'cuota_interes' => 0,
                'cuota_moradias' => 0,
                'cuota_multa' => 0,
                'cuota_subtotal' => $credito_monto,
                'cuota_descuento' => 0,
                'cuota_total' => $credito_monto,
                'cuota_fechalimite' => $credito_fechalimite,
                'cuota_cancelado' => 0,
                'cuota_saldo' => $credito_monto,
                
            );
            $this->load->model('Cuotum_model');
            $cuota_id = $this->Cuotum_model->add_cuotum($cadcuota);
            /* **********F I N  poner en credito************* */
            $cad = array(
                    'estado_id' => $estado_id,
                );
            $this->Detalle_serv_model->update_detalle_serv($detalleserv_id,$cad);
            
            $res_ids = $this->Detalle_serv_model->get_ids_estado_detalle_serv($servicio_id);
            $cont = 0;
            foreach ($res_ids as $ids)
            {
                if($ids['estado_id'] == $estado_id || $ids['estado_id'] == $estado_terminadoid){
                    $cont++;
                }
            }
            if($cont == count($res_ids)){
                $params = array(
                            'estado_id' => $estado_terminadoid,
                );
                $this->load->model('Servicio_model');
                $this->Servicio_model->update_servicio($servicio_id,$params);
            }
             redirect('servicio/serview/'.$servicio_id);
            }elseif($estado_id == 28){
                $fecha_proceso = date('Y-m-d');
                $hora_proceso  = date('H:i:s');
                    $detparams = array(
                        'estado_id' => $estado_id,
                        'detalleserv_fechaproceso' => $fecha_proceso,
                        'detalleserv_horaproceso'  => $hora_proceso,
                    );
                    $this->Detalle_serv_model->update_detalle_serv($detalleserv_id, $detparams);

                    $cont = 0;
                    foreach($res_ids as $ids)
                    {
                        if($ids['estado_id'] == $estado_id){
                            $cont++;
                        }
                    }
                    if($cont == count($res_ids)){
                        $params = array(
                                    'estado_id' => $estado_id,
                        );
                        $this->Servicio_model->update_servicio($servicio_id,$params);
                    }
                    redirect('servicio/serview/'.$servicio_id);
                }
            redirect('servicio/serview/'.$servicio_id);
            }
            else
            {
                redirect('servicio/serview/'.$servicio_id);
            }
        }else
        {
            $data['detalle_serv'] = $this->Detalle_serv_model->get_detalle_serv($detalleserv_id);
            
            $this->load->model('Categoria_servicio_model');
	    $data['all_categoria_servicio'] = $this->Categoria_servicio_model->get_all_categoria_servicio_id1();
            
            $this->load->model('Subcategoria_servicio_model');
	    $data['all_subcategoria_servicio'] = $this->Subcategoria_servicio_model->get_all_subcategoria_servicio_id1();
            /*
            $this->load->model('Responsable_model');
	    $data['all_responsable'] = $this->Responsable_model->get_all_responsable();
            */
            $this->load->model('Usuario_model');
	    $data['all_responsable'] = $this->Usuario_model->get_all_usuario_tecnicoresponsable_ok();
            
            $this->load->model('Tipo_servicio_model');
	    $data['tipo_servicio'] = $this->Tipo_servicio_model->get_tipo_servicio($data['servicio']['tiposerv_id']);
	    $data['all_tipo_servicio'] = $this->Tipo_servicio_model->get_all_tipo_servicio_id1();
            
            $this->load->model('Categoria_trabajo_model');
	    $data['all_categoria_trabajo'] = $this->Categoria_trabajo_model->get_all_categoria_trabajo_id1();
            
            $this->load->model('Tiempo_uso_model');
	    $data['all_tiempo_uso'] = $this->Tiempo_uso_model->get_all_tiempo_uso_id1();
            
            $this->load->model('Procedencia_model');
	    $data['all_procedencia'] = $this->Procedencia_model->get_all_procedencia_id1();

            $this->load->model('Estado_model');
	    $data['all_estado'] = $this->Estado_model->get_all_estado_servicio();
            
            $data['_view'] = 'detalle_serv/modificarmidetalle';
            $this->load->view('layouts/main',$data);
        }
        }
    }
    /*
     * *************Modifica los datos de Diagnostico, Solucion,
     * *************peso salida, Glosa y estado de este detalle de servicio ($detalleser_id)
     */
    function registrartec($servicio_id, $detalleserv_id)
    {
        $data['sistema'] = $this->sistema;
        if($this->acceso(80)){
            $this->load->library('form_validation');

	    $this->form_validation->set_rules('detalleserv_diagnostico','Detalle Servicio Diagnostico','required');
	    $this->form_validation->set_rules('detalleserv_solucion','Detalle Servicio Solucion','required');
            
	    if($this->form_validation->run())       
            {
                $estado_id = 6; //Estado definido en la tabla (TERMINADO)
                $fecha_terminado = date('Y-m-d');
                $hora_terminado = date('H:i:s');
                $detparams = array(
                                'estado_id' => $estado_id,
                                'detalleserv_fechaterminado' => $fecha_terminado,
                                'detalleserv_horaterminado' => $hora_terminado,
                                'detalleserv_diagnostico' => $this->input->post('detalleserv_diagnostico'),
                                'detalleserv_solucion' => $this->input->post('detalleserv_solucion'),
                                'detalleserv_pesosalida' => $this->input->post('detalleserv_pesosalida'),
                                'detalleserv_glosa' => $this->input->post('detalleserv_glosa'),
                );
                $this->Detalle_serv_model->update_detalle_serv($detalleserv_id,$detparams);

                $res_ids = $this->Detalle_serv_model->get_ids_estado_detalle_serv($servicio_id);
                $cont = 0;
                foreach ($res_ids as $ids)
                {
                    if($ids['estado_id'] == $estado_id){
                        $cont++;
                    }
                }
                if($cont == count($res_ids)){
                    $params = array(
                                'estado_id' => $estado_id,
                    );
                    $this->load->model('Servicio_model');
                    $this->Servicio_model->update_servicio($servicio_id,$params);
                }
                echo json_encode("ok");
                //redirect('servicio/serview/'.$servicio_id);
            }else{
                echo json_encode("faltadatos");
            }
        }
    }
    /*
     * *************Registra el cobro total de un servicio *********************
     * *************y recalcula los valores de los detalles y cambia todos los estado a ENTREGADO***********
     */
    function registrarcobroTotalOK($servicio_id)
    {
        $data['sistema'] = $this->sistema;
        if($this->acceso(84)){
        $cad = "";
        $servicio_total = $this->input->post('servicio_total');
        if(isset($servicio_total))
        {
            $fecha_cobro =  $this->input->post('fecha_cobro');
            //$fecha_entrega = $this->Detalle_serv_model->normalize_date($fecha_cobro);
            $fecha_finalizacion = date("Y-m-d", strtotime($fecha_cobro));
            $hora_finalizacion = date("H:i:s", strtotime($fecha_cobro));
            
            $res_detalle_serv = $this->Detalle_serv_model->get_detalle_serv_menos_all($servicio_id);
            $estado_id = 7; //es el estado ENTREGADO
            foreach ($res_detalle_serv as $det_serv)
            {
                $detalleserv_acuenta = $det_serv['detalleserv_total'];
                $cad = array(
                        'estado_id' => $estado_id,
                        'detalleserv_acuenta' => $detalleserv_acuenta,
                        'detalleserv_saldo' => 0,
                        'detalleserv_fechaentregado' => $fecha_finalizacion,
                        'detalleserv_horaentregado' => $hora_finalizacion,
                );
                $this->Detalle_serv_model->update_detalle_serv($det_serv['detalleserv_id'],$cad);
            }
            
            $cadserv = array(
                        'estado_id' => $estado_id,
                        'servicio_acuenta' => $servicio_total,
                        'servicio_saldo' => 0,
                        'servicio_fechafinalizacion' => $fecha_finalizacion,
                        'servicio_horafinalizacion' => $hora_finalizacion,
                );
            $this->load->model('Servicio_model');
            $this->Servicio_model->update_servicio($servicio_id,$cadserv);
            
             redirect('servicio/serview/'.$servicio_id);
        } else {
            redirect('servicio/serview/'.$servicio_id);
        }
        }
    }
    /*
     * *************Registra el cobro total (DE TODOS LOS DETALLES QUE ESTEN EN TERMINADO(estado_id = 6)) de un servicio *********************
     * *************y recalcula los valores de los detalles y cambia todos los estados a ENTREGADO(estado_id = 7)***********
     */
    function registrarcobrototal($servicio_id)
    {
        $data['sistema'] = $this->sistema;
        if($this->acceso(84)){
            $usuario_id = $this->session_data['usuario_id'];
            $fecha_cobro =  $this->input->post('fecha_cobro');
            $detalleserv_entregadoa =  $this->input->post('detalleserv_entregadoa');
            $fecha_finalizacion = date("Y-m-d", strtotime($fecha_cobro));
            $hora_finalizacion = date("H:i:s", strtotime($fecha_cobro));
            $fechahora = date("Y-m-d H:i:s", strtotime($fecha_cobro));
            
            $this->load->model('Servicio_model');
            //recupera a todos los detalles de servicio que su estado sean 6= TERMINADO
            $res_detalle_serv = $this->Detalle_serv_model->get_detalle_serv_all_terminado($servicio_id);
            $estado_id = 7; //es el estado ENTREGADO
            $estado_creditoid = 16; //es el estado CREDITO
            foreach ($res_detalle_serv as $det_serv)
            {
                $cad = array(
                        'estado_id' => $estado_id,
                        'detalleserv_fechaentregado' => $fecha_finalizacion,
                        'detalleserv_horaentregado' => $hora_finalizacion,
                        'detalleserv_fpagosaldo' => $fechahora,
                        'usuariopsaldo_id' => $usuario_id,
                        'detalleserv_entregadoa' => $detalleserv_entregadoa,
                );
                $this->Detalle_serv_model->update_detalle_serv($det_serv['detalleserv_id'],$cad);
            }
            
            $res_ids = $this->Detalle_serv_model->get_ids_estado_detalle_serv($servicio_id);
            $cont = 0;
            foreach($res_ids as $ids)
            {
                if($ids['estado_id'] == $estado_id || $ids['estado_id'] == $estado_creditoid){
                    $cont++;
                }
            }
            if($cont == count($res_ids)){
                $params = array(
                            'estado_id' => $estado_id,
                            'servicio_fechafinalizacion' => $fecha_finalizacion,
                            'servicio_horafinalizacion' => $hora_finalizacion,
                );

                $this->Servicio_model->update_servicio($servicio_id,$params);
            }
            /*
            $data['resultado'] = $this->Detalle_serv_model->sumarmontos($servicio_id);

            $total = $data['resultado']['total'];
            $acuenta = $data['resultado']['acuenta'];
            $saldo = $data['resultado']['saldo'];
            $cadserv = array(
                            'servicio_total' => $total,
                            'servicio_acuenta' => $acuenta,
                            'servicio_saldo' => $saldo,
            );

            
            $this->Servicio_model->update_servicio($servicio_id,$cadserv);
            */
           echo json_encode("ok");
             //redirect('servicio/serview/'.$servicio_id);
        }
    }
    /*
     * *************Registra el cobro de un detalle de servicio *********************
     * *************y recalcula los valores de los detalles y cambia el estado de este detalle a ENTREGADO***********
     */
    function registrarcobrodetalle($servicio_id, $detalleserv_id)
    {
        $data['sistema'] = $this->sistema;
        if($this->acceso(87)){
                $this->load->library('form_validation');
                $this->form_validation->set_rules('fecha_cobro','Detalle Servicio Fecha Cobro','required');
            
	    if($this->form_validation->run())       
            {
                
            //Este estado_id 7 es ENTREGADO, que tambien significa que es pagado
            $estado_id  = 7;
            $estado_id2 = 16;
            $usuario_id = $this->session_data['usuario_id'];
            $fecha_cobro =  $this->input->post('fecha_cobro');
            $fecha_finalizacion = date("Y-m-d", strtotime($fecha_cobro));
            $hora_finalizacion = date("H:i:s", strtotime($fecha_cobro));
            $fechaHora = date("Y:m:d H:i:s", strtotime($fecha_cobro));
            $cad = array(
                    'estado_id' => $estado_id,
                    'detalleserv_fechaentregado' => $fecha_finalizacion,
                    'detalleserv_horaentregado' => $hora_finalizacion,
                    'detalleserv_fpagosaldo' => $fechaHora,
                    'usuariopsaldo_id' => $usuario_id,
                );
            $this->Detalle_serv_model->update_detalle_serv($detalleserv_id,$cad);
                     
            $res_ids = $this->Detalle_serv_model->get_ids_estado_detalle_serv($servicio_id);
            $cont = 0;
            foreach ($res_ids as $ids)
            {
                if($ids['estado_id'] == $estado_id || $ids['estado_id'] == $estado_id2){
                    $cont++;
                }
            }
            if($cont == count($res_ids)){
                $params = array(
                            'estado_id' => $estado_id,
                            'servicio_fechafinalizacion' => $fecha_finalizacion,
                            'servicio_horafinalizacion' => $hora_finalizacion,
                );
                $this->load->model('Servicio_model');
                $this->Servicio_model->update_servicio($servicio_id,$params);
            }
            
            echo json_encode("ok");
            //redirect('servicio/serview/'.$servicio_id);
            
        }else{
                echo json_encode("faltadatos");
            }
        }
    }
    /*
     * Funcion que busca todos los detalles de los servicios con un determiando estado(estado_id)
     * PENDIENTE, TERMINADO, ENTREGADO, ANULADO
     */
    function buscarporestado()
    {
        $data['sistema'] = $this->sistema;
        if($this->acceso(69)){
            $data['page_title'] = "Detalle de Servicio";
            $estado_id = $this->input->post('estado_id');
            if(isset($estado_id))
            {
                $params['limit'] = RECORDS_PER_PAGE; 
                $params['offset'] = ($this->input->get('per_page')) ? $this->input->get('per_page') : 0;

                $config = $this->config->item('pagination');
                $config['base_url'] = site_url('detalle_serv/buscarporestado?');
                $config['total_rows'] = $this->Detalle_serv_model->get_all_detalle_serv_count_estado($estado_id);
                $this->pagination->initialize($config);

                $data['detalle_serv'] = $this->Detalle_serv_model->get_detalle_serv_all_for_estado($estado_id, $params);

                $data['_view'] = 'detalle_serv/buscarporestado';
                $this->load->view('layouts/main',$data);

            }else{
                redirect('servicio/index');
            }
        }
    }
    /*
     * Funcion que busca todos los detalles de los servicios
     * con una determianda categoria(tipo) de trabajo(cattrab_id)
     * RECARGA, PROCESO, REMOJO, REVISION
     */
    function buscarportrabajo()
    {
        $data['sistema'] = $this->sistema;
        if($this->acceso(69)){
            $data['page_title'] = "Detalle de Servicio";
        $cattrab_id = $this->input->post('cattrab_id');
        if(isset($cattrab_id))
        {
            $params['limit'] = RECORDS_PER_PAGE; 
            $params['offset'] = ($this->input->get('per_page')) ? $this->input->get('per_page') : 0;

            $config = $this->config->item('pagination');
            $config['base_url'] = site_url('detalle_serv/buscarportrabajo?');
            $config['total_rows'] = $this->Detalle_serv_model->get_all_detalle_serv_count_ctrabajo($cattrab_id);
            $this->pagination->initialize($config);

            $data['detalle_serv'] = $this->Detalle_serv_model->get_detalle_serv_all_for_ctrabajo($cattrab_id, $params);
        
            $data['_view'] = 'detalle_serv/buscarportrabajo';
            $this->load->view('layouts/main',$data);
            
        }else{
            redirect('servicio/index');
        }
        }
    }
    
    /*
     * ************* Funcion que Registra el detalle de un servicio *********************
     * ************* y recalcula los valores de los detalles y cambia todos los estado a ENTREGADO***********
     */
    function registrarcreditodetalle()
    {
        $data['sistema'] = $this->sistema;
        if($this->acceso(88)){
        //este estado es CREDITO
        $estado_id = 16;
        $estado_terminadoid = 7; // estado ENTREGADO
        $servicio_id = $this->input->post('servicio_id');
        $detalleserv_id = $this->input->post('detalleserv_id');
        $credito_monto = $this->input->post('monto');
        if(isset($detalleserv_id))
        {
            /* **********INICIO  poner en credito************* */
            //8 = pendiente de Creditos
            $estadocredito_id = 8;
            $una_semana = time() + (7 * 24 * 60 * 60);
            $credito_fechalimite = date('Y-m-d', $una_semana);
            $credito_fecha = date("Y-m-d");
            $credito_hora = date("H:i:s");
            $cadcredito = array(
                'estado_id' => $estadocredito_id,
                'compra_id' => 0,
                'venta_id' => 0,
                'servicio_id' => $servicio_id,
                'credito_monto' => $credito_monto,
                'credito_cuotainicial' => 0,
                'credito_interesproc' => 0,
                'credito_interesmonto' => 0,
                'credito_numpagos' => 1,
                'credito_fechalimite' => $credito_fechalimite,
                'credito_fecha' => $credito_fecha,
                'credito_hora' => $credito_hora,
                'credito_tipo' => 1,
            );
            $this->load->model('Credito_model');
            $credito_id = $this->Credito_model->add_credito($cadcredito);
            $usuario_id = $this->session_data['usuario_id'];
            $cadcuota = array(
                'credito_id' => $credito_id,
                'usuario_id' => $usuario_id,
                'estado_id' => $estadocredito_id,
                'cuota_numcuota' => 1,
                'cuota_capital' => $credito_monto,
                'cuota_interes' => 0,
                'cuota_moradias' => 0,
                'cuota_multa' => 0,
                'cuota_subtotal' => $credito_monto,
                'cuota_descuento' => 0,
                'cuota_total' => $credito_monto,
                'cuota_fechalimite' => $credito_fechalimite,
                'cuota_cancelado' => 0,
                'cuota_saldo' => $credito_monto,
                
            );
            $this->load->model('Cuotum_model');
            $cuota_id = $this->Cuotum_model->add_cuotum($cadcuota);
            /* **********F I N  poner en credito************* */
            $cad = array(
                    'estado_id' => $estado_id,
                );
            $this->Detalle_serv_model->update_detalle_serv($detalleserv_id,$cad);
            
            $res_ids = $this->Detalle_serv_model->get_ids_estado_detalle_serv($servicio_id);
            $cont = 0;
            foreach ($res_ids as $ids)
            {
                if($ids['estado_id'] == $estado_id || $ids['estado_id'] == $estado_terminadoid){
                    $cont++;
                }
            }
            if($cont == count($res_ids)){
                $params = array(
                            'estado_id' => $estado_terminadoid,
                            'servicio_fechafinalizacion' => $credito_fecha,
                            'servicio_horafinalizacion' => $credito_hora,
                );
                $this->load->model('Servicio_model');
                $this->Servicio_model->update_servicio($servicio_id,$params);
            }
            echo json_encode("ok");
            //redirect('servicio/serview/'.$servicio_id);
        }else {
            echo json_encode("faltadatos");
            //redirect('servicio/serview/'.$servicio_id);
        }
        }
    }
    
    /*
     * *************Registra el CREDITO de todos los detalles de servicio en donde sus estados sean TERMIANDOS***********
     * *********************************Y cambia todos los estados a ENTREGADO(estado_id = 7)**********************
     */
    function registrarcreditoTotal($servicio_id)
    {
        $data['sistema'] = $this->sistema;
        if($this->acceso(85)){
                $usuario_id = $this->session_data['usuario_id'];
                $fecha_finalizacion = date("Y-m-d");
                $hora_finalizacion = date("H:i:s");
                $fechahora = date("Y-m-d H:i:s");
                $this->load->model('Servicio_model');
                //recupera a todos los detalles de servicio que su estado sean 6= TERMINADO
                $res_detalle_serv = $this->Detalle_serv_model->get_detalle_serv_all_terminado($servicio_id);
                $estado_id     = 16; //es el estado CREDITO
                $estado_identr = 7; //es el estado ENTREGADO
                $credito_monto = 0;
                foreach ($res_detalle_serv as $det_serv)
                {
                    $credito_monto = $credito_monto + $det_serv['detalleserv_saldo'];
                    $cad = array(
                            'estado_id' => $estado_id,
                    );
                    $this->Detalle_serv_model->update_detalle_serv($det_serv['detalleserv_id'],$cad);
                }
                /* **********INICIO  poner en credito************* */
                //8 = pendiente de Creditos
                $estadocredito_id = 8;
                $una_semana = time() + (7 * 24 * 60 * 60);
                $credito_fechalimite = date('Y-m-d', $una_semana);
                $credito_fecha = date("Y-m-d");
                $credito_hora = date("H:i:s");
                $cadcredito = array(
                    'estado_id' => $estadocredito_id,
                    'compra_id' => 0,
                    'venta_id' => 0,
                    'servicio_id' => $servicio_id,
                    'credito_monto' => $credito_monto,
                    'credito_cuotainicial' => 0,
                    'credito_interesproc' => 0,
                    'credito_interesmonto' => 0,
                    'credito_numpagos' => 1,
                    'credito_fechalimite' => $credito_fechalimite,
                    'credito_fecha' => $credito_fecha,
                    'credito_hora' => $credito_hora,
                    'credito_tipo' => 1,
                );
                $this->load->model('Credito_model');
                $credito_id = $this->Credito_model->add_credito($cadcredito);
               // $usuario_id = $session_data['usuario_id'];   //poner si no se llama arriba!!
                $cadcuota = array(
                    'credito_id' => $credito_id,
                    'usuario_id' => $usuario_id,
                    'estado_id' => $estadocredito_id,
                    'cuota_numcuota' => 1,
                    'cuota_capital' => $credito_monto,
                    'cuota_interes' => 0,
                    'cuota_moradias' => 0,
                    'cuota_multa' => 0,
                    'cuota_subtotal' => $credito_monto,
                    'cuota_descuento' => 0,
                    'cuota_total' => $credito_monto,
                    'cuota_fechalimite' => $credito_fechalimite,
                    'cuota_cancelado' => 0,
                    'cuota_saldo' => $credito_monto,

                );
                $this->load->model('Cuotum_model');
                $cuota_id = $this->Cuotum_model->add_cuotum($cadcuota);
                /* **********F I N  poner en credito************* */
                

                $res_ids = $this->Detalle_serv_model->get_ids_estado_detalle_serv($servicio_id);
                $cont = 0;
                foreach($res_ids as $ids)
                {
                    if($ids['estado_id'] == $estado_id || $ids['estado_id'] == $estado_identr){
                        $cont++;
                    }
                }
                if($cont == count($res_ids)){
                    $params = array(
                                'estado_id' => $estado_identr,
                                'servicio_fechafinalizacion' => $fecha_finalizacion,
                                'servicio_horafinalizacion' => $hora_finalizacion,
                    );
                    $this->Servicio_model->update_servicio($servicio_id,$params);
                    }
                echo json_encode("ok");
                //redirect('servicio/serview/'.$servicio_id);
        }
    }
    /*
     * Funcion que busca todos los detalles de los servicios
     * con una determianda categoria de servico(catserv_id)
     * RECARGA TONER, RECARGA TINTA, IMPRESORA, PORTATIL, PANTALLA.... etc..etc....
     */
    function buscarporcatserv()
    {
        $data['sistema'] = $this->sistema;
        if($this->acceso(69)){
            $data['page_title'] = "Detalle de Servicio";
        $catserv_id = $this->input->post('catserv_id');
        if(isset($catserv_id))
        {
            $params['limit'] = RECORDS_PER_PAGE; 
            $params['offset'] = ($this->input->get('per_page')) ? $this->input->get('per_page') : 0;

            $config = $this->config->item('pagination');
            $config['base_url'] = site_url('detalle_serv/buscarporcatserv?');
            $config['total_rows'] = $this->Detalle_serv_model->get_all_detalle_serv_count_cservicio($catserv_id);
            $this->pagination->initialize($config);

            $data['detalle_serv'] = $this->Detalle_serv_model->get_detalle_serv_all_for_cservicio($catserv_id, $params);
        
            $data['_view'] = 'detalle_serv/buscarporcatserv';
            $this->load->view('layouts/main',$data);
            
        }else{
            redirect('servicio/index');
        }
        }
    }
    /*
     * Funcion que busca todos las subcategorias de los servicios
     */
    function buscarporsubcatserv()
    {
        $data['sistema'] = $this->sistema;
        if($this->acceso(69)){
            $data['page_title'] = "Detalle de Servicio";
        $parametro = $this->input->post('buscarsubcat');
        if(isset($parametro))
        {
            $params['limit'] = RECORDS_PER_PAGE; 
            $params['offset'] = ($this->input->get('per_page')) ? $this->input->get('per_page') : 0;

            $config = $this->config->item('pagination');
            $config['base_url'] = site_url('detalle_serv/buscarporcatserv?');
            $config['total_rows'] = $this->Detalle_serv_model->get_all_subcatserv_count($parametro);
            $this->pagination->initialize($config);

            $data['detalle_serv'] = $this->Detalle_serv_model->get_all_subcatserv($parametro, $params);
        
            $data['_view'] = 'detalle_serv/buscarporcatserv';
            $this->load->view('layouts/main',$data);
            
        }else{
            redirect('servicio/index');
        }
        }
    }
    
    /*
     * Funcion que busca a los clientes con un determinado parametro
     */
    function buscarcliente()
    {
        $data['sistema'] = $this->sistema;
        if($this->acceso(75)){
            $data['page_title'] = "Detalle de Servicio";
        $parametro = $this->input->post('buscarcliente');
        if(isset($parametro))
        {
            $data['all_cliente'] = $this->Detalle_serv_model->get_all_cliente($parametro);
        
            $data['_view'] = 'detalle_serv/buscarcliente';
            $this->load->view('layouts/main',$data);
            
        }else{
            redirect('servicio/index');
        }
        }
    }
    
    /*
     * Funcion que busca a un cliente atravez de su C.I.
     */
    function kardexserviciocliente($cliente_id)
    {
        $data['sistema'] = $this->sistema;
        if($this->acceso(75)){
            $data['page_title'] = "Kardex Cliente";
        //$parametro = $this->input->post('buscarcliente');
        if(isset($cliente_id))
        {
            $params['limit'] = RECORDS_PER_PAGE; 
            $params['offset'] = ($this->input->get('per_page')) ? $this->input->get('per_page') : 0;

            $config = $this->config->item('pagination');
            $config['base_url'] = site_url('detalle_serv/kardexserviciocliente?');
            $config['total_rows'] = $this->Detalle_serv_model->get_kardexclienteservicio_count($cliente_id);
            $this->pagination->initialize($config);

            $data['all_cliente'] = $this->Detalle_serv_model->get_kardexclienteservicio($cliente_id, $params);
            $cliente = $data['all_cliente'][0]['cliente_nombre'];
            $data['cliente'] = $cliente;
        
            $data['_view'] = 'detalle_serv/kardexserviciocliente';
            $this->load->view('layouts/main',$data);
            
        }else{
            redirect('servicio/index');
        }
        }
    }
    
    /*
    * buscar detalles de servicios
    */
    function buscardetserviciosfecha()
    {
        $data['sistema'] = $this->sistema;
        if($this->acceso(69)){  

        if ($this->input->is_ajax_request()) {
            
            $filtro = $this->input->post('filtro');   
            
            if ($filtro!=""){
            $datos = $this->Detalle_serv_model->get_busqueda_detservicio_parametro($filtro);
            //$datos = $this->Inventario_model->get_inventario_bloque();
            echo json_encode($datos);
            }
            else echo json_encode(null);
        }
        else
        {                 
            show_404();
        }
        }
    }
    /* ***********Imprime comprobante de pago de un detalle de servicio, tamaño carta********** */
    function compdetalle_pago($detalleserv_id)
    {
        $data['sistema'] = $this->sistema;
        if($this->acceso(69)){
            $data['page_title'] = "Comprobante de Servicio";
	    $data['detalle_serv'] = $this->Detalle_serv_model->get_detalle_serv($detalleserv_id);
            
            $this->load->model('Servicio_model');
            $data['servicio'] = $this->Servicio_model->get_servicio($data['detalle_serv']['servicio_id']);
            
            $empresa_id = 1;
            $this->load->model('Empresa_model');
	    $data['empresa'] = $this->Empresa_model->get_empresa($empresa_id);
            
            $this->load->model('Cliente_model');
	    $data['cliente'] = $this->Cliente_model->get_cliente($data['servicio']['cliente_id']);
            
            $this->load->model('Usuario_model');
	    $data['usuario'] = $this->Usuario_model->get_usuario($data['detalle_serv']['usuariopsaldo_id']);
            
            $this->load->model('Dosificacion_model');
	    $data['all_dosificacion'] = $this->Dosificacion_model->get_all_dosificacion_servicio();
            
            $data['_view'] = 'detalle_serv/compdetalle_pago';
            $this->load->view('layouts/main',$data);
        }
    }
    /* ***********Imprime comprobante de pago de un detalle de servicio, tamaño boucher********** */
    function compdetalle_pago_boucher($detalleserv_id)
    {
        $data['sistema'] = $this->sistema;
        if($this->acceso(69)){
            $data['page_title'] = "Comprobante de Servicio";
	    $data['detalle_serv'] = $this->Detalle_serv_model->get_detalle_serv($detalleserv_id);
            
            $this->load->model('Servicio_model');
            $data['servicio'] = $this->Servicio_model->get_servicio($data['detalle_serv']['servicio_id']);
            
            $empresa_id = 1;
            $this->load->model('Empresa_model');
	    $data['empresa'] = $this->Empresa_model->get_empresa($empresa_id);
            
            $this->load->model('Cliente_model');
	    $data['cliente'] = $this->Cliente_model->get_cliente($data['servicio']['cliente_id']);
            
            $this->load->model('Usuario_model');
	    $data['usuario'] = $this->Usuario_model->get_usuario($data['detalle_serv']['usuariopsaldo_id']);
            
            $this->load->model('Dosificacion_model');
	    $data['all_dosificacion'] = $this->Dosificacion_model->get_all_dosificacion_servicio();
            
            $data['_view'] = 'detalle_serv/compdetalle_pago_boucher';
            $this->load->view('layouts/main',$data);
        }
    }
    
    /*
     * ************* recupera el kardex por medio de un codigo ***********
     */
    function get_kardexdetalle()
    {
        $data['sistema'] = $this->sistema;
        if ($this->input->is_ajax_request()) {
            $codigo = $this->input->post('codigo');
            if ($codigo!=""){
                $this->load->model('Detalle_serv_model');
                $datos = $this->Detalle_serv_model->buscar_detalle_serv_all_codigo($codigo);
                echo json_encode($datos);
            }else echo json_encode("faltadatos");
        }else{                 
            show_404();
        }
    }
    
    /*
     * Funcion Que busca el detalle de un producto, atravez de su codigo
     */
    function buscardetalleservk()
    {
        $data['sistema'] = $this->sistema;
        if($this->acceso(74)){
            $data['page_title'] = "Detalle de Servicio";
	    if(isset($_POST) && count($_POST) > 0)     
            {
                $codigo = $this->input->post('codigo');
                
                $res = $this->Detalle_serv_model->buscar_detalle_serv_codigo($codigo);
                if(isset($res) && !empty($res))
                {
                    redirect('detalle_serv/kardex_detallek/'.$codigo);
                }else{
                    redirect('servicio/index/no');
                    //redirect('servicio/index/'.$servicio_id."/no");
                }
            }else{
                redirect('servicio/index/no');
                /*$data['_view'] = 'servicio/serviciocreado/'.$servicio_id;
                $this->load->view('layouts/main',$data);*/
            }
        }
    }
    
    function kardex_detallek($codigo)
    {
        $data['sistema'] = $this->sistema;
        if($this->acceso(69)){
            $data['page_title'] = "Detalle de Servicio";
            $data['codigo'] = $codigo;
            //$rescodigo = str_replace("%20", " ", $codigo);
            $data['detalle_serv'] = $this->Detalle_serv_model->buscar_detalle_serv_codigo($codigo);

            $this->load->model('Servicio_model');
            //$data['servicio'] = $this->Servicio_model->get_servicio($servicio_id);

            $this->load->model('Categoria_servicio_model');
            $data['all_categoria_servicio'] = $this->Categoria_servicio_model->get_all_categoria_servicio_id1();
            if(isset($data['detalle_serv'][0]['catserv_id'])){
                $data['categoria_servicio'] = $this->Categoria_servicio_model->get_categoria_servicio($data['detalle_serv'][0]['catserv_id']);
            }

            $this->load->model('Subcategoria_servicio_model');
            $data['all_subcategoria_servicio'] = $this->Subcategoria_servicio_model->get_all_subcategoria_servicio_id1();

            $this->load->model('Usuario_model');
            $data['all_responsable'] = $this->Usuario_model->get_all_usuario_tecnicoresponsable_ok();

            $this->load->model('Categoria_trabajo_model');
            $data['all_categoria_trabajo'] = $this->Categoria_trabajo_model->get_all_categoria_trabajo_id1();

            $this->load->model('Tiempo_uso_model');
            $data['all_tiempo_uso'] = $this->Tiempo_uso_model->get_all_tiempo_uso_id1();

            $this->load->model('Procedencia_model');
            $data['all_procedencia'] = $this->Procedencia_model->get_all_procedencia_id1();

            $this->load->model('Parametro_model');
            $data['parametro'] = $this->Parametro_model->get_parametro_servicio();

            $data['_view'] = 'detalle_serv/kardex_detallek';
            $this->load->view('layouts/main',$data);
        }
    }
    /*
     *  *********************Crea un nuevo Servicio con un detalle seleccionado por kardex **************
     */
    function nuevodetallek()
    {
        $data['sistema'] = $this->sistema;
        
        if($this->acceso(69)){
            
            $this->load->model('Servicio_model');
            $this->load->library('form_validation');
	    $this->form_validation->set_rules('detalleserv_descripcion','Detalle Servicio Descripcion','required');
	    //$this->form_validation->set_rules('detalleserv_codigo','Detalle Servicio Codigo','required');
	    $this->form_validation->set_rules('detalleserv_falla','Detalle Servicio Falla','required');
            $codigo = $this->input->post('codigo');
	    if($this->form_validation->run())     
            {
                /* ************ INICIO CREAR NUEVO SERVICIO ************** */
                $estado_id = 5; // este valor (PENDIENTE) esta definido en la tabla Estado
                $usuario_id = $this->session_data['usuario_id'];
                $tiposerv_id = 1; //este valor (Servicio Normal) esta definido en la tabla tipo_servicio
                $cliente_id = $this->input->post('cliente_id');

                date_default_timezone_set('America/La_Paz');
                $fecha_res = date('Y-m-d');
                $hora_res = date('H:i:s');
                $params = array(
                                'estado_id' => $estado_id,
                                'usuario_id' => $usuario_id,
                                'tiposerv_id' => $tiposerv_id,
                                'cliente_id' => $cliente_id,
                                'servicio_fecharecepcion' => $fecha_res,
                                'servicio_horarecepcion' => $hora_res,
                );

                $servicio_id = $this->Servicio_model->add_servicio($params);
                /* ************ F I N  CREAR NUEVO SERVICIO ************** */
                //$fecha_entrega = $this->Detalle_serv_model->normalize_date($this->input->post('detalleserv_fechaentrega'));
                $fecha_entrega = $this->input->post('detalleserv_fechaentrega');
                $hora_entrega = date("H:i:s", strtotime($this->input->post('detalleserv_horaentrega')));
                //
                //$estado_id = 5;
                //$usuario_id = $session_data['usuario_id'];
                $catserv_id = $this->input->post('catserv_id');
                $subcatserv_id = $this->input->post('subcatserv_id');
                
                $inputotal = $this->input->post('detalleserv_total'); 
                $inputacuenta = $this->input->post('detalleserv_acuenta');
                $inputsaldo = $this->input->post('detalleserv_saldo');
                $esreclamo = $this->input->post('detalleserv_reclamo');
                if(isset($esreclamo)){
                    $esreclamo = "si";
                }else{
                    $esreclamo = "no";
                }
                $params = array(
                                    'estado_id' => $estado_id,
                                    'responsable_id' => $this->input->post('responsable_id'),
                                    'usuario_id' => $usuario_id,
                                    'servicio_id' => $servicio_id,
                                    'catserv_id' => $catserv_id,
                                    'subcatserv_id' => $subcatserv_id,
                                    'cattrab_id' => $this->input->post('cattrab_id'),
                                    'tiempouso_id' => $this->input->post('tiempouso_id'),
                                    'procedencia_id' => $this->input->post('procedencia_id'),
                                    'detalleserv_codigo' => $this->input->post('detalleserv_codigo'),
                                    'detalleserv_descripcion' => $this->input->post('detalleserv_descripcion'),
                                    'detalleserv_reclamo' => $esreclamo,
                                    'detalleserv_falla' => $this->input->post('detalleserv_falla'),
                                    'detalleserv_diagnostico' => $this->input->post('detalleserv_diagnostico'),
                                    'detalleserv_solucion' => $this->input->post('detalleserv_solucion'),
                                    'detalleserv_pesoentrada' => $this->input->post('detalleserv_pesoentrada'),
                                    'detalleserv_glosa' => $this->input->post('detalleserv_glosa'),
                                    'detalleserv_total' => $inputotal,
                                    'detalleserv_acuenta' => $inputacuenta,
                                    'detalleserv_saldo' => $inputsaldo,
//                                    'detalleserv_fechaterminado' => $this->input->post('detalleserv_fechaterminado'),
//                                    'detalleserv_horaterminado' => $this->input->post('detalleserv_horaterminado'),
                                    'detalleserv_fechaentrega' => $fecha_entrega,
                                    'detalleserv_horaentrega' => $hora_entrega,
                                    'detalleserv_insumo' => $this->input->post('detalleserv_insumo'),
                );
                $detalle_serv_id = $this->Detalle_serv_model->add_detalle_serv($params);

                $facuenta = date('Y-m-d H:i:s');
                if($inputacuenta >0)
                {
                    $detparam = array(
                                'detalleserv_fpagoacuenta' => $facuenta,
                                'usuariopacuenta_id' => $usuario_id,
                    );
                    $this->Detalle_serv_model->update_detalle_serv($detalle_serv_id, $detparam);
                }
                
                $data['resultado'] = $this->Detalle_serv_model->sumarmontos($servicio_id);
                $total = $data['resultado']['total'];
                $acuenta = $data['resultado']['acuenta'];
                $saldo = $data['resultado']['saldo'];
                $sumparams = array(
                                    'servicio_total' => $total,
                                    'servicio_acuenta' => $acuenta,
                                    'servicio_saldo' => $saldo,
                );

                $this->load->model('Servicio_model');
                $this->Servicio_model->update_servicio($servicio_id,$sumparams);            
                
                $data['servicio'] = $this->Servicio_model->get_servicio($servicio_id);
        
                redirect('servicio/serviciocreado/'.$servicio_id);
            }else{
                redirect('detalle_serv/kardex_detallek/'.$codigo);
            }
        }
    }
    /*
     *  *********************Crea un nuevo Servicio con un detalle seleccionado por kardex **************
     */
    function nuevodetallehistorialc($detalleserv_id)
    {
        $data['sistema'] = $this->sistema;
        
        if($this->acceso(69)){
            
            $this->load->model('Servicio_model');
            $this->load->library('form_validation');
	    $this->form_validation->set_rules('detalleserv_descripcion','Detalle Servicio Descripcion','required');
	    //$this->form_validation->set_rules('detalleserv_codigo','Detalle Servicio Codigo','required');
	    $this->form_validation->set_rules('detalleserv_falla','Detalle Servicio Falla','required');
            $cliente_id = $this->input->post('cliente_id');
	    if($this->form_validation->run())     
            {
                /* ************ INICIO CREAR NUEVO SERVICIO ************** */
                $estado_id = 5; // este valor (PENDIENTE) esta definido en la tabla Estado
                $usuario_id = $this->session_data['usuario_id'];
                $tiposerv_id = 1; //este valor (Servicio Normal) esta definido en la tabla tipo_servicio
                

                date_default_timezone_set('America/La_Paz');
                $fecha_res = date('Y-m-d');
                $hora_res = date('H:i:s');
                $params = array(
                                'estado_id' => $estado_id,
                                'usuario_id' => $usuario_id,
                                'tiposerv_id' => $tiposerv_id,
                                'cliente_id' => $cliente_id,
                                'servicio_fecharecepcion' => $fecha_res,
                                'servicio_horarecepcion' => $hora_res,
                );

                $servicio_id = $this->Servicio_model->add_servicio($params);
                /* ************ F I N  CREAR NUEVO SERVICIO ************** */
                //$fecha_entrega = $this->Detalle_serv_model->normalize_date($this->input->post('detalleserv_fechaentrega'));
                $fecha_entrega = $this->input->post('detalleserv_fechaentrega');
                $hora_entrega = date("H:i:s", strtotime($this->input->post('detalleserv_horaentrega')));
                //
                //$estado_id = 5;
                //$usuario_id = $session_data['usuario_id'];
                $catserv_id = $this->input->post('catserv_id');
                $subcatserv_id = $this->input->post('subcatserv_id');
                
                $inputotal = $this->input->post('detalleserv_total'); 
                $inputacuenta = $this->input->post('detalleserv_acuenta');
                $inputsaldo = $this->input->post('detalleserv_saldo');
                $esreclamo = $this->input->post('detalleserv_reclamo');
                if(isset($esreclamo)){
                    $esreclamo = "si";
                }else{
                    $esreclamo = "no";
                }
                $params = array(
                                    'estado_id' => $estado_id,
                                    'responsable_id' => $this->input->post('responsable_id'),
                                    'usuario_id' => $usuario_id,
                                    'servicio_id' => $servicio_id,
                                    'catserv_id' => $catserv_id,
                                    'subcatserv_id' => $subcatserv_id,
                                    'cattrab_id' => $this->input->post('cattrab_id'),
                                    'tiempouso_id' => $this->input->post('tiempouso_id'),
                                    'procedencia_id' => $this->input->post('procedencia_id'),
                                    'detalleserv_codigo' => $this->input->post('detalleserv_codigo'),
                                    'detalleserv_descripcion' => $this->input->post('detalleserv_descripcion'),
                                    'detalleserv_reclamo' => $esreclamo,
                                    'detalleserv_falla' => $this->input->post('detalleserv_falla'),
                                    'detalleserv_diagnostico' => $this->input->post('detalleserv_diagnostico'),
                                    'detalleserv_solucion' => $this->input->post('detalleserv_solucion'),
                                    'detalleserv_pesoentrada' => $this->input->post('detalleserv_pesoentrada'),
                                    'detalleserv_glosa' => $this->input->post('detalleserv_glosa'),
                                    'detalleserv_total' => $inputotal,
                                    'detalleserv_acuenta' => $inputacuenta,
                                    'detalleserv_saldo' => $inputsaldo,
//                                    'detalleserv_fechaterminado' => $this->input->post('detalleserv_fechaterminado'),
//                                    'detalleserv_horaterminado' => $this->input->post('detalleserv_horaterminado'),
                                    'detalleserv_fechaentrega' => $fecha_entrega,
                                    'detalleserv_horaentrega' => $hora_entrega,
                                    'detalleserv_insumo' => $this->input->post('detalleserv_insumo'),
                );
                $detalle_serv_id = $this->Detalle_serv_model->add_detalle_serv($params);

                $facuenta = date('Y-m-d H:i:s');
                if($inputacuenta >0)
                {
                    $detparam = array(
                                'detalleserv_fpagoacuenta' => $facuenta,
                                'usuariopacuenta_id' => $usuario_id,
                    );
                    $this->Detalle_serv_model->update_detalle_serv($detalle_serv_id, $detparam);
                }
                
                $data['resultado'] = $this->Detalle_serv_model->sumarmontos($servicio_id);
                $total = $data['resultado']['total'];
                $acuenta = $data['resultado']['acuenta'];
                $saldo = $data['resultado']['saldo'];
                $sumparams = array(
                                    'servicio_total' => $total,
                                    'servicio_acuenta' => $acuenta,
                                    'servicio_saldo' => $saldo,
                );

                $this->load->model('Servicio_model');
                $this->Servicio_model->update_servicio($servicio_id,$sumparams);            
                
                $data['servicio'] = $this->Servicio_model->get_servicio($servicio_id);
                $esparafin = $this->input->post('parafinalizar'.$detalleserv_id);
                if($esparafin> 0){
                    
                    $fecha_reg = date('Y-m-d');
                    $hora_reg = date('H:i:s');
                    $minseg = date('is');
                    //$servicio_id = $this->input->post('servicio_id');

                    $minutosegundo = date('is');

                    $this->load->model('Dosificacion_model');
                    $dosificacion   = $this->Dosificacion_model->get_dosificacion_activa();
                    $autorizacion   = $dosificacion[0]['dosificacion_autorizacion'];
                    $llave          = $dosificacion[0]['dosificacion_llave'];
                    $codseguimiento = $this->codigo_control($llave, $autorizacion, $servicio_id, $servicio_id,$fecha_reg, $minseg);

                    $params = array(
                        'servicio_fecharecepcion' => $fecha_reg,
                        'servicio_horarecepcion' => $hora_reg,
                        'servicio_codseguimiento' => $codseguimiento,
                    );
                    $this->Servicio_model->update_servicio($servicio_id,$params);
                    //echo "<script>window.opener.location.reload(); window.close();</script>";exit;
                    echo "<script>window.opener.location.reload(); window.location='".base_url('servicio/boletacomprobanteserv/'.$servicio_id)."';</script>";exit;
                    //redirect('servicio/boletacomprobanteserv/'.$servicio_id);
                }else{
                    redirect('servicio/serviciocreado/'.$servicio_id);
                }
                
            }else{
                redirect('detalle_serv/historial_cliente/'.$cliente_id);
            }
        }
    }
    /*
     * ************* recupera el kardex por medio de un codigo ***********
     */
    function get_historial_cliente()
    {
        $data['sistema'] = $this->sistema;
        if ($this->input->is_ajax_request()) {
            $cliente_id = $this->input->post('cliente_id');
            if ($cliente_id!=""){
                $this->load->model('Detalle_serv_model');
                $datos = $this->Detalle_serv_model->buscar_detalle_serv_cliente($cliente_id);
                echo json_encode($datos);
            }else echo json_encode("faltadatos");
        }else{                 
            show_404();
        }
    }
    /* *** Historial de cliente **** */
    function historial_cliente($cliente_id)
    {
        $data['sistema'] = $this->sistema;
        if($this->acceso(75)){
            $data['page_title'] = "Historial Cliente";
            $data['cliente_id'] = $cliente_id;
            
            $this->load->model('Cliente_model');
            $data['cliente'] = $this->Cliente_model->get_cliente($cliente_id);

            $this->load->model('Servicio_model');
            //$data['servicio'] = $this->Servicio_model->get_servicio($servicio_id);

            $this->load->model('Categoria_servicio_model');
            $data['all_categoria_servicio'] = $this->Categoria_servicio_model->get_all_categoria_servicio_id1();
            if(isset($data['cliente']['cliente_id'])){
                $this->load->model('Subcategoria_servicio_model');
                $data['all_subcategoria_servicio'] = $this->Subcategoria_servicio_model->get_all_subcategoria_servicio_id1();

                $this->load->model('Usuario_model');
                $data['all_responsable'] = $this->Usuario_model->get_all_usuario_tecnicoresponsable_ok();

                $this->load->model('Categoria_trabajo_model');
                $data['all_categoria_trabajo'] = $this->Categoria_trabajo_model->get_all_categoria_trabajo_id1();

                $this->load->model('Tiempo_uso_model');
                $data['all_tiempo_uso'] = $this->Tiempo_uso_model->get_all_tiempo_uso_id1();

                $this->load->model('Procedencia_model');
                $data['all_procedencia'] = $this->Procedencia_model->get_all_procedencia_id1();

                $this->load->model('Parametro_model');
                $data['parametro'] = $this->Parametro_model->get_parametro_servicio();

                $data['_view'] = 'detalle_serv/historial_cliente';
                $this->load->view('layouts/main',$data);
            }else{
                
            }
        }
    }
    function codigo_control($dosificacion_llave, $dosificacion_autorizacion, $dosificacion_numfact, $nit,$fecha_trans, $monto)
    {

        //include 'ControlCode.php';

        $code = $this->controlcode->generate($dosificacion_autorizacion,//Numero de autorizacion
                                                   $dosificacion_numfact,//Numero de factura
                                                   $nit,//Número de Identificación Tributaria o Carnet de Identidad
                                                   str_replace('-','',$fecha_trans),//fecha de transaccion de la forma AAAAMMDD
                                                   $monto,//Monto de la transacción
                                                   $dosificacion_llave//Llave de dosificación
                        );        
         return str_replace('-','',$code);
    }
    /*
     *  *********************Modifica el detalle de un servicio, no modifica el codigo*******************************
     */
    function modificareldetalle($servicio_id, $detalleserv_id, $b = null)
    {
        $data['sistema'] = $this->sistema;
        if($this->acceso(86)){
            $data['page_title'] = "Detalle de Servicio";
            $this->load->model('Servicio_model');
            $data['servicio'] = $this->Servicio_model->get_servicio($servicio_id);
            $data['b'] = $b;
        if(isset($_POST) && count($_POST) > 0)
        {
            $this->load->library('form_validation');

	    $this->form_validation->set_rules('detalleserv_descripcion','Detalle Servicio Descripcion','required');
	    //$this->form_validation->set_rules('detalleserv_codigo','Detalle Servicio Codigo','required');
	    $this->form_validation->set_rules('detalleserv_falla','Detalle Servicio Falla','required');
            if($b == "s"){
                $esunico = "/index/".$servicio_id."/s";
            }else{ $esunico = ""; }
	    if($this->form_validation->run())     
            {
                $estado_id = $this->input->post('estado_id');
                //$fecha_entrega = $this->Detalle_serv_model->normalize_date($this->input->post('detalleserv_fechaentrega'));
                $hora_entrega = date("H:i:s", strtotime($this->input->post('detalleserv_horaentrega')));
            
                $usuario_id = $this->session_data['usuario_id'];
                $inputacuenta = $this->input->post('detalleserv_acuenta');
                $inputsaldo = $this->input->post('detalleserv_saldo');
                $catserv_id = $this->input->post('catserv_id');
                $subcatserv_id = $this->input->post('subcatserv_id');
                $esreclamo = $this->input->post('detalleserv_reclamo');
                if(isset($esreclamo)){
                    $esreclamo = "si";
                }else{
                    $esreclamo = "no";
                }
                $params = array(
                    'estado_id' => $estado_id,
                    'responsable_id' => $this->input->post('responsable_id'),
                    'usuario_id' => $usuario_id,
                    //'servicio_id' => $servicio_id,
                    'catserv_id' => $catserv_id,
                    'subcatserv_id' => $subcatserv_id,
                    'cattrab_id' => $this->input->post('cattrab_id'),
                    'tiempouso_id' => $this->input->post('tiempouso_id'),
                    'procedencia_id' => $this->input->post('procedencia_id'),
                    //'detalleserv_codigo' => $this->input->post('detalleserv_codigo'),
                    'detalleserv_descripcion' => $this->input->post('detalleserv_descripcion'),
                    //'detalleserv_reclamo' => $this->input->post('detalleserv_reclamo'),
                    'detalleserv_reclamo' => $esreclamo,
                    'detalleserv_falla' => $this->input->post('detalleserv_falla'),
                    'detalleserv_diagnostico' => $this->input->post('detalleserv_diagnostico'),
                    'detalleserv_solucion' => $this->input->post('detalleserv_solucion'),
                    'detalleserv_pesoentrada' => $this->input->post('detalleserv_pesoentrada'),
                    'detalleserv_glosa' => $this->input->post('detalleserv_glosa'),
                    'detalleserv_total' => $this->input->post('detalleserv_total'),
                    'detalleserv_acuenta' => $inputacuenta,
                    'detalleserv_saldo' => $inputsaldo,
//                                    'detalleserv_fechaterminado' => $this->input->post('detalleserv_fechaterminado'),
//                                    'detalleserv_horaterminado' => $this->input->post('detalleserv_horaterminado'),
                    'detalleserv_fechaentrega' => $this->input->post('detalleserv_fechaentrega'),
                    'detalleserv_horaentrega' => $hora_entrega,
                    'detalleserv_insumo' => $this->input->post('detalleserv_insumo'),
                );

                $this->Detalle_serv_model->update_detalle_serv($detalleserv_id,$params);
                
                $this->load->model('Servicio_model');
                
                $res_ids = $this->Detalle_serv_model->get_ids_estado_detalle_serv($servicio_id);
                // 4 es el estado de ANULADO
                if($estado_id == 4)
                {
                    $this->load->model('Categoria_insumo_model');
                    $this->load->model('Detalle_venta_model');
                    $insumos_usados = $this->Categoria_insumo_model->get_all_insumos_usados($detalleserv_id);
                    foreach($insumos_usados as $insumo){
                        $detalleventa = array(
                            'detalleven_cantidad' => 0,
                            'detalleven_unidad' => 0,
                            'detalleven_costo' => 0,
                            'detalleven_precio' => 0,
                            'detalleven_descuento' => 0,
                            'detalleven_total' => 0,
                            'detalleven_preferencia' => "-",
                            'detalleven_caracteristicas' => "",
                            'detalleven_comision' => 0,
                        );
                        $this->Detalle_venta_model->update_detalle_venta($insumo['detalleven_id'], $detalleventa);
                    }
                    
                    $detparams = array(
                                    'estado_id' => $estado_id,
                    );
                    $this->Detalle_serv_model->update_detalle_serv($detalleserv_id, $detparams);
                    
                    $cont = 0;
                    foreach($res_ids as $ids)
                    {
                        if($ids['estado_id'] == $estado_id){
                            $cont++;
                        }
                    }
                    if($cont == count($res_ids)){
                        $params = array(
                                    'estado_id' => $estado_id,
                        );
                        $this->Servicio_model->update_servicio($servicio_id,$params);
                    }

                    $detparams = array(
                                    'detalleserv_total' => 0,
                                    'detalleserv_acuenta' => 0,
                                    'detalleserv_saldo' => 0,
                    );

                    $this->Detalle_serv_model->anular_detalle_serv($detalleserv_id, $detparams);

                    $data['resultado'] = $this->Detalle_serv_model->sumarmontos($servicio_id);
                    $total = $data['resultado']['total'];
                    $acuenta = $data['resultado']['acuenta'];
                    $saldo = $data['resultado']['saldo'];
                    $sumparams = array(
                                        'servicio_total' => $total,
                                        'servicio_acuenta' => $acuenta,
                                        'servicio_saldo' => $saldo,
                    );

                    $this->Servicio_model->update_servicio($servicio_id,$sumparams);
                    redirect('servicio'.$esunico);
                    
                }elseif($estado_id == 7){ //el 7 representa a ENTREGADO
                    $estado_credid = 16;
                    $fecha_finalizacion = date('Y-m-d');
                    $hora_finalizacion = date('H:i:s');
                    $fechahora = date('Y-m-d H:i:s');
                    if($inputacuenta > 0)
                    {
                        $detparams = array(
                                'detalleserv_fpagoacuenta' => $fechahora,
                                'usuariopacuenta_id' => $usuario_id,
                        );
                        $this->Detalle_serv_model->update_detalle_serv($detalleserv_id, $detparams);

                    }
                    $detparams = array(
                            'estado_id' => $estado_id,
                            'detalleserv_fechaentregado' => $fecha_finalizacion,
                            'detalleserv_horaentregado' => $hora_finalizacion,
                    );
                    $this->Detalle_serv_model->update_detalle_serv($detalleserv_id, $detparams);
                    
                    if($inputsaldo > 0)
                    {
                        $salparams = array(
                                'detalleserv_fpagosaldo' => $fechahora,
                                'usuariopsaldo_id' => $usuario_id,
                        );
                        $this->Detalle_serv_model->update_detalle_serv($detalleserv_id, $salparams);
                    }
                    $cont = 0;
                    foreach($res_ids as $ids)
                    {
                        if($ids['estado_id'] == $estado_id || $ids['estado_id'] == $estado_credid){
                            $cont++;
                        }
                    }
                    if($cont == count($res_ids)){
                        $params = array(
                                    'estado_id' => $estado_id,
                                    'servicio_fechafinalizacion' => $fecha_finalizacion,
                                    'servicio_horafinalizacion' => $hora_finalizacion,
                        );
                        $this->Servicio_model->update_servicio($servicio_id,$params);
                    }
                    $data['resultado'] = $this->Detalle_serv_model->sumarmontos($servicio_id);
                    
                    $total = $data['resultado']['total'];
                    $acuenta = $data['resultado']['acuenta'];
                    $saldo = $data['resultado']['saldo'];
                    $sumparams = array(
                                    'servicio_total' => $total,
                                    'servicio_acuenta' => $acuenta,
                                    'servicio_saldo' => $saldo,
                    );

                    $this->Servicio_model->update_servicio($servicio_id,$sumparams);
                    
                    redirect('servicio'.$esunico);
                    
                }elseif($estado_id == 6 || $estado_id == 5)
                { //5 --> PENDIENTE; 6-->TERMINADO
                    $detparams = array(
                                    'estado_id' => $estado_id,
                    );
                    $this->Detalle_serv_model->update_detalle_serv($detalleserv_id, $detparams);
                    
                    $res_ids = $this->Detalle_serv_model->get_ids_estado_detalle_serv($servicio_id);
                    $cont = 0;
                    foreach($res_ids as $ids)
                    {
                        if($ids['estado_id'] == $estado_id){
                            $cont++;
                        }
                    }
                    if($cont == count($res_ids)){
                        $params = array(
                                    'estado_id' => $estado_id,
                        );
                        
                        $this->Servicio_model->update_servicio($servicio_id,$params);
                    }
                    if($estado_id == 6 ){
                        $fecha_terminado = date('Y-m-d');
                        $hora_terminado = date('H:i:s');
                        $paramsdet = array(
                                    'detalleserv_fechaterminado' => $fecha_terminado,
                                    'detalleserv_horaterminado' => $hora_terminado,
                        );
                        $this->Detalle_serv_model->update_detalle_serv($detalleserv_id,$paramsdet);
                    }
                    $data['resultado'] = $this->Detalle_serv_model->sumarmontos($servicio_id);
                    $total = $data['resultado']['total'];
                    $acuenta = $data['resultado']['acuenta'];
                    $saldo = $data['resultado']['saldo'];
                    $sumparams = array(
                                    'servicio_total' => $total,
                                    'servicio_acuenta' => $acuenta,
                                    'servicio_saldo' => $saldo,
                    );

                    $this->Servicio_model->update_servicio($servicio_id,$sumparams);
                    redirect('servicio'.$esunico);
                }elseif($estado_id == 16){
                    //este estado es CREDITO
        $estado_terminadoid = 7; // estado ENTREGADO
        $credito_monto = $inputsaldo;
        
            /* **********INICIO  poner en credito************* */
            //8 = pendiente de Creditos
            $estadocredito_id = 8;
            $una_semana = time() + (7 * 24 * 60 * 60);
            $credito_fechalimite = date('Y-m-d', $una_semana);
            $credito_fecha = date("Y-m-d");
            $credito_hora = date("H:i:s");
            $cadcredito = array(
                'estado_id' => $estadocredito_id,
                'compra_id' => 0,
                'venta_id' => 0,
                'servicio_id' => $servicio_id,
                'credito_monto' => $credito_monto,
                'credito_cuotainicial' => 0,
                'credito_interesproc' => 0,
                'credito_interesmonto' => 0,
                'credito_numpagos' => 1,
                'credito_fechalimite' => $credito_fechalimite,
                'credito_fecha' => $credito_fecha,
                'credito_hora' => $credito_hora,
                'credito_tipo' => 1,
            );
            $this->load->model('Credito_model');
            $credito_id = $this->Credito_model->add_credito($cadcredito);
            $usuario_id = $this->session_data['usuario_id'];
            $cadcuota = array(
                'credito_id' => $credito_id,
                'usuario_id' => $usuario_id,
                'estado_id' => $estadocredito_id,
                'cuota_numcuota' => 1,
                'cuota_capital' => $credito_monto,
                'cuota_interes' => 0,
                'cuota_moradias' => 0,
                'cuota_multa' => 0,
                'cuota_subtotal' => $credito_monto,
                'cuota_descuento' => 0,
                'cuota_total' => $credito_monto,
                'cuota_fechalimite' => $credito_fechalimite,
                'cuota_cancelado' => 0,
                'cuota_saldo' => $credito_monto,
                
            );
            $this->load->model('Cuotum_model');
            $cuota_id = $this->Cuotum_model->add_cuotum($cadcuota);
            /* **********F I N  poner en credito************* */
            $cad = array(
                    'estado_id' => $estado_id,
                );
            $this->Detalle_serv_model->update_detalle_serv($detalleserv_id,$cad);
            
            $res_ids = $this->Detalle_serv_model->get_ids_estado_detalle_serv($servicio_id);
            $cont = 0;
            foreach ($res_ids as $ids)
            {
                if($ids['estado_id'] == $estado_id || $ids['estado_id'] == $estado_terminadoid){
                    $cont++;
                }
            }
            if($cont == count($res_ids)){
                $params = array(
                            'estado_id' => $estado_terminadoid,
                );
                $this->load->model('Servicio_model');
                $this->Servicio_model->update_servicio($servicio_id,$params);
            }
             redirect('servicio'.$esunico);
            }elseif($estado_id == 28){
                $detparams = array(
                                'estado_id' => $estado_id,
                );
                $this->Detalle_serv_model->update_detalle_serv($detalleserv_id, $detparams);

                $cont = 0;
                foreach($res_ids as $ids)
                {
                    if($ids['estado_id'] == $estado_id){
                        $cont++;
                    }
                }
                if($cont == count($res_ids)){
                    $params = array(
                                'estado_id' => $estado_id,
                    );
                    $this->Servicio_model->update_servicio($servicio_id,$params);
                }
                redirect('servicio'.$esunico);
            }
            redirect('servicio'.$esunico);
            }
            else
            {
                redirect('servicio'.$esunico);
            }
        }else
        {
            $data['detalle_serv'] = $this->Detalle_serv_model->get_detalle_serv($detalleserv_id);
            
            $this->load->model('Categoria_servicio_model');
	    $data['all_categoria_servicio'] = $this->Categoria_servicio_model->get_all_categoria_servicio_id1();
            
            $this->load->model('Subcategoria_servicio_model');
	    $data['all_subcategoria_servicio'] = $this->Subcategoria_servicio_model->get_all_subcategoria_servicio_id1();
            /*
            $this->load->model('Responsable_model');
	    $data['all_responsable'] = $this->Responsable_model->get_all_responsable();
            */
            $this->load->model('Usuario_model');
	    $data['all_responsable'] = $this->Usuario_model->get_all_usuario_tecnicoresponsable_ok();
            
            $this->load->model('Tipo_servicio_model');
	    $data['tipo_servicio'] = $this->Tipo_servicio_model->get_tipo_servicio($data['servicio']['tiposerv_id']);
	    $data['all_tipo_servicio'] = $this->Tipo_servicio_model->get_all_tipo_servicio_id1();
            
            $this->load->model('Categoria_trabajo_model');
	    $data['all_categoria_trabajo'] = $this->Categoria_trabajo_model->get_all_categoria_trabajo_id1();
            
            $this->load->model('Tiempo_uso_model');
	    $data['all_tiempo_uso'] = $this->Tiempo_uso_model->get_all_tiempo_uso_id1();
            
            $this->load->model('Procedencia_model');
	    $data['all_procedencia'] = $this->Procedencia_model->get_all_procedencia_id1();

            $this->load->model('Estado_model');
	    $data['all_estado'] = $this->Estado_model->get_all_estado_servicio();
            
            $data['_view'] = 'detalle_serv/modificareldetalle';
            $this->load->view('layouts/main',$data);
        }
        }
    }
    /*
     * ************* obtiene los detalles deun servicio para la facturacion.. ***********
     */
    function get_detalle_serv()
    {
        $data['sistema'] = $this->sistema;
        if ($this->input->is_ajax_request()) {
            $servicio_id = $this->input->post('servicio_id');
            if ($servicio_id!=""){
                $datos = $this->Detalle_serv_model->get_thisdetalle_serv_forfactura($servicio_id);
                echo json_encode($datos);
            }else echo json_encode("faltadatos");
        }else{                 
            show_404();
        }
    }
}
