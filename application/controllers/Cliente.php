<?php
/* 
 * Generated by CRUDigniter v3.2 
 * www.crudigniter.com
 */
 
class Cliente extends CI_Controller{
    private $session_data = "";
    function __construct()
    {
        parent::__construct();
        $this->load->model('Cliente_model');
        $this->load->model('Compra_model');
        if ($this->session->userdata('logged_in')) {
            $this->session_data = $this->session->userdata('logged_in');
        }else {
            redirect('', 'refresh');
        }
    }
    /* *****Funcion que verifica el acceso al sistema**** */
    private function acceso($id_rol){
        $rolusuario = $this->session_data['rol'];
        if($rolusuario[$id_rol-1]['rolusuario_asignado'] == 1){
            return true;
        }else{
            $data['_view'] = 'login/mensajeacceso';
            $this->load->view('layouts/main',$data);
        }
    }
    /*
     * Listing of cliente
     */
    function index($a = null)
    {
        if($this->acceso(94)){
            $data['rol'] = $this->session_data['rol'];
            $data['page_title'] = "Cliente";
            $data['a'] = $a;
            $data['err'] ="";

            $this->load->model('Categoria_cliente_model');
            $data['all_categoria_cliente'] = $this->Categoria_cliente_model->get_all_cat_cliente();

            $this->load->model('Categoria_clientezona_model');
            $data['all_categoria_clientezona'] = $this->Categoria_clientezona_model->get_all_categoria_clientezona_asc();

            $this->load->model('Tipo_cliente_model');
            $data['all_tipo_cliente'] = $this->Tipo_cliente_model->get_all_tipo_cliente_asc();

            $this->load->model('Usuario_model');
            $data['all_prevendedor'] = $this->Usuario_model->get_all_usuario_prev_activo();

            $this->load->model('Estado_model');
            $data['all_estado'] = $this->Estado_model->get_all_estado_activo_inactivo();

            $this->load->model('Empresa_model');
            $data['empresa'] = $this->Empresa_model->get_all_empresa();
            
            $this->load->model('Parametro_model');
            $data['parametro'] = $this->Parametro_model->get_parametro(1);

            $data['_view'] = 'cliente/index';
            $this->load->view('layouts/main',$data);
        }
    }

    /*
     * Adding a new cliente
     */
    function add()
    {
        if($this->acceso(95)){
            $data['page_title'] = "Cliente";
            $this->load->library('form_validation');

            //$this->form_validation->set_rules('cliente_codigo','Cliente Codigo','required');
            $this->form_validation->set_rules('cliente_nombre','Cliente Nombre','trim|required', array('required' => 'Este Campo no debe ser vacio'));
            //$this->form_validation->set_rules('cliente_nombrenegocio','Nombre Negocio','required');

            if($this->form_validation->run())     
            {
                $this->input->post('cliente_nombre');
                $resultado = $this->Cliente_model->es_cliente_registrado($this->input->post('cliente_nombre'));
                if($resultado > 0){
                    $this->load->model('Estado_model');
                    $data['all_estado'] = $this->Estado_model->get_all_estado_activo_inactivo();

                    $this->load->model('Categoria_clientezona_model');
                    $data['zona'] = $this->Categoria_clientezona_model->get_all_categoria_clientezona();
                    /***Añadido por Mario Escobar para asignarle a un usuario prevendedor***/
                    $this->load->model('Usuario_model');
                    $data['all_usuario_prev'] = $this->Usuario_model->get_all_usuario_prev_activo();

                    $this->load->model('Tipo_cliente_model');
                    $data['all_tipo_cliente'] = $this->Tipo_cliente_model->get_all_tipo_cliente();

                    $this->load->model('Categoria_cliente_model');
                    $data['all_categoria_cliente'] = $this->Categoria_cliente_model->get_all_categoria_cliente();
		    
                    $data['resultado'] = 1;
                    $data['_view'] = 'cliente/add';
                    $this->load->view('layouts/main',$data);
                  
                }else{
                /* *********************INICIO imagen***************************** */
                $foto="";
                if (!empty($_FILES['cliente_foto']['name'])){
                        $this->load->library('image_lib');
                        $config['upload_path'] = './resources/images/clientes/';
                        $img_full_path = $config['upload_path'];

                        $config['allowed_types'] = 'gif|jpeg|jpg|png';
                        $config['max_size'] = 0;
                        $config['max_width'] = 5900;
                        $config['max_height'] = 5900;
                        
                        $new_name = time(); //str_replace(" ", "_", $this->input->post('proveedor_nombre'));
                        $config['file_name'] = $new_name; //.$extencion;
                        $config['file_ext_tolower'] = TRUE;

                        $this->load->library('upload', $config);
                        $this->upload->do_upload('cliente_foto');

                        $img_data = $this->upload->data();
                        $extension = $img_data['file_ext'];
                        /* ********************INICIO para resize***************************** */
                        if ($img_data['file_ext'] == ".jpg" || $img_data['file_ext'] == ".png" || $img_data['file_ext'] == ".jpeg" || $img_data['file_ext'] == ".gif") {
                            $conf['image_library'] = 'gd2';
                            $conf['source_image'] = $img_data['full_path'];
                            $conf['new_image'] = './resources/images/clientes/';
                            $conf['maintain_ratio'] = TRUE;
                            $conf['create_thumb'] = FALSE;
                            $conf['width'] = 800;
                            $conf['height'] = 600;
                            $this->image_lib->clear();
                            $this->image_lib->initialize($conf);
                            if(!$this->image_lib->resize()){
                                echo $this->image_lib->display_errors('','');
                            }
                        }
                        /* ********************F I N  para resize***************************** */
                        $confi['image_library'] = 'gd2';
                        $confi['source_image'] = './resources/images/clientes/'.$new_name.$extension;
                        $confi['new_image'] = './resources/images/clientes/'."thumb_".$new_name.$extension;
                        $confi['create_thumb'] = FALSE;
                        $confi['maintain_ratio'] = TRUE;
                        $confi['width'] = 50;
                        $confi['height'] = 50;

                        $this->image_lib->clear();
                        $this->image_lib->initialize($confi);
                        $this->image_lib->resize();

                        $foto = $new_name.$extension;
                    }
            /* *********************FIN imagen***************************** */
                $usuario_id = $this->session_data['usuario_id'];
                //no es necesario porque se esta usando el date y ya no el date piker
                //$mifecha = $this->Cliente_model->normalize_date($this->input->post('cliente_aniversario'));
                $estado_id = 1;
                $lun = $this->input->post('lun');
                if($lun != 1){ $lun = 0; }
                $mar = $this->input->post('mar');
                if($mar != 1){ $mar = 0; }
                $mie = $this->input->post('mie');
                if($mie != 1){ $mie = 0; }
                $jue = $this->input->post('jue');
                if($jue != 1){ $jue = 0; }
                $vie = $this->input->post('vie');
                if($vie != 1){ $vie = 0; }
                $sab = $this->input->post('sab');
                if($sab != 1){ $sab = 0; }
                $dom = $this->input->post('dom');
                if($dom != 1){ $dom = 0; }
                $params = array(
                            'estado_id' => $estado_id,
                            'tipocliente_id' => $this->input->post('tipocliente_id'),
                            'categoriaclie_id' => $this->input->post('categoriaclie_id'),
                            'cliente_codigo' => $this->input->post('cliente_codigo'),
                            'cliente_nombre' => $this->input->post('cliente_nombre'),
                            'cliente_ci' => $this->input->post('cliente_ci'),
                            'cliente_direccion' => $this->input->post('cliente_direccion'),
                            'cliente_telefono' => $this->input->post('cliente_telefono'),
                            'cliente_celular' => $this->input->post('cliente_celular'),
                            'cliente_foto' => $foto,
                            'cliente_email' => $this->input->post('cliente_email'),
                            'cliente_nombrenegocio' => $this->input->post('cliente_nombrenegocio'),
                            'cliente_aniversario' => $this->input->post('cliente_aniversario'),
                            'cliente_latitud' => $this->input->post('cliente_latitud'),
                            'cliente_longitud' => $this->input->post('cliente_longitud'),
                            'cliente_nit' => $this->input->post('cliente_nit'),
                            'cliente_razon' => $this->input->post('cliente_razon'),
                            'cliente_departamento' => $this->input->post('cliente_departamento'),
                            'usuario_id' => $this->input->post('usuario_id'),
                            'zona_id' => $this->input->post('zona_id'),
                            'lun' => $lun,
                            'mar' => $mar,
                            'mie' => $mie,
                            'jue' => $jue,
                            'vie' => $vie,
                            'sab' => $sab,
                            'dom' => $dom,
                );
            
                $cliente_id = $this->Cliente_model->add_cliente($params);
                redirect('cliente/index');
                }
            }
            else
            {
                            $this->load->model('Estado_model');
                            $data['all_estado'] = $this->Estado_model->get_all_estado_activo_inactivo();

                            $this->load->model('Categoria_clientezona_model');
                            $data['zona'] = $this->Categoria_clientezona_model->get_all_categoria_clientezona();
                            /***Añadido por Mario Escobar para asignarle a un usuario prevendedor***/
                            $this->load->model('Usuario_model');
                            $data['all_usuario_prev'] = $this->Usuario_model->get_all_usuario_prev_activo();

                            $this->load->model('Tipo_cliente_model');
                            $data['all_tipo_cliente'] = $this->Tipo_cliente_model->get_all_tipo_cliente();

                            $this->load->model('Categoria_cliente_model');
                            $data['all_categoria_cliente'] = $this->Categoria_cliente_model->get_all_categoria_cliente();

                            $data['resultado'] = 0;

                $data['_view'] = 'cliente/add';
                $this->load->view('layouts/main',$data);
            }
        }
    }  

    /*
     * Editing a cliente
     */
    function edit($cliente_id)
    {
        if($this->acceso(98)){
            $data['page_title'] = "Cliente";
        // check if the cliente exists before trying to edit it
        $data['cliente'] = $this->Cliente_model->get_cliente($cliente_id);
        
        if(isset($data['cliente']['cliente_id']))
        {
            $this->load->library('form_validation');

			//$this->form_validation->set_rules('cliente_codigo','Cliente Codigo','required');
			$this->form_validation->set_rules('cliente_nombre','Cliente Nombre','required');
                        //$this->form_validation->set_rules('cliente_nombrenegocio','Cliente Nombre Negocio','required');
		
	    if($this->form_validation->run())     
            {
                $usuario_id = $this->session_data['usuario_id'];
                /* *********************INICIO imagen***************************** */
                $foto="";
                $foto1= $this->input->post('cliente_foto1');
                if (!empty($_FILES['cliente_foto']['name']))
                {
                    $config['upload_path'] = './resources/images/clientes/';
                    $config['allowed_types'] = 'gif|jpeg|jpg|png';
                    $config['max_size'] = 0;
                    $config['max_width'] = 5900;
                    $config['max_height'] = 5900;

                    $new_name = time(); //str_replace(" ", "_", $this->input->post('proveedor_nombre'));
                    $config['file_name'] = $new_name; //.$extencion;
                    $config['file_ext_tolower'] = TRUE;
                    
                    $this->load->library('image_lib');
                    $this->image_lib->initialize($config);
                    
                    $this->load->library('upload', $config);
                    $this->upload->do_upload('cliente_foto');

                    $img_data = $this->upload->data();
                    $extension = $img_data['file_ext'];
                    /* ********************INICIO para resize***************************** */
                    if($img_data['file_ext'] == ".jpg" || $img_data['file_ext'] == ".png" || $img_data['file_ext'] == ".jpeg" || $img_data['file_ext'] == ".gif") {
                        $conf['image_library'] = 'gd2';
                        $conf['source_image'] = $img_data['full_path'];
                        $conf['new_image'] = './resources/images/clientes/';
                        $conf['maintain_ratio'] = TRUE;
                        $conf['create_thumb'] = FALSE;
                        $conf['width'] = 800;
                        $conf['height'] = 600;
                        
                        $this->image_lib->initialize($conf);
                        if(!$this->image_lib->resize()){
                            echo $this->image_lib->display_errors('','');
                        }
                        $this->image_lib->clear();
                    }
                    /* ********************F I N  para resize***************************** */
                    //$directorio = base_url().'resources/imagenes/';
                    $base_url = explode('/', base_url());
                    //$directorio = FCPATH.'resources\images\clientes\\';
                    $directorio = $_SERVER['DOCUMENT_ROOT'].'/'.$base_url[3].'/resources/images/clientes/';
                    //$directorio = $_SERVER['DOCUMENT_ROOT'].'/ximpleman_web/resources/images/clientes/';
                    if(isset($foto1) && !empty($foto1)){
                      if(file_exists($directorio.$foto1)){
                          unlink($directorio.$foto1);
                          $mimagenthumb = "thumb_".$foto1;
                          unlink($directorio.$mimagenthumb);
                      }
                  }
                    $confi['image_library'] = 'gd2';
                    $confi['source_image'] = './resources/images/clientes/'.$new_name.$extension;
                    $confi['new_image'] = './resources/images/clientes/'."thumb_".$new_name.$extension;
                    $confi['create_thumb'] = FALSE;
                    $confi['maintain_ratio'] = TRUE;
                    $confi['width'] = 50;
                    $confi['height'] = 50;

                    $this->image_lib->clear();
                    $this->image_lib->initialize($confi);
                    $this->image_lib->resize();

                    $foto = $new_name.$extension;
                }else{
                    $foto = $foto1;
                }
            /* *********************FIN imagen***************************** */
                            //$this->input->post('cliente_foto'),
                           //$mifecha = $this->Cliente_model->normalize_date($this->input->post('cliente_aniversario'));
                            //$mifecha = normalize_date($this->input->post('cliente_aniversario'));
                    $lun = $this->input->post('lun');
                    if($lun != 1){ $lun = 0; }
                    $mar = $this->input->post('mar');
                    if($mar != 1){ $mar = 0; }
                    $mie = $this->input->post('mie');
                    if($mie != 1){ $mie = 0; }
                    $jue = $this->input->post('jue');
                    if($jue != 1){ $jue = 0; }
                    $vie = $this->input->post('vie');
                    if($vie != 1){ $vie = 0; }
                    $sab = $this->input->post('sab');
                    if($sab != 1){ $sab = 0; }
                    $dom = $this->input->post('dom');
                    if($dom != 1){ $dom = 0; }
                    $params = array(
                        'estado_id' => $this->input->post('estado_id'),
                        'tipocliente_id' => $this->input->post('tipocliente_id'),
                        'categoriaclie_id' => $this->input->post('categoriaclie_id'),
                        'cliente_codigo' => $this->input->post('cliente_codigo'),
                        'zona_id' => $this->input->post('zona_id'),
                        'cliente_nombre' => $this->input->post('cliente_nombre'),
                        'cliente_ci' => $this->input->post('cliente_ci'),
                        'cliente_direccion' => $this->input->post('cliente_direccion'),
                        'cliente_telefono' => $this->input->post('cliente_telefono'),
                        'cliente_celular' => $this->input->post('cliente_celular'),
                        'cliente_foto' => $foto,
                        'cliente_email' => $this->input->post('cliente_email'),
                        'cliente_nombrenegocio' => $this->input->post('cliente_nombrenegocio'),
                        'cliente_aniversario' => $this->input->post('cliente_aniversario'),
                        'cliente_latitud' => $this->input->post('cliente_latitud'),
                        'cliente_longitud' => $this->input->post('cliente_longitud'),
                        'cliente_nit' => $this->input->post('cliente_nit'),
                        'cliente_razon' => $this->input->post('cliente_razon'),
                        'cliente_departamento' => $this->input->post('cliente_departamento'),
                        'usuario_id' => $this->input->post('usuario_id'),
                        'lun' => $lun,
                        'mar' => $mar,
                        'mie' => $mie,
                        'jue' => $jue,
                        'vie' => $vie,
                        'sab' => $sab,
                        'dom' => $dom,

                    );

                    $this->Cliente_model->update_cliente($cliente_id,$params);            
                    redirect('cliente/index');
                }
                else
                {
                    $this->load->model('Estado_model');
                    $data['all_estado'] = $this->Estado_model->get_all_estado_activo_inactivo();

                    $this->load->model('Categoria_clientezona_model');
                    $data['all_categoria_clientezona'] = $this->Categoria_clientezona_model->get_all_categoria_clientezona();
                    /***Añadido por Mario Escobar parqa asignarle a un usuario prevendedor***/
                    $this->load->model('Usuario_model');
                    $data['all_usuario_prev'] = $this->Usuario_model->get_all_usuario_prev_activo();

                    $this->load->model('Tipo_cliente_model');
                    $data['all_tipo_cliente'] = $this->Tipo_cliente_model->get_all_tipo_cliente();

                    $this->load->model('Categoria_cliente_model');
                    $data['all_categoria_cliente'] = $this->Categoria_cliente_model->get_all_categoria_cliente();

                    $data['_view'] = 'cliente/edit';
                    $this->load->view('layouts/main',$data);
                }
            }
            else
                show_error('The cliente you are trying to edit does not exist.');
        }
    }
    //modificar clientes en pedidos
    function modificar_cliente($cliente_id)
    {
        if($this->acceso(31)){
            $data['page_title'] = "Modificar Cliente";
        // check if the cliente exists before trying to edit it
        $data['cliente'] = $this->Cliente_model->get_cliente($cliente_id);
        $data['usuario_id'] = $this->session_data["usuario_id"];
        $data['tipousuario_id'] = $this->session_data["tipousuario_id"];
        
        if(isset($data['cliente']['cliente_id']))
        {
            $this->load->library('form_validation');

			//$this->form_validation->set_rules('cliente_codigo','Cliente Codigo','required');
			$this->form_validation->set_rules('cliente_nombre','Cliente Nombre','required');
                        //$this->form_validation->set_rules('cliente_nombrenegocio','Cliente Nombre Negocio','required');
		
	    if($this->form_validation->run())     
            {
                $usuario_id = $this->session_data['usuario_id'];
                /* *********************INICIO imagen***************************** */
                $foto="";
                $foto1= $this->input->post('cliente_foto1');
                if (!empty($_FILES['cliente_foto']['name']))
                {
                    $config['upload_path'] = './resources/images/clientes/';
                    $config['allowed_types'] = 'gif|jpeg|jpg|png';
                    $config['max_size'] = 0;
                    $config['max_width'] = 5900;
                    $config['max_height'] = 5900;

                    $new_name = time(); //str_replace(" ", "_", $this->input->post('proveedor_nombre'));
                    $config['file_name'] = $new_name; //.$extencion;
                    $config['file_ext_tolower'] = TRUE;
                    
                    $this->load->library('image_lib');
                    $this->image_lib->initialize($config);
                    
                    $this->load->library('upload', $config);
                    $this->upload->do_upload('cliente_foto');

                    $img_data = $this->upload->data();
                    $extension = $img_data['file_ext'];
                    /* ********************INICIO para resize***************************** */
                    if($img_data['file_ext'] == ".jpg" || $img_data['file_ext'] == ".png" || $img_data['file_ext'] == ".jpeg" || $img_data['file_ext'] == ".gif") {
                        $conf['image_library'] = 'gd2';
                        $conf['source_image'] = $img_data['full_path'];
                        $conf['new_image'] = './resources/images/clientes/';
                        $conf['maintain_ratio'] = TRUE;
                        $conf['create_thumb'] = FALSE;
                        $conf['width'] = 800;
                        $conf['height'] = 600;
                        
                        $this->image_lib->initialize($conf);
                        if(!$this->image_lib->resize()){
                            echo $this->image_lib->display_errors('','');
                        }
                        $this->image_lib->clear();
                    }
                    /* ********************F I N  para resize***************************** */
                    //$directorio = base_url().'resources/imagenes/';
                    $base_url = explode('/', base_url());
                    //$directorio = FCPATH.'resources\images\clientes\\';
                    $directorio = $_SERVER['DOCUMENT_ROOT'].'/'.$base_url[3].'/resources/images/clientes/';
                    //$directorio = $_SERVER['DOCUMENT_ROOT'].'/ximpleman_web/resources/images/clientes/';
                    if(isset($foto1) && !empty($foto1)){
                      if(file_exists($directorio.$foto1)){
                          unlink($directorio.$foto1);
                          $mimagenthumb = "thumb_".$foto1;
                          unlink($directorio.$mimagenthumb);
                      }
                  }
                    $confi['image_library'] = 'gd2';
                    $confi['source_image'] = './resources/images/clientes/'.$new_name.$extension;
                    $confi['new_image'] = './resources/images/clientes/'."thumb_".$new_name.$extension;
                    $confi['create_thumb'] = FALSE;
                    $confi['maintain_ratio'] = TRUE;
                    $confi['width'] = 50;
                    $confi['height'] = 50;

                    $this->image_lib->clear();
                    $this->image_lib->initialize($confi);
                    $this->image_lib->resize();

                    $foto = $new_name.$extension;
                }else{
                    $foto = $foto1;
                }
            /* *********************FIN imagen***************************** */
                            //$this->input->post('cliente_foto'),
                           //$mifecha = $this->Cliente_model->normalize_date($this->input->post('cliente_aniversario'));
                            //$mifecha = normalize_date($this->input->post('cliente_aniversario'));
                    $lun = $this->input->post('lun');
                    if($lun != 1){ $lun = 0; }
                    $mar = $this->input->post('mar');
                    if($mar != 1){ $mar = 0; }
                    $mie = $this->input->post('mie');
                    if($mie != 1){ $mie = 0; }
                    $jue = $this->input->post('jue');
                    if($jue != 1){ $jue = 0; }
                    $vie = $this->input->post('vie');
                    if($vie != 1){ $vie = 0; }
                    $sab = $this->input->post('sab');
                    if($sab != 1){ $sab = 0; }
                    $dom = $this->input->post('dom');
                    if($dom != 1){ $dom = 0; }
                    $params = array(
                        'estado_id' => $this->input->post('estado_id'),
                        'tipocliente_id' => $this->input->post('tipocliente_id'),
                        'categoriaclie_id' => $this->input->post('categoriaclie_id'),
                        'cliente_codigo' => $this->input->post('cliente_codigo'),
                        'zona_id' => $this->input->post('zona_id'),
                        'cliente_nombre' => $this->input->post('cliente_nombre'),
                        'cliente_ci' => $this->input->post('cliente_ci'),
                        'cliente_direccion' => $this->input->post('cliente_direccion'),
                        'cliente_telefono' => $this->input->post('cliente_telefono'),
                        'cliente_celular' => $this->input->post('cliente_celular'),
                        'cliente_foto' => $foto,
                        'cliente_email' => $this->input->post('cliente_email'),
                        'cliente_nombrenegocio' => $this->input->post('cliente_nombrenegocio'),
                        'cliente_aniversario' => $this->input->post('cliente_aniversario'),
                        'cliente_latitud' => $this->input->post('cliente_latitud'),
                        'cliente_longitud' => $this->input->post('cliente_longitud'),
                        'cliente_nit' => $this->input->post('cliente_nit'),
                        'cliente_razon' => $this->input->post('cliente_razon'),
                        'usuario_id' => $this->input->post('usuario_id'),
                        'lun' => $lun,
                        'mar' => $mar,
                        'mie' => $mie,
                        'jue' => $jue,
                        'vie' => $vie,
                        'sab' => $sab,
                        'dom' => $dom,

                    );

                    $this->Cliente_model->update_cliente($cliente_id,$params);
                    
                    //$this->load->model('Pedido_model');
                    //$this->Pedido_model->cambiar_cliente($pedido_id,$cliente_id);
                    redirect('pedido/pedidoabierto/'.$cliente_id);
                }
                else
                {
                    $this->load->model('Estado_model');
                    $data['all_estado'] = $this->Estado_model->get_all_estado_activo_inactivo();

                    $this->load->model('Categoria_clientezona_model');
                    $data['all_categoria_clientezona'] = $this->Categoria_clientezona_model->get_all_categoria_clientezona();
                    /***Añadido por Mario Escobar parqa asignarle a un usuario prevendedor***/
                    $this->load->model('Usuario_model');
                    $data['all_usuario_prev'] = $this->Usuario_model->get_all_usuario_prev_activo();

                    $this->load->model('Tipo_cliente_model');
                    $data['all_tipo_cliente'] = $this->Tipo_cliente_model->get_all_tipo_cliente();

                    $this->load->model('Categoria_cliente_model');
                    $data['all_categoria_cliente'] = $this->Categoria_cliente_model->get_all_categoria_cliente();

                    
                    $data['pedido_id'] = 0;
                    $data['_view'] = 'cliente/modificar_cliente';
                    $this->load->view('layouts/main',$data);
                }
            }
            else
                show_error('The cliente you are trying to edit does not exist.');
        }
    }

    /*
     * Deleting cliente
     */
    function remove($cliente_id)
    {
        if($this->acceso(99)){
        $cliente = $this->Cliente_model->get_cliente($cliente_id);

        // check if the cliente exists before trying to delete it
        if(isset($cliente['cliente_id']))
        {
            $res = $this->Cliente_model->cliente_es_usado($cliente_id);
            
            if($res == 0){
                $this->Cliente_model->delete_cliente($cliente_id);
                redirect('cliente/index');
            }else{
                $a = 1;
                redirect('cliente/index/'.$a);
            }
        }
        else
            show_error('The cliente you are trying to delete does not exist.');
        }
    }
    
    /*
     * Se Añade un nuevo Cliente desde Detalle - Servicios por MEV
     */
    function add_new($servicio_id)
    {
        if($this->acceso(69)){
            $this->load->model('Servicio_model');
            $data['servicio'] = $this->Servicio_model->get_servicio($servicio_id);

            if(isset($data['servicio']['servicio_id']))
            {
                $this->load->library('form_validation');
                $this->form_validation->set_rules('cliente_nombre','Cliente telefono','required');
                $this->form_validation->set_rules('cliente_codigo','Cliente telefono','required');
                $this->form_validation->set_rules('cliente_telefono','Cliente telefono','required');

                if($this->form_validation->run())     
                {
                    $nombre = $this->input->post('cliente_nombre');
                    $resultado = $this->Cliente_model->es_cliente_registrado($nombre);
                    if($resultado <= 0){
                        if ($this->input->is_ajax_request()){
                        $usuario_id = $this->session_data['usuario_id'];
                        $tipocliente_id = 1;
                        $categoria_clie = 1;

                        $estado_id = 1; //$this->Estado_model->get_id_estado($estado_descripcion);
                        $mifecha = $this->Cliente_model->normalize_date($this->input->post('cliente_aniversario'));
                        $params = array(
                                    'estado_id' => $estado_id,
                                    'tipocliente_id' => $tipocliente_id,
                                    'categoriaclie_id' => $categoria_clie,
                                    'cliente_codigo' => $this->input->post('cliente_codigo'),
                                    'cliente_nombre' => $this->input->post('cliente_nombre'),
                                    'cliente_ci' => $this->input->post('cliente_ci'),
                                    'cliente_direccion' => $this->input->post('cliente_direccion'),
                                    'cliente_telefono' => $this->input->post('cliente_telefono'),
                                    'cliente_celular' => $this->input->post('cliente_celular'),
                                    'cliente_foto' => $this->input->post('cliente_foto'),
                                    'cliente_email' => $this->input->post('cliente_email'),
                                    'cliente_nombrenegocio' => $this->input->post('cliente_nombrenegocio'),
                                    'cliente_aniversario' => $mifecha,
                                    'cliente_latitud' => $this->input->post('cliente_latitud'),
                                    'cliente_longitud' => $this->input->post('cliente_longitud'),
                                    'cliente_nit' => $this->input->post('cliente_nit'),
                                    'cliente_razon' => $this->input->post('cliente_nombre'),
                                    'usuario_id' => $this->input->post('usuario_id'),
                                );
                            $cliente_id = $this->Cliente_model->add_cliente($params);

                            $params_serv = array(
                                   'cliente_id' => $cliente_id,
                                   //'servicio_codseguimiento' => $this->input->post('codigo_seg'),
                                );

                            $this->Servicio_model->update_servicio($servicio_id,$params_serv);

                        $datos = $this->Cliente_model->get_cliente($cliente_id);
                    echo json_encode($datos);
                    }else{ show_404(); }
                }else{
                    $a = array('0' => "sonduplicados", '1' => $nombre);
                    echo json_encode($a);
                }
            }else{
                echo json_encode("faltadatos");
            }
            }else{
                    show_error('El servicio al cual desea asignar un cliente, no existe');
            }
        }
    }
    
    /*
    * buscar clientes
    */
    function buscarclientes()
    {
        $num = $this->Compra_model->numero();
        $permiso = $num[0]['parametro_permisocredito'];
        $usuario_id = $this->session_data['usuario_id'];
        $tipo_usuario = $this->session_data['tipousuario_id'];
        if ($tipo_usuario>1 && $permiso==2) {
           $condicion = " and c.usuario_id=".$usuario_id."";
        }else{
           $condicion = "";
        }
        if($this->acceso(94)){
            if ($this->input->is_ajax_request()) {

                $parametro = $this->input->post('parametro');   
                $categoria = $this->input->post('categoriaestado');   
                //$limite = $this->input->post('limite');   

                //if ($parametro!=""){
                $datos = $this->Cliente_model->get_busqueda_cliente_parametro($parametro, $categoria, $condicion);
                echo json_encode($datos);
                /*}
                else echo json_encode(null);*/
            }
            else
            {                 
                show_404();
            }
        }
    }
    
    
    /*
    * buscar clientes
    */
    function buscarclientes_usuario()
    {
        if($this->acceso(94)){   
            $usuario_id = $this->session_data['usuario_id'];
            if ($this->input->is_ajax_request()) {

                $parametro = $this->input->post('parametro');   
                $tipo = $this->input->post('tipo');

                if($tipo == 1){ //busque de solo mis clientes
                    $condicion = " c.usuario_id = ".$usuario_id;

                }
                else{
                    $condicion = " "; //busqueda de todos los clientes

                }


                if ($parametro!=""){
                $datos = $this->Cliente_model->get_cliente_por_usuario($parametro,$condicion);
                echo json_encode($datos);
                }
                else echo json_encode(null);
            }
            else
            {                 
                show_404();
            }
        }
    }
    
    /*
    * buscar clientes
    */
    function buscarclientesactivos()
    {
        if($this->acceso(70)){
            if ($this->input->is_ajax_request()) {

                $parametro = $this->input->post('parametro');   

                if ($parametro!=""){
                $datos = $this->Cliente_model->get_busqueda_cliente_activo_parametro($parametro);
                echo json_encode($datos);
                }
                else echo json_encode(null);
            }
            else
            {                 
                show_404();
            }
        }
    }
    
    /*
     * Ingresar nuevo cliente
     */
    function clientenuevo($pedido_id)
    {
        if($this->acceso(30)){ // rol 30 admnistrar pedidos
            $data['page_title'] = "Cliente";
            $data['tipousuario_id'] =  $this->session_data['tipousuario_id'];
            $data['usuario_id'] =  $this->session_data['usuario_id'];
            
            $this->load->library('form_validation');

            //$this->form_validation->set_rules('cliente_codigo','Cliente Codigo','required');
            $this->form_validation->set_rules('cliente_nombre','Cliente Nombre','trim|required', array('required' => 'Este Campo no debe ser vacio'));
            //$this->form_validation->set_rules('cliente_nombrenegocio','Nombre Negocio','required');

            if($this->form_validation->run())     
            {
                $this->input->post('cliente_nombre');
                
                $resultado = $this->Cliente_model->es_cliente_registrado($this->input->post('cliente_nombre'));
                if($resultado > 0){
                    $this->load->model('Estado_model');
                    $data['all_estado'] = $this->Estado_model->get_all_estado_activo_inactivo();

                    $this->load->model('Categoria_clientezona_model');
                    $data['zona'] = $this->Categoria_clientezona_model->get_all_categoria_clientezona();
                    /***Añadido por Mario Escobar para asignarle a un usuario prevendedor***/
                    $this->load->model('Usuario_model');
                    $data['all_usuario_prev'] = $this->Usuario_model->get_all_usuario_prev_activo();

                    $this->load->model('Tipo_cliente_model');
                    $data['all_tipo_cliente'] = $this->Tipo_cliente_model->get_all_tipo_cliente();

                    $this->load->model('Categoria_cliente_model');
                    $data['all_categoria_cliente'] = $this->Categoria_cliente_model->get_all_categoria_cliente();
		    
                    $data['resultado'] = 1;
                    $data['_view'] = 'cliente/add';
                    $this->load->view('layouts/main',$data);
                  
                }else{
                /* *********************INICIO imagen***************************** */
                $foto="";
                if (!empty($_FILES['cliente_foto']['name'])){
                        $this->load->library('image_lib');
                        $config['upload_path'] = './resources/images/clientes/';
                        $img_full_path = $config['upload_path'];

                        $config['allowed_types'] = 'gif|jpeg|jpg|png';
                        $config['max_size'] = 0;
                        $config['max_width'] = 5900;
                        $config['max_height'] = 5900;
                        
                        $new_name = time(); //str_replace(" ", "_", $this->input->post('proveedor_nombre'));
                        $config['file_name'] = $new_name; //.$extencion;
                        $config['file_ext_tolower'] = TRUE;

                        $this->load->library('upload', $config);
                        $this->upload->do_upload('cliente_foto');

                        $img_data = $this->upload->data();
                        $extension = $img_data['file_ext'];
                        /* ********************INICIO para resize***************************** */
                        if ($img_data['file_ext'] == ".jpg" || $img_data['file_ext'] == ".png" || $img_data['file_ext'] == ".jpeg" || $img_data['file_ext'] == ".gif") {
                            $conf['image_library'] = 'gd2';
                            $conf['source_image'] = $img_data['full_path'];
                            $conf['new_image'] = './resources/images/clientes/';
                            $conf['maintain_ratio'] = TRUE;
                            $conf['create_thumb'] = FALSE;
                            $conf['width'] = 800;
                            $conf['height'] = 600;
                            $this->image_lib->clear();
                            $this->image_lib->initialize($conf);
                            if(!$this->image_lib->resize()){
                                echo $this->image_lib->display_errors('','');
                            }
                        }
                        /* ********************F I N  para resize***************************** */
                        $confi['image_library'] = 'gd2';
                        $confi['source_image'] = './resources/images/clientes/'.$new_name.$extension;
                        $confi['new_image'] = './resources/images/clientes/'."thumb_".$new_name.$extension;
                        $confi['create_thumb'] = FALSE;
                        $confi['maintain_ratio'] = TRUE;
                        $confi['width'] = 50;
                        $confi['height'] = 50;

                        $this->image_lib->clear();
                        $this->image_lib->initialize($confi);
                        $this->image_lib->resize();

                        $foto = $new_name.$extension;
                    }
                /* *********************FIN imagen***************************** */
                    $usuario_id = $this->session_data['usuario_id'];
                    //no es necesario porque se esta usando el date y ya no el date piker
                    //$mifecha = $this->Cliente_model->normalize_date($this->input->post('cliente_aniversario'));
                    $estado_id = 1;
                    $lun = $this->input->post('lun');
                    if($lun != 1){ $lun = 0; }
                    $mar = $this->input->post('mar');
                    if($mar != 1){ $mar = 0; }
                    $mie = $this->input->post('mie');
                    if($mie != 1){ $mie = 0; }
                    $jue = $this->input->post('jue');
                    if($jue != 1){ $jue = 0; }
                    $vie = $this->input->post('vie');
                    if($vie != 1){ $vie = 0; }
                    $sab = $this->input->post('sab');
                    if($sab != 1){ $sab = 0; }
                    $dom = $this->input->post('dom');
                    if($dom != 1){ $dom = 0; }
                    $params = array(
                                'estado_id' => $estado_id,
                                'tipocliente_id' => $this->input->post('tipocliente_id'),
                                'categoriaclie_id' => $this->input->post('categoriaclie_id'),
                                'cliente_codigo' => $this->input->post('cliente_codigo'),
                                'cliente_nombre' => $this->input->post('cliente_nombre'),
                                'cliente_ci' => $this->input->post('cliente_ci'),
                                'cliente_direccion' => $this->input->post('cliente_direccion'),
                                'cliente_telefono' => $this->input->post('cliente_telefono'),
                                'cliente_celular' => $this->input->post('cliente_celular'),
                                'cliente_foto' => $foto,
                                'cliente_email' => $this->input->post('cliente_email'),
                                'cliente_nombrenegocio' => $this->input->post('cliente_nombrenegocio'),
                                'cliente_aniversario' => $this->input->post('cliente_aniversario'),
                                'cliente_latitud' => $this->input->post('cliente_latitud'),
                                'cliente_longitud' => $this->input->post('cliente_longitud'),
                                'cliente_nit' => $this->input->post('cliente_nit'),
                                'cliente_razon' => $this->input->post('cliente_razon'),
                                'usuario_id' => $this->input->post('usuario_id'),
                                'zona_id' => $this->input->post('zona_id'),
                                'lun' => $lun,
                                'mar' => $mar,
                                'mie' => $mie,
                                'jue' => $jue,
                                'vie' => $vie,
                                'sab' => $sab,
                                'dom' => $dom,
                    );

    //            $cliente_id = $this->Cliente_model->add_cliente($params);
    //            redirect('cliente/index');
    //            
                    $cliente_id = $this->Cliente_model->add_cliente($params);
                    //$this->load->model('Pedido_model');
                    //$this->Pedido_model->cambiar_cliente($pedido_id,$cliente_id);            
                    //redirect('pedido/pedidoabierto/'.$pedido_id);            
                    redirect('pedido/pedidoabierto/'.$cliente_id);            

                }
            }
            else
            {
                $this->load->model('Estado_model');
                $data['all_estado'] = $this->Estado_model->get_all_estado_activo_inactivo();

                $this->load->model('Categoria_clientezona_model');
                $data['zona'] = $this->Categoria_clientezona_model->get_all_categoria_clientezona();
                /***Añadido por Mario Escobar para asignarle a un usuario prevendedor***/
                $this->load->model('Usuario_model');
                $data['all_usuario_prev'] = $this->Usuario_model->get_all_usuario_prev_activo();

                $this->load->model('Tipo_cliente_model');
                $data['all_tipo_cliente'] = $this->Tipo_cliente_model->get_all_tipo_cliente();

                $this->load->model('Categoria_cliente_model');
                $data['all_categoria_cliente'] = $this->Categoria_cliente_model->get_all_categoria_cliente();

                $data['resultado'] = 0;
    //            
    //            $data['_view'] = 'cliente/add';
    //            $this->load->view('layouts/main',$data);

                        $data['pedido_id'] = $pedido_id;
                        $data['_view'] = 'cliente/clientenuevo';
                        $this->load->view('layouts/main',$data);            

            }
        }
    }  
    
    /*
     * Adding a new cliente
     */
//    function cambiarcliente($cliente_id,$pedido_id,$cliente_nit,$cliente_razon)
    function cambiarcliente($cliente_id,$pedido_id)
    {
        $this->load->model('Pedido_model');
//        $sql = "update cliente set cliente_nit = '".$cliente_nit."',".
//                "cliente_razon = '".$cliente_razon."' ".
//                "where cliente_id = ".$cliente_id;        
//        $this->Pedido_model->ejecutar($sql);       
        $this->Pedido_model->cambiar_cliente($pedido_id,$cliente_id);
        redirect('pedido/pedidoabierto/'.$pedido_id);
        
    }
    
    
    function realizar_pedido($cliente_id)
    {
        if($this->acceso(30)){
            //**************** inicio contenido ***************     
            //Crear el pedido
            $usuario_id = $this->session_data['usuario_id'];
            $this->load->model('Pedido_model');
            $pedido_id = $this->Pedido_model->crear_pedido($usuario_id);
            $cliente = $this->Cliente_model->get_cliente($cliente_id);

            $this->cambiarcliente($cliente_id, $pedido_id, $cliente['cliente_nit'], $cliente['cliente_razon']);
            redirect('pedido/pedidoabierto/'.$pedido_id);
        }         
    }
    
    
    /*
    * buscar clientes limite 50
    */
    function buscarclienteslimit()
    {
        $num = $this->Compra_model->numero();
        $permiso = $num[0]['parametro_permisocredito'];
        $usuario_id = $this->session_data['usuario_id'];
        $tipo_usuario = $this->session_data['tipousuario_id'];
        if ($tipo_usuario>1 && $permiso==2) {
           $condicion = " and c.usuario_id=".$usuario_id."";
        }else{
           $condicion = "";
        }
        if($this->acceso(94)){
            if ($this->input->is_ajax_request()) {

                $parametro = $this->input->post('parametro');   
                //$limite = $this->input->post('limite');   

                /*if ($parametro!=""){*/
                $datos = $this->Cliente_model->get_all_cliente_limit($condicion);
                echo json_encode($datos);
                /*}
                else echo json_encode(null);*/
            }
            else
            {                 
                show_404();
            }
        }
    }
    /* buscar Todos los clientes */
    function buscarclientesall()
    {
        $num = $this->Compra_model->numero();
        $permiso = $num[0]['parametro_permisocredito'];
        $usuario_id = $this->session_data['usuario_id'];
        $tipo_usuario = $this->session_data['tipousuario_id'];
        if ($tipo_usuario>1 && $permiso==2) {
           $condicion = " and c.usuario_id=".$usuario_id."";
        }else{
           $condicion = "";
        }
        if($this->acceso(30)){ //permiso para administrar pedidos
            if ($this->input->is_ajax_request())
            {
                $datos = $this->Cliente_model->get_all_cliente($condicion);
                echo json_encode($datos);
            }
            else
            {                 
                show_404();
            }
        }
    }
    
   
    /*
    * buscar clientes para pedido //://-->para pedidos
    */
    function buscarclientes_pedido()
    {
        if($this->acceso(30)){
            if ($this->input->is_ajax_request()) {
                $parametro = $this->input->post('parametro');

                if ($parametro!=""){
                    
                    $datos = $this->Cliente_model->get_cliente_parametro($parametro);
                
                echo json_encode($datos);
                }
                else echo json_encode(null);
            }
            else
            {                 
                show_404();
            }
        }
    }
    

    function mapa_clientes()
    {

        //control de sesion
//        if ($this->session->userdata('perfil')=='PREVENDEDOR'){
            
       if($this->acceso(30)) {
        //**************** inicio contenido ***************  
        
            $data['page_title'] = "Mapa de Clientes";
            $usuario_id = $this->session_data['usuario_id']; //$this->session->userdata('id_usu');
            
            $data['all_pedido'] = $this->Pedido_model->get_mis_pedidos($usuario_id);
            //$data['puntos_referencia'] = $this->Puntos_referencia_model->get_all_puntos_referencia();
            $data['_view'] = 'pedido/mapaentregas';
            
            $this->load->view('layouts/main',$data);
            
        //**************** fin contenido ***************
        }
        
    }
    
    /* * reporte de distribuidor * */
    function reporte_distribuidor()
    {
        //if($this->acceso(94)){
            $data['tipousuario_id'] = $this->session_data['tipousuario_id'];
            $data['usuario_nombre'] = $this->session_data['usuario_nombre'];
            $data['usuario_id'] = $this->session_data['usuario_id'];
            $this->load->model('Empresa_model');
            $data['empresa'] = $this->Empresa_model->get_all_empresa();
            
            $this->load->model('Usuario_model');
            $data['all_usuario'] = $this->Usuario_model->get_all_usuario_activo();

            $data['_view'] = 'cliente/reporte_distribuidor';
            $this->load->view('layouts/main',$data);
        //}
    }
    
    /* * buscar clientes para pedido //://-->para pedidos * */
    function ventatodasdia()
    {
        //if($this->acceso(31)){
            if ($this->input->is_ajax_request()){
                $parametro = $this->input->post('parametro');

                if ($parametro!=""){
                    $this->load->model('Venta_model');
                    $datos = $this->Venta_model->get_venta($parametro);
                    echo json_encode($datos);
                }
                else echo json_encode(null);
            }
            else
            {                 
                show_404();
            }
        //}
    }
}
