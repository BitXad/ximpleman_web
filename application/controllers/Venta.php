<?php
/* 
 * Generated by CRUDigniter v3.2 
 * www.crudigniter.com.
 */
 
class Venta extends CI_Controller{
    function __construct()
    {
        parent::__construct();
        $this->load->model('Venta_model');
        $this->load->model('Inventario_model');
        $this->load->model('Pedido_model');
        $this->load->model('Tipo_transaccion_model');
        $this->load->model('Forma_pago_model');
        $this->load->model('Pedido_model');
        $this->load->model('Tipo_cliente_model');
        $this->load->model('Dosificacion_model');
        $this->load->model('Factura_model'); 
        $this->load->library('ControlCode');
        $this->load->model('Empresa_model');
        $this->load->model('Detalle_venta_model');
        $this->load->model('Parametro_model');
        $this->load->model('Estado_model');
        $this->load->model('Usuario_model');
        $this->load->model('Cliente_model');
        $this->load->model('Tipo_servicio_model');
        $this->load->model('Preferencia_model');
        $this->load->model('Credito_model');
        $this->load->model('Categoria_clientezona_model');
        if ($this->session->userdata('logged_in')) {
            $this->session_data = $this->session->userdata('logged_in');
        }else {
            redirect('', 'refresh');
        }
    }
    /* *****Funcion que verifica el acceso al sistema**** */
    private function acceso($id_rol){
        $rolusuario = $this->session_data['rol'];
        if($rolusuario[$id_rol-1]['rolusuario_asignado'] == 1){
            return true;
        }else{
//            $data['_view'] = 'login/mensajeacceso';
//            $this->load->view('layouts/main',$data);
            return false;
        }
    } 

    /*
     * Listing of venta
     */
    function index()
    {

        if($this->acceso(18)){
        //**************** inicio contenido ***************
        $data['rolusuario'] = $this->session_data['rol'];
        //$data['venta'] = $this->Venta_model->get_all_venta($params);
        $data['page_title'] = "Ventas del dia";
        $data['parametro'] = $this->Parametro_model->get_parametros();
        $data['estado'] = $this->Estado_model->get_tipo_estado(1);
        $data['usuario'] = $this->Venta_model->get_usuarios();
        
        $data['_view'] = 'venta/index';
        $this->load->view('layouts/main',$data);
        
		
		
        //**************** fin contenido ***************
		}
        
    }

    function ventas()
    {    
        
        if($this->acceso(12)){
        //**************** inicio contenido ***************        
        $data['rolusuario'] = $this->session_data['rol'];
        $usuario_id = $this->session_data['usuario_id'];
        $tipousuario_id = $this->session_data['tipousuario_id'];        

        $data['page_title'] = "Ventas";
        $data['dosificacion'] = $this->Dosificacion_model->get_all_dosificacion();
        $data['pedidos'] = $this->Pedido_model->get_pedidos_activos();
        $data['cliente'] = $this->Venta_model->get_cliente_inicial();
        $data['zonas'] = $this->Categoria_clientezona_model->get_all_categoria_clientezona();
        $data['categoria_producto'] = $this->Venta_model->get_categoria_producto();
        $data['tipo_transaccion'] = $this->Tipo_transaccion_model->get_all_tipo();
        $data['forma_pago'] = $this->Forma_pago_model->get_all_forma();
        $data['tipo_cliente'] = $this->Tipo_cliente_model->get_all_tipo_cliente();
        $data['tipo_servicio'] = $this->Tipo_servicio_model->get_all_tipo_servicio();
        $data['parametro'] = $this->Parametro_model->get_parametros();
        $data['usuario'] = $this->Usuario_model->get_all_usuario_activo();
        $data['preferencia'] = $this->Preferencia_model->get_all_preferencia();
        $data['usuario_id'] = $usuario_id;
        $data['tipousuario_id'] = $tipousuario_id;
        
        //$data['venta'] = $this->Venta_model->get_all_venta($usuario_id);
        
        $data['_view'] = 'venta/ventas';
        $this->load->view('layouts/main',$data);
        		
        //**************** fin contenido ***************
        }        
    }
    
    function ventas_cliente($cliente_id)
    {    
        
        if($this->acceso(12)){
        //**************** inicio contenido ***************        
        
        $usuario_id = $this->session_data['usuario_id'];
        $tipousuario_id = $this->session_data['tipousuario_id'];
        $data['rolusuario'] = $this->session_data['rol'];
        $data['page_title'] = "Ventas";
        $data['dosificacion'] = $this->Dosificacion_model->get_all_dosificacion();
        $data['pedidos'] = $this->Pedido_model->get_pedidos_activos();
        
        $cliente_array = $this->Cliente_model->get_cliente_by_id($cliente_id);
        if(sizeof($cliente_array)>0)
        {
            $data['cliente'] = $cliente_array;
        }
        else
        {
            $data['cliente'] = $this->Venta_model->get_cliente_inicial();
            
        }        
        
        $data['zonas'] = $this->Categoria_clientezona_model->get_all_categoria_clientezona();
        $data['categoria_producto'] = $this->Venta_model->get_categoria_producto();
        $data['tipo_transaccion'] = $this->Tipo_transaccion_model->get_all_tipo();
        $data['forma_pago'] = $this->Forma_pago_model->get_all_forma();
        $data['tipo_cliente'] = $this->Tipo_cliente_model->get_all_tipo_cliente();
        $data['parametro'] = $this->Parametro_model->get_parametros();
        $data['usuario_id'] = $usuario_id;
        $data['tipousuario_id'] = $tipousuario_id;
        $data['tipo_servicio'] = $this->Tipo_servicio_model->get_all_tipo_servicio();
        $data['preferencia'] = $this->Preferencia_model->get_all_preferencia();
        
        //$data['venta'] = $this->Venta_model->get_all_venta($usuario_id);
        
        $data['_view'] = 'venta/ventas';
        $this->load->view('layouts/main',$data);
        		
        //**************** fin contenido ***************
        }       
        
    }

    function ingresar_detalle()
    {       
        if($this->acceso(12)||$this->acceso(30)){ // 12 ventas 30 pedidos
        //**************** inicio contenido ***************        
  
        $usuario_id = $this->session_data['usuario_id'];
        
        $producto_id = $this->input->post('producto_id');
        $cantidad = $this->input->post('cantidad');
        $existencia = $this->input->post('existencia');
        $datos1 = $this->input->post('datos1');
        $agrupado = $this->input->post('agrupado');
        
        $descuento = $this->input->post('descuento');
        
        $sql1 = "";
        $sql1 = "insert into detalle_venta_aux(venta_id,moneda_id,producto_id,detalleven_codigo,detalleven_cantidad,detalleven_unidad,detalleven_costo,detalleven_precio,detalleven_subtotal, ".
                "detalleven_descuento,detalleven_total,detalleven_caracteristicas,detalleven_preferencia,detalleven_comision,detalleven_tipocambio,usuario_id,existencia,".
                "producto_nombre, producto_unidad, producto_marca, categoria_id, producto_codigobarra,
                detalleven_envase,detalleven_nombreenvase,detalleven_costoenvase,detalleven_precioenvase,detalleven_cantidadenvase,detalleven_garantiaenvase,detalleven_devueltoenvase,detalleven_montodevolucion,detalleven_prestamoenvase, detalleven_fechavenc) ".
                " value(".$datos1.")";
        
        $sql2 = "update detalle_venta_aux set detalleven_cantidad = detalleven_cantidad + ".$cantidad.
                ", detalleven_subtotal = detalleven_precio * (detalleven_cantidad)".
                ", detalleven_descuento = ".$descuento.
                ", detalleven_total = (detalleven_precio - ".$descuento.")*(detalleven_cantidad)".
                ", detalleven_cantidadenvase = if(detalleven_envase=1,detalleven_cantidad,0) ".
                "  where producto_id = ".$producto_id." and usuario_id = ".$usuario_id;
        
        $descuento = 0;
        
        $sql = "select if(sum(detalleven_cantidad)+".$cantidad.">".$existencia.",1,0) as resultado from detalle_venta_aux where producto_id = ".$producto_id;

        $resultado = $this->Venta_model->consultar($sql);
        
        
        if ($resultado[0]['resultado']==0){ //si la cantidad aun es menor al inventario
            
            if($agrupado==1){
                
                if ($this->Venta_model->existe($producto_id,$usuario_id)){
                    $sql = $sql2;             
                }
                else{
                    $sql = $sql1;
                }                
            }
            else
            {
                $sql = $sql1;
            }
          
            $this->Venta_model->ejecutar($sql);
            
            $result = 1;
            echo '[{"cliente_id":"'.$result.'"}]';
            
        }
        else { $result = 0;  echo '[{"cliente_id":"'.$result.'"}]';}
            
        //**************** fin contenido ***************
        }
             
               
    }

    function eliminardetalle()
    {       
        if($this->acceso(12)){
        //**************** inicio contenido ***************       
        
        $usuario_id = $this->session_data['usuario_id'];
        
        $sql =  "delete from detalle_venta_aux where usuario_id=".$usuario_id;
        $this->Venta_model->ejecutar($sql);
        return true;
    
            		
        //**************** fin contenido ***************
        }
        		   
        
    }
    
    function codigo_control($dosificacion_llave, $dosificacion_autorizacion, $dosificacion_numfact, $nit,$fecha_trans, $monto)
    {

        //include 'ControlCode.php';

        $code = $this->controlcode->generate($dosificacion_autorizacion,//Numero de autorizacion
                                                   $dosificacion_numfact,//Numero de factura
                                                   $nit,//Número de Identificación Tributaria o Carnet de Identidad
                                                   str_replace('-','',$fecha_trans),//fecha de transaccion de la forma AAAAMMDD
                                                   $monto,//Monto de la transacción
                                                   $dosificacion_llave//Llave de dosificación
                        );        
         return $code;
    }
    
    function registrarventa()
    {  
        if($this->acceso(12)){
        //**************** inicio contenido ***************        
        
        $usuario_id = $this->session_data['usuario_id'];
        
        $porcentaje = 0;
        
        $cad = $this->input->post('cad'); // recuperamos la consulta sql enviada mediante JS para el insert en la venta
        $sql = "insert into venta(forma_id,tipotrans_id,usuario_id,cliente_id,moneda_id,".
               "estado_id,venta_fecha,venta_hora,venta_subtotal,venta_descuento,venta_total,".
               "venta_efectivo,venta_cambio,venta_glosa,venta_comision,venta_tipocambio,detalleserv_id,".
               "venta_tipodoc, tiposerv_id, entrega_id,venta_numeromesa, venta_numeroventa,usuarioprev_id,pedido_id, orden_id, entrega_estadoid".
               ") value(".$cad.")";
        
        $tipo_transaccion = $this->input->post('tipo_transaccion'); // recuperamos la consulta sql enviada mediante JS
        $cuotas = $this->input->post('cuotas'); // recuperamos la consulta sql enviada mediante JS
        $cuota_inicial = $this->input->post('cuota_inicial'); // recuperamos la consulta sql enviada mediante JS
        $venta_total = $this->input->post('venta_total'); // recuperamos la consulta sql enviada mediante JS
        $credito_interes = $this->input->post('credito_interes'); // interes por ventas
        $pedido_id = $this->input->post('pedido_id'); // interes por ventas
        $nit = $this->input->post('nit'); // nit del cliente
        $razon = $this->input->post('razon'); // nit del cliente
        $fecha_venta = $this->input->post('venta_fecha'); // nit del cliente
        $venta_descuento = $this->input->post('venta_descuento'); // descuento de la venta
        $usuarioprev_id = $this->input->post('usuarioprev_id'); // descuento de la venta
        $orden_id = $this->input->post('orden_id'); // Orden de trabajo        
        $venta_efectivo = $this->input->post('venta_efectivo'); // efectivo cancelado
        $venta_cambio = $this->input->post('venta_cambio'); // Cambio devuelto  
        
        $facturado = $this->input->post('facturado'); // si la venta es facturada
        
        $venta_id = $this->Venta_model->ejecutar($sql);// ejecutamos la consulta para registrar la venta y recuperamos venta_id
        
        if (($venta_total+$venta_descuento)>0)
            $porcentaje = $venta_descuento / ($venta_total+$venta_descuento);
        else
            $porcentaje = 0;
            
        $sql =  "insert into detalle_venta
        (producto_id,
          venta_id,
          moneda_id,
          detalleven_codigo,
          detalleven_cantidad,
          detalleven_unidad,
          detalleven_costo,
          detalleven_precio,
          detalleven_subtotal,
          detalleven_descuento,
          detalleven_total,
          detalleven_caracteristicas,
          detalleven_preferencia,
          detalleven_comision,
          detalleven_tipocambio,
          detalleven_envase,
          detalleven_nombreenvase,
          detalleven_costoenvase,
          detalleven_precioenvase,
          detalleven_cantidadenvase,
          detalleven_garantiaenvase,
          detalleven_devueltoenvase,
          detalleven_fechadevolucion,
          detalleven_horadevolucion,
          detalleven_montodevolucion,
          detalleven_prestamoenvase,
          detalleven_fechavenc,
          usuario_id,
          factura_id
        )

        (SELECT 
          producto_id,
          ".$venta_id." as venta_id,
          moneda_id,
          detalleven_codigo,
          detalleven_cantidad,
          detalleven_unidad,
          detalleven_costo,
          detalleven_precio - (detalleven_subtotal*".$porcentaje."/detalleven_cantidad),
          detalleven_subtotal,
          (detalleven_subtotal*".$porcentaje."/detalleven_cantidad),
          detalleven_total * (1 - ".$porcentaje."),
          detalleven_caracteristicas,
          detalleven_preferencia,
          detalleven_comision,
          detalleven_tipocambio,
            detalleven_envase,
            detalleven_nombreenvase,
            detalleven_costoenvase,
            detalleven_precioenvase,
            detalleven_cantidadenvase,
            detalleven_garantiaenvase,
            detalleven_devueltoenvase,
            detalleven_fechadevolucion,
            detalleven_horadevolucion,
            detalleven_montodevolucion,
            detalleven_prestamoenvase,
            detalleven_fechavenc,
            usuario_id,
            0 as factura_id
          
        FROM
          detalle_venta_aux
        WHERE 
          usuario_id=".$usuario_id.")";
        
        //$sqldetalle = $sql;
        $this->Venta_model->ejecutar($sql);// cargar los productos del detalle_aux al detalle_venta
        
        
        //************* reducri inventario
        
        $this->Inventario_model->reducir_inventario_aux($usuario_id);
        
  
        if($tipo_transaccion==2) //Si la transaccion es a credito
        {            
            //$credito_id =  
            $estado_id =  8; //8 pendiente 9 cancelado
            $compra_id =  0;
            $venta_id =  $venta_id;
            $credito_monto =  $venta_total - $cuota_inicial;
            $credito_cuotainicial =  $cuota_inicial;
            $credito_interesproc =  $credito_interes;
            $credito_interesmonto =  $venta_total * $venta_interes; //revisar
            $credito_numpagos =  $cuotas;
            $credito_fechalimite =  "date_add(date(now()), INTERVAL +1 WEEK)";
            $credito_fecha = date('Y-m-d');
            $time = time();
            $credito_hora =  date("H:i:s", $time);
            $credito_tipo = 1; // 1- ventas 2 - compras
         
            $cuotas       = $this->input->post('cuotas');
            $interes       = $this->input->post('interes');
            $modalidad    = $this->input->post('modalidad');
            $dia_pago     = $this->input->post('dia_pago');
            $fecha_inicio = $this->input->post('fecha_inicio');
            $numcuota = $cuotas; //numero de cuotas
            
                        
            if ($modalidad == "MENSUAL") $intervalo = 30; //si los pagos son mensuales
            else $intervalo = 7; //si los pagos son semanales
            
                $cuota_numcuota = 1;
                for ($i=1; $i <= $numcuota; $i++) { // ciclo para llenar las cuotas
                    $cuota_numcuota = $i;
                    
                    $cuota_fechalimitex = (time() + ($intervalo * $i * 24 * 60 * 60 ));
                    if ($modalidad == "MENSUAL") 
                        $cuota_fechalimite = date('Y-m-'.$dia_pago, $cuota_fechalimitex);
                    else 
                        $cuota_fechalimite = date('Y-m-d', $cuota_fechalimitex); 

                }
                $credito_fechalimite = $cuota_fechalimite;
            
            $sql = "insert  into credito(estado_id,compra_id,venta_id,credito_monto,credito_cuotainicial,credito_interesproc,credito_interesmonto,credito_numpagos,credito_fechalimite,credito_fecha,credito_hora,credito_tipo) value(".
                    $estado_id.",".$compra_id.",".$venta_id.",".$credito_monto.",".$credito_cuotainicial.",".$credito_interesproc.",".$credito_interesmonto.",".$credito_numpagos.",'".$credito_fechalimite."','".$credito_fecha."','".$credito_hora."',".$credito_tipo.")";
            $credito_id = $this->Venta_model->ejecutar($sql);// cargar los productos del detalle_aux al detalle_venta

            
            $estado_id =  8; //8 pendiente 9 cancelado
            $cuota_numcuota = 1;
            $cuota_capital = $venta_total - $cuota_inicial;
            $cuota_interes = ($venta_total - $cuota_inicial)*($credito_interes/100);
            $cuota_moradias = 0;
            $cuota_multa = 0;
            $cuota_subtotal =  $venta_total - $cuota_inicial;
            $cuota_descuento = 0;
            $cuota_total = $venta_total - $cuota_inicial+$cuota_interes;
            
            $cuota_cancelado = 0;
            $cuota_fecha = "'1900-01-01'";
            $cuota_hora = "'00:00'";
            $cuota_numercibo =  0;
            $cuota_saldo = $venta_total - $cuota_inicial;
            $cuota_glosa = "''";
            $cuota_saldocredito = $venta_total - $cuota_inicial;
                 
           
            $dias_mora = 0;
            $multa = 0;
            $descuento = 0;
            $cancelado = 0;
            $credito_monto = $venta_total - $cuota_inicial;
            
            $patron = ($numcuota*0.5) + 0.5;
            $cuota_capital = ($credito_monto)/$numcuota;   // bien         
            $fijo = $patron * $credito_monto * ($credito_interes/100/$numcuota);
            $cuota_subtotal = $fijo + $cuota_capital + $dias_mora + $multa;
            $total = $cuota_subtotal - $descuento;
            $saldo_deudor = $credito_monto;
            
            $siguiente= 0;
            $cuota_fechalimite = $fecha_inicio;
           
           // $fecha_inicio = date('YYYY', $fecha_inicio)."-".date('MM', $fecha_inicio)."-".$dia_pago;
            
            $cuota_fechalimite = $fecha_inicio;
            

                
            
                for ($i=1; $i <= $numcuota; $i++) { // ciclo para llenar las cuotas
                    $cuota_numcuota = $i;
                    
                    $cuota_fechalimitex = (time() + ($intervalo * $i * 24 * 60 * 60 ));
                    if ($modalidad == "MENSUAL") 
                        $cuota_fechalimite = date('Y-m-'.$dia_pago, $cuota_fechalimitex);
                    else 
                        $cuota_fechalimite = date('Y-m-d', $cuota_fechalimitex); 
                    
                    $cuota ="insert into cuota (credito_id,usuario_id,estado_id,cuota_numcuota,cuota_capital,cuota_interes,cuota_moradias,cuota_multa,cuota_descuento,cuota_cancelado,cuota_total,cuota_subtotal,cuota_fechalimite,cuota_saldo) VALUES (".
                            $credito_id.",".$usuario_id.",".$estado_id.",".$cuota_numcuota.",".$cuota_capital.",".$fijo.",".
                            $dias_mora.",".$multa.",".$descuento.",".$cancelado.",".$total.",".$cuota_subtotal.",'".$cuota_fechalimite."',".$saldo_deudor.")";
                  
                    $this->Venta_model->ejecutar($cuota);

//                    $saldo_deudor = $cuota_total - $cuota_capital;
//                    $cuota_total = $saldo_deudor;
                    $saldo_deudor = $saldo_deudor - $cuota_capital;
                    //$cuota_total = $saldo_deudor;
                }
            

            
        }
              
        if($pedido_id > 0)
        {
            $sql = "update pedido set estado_id = 13  where pedido_id = ".$pedido_id;
            $this->Venta_model->ejecutar($sql);
        }
                
        
        if($facturado=="true"){//si la venta es facturada

            $dosificacion = $this->Dosificacion_model->get_dosificacion_activa();

  //          if (sizeof($dosificacion)>0){ //si existe una dosificacion activa
                
                $estado_id = 1; 
                
                $factura_fechaventa    = $fecha_venta;
                $factura_fecha         = "date(now())";
                $factura_hora          = "time(now())";
                $factura_subtotal = $venta_total+$venta_descuento;
                $factura_nit           = $nit;
                $factura_razonsocial   = $razon;
                $factura_ice           = 0;
                $factura_exento        = 0;
                $factura_descuento     = $venta_descuento;
                $factura_total         = $venta_total;
                $factura_numero        = $dosificacion[0]['dosificacion_numfact']+1;
                $factura_autorizacion  = $dosificacion[0]['dosificacion_autorizacion'];
                $factura_llave         = $dosificacion[0]['dosificacion_llave'];
                $factura_fechalimite   = $dosificacion[0]['dosificacion_fechalimite'];
                $factura_codigocontrol = $this->codigo_control($factura_llave, $factura_autorizacion, $factura_numero, $nit,$factura_fechaventa, $factura_total);
                $factura_leyenda1       = $dosificacion[0]['dosificacion_leyenda1'];
                $factura_leyenda2       = $dosificacion[0]['dosificacion_leyenda2'];
                $factura_nitemisor     = $dosificacion[0]['dosificacion_nitemisor'];
                $factura_sucursal      = $dosificacion[0]['dosificacion_sucursal'];
                $factura_sfc           = $dosificacion[0]['dosificacion_sfc'];
                $factura_actividad     = $dosificacion[0]['dosificacion_actividad'];

                $sql = "update dosificacion set dosificacion_numfact = ".$factura_numero;
                $this->Venta_model->ejecutar($sql);
                             
                $sql = "insert into factura(estado_id, venta_id, factura_fechaventa, 
                    factura_fecha, factura_hora, factura_subtotal, 
                    factura_ice, factura_exento, factura_descuento, factura_total, 
                    factura_numero, factura_autorizacion, factura_llave, 
                    factura_fechalimite, factura_codigocontrol, factura_leyenda1, factura_leyenda2,
                    factura_nit, factura_razonsocial, factura_nitemisor, factura_sucursal, factura_sfc, factura_actividad,
                    usuario_id, tipotrans_id, factura_efectivo, factura_cambio) value(".
                    $estado_id.",".$venta_id.",'".$factura_fechaventa."',".
                    $factura_fecha.",".$factura_hora.",".$factura_subtotal.",".
                    $factura_ice.",".$factura_exento.",".$factura_descuento.",".$factura_total.",".
                    $factura_numero.",".$factura_autorizacion.",'".$factura_llave."','".
                    $factura_fechalimite."','".$factura_codigocontrol."','".$factura_leyenda1."','".$factura_leyenda2."',".
                    $factura_nit.",'".$factura_razonsocial."','".$factura_nitemisor."','".
                    $factura_sucursal."','".$factura_sfc."','".$factura_actividad."',".
                    $usuario_id.",".$tipo_transaccion.",".$venta_efectivo.",".$venta_cambio.")";

                $factura_id = $this->Venta_model->ejecutar($sql);
               
            
                $sql =  "insert into detalle_factura(
                 producto_id,
                venta_id,
                factura_id,
                detallefact_codigo,
                detallefact_unidad,
                detallefact_cantidad,            
                detallefact_descripcion,
                detallefact_precio,
                detallefact_subtotal,
                detallefact_descuento,
                detallefact_total,                
                detallefact_preferencia,
                detallefact_caracteristicas)

                (SELECT 
                  producto_id,
                  ".$venta_id." as venta_id,          
                  ".$factura_id." as factura_id,
                  detalleven_codigo,
                  detalleven_unidad,
                  detalleven_cantidad,
                  producto_nombre,          
                  detalleven_precio - (detalleven_subtotal*".$porcentaje."/detalleven_cantidad),
                  detalleven_subtotal,
                 (detalleven_subtotal*".$porcentaje."/detalleven_cantidad),
                  detalleven_total * (1 - ".$porcentaje."),     
                  detalleven_preferencia,
                  detalleven_caracteristicas

                FROM
                  detalle_venta_aux
                WHERE 
                  usuario_id=".$usuario_id.")";
         
                $this->Venta_model->ejecutar($sql);               
                
                $this->ultimaventa(1);
       //     }
        }
        
        if($orden_id > 0)
        {
            $sql = "update orden_trabajo set estado_id = 18  where orden_id = ".$orden_id;
            $this->Venta_model->ejecutar($sql);
            $proceso_fechaproceso = "now()";
            $contador = 1;
            $prisql = "insert into proceso_orden(orden_id,estado,estado_id,usuario_id,proceso_fechaproceso,proceso_fechaterminado) value(".$orden_id.",17,26,0,".$proceso_fechaproceso.",".$proceso_fechaproceso.")";
            $primid = $this->Venta_model->ejecutar($prisql); 

            for ($contador = 18; $contador<=23; $contador++){
                 
                //$orden_id = 
                $estado = $contador;
                $estado_id = 24;
                
                $sql = "insert into proceso_orden(orden_id,estado,estado_id,usuario_id) value(".
                        $orden_id.",".$estado.",".$estado_id.",0)";
                $id = $this->Venta_model->ejecutar($sql);              
                
            }            
        }

        //**************** fin contenido ***************
        }
               
        
    }
    
    
 /* 
 */
    function buscarcodigo()  
    {   

            $cantidad = 1;        
            $codigo = $this->input->post('codigo');
            $producto = $this->Inventario_model->get_inventario_codigo($codigo);
            
            if (sizeof($producto)>0){
                echo json_encode($producto);
            }
            else
            {
                $producto = $this->Inventario_model->get_inventario_codigo_factor($codigo);                
                echo json_encode($producto);
                
            }            

    }

    

    function generar_factura()
    {  
        if($this->acceso(12)){
        //**************** inicio contenido ***************        

            //$dosificacion = $this->Dosificacion_model->get_dosificacion_activa();
            $dosificacion = $this->Dosificacion_model->get_dosificacion(1);

            $usuario_id = $this->session_data['usuario_id'];
            
            
            //********** parametros para la generacion de factura *************            
            
            $nit_factura = $this->input->post('nit');
            $razon_social = $this->input->post('razon_social');
            $fecha_venta = $this->input->post('fecha_venta');
            $detallefact_descripcion = $this->input->post('detalle_factura');
            $unidad = $this->input->post('detalle_unidad');
            $cantidad = $this->input->post('detalle_cantidad');
            $precio = $this->input->post('detalle_precio');            
            
            $llave_foranea = $this->input->post('llave_foranea');            
            $llave_valor = $this->input->post('llave_valor');            
            
            $tipotrans_id = 1;            
            
            if ($llave_foranea=="venta_id"){
                $venta_id = $llave_valor;
            }
            else{
                $venta_id = 0;
            }
            
            
            
//            $nit_factura = "5152377019";
//            $razon_social = "LOZANO SRL";
//            $fecha_venta = "2019-05-22";            
//            $detallefact_descripcion = "CUOTA POR CREDITO Nº 445";
//            $unidad = "CUOTA";
//            $cantidad = 1;
//            $precio = 385.90; 
            
            $monto_factura = $cantidad * $precio;
            
            
            
            //********** fin parametros para la generacion de factura *************

//            $nit = "51523773019";
//            $razon_social = "PEALEZ SRL";
//            $fecha_venta = "PEALEZ SRL";
//            $detalle_factura = "Pago por mercaderia";
//            $monto_factura = "Pago por mercaderia";
                        
            $numero_factura = $dosificacion["dosificacion_numfact"]+1;
            $estado_id = 1;
            
            //$venta_id = $this->input->post('venta_id');
            
            $factura_fechaventa = $fecha_venta;
            $factura_fecha = "date(now())";
            $factura_hora = "time(now())";
            $factura_subtotal = $monto_factura;
            $factura_ice = 0;
            $factura_exento = 0;
            $factura_descuento = 0;
            $factura_total = $monto_factura;
            $factura_numero = $numero_factura;
            $factura_autorizacion = $dosificacion["dosificacion_autorizacion"];
            $factura_llave = $dosificacion["dosificacion_llave"];
            $factura_fechalimite = $dosificacion["dosificacion_fechalimite"];
            $factura_leyenda1 = $dosificacion["dosificacion_leyenda1"];
            $factura_leyenda2 = $dosificacion["dosificacion_leyenda2"];
            $factura_nit = $nit_factura;
            $factura_razonsocial = $razon_social;
            $factura_nitemisor = $dosificacion["dosificacion_nitemisor"];
            $factura_sucursal = $dosificacion["dosificacion_sucursal"];
            $factura_sfc = $dosificacion["dosificacion_sfc"];
            $factura_actividad = $dosificacion["dosificacion_actividad"];
            
            $factura_efectivo = $factura_total;
            $factura_cambio = 0;
          
            $factura_codigocontrol = $this->codigo_control($factura_llave, $factura_autorizacion, $factura_numero, $factura_nit, $factura_fechaventa, $factura_total);
            
            $sql = "update dosificacion set dosificacion_numfact = ".$factura_numero;
            $this->Venta_model->ejecutar($sql);
            
            $sql = "insert into factura(estado_id, factura_fechaventa, 
                    factura_fecha, factura_hora, factura_subtotal, 
                    factura_ice, factura_exento, factura_descuento, factura_total, 
                    factura_numero, factura_autorizacion, factura_llave, 
                    factura_fechalimite, factura_codigocontrol, factura_leyenda1, factura_leyenda2,
                    factura_nit, factura_razonsocial, factura_nitemisor, factura_sucursal, factura_sfc, factura_actividad, usuario_id,".$llave_foranea.",
                    factura_efectivo, factura_cambio, tipotrans_id) value(".
                    $estado_id.",'".$factura_fechaventa."',".
                    $factura_fecha.",".$factura_hora.",".$factura_subtotal.",".
                    $factura_ice.",".$factura_exento.",".$factura_descuento.",".$factura_total.",".
                    $factura_numero.",".$factura_autorizacion.",'".$factura_llave."','".
                    $factura_fechalimite."','".$factura_codigocontrol."','".$factura_leyenda1."','".$factura_leyenda2."',".
                    $factura_nit.",'".$factura_razonsocial."','".$factura_nitemisor."','".
                    $factura_sucursal."','".$factura_sfc."','".$factura_actividad."',".$usuario_id.",".$llave_valor.",".
                    $factura_efectivo.",".$factura_cambio.",".$tipotrans_id.")";

            $factura_id = $this->Venta_model->ejecutar($sql);


            $producto_id = 0;
            $detallefact_codigo = "-";
            $detallefact_cantidad = $cantidad;
            $detallefact_precio = $precio;
            $detallefact_subtotal =  $monto_factura;
            $detallefact_descuento = 0;
            $detallefact_total = $monto_factura;
            $detallefact_preferencia =  "";
            $detallefact_caracteristicas = "";
            
            $sql =  "insert into detalle_factura(
             producto_id,
            venta_id,
            factura_id,
            detallefact_codigo,
            detallefact_unidad,
            detallefact_cantidad,            
            detallefact_descripcion,
            detallefact_precio,
            detallefact_subtotal,
            detallefact_descuento,
            detallefact_total,                
            detallefact_preferencia,
            detallefact_caracteristicas)
            
            value(
            ".$producto_id.",
            ".$venta_id.",
            ".$factura_id.",
            '".$detallefact_codigo."',
            '".$unidad."',
            ".$detallefact_cantidad.",            
            '".$detallefact_descripcion."',
            ".$detallefact_precio.",
            ".$detallefact_subtotal.",
            ".$detallefact_descuento.",
            ".$detallefact_total.",                
            '".$detallefact_preferencia."',
            '".$detallefact_caracteristicas."')";

            $this->Venta_model->ejecutar($sql);           
            
            
            if($venta_id>0){
                $sql = "update venta set venta_tipodoc = 1 where venta_id = ".$venta_id;
                $this->Venta_model->ejecutar($sql);
            }
            echo json_encode($factura_id);
        //**************** fin contenido ***************
        }
    }
        
    
    /*
     * Adding a new venta
     */
    function add()
    {   
        
        if($this->acceso(12)){
        //**************** inicio contenido ***************        
        
        if(isset($_POST) && count($_POST) > 0)     
        {   
            $params = array(
				'forma_id' => $this->input->post('forma_id'),
				'tipotrans_id' => $this->input->post('tipotrans_id'),
				'usuario_id' => $this->input->post('usuario_id'),
				'cliente_id' => $this->input->post('cliente_id'),
				'moneda_id' => $this->input->post('moneda_id'),
				'estado_id' => $this->input->post('estado_id'),
				'venta_fecha' => $this->input->post('venta_fecha'),
				'venta_hora' => $this->input->post('venta_hora'),
				'venta_subtotal' => $this->input->post('venta_subtotal'),
				'venta_descuento' => $this->input->post('venta_descuento'),
				'venta_total' => $this->input->post('venta_total'),
				'venta_efectivo' => $this->input->post('venta_efectivo'),
				'venta_cambio' => $this->input->post('venta_cambio'),
				'venta_glosa' => $this->input->post('venta_glosa'),
				'venta_comision' => $this->input->post('venta_comision'),
				'venta_tipocambio' => $this->input->post('venta_tipocambio'),
            );
            
            $venta_id = $this->Venta_model->add_venta($params);
            redirect('venta/index');
        }
        else
        {
            $this->load->model('Forma_pago_model');
            $data['all_forma_pago'] = $this->Forma_pago_model->get_all_forma_pago();

            $this->load->model('Tipo_transaccion_model');
            $data['all_tipo_transaccion'] = $this->Tipo_transaccion_model->get_all_tipo_transaccion();

            $this->load->model('Cliente_model');
            $data['all_cliente'] = $this->Cliente_model->get_all_cliente();
            $data['all_cliente'] = $this->Cliente_model->get_all_cliente();

            $this->load->model('Moneda_model');
            $data['all_moneda'] = $this->Moneda_model->get_all_moneda();

            $this->load->model('Estado_model');
            $data['all_estado'] = $this->Estado_model->get_all_estado();
            
            $data['_view'] = 'venta/add';
            $this->load->view('layouts/main',$data);
        }
      		
        //**************** fin contenido ***************
        }			      
        
    }  

    /*
     * Editing a venta
     */
function edit($venta_id)
    {   
        if($this->acceso(19)){
        //**************** inicio contenido ***************      
        
        $usuario_id = $this->session_data['usuario_id'];
        // check if the venta exists before trying to edit it
        $venta = $this->Venta_model->get_venta($venta_id);
        
        $data['venta'] = $venta;//$this->Venta_model->get_venta($venta_id);
        $cliente_id = $venta["cliente_id"];
       
        //echo "Cliente: ".$cliente_id;
        if(isset($data['venta']['venta_id']))
        {
            if(isset($_POST) && count($_POST) > 0)     
            {
                $tipotrans_id = $this->input->post('tipotrans_id');
                $venta_fecha = implode("-", array_reverse(explode("/", $this->input->post('venta_fecha'))));
                $params = array(
                    'forma_id' => $this->input->post('forma_id'),
                    'tipotrans_id' => $this->input->post('tipotrans_id'),
                    'usuario_id' => $this->input->post('usuario_id'),
                    'cliente_id' => $this->input->post('cliente_id'),
                    'moneda_id' => $this->input->post('moneda_id'),
                    'estado_id' => $this->input->post('estado_id'),
                    'venta_fecha' => $venta_fecha,
                    'venta_hora' => $this->input->post('venta_hora'),
                    'venta_subtotal' => $this->input->post('venta_subtotal'),
                    'venta_descuento' => $this->input->post('venta_descuento'),
                    'venta_total' => $this->input->post('venta_total'),
                    'venta_efectivo' => $this->input->post('venta_efectivo'),
                    'venta_cambio' => $this->input->post('venta_cambio'),
                    'venta_glosa' => $this->input->post('venta_glosa'),
                    'venta_comision' => $this->input->post('venta_comision'),
                    'venta_tipocambio' => $this->input->post('venta_tipocambio'),
                );

                if ($tipotrans_id == 1)
                {
                    $credito = $this->Credito_model->get_credito_id($venta['venta_id']);
                    if (isset($credito)) {
                    $this->Venta_model->eliminar_credito($credito['credito_id']);
                    }
                    
                }
                
                if ($tipotrans_id == 2 || $tipotrans_id == 3)
                {

                        $fecha_inicio = $venta_fecha;
                        //$credito_id =  
                        $estado_id =  8; //8 pendiente 9 cancelado
                        $compra_id =  0;
                        //$venta_id =  $venta_id;
                        $credito_monto =  $venta['venta_total'];
                        $credito_cuotainicial =  0;
                        $credito_interesproc =  0;
                        $credito_interesmonto =  0; //revisar
                        $credito_numpagos =  1;
                        $credito_fechalimite =  "date_add(date(now()), INTERVAL +1 WEEK)";
                        $credito_fecha = $venta['venta_fecha'];
                        $time = time();
                        $credito_hora =  date("H:i:s", $time);
                        $credito_tipo = 1; // 1- ventas 2 - compras
                        $venta_total = $credito_monto;
                        $cuota_inicial = 0;
                        $credito_interes = 0;
//                        $cuotas       = $this->input->post('cuotas');
//                        $interes       = $this->input->post('interes');
                        $modalidad    = "MENSUAL";//$this->input->post('modalidad');
//                        $dia_pago     = $this->input->post('dia_pago');
//                        $fecha_inicio = $this->input->post('fecha_inicio');


                        $sql = "insert  into credito(estado_id,compra_id,venta_id,credito_monto,credito_cuotainicial,credito_interesproc,credito_interesmonto,credito_numpagos,credito_fechalimite,credito_fecha,credito_hora,credito_tipo) value(".
                                $estado_id.",".$compra_id.",".$venta_id.",".$credito_monto.",".$credito_cuotainicial.",".$credito_interesproc.",".
                                $credito_interesmonto.",".$credito_numpagos.",'".$credito_fechalimite."','".$credito_fecha."','".$credito_hora."',".$credito_tipo.")";
                        $credito_id = $this->Venta_model->ejecutar($sql);// cargar los productos del detalle_aux al detalle_venta


                        $estado_id =  8; //8 pendiente 9 cancelado
                        $cuota_numcuota = 1;
                        $cuota_capital = 0; //$venta_total - $cuota_inicial;
                        $cuota_interes = ($venta_total - $cuota_inicial)*($credito_interes/100);
                        $cuota_moradias = 0;
                        $cuota_multa = 0;
                        $cuota_subtotal =  $venta_total - $cuota_inicial;
                        $cuota_descuento = 0;
                        $cuota_total = $venta_total - $cuota_inicial+$cuota_interes;

                        $cuota_cancelado = 0;
                        $cuota_fecha = "'1900-01-01'";
                        $cuota_hora = "'00:00'";
                        $cuota_numercibo =  0;
                        $cuota_saldo = $venta_total - $cuota_inicial;
                        $cuota_glosa = "''";
                        $cuota_saldocredito = $venta_total - $cuota_inicial;

                        $credito_id = $this->db->insert_id();

                        $dias_mora = 0;
                        $multa = 0;
                        $descuento = 0;
                        $cancelado = 0;
                        $credito_monto = $venta_total - $cuota_inicial;
                        
                        $numcuota = 1;//$cuotas; //numero de cuotas
                        $patron = ($numcuota*0.5) + 0.5;
                        $cuota_capital = ($credito_monto)/$numcuota;   // bien         
                        $fijo = $patron * $credito_monto * ($credito_interes/100/$numcuota);
                        $cuota_subtotal = $fijo + $cuota_capital + $dias_mora + $multa;
                        $total = $cuota_subtotal - $descuento;
                        $saldo_deudor = $credito_monto;

                        $siguiente= 0;
                        $cuota_fechalimite = $fecha_inicio;

                        $cuota_fechalimite = $fecha_inicio;


                        if ($modalidad == "MENSUAL") $intervalo = 30; //si los pagos son mensuales
                        else $intervalo = 7; //si los pagos son semanales


                        for ($i=1; $i <= $numcuota; $i++) { // ciclo para llenar las cuotas
                            $cuota_numcuota = $i;

//                            $cuota_fechalimitex = (time() + ($intervalo * $i * 24 * 60 * 60 ));
//                            if ($modalidad == "MENSUAL") 
//                                $cuota_fechalimite = date('Y-m-'.$dia_pago, $cuota_fechalimitex);
//                            else 
//                                $cuota_fechalimite = date('Y-m-d', $cuota_fechalimitex); 
                            $cuota_fechalimite = $credito_fechalimite; 

                            $cuota ="insert into cuota (credito_id,usuario_id,estado_id,cuota_numcuota,cuota_capital,cuota_interes,cuota_moradias,cuota_multa,cuota_descuento,cuota_cancelado,cuota_total,cuota_subtotal,cuota_fechalimite,cuota_saldo) VALUES (".
                                    $credito_id.",".$usuario_id.",".$estado_id.",".$cuota_numcuota.",".$cuota_capital.",".$fijo.",".
                                    $dias_mora.",".$multa.",".$descuento.",".$cancelado.",".$total.",".$cuota_subtotal.",'".$cuota_fechalimite."',".$saldo_deudor.")";

                            $this->Venta_model->ejecutar($cuota);
                            $saldo_deudor = $saldo_deudor - $cuota_capital;
                        }
                    
                }//fin de tipotrans
                

                $this->Venta_model->update_venta($venta_id,$params);            
                redirect('venta/index');
            }
            else
            {
                $this->load->model('Forma_pago_model');
                $data['all_forma_pago'] = $this->Forma_pago_model->get_all_forma_pago();

                $this->load->model('Tipo_transaccion_model');
                $data['all_tipo_transaccion'] = $this->Tipo_transaccion_model->get_all_tipo_transaccion();

                $this->load->model('Cliente_model');
                $data['all_cliente'] = $this->Cliente_model->get_cliente_by_id($cliente_id);

                $this->load->model('Moneda_model');
                $data['all_moneda'] = $this->Moneda_model->get_all_moneda();

                $this->load->model('Usuario_model');
                $data['all_usuario'] = $this->Usuario_model->get_all_usuario();
                
                $this->load->model('Estado_model');
                $data['all_estado'] = $this->Estado_model->get_all_estado_activo_inactivo();

                $data['_view'] = 'venta/edit';
                $this->load->view('layouts/main',$data);
            }
        }
        else
            show_error('The venta you are trying to edit does not exist.');
            
        //**************** fin contenido ***************
        }
        			
    } 
    
    function buscar_venta()
    {   
        if($this->acceso(19)){
        //**************** inicio contenido ***************      
            $data['page_title'] = "Buscar venta";        
            $data['_view'] = 'venta/buscar_venta';
            $this->load->view('layouts/main',$data);
         
        }
        			
    } 
    
    /*
     * Deleting venta
     */
    
    function nota_venta($venta_id)
    {
        $data['venta'] = $this->Detalle_venta_model->get_venta($venta_id);
        $data['detalle_venta'] = $this->Detalle_venta_model->get_detalle_venta($venta_id);        
        $data['empresa'] = $this->Empresa_model->get_empresa(1);        
        $data['page_title'] = "Nota de venta";        
        
        $data['_view'] = 'venta/nota_venta';
        $this->load->view('layouts/main',$data);    
       
    }
    
    /*
     * Modulo paramodificar una venta
     */
    
    function modificar_venta($venta_id)
    {
        
        
        if($this->acceso(20)){
        //**************** inicio contenido ***************      
        $data['rolusuario'] = $this->session_data['rol'];
        $usuario_id = $this->session_data['usuario_id'];
        $tipousuario_id = $this->session_data['tipousuario_id']; 
        
                // check if the venta exists before trying to edit it
        $venta = $this->Venta_model->get_venta($venta_id);
        
        $data['venta'] = $venta;//$this->Venta_model->get_venta($venta_id);
        $cliente_id = $venta["cliente_id"];       
        
        $data['page_title'] = "Modificar Venta";
        
        $data['dosificacion'] = $this->Dosificacion_model->get_all_dosificacion();
        $data['pedidos'] = $this->Pedido_model->get_pedidos_activos();
        $data['cliente'] = $this->Cliente_model->get_cliente_by_id($cliente_id);
        $data['categoria_producto'] = $this->Venta_model->get_categoria_producto();
        $data['tipo_transaccion'] = $this->Tipo_transaccion_model->get_all_tipo();
        $data['forma_pago'] = $this->Forma_pago_model->get_all_forma();
        $data['tipo_cliente'] = $this->Tipo_cliente_model->get_all_tipo_cliente();
        $data['tipo_servicio'] = $this->Tipo_servicio_model->get_all_tipo_servicio();
        $data['parametro'] = $this->Parametro_model->get_parametros();
        $data['usuario'] = $this->Usuario_model->get_all_usuario_activo();
        $data['preferencia'] = $this->Preferencia_model->get_all_preferencia();
        $data['usuario_id'] = $usuario_id;
        $data['tipousuario_id'] = $tipousuario_id;
        $data['zonas'] = $this->Categoria_clientezona_model->get_all_categoria_clientezona();
        
                
        //**************** inicio contenido ***************     
                
       
        $data['venta_id'] = $venta_id;
        $data['venta'] = $this->Detalle_venta_model->get_venta($venta_id);
        $data['detalle_venta'] = $this->Detalle_venta_model->cargar_detalle_venta($venta_id, $usuario_id);        
        $data['empresa'] = $this->Empresa_model->get_empresa(1);        

        if($venta['tipotrans_id'] == 2){
            $data['credito'] = $this->Credito_model->get_credito_id($venta_id);
        }
    
        
        $data['_view'] = 'venta/modificar_venta';
        $this->load->view('layouts/main',$data);    
  
        //**************** fin contenido ***************
        }
               
        
    }
    
    function modificar_detalle()
    {
        
        
        if($this->acceso(12)){
        //**************** inicio contenido ***************      

                
        $usuario_id = $this->session_data['usuario_id'];
        
        $venta_id = $this->input->post('venta_id');
        $cliente_id = $this->input->post('cliente_id');
        $venta_fecha = $this->input->post('venta_fecha');
        $venta_subtotal = $this->input->post('venta_subtotal');
        $venta_descuento = $this->input->post('venta_descuento');
        $venta_total = $this->input->post('venta_total');
        $venta_total = $venta_total - $venta_descuento;
        $venta_efectivo = $this->input->post('venta_efectivo');
        $venta_cambio = $this->input->post('venta_cambio');
        $tipotrans_id = $this->input->post('tipo_transaccion');
        $forma_id = $this->input->post('forma_pago');
        $credito_id = $this->input->post('credito_id');
        $cuota_inicial = $this->input->post('cuota_inicial');
        $credito_interes = $this->input->post('credito_interes');
        $venta_interes = $this->input->post('venta_interes');
        $cuotas = $this->input->post('cuotas');
        
        $modificar_credito = $this->input->post('modificar_credito');
        
        $porcentaje = 0;
        
        $sql = "delete from detalle_venta where venta_id = ".$venta_id;
        $this->Venta_model->ejecutar($sql);
        
        /*
        $sql =  "insert into detalle_venta
                (producto_id,
                  venta_id,
                  moneda_id,
                  detalleven_codigo,
                  detalleven_cantidad,
                  detalleven_unidad,
                  detalleven_costo,
                  detalleven_precio,
                  detalleven_subtotal,
                  detalleven_descuento,
                  detalleven_total,
                  detalleven_caracteristicas,
                  detalleven_preferencia,
                  detalleven_comision,
                  detalleven_tipocambio,
                  usuario_id
                )
                
                (SELECT 
                  producto_id,
                  ".$venta_id." as venta_id,
                  moneda_id,
                  detalleven_codigo,
                  detalleven_cantidad,
                  detalleven_unidad,
                  detalleven_costo,
                  detalleven_precio,
                  detalleven_subtotal,
                  detalleven_subtotal * ".$porcentaje.",
                  detalleven_total - (detalleven_subtotal * ".$porcentaje."),
                  detalleven_caracteristicas,
                  detalleven_preferencia,
                  detalleven_comision,
                  detalleven_tipocambio,
                  usuario_id
                FROM
                  detalle_venta_aux
                WHERE 
                  usuario_id=".$usuario_id.")";
        */


        
        if (($venta_total+$venta_descuento)>0)
            $porcentaje = $venta_descuento / ($venta_total+$venta_descuento);
        else
            $porcentaje = 0;
            
        $sql =  "insert into detalle_venta
        (producto_id,
          venta_id,
          moneda_id,
          detalleven_codigo,
          detalleven_cantidad,
          detalleven_unidad,
          detalleven_costo,
          detalleven_precio,
          detalleven_subtotal,
          detalleven_descuento,
          detalleven_total,
          detalleven_caracteristicas,
          detalleven_preferencia,
          detalleven_comision,
          detalleven_tipocambio,
          detalleven_envase,
          detalleven_nombreenvase,
          detalleven_costoenvase,
          detalleven_precioenvase,
          detalleven_cantidadenvase,
          detalleven_garantiaenvase,
          detalleven_devueltoenvase,
          detalleven_fechadevolucion,
          detalleven_horadevolucion,
          detalleven_montodevolucion,
          detalleven_prestamoenvase,
          detalleven_fechavenc,
          usuario_id,
          factura_id
        )

        (SELECT 
          producto_id,
          ".$venta_id." as venta_id,
          moneda_id,
          detalleven_codigo,
          detalleven_cantidad,
          detalleven_unidad,
          detalleven_costo,
          detalleven_precio - (detalleven_subtotal*".$porcentaje."/detalleven_cantidad),
          detalleven_subtotal,
          (detalleven_subtotal*".$porcentaje."/detalleven_cantidad),
          detalleven_total * (1 - ".$porcentaje."),
          detalleven_caracteristicas,
          detalleven_preferencia,
          detalleven_comision,
          detalleven_tipocambio,
            detalleven_envase,
            detalleven_nombreenvase,
            detalleven_costoenvase,
            detalleven_precioenvase,
            detalleven_cantidadenvase,
            detalleven_garantiaenvase,
            detalleven_devueltoenvase,
            detalleven_fechadevolucion,
            detalleven_horadevolucion,
            detalleven_montodevolucion,
            detalleven_prestamoenvase,
            detalleven_fechavenc,
            usuario_id,
            0 as factura_id
          
        FROM
          detalle_venta_aux
        WHERE 
          usuario_id=".$usuario_id.")";

        
        
        $this->Venta_model->ejecutar($sql);        
        
        
        $sql = "update venta set ".
                "cliente_id = ".$cliente_id.
                ",venta_fecha = '".$venta_fecha."'".
                ",venta_subtotal = ".$venta_subtotal.
                ",venta_descuento = ".$venta_descuento.
                ",venta_total = ".($venta_total).
                ",venta_efectivo = ".$venta_efectivo.
                ",venta_cambio = ".$venta_cambio.                
                ",tipotrans_id = ".$tipotrans_id.                
                ",forma_id = ".$forma_id.                
                " where venta_id = ".$venta_id;       
        $this->Venta_model->ejecutar($sql);        
        
        $sql = "delete from detalle_venta_aux where usuario_id = ".$usuario_id;
        $this->Venta_model->ejecutar($sql);        
        
        
        if($tipotrans_id==2){ //si el tipo de transaccion es credito

            if($credito_id>=0){ //si la transaccion era a credito verificar si se desea modificar los datos del credito
                if($modificar_credito==1){ //verificamos si se da la orden de modificar los valores del credito
                    //eliminar los datos del credito
                    $sql = "delete from cuota where credito_id=".$credito_id;
                    $this->Venta_model->ejecutar($sql);
                
                    //Generar credito
                    $sql = "delete from credito where credito_id=".$credito_id;
                    $this->Venta_model->ejecutar($sql);

                    //Generar detalle del credito
                    //$credito_id =  
                    $estado_id =  8; //8 pendiente 9 cancelado
                    $compra_id =  0;
                    $venta_id =  $venta_id;
                    $credito_monto =  $venta_total - $cuota_inicial;
                    $credito_cuotainicial =  $cuota_inicial;
                    $credito_interesproc =  $credito_interes;
                    $credito_interesmonto =  $venta_total * $venta_interes; //revisar
                    $credito_numpagos =  $cuotas;
                    $credito_fechalimite =  "date_add(date(now()), INTERVAL +1 WEEK)";
                    $credito_fecha = date('Y-m-d');
                    $time = time();
                    $credito_hora =  date("H:i:s", $time);
                    $credito_tipo = 1; // 1- ventas 2 - compras

                    $cuotas       = $this->input->post('cuotas');
                    $interes       = $this->input->post('interes');
                    $modalidad    = $this->input->post('modalidad');
                    $dia_pago     = $this->input->post('dia_pago');
                    $fecha_inicio = $this->input->post('fecha_inicio');
                    $numcuota = $cuotas; //numero de cuotas

                        
            if ($modalidad == "MENSUAL") $intervalo = 30; //si los pagos son mensuales
            else $intervalo = 7; //si los pagos son semanales
            
                $cuota_numcuota = 1;
                for ($i=1; $i <= $numcuota; $i++) { // ciclo para llenar las cuotas
                    $cuota_numcuota = $i;
                    
                    $cuota_fechalimitex = (time() + ($intervalo * $i * 24 * 60 * 60 ));
                    if ($modalidad == "MENSUAL") 
                        $cuota_fechalimite = date('Y-m-'.$dia_pago, $cuota_fechalimitex);
                    else 
                        $cuota_fechalimite = date('Y-m-d', $cuota_fechalimitex); 

                }
                $credito_fechalimite = $cuota_fechalimite;
            
            $sql = "insert  into credito(estado_id,compra_id,venta_id,credito_monto,credito_cuotainicial,credito_interesproc,credito_interesmonto,credito_numpagos,credito_fechalimite,credito_fecha,credito_hora,credito_tipo) value(".
                    $estado_id.",".$compra_id.",".$venta_id.",".$credito_monto.",".$credito_cuotainicial.",".$credito_interesproc.",".$credito_interesmonto.",".$credito_numpagos.",'".$credito_fechalimite."','".$credito_fecha."','".$credito_hora."',".$credito_tipo.")";
            echo $sql;
            $credito_id = $this->Venta_model->ejecutar($sql);// cargar los productos del detalle_aux al detalle_venta

            
            $estado_id =  8; //8 pendiente 9 cancelado
            $cuota_numcuota = 1;
            $cuota_capital = $venta_total - $cuota_inicial;
            $cuota_interes = ($venta_total - $cuota_inicial)*($credito_interes/100);
            $cuota_moradias = 0;
            $cuota_multa = 0;
            $cuota_subtotal =  $venta_total - $cuota_inicial;
            $cuota_descuento = 0;
            $cuota_total = $venta_total - $cuota_inicial+$cuota_interes;
            
            $cuota_cancelado = 0;
            $cuota_fecha = "'1900-01-01'";
            $cuota_hora = "'00:00'";
            $cuota_numercibo =  0;
            $cuota_saldo = $venta_total - $cuota_inicial;
            $cuota_glosa = "''";
            $cuota_saldocredito = $venta_total - $cuota_inicial;
                 
           
            $dias_mora = 0;
            $multa = 0;
            $descuento = 0;
            $cancelado = 0;
            $credito_monto = $venta_total - $cuota_inicial;
            
            $patron = ($numcuota*0.5) + 0.5;
            $cuota_capital = ($credito_monto)/$numcuota;   // bien         
            $fijo = $patron * $credito_monto * ($credito_interes/100/$numcuota);
            $cuota_subtotal = $fijo + $cuota_capital + $dias_mora + $multa;
            $total = $cuota_subtotal - $descuento;
            $saldo_deudor = $credito_monto;
            
            $siguiente= 0;
            $cuota_fechalimite = $fecha_inicio;
           
           // $fecha_inicio = date('YYYY', $fecha_inicio)."-".date('MM', $fecha_inicio)."-".$dia_pago;
            
            $cuota_fechalimite = $fecha_inicio;
            

                
            
                for ($i=1; $i <= $numcuota; $i++) { // ciclo para llenar las cuotas
                    $cuota_numcuota = $i;
                    
                    $cuota_fechalimitex = (time() + ($intervalo * $i * 24 * 60 * 60 ));
                    if ($modalidad == "MENSUAL") 
                        $cuota_fechalimite = date('Y-m-'.$dia_pago, $cuota_fechalimitex);
                    else 
                        $cuota_fechalimite = date('Y-m-d', $cuota_fechalimitex); 
                    
                    $cuota ="insert into cuota (credito_id,usuario_id,estado_id,cuota_numcuota,cuota_capital,cuota_interes,cuota_moradias,cuota_multa,cuota_descuento,cuota_cancelado,cuota_total,cuota_subtotal,cuota_fechalimite,cuota_saldo) VALUES (".
                            $credito_id.",".$usuario_id.",".$estado_id.",".$cuota_numcuota.",".$cuota_capital.",".$fijo.",".
                            $dias_mora.",".$multa.",".$descuento.",".$cancelado.",".$total.",".$cuota_subtotal.",'".$cuota_fechalimite."',".$saldo_deudor.")";
                  
                    $this->Venta_model->ejecutar($cuota);

//                    $saldo_deudor = $cuota_total - $cuota_capital;
//                    $cuota_total = $saldo_deudor;
                    $saldo_deudor = $saldo_deudor - $cuota_capital;
                    //$cuota_total = $saldo_deudor;
                }

                }
            }
            else{
                
            }
            
            
        }
        else{
            if($credito_id>0){ //si la transaccion era a credito eliminar el credito
                $sql = "delete from cuota where credito_id=".$credito_id;
                $this->Venta_model->ejecutar($sql);
                
                $sql = "delete from credito where credito_id=".$credito_id;
                $this->Venta_model->ejecutar($sql);                
            }
        }
        
        
        //**************** inicio contenido ***************     
                  
        //**************** fin contenido ***************
        }
               
    }
    
    
    function remove($venta_id)
    {
        
        if($this->acceso(12)){
        //**************** inicio contenido ***************     
        
        $venta = $this->Venta_model->get_venta($venta_id);

        // check if the venta exists before trying to delete it
        if(isset($venta['venta_id']))
        {
            $this->Venta_model->delete_venta($venta_id);
            redirect('venta/index');
        }
        else
            show_error('The venta you are trying to delete does not exist.');
            		
        //**************** fin contenido ***************
        }
        			
    }

    /*
     * Eliminar item de detalle
     */
    function eliminaritem($detalleven_id)
    {
        if($this->acceso(12)){
        //**************** inicio contenido ***************        

        $sql = "delete from detalle_venta_aux where detalleven_id = ".$detalleven_id;
        $this->Venta_model->ejecutar($sql);
        return true;
            		
        //**************** fin contenido ***************
        }
        			
    }

    /*
     * Eliminar todos los items
     */
    function eliminartodo()
    {
        if($this->acceso(12)){
        //**************** inicio contenido ***************        
        $usuario_id = $this->session_data['usuario_id'];
        $sql = "delete from detalle_venta_aux where usuario_id = ".$usuario_id;
        $this->Venta_model->ejecutar($sql);
        return true;
            		
        //**************** fin contenido ***************
        }
        			
        
    }

    /*
     * Eliminar todos los items
     */
    function cancelar_cambios()
    {
        if($this->acceso(12)){
        //**************** inicio contenido ***************
                
                
        $usuario_id = $this->session_data['usuario_id'];
        $sql = "delete from detalle_venta_aux where usuario_id = ".$usuario_id;
        $this->Venta_model->ejecutar($sql);
        
        redirect('venta');
            		
        //**************** fin contenido ***************
        }
        			
        
    }
    /*
     * incrementar cantidad de productos en el detalle
     */
    function incrementar()
    {
        if($this->acceso(12)||$this->acceso(30)){ // 12 ventas 30 pedidos
        //**************** inicio contenido ***************        
        
        $detalleven_id = $this->input->post('detalleven_id');
        $cantidad = $this->input->post('cantidad');
        $descuento = 0;
        
            $sql = "update detalle_venta_aux set detalleven_cantidad = detalleven_cantidad + ".$cantidad.
                    ", detalleven_subtotal = detalleven_precio * (detalleven_cantidad)".
                    ", detalleven_descuento = ".$descuento.
                    ", detalleven_total = (detalleven_precio - ".$descuento.")*(detalleven_cantidad)".
                    "  where detalleven_id = ".$detalleven_id;
            
        $this->Venta_model->ejecutar($sql);
        return true;
        
            		
        //**************** fin contenido ***************
        }
        			
        
    }
    /*
     * incrementar cantidad de productos en el detalle
     */
    function incrementar_detalle()
    {
        if($this->acceso(12)||$this->acceso(30)){ // 12 ventas 30 pedidos
        //**************** inicio contenido ***************        
        
        $detalleven_id = $this->input->post('detalleven_id');
        $cantidad = $this->input->post('cantidad');
        $venta_id = $this->input->post('venta_id');
        $descuento = 0;
        
            $sql = "update detalle_venta set detalleven_cantidad = detalleven_cantidad + ".$cantidad.
                    ", detalleven_subtotal = detalleven_precio * (detalleven_cantidad)".
                    ", detalleven_descuento = ".$descuento.
                    ", detalleven_total = (detalleven_precio - ".$descuento.")*(detalleven_cantidad)".
                    "  where detalleven_id = ".$detalleven_id;
            
        $this->Venta_model->ejecutar($sql);
        
        $this->actualizar_tabla_venta($venta_id);
        
        return true;
        
            		
        //**************** fin contenido ***************
        }
        			
        
    }

    /*
     * reduce la cantidad de productos en el detalle
     */
    function reducir()
    {
      
        if($this->acceso(12)||$this->acceso(30)){ // 12 ventas 30 pedidos
        //**************** inicio contenido ***************
        
        
        $detalleven_id = $this->input->post('detalleven_id');
        $cantidad = $this->input->post('cantidad');
        $descuento = 0;
        
            $sql = "update detalle_venta_aux set detalleven_cantidad = detalleven_cantidad - ".$cantidad.
                    ", detalleven_subtotal = detalleven_precio * (detalleven_cantidad)".
                    ", detalleven_descuento = ".$descuento.
                    ", detalleven_total = (detalleven_precio - ".$descuento.")*(detalleven_cantidad)".
                    "  where detalleven_id = ".$detalleven_id;
            
        $this->Venta_model->ejecutar($sql);
        return true;
            		
        //**************** fin contenido ***************
        }
        			
        
    }


    /*
     * reduce la cantidad de productos en el detalle
     */
    function reducir_detalle()
    {
      
        if($this->acceso(12)||$this->acceso(30)){ // 12 ventas 30 pedidos
        //**************** inicio contenido ***************
        
        
        $detalleven_id = $this->input->post('detalleven_id');
        $cantidad = $this->input->post('cantidad');
        $venta_id = $this->input->post('venta_id');
        $descuento = 0;
        
            $sql = "update detalle_venta set detalleven_cantidad = detalleven_cantidad - ".$cantidad.
                    ", detalleven_subtotal = detalleven_precio * (detalleven_cantidad)".
                    ", detalleven_descuento = ".$descuento.
                    ", detalleven_total = (detalleven_precio - ".$descuento.")*(detalleven_cantidad)".
                    "  where detalleven_id = ".$detalleven_id;
            
        $this->Venta_model->ejecutar($sql);
        
        $this->actualizar_tabla_venta($venta_id);
        
        
        return true;
            		
        //**************** fin contenido ***************
        }
        			
        
    }

    /*
     * Buscar Cliente
     */
    function buscarcliente()
    {
        if($this->acceso(12)){
        //**************** inicio contenido ***************
        
                if ($this->input->is_ajax_request()) {       
                    
                    $nit = $this->input->post('nit');                    
                    $datos = $this->Venta_model->buscar_cliente($nit);
                    echo json_encode($datos);                        

                }
                else
                {                 
                            show_404();
                }  
        		
        //**************** fin contenido ***************
        }
                
               
    }
    /*
     * Mostrar detalle de venta
     */
    function detalleventa()
    {

        //if($this->acceso(12)){
        //**************** inicio contenido ***************
        
        
        $usuario_id = $this->session_data['usuario_id'];
        
        if ($this->input->is_ajax_request()) {

            //$sql = "select * from detalle_venta_aux where usuario_id=".$usuario_id;
            //$datos = $this->Venta_model->consultar($sql);
            $datos = $this->Venta_model->get_detalle_aux($usuario_id);
            
            echo json_encode($datos);
            
        }
        else
        {                 
                    show_404();
        }  
        		
        //**************** fin contenido ***************
        //}
        			
               
    }

    /*
     * incrementar cantidad de productos en el detalle
     */
    function actualizarprecio()
    {
     
        //if($this->acceso(12)){
        //**************** inicio contenido *************** 
      
        if ($this->input->is_ajax_request()) {
            $precio = $this->input->post('precio');
            $cantidad = $this->input->post('cantidad');
            $detalleven_id = $this->input->post('detalleven_id');
            $descuento = '0';
        
            $sql = "update detalle_venta_aux set detalleven_cantidad =  ".$cantidad.
                    ", detalleven_precio = ".$precio.
                    ", detalleven_subtotal = detalleven_precio * (detalleven_cantidad)".
                    ", detalleven_descuento = ".$descuento.
                    ", detalleven_total = (detalleven_precio - ".$descuento.")*(detalleven_cantidad)".
                    "  where detalleven_id = ".$detalleven_id;
            
        $this->Venta_model->ejecutar($sql);
        return true;
            
        }
        else
        {                 
                    show_404();
        }  

        //**************** fin contenido ***************
        //}
    }
    
/*
* buscar productos
*/
function buscarproductos()
{
        //**************** inicio contenido ***************    
    
        $usuario_id = $this->session_data['usuario_id'];

        if ($this->input->is_ajax_request()) {
            
            $parametro = $this->input->post('parametro');   
            
            if ($parametro!=""){
            $datos = $this->Inventario_model->get_inventario_parametro($parametro);            
          echo json_encode($datos);
          
            }
            else echo json_encode(null);
        }
        else
        {                 
            show_404();
        }   
        		
        //**************** fin contenido ***************
        			     
        
}
    
/*
* buscar productos por categoria de productos
*/
function buscarcategorias()
{
        //**************** inicio contenido ***************   
   
        $usuario_id = $this->session_data['usuario_id'];

        if ($this->input->is_ajax_request()) {
            
            $parametro = $this->input->post('parametro');   
            
            if ($parametro!=""){
            $datos = $this->Inventario_model->get_inventario_categoria($parametro);            
            //$datos = $this->Inventario_model->get_inventario_bloque();
            echo json_encode($datos);
            }
            else echo json_encode(null);
        }
        else
        {                 
            show_404();
        }      
        		
        //**************** fin contenido ***************
              
}

function buscarcotizar()
{
        $usuario_id = $this->session_data['usuario_id'];

        if ($this->input->is_ajax_request()) {
            
            $parametro = $this->input->post('parametro');   
            
            if ($parametro!=""){
            $datos = $this->Inventario_model->get_inventario_coti($parametro);            
            //$datos = $this->Inventario_model->get_inventario_bloque();
            echo json_encode($datos);
            }
            else echo json_encode(null);
        }
        else
        {                 
            show_404();
        }              
}
    
/*
* Registrar cliente
*/
function registrarcliente()
{
        if(($this->acceso(12)==true)||($this->acceso(30)==true)){
        //**************** inicio contenido ***************    
    
        if ($this->input->is_ajax_request()) {
            
            $cliente_nit = $this->input->post('nit');
            $cliente_razon = "'".$this->input->post('razon')."'";
            $cliente_telefono = "'".$this->input->post('telefono')."'";
            $tipocliente_id = $this->input->post('tipocliente_id');
            
            $cliente_nombre =  "'".$this->input->post('cliente_nombre')."'";
            $cliente_ci =  "'".$this->input->post('cliente_ci')."'";
            $cliente_nombrenegocio =  "'".$this->input->post('cliente_nombrenegocio')."'";
            $cliente_codigo =  "'".$this->input->post('cliente_codigo')."'";

            $cliente_direccion =  "'".$this->input->post('cliente_direccion')."'";
            $cliente_departamento =  "'".$this->input->post('cliente_departamento')."'";
            $cliente_celular =  "'".$this->input->post('cliente_celular')."'";
            $zona_id =  $this->input->post('zona_id');
            
            $cliente_ci = $cliente_nit;
            $cliente_nombre = $cliente_razon;
            $sql = "insert cliente(tipocliente_id,categoriaclie_id,cliente_nombre,cliente_ci,cliente_nit,
                    cliente_razon,cliente_telefono,estado_id,usuario_id,
                    cliente_nombrenegocio, cliente_codigo, cliente_direccion, cliente_departamento,
                    cliente_celular, zona_id
                    ) value(".$tipocliente_id.",1,".$cliente_nombre.",".$cliente_ci.",".$cliente_nit.",".
                    $cliente_razon.",".$cliente_telefono.",1,0,".
                   $cliente_nombrenegocio.",".$cliente_codigo.",".$cliente_direccion.",".$cliente_departamento.",".
                   $cliente_celular.",".$zona_id.")";
//            echo $sql;
            $datos = $this->Venta_model->registrarcliente($sql);
            echo json_encode($datos);
            
        }
        else
        {                 
            show_404();
        }   
        
        		
        //**************** fin contenido ***************
        			}
        		
}
    
/*
* Registrar cliente
*/
function modificarcliente()
{
        if($this->acceso(12)||$this->acceso(30)){
        //**************** inicio contenido ***************    
    
        if ($this->input->is_ajax_request()) {
            
            $cliente_nit = $this->input->post('nit');    
            
            if($cliente_nit == null || $cliente_nit==0) $cliente_nit = 0;
            
            $cliente_razon = "'".$this->input->post('razon')."'";
            $cliente_telefono = "'".$this->input->post('telefono')."'";
            $cliente_id = $this->input->post('cliente_id');
            $cliente_nombre =  "'".$this->input->post('cliente_nombre')."'";
            
            $tipocliente_id = $this->input->post('tipocliente_id');
            
            $cliente_nombre =  "'".$this->input->post('cliente_nombre')."'";
            $cliente_ci =  "'".$this->input->post('cliente_ci')."'";
            $cliente_nombrenegocio =  "'".$this->input->post('cliente_nombrenegocio')."'";
            $cliente_codigo =  "'".$this->input->post('cliente_codigo')."'";

            $cliente_direccion =  "'".$this->input->post('cliente_direccion')."'";
            $cliente_departamento =  "'".$this->input->post('cliente_departamento')."'";
            $cliente_celular =  "'".$this->input->post('cliente_celular')."'";
            $zona_id = $this->input->post('zona_id');
            
            
            if ($cliente_id>0){
                $sql = "update cliente set ".
                        " cliente_nombre = ".$cliente_nombre.
    //                    ",cliente_ci = ".$cliente_ci.
                        ",cliente_nit = ".$cliente_nit.
                        ",cliente_razon = ".$cliente_razon.
                        ",cliente_telefono = ".$cliente_telefono.
                        ",tipocliente_id = ".$tipocliente_id.
                        
                        ",cliente_nombre= ".$cliente_nombre.
                        ",cliente_ci = ".$cliente_ci.
                        ",cliente_nombrenegocio = ".$cliente_nombrenegocio.
                        ",cliente_codigo = ".$cliente_codigo.
                        
                        ",cliente_direccion= ".$cliente_direccion.
                        ",cliente_departamento = ".$cliente_departamento.
                        ",cliente_celular = ".$cliente_celular.
                        ",zona_id = ".$zona_id.
                        
                        " where cliente_id = ".$cliente_id;
                
                $datos = $this->Venta_model->modificarcliente($sql);            
                echo  '[{"cliente_id":'.$cliente_id.'}]';
            }
            else{
                //si el cliente ingresa con nit 0 se debe
                              
                $datos = $this->Venta_model->buscar_cliente($cliente_nit); 
                
                if (sizeof($datos)>0){
                    $cliente_id = $datos[0]["cliente_id"];

                    $sql = "update cliente set ".
                            " cliente_nombre = ".$cliente_nombre.
                            ",cliente_nit = ".$cliente_nit.
                            ",cliente_razon = ".$cliente_razon.
                            ",cliente_telefono = ".$cliente_telefono.
                            " where cliente_id = ".$cliente_id;

                    $datos = $this->Venta_model->modificarcliente($sql);   
                    echo  '[{"cliente_id":'.$cliente_id.'}]';
                }
                else{
                        $cliente_ci = $cliente_nit;
                        $cliente_nombre = $cliente_razon;
                        $sql = "insert cliente(tipocliente_id,categoriaclie_id,cliente_nombre,cliente_ci,cliente_nit,cliente_razon,cliente_telefono,estado_id,usuario_id) value(1,1,".
                               $cliente_nombre.",".$cliente_ci.",".$cliente_nit.",".$cliente_razon.",".$cliente_telefono.",1,0)";

                        $datos = $this->Venta_model->registrarcliente($sql);
                        return json_encode($datos);
 
                }
                
            }
//echo json_encode(true);
            
        }
        else
        {                 
            show_404();
        }   		
        //**************** fin contenido ***************
        			}
        			
}


/*************** funcion para mostrar la vista de la factura******************/
function ultimaventa($tipo){
    
              if($this->acceso(12)||$this->acceso(30)){
        //**************** inicio contenido ***************    
    
                
    $venta = $this->Venta_model->ultima_venta();
    $venta_tipodoc = $venta[0]['venta_tipodoc'];
    $venta_id = $venta[0]['venta_id'];
    
    if ($venta_tipodoc==1){ 
        redirect('factura/imprimir_factura/'.$venta_id."/".$tipo);
        //redirect('factura/factura_boucher/'.$venta_id);
        
    }
    else{
        redirect('factura/imprimir_recibo/'.$venta_id);
        //redirect('factura/recibo_boucher/'.$venta_id);        
    }
        
       //**************** fin contenido ***************
    }
            
}

/*************** funcion para mostrar la vista de la factura******************/
function ultimorecibo(){
    
    if($this->acceso(12)||$this->acceso(30)){
    //**************** inicio contenido ***************    
    
                
    $venta = $this->Venta_model->ultima_venta();
    $venta_tipodoc = $venta[0]['venta_tipodoc'];
    $venta_id = $venta[0]['venta_id'];
    

     redirect('factura/imprimir_recibo/'.$venta_id);
        //redirect('factura/recibo_boucher/'.$venta_id);        
 
        
       //**************** fin contenido ***************
        }
            
}

function ultimagarantia(){
    
    if($this->acceso(12)||$this->acceso(30)){
    //**************** inicio contenido ***************    
    
                
    $venta = $this->Venta_model->ultima_venta();
    $venta_tipodoc = $venta[0]['venta_tipodoc'];
    $venta_id = $venta[0]['venta_id'];
    

     redirect('factura/certificado_garantia/'.$venta_id);
        //redirect('factura/recibo_boucher/'.$venta_id);        
 
        
       //**************** fin contenido ***************
        }
            
}

function ultimacomanda(){
    
       if($this->acceso(12)){
        //**************** inicio contenido ***************    
    
                
    $venta = $this->Venta_model->ultima_venta();
    $venta_tipodoc = $venta[0]['venta_tipodoc'];
    $venta_id = $venta[0]['venta_id'];
    
        redirect('factura/comanda_boucher/'.$venta_id);

       //**************** fin contenido ***************
        }
            
}

function eliminar_venta($venta_id){

        if($this->acceso(12)){
        //**************** inicio contenido ***************       
    
            $sql = "update inventario i, detalle_venta d"
                    ." set i.existencia = i.existencia + d.detalleven_cantidad"
                    ." where d.venta_id = ".$venta_id." and d.producto_id = i.producto_id ";
            $this->Venta_model->ejecutar($sql);    

            $sql =  "delete from detalle_venta where venta_id = ".$venta_id;
            $this->Venta_model->ejecutar($sql);

            $sql =  "delete from venta where venta_id = ".$venta_id;
            $this->Venta_model->ejecutar($sql);

            $sql =  "delete from cuota where credito_id = (select credito_id from credito where venta_id = ".$venta_id." ) ";
            $this->Venta_model->ejecutar($sql);

            $sql =  "delete from credito where venta_id = ".$venta_id;
            $this->Venta_model->ejecutar($sql);

            redirect('venta/index');
            
       //**************** fin contenido ***************
        			}
        			              
}

function anular_venta($venta_id){

        if($this->acceso(22)){
        //**************** inicio contenido ***************   
    
    //$sql =  "delete from detalle_venta where venta_id = ".$venta_id;
    $sql =  "update detalle_venta set detalleven_cantidad = 0, detalleven_precio = 0, detalleven_total = 0 where venta_id = ".$venta_id;
    $this->Venta_model->ejecutar($sql);
            
    //$sql =  "delete from venta where venta_id = ".$venta_id;
    $sql =  "update venta set venta_subtotal = 0, venta_descuento = 0, venta_total = 0, venta_efectivo = 0, venta_cambio = 0, estado_id = 3 where venta_id = ".$venta_id;
    $this->Venta_model->ejecutar($sql);
    
    //$sql =  "delete from cuota where credito_id = (select credito_id from credito where venta_id = ".$venta_id." ) ";
    $sql =  "update cuota  set
            cuota_numcuota = 0
            ,cuota_capital = 0
            ,cuota_interes = 0
            ,cuota_moradias = 0
            ,cuota_multa = 0
            ,cuota_subtotal = 0
            ,cuota_descuento = 0
            ,cuota_total = 0
            ,cuota_cancelado = 0
            ,cuota_numercibo = 0
            ,cuota_saldo = 0
            ,estado_id = 27
            ,cuota_saldocredito = 0
             where credito_id = (select credito_id from credito where venta_id = ".$venta_id." ) ";
    $this->Venta_model->ejecutar($sql);
        
    $sql =  "update credito set
            estado_id = 27
            ,credito_monto = 0
            ,credito_cuotainicial = 0
            ,credito_interesproc = 0
            ,credito_interesmonto = 0
            ,credito_numpagos = 0
            ,credito_tipointeres = 0
            where venta_id = ".$venta_id;
    $this->Venta_model->ejecutar($sql);
            
//    $sql =  "update pedido set estado_id = 11 where pedido_id = (select v.pedido_id from venta v where v.venta_id = ".$venta_id.")";
//    $this->Venta_model->ejecutar($sql);
//    
    
    $this->Inventario_model->actualizar_inventario(); 
    redirect('venta/index');
    
    //**************** fin contenido ***************
                             }
                              
    
}

    /*
     * Mostrar ventas
     */
    function mostrar_ventas()
    {
        //**************** inicio contenido ***************   

        $usuario_id = $this->session_data['usuario_id'];

        
        if ($this->input->is_ajax_request()) {
            
            $filtro = $this->input->post('filtro');
            
            if ($filtro == null){
                $result = $this->Venta_model->get_ventas(" and v.venta_fecha = date(now())");
            }
            else{
                $result = $this->Venta_model->get_ventas($filtro);            
            }

           echo json_encode($result);
            
        }
        else
        {                 
                    show_404();
        }    
       //**************** fin contenido ***************
        			     
    }
    
  function busquedacombi()
    {

       if($this->acceso(144)){
        //**************** inicio contenido ***************          

                
        
        $config = $this->config->item('pagination');
       
        $config['total_rows'] = $this->Venta_model->get_all_venta_count();
        $this->pagination->initialize($config);
        $this->load->model('Usuario_model');
        $this->load->model('Detalle_venta_model');
        $filtro = $this->input->post('filtro');
        
        if ($filtro == null){
           //$data['venta'] = $this->Venta_model->get_all_ventas($params);
        }
        else{
             $data['venta'] = $this->Venta_model->get_busqueda($filtro);            
        }
        
        $data['all_usuario'] = $this->Usuario_model->get_all_usuario();
        $data['empresa'] = $this->Empresa_model->get_empresa(1); 
      
        $data['_view'] = 'venta/combinados';
        $this->load->view('layouts/main',$data);
        //**************** fin contenido ***************
        			}
        		     

    }

    function comision()
    {
        if($this->acceso(143)){
        //**************** inicio contenido ***************           
        
        $this->load->model('Usuario_model');
        //$this->load->model('Detalle_venta_model');
        $filtro = $this->input->post('filtro');
        
        if ($filtro == null){
           //$data['venta'] = $this->Venta_model->get_all_venta(1);
        }
        else{
             $data['venta'] = $this->Venta_model->get_busqueda($filtro);            
        }
        
        $data['all_usuario'] = $this->Usuario_model->get_all_usuario();
         
      
        $data['_view'] = 'venta/comisiones';
        $this->load->view('layouts/main',$data);
        
       //**************** fin contenido ***************
        			}
        		          
        
    }
    
    function buscarporvendedores()
    {
            //**************** inicio contenido ***************          

            if ($this->input->is_ajax_request()) {

                $filtro = $this->input->post('filtro');   

                if ($filtro!=""){
                $datos = $this->Venta_model->get_busqueda($filtro);            

                echo json_encode($datos);
                }
                else echo json_encode(null);
            }
            else
            {                 
                show_404();
            }              

           //**************** fin contenido ***************
                         

    }

    
    function actualizar_tabla_venta($venta_id)
    {

        //actualizar los totales
        $sql = "select if(sum(x.detalleven_subtotal)>0,sum(x.detalleven_subtotal),0) as subtotal,"
                . "if(sum(x.detalleven_descuento)>0,sum(x.detalleven_descuento),0) as descuento, "
                . "if(sum(x.detalleven_total)>0, sum(x.detalleven_total),0) as total "
                . " from detalle_venta x where x.venta_id = ".$venta_id;                    
        $resultado = $this->Venta_model->consultar($sql);

        //echo json_encode($resultado);

        $subtotal = $resultado[0]['subtotal'];
        $descuento = $resultado[0]['descuento'];
        $total = $resultado[0]['total'];

        $sql = "update venta set "
                . " venta_subtotal = ".$subtotal
                . ",venta_descuento = ".$descuento
                . ",venta_total = ".$total
                ." where venta_id = ".$venta_id;
        $this->Venta_model->ejecutar($sql);        
        
        return true;
        
    }
    
    function eliminar_producto_vendido($detalleven_id)
    {
           if($this->acceso(12)||$this->acceso(30)){ //12 ventas o 30 pedidos
            //**************** inicio contenido ***************          

            if ($this->input->is_ajax_request()) {

                //Obtener el detalle de la venta a eliminar
                $sql = "select * from detalle_venta where detalleven_id = ".$detalleven_id;
                $resultado = $this->Venta_model->consultar($sql);
                
                if (sizeof($resultado)>0){ // si el detalle existe
                    
                    
                    $producto_id = $resultado[0]['producto_id'];
                    $cantidad = $resultado[0]['detalleven_cantidad'];
                    $venta_id = $resultado[0]['venta_id'];
                    
                    //eliminar el detalle de la venta
                    $sql = "delete from detalle_venta where detalleven_id = ".$detalleven_id;                    
                    $this->Venta_model->ejecutar($sql);

                    //retornamos la cantidad al inventario
                    $sql = "update inventario set existencia = existencia + ".$cantidad;
                    $this->Venta_model->ejecutar($sql);

                    $this->actualizar_tabla_venta($venta_id);
                 
                    
                }
                
                return true;
                
            }
            else
            {                 
                show_404();
            }              

           //**************** fin contenido ***************
                }
                      

    }
    
    

    /*
     * Verificar las ventas
     */
    function verificar_ventas()
    {
        //**************** inicio contenido ***************   

        $usuario_id = $this->session_data['usuario_id'];

        
        if ($this->input->is_ajax_request()) {
            
            $filtro = $this->input->post('filtro');
            
            if ($filtro == null){
                $result = $this->Venta_model->mostrar_ventas(" and v.venta_fecha = date(now())");
            }
            else{
                $result = $this->Venta_model->mostrar_ventas($filtro);            
            }

           echo json_encode($result);
            
        }
        else
        {                 
                    show_404();
        }    
       //**************** fin contenido ***************
        			       
    }       

    function costo_cero()
    {       
         if($this->acceso(15)){
        //**************** inicio contenido ***************       
        
        $usuario_id = $this->session_data['usuario_id'];
        
        $sql =  "UPDATE
                detalle_venta_aux
              SET
                detalleven_costo = 0,
                detalleven_precio = 0,
                detalleven_subtotal = 0,
                detalleven_descuento = 0,
                detalleven_total = 0
              WHERE
                usuario_id = ".$usuario_id;
        $this->Venta_model->ejecutar($sql);
        return true;
    
            		
        //**************** fin contenido ***************
        			}
        		   
        
    }
        
    function cantidad_en_detalle()
    {       
        if($this->acceso(12)||$this->acceso(30)){ //12 ventas o 30 pedidos
        //**************** inicio contenido ***************       
        
        $usuario_id = $this->session_data['usuario_id'];
        
        $producto_id = $this->input->post('producto_id');
        
        $sql =  "select if(sum(detalleven_cantidad)>0,sum(detalleven_cantidad),0) as cantidad from detalle_venta_aux "
                . " where producto_id =".$producto_id;
        
        $resultado = $this->Venta_model->consultar($sql);
        echo json_encode($resultado);
    
            		
        //**************** fin contenido ***************
        }
    }
        
    function cantidad_en_detalle_otros()
    {       
          if($this->acceso(12)||$this->acceso(30)){ //12 ventas o 30 pedidos
        //**************** inicio contenido ***************       
        
        $usuario_id = $this->session_data['usuario_id'];
        
        $producto_id = $this->input->post('producto_id');
        
        $sql =  "select if(sum(detalleven_cantidad)>0,sum(detalleven_cantidad),0) as cantidad from detalle_venta_aux "
                . " where producto_id =".$producto_id." and usuario_id <>".$usuario_id;
        
        $resultado = $this->Venta_model->consultar($sql);
        echo json_encode($resultado);
    
            		
        //**************** fin contenido ***************
        			}	
    }
        


    function existencia()
    {       
         if($this->acceso(12)||$this->acceso(30)){ //12 ventas o 30 pedidos
        //**************** inicio contenido ***************       
        
        $usuario_id = $this->session_data['usuario_id'];
        
        $producto_id = $this->input->post('producto_id');
        
//        $sql =  "select existencia from inventario "
//                . " where producto_id =".$producto_id;
        
        $sql =  "select existencia from detalle_venta_aux "
                . " where producto_id =".$producto_id." and usuario_id = ".$usuario_id;
        
        $resultado = $this->Venta_model->consultar($sql);
        echo json_encode($resultado);
    
            		
        //**************** fin contenido ***************
        			}
        			
    }        

    function precio_costo()
    {       
         if($this->acceso(16)){
        //**************** inicio contenido ***************       
        
        $usuario_id = $this->session_data['usuario_id'];
        
        $sql =  "UPDATE
                detalle_venta_aux
              SET
               
                detalleven_precio = detalleven_costo,
                detalleven_subtotal = detalleven_costo * detalleven_cantidad,
                detalleven_descuento = 0,
                detalleven_total = detalleven_costo * detalleven_cantidad
              WHERE
                usuario_id = ".$usuario_id;
        $this->Venta_model->ejecutar($sql);
        return true;
    
            		
        //**************** fin contenido ***************
        			}
        			 
        
    }

    function buscar_clientes()
    {       

        //**************** inicio contenido ***************       
        
        $usuario_id = $this->session_data['usuario_id'];
        $parametro = $this->input->post('parametro');
        
        $sql =  "select * from cliente where ".
                " cliente_razon like '%".$parametro."%'".
                " or cliente_nombre like '%".$parametro."%'".
                " or cliente_codigo like '%".$parametro."%'".
                " or cliente_nit like '%".$parametro."%'";
        //echo $sql;
        $resultado = $this->Venta_model->consultar($sql);
        echo json_encode($resultado);
    
            		
        //**************** fin contenido ***************
        			
        		
    }
        
    function seleccionar_cliente($cliente_id){
        if($this->acceso(12)){
               //**************** inicio contenido ***************       

               $usuario_id = $this->session_data['usuario_id'];
               
               
               $sql =  "select * from cliente where ".
                       " cliente_id = ".$cliente_id;
               
               $resultado = $this->Venta_model->consultar($sql);
               echo json_encode($resultado);


               //**************** fin contenido ***************
                                       }
                                        
        
    }
        
    function registrar_caracteristicas(){
       if($this->acceso(12)){
               //**************** inicio contenido ***************       

               $usuario_id = $this->session_data['usuario_id'];
               
               $detalleven_id = $this->input->post('detalleven_id');
               $detalleven_preferencia = $this->input->post('preferencia');
               $detalleven_caracteristicas = $this->input->post('caracteristicas');
               $costo = $this->input->post('costo');
               $check = $this->input->post('check');
               $cantidadenvase = $this->input->post('cantidadenvase');
               $garantia = $this->input->post('garantia');
               $fecha_vencimiento = $this->input->post('fecha_vencimiento');
               
               $sql =  "update detalle_venta_aux set ".
                       " detalleven_preferencia = '".$detalleven_preferencia."'".
                       " ,detalleven_caracteristicas = '".$detalleven_caracteristicas."'".
                       " ,detalleven_fechavenc = '".$fecha_vencimiento."'".                       
                       " ,detalleven_costo = ".$costo.                       
                       " ,detalleven_devueltoenvase = 0".
                       " ,detalleven_montodevolucion = 0".
                       " ,detalleven_cantidadenvase = if(".$check."=1,".$cantidadenvase.",0)".
                       " ,detalleven_garantiaenvase = if(".$check."=1,".$garantia.",0)".                       
                       " ,detalleven_prestamoenvase = if(".$check."=1,1,0)".                       
                       " where detalleven_id = ".$detalleven_id;
               //echo $sql;
               $resultado = $this->Venta_model->ejecutar($sql);
               //echo json_encode($resultado);
               return true; 

               //**************** fin contenido ***************
                                       }
                                          
        
    }
  
        
    function verificar_detalle($monto){
        if($this->acceso(12)){
               //**************** inicio contenido ***************       

               $usuario_id = $this->session_data['usuario_id'];
               
               
               $sql =  "SELECT 
                        if(round(sum(detalleven_total), 2) = round(".$monto.", 2), 1, 0) AS resultado
                      FROM
                        detalle_venta_aux
                      WHERE
                        usuario_id =".$usuario_id;
               
               $resultado = $this->Venta_model->consultar($sql);
               echo json_encode($resultado);


               //**************** fin contenido ***************
        }
                                                   
        
    }    
        
    function guardar_preferencia(){
       //if($this->acceso(12)){
               //**************** inicio contenido ***************       
            $preferencia = $this->input->post('preferencia');
            $detalleven_id = $this->input->post('detalleven_id');
               
            $sql = "update detalle_venta_aux set detalleven_preferencia = '".$preferencia."'".
              " where detalleven_id = ".$detalleven_id;           
           //echo $sql;                  
            
           $resultado = $this->Venta_model->ejecutar($sql);
            echo true;

               //**************** fin contenido ***************
         //                              }
        
    }    
        
    function asignar_inventario(){
        //if($this->acceso(12)){
        //**************** inicio contenido ***************       

            $usuario_vendedor = $this->session_data['usuario_id'];
            $usuario_id = $this->input->post('usuario_id');


            $sql =  "delete from inventario_usuario where inventario_fecha = date(now()) and usuario_id = ".$usuario_id;
            $this->Venta_model->ejecutar($sql);
            
            $sql =  "insert into inventario_usuario
                    (producto_id,inventario_costo, inventario_fecha,inventario_hora,inventario_cantidad,inventario_ventas, inventario_pedidos,inventario_devoluciones,inventario_saldo,usuario_id)
                    (select producto_id,detalleven_costo, date(now()),time(now()), detalleven_cantidad , 0, 0, 0, detalleven_cantidad, ".$usuario_id." 
                    from detalle_venta_aux where usuario_id=".$usuario_vendedor.")";
            $this->Venta_model->ejecutar($sql);
            
            echo json_encode(TRUE);


        //**************** fin contenido ***************
        //}
    }   

    function numero_ventas(){
        //if($this->acceso(12)){
        //**************** inicio contenido ***************       

            $usuario_vendedor = $this->session_data['usuario_id'];
            $usuario_id = $this->input->post('usuario_id');


            $sql =  "select count(*)+1 as cantidad from venta where venta_fecha = date(now())";
            $res = $this->Venta_model->consultar($sql);
            
                        
            echo json_encode($res);


        //**************** fin contenido ***************        
    }   
    

    function ejecutar_consulta(){
        //if($this->acceso(12)){
        //**************** inicio contenido ***************       

//            $usuario_vendedor = $this->session_data['usuario_id'];
//            $usuario_id = $this->input->post('usuario_id');

            $sql = $this->input->post('sql');
            $this->Venta_model->ejecutar($sql);
            
                        
            echo json_encode($res);


        //**************** fin contenido ***************        
    }   
    
    //Muestra la lista de vencimientos
    function vencimientos()
    {
        
        if($this->acceso(30)) {
                
        //**************** inicio contenido ***************            
        $usuario_id = $this->session_data['usuario_id'];
        $usuario_nombre = $this->session_data['usuario_nombre'];
        $tipousuario_id = $this->session_data['tipousuario_id'];
        
        $rolusuario = $this->session_data['rol'];

        $data['esrol'] = $rolusuario[33-1]['rolusuario_asignado'];
        $data['esrolconsolidar'] = $rolusuario[35-1]['rolusuario_asignado'];
        $data['empresa'] = $this->Empresa_model->get_empresa(1); 
        
        $data['page_title'] = "Vencimientos"
                . "";
        $data['usuario'] = $this->Usuario_model->get_todos_usuario(); // para el select
        $data['usuario_id'] = $usuario_id; //el usuario logueado
        
        $data['tipousuario_id'] = $tipousuario_id; 
        $data['usuario_nombre'] = $usuario_nombre;
        
        $data['estado'] = $this->Estado_model->get_tipo_estado(5);
        
        $data['_view'] = 'venta/vencimientos';
        $this->load->view('layouts/main',$data);
        //**************** fin contenido ***************
        }    
    }
    
    function lista_vencimientos(){
        
        if($this->acceso(12)){
        //**************** inicio contenido ***************       
        
            $fecha_desde = $this->input->post("fecha_desde");
            $fecha_hasta = $this->input->post("fecha_hasta");
            $usuario_id = $this->input->post("usuario_id");

            $resultado = $this->Venta_model->get_vencimientos($fecha_desde,$fecha_hasta,$usuario_id);
            echo json_encode($resultado);
        }
        else
        {
            $data['_view'] = 'login/mensajeacceso';
            $this->load->view('layouts/main',$data);
        }
        
   }

    //Muestra la lista de vencimientos
    function prestamos()
    {
        
        if($this->acceso(30)) {
                
        //**************** inicio contenido ***************            
        $usuario_id = $this->session_data['usuario_id'];
        $usuario_nombre = $this->session_data['usuario_nombre'];
        $tipousuario_id = $this->session_data['tipousuario_id'];
        
        $rolusuario = $this->session_data['rol'];

        $data['esrol'] = $rolusuario[33-1]['rolusuario_asignado'];
        $data['esrolconsolidar'] = $rolusuario[35-1]['rolusuario_asignado'];
        $data['empresa'] = $this->Empresa_model->get_empresa(1); 
        
        $data['page_title'] = "Vencimientos"
                . "";
        $data['usuario'] = $this->Usuario_model->get_todos_usuario(); // para el select
        //$data['tipo_transaccion'] = $this->Tipo_transaccion_model->get_all_tipo(); //para el select
        $data['usuario_id'] = $usuario_id; //el usuario logueado
        
        $data['tipousuario_id'] = $tipousuario_id; 
        $data['usuario_nombre'] = $usuario_nombre;
        

        
        //$data['pedidosn'] = $this->Pedido_model->get_pedido_sin_nombre($usuario_id);
        $data['estado'] = $this->Estado_model->get_tipo_estado(5);
        
        $data['_view'] = 'venta/prestamos';
        $this->load->view('layouts/main',$data);
        //**************** fin contenido ***************
        }    
    }
    
    function lista_prestamos(){
        
        if($this->acceso(12)){
        //**************** inicio contenido ***************       
        
            $fecha_desde = $this->input->post("fecha_desde");
            $fecha_hasta = $this->input->post("fecha_hasta");
            $usuario_id = $this->input->post("usuario_id");
            $tipo_prestamo = $this->input->post("tipo_prestamo");
            $kardex = $this->input->post("kardex");
            $producto_id = $this->input->post("producto_id");
            
            if($kardex == 0){
                if ($tipo_prestamo==1)
                    $resultado = $this->Venta_model->get_prestamos($fecha_desde,$fecha_hasta,$usuario_id);
                else
                    $resultado = $this->Venta_model->get_devoluciones($fecha_desde,$fecha_hasta,$usuario_id);
            }
            else{
                    $resultado = $this->Venta_model->get_kardex($producto_id);
            }
            
            echo json_encode($resultado);
        }
        else
        {
            $data['_view'] = 'login/mensajeacceso';
            $this->load->view('layouts/main',$data);
        }
        
   }   

   function registrar_devolucion(){
        
        if($this->acceso(12)){
        //**************** inicio contenido ***************       
            $usuario_id = $this->session_data['usuario_id'];
            $detalleven_id = $this->input->post("detalleven_id");
            $cantidad = $this->input->post("detalleven_cantidadenvase");
            $garantia = $this->input->post("detalleven_garantiaenvase");

            $sql = "update detalle_venta set".
                    " detalleven_devueltoenvase = ".$cantidad.
                    ",detalleven_montodevolucion = ".$garantia.
                    ",detalleven_fechadevolucion = date(now()) ".
                    ",detalleven_horadevolucion = time(now()) ".
                    ",detalleven_usuario_id = ".$usuario_id.
                    " where detalleven_id = ".$detalleven_id;
            
            $this->Venta_model->ejecutar($sql);
            return true;
        }
        else
        {
            $data['_view'] = 'login/mensajeacceso';
            $this->load->view('layouts/main',$data);
        }
        
   }
   /* genera factura desde el index de ventas  */
   function generar_factura_detalle_aux()
    {
        if($this->acceso(12)){
            //$dosificacion = $this->Dosificacion_model->get_dosificacion_activa();
            $dosificacion = $this->Dosificacion_model->get_dosificacion(1);

            $usuario_id = $this->session_data['usuario_id'];
            
            $venta_id = $this->input->post('venta_id');
            
            $nit_factura = $this->input->post('nit');
            $razon_social = $this->input->post('razon');
            
            $tipotrans_id = 1;
            $monto_factura = $this->input->post('monto_factura');
            
            $numero_factura = $dosificacion["dosificacion_numfact"]+1;
            $estado_id = 1;
            $fecha_venta = date('Y-m-d');
            $factura_fechaventa = $fecha_venta;
            $factura_fecha = "date(now())";
            $factura_hora = "time(now())";
            $factura_subtotal = $monto_factura;
            $factura_ice = 0;
            $factura_exento = 0;
            $factura_descuento = 0;
            $factura_total = $monto_factura;
            $factura_numero = $numero_factura;
            $factura_autorizacion = $dosificacion["dosificacion_autorizacion"];
            $factura_llave = $dosificacion["dosificacion_llave"];
            $factura_fechalimite = $dosificacion["dosificacion_fechalimite"];
            $factura_leyenda1 = $dosificacion["dosificacion_leyenda1"];
            $factura_leyenda2 = $dosificacion["dosificacion_leyenda2"];
            $factura_nit = $nit_factura;
            $factura_razonsocial = $razon_social;
            $factura_nitemisor = $dosificacion["dosificacion_nitemisor"];
            $factura_sucursal = $dosificacion["dosificacion_sucursal"];
            $factura_sfc = $dosificacion["dosificacion_sfc"];
            $factura_actividad = $dosificacion["dosificacion_actividad"];
            
            $factura_efectivo = $factura_total;
            $factura_cambio = 0;
          
            $factura_codigocontrol = $this->codigo_control($factura_llave, $factura_autorizacion, $factura_numero, $factura_nit, $factura_fechaventa, $factura_total);
            
            $sql = "update dosificacion set dosificacion_numfact = ".$factura_numero;
            $this->Venta_model->ejecutar($sql);
            
            $sql = "insert into factura(estado_id, factura_fechaventa, 
                    factura_fecha, factura_hora, factura_subtotal, 
                    factura_ice, factura_exento, factura_descuento, factura_total, 
                    factura_numero, factura_autorizacion, factura_llave, 
                    factura_fechalimite, factura_codigocontrol, factura_leyenda1, factura_leyenda2,
                    factura_nit, factura_razonsocial, factura_nitemisor, factura_sucursal, factura_sfc, factura_actividad, usuario_id, venta_id,
                    factura_efectivo, factura_cambio, tipotrans_id) value(".
                    $estado_id.",'".$factura_fechaventa."',".
                    $factura_fecha.",".$factura_hora.",".$factura_subtotal.",".
                    $factura_ice.",".$factura_exento.",".$factura_descuento.",".$factura_total.",".
                    $factura_numero.",".$factura_autorizacion.",'".$factura_llave."','".
                    $factura_fechalimite."','".$factura_codigocontrol."','".$factura_leyenda1."','".$factura_leyenda2."',".
                    $factura_nit.",'".$factura_razonsocial."','".$factura_nitemisor."','".
                    $factura_sucursal."','".$factura_sfc."','".$factura_actividad."',".$usuario_id.",".$venta_id.",".
                    $factura_efectivo.",".$factura_cambio.",".$tipotrans_id.")";

            $factura_id = $this->Venta_model->ejecutar($sql);
            
            $this->load->model('Detalle_factura_aux_model');
            $all_detalle_factura_aux = $this->Detalle_factura_aux_model->getall_detalle_factura_aux($venta_id);
            foreach($all_detalle_factura_aux as $detalle_fact){
                $params = array(
                'producto_id' => $detalle_fact['producto_id'],
                'venta_id' => $detalle_fact['venta_id'],
                'factura_id' => $factura_id,
                'detallefact_cantidad' => $detalle_fact['detallefact_cantidad'],
                'detallefact_codigo' => $detalle_fact['detallefact_codigo'],
                'detallefact_unidad' => $detalle_fact['detallefact_unidad'],
                'detallefact_descripcion' => $detalle_fact['detallefact_descripcion'],
                'detallefact_precio' => $detalle_fact['detallefact_precio'],
                'detallefact_subtotal' => $detalle_fact['detallefact_subtotal'],
                'detallefact_descuento' => $detalle_fact['detallefact_descuento'],
                'detallefact_total' => $detalle_fact['detallefact_total'],
                'detallefact_preferencia' => $detalle_fact['detallefact_preferencia'],
                'detallefact_caracteristicas' => $detalle_fact['detallefact_caracteristicas'],
                'usuario_id' => $usuario_id,
            );
            $detallefact_id = $this->Detalle_factura_aux_model->add_detalle_factura_aux($params);
            }
            
            $this->Detalle_factura_aux_model->delete_detalleventa_factura_aux($venta_id);
                       
            
            
            if($venta_id>0){
                $sql = "update venta set venta_tipodoc = 1 where venta_id = ".$venta_id;
                $this->Venta_model->ejecutar($sql);
            }
            
            echo json_encode($factura_id);
        //**************** fin contenido ***************
        }
    }
    /* genera factura desde el index de servicios con sus detalles */
    function generar_factura_detalle_servicio()
    {
        if($this->acceso(12)){
            //$dosificacion = $this->Dosificacion_model->get_dosificacion_activa();
            $dosificacion = $this->Dosificacion_model->get_dosificacion(1);

            $usuario_id = $this->session_data['usuario_id'];
            
            //$venta_id = $this->input->post('venta_id');
            
            $nit_factura = $this->input->post('nit');
            $razon_social = $this->input->post('razon_social');
            
            $llave_foranea = $this->input->post('llave_foranea');            
            $llave_valor = $this->input->post('llave_valor');
            
            $tipotrans_id = 1;
            if ($llave_foranea=="venta_id"){
                $venta_id = $llave_valor;
            }
            else{
                $venta_id = 0;
            }
            $monto_factura = $this->input->post('detalle_precio');
            
            $numero_factura = $dosificacion["dosificacion_numfact"]+1;
            $estado_id = 1;
            $fecha_venta = date('Y-m-d');
            $factura_fechaventa = $fecha_venta;
            $factura_fecha = "date(now())";
            $factura_hora = "time(now())";
            $factura_subtotal = $monto_factura;
            $factura_ice = 0;
            $factura_exento = 0;
            $factura_descuento = 0;
            $factura_total = $monto_factura;
            $factura_numero = $numero_factura;
            $factura_autorizacion = $dosificacion["dosificacion_autorizacion"];
            $factura_llave = $dosificacion["dosificacion_llave"];
            $factura_fechalimite = $dosificacion["dosificacion_fechalimite"];
            $factura_leyenda1 = $dosificacion["dosificacion_leyenda1"];
            $factura_leyenda2 = $dosificacion["dosificacion_leyenda2"];
            $factura_nit = $nit_factura;
            $factura_razonsocial = $razon_social;
            $factura_nitemisor = $dosificacion["dosificacion_nitemisor"];
            $factura_sucursal = $dosificacion["dosificacion_sucursal"];
            $factura_sfc = $dosificacion["dosificacion_sfc"];
            $factura_actividad = $dosificacion["dosificacion_actividad"];
            
            $factura_efectivo = $factura_total;
            $factura_cambio = 0;
          
            $factura_codigocontrol = $this->codigo_control($factura_llave, $factura_autorizacion, $factura_numero, $factura_nit, $factura_fechaventa, $factura_total);
            
            $sql = "update dosificacion set dosificacion_numfact = ".$factura_numero;
            $this->Venta_model->ejecutar($sql);
            
            $sql = "insert into factura(estado_id, factura_fechaventa, 
                    factura_fecha, factura_hora, factura_subtotal, 
                    factura_ice, factura_exento, factura_descuento, factura_total, 
                    factura_numero, factura_autorizacion, factura_llave, 
                    factura_fechalimite, factura_codigocontrol, factura_leyenda1, factura_leyenda2,
                    factura_nit, factura_razonsocial, factura_nitemisor, factura_sucursal, factura_sfc, factura_actividad, usuario_id, ".$llave_foranea.",
                    factura_efectivo, factura_cambio, tipotrans_id) value(".
                    $estado_id.",'".$factura_fechaventa."',".
                    $factura_fecha.",".$factura_hora.",".$factura_subtotal.",".
                    $factura_ice.",".$factura_exento.",".$factura_descuento.",".$factura_total.",".
                    $factura_numero.",".$factura_autorizacion.",'".$factura_llave."','".
                    $factura_fechalimite."','".$factura_codigocontrol."','".$factura_leyenda1."','".$factura_leyenda2."',".
                    $factura_nit.",'".$factura_razonsocial."','".$factura_nitemisor."','".
                    $factura_sucursal."','".$factura_sfc."','".$factura_actividad."',".$usuario_id.",".$llave_valor.",".
                    $factura_efectivo.",".$factura_cambio.",".$tipotrans_id.")";

            $factura_id = $this->Venta_model->ejecutar($sql);
            
            $this->load->model('Detalle_serv_model');
            $all_detalle_servicio_factura = $this->Detalle_serv_model->get_thisdetalle_serv_forfactura($llave_valor);
            //$all_detalle_factura_aux = $this->Detalle_factura_aux_model->getall_detalle_factura_aux($venta_id);
            $parametro_serviciofact = $this->input->post('parametro_serviciofact');
            $detalle_servfact = "";
            foreach($all_detalle_servicio_factura as $detalle_fact){
                if($parametro_serviciofact == 1){
                    $detalle_servfact = $detalle_fact['detalleserv_solucion'];
                }elseif($parametro_serviciofact == 2){
                    $detalle_servfact = $detalle_fact['detalleserv_descripcion'];
                }elseif($parametro_serviciofact == 3){
                    $detalle_servfact = $detalle_fact['detalleserv_solucion'].", ".$detalle_fact['detalleserv_descripcion'];
                }elseif($parametro_serviciofact == 4){
                    $detalle_servfact = $detalle_fact['detalleserv_descripcion'].", ".$detalle_fact['detalleserv_solucion'];
                }
                $params = array(
                'producto_id' => 0,
                'venta_id' => 0,
                'factura_id' => $factura_id,
                'detallefact_cantidad' => 1,
                'detallefact_codigo' => '',
                'detallefact_unidad' => 'UNIDAD',
                'detallefact_descripcion' => $detalle_servfact,
                'detallefact_precio' => 0,
                'detallefact_subtotal' => $detalle_fact['detalleserv_total'],
                'detallefact_descuento' => 0,
                'detallefact_total' => $detalle_fact['detalleserv_total'],
                'detallefact_preferencia' => '',
                'detallefact_caracteristicas' => '',
                'usuario_id' => $usuario_id,
            );
                
            $this->load->model('Detalle_factura_aux_model');
            $detallefact_id = $this->Detalle_factura_aux_model->add_detalle_factura_aux($params);
            }
            

                       
            
            
            if($venta_id>0){
                $sql = "update venta set venta_tipodoc = 1 where venta_id = ".$venta_id;
                $this->Venta_model->ejecutar($sql);
            }
            
            echo json_encode($factura_id);
      
        //**************** fin contenido ***************
        }
    }
}
