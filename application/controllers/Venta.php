<?php
/* 
 * Generated by CRUDigniter v3.2 
 * www.crudigniter.com.
 */
 
class Venta extends CI_Controller{
    function __construct()
    {
        parent::__construct();
        $this->load->model('Venta_model');
        $this->load->model('Inventario_model');
        $this->load->model('Pedido_model');
        $this->load->model('Tipo_transaccion_model');
        $this->load->model('Forma_pago_model');
        $this->load->model('Pedido_model');
        $this->load->model('Tipo_cliente_model');
        $this->load->model('Dosificacion_model');
        $this->load->model('Factura_model'); 
        $this->load->library('ControlCode');
        $this->load->model('Empresa_model');
        $this->load->model('Detalle_venta_model');
        $this->load->model('Parametro_model');
        $this->load->model('Estado_model');
        $this->load->model('Usuario_model');
        $this->load->model('Cliente_model');
    } 

    /*
     * Listing of venta
     */
    function index()
    {

        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        //**************** inicio contenido ***************
		
        
        
//        $params['limit'] = RECORDS_PER_PAGE;
//        $params['offset'] = ($this->input->get('per_page')) ? $this->input->get('per_page') : 0;
//        
//        $config = $this->config->item('pagination');
//        $config['base_url'] = site_url('venta/index?');
//        $config['total_rows'] = $this->Venta_model->get_all_venta_count();
//        $this->pagination->initialize($config);

       
        //$data['venta'] = $this->Venta_model->get_all_venta($params);
        $data['parametro'] = $this->Parametro_model->get_parametros();
        $data['estado'] = $this->Estado_model->get_tipo_estado(1);
        $data['usuario'] = $this->Venta_model->get_usuarios();
        
        $data['_view'] = 'venta/index';
        $this->load->view('layouts/main',$data);
        
		
		
        //**************** fin contenido ***************
			}
			else{ redirect('alerta'); }
        } else { redirect('', 'refresh'); }    
        
    }

    function ventas()
    {    
        
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        //**************** inicio contenido ***************        
        
        $usuario_id = $session_data['usuario_id'];
        $tipousuario_id = $session_data['tipousuario_id'];
        
//        $params['limit'] = RECORDS_PER_PAGE; 
//        $params['offset'] = ($this->input->get('per_page')) ? $this->input->get('per_page') : 0;
        //$data['cliente'] = $this->Venta_model->get_all_cliente();
        //$data['inventario'] = $this->Inventario_model->get_inventario_bloque();
        //$data['presentacion'] = $this->Inventario_model->get_presentacion();  
        //$data['detalle_venta'] = $this->Venta_model->get_detalle_aux($usuario_id);

        $data['page_title'] = "Ventas";
        
        $data['dosificacion'] = $this->Dosificacion_model->get_all_dosificacion();
        $data['pedidos'] = $this->Pedido_model->get_pedidos_activos();
        $data['cliente'] = $this->Venta_model->get_cliente_inicial();
        $data['categoria_producto'] = $this->Venta_model->get_categoria_producto();
        $data['tipo_transaccion'] = $this->Tipo_transaccion_model->get_all_tipo();
        $data['forma_pago'] = $this->Forma_pago_model->get_all_forma();
        $data['tipo_cliente'] = $this->Tipo_cliente_model->get_all_tipo_cliente();
        $data['parametro'] = $this->Parametro_model->get_parametros();
        $data['usuario_id'] = $usuario_id;
        $data['tipousuario_id'] = $tipousuario_id;
        
        //$data['venta'] = $this->Venta_model->get_all_venta($usuario_id);
        
        $data['_view'] = 'venta/ventas';
        $this->load->view('layouts/main',$data);
        		
        //**************** fin contenido ***************
        			}
        			else{ redirect('alerta'); }
        } else { redirect('', 'refresh'); }        
        
    }
    function ventas_cliente($cliente_id)
    {    
        
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        //**************** inicio contenido ***************        
        
        $usuario_id = $session_data['usuario_id'];
        $tipousuario_id = $session_data['tipousuario_id'];
        
//        $params['limit'] = RECORDS_PER_PAGE; 
//        $params['offset'] = ($this->input->get('per_page')) ? $this->input->get('per_page') : 0;
        //$data['cliente'] = $this->Venta_model->get_all_cliente();
        //$data['inventario'] = $this->Inventario_model->get_inventario_bloque();
        //$data['presentacion'] = $this->Inventario_model->get_presentacion();  
        //$data['detalle_venta'] = $this->Venta_model->get_detalle_aux($usuario_id);
        $data['page_title'] = "Ventas";
        $data['pedidos'] = $this->Pedido_model->get_pedidos_activos();
        $data['cliente'] = $this->Cliente_model->get_cliente_by_id($cliente_id);
        $data['categoria_producto'] = $this->Venta_model->get_categoria_producto();
        $data['tipo_transaccion'] = $this->Tipo_transaccion_model->get_all_tipo();
        $data['forma_pago'] = $this->Forma_pago_model->get_all_forma();
        $data['tipo_cliente'] = $this->Tipo_cliente_model->get_all_tipo_cliente();
        $data['parametro'] = $this->Parametro_model->get_parametros();
        $data['usuario_id'] = $usuario_id;
        $data['tipousuario_id'] = $tipousuario_id;
        
        //$data['venta'] = $this->Venta_model->get_all_venta($usuario_id);
        
        $data['_view'] = 'venta/ventas';
        $this->load->view('layouts/main',$data);
        		
        //**************** fin contenido ***************
        			}
        			else{ redirect('alerta'); }
        } else { redirect('', 'refresh'); }        
        
    }

    function ingresar_detalle()
    {       
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        //**************** inicio contenido ***************        
  
        $usuario_id = $session_data['usuario_id'];
        
        $producto_id = $this->input->post('producto_id');
        $cantidad = $this->input->post('cantidad');
        $existencia = $this->input->post('existencia');
        $sql1 = $this->input->post('sql1');
        $sql2 = $this->input->post('sql2');
        $descuento = 0;
        
        $sql = "select if(sum(detalleven_cantidad)+".$cantidad.">".$existencia.",1,0) as resultado from detalle_venta_aux where producto_id = ".$producto_id;

        $resultado = $this->Venta_model->consultar($sql);
        
        
        if ($resultado[0]['res<ultado']==0){ //si la cantidad aun es menor al inventario                   
            if ($this->Venta_model->existe($producto_id,$usuario_id)){
                $sql = $sql2;             
            }
            else{
                $sql = $sql1;
            }

           
            $this->Venta_model->ejecutar($sql);
            
            $result = 1;
            echo '[{"cliente_id":"'.$result.'"}]';
            
        }
        else { $result = 0;  echo '[{"cliente_id":"'.$result.'"}]';}
            
        //**************** fin contenido ***************
        }
        else{ redirect('alerta'); }
        } else { redirect('', 'refresh'); }           
               
    }

    function eliminardetalle()
    {       
         if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        //**************** inicio contenido ***************       
        
        $usuario_id = $session_data['usuario_id'];
        
        $sql =  "delete from detalle_venta_aux where usuario_id=".$usuario_id;
        $this->Venta_model->ejecutar($sql);
        return true;
    
            		
        //**************** fin contenido ***************
        			}
        			else{ redirect('alerta'); }
        } else { redirect('', 'refresh'); }    
        
    }
    
    function codigo_control($dosificacion_llave, $dosificacion_autorizacion, $dosificacion_numfact, $nit,$fecha_trans, $monto)
    {

        //include 'ControlCode.php';

        $code = $this->controlcode->generate($dosificacion_autorizacion,//Numero de autorizacion
                                                   $dosificacion_numfact,//Numero de factura
                                                   $nit,//Número de Identificación Tributaria o Carnet de Identidad
                                                   str_replace('-','',$fecha_trans),//fecha de transaccion de la forma AAAAMMDD
                                                   $monto,//Monto de la transacción
                                                   $dosificacion_llave//Llave de dosificación
                        );        
         return $code;
    }
    
    function registrarventa()
    {  
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        //**************** inicio contenido ***************        
        
        $usuario_id = $session_data['usuario_id'];
        
        $porcentaje = 0;
        $sql = $this->input->post('sql'); // recuperamos la consulta sql enviada mediante JS
        $tipo_transaccion = $this->input->post('tipo_transaccion'); // recuperamos la consulta sql enviada mediante JS
        $cuotas = $this->input->post('cuotas'); // recuperamos la consulta sql enviada mediante JS
        $cuota_inicial = $this->input->post('cuota_inicial'); // recuperamos la consulta sql enviada mediante JS
        $venta_total = $this->input->post('venta_total'); // recuperamos la consulta sql enviada mediante JS
        $credito_interes = $this->input->post('credito_interes'); // interes por ventas
        $pedido_id = $this->input->post('pedido_id'); // interes por ventas
        $nit = $this->input->post('nit'); // nit del cliente
        $razon = $this->input->post('razon'); // nit del cliente
        $fecha_venta = $this->input->post('venta_fecha'); // nit del cliente
        $venta_descuento = $this->input->post('venta_descuento'); // descuento de la venta
        
        $facturado = $this->input->post('facturado'); // si la venta es facturada
        
        $venta_id = $this->Venta_model->ejecutar($sql);// ejecutamos la consulta para registrar la venta y recuperamos venta_id
        
        if (($venta_total+$venta_descuento)>0)
            $porcentaje = $venta_descuento / ($venta_total+$venta_descuento);
        else
            $porcentaje = 0;
            
        $sql =  "insert into detalle_venta
        (producto_id,
          venta_id,
          moneda_id,
          detalleven_codigo,
          detalleven_cantidad,
          detalleven_unidad,
          detalleven_costo,
          detalleven_precio,
          detalleven_subtotal,
          detalleven_descuento,
          detalleven_total,
          detalleven_caracteristicas,
          detalleven_preferencia,
          detalleven_comision,
          detalleven_tipocambio,
          usuario_id
        )


        (SELECT 
          producto_id,
          ".$venta_id." as venta_id,
          moneda_id,
          detalleven_codigo,
          detalleven_cantidad,
          detalleven_unidad,
          detalleven_costo,
          detalleven_precio,
          detalleven_subtotal,
          detalleven_subtotal * ".$porcentaje.",
          detalleven_total - (detalleven_subtotal * ".$porcentaje."),
          detalleven_caracteristicas,
          detalleven_preferencia,
          detalleven_comision,
          detalleven_tipocambio,
          usuario_id
        FROM
          detalle_venta_aux
        WHERE 
          usuario_id=".$usuario_id.")";
        
        //$sqldetalle = $sql;
        $this->Venta_model->ejecutar($sql);// cargar los productos del detalle_aux al detalle_venta
        
        
        //************* reducri inventario
        
        $this->Inventario_model->reducir_inventario_aux($usuario_id);
        
  
        if($tipo_transaccion==2) //Si la transaccion es a credito
        {            
            //$credito_id =  
            $estado_id =  8; //8 pendiente 9 cancelado
            $compra_id =  0;
            $venta_id =  $venta_id;
            $credito_monto =  $venta_total;
            $credito_cuotainicial =  $cuota_inicial;
            $credito_interesproc =  $credito_interes;
            $credito_interesmonto =  $venta_total * $venta_interes; //revisar
            $credito_numpagos =  $cuotas;
            $credito_fechalimite =  "date_add(date(now()), INTERVAL +1 WEEK)";
            $credito_fecha = date('Y-m-d');
            $time = time();
            $credito_hora =  date("H:i:s", $time);
            $credito_tipo = 1; // 1- ventas 2 - compras
         
            $cuotas       = $this->input->post('cuotas');
            $interes       = $this->input->post('interes');
            $modalidad    = $this->input->post('modalidad');
            $dia_pago     = $this->input->post('dia_pago');
            $fecha_inicio = $this->input->post('fecha_inicio');

            
            
            $sql = "insert  into credito(estado_id,compra_id,venta_id,credito_monto,credito_cuotainicial,credito_interesproc,credito_interesmonto,credito_numpagos,credito_fechalimite,credito_fecha,credito_hora,credito_tipo) value(".
                    $estado_id.",".$compra_id.",".$venta_id.",".$credito_monto.",".$credito_cuotainicial.",".$credito_interesproc.",".$credito_interesmonto.",".$credito_numpagos.",'".$credito_fechalimite."','".$credito_fecha."','".$credito_hora."',".$credito_tipo.")";
            $credito_id = $this->Venta_model->ejecutar($sql);// cargar los productos del detalle_aux al detalle_venta

            
            $estado_id =  8; //8 pendiente 9 cancelado
            $cuota_numcuota = 1;
            $cuota_capital = $venta_total - $cuota_inicial;
            $cuota_interes = ($venta_total - $cuota_inicial)*($credito_interes/100);
            $cuota_moradias = 0;
            $cuota_multa = 0;
            $cuota_subtotal =  $venta_total - $cuota_inicial;
            $cuota_descuento = 0;
            $cuota_total = $venta_total - $cuota_inicial+$cuota_interes;
            
            $cuota_cancelado = 0;
            $cuota_fecha = "'1900-01-01'";
            $cuota_hora = "'00:00'";
            $cuota_numercibo =  0;
            $cuota_saldo = $venta_total - $cuota_inicial;
            $cuota_glosa = "''";
            $cuota_saldocredito = $venta_total - $cuota_inicial;
                 
            
//            for ($ncuotas=1; $ncuotas <= $cuotas; $ncuotas++){
//                
//                $sql = "insert into cuota(credito_id,usuario_id,estado_id,cuota_numcuota,cuota_capital,cuota_interes,cuota_moradias,cuota_multa,cuota_subtotal,cuota_descuento,cuota_total,cuota_fechalimite,cuota_cancelado,cuota_fecha,cuota_hora,cuota_numercibo,cuota_saldo,cuota_glosa,cuota_saldocredito) value(".
//                $credito_id.",".$usuario_id.",".$estado_id.",".$cuota_numcuota.",".$cuota_capital.",".$cuota_interes.",".$cuota_moradias.",".$cuota_multa.",".$cuota_subtotal.",".$cuota_descuento.",".$cuota_total.",".$cuota_fechalimite.",".$cuota_cancelado.",".$cuota_fecha.",".$cuota_hora.",".$cuota_numercibo.",".$cuota_saldo.",".$cuota_glosa.",".$cuota_saldocredito.")";
//          
//            }
            
//***********************************************************************************************

//    if ($_POST['tipotrans_id']==2) { // tipotrans_id = 2 : CREDITO
//        
//       $sql = "INSERT INTO credito (estado_id,compra_id,credito_monto,credito_cuotainicial,credito_interesproc,credito_interesmonto,credito_numpagos,credito_tipointeres,credito_fechalimite,credito_fecha,credito_tipo,credito_hora) VALUES (".$estado_id.",".$compra_id.",".$credito_monto.",".$credito_cuotainicial.",".$credito_interesproc.",".$credito_interesmonto.",".$credito_numpagos.",".$credito_tipointeres.",".$credito_fechalimite.",".$credito_fecha.",".$credito_tipo.",".$credito_hora.")"; 
//                    $this->db->query($sql);
//                    $credito_id = $this->db->insert_id();
           
            $dias_mora = 0;
            $multa = 0;
            $descuento = 0;
            $cancelado = 0;
            $credito_monto = $venta_total - $cuota_inicial;
            $numcuota = $cuotas; //numero de cuotas
            $patron = ($numcuota*0.5) + 0.5;
            $cuota_capital = ($credito_monto)/$numcuota;   // bien         
            $fijo = $patron * $credito_monto * ($credito_interes/100/$numcuota);
            $cuota_subtotal = $fijo + $cuota_capital + $dias_mora + $multa;
            $total = $cuota_subtotal - $descuento;
            $saldo_deudor = $credito_monto;
            
            $siguiente= 0;
            $cuota_fechalimite = $fecha_inicio;
           
           // $fecha_inicio = date('YYYY', $fecha_inicio)."-".date('MM', $fecha_inicio)."-".$dia_pago;
            
            $cuota_fechalimite = $fecha_inicio;
            
            
            if ($modalidad == "MENSUAL") $intervalo = 30; //si los pagos son mensuales
            else $intervalo = 7; //si los pagos son semanales
                
            
                for ($i=1; $i <= $numcuota; $i++) { // ciclo para llenar las cuotas
                    $cuota_numcuota = $i;
                    
                    $cuota_fechalimitex = (time() + ($intervalo * $i * 24 * 60 * 60 ));
                    if ($modalidad == "MENSUAL") 
                        $cuota_fechalimite = date('Y-m-'.$dia_pago, $cuota_fechalimitex);
                    else 
                        $cuota_fechalimite = date('Y-m-d', $cuota_fechalimitex); 
                    
                    $cuota ="insert into cuota (credito_id,usuario_id,estado_id,cuota_numcuota,cuota_capital,cuota_interes,cuota_moradias,cuota_multa,cuota_descuento,cuota_cancelado,cuota_total,cuota_subtotal,cuota_fechalimite,cuota_saldo) VALUES (".
                            $credito_id.",".$usuario_id.",".$estado_id.",".$cuota_numcuota.",".$cuota_capital.",".$fijo.",".
                            $dias_mora.",".$multa.",".$descuento.",".$cancelado.",".$total.",".$cuota_subtotal.",'".$cuota_fechalimite."',".$saldo_deudor.")";
                  
                    $this->Venta_model->ejecutar($cuota);

//                    $saldo_deudor = $cuota_total - $cuota_capital;
//                    $cuota_total = $saldo_deudor;
                    $saldo_deudor = $saldo_deudor - $cuota_capital;
                    //$cuota_total = $saldo_deudor;
                }
            

            
        }
              
        if($pedido_id > 0)
        {
            $sql = "update pedido set estado_id = 13  where pedido_id = ".$pedido_id;
            $this->Venta_model->ejecutar($sql);
        }
                
        
        if($facturado=="true"){//si la venta es facturada

            $dosificacion = $this->Dosificacion_model->get_dosificacion_activa();

  //          if (sizeof($dosificacion)>0){ //si existe una dosificacion activa
                
                $estado_id = 1; 
                
                $factura_fechaventa    = $fecha_venta;
                $factura_fecha         = "date(now())";
                $factura_hora          = "time(now())";
                $factura_subtotal = $venta_total;
                $factura_nit           = $nit;
                $factura_razonsocial   = $razon;
                $factura_ice           = 0;
                $factura_exento        = 0;
                $factura_descuento     = 0;
                $factura_total         = $venta_total - $factura_descuento;
                $factura_numero        = $dosificacion[0]['dosificacion_numfact']+1;
                $factura_autorizacion  = $dosificacion[0]['dosificacion_autorizacion'];
                $factura_llave         = $dosificacion[0]['dosificacion_llave'];
                $factura_fechalimite   = $dosificacion[0]['dosificacion_fechalimite'];
                $factura_codigocontrol = $this->codigo_control($factura_llave, $factura_autorizacion, $factura_numero, $nit,$factura_fechaventa, $factura_total);
                $factura_leyenda1       = $dosificacion[0]['dosificacion_leyenda1'];
                $factura_leyenda2       = $dosificacion[0]['dosificacion_leyenda2'];
                $factura_nitemisor     = $dosificacion[0]['dosificacion_nitemisor'];
                $factura_sucursal      = $dosificacion[0]['dosificacion_sucursal'];
                $factura_sfc           = $dosificacion[0]['dosificacion_sfc'];
                $factura_actividad     = $dosificacion[0]['dosificacion_actividad'];

                $sql = "update dosificacion set dosificacion_numfact = ".$factura_numero;
                $this->Venta_model->ejecutar($sql);
                             
                $sql = "insert into factura(estado_id, venta_id, factura_fechaventa, 
                    factura_fecha, factura_hora, factura_subtotal, 
                    factura_ice, factura_exento, factura_descuento, factura_total, 
                    factura_numero, factura_autorizacion, factura_llave, 
                    factura_fechalimite, factura_codigocontrol, factura_leyenda1, factura_leyenda2,
                    factura_nit, factura_razonsocial, factura_nitemisor, factura_sucursal, factura_sfc, factura_actividad) value(".
                    $estado_id.",".$venta_id.",'".$factura_fechaventa."',".
                    $factura_fecha.",".$factura_hora.",".$factura_subtotal.",".
                    $factura_ice.",".$factura_exento.",".$factura_descuento.",".$factura_total.",".
                    $factura_numero.",".$factura_autorizacion.",'".$factura_llave."','".
                    $factura_fechalimite."','".$factura_codigocontrol."','".$factura_leyenda1."','".$factura_leyenda2."',".
                    $factura_nit.",'".$factura_razonsocial."','".$factura_nitemisor."','".
                    $factura_sucursal."','".$factura_sfc."','".$factura_actividad."')";
                $this->Venta_model->ejecutar($sql);
                
                $this->ultimaventa();
       //     }
        }
        
      
        //**************** fin contenido ***************
        }
        else{ redirect('alerta'); }
        } else { redirect('', 'refresh'); }        
        
    }
    
 /* 
 */
    function buscarcodigo()  
    {   
//        
//        if ($this->session->userdata('logged_in')) {
//            $session_data = $this->session->userdata('logged_in');
//            if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
//                $data = array(
//                    'page_title' => 'Admin >> Mi Cuenta'
//                );
//        //**************** inicio contenido ***************        
//        
//        $usuario_id = $session_data['usuario_id'];
        

//        if ($this->input->is_ajax_request()) {       

            $cantidad = 1;        
            $codigo = $this->input->post('codigo');
            $producto = $this->Inventario_model->get_inventario_codigo($codigo);
            
            if (sizeof($producto)>0){
                echo json_encode($producto);
            }
            else
            {
                $producto = $this->Inventario_model->get_inventario_codigo_factor($codigo);                
                echo json_encode($producto);
                
            }
            
            
            
//        }  
//        else {$arreglo =  '[{"existencia":"-1"}]'; echo  $arreglo; }//no existe el producto
        
            //
//            if (sizeof($producto)>0){
//                //echo $producto[0]['producto_nombre']." ".$producto[0]['existencia'];
//                $producto_id = $producto[0]['producto_id'];
//                $existencia = $producto[0]['existencia'];
//                
//                $sql =  "select if(sum(detalleven_cantidad)>0,sum(detalleven_cantidad),0) as cantidad from detalle_venta_aux "
//                               . " where producto_id =".$producto_id;
//
//                $resultado = $this->Venta_model->consultar($sql);
//                
//                $cantidad = $resultado[0]['cantidad'] + 1;              
//                
//                $result = 0;
//                
//                if($cantidad<=$existencia){        
//                
//                    if (!$this->Venta_model->existe($producto_id,$usuario_id)){ //Si el producto no existe en el detalle
//
//                        $resultado =  $this->Venta_model->agregarxcodigo($usuario_id,$producto_id,$cantidad);
//                        //redirect('venta/ventas');
//                        $arreglo = '[{"resultado":"1"}]';
//                        echo $arreglo;//el producto se ingreso correctamente
//
//                    }
//                    else{
//
//                        $resultado = $this->Venta_model->incrementar($usuario_id,$producto_id,$cantidad);
//                        //redirect('venta/ventas');
//                        echo $arreglo; //el producto se ingreso correctamente
//
//                    }
//                
//                }
//                else {  $arreglo =  '[{"resultado":"0"}]'; echo $arreglo;}//la cantidad exece el invetario
//                
//                
//            }
//            else {$arreglo =  '[{"resultado":"-1"}]'; echo  $arreglo; }//no existe el producto
//            
//        }
//        else
//        {  $arreglo =  '[{"resultado":"-1"}]';               
//           echo $arreglo; //no existe el producto
//        }  
                       
        		
        //**************** fin contenido ***************
//            }
//            else{ redirect('alerta'); }
//        } else { redirect('', 'refresh'); }

    }

    /*
     * Adding a new venta
     */
    function add()
    {   
        
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        //**************** inicio contenido ***************        
        
        if(isset($_POST) && count($_POST) > 0)     
        {   
            $params = array(
				'forma_id' => $this->input->post('forma_id'),
				'tipotrans_id' => $this->input->post('tipotrans_id'),
				'usuario_id' => $this->input->post('usuario_id'),
				'cliente_id' => $this->input->post('cliente_id'),
				'moneda_id' => $this->input->post('moneda_id'),
				'estado_id' => $this->input->post('estado_id'),
				'venta_fecha' => $this->input->post('venta_fecha'),
				'venta_hora' => $this->input->post('venta_hora'),
				'venta_subtotal' => $this->input->post('venta_subtotal'),
				'venta_descuento' => $this->input->post('venta_descuento'),
				'venta_total' => $this->input->post('venta_total'),
				'venta_efectivo' => $this->input->post('venta_efectivo'),
				'venta_cambio' => $this->input->post('venta_cambio'),
				'venta_glosa' => $this->input->post('venta_glosa'),
				'venta_comision' => $this->input->post('venta_comision'),
				'venta_tipocambio' => $this->input->post('venta_tipocambio'),
            );
            
            $venta_id = $this->Venta_model->add_venta($params);
            redirect('venta/index');
        }
        else
        {
            $this->load->model('Forma_pago_model');
            $data['all_forma_pago'] = $this->Forma_pago_model->get_all_forma_pago();

            $this->load->model('Tipo_transaccion_model');
            $data['all_tipo_transaccion'] = $this->Tipo_transaccion_model->get_all_tipo_transaccion();

            $this->load->model('Cliente_model');
            $data['all_cliente'] = $this->Cliente_model->get_all_cliente();
            $data['all_cliente'] = $this->Cliente_model->get_all_cliente();

            $this->load->model('Moneda_model');
            $data['all_moneda'] = $this->Moneda_model->get_all_moneda();

            $this->load->model('Estado_model');
            $data['all_estado'] = $this->Estado_model->get_all_estado();
            
            $data['_view'] = 'venta/add';
            $this->load->view('layouts/main',$data);
        }
        
        		
        //**************** fin contenido ***************
        			}
        			else{ redirect('alerta'); }
        } else { redirect('', 'refresh'); }        
        
    }  

    /*
     * Editing a venta
     */
function edit($venta_id)
    {   
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        //**************** inicio contenido ***************      
      
        // check if the venta exists before trying to edit it
        $venta = $this->Venta_model->get_venta($venta_id);
        
        $data['venta'] = $venta;//$this->Venta_model->get_venta($venta_id);
        $cliente_id = $venta["cliente_id"];
       
        //echo "Cliente: ".$cliente_id;
        if(isset($data['venta']['venta_id']))
        {
            if(isset($_POST) && count($_POST) > 0)     
            {
                $venta_fecha = implode("-", array_reverse(explode("/", $this->input->post('venta_fecha'))));
                $params = array(
                    'forma_id' => $this->input->post('forma_id'),
                    'tipotrans_id' => $this->input->post('tipotrans_id'),
                    'usuario_id' => $this->input->post('usuario_id'),
                    'cliente_id' => $this->input->post('cliente_id'),
                    'moneda_id' => $this->input->post('moneda_id'),
                    'estado_id' => $this->input->post('estado_id'),
                    'venta_fecha' => $venta_fecha,
                    'venta_hora' => $this->input->post('venta_hora'),
                    'venta_subtotal' => $this->input->post('venta_subtotal'),
                    'venta_descuento' => $this->input->post('venta_descuento'),
                    'venta_total' => $this->input->post('venta_total'),
                    'venta_efectivo' => $this->input->post('venta_efectivo'),
                    'venta_cambio' => $this->input->post('venta_cambio'),
                    'venta_glosa' => $this->input->post('venta_glosa'),
                    'venta_comision' => $this->input->post('venta_comision'),
                    'venta_tipocambio' => $this->input->post('venta_tipocambio'),
                );

                $this->Venta_model->update_venta($venta_id,$params);            
                redirect('venta/index');
            }
            else
            {
                $this->load->model('Forma_pago_model');
                $data['all_forma_pago'] = $this->Forma_pago_model->get_all_forma_pago();

                $this->load->model('Tipo_transaccion_model');
                $data['all_tipo_transaccion'] = $this->Tipo_transaccion_model->get_all_tipo_transaccion();

                $this->load->model('Cliente_model');
                $data['all_cliente'] = $this->Cliente_model->get_cliente_by_id($cliente_id);

                $this->load->model('Moneda_model');
                $data['all_moneda'] = $this->Moneda_model->get_all_moneda();

                $this->load->model('Usuario_model');
                $data['all_usuario'] = $this->Usuario_model->get_all_usuario();
                
                $this->load->model('Estado_model');
                $data['all_estado'] = $this->Estado_model->get_all_estado_activo_inactivo();

                $data['_view'] = 'venta/edit';
                $this->load->view('layouts/main',$data);
            }
        }
        else
            show_error('The venta you are trying to edit does not exist.');
            
            		
        //**************** fin contenido ***************
        			}
        			else{ redirect('alerta'); }
        } else { redirect('', 'refresh'); }
    } 
    
    /*
     * Deleting venta
     */
    
    function nota_venta($venta_id)
    {
        $data['venta'] = $this->Detalle_venta_model->get_venta($venta_id);
        $data['detalle_venta'] = $this->Detalle_venta_model->get_detalle_venta($venta_id);        
        $data['empresa'] = $this->Empresa_model->get_empresa(1);        
        $data['page_title'] = "Nota de venta";        
        
        $data['_view'] = 'venta/nota_venta';
        $this->load->view('layouts/main',$data);    
       
    }
    
    
    /*
     * Modulo paramodificar una venta
     */
    
    function modificar_venta($venta_id)
    {
        
        
           if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        //**************** inicio contenido ***************      
        $usuario_id = $session_data['usuario_id'];
        $tipousuario_id = $session_data['tipousuario_id'];
        
                // check if the venta exists before trying to edit it
        $venta = $this->Venta_model->get_venta($venta_id);
        
        $data['venta'] = $venta;//$this->Venta_model->get_venta($venta_id);
        $cliente_id = $venta["cliente_id"];
       
        
        $data['page_title'] = "Modificar venta";
        $data['pedidos'] = $this->Pedido_model->get_pedidos_activos();
        $data['cliente'] = $this->Cliente_model->get_cliente_by_id($cliente_id);
        $data['categoria_producto'] = $this->Venta_model->get_categoria_producto();
        $data['tipo_transaccion'] = $this->Tipo_transaccion_model->get_all_tipo();
        $data['forma_pago'] = $this->Forma_pago_model->get_all_forma();
        $data['tipo_cliente'] = $this->Tipo_cliente_model->get_all_tipo_cliente();
        $data['parametro'] = $this->Parametro_model->get_parametros();
        $data['usuario_id'] = $usuario_id;
        $data['tipousuario_id'] = $tipousuario_id;              
                
        //**************** inicio contenido ***************     
                
       
        $data['venta_id'] = $venta_id;
        $data['venta'] = $this->Detalle_venta_model->get_venta($venta_id);
        $data['detalle_venta'] = $this->Detalle_venta_model->cargar_detalle_venta($venta_id, $usuario_id);        
        $data['empresa'] = $this->Empresa_model->get_empresa(1);        
        $data['page_title'] = "Nota de venta";        
        
        $data['_view'] = 'venta/modificar_venta';
        $this->load->view('layouts/main',$data);    
  
        //**************** fin contenido ***************
                }
                else{ redirect('alerta'); }
        } else { redirect('', 'refresh'); }
        
    }
    
    function modificar_detalle()
    {
        
        
           if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        //**************** inicio contenido ***************      

                
        $usuario_id = $session_data['usuario_id'];
        $venta_id = $this->input->post('venta_id');
        $cliente_id = $this->input->post('cliente_id');
        $venta_fecha = $this->input->post('venta_fecha');
        $venta_subtotal = $this->input->post('venta_subtotal');
        $venta_descuento = $this->input->post('venta_descuento');
        $venta_total = $this->input->post('venta_total');
        $venta_efectivo = $this->input->post('venta_efectivo');
        $venta_cambio = $this->input->post('venta_cambio');
        
        $porcentaje = 0;
        
        $sql = "delete from detalle_venta where venta_id=".$venta_id;
        $this->Venta_model->ejecutar($sql);
        
        $sql =  "insert into detalle_venta
                (producto_id,
                  venta_id,
                  moneda_id,
                  detalleven_codigo,
                  detalleven_cantidad,
                  detalleven_unidad,
                  detalleven_costo,
                  detalleven_precio,
                  detalleven_subtotal,
                  detalleven_descuento,
                  detalleven_total,
                  detalleven_caracteristicas,
                  detalleven_preferencia,
                  detalleven_comision,
                  detalleven_tipocambio,
                  usuario_id
                )


                (SELECT 
                  producto_id,
                  ".$venta_id." as venta_id,
                  moneda_id,
                  detalleven_codigo,
                  detalleven_cantidad,
                  detalleven_unidad,
                  detalleven_costo,
                  detalleven_precio,
                  detalleven_subtotal,
                  detalleven_subtotal * ".$porcentaje.",
                  detalleven_total - (detalleven_subtotal * ".$porcentaje."),
                  detalleven_caracteristicas,
                  detalleven_preferencia,
                  detalleven_comision,
                  detalleven_tipocambio,
                  usuario_id
                FROM
                  detalle_venta_aux
                WHERE 
                  usuario_id=".$usuario_id.")";
        $this->Venta_model->ejecutar($sql);        
        
        $sql = "update venta set ".
                "cliente_id = ".$cliente_id.
                ",venta_fecha = '".$venta_fecha."'".
                ",venta_subtotal = ".$venta_subtotal.
                ",venta_descuento = ".$venta_descuento.
                ",venta_total = ".$venta_total.
                ",venta_efectivo = ".$venta_efectivo.
                ",venta_cambio = ".$venta_cambio.                
                " where venta_id = ".$venta_id;
        
        $this->Venta_model->ejecutar($sql);        
        
        $sql = "delete from detalle_venta_aux where usuario_id = ".$usuario_id;
        $this->Venta_model->ejecutar($sql);        
        
        
        //**************** inicio contenido ***************     
                  
        //**************** fin contenido ***************
                }
                else{ redirect('alerta'); }
        } else { redirect('', 'refresh'); }       
    }
    
    
    function remove($venta_id)
    {
        
           if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        //**************** inicio contenido ***************     
        
        $venta = $this->Venta_model->get_venta($venta_id);

        // check if the venta exists before trying to delete it
        if(isset($venta['venta_id']))
        {
            $this->Venta_model->delete_venta($venta_id);
            redirect('venta/index');
        }
        else
            show_error('The venta you are trying to delete does not exist.');
            		
        //**************** fin contenido ***************
        			}
        			else{ redirect('alerta'); }
        } else { redirect('', 'refresh'); }
    }

    /*
     * Eliminar item de detalle
     */
    function eliminaritem($detalleven_id)
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        //**************** inicio contenido ***************        

        $sql = "delete from detalle_venta_aux where detalleven_id = ".$detalleven_id;
        $this->Venta_model->ejecutar($sql);
        return true;
            		
        //**************** fin contenido ***************
        			}
        			else{ redirect('alerta'); }
        } else { redirect('', 'refresh'); }
        
    }

    /*
     * Eliminar todos los items
     */
    function eliminartodo()
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        //**************** inicio contenido ***************        
        $usuario_id = $session_data['usuario_id'];
        $sql = "delete from detalle_venta_aux where usuario_id = ".$usuario_id;
        $this->Venta_model->ejecutar($sql);
        return true;
            		
        //**************** fin contenido ***************
        			}
        			else{ redirect('alerta'); }
        } else { redirect('', 'refresh'); }
        
    }
    /*
     * incrementar cantidad de productos en el detalle
     */
    function incrementar()
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        //**************** inicio contenido ***************        
        
        $detalleven_id = $this->input->post('detalleven_id');
        $cantidad = $this->input->post('cantidad');
        $descuento = 0;
        
            $sql = "update detalle_venta_aux set detalleven_cantidad = detalleven_cantidad + ".$cantidad.
                    ", detalleven_subtotal = detalleven_precio * (detalleven_cantidad)".
                    ", detalleven_descuento = ".$descuento.
                    ", detalleven_total = (detalleven_precio - ".$descuento.")*(detalleven_cantidad)".
                    "  where detalleven_id = ".$detalleven_id;
            
        $this->Venta_model->ejecutar($sql);
        return true;
        
            		
        //**************** fin contenido ***************
        			}
        			else{ redirect('alerta'); }
        } else { redirect('', 'refresh'); }
        
    }
    /*
     * incrementar cantidad de productos en el detalle
     */
    function incrementar_detalle()
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        //**************** inicio contenido ***************        
        
        $detalleven_id = $this->input->post('detalleven_id');
        $cantidad = $this->input->post('cantidad');
        $venta_id = $this->input->post('venta_id');
        $descuento = 0;
        
            $sql = "update detalle_venta set detalleven_cantidad = detalleven_cantidad + ".$cantidad.
                    ", detalleven_subtotal = detalleven_precio * (detalleven_cantidad)".
                    ", detalleven_descuento = ".$descuento.
                    ", detalleven_total = (detalleven_precio - ".$descuento.")*(detalleven_cantidad)".
                    "  where detalleven_id = ".$detalleven_id;
            
        $this->Venta_model->ejecutar($sql);
        
        $this->actualizar_tabla_venta($venta_id);
        
        return true;
        
            		
        //**************** fin contenido ***************
        			}
        			else{ redirect('alerta'); }
        } else { redirect('', 'refresh'); }
        
    }

    /*
     * reduce la cantidad de productos en el detalle
     */
    function reducir()
    {
      
            if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        //**************** inicio contenido ***************
        
        
        $detalleven_id = $this->input->post('detalleven_id');
        $cantidad = $this->input->post('cantidad');
        $descuento = 0;
        
            $sql = "update detalle_venta_aux set detalleven_cantidad = detalleven_cantidad - ".$cantidad.
                    ", detalleven_subtotal = detalleven_precio * (detalleven_cantidad)".
                    ", detalleven_descuento = ".$descuento.
                    ", detalleven_total = (detalleven_precio - ".$descuento.")*(detalleven_cantidad)".
                    "  where detalleven_id = ".$detalleven_id;
            
        $this->Venta_model->ejecutar($sql);
        return true;
            		
        //**************** fin contenido ***************
        			}
        			else{ redirect('alerta'); }
        } else { redirect('', 'refresh'); }
        
    }


    /*
     * reduce la cantidad de productos en el detalle
     */
    function reducir_detalle()
    {
      
            if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        //**************** inicio contenido ***************
        
        
        $detalleven_id = $this->input->post('detalleven_id');
        $cantidad = $this->input->post('cantidad');
        $venta_id = $this->input->post('venta_id');
        $descuento = 0;
        
            $sql = "update detalle_venta set detalleven_cantidad = detalleven_cantidad - ".$cantidad.
                    ", detalleven_subtotal = detalleven_precio * (detalleven_cantidad)".
                    ", detalleven_descuento = ".$descuento.
                    ", detalleven_total = (detalleven_precio - ".$descuento.")*(detalleven_cantidad)".
                    "  where detalleven_id = ".$detalleven_id;
            
        $this->Venta_model->ejecutar($sql);
        
        $this->actualizar_tabla_venta($venta_id);
        
        
        return true;
            		
        //**************** fin contenido ***************
        			}
        			else{ redirect('alerta'); }
        } else { redirect('', 'refresh'); }
        
    }

    /*
     * Buscar Cliente
     */
    function buscarcliente()
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        //**************** inicio contenido ***************
        
                if ($this->input->is_ajax_request()) {       
                    
                    $nit = $this->input->post('nit');                    
                    $datos = $this->Venta_model->buscar_cliente($nit);
                    echo json_encode($datos);                        

                }
                else
                {                 
                            show_404();
                }  
        		
        //**************** fin contenido ***************
                }
                else{ redirect('alerta'); }
        } else { redirect('', 'refresh'); }
               
    }
    /*
     * Mostrar detalle de venta
     */
    function detalleventa()
    {

        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        //**************** inicio contenido ***************
        
        
        $usuario_id = $session_data['usuario_id'];
        
        if ($this->input->is_ajax_request()) {

            //$sql = "select * from detalle_venta_aux where usuario_id=".$usuario_id;
            //$datos = $this->Venta_model->consultar($sql);
            $datos = $this->Venta_model->get_detalle_aux($usuario_id);
            
            echo json_encode($datos);
            
        }
        else
        {                 
                    show_404();
        }  
        		
        //**************** fin contenido ***************
        			}
        			else{ redirect('alerta'); }
        } else { redirect('', 'refresh'); }
               
    }

    /*
     * incrementar cantidad de productos en el detalle
     */
    function actualizarprecio()
    {
     
            if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        //**************** inicio contenido *************** 
      
        if ($this->input->is_ajax_request()) {
            $precio = $this->input->post('precio');
            $cantidad = $this->input->post('cantidad');
            $detalleven_id = $this->input->post('detalleven_id');
            $descuento = '0';
        
            $sql = "update detalle_venta_aux set detalleven_cantidad =  ".$cantidad.
                    ", detalleven_precio = ".$precio.
                    ", detalleven_subtotal = detalleven_precio * (detalleven_cantidad)".
                    ", detalleven_descuento = ".$descuento.
                    ", detalleven_total = (detalleven_precio - ".$descuento.")*(detalleven_cantidad)".
                    "  where detalleven_id = ".$detalleven_id;
            
        $this->Venta_model->ejecutar($sql);
        return true;
            
        }
        else
        {                 
                    show_404();
        }  

        		
        //**************** fin contenido ***************
        			}
        			else{ redirect('alerta'); }
        } else { redirect('', 'refresh'); }        
               
               
    }
    
/*
* buscar productos
*/
function buscarproductos()
{
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        //**************** inicio contenido ***************    
    
        $usuario_id = $session_data['usuario_id'];

        if ($this->input->is_ajax_request()) {
            
            $parametro = $this->input->post('parametro');   
            
            if ($parametro!=""){
            $datos = $this->Inventario_model->get_inventario_parametro($parametro);            
          echo json_encode($datos);
          
            }
            else echo json_encode(null);
        }
        else
        {                 
            show_404();
        }   
        		
        //**************** fin contenido ***************
        			}
        			else{ redirect('alerta'); }
        } else { redirect('', 'refresh'); }        
        
}
    
/*
* buscar productos por categoria de productos
*/
function buscarcategorias()
{
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        //**************** inicio contenido ***************   
   
        $usuario_id = $session_data['usuario_id'];

        if ($this->input->is_ajax_request()) {
            
            $parametro = $this->input->post('parametro');   
            
            if ($parametro!=""){
            $datos = $this->Inventario_model->get_inventario_categoria($parametro);            
            //$datos = $this->Inventario_model->get_inventario_bloque();
            echo json_encode($datos);
            }
            else echo json_encode(null);
        }
        else
        {                 
            show_404();
        }      
        		
        //**************** fin contenido ***************
        			}
        			else{ redirect('alerta'); }
        } else { redirect('', 'refresh'); }        
}

function buscarcotizar()
{
        $usuario_id = 1;

        if ($this->input->is_ajax_request()) {
            
            $parametro = $this->input->post('parametro');   
            
            if ($parametro!=""){
            $datos = $this->Inventario_model->get_inventario_coti($parametro);            
            //$datos = $this->Inventario_model->get_inventario_bloque();
            echo json_encode($datos);
            }
            else echo json_encode(null);
        }
        else
        {                 
            show_404();
        }              
}
    
/*
* Registrar cliente
*/
function registrarcliente()
{
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        //**************** inicio contenido ***************    
    
        if ($this->input->is_ajax_request()) {
            
            $cliente_nit = $this->input->post('nit');
            $cliente_razon = "'".$this->input->post('razon')."'";
            $cliente_telefono = "'".$this->input->post('telefono')."'";
            $cliente_ci = $cliente_nit;
            $cliente_nombre = $cliente_razon;
            $sql = "insert cliente(tipocliente_id,categoriaclie_id,cliente_nombre,cliente_ci,cliente_nit,cliente_razon,cliente_telefono,estado_id,usuario_id) value(1,1,".
                   $cliente_nombre.",".$cliente_ci.",".$cliente_nit.",".$cliente_razon.",".$cliente_telefono.",1,0)";
            
            $datos = $this->Venta_model->registrarcliente($sql);
            echo json_encode($datos);
            
        }
        else
        {                 
            show_404();
        }   
        
        		
        //**************** fin contenido ***************
        			}
        			else{ redirect('alerta'); }
        } else { redirect('', 'refresh'); }
}
/*
* Registrar cliente
*/
function modificarcliente()
{
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        //**************** inicio contenido ***************    
    
        if ($this->input->is_ajax_request()) {
            
            $cliente_nit = $this->input->post('nit');          
            if($cliente_nit == null) $cliente_nit = 0;
            
            $cliente_razon = "'".$this->input->post('razon')."'";
            $cliente_telefono = "'".$this->input->post('telefono')."'";
            $cliente_id = $this->input->post('cliente_id');
//            $cliente_ci =  "'".$this->input->post('cliente_ci')."'";
            $cliente_nombre =  "'".$this->input->post('cliente_nombre')."'";
            
            if ($cliente_id>0){
                $sql = "update cliente set ".
                        " cliente_nombre = ".$cliente_nombre.
    //                    ",cliente_ci = ".$cliente_ci.
                        ",cliente_nit = ".$cliente_nit.
                        ",cliente_razon = ".$cliente_razon.
                        ",cliente_telefono = ".$cliente_telefono.
                        " where cliente_id = ".$cliente_id;

                $datos = $this->Venta_model->modificarcliente($sql);            
                echo  '[{"cliente_id":'.$cliente_id.'}]';
            }
            else{
                //si el cliente ingresa con nit 0 se debe
                              
                $datos = $this->Venta_model->buscar_cliente($cliente_nit); 
                
                if (sizeof($datos)>0){
                    $cliente_id = $datos[0]["cliente_id"];

                    $sql = "update cliente set ".
                            " cliente_nombre = ".$cliente_nombre.
                            ",cliente_nit = ".$cliente_nit.
                            ",cliente_razon = ".$cliente_razon.
                            ",cliente_telefono = ".$cliente_telefono.
                            " where cliente_id = ".$cliente_id;

                    $datos = $this->Venta_model->modificarcliente($sql);   
                    echo  '[{"cliente_id":'.$cliente_id.'}]';
                }
                else{
                        

 
                        $cliente_ci = $cliente_nit;
                        $cliente_nombre = $cliente_razon;
                        $sql = "insert cliente(tipocliente_id,categoriaclie_id,cliente_nombre,cliente_ci,cliente_nit,cliente_razon,cliente_telefono,estado_id,usuario_id) value(1,1,".
                               $cliente_nombre.",".$cliente_ci.",".$cliente_nit.",".$cliente_razon.",".$cliente_telefono.",1,0)";

                        $datos = $this->Venta_model->registrarcliente($sql);
                        return json_encode($datos);
 
                }
                
            }
            
            
//echo json_encode(true);
            
        }
        else
        {                 
            show_404();
        }   
        
        		
        //**************** fin contenido ***************
        			}
        			else{ redirect('alerta'); }
        } else { redirect('', 'refresh'); }
}


/*************** funcion para mostrar la vista de la factura******************/
function ultimaventa(){
    
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                $data = array(
                    'page_title' => 'Imprimir factura'
                );
        //**************** inicio contenido ***************    
    
                
    $venta = $this->Venta_model->ultima_venta();
    $venta_tipodoc = $venta[0]['venta_tipodoc'];
    $venta_id = $venta[0]['venta_id'];
    
    if ($venta_tipodoc==1){ 
        redirect('factura/factura_boucher/'.$venta_id);}
    else{
        redirect('factura/recibo_boucher/'.$venta_id);}
        
       //**************** fin contenido ***************
        }
            else{ redirect('alerta'); }
        } else { redirect('', 'refresh'); }    
}

function eliminar_venta($venta_id){

        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        //**************** inicio contenido ***************       
    
            $sql = "update inventario i, detalle_venta d"
                    ." set i.existencia = i.existencia + d.detalleven_cantidad"
                    ." where d.venta_id = ".$venta_id." and d.producto_id = i.producto_id ";
            $this->Venta_model->ejecutar($sql);    

            $sql =  "delete from detalle_venta where venta_id = ".$venta_id;
            $this->Venta_model->ejecutar($sql);

            $sql =  "delete from venta where venta_id = ".$venta_id;
            $this->Venta_model->ejecutar($sql);

            $sql =  "delete from cuota where credito_id = (select credito_id from credito where venta_id = ".$venta_id." ) ";
            $this->Venta_model->ejecutar($sql);

            $sql =  "delete from credito where venta_id = ".$venta_id;
            $this->Venta_model->ejecutar($sql);

            redirect('venta/index');
            
       //**************** fin contenido ***************
        			}
        			else{ redirect('alerta'); }
        } else { redirect('', 'refresh'); }               
}

function anular_venta($venta_id){

        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        //**************** inicio contenido ***************   
        //    
    //actualiza el invetario retornando los productos
//    $sql = "update inventario i, detalle_venta d"
//            ." set i.existencia = i.existencia + d.detalleven_cantidad"
//            ." where d.venta_id = ".$venta_id." and d.producto_id = i.producto_id ";
//    $this->Venta_model->ejecutar($sql);    

    
    //$sql =  "delete from detalle_venta where venta_id = ".$venta_id;
    $sql =  "update detalle_venta set detalleven_cantidad = 0, detalleven_precio = 0, detalleven_total = 0 where venta_id = ".$venta_id;
    $this->Venta_model->ejecutar($sql);
            
    //$sql =  "delete from venta where venta_id = ".$venta_id;
    $sql =  "update venta set venta_subtotal = 0, venta_descuento = 0, venta_total = 0, venta_efectivo = 0, venta_cambio = 0, estado_id = 3 where venta_id = ".$venta_id;
    $this->Venta_model->ejecutar($sql);
    
    //$sql =  "delete from cuota where credito_id = (select credito_id from credito where venta_id = ".$venta_id." ) ";
    $sql =  "update cuota  set
            cuota_numcuota = 0
            ,cuota_capital = 0
            ,cuota_interes = 0
            ,cuota_moradias = 0
            ,cuota_multa = 0
            ,cuota_subtotal = 0
            ,cuota_descuento = 0
            ,cuota_total = 0
            ,cuota_cancelado = 0
            ,cuota_numercibo = 0
            ,cuota_saldo = 0
            ,cuota_saldocredito = 0
             where credito_id = (select credito_id from credito where venta_id = ".$venta_id." ) ";
    $this->Venta_model->ejecutar($sql);
        
    $sql =  "update credito set
            estado_id = 9
            ,credito_monto = 0
            ,credito_cuotainicial = 0
            ,credito_interesproc = 0
            ,credito_interesmonto = 0
            ,credito_numpagos = 0
            ,credito_tipointeres = 0
            where venta_id = ".$venta_id;
    $this->Venta_model->ejecutar($sql);
            
    redirect('venta/index');
    
    //**************** fin contenido ***************
                             }
                             else{ redirect('alerta'); }
     } else { redirect('', 'refresh'); }       
    
}

    /*
     * Mostrar ventas
     */
    function mostrar_ventas()
    {

        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                $data = array(
                    'page_title' => 'Mostrar Ventas'
                );
        //**************** inicio contenido ***************   

        $usuario_id = 1;

        
        if ($this->input->is_ajax_request()) {
            
            $filtro = $this->input->post('filtro');
            
            if ($filtro == null){
                $result = $this->Venta_model->get_ventas(" and v.venta_fecha = date(now())");
            }
            else{
                $result = $this->Venta_model->get_ventas($filtro);            
            }

           echo json_encode($result);
            
        }
        else
        {                 
                    show_404();
        }    
       //**************** fin contenido ***************
        			}
        			else{ redirect('alerta'); }
        } else { redirect('', 'refresh'); }           
    }
    
  function busquedacombi()
    {

        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        //**************** inicio contenido ***************          

                
        $params['limit'] = RECORDS_PER_PAGE;
        $params['offset'] = ($this->input->get('per_page')) ? $this->input->get('per_page') : 0;
        
        $config = $this->config->item('pagination');
       
        $config['total_rows'] = $this->Venta_model->get_all_venta_count();
        $this->pagination->initialize($config);
        $this->load->model('Usuario_model');
        $this->load->model('Detalle_venta_model');
        $filtro = $this->input->post('filtro');
        
        if ($filtro == null){
           $data['venta'] = $this->Venta_model->get_all_ventas($params);
        }
        else{
             $data['venta'] = $this->Venta_model->get_busqueda($filtro);            
        }
        
        $data['all_usuario'] = $this->Usuario_model->get_all_usuario($params);
         
      
        $data['_view'] = 'venta/combinados';
        $this->load->view('layouts/main',$data);
        //**************** fin contenido ***************
        			}
        			else{ redirect('alerta'); }
        } else { redirect('', 'refresh'); }          

    }

    function comision()
    {
        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        //**************** inicio contenido ***************           
        
        $params['limit'] = RECORDS_PER_PAGE;
        $params['offset'] = ($this->input->get('per_page')) ? $this->input->get('per_page') : 0;
        
        $config = $this->config->item('pagination');
       
        $config['total_rows'] = $this->Venta_model->get_all_venta_count();
        $this->pagination->initialize($config);
        $this->load->model('Usuario_model');
        $this->load->model('Detalle_venta_model');
        $filtro = $this->input->post('filtro');
        
        if ($filtro == null){
           $data['venta'] = $this->Venta_model->get_all_venta($params);
        }
        else{
             $data['venta'] = $this->Venta_model->get_busqueda($filtro);            
        }
        
        $data['all_usuario'] = $this->Usuario_model->get_all_usuario($params);
         
      
        $data['_view'] = 'venta/comisiones';
        $this->load->view('layouts/main',$data);
        
       //**************** fin contenido ***************
        			}
        			else{ redirect('alerta'); }
        } else { redirect('', 'refresh'); }           
        
    }
    
    function buscarporvendedores()
    {
            if ($this->session->userdata('logged_in')) {
                $session_data = $this->session->userdata('logged_in');
                if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                    $data = array(
                        'page_title' => 'Admin >> Mi Cuenta'
                    );
            //**************** inicio contenido ***************          

            if ($this->input->is_ajax_request()) {

                $filtro = $this->input->post('filtro');   

                if ($filtro!=""){
                $datos = $this->Venta_model->get_busqueda($filtro);            

                echo json_encode($datos);
                }
                else echo json_encode(null);
            }
            else
            {                 
                show_404();
            }              

           //**************** fin contenido ***************
                }
                else{ redirect('alerta'); }
            } else { redirect('', 'refresh'); }           

    }

    
    function actualizar_tabla_venta($venta_id)
    {

        //actualizar los totales
        $sql = "select if(sum(x.detalleven_subtotal)>0,sum(x.detalleven_subtotal),0) as subtotal,"
                . "if(sum(x.detalleven_descuento)>0,sum(x.detalleven_descuento),0) as descuento, "
                . "if(sum(x.detalleven_total)>0, sum(x.detalleven_total),0) as total "
                . " from detalle_venta x where x.venta_id = ".$venta_id;                    
        $resultado = $this->Venta_model->consultar($sql);

        //echo json_encode($resultado);

        $subtotal = $resultado[0]['subtotal'];
        $descuento = $resultado[0]['descuento'];
        $total = $resultado[0]['total'];

        $sql = "update venta set "
                . " venta_subtotal = ".$subtotal
                . ",venta_descuento = ".$descuento
                . ",venta_total = ".$total
                ." where venta_id = ".$venta_id;
        $this->Venta_model->ejecutar($sql);        
        
        return true;
        
    }
    
    function eliminar_producto_vendido($detalleven_id)
    {
            if ($this->session->userdata('logged_in')) {
                $session_data = $this->session->userdata('logged_in');
                if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                    $data = array(
                        'page_title' => 'Admin >> Mi Cuenta'
                    );
            //**************** inicio contenido ***************          

            if ($this->input->is_ajax_request()) {

                //Obtener el detalle de la venta a eliminar
                $sql = "select * from detalle_venta where detalleven_id = ".$detalleven_id;
                $resultado = $this->Venta_model->consultar($sql);
                
                if (sizeof($resultado)>0){ // si el detalle existe
                    
                    
                    $producto_id = $resultado[0]['producto_id'];
                    $cantidad = $resultado[0]['detalleven_cantidad'];
                    $venta_id = $resultado[0]['venta_id'];
                    
                    //eliminar el detalle de la venta
                    $sql = "delete from detalle_venta where detalleven_id = ".$detalleven_id;                    
                    $this->Venta_model->ejecutar($sql);

                    //retornamos la cantidad al inventario
                    $sql = "update inventario set existencia = existencia + ".$cantidad;
                    $this->Venta_model->ejecutar($sql);

                    $this->actualizar_tabla_venta($venta_id);
                 
                    
                }
                
                return true;
                
            }
            else
            {                 
                show_404();
            }              

           //**************** fin contenido ***************
                }
                else{ redirect('alerta'); }
            } else { redirect('', 'refresh'); }           

    }
    
    

    /*
     * Verificar las ventas
     */
    function verificar_ventas()
    {

        if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        //**************** inicio contenido ***************   

        $usuario_id = 1;

        
        if ($this->input->is_ajax_request()) {
            
            $filtro = $this->input->post('filtro');
            
            if ($filtro == null){
                $result = $this->Venta_model->mostrar_ventas(" and v.venta_fecha = date(now())");
            }
            else{
                $result = $this->Venta_model->mostrar_ventas($filtro);            
            }

           echo json_encode($result);
            
        }
        else
        {                 
                    show_404();
        }    
       //**************** fin contenido ***************
        			}
        			else{ redirect('alerta'); }
        } else { redirect('', 'refresh'); }           
    }       

    function costo_cero()
    {       
         if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        //**************** inicio contenido ***************       
        
        $usuario_id = $session_data['usuario_id'];
        
        $sql =  "UPDATE
                detalle_venta_aux
              SET
                detalleven_costo = 0,
                detalleven_precio = 0,
                detalleven_subtotal = 0,
                detalleven_descuento = 0,
                detalleven_total = 0
              WHERE
                usuario_id = ".$usuario_id;
        $this->Venta_model->ejecutar($sql);
        return true;
    
            		
        //**************** fin contenido ***************
        			}
        			else{ redirect('alerta'); }
        } else { redirect('', 'refresh'); }    
        
    }
        
    function cantidad_en_detalle()
    {       
         if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        //**************** inicio contenido ***************       
        
        $usuario_id = $session_data['usuario_id'];
        
        $producto_id = $this->input->post('producto_id');
        
        $sql =  "select if(sum(detalleven_cantidad)>0,sum(detalleven_cantidad),0) as cantidad from detalle_venta_aux "
                . " where producto_id =".$producto_id;
        
        $resultado = $this->Venta_model->consultar($sql);
        echo json_encode($resultado);
    
            		
        //**************** fin contenido ***************
        			}
        			else{ redirect('alerta'); }
        } else { redirect('', 'refresh'); }    
        
    }
        
    function cantidad_en_detalle_otros()
    {       
         if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        //**************** inicio contenido ***************       
        
        $usuario_id = $session_data['usuario_id'];
        
        $producto_id = $this->input->post('producto_id');
        
        $sql =  "select if(sum(detalleven_cantidad)>0,sum(detalleven_cantidad),0) as cantidad from detalle_venta_aux "
                . " where producto_id =".$producto_id." and usuario_id <>".$usuario_id;
        
        $resultado = $this->Venta_model->consultar($sql);
        echo json_encode($resultado);
    
            		
        //**************** fin contenido ***************
        			}
        			else{ redirect('alerta'); }
        } else { redirect('', 'refresh'); }    
        
    }
        


    function existencia()
    {       
         if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        //**************** inicio contenido ***************       
        
        $usuario_id = $session_data['usuario_id'];
        
        $producto_id = $this->input->post('producto_id');
        
//        $sql =  "select existencia from inventario "
//                . " where producto_id =".$producto_id;
        
        $sql =  "select existencia from detalle_venta_aux "
                . " where producto_id =".$producto_id." and usuario_id = ".$usuario_id;
        
        $resultado = $this->Venta_model->consultar($sql);
        echo json_encode($resultado);
    
            		
        //**************** fin contenido ***************
        			}
        			else{ redirect('alerta'); }
        } else { redirect('', 'refresh'); }
    }        

    function precio_costo()
    {       
         if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        //**************** inicio contenido ***************       
        
        $usuario_id = $session_data['usuario_id'];
        
        $sql =  "UPDATE
                detalle_venta_aux
              SET
               
                detalleven_precio = detalleven_costo,
                detalleven_subtotal = detalleven_costo * detalleven_cantidad,
                detalleven_descuento = 0,
                detalleven_total = detalleven_costo * detalleven_cantidad
              WHERE
                usuario_id = ".$usuario_id;
        $this->Venta_model->ejecutar($sql);
        return true;
    
            		
        //**************** fin contenido ***************
        			}
        			else{ redirect('alerta'); }
        } else { redirect('', 'refresh'); }    
        
    }

    function buscar_clientes()
    {       
         if ($this->session->userdata('logged_in')) {
            $session_data = $this->session->userdata('logged_in');
            if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                $data = array(
                    'page_title' => 'Admin >> Mi Cuenta'
                );
        //**************** inicio contenido ***************       
        
        $usuario_id = $session_data['usuario_id'];
        $parametro = $this->input->post('parametro');
        
        $sql =  "select * from cliente where ".
                " cliente_razon like '%".$parametro."%'".
                " or cliente_nombre like '%".$parametro."%'".
                " or cliente_codigo like '%".$parametro."%'".
                " or cliente_nit like '%".$parametro."%'";
        //echo $sql;
        $resultado = $this->Venta_model->consultar($sql);
        echo json_encode($resultado);
    
            		
        //**************** fin contenido ***************
        			}
        			else{ redirect('alerta'); }
        } else { redirect('', 'refresh'); }    
        
    }
        
    function seleccionar_cliente($cliente_id){
        if ($this->session->userdata('logged_in')) {
                   $session_data = $this->session->userdata('logged_in');
                   if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                       $data = array(
                           'page_title' => 'Admin >> Mi Cuenta'
                       );
               //**************** inicio contenido ***************       

               $usuario_id = $session_data['usuario_id'];
               
               
               $sql =  "select * from cliente where ".
                       " cliente_id = ".$cliente_id;
               
               $resultado = $this->Venta_model->consultar($sql);
               echo json_encode($resultado);


               //**************** fin contenido ***************
                                       }
                                       else{ redirect('alerta'); }
               } else { redirect('', 'refresh'); }            
        
    }
        
    function registrar_caracteristicas(){
        if ($this->session->userdata('logged_in')) {
                   $session_data = $this->session->userdata('logged_in');
                   if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                       $data = array(
                           'page_title' => 'Admin >> Mi Cuenta'
                       );
               //**************** inicio contenido ***************       

               $usuario_id = $session_data['usuario_id'];
               
               $detalleven_id = $this->input->post('detalleven_id');
               $detalleven_preferencia = $this->input->post('preferencia');
               $detalleven_caracteristicas = $this->input->post('caracteristicas');
               
               $sql =  "update detalle_venta_aux set ".
                       " detalleven_preferencia = '".$detalleven_preferencia."', ".
                       " detalleven_caracteristicas = '".$detalleven_caracteristicas."'".                       
                       " where detalleven_id = ".$detalleven_id;
               
               $resultado = $this->Venta_model->ejecutar($sql);
               //echo json_encode($resultado);
               return true; 

               //**************** fin contenido ***************
                                       }
                                       else{ redirect('alerta'); }
               } else { redirect('', 'refresh'); }            
        
    }
  
        
    function verificar_detalle($monto){
        if ($this->session->userdata('logged_in')) {
            
                   $session_data = $this->session->userdata('logged_in');
                   if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                       $data = array(
                           'page_title' => 'Admin >> Mi Cuenta'
                       );
               //**************** inicio contenido ***************       

               $usuario_id = $session_data['usuario_id'];
               
               
               $sql =  "SELECT 
                        if(round(sum(detalleven_total), 2) = round(".$monto.", 2), 1, 0) AS resultado
                      FROM
                        detalle_venta_aux
                      WHERE
                        usuario_id =".$usuario_id;
               
               $resultado = $this->Venta_model->consultar($sql);
               echo json_encode($resultado);


               //**************** fin contenido ***************
                                       }
                                       else{ redirect('alerta'); }
               } else { redirect('', 'refresh'); }            
        
    }    
        
    function ejecutar_consulta(){
        if ($this->session->userdata('logged_in')) {
            
                   $session_data = $this->session->userdata('logged_in');
                   if($session_data['tipousuario_id']>=1 and $session_data['tipousuario_id']<=4) {
                       $data = array(
                           'page_title' => 'Admin >> Mi Cuenta'
                       );
               //**************** inicio contenido ***************       

               $sql = $this->input->post('sql');
               
               
               $resultado = $this->Venta_model->ejecutar($sql);
               echo true;


               //**************** fin contenido ***************
                                       }
                                       else{ redirect('alerta'); }
               } else { redirect('', 'refresh'); }            
        
    }    
    
}
