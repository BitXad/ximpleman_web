<?php
/* 
 * Generated by CRUDigniter v3.2 
 * www.crudigniter.com
 */
 
class Dia extends CI_Controller{
    
    private $sistema;
    function __construct()
    {
        parent::__construct();
        $this->load->model('Dia_model');
        $this->load->model('Sistema_model');
        $this->sistema = $this->Sistema_model->get_sistema();
    } 

    /*
     * Listing of dia
     */
    function index()
    {
        $data['sistema'] = $this->sistema;
        $data['dia'] = $this->Dia_model->get_all_dia();
        
        $data['_view'] = 'dia/index';
        $this->load->view('layouts/main',$data);
    }

    /*
     * Adding a new dia
     */
    function add()
    {   
        $data['sistema'] = $this->sistema;
        if(isset($_POST) && count($_POST) > 0)     
        {   
                $params = array(
                                    'fecha' => $this->input->post('fecha'),
                                    'tipo_cambio' => $this->input->post('tipo_cambio'),
                                    'tipo_ufv' => $this->input->post('tipo_ufv'),
                );

                $dia_id = $this->Dia_model->add_dia($params);
            redirect('dia/index');
        }
        else
        {            
            $data['_view'] = 'dia/add';
            $this->load->view('layouts/main',$data);
        }
    }  

    /*
     * Editing a dia
     */
    function edit($cod_dia)
    {   
        $data['sistema'] = $this->sistema;
        // check if the dia exists before trying to edit it
        $data['dia'] = $this->Dia_model->get_dia($cod_dia);
        
        if(isset($data['dia']['cod_dia']))
        {
            if(isset($_POST) && count($_POST) > 0)     
            {   
                $params = array(
					'fecha' => $this->input->post('fecha'),
					'tipo_cambio' => $this->input->post('tipo_cambio'),
					'tipo_ufv' => $this->input->post('tipo_ufv'),
                );

                $this->Dia_model->update_dia($cod_dia,$params);            
                redirect('dia/index');
            }
            else
            {
                $data['_view'] = 'dia/edit';
                $this->load->view('layouts/main',$data);
            }
        }
        else
            show_error('The dia you are trying to edit does not exist.');
    } 

    /*
     * Deleting dia
     */
    function remove($cod_dia)
    {
        $data['sistema'] = $this->sistema;
        $dia = $this->Dia_model->get_dia($cod_dia);

        // check if the dia exists before trying to delete it
        if(isset($dia['cod_dia']))
        {
            $this->Dia_model->delete_dia($cod_dia);
            redirect('dia/index');
        }
        else
            show_error('The dia you are trying to delete does not exist.');
    }
    
    /* registrar cambio en Dia
     * 
    */
    function buscarcotizaciones()
    {
        $data['sistema'] = $this->sistema;
        //if($this->acceso(102)){
            if ($this->input->is_ajax_request()){
                $datos = $this->Dia_model->get_all_dia();
                echo json_encode($datos);
            }else{
                show_404();
            }
        //}
    }
    /*
    * registrar cambio en Dia
    */
    function registrarcotizacion()
    {
        $data['sistema'] = $this->sistema;
        //if($this->acceso(102)){
            if ($this->input->is_ajax_request()){
                $params = array(
                    'fecha' => $this->input->post('fecha'),
                    'tipo_cambio' => $this->input->post('tipo_cambio'),
                    'tipo_ufv' => $this->input->post('tipo_ufv'),
                );
                $dia_id = $this->Dia_model->add_dia($params);
                echo json_encode("ok");
            }else{
                show_404();
            }
        //}
    }
    /*
    * modificar cotizacion en Dia
    */
    function modificarcotizacion()
    {
        $data['sistema'] = $this->sistema;
        //if($this->acceso(102)){
            if ($this->input->is_ajax_request()){
                $params = array(
                    'fecha' => $this->input->post('fecha'),
                    'tipo_cambio' => $this->input->post('tipo_cambio'),
                    'tipo_ufv' => $this->input->post('tipo_ufv'),
                );
                $cod_dia = $this->input->post('cod_dia');
                $this->Dia_model->update_dia($cod_dia, $params);
                echo json_encode("ok");
            }else{
                show_404();
            }
        //}
    }
    /*
    * eliminar cotizacion en Dia
    */
    function eliminarcotizacion()
    {
        $data['sistema'] = $this->sistema;
        //if($this->acceso(102)){
            if ($this->input->is_ajax_request()){
                $cod_dia = $this->input->post('cod_dia');
                $this->Dia_model->delete_dia($cod_dia);
                echo json_encode("ok");
            }else{
                show_404();
            }
        //}
    }
    /*
    * eliminar cotizacion en Dia
    */
    function importararchivo()
    {
        $data['sistema'] = $this->sistema;
        //if($this->acceso(102)){
            if ($this->input->is_ajax_request()){
                $tipo = $_FILES['archivo']['type'];
                $tamanio = $_FILES['archivo']['size'];
                $archivotmp = $_FILES['archivo']['tmp_name'];
                $respuesta = new stdClass();
                $respuesta->mensaje = "";
                $borrar = "";
                //if( $tipo == 'application/vnd.ms-excel'){
                $archivo = "./resources/images/formapago/alumno.csv";
                if(move_uploaded_file($archivotmp, $archivo) ){
                   $respuesta->estado = true;
                } else {
                   $respuesta->estado = false;
                   $respuesta->mensaje = "El archivo no se pudo subir al servidor, inténtalo mas tarde";
                }
                if($respuesta->estado){
                    /* Se crea la conexión a la base de datos*/
                    //$conexion = new mysqli('localhost','usuario','password','basedatos',3306);
                    $lineas = file('./resources/images/formapago/alumno.csv');
                    foreach ($lineas as $linea) {
                        
                    //}
                    //foreach ($lineas as $linea_num => $linea)
                    //{
                        $datos = explode(";",$linea);
                        $fecha       = trim($datos[0]);
                        //$fecha       = $datos[0];
                        $borrar = substr($fecha, 0, 10);
                        //$fecha1 = date("Y-m-d", strtotime($borrar));
                           /*echo $fecha1;
                           break;*/
                       //$fecha1      = explode("/",$fecha);
                       //$fecha2      = $fecha1[0]."/".$fecha1[2]."/".$fecha1[1]; //date("Y-m-d", strtotime($fecha));
                        $fecha1 = str_replace("/", "\/", $borrar);
                       $tipo_cambio = trim($datos[1]);
                       $tipo_ufv    = trim($datos[2]);
                       $params = array(
                            'fecha'       => $fecha1,
                            'tipo_cambio' => $tipo_cambio,
                            'tipo_ufv'    => $tipo_ufv,
                        );
                        $dia_id = $this->Dia_model->add_dia($params);
                       
                        /*$consulta = "INSERT INTO tblalumno(matricula,paterno, materno, nombre) VALUES('$matricula', '$paterno', '$materno', '$nombre');";
                        if(!$conexion->query($consulta)){
                            $respuesta->estado = false;
                            $respuesta->errormsg .= "El alumno $paterno $materno $nombre no se guardo, verifica la información \n";
                        }*/
                    }
                }
                    if($respuesta->estado == true)
                       $respuesta->mensaje = "Todos los registros se guardaron correctamente\n";
                /*}
                else {
                   $respuesta->mensaje = "La información no se guardo debido a que solo se admiten archivos .csv\n";
                }*/
                 //echo json_encode($respuesta);
                 //echo json_encode($lineas);
                 echo json_encode($fecha1);
            }else{
                show_404();
            }
        //}
    }
    
}
