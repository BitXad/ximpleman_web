<?php
/* 
 * Generated by CRUDigniter v3.2 
 * www.crudigniter.com
 */
 
class Cuotum extends CI_Controller{
    private $session_data = "";
    private $sistema;
    private $parametros;

    function __construct()
    {
        parent::__construct();
        $this->load->model('Cuotum_model');
        $this->load->model('Empresa_model');
        $this->load->model('Credito_model');        
        $this->load->model('Banco_model');        
        $this->load->model('Compra_model');
        $this->load->model('Moneda_model');
        $this->load->model('Parametro_model');
        $this->load->helper('numeros');  
        $this->load->model('Dosificacion_model');
        $this->load->model('Ingreso_model');
        $this->load->model('Factura_model');
        $this->load->model('Forma_pago_model');
        $this->load->model('Detalle_venta_model');
        $this->load->model('Detalle_serv_model');
        $this->load->library('ControlCode');
        if ($this->session->userdata('logged_in')) {
            $this->session_data = $this->session->userdata('logged_in');
        }else {
            redirect('', 'refresh');
        }
        
        $this->load->model('Sistema_model');
	$this->sistema = $this->Sistema_model->get_sistema();
        
        $parametro = $this->Parametro_model->get_parametros();
        $this->parametros = $parametro[0];
    
        
    }
    /* *****Funcion que verifica el acceso al sistema**** */
    private function acceso($id_rol){
        $data['sistema'] = $this->sistema;
        $rolusuario = $this->session_data['rol'];
        if($rolusuario[$id_rol-1]['rolusuario_asignado'] == 1){
            return true;
        }else{
            $data['_view'] = 'login/mensajeacceso';
            $this->load->view('layouts/main',$data);
        }
    }
    /*
     * Listing of cuota
     */
    function index()
    {
        $data['sistema'] = $this->sistema;
        if($this->acceso(41)){
            $data['page_title'] = "Cuota";
            $usuario_id = $this->session_data['usuario_id'];
            $data['cuota'] = $this->Cuotum_model->get_all_cuota();
            $data['parametro'] = $this->parametros;

            $data['_view'] = 'cuotum/index';
            $this->load->view('layouts/main',$data);
        }
    }

    function deudas($credito_id)
    {
        $data['sistema'] = $this->sistema;
        $data['parametro'] = $this->parametros;
        
        if($this->acceso(42)){
            $data['page_title'] = "Cuota";
            $data['rol'] = $this->session_data['rol'];
            $data['cuota'] = $this->Cuotum_model->get_all_deuda($credito_id);
            $data['bancos'] = $this->Banco_model->getall_bancosact_asc();
            $data['credito'] = $this->Credito_model->dato_deudas($credito_id);
            $data['all_forma_pago'] = $this->Forma_pago_model->get_all_forma();
            $data['_view'] = 'cuotum/deudas';
            $this->load->view('layouts/main',$data);
        }
    }

    function planDeuda($credito_id)
    {
        $data['sistema'] = $this->sistema;
        $data['parametro'] = $this->parametros;
        
        if($this->acceso(42)){
            $data['page_title'] = "Cuota";
            $data['empresa'] = $this->Empresa_model->get_empresa(1);
            $data['cuota'] = $this->Cuotum_model->get_all_deuda($credito_id);
            //$data['cuotum'] = $this->Cuotum_model->get_cuotum($cuota_id);
            $data['_view'] = 'cuotum/planDeudas';
            $this->load->view('layouts/main',$data);
        }
    }
    
    function cuentas($credito_id){
        
        $data['sistema'] = $this->sistema;
        $data['parametro'] = $this->parametros;
        
        if($this->acceso(48)){
            
            $data['page_title'] = "Plan de pagos";
            $data['rol'] = $this->session_data['rol'];
            $cuotas_pendientes = $this->Cuotum_model->get_pendientes($credito_id);
            if (isset($cuotas_pendientes)) {
                foreach ($cuotas_pendientes as $cuota) {
                    $hoy = new DateTime('NOW');
                    $fechalimite = new DateTime($cuota['cuota_fechalimite']);
                    
                    if ($hoy>$fechalimite) {
                        $diff = $hoy->diff($fechalimite);
                        $dias =  $diff->days;
                        $multa = $dias*$cuota['cuota_interes']/30;
                        $sql = "UPDATE cuota SET cuota_moradias = ".$dias.", cuota_multa = ".$multa."  WHERE credito_id = ".$credito_id." and cuota_id = ".$cuota['cuota_id']." ";
                        $this->db->query($sql);
                    }
                }
            }
            
            $parametros = $this->Parametro_model->get_parametro(1);
            $data['parametro_factura'] = $parametros['parametro_factura'];
            $data['bancos'] = $this->Banco_model->getall_bancosact_asc();
            $data['moneda'] = $this->Moneda_model->get_moneda($parametros['moneda_id']);
            $data['cuota'] = $this->Cuotum_model->get_all_cuentas($credito_id);
            $data['credito'] = $this->Credito_model->dato_cuentas($credito_id);
            $data['all_forma_pago'] = $this->Forma_pago_model->get_all_forma();
            $data['_view'] = 'cuotum/cuentas';
            $this->load->view('layouts/main',$data);
            
        }
    }
    
    function cuenta_serv($credito_id)
    {
        $data['sistema'] = $this->sistema;
        $data['parametro'] = $this->parametros;
        
        if($this->acceso(47)){
            $data['page_title'] = "Plan de pagos";
            $data['rol'] = $this->session_data['rol'];
            $cuotas_pendientes = $this->Cuotum_model->get_pendientes($credito_id);
            if (isset($cuotas_pendientes)) {
                foreach ($cuotas_pendientes as $cuota) {
                    $hoy = new DateTime('NOW');
                    $fechalimite = new DateTime($cuota['cuota_fechalimite']);
                    if ($hoy>$fechalimite){
                        $diff = $hoy->diff($fechalimite);
                        $dias =  $diff->days;
                        $multa = $dias*$cuota['cuota_interes']/30;
                        $sql = "UPDATE cuota SET cuota_moradias = ".$dias.", cuota_multa = ".$multa."  WHERE credito_id = ".$credito_id." and cuota_id = ".$cuota['cuota_id']." ";
                        $this->db->query($sql);
                    }
                }
            }
            $parametros = $this->Parametro_model->get_parametro(1);
            $data['moneda'] = $this->Moneda_model->get_moneda($parametros['moneda_id']);
            $data['bancos'] = $this->Banco_model->getall_bancosact_asc();
            $data['cuota'] = $this->Cuotum_model->get_all_cuenta_serv($credito_id);
            $data['credito'] = $this->Credito_model->dato_cuenta_serv($credito_id);
            $data['all_forma_pago'] = $this->Forma_pago_model->get_all_forma();
            $data['_view'] = 'cuotum/cuentas';
            $this->load->view('layouts/main',$data);
        }
    }
    function planCuenta($credito_id)
    {
        $data['sistema'] = $this->sistema;
        $data['parametro'] = $this->parametros;
        
        if($this->acceso(48)){            
            
            $data['page_title'] = "Cuota";
            $data['empresa'] = $this->Empresa_model->get_empresa(1);
            $data['moneda'] = $this->Moneda_model->get_moneda($this->parametros['moneda_id']);
            //$data['cuota'] = $this->Cuotum_model->get_all_cuentas($credito_id);
            $data['cuota'] = $this->Cuotum_model->get_all_cuentas($credito_id);
           // $data['cuotum'] = $this->Cuotum_model->get_cuotum($cuota_id);
            if ($this->parametros['parametro_notaentrega']==1){
                $data['conimagen'] = 1;
            }elseif($this->parametros['parametro_notaentrega']==2){
                $data['conimagen'] = 2;
            }
            $eldetalle = "";
            if(isset($data['cuota'])){
                $detalle_venta = $this->Detalle_venta_model->get_detalle_venta($data['cuota'][0]['venta_id']);
                foreach ($detalle_venta as $detalle) {
                    $eldetalle = $detalle['categoria_nombre']." - ".$detalle['producto_nombre']." | ";
                }
            }
            $data['eldetalle'] = $eldetalle;
            
            $data['_view'] = 'cuotum/planCuentas';
            /* para lotes:  */
            //$data['_view'] = 'cuotum/planCuentas_lotes';
            $this->load->view('layouts/main',$data);
        }
    }
    function planCuentaServ($credito_id)
    {
        $data['sistema'] = $this->sistema;
        $data['parametro'] = $this->parametros;
        
        if($this->acceso(47)){
            $data['page_title'] = "Cuota";
            $data['empresa'] = $this->Empresa_model->get_empresa(1);
            $data['cuota'] = $this->Cuotum_model->get_all_cuenta_serv($credito_id);
            
            if ($this->parametros['parametro_notaentrega']==1){
                $data['conimagen'] = 1;
            }elseif($this->parametros['parametro_notaentrega']==2){
                $data['conimagen'] = 2;
            }
            $eldetalle = "";
            if(isset($data['cuota'])){
                $detalle_venta = $this->Detalle_serv_model->get_detalle_serv_all($data['cuota'][0]['servicio_id']);
                foreach ($detalle_venta as $detalle) {
                    $eldetalle = $detalle['detalleserv_descripcion'];
                }
            }
            $data['eldetalle'] = $eldetalle;
            $data['_view'] = 'cuotum/planCuentas';
            $this->load->view('layouts/main',$data);
        }
    }
    function recibodeudas($cuota_id)
    {
        $data['sistema'] = $this->sistema;
        $data['parametro'] = $this->parametros;
        
        $num = $this->Compra_model->numero();
        $este = $num[0]['parametro_tipoimpresora'];
        if($this->acceso(41)){
            $data['page_title'] = "Cuota";
            $data['cuota'] = $this->Cuotum_model->get_recibo_deuda($cuota_id);
            $data['empresa'] = $this->Empresa_model->get_empresa(1);
           // $data['cuotum'] = $this->Cuotum_model->get_cuotum($cuota_id);
        if ($este == 'NORMAL') {
        $data['_view'] = 'cuotum/reciboDeuda';
        $this->load->view('layouts/main',$data);
        }else{
        $data['_view'] = 'cuotum/boucherDeuda';
        $this->load->view('layouts/main',$data);
 
        }
            
        }
    }
    
     function recibocuentas($cuota_id, $eldetalle = null)
    {
         $data['sistema'] = $this->sistema;
         $data['parametro'] = $this->parametros;

        $num = $this->Compra_model->numero();
        $este = $num[0]['parametro_tipoimpresora'];
        $data['moneda'] = $this->Moneda_model->get_moneda($data['parametro']['moneda_id']);
         if($this->acceso(47)){
            $data['page_title'] = "Comprobante";
            $data['cuota'] = $this->Cuotum_model->get_recibo_cuenta($cuota_id);
            $data['empresa'] = $this->Empresa_model->get_empresa(1);
            
            if($eldetalle == 1){
                if(isset($data['cuota'])){
                    $data['detalle_venta'] = $this->Cuotum_model->get_detallesventa($data['cuota'][0]['venta_id']);
                    $data['lacategoria'] = $data['detalle_venta'][0]['categoria_nombre'];
                }else{
                    $data['detalle_venta'] = "";
                    $data['lacategoria'] = "";
                }
            }else{
                $data['detalle_venta'] = "";
                $data['lacategoria'] = "";
            }
            
            // $data['cuotum'] = $this->Cuotum_model->get_cuotum($cuota_id);
           
            if ($este == 'NORMAL') {
            $data['_view'] = 'cuotum/reciboCuenta';
            $this->load->view('layouts/main',$data);
            }else{
            $data['_view'] = 'cuotum/boucherCuenta';
            $this->load->view('layouts/main',$data);

            }
        }
    }

   function recibocuentaserv($cuota_id)
    {
       $data['sistema'] = $this->sistema;
       $data['parametro'] = $this->parametros;
       
       if($this->acceso(47)){
            $data['page_title'] = "Cuota";
            $data['cuota'] = $this->Cuotum_model->get_recibo_cuentaServ($cuota_id);
            $data['empresa'] = $this->Empresa_model->get_empresa(1);
            $data['moneda'] = $this->Moneda_model->get_moneda($data['parametro'][0]['moneda_id']);

            $data['detalle_venta'] = "";
            $data['lacategoria'] = "";
           // $data['cuotum'] = $this->Cuotum_model->get_cuotum($cuota_id);
            $data['_view'] = 'cuotum/reciboCuenta';
            $this->load->view('layouts/main',$data);
        }
    }
    function comprobantedeudas($cuota_id,$credito_id)
    {
        $data['sistema'] = $this->sistema;
        $data['parametro'] = $this->parametros;
        
        if($this->acceso(41)){
            $data['page_title'] = "Cuota";
            $data['cuota'] = $this->Cuotum_model->get_recibo_deuda($cuota_id);
            $data['empresa'] = $this->Empresa_model->get_empresa(1);
            $data['credito'] = $this->Cuotum_model->get_all_deuda($credito_id);
            $data['_view'] = 'cuotum/comprobanteDeuda';
            $this->load->view('layouts/main',$data);
        }
    }
    function comprobantecuentas($cuota_id,$credito_id)
    {
        $data['sistema'] = $this->sistema;
        $data['parametro'] = $this->parametros;
        
        if($this->acceso(47)){
            $data['page_title'] = "Cuota";
            $data['cuota'] = $this->Cuotum_model->get_recibo_cuenta($cuota_id);
            $data['empresa'] = $this->Empresa_model->get_empresa(1);
            $data['credito'] = $this->Cuotum_model->get_all_cuentas($credito_id);
            $data['_view'] = 'cuotum/comprobanteCuenta';
            $this->load->view('layouts/main',$data);
        }
    }

    function notacobro($cuota_id,$credito_id)
    {
        $data['sistema'] = $this->sistema;
        $data['parametro'] = $this->parametros;
        
        if($this->acceso(41) or $this->acceso(47)){
            $data['page_title'] = "Cuota";
            $parametros = $this->Parametro_model->get_parametro(1);
            $data['moneda'] = $this->Moneda_model->get_moneda($parametros['moneda_id']);
            $data['cuota'] = $this->Cuotum_model->get_recibo_cuenta($credito_id);
            $data['empresa'] = $this->Empresa_model->get_empresa(1);
            $data['credito'] = $this->Cuotum_model->get_all_cuentas($credito_id);
            $data['_view'] = 'cuotum/notaCobro';
            $this->load->view('layouts/main',$data);
        }
    }

    function comprobantecuentaserv($cuota_id,$credito_id)
    {
        $data['sistema'] = $this->sistema;
        $data['parametro'] = $this->parametros;
        
        if($this->acceso(47)){
            $data['page_title'] = "Cuota";
            $data['cuota'] = $this->Cuotum_model->get_recibo_cuentaServ($cuota_id);
            $data['empresa'] = $this->Empresa_model->get_empresa(1);
            $data['credito'] = $this->Cuotum_model->get_all_cuentas($credito_id);
            $data['_view'] = 'cuotum/comprobanteCuenta';
            $this->load->view('layouts/main',$data);
        }
    }
    function pagar($cuota_id)
    {
        $data['sistema'] = $this->sistema;
        $data['parametro'] = $this->parametros;
        
        if($this->acceso(41)){
            $data['page_title'] = "Cuota";
            $usuario_id = $this->session_data['usuario_id'];
            $data['cuota'] = $this->Cuotum_model->get_cuotum($cuota_id);
           //  $data['cuota'] = $this->Cuotum_model->get_all_deuda($credito_id);
            $estado_id = 8;
            $cuota_id = $this->input->post('cuota_id');
            $num = $this->Cuotum_model->numero();
            $maximo = $num[0]['parametro_montomax'];
            $interes = $num[0]['parametro_interes'];
            $credito_id = $this->input->post('credito_id');
            $credito_tipointeres = $this->input->post('credito_tipointeres');
            $cuota_capital = $this->input->post('cuota_capital');
            $banco_id = $this->input->post('forma_pago') != 1 ? $this->input->post('banco'):'0';

  $si_orden=$this->input->post('cuota_ordenpago');     
   if ($si_orden==1 ) {
     $this->load->model('Orden_pago_model');
      $nodoc=$this->input->post('cuota_numercibo');
      $orden_fecha = "'".date("Y-m-d")."'"; 
      $orden_hora = "'".date("H:i:s")."'"; 
      $compra_prove=$this->Cuotum_model->get_all_deuda($credito_id);
      $proveedor_nombre = $compra_prove[0]['proveedor_nombre'];
      $orden_monto = $this->input->post('cuota_cancelado');
      $orden_motivo = "'pago de cuota a proveedor No. ".$cuota_id."/credito".$credito_id."  documento No. ".$nodoc." '";
      $comprita = 0;
      $orden = "insert into orden_pago(usuario_id1,usuario_id2,orden_monto,orden_destinatario,orden_motivo,orden_fecha,orden_hora,estado_id,orden_cancelado,compra_id,cuota_id) "
                    . "value(".$usuario_id.",0".",".$orden_monto.",'".$proveedor_nombre."',".$orden_motivo.",".$orden_fecha.",".$orden_hora.",8,0,".$comprita.",".$cuota_id.")";
            //echo $sql;
           $this->Orden_pago_model->registrar_orden($orden);
   }
        if($cuota_capital==0){
         $params = array(
                    
                    'usuario_id' => $usuario_id,
                    'estado_id' => $this->input->post('estado_id'),
                   // 'cuota_numcuota' => $this->input->post('cuota_numcuota'),
                    //'cuota_capital' => $this->input->post('cuota_capital'),
                    //'cuota_interes' => $this->input->post('cuota_interes'),
                    //'cuota_moradias' => $this->input->post('cuota_moradias'),
                    //'cuota_multa' => $this->input->post('cuota_multa'),
                   // 'cuota_subtotal' => $this->input->post('cuota_subtotal'),
                   // 'cuota_descuento' => $this->input->post('cuota_descuento'),
                    //'cuota_total' => $this->input->post('cuota_total'),
                   // 'cuota_fechalimite' => $this->input->post('cuota_fechalimite'),
                    'cuota_cancelado' => $this->input->post('cuota_cancelado'),
                    'cuota_fecha' => $this->input->post('cuota_fecha'),
                    'cuota_hora' => $this->input->post('cuota_hora'),
                    'cuota_numercibo' => $this->input->post('cuota_numercibo'),
                   // 'cuota_saldo' => $this->input->post('cuota_saldo'),
                    'cuota_glosa' => $this->input->post('cuota_glosa'),
                    'cuota_ordenpago' => $this->input->post('cuota_ordenpago'),
                    'forma_id' => $this->input->post('forma_pago'),
                    'cuota_forma_glosa' => $this->input->post('cuota_forma_glosa'),
                    'banco_id' => $banco_id,
                );


                $this->Cuotum_model->update_cuotum($cuota_id,$params); 
                 }   
             else{
                 $params = array(
                    
                        'usuario_id' => $usuario_id,
                    'estado_id' => $this->input->post('estado_id'),
                   // 'cuota_numcuota' => $this->input->post('cuota_numcuota'),
                    //'cuota_capital' => $this->input->post('cuota_capital'),
                    //'cuota_interes' => $this->input->post('cuota_interes'),
                    //'cuota_moradias' => $this->input->post('cuota_moradias'),
                    //'cuota_multa' => $this->input->post('cuota_multa'),
                   // 'cuota_subtotal' => $this->input->post('cuota_subtotal'),
                   // 'cuota_descuento' => $this->input->post('cuota_descuento'),
                    //'cuota_total' => $this->input->post('cuota_total'),
                   // 'cuota_fechalimite' => $this->input->post('cuota_fechalimite'),
                    'cuota_cancelado' => $this->input->post('cuota_cancelado'),
                    'cuota_fecha' => $this->input->post('cuota_fecha'),
                    'cuota_hora' => (date('H:i:s')), 
                    'cuota_numercibo' => $this->input->post('cuota_numercibo'),
                   // 'cuota_saldo' => $this->input->post('cuota_saldo'),
                    'cuota_glosa' => $this->input->post('cuota_glosa'),
                    'cuota_ordenpago' => $this->input->post('cuota_ordenpago'),
                    'forma_id' => $this->input->post('forma_pago'),
                    'cuota_forma_glosa' => $this->input->post('cuota_forma_glosa'),
                    'banco_id' => $banco_id,
                );


                $this->Cuotum_model->update_cuotum($cuota_id,$params); 
                 $dias_mora = 0;
                    $multa = 0;
                    $descuento = 0;
                    $cancelado = 0;
                    $credito_fecha = $this->input->post('cuota_fecha');
                    $credito_hora = "'".date('H:i:s')."'";
                    $fechalimite  = $this->input->post('cuota_fechalimite');
                    $credito_fechalimite = "'".$fechalimite."'";
                    $cuota_cancelado = $this->input->post('cuota_cancelado');
           
              if ($credito_tipointeres==1){
                 $cuota_capital = $this->input->post('cuota_capital');
                 $reinteres = $this->input->post('cuota_interes');
                 $capital = $this->input->post('cuota_total');
                 $saldo = $this->input->post('cuota_saldo');
             $fijo = ($cuota_capital * $reinteres)/$capital;
             $cuota_subtotal = $fijo + $cuota_capital + $dias_mora + $multa;

            
                $total =  $cuota_subtotal - $descuento;
              $saldo_deudor = $saldo - $cuota_cancelado + $reinteres;

                $cuota_numcuota = $this->input->post('cuota_numcuota');
                
                  $cuota ="INSERT INTO cuota (credito_id,usuario_id,estado_id,cuota_numcuota,cuota_capital,cuota_interes,cuota_moradias,cuota_multa,cuota_descuento,cuota_cancelado,cuota_total,cuota_subtotal,cuota_fechalimite,cuota_fecha,cuota_saldo,cuota_hora) VALUES (".$credito_id.",".$usuario_id.",".$estado_id.",".$cuota_numcuota.",".$cuota_capital.",".$fijo.",".$dias_mora.",".$multa.",".$descuento.",".$cancelado.",".$total.",".$cuota_subtotal.",".$credito_fechalimite.",".$credito_fecha.",".$saldo_deudor.",".$credito_hora.")";
                $this->db->query($cuota);
  
               
               
              }
                else{
                     $cuota_capital = $this->input->post('cuota_capital');
                    $reinteres = $this->input->post('cuota_interes');
                     $saldo = $this->input->post('cuota_saldo');
                     $saldo_deudor = $saldo - $cuota_cancelado + $reinteres;
                    
            
              
                $variable = $saldo_deudor * ($interes/100);
                $cuota_subtotal = $variable + $cuota_capital + $dias_mora + $multa;
                $cuota_numcuota = $this->input->post('cuota_numcuota');
                $total =  $cuota_subtotal - $descuento;

                 $cuota ="INSERT INTO cuota (credito_id,usuario_id,estado_id,cuota_numcuota,cuota_capital,cuota_interes,cuota_moradias,cuota_multa,cuota_descuento,cuota_cancelado,cuota_total,cuota_subtotal,cuota_fechalimite,cuota_fecha,cuota_saldo,cuota_hora) VALUES (".$credito_id.",".$usuario_id.",".$estado_id.",".$cuota_numcuota.",".$cuota_capital.",".$variable.",".$dias_mora.",".$multa.",".$descuento.",".$cancelado.",".$total.",".$cuota_subtotal.",".$credito_fechalimite.",".$credito_fecha.",".$saldo_deudor.",".$credito_hora.")";
                $this->db->query($cuota);
               
              
                }

            }
    /*} else {
        if ($credito_monto > $maximo){
            $cuota_capital = $credito_monto/$numcuota;
             $fijo = $patron * $credito_monto * ($interes/100/$numcuota);
             $cuota_subtotal = $fijo + $cuota_capital + $dias_mora + $multa;;
             $total = $cuota_subtotal - $descuento;
                $saldo_deudor = $cuota_total;
            
                 $siguiente= 0;
                for ($i=1; $i <= $numcuota; $i++) { 

                $cuota_numcuota = $i;
                $proximo_martes2 = time() + ( ($diasgra+$siguiente-($nroDia-$diapago)) * 24 * 60 * 60 );
                               $credito_fechalimite = "'".date('Y-m-d', $proximo_martes2)."'";
                $cuota ="INSERT INTO cuota (credito_id,usuario_id,estado_id,cuota_numcuota,cuota_capital,cuota_interes,cuota_moradias,cuota_multa,cuota_descuento,cuota_cancelado,cuota_total,cuota_subtotal,cuota_fechalimite,cuota_fecha,cuota_saldo,cuota_hora) VALUES (".$credito_id.",".$usuario_id.",".$estado_id.",".$cuota_numcuota.",".$cuota_capital.",".$fijo.",".$dias_mora.",".$multa.",".$descuento.",".$cancelado.",".$total.",".$cuota_subtotal.",".$credito_fechalimite.",".$credito_fecha.",".$saldo_deudor.",".$credito_hora.")";
                $this->db->query($cuota);
                $siguiente = $siguiente+$periodo;
                $saldo_deudor = $cuota_total - $cuota_capital;
                $cuota_total = $saldo_deudor;
                }
             }
             else{
                $numcuota = 1;
                 $cuota_capital = $credito_monto/$numcuota;
             $fijo = $patron * $credito_monto * ($interes/100/$numcuota);
             $cuota_subtotal = $fijo + $cuota_capital + $dias_mora + $multa;;
             $total = $cuota_subtotal - $descuento;
                $saldo_deudor = $cuota_total;
            
                 $siguiente= 0;
                for ($i=1; $i <= $numcuota; $i++) { 

                $cuota_numcuota = $i;
                $proximo_martes2 = time() + ( ($diasgra+$siguiente-($nroDia-$diapago)) * 24 * 60 * 60 );
                               $credito_fechalimite = "'".date('Y-m-d', $proximo_martes2)."'";
                   $cuota ="INSERT INTO cuota (credito_id,usuario_id,estado_id,cuota_numcuota,cuota_capital,cuota_interes,cuota_moradias,cuota_multa,cuota_descuento,cuota_cancelado,cuota_total,cuota_subtotal,cuota_fechalimite,cuota_fecha,cuota_saldo,cuota_hora) VALUES (".$credito_id.",".$usuario_id.",".$estado_id.",".$cuota_numcuota.",".$cuota_capital.",".$fijo.",".$dias_mora.",".$multa.",".$descuento.",".$cancelado.",".$total.",".$cuota_subtotal.",".$credito_fechalimite.",".$credito_fecha.",".$saldo_deudor.",".$credito_hora.")";
                $this->db->query($cuota);
                $siguiente = $siguiente+$periodo;
                $saldo_deudor = $cuota_total - $cuota_capital;
                $cuota_total = $saldo_deudor;
             }
         }*/
            
            $credis = "SELECT COUNT(cuota_id) as 'creditango' FROM cuota  WHERE cuota.credito_id = ".$credito_id;
            $credingo = $this->db->query($credis)->result_array();
            $cuotis = "SELECT COUNT(cuota_id) as 'cuotanga' FROM cuota  WHERE cuota.estado_id = 9 and cuota.credito_id = ".$credito_id;
            $cuotinga = $this->db->query($cuotis)->result_array();
            
            


            if($cuotinga[0]['cuotanga'] == $credingo[0]['creditango']){
            $actualizar = "UPDATE credito SET credito.estado_id=9 WHERE credito.credito_id=".$credito_id;
            $this->db->query($actualizar);
            }


                 redirect('cuotum/deudas/'.$credito_id);  

            }
    }
    
    function cobrar($cuota_id)
    {
        $data['sistema'] = $this->sistema;
        $data['parametro'] = $this->parametros;
        
        if($this->acceso(47)){
            $usuario_id = $this->session_data['usuario_id'];
        $data['cuota'] = $this->Cuotum_model->get_cuotum($cuota_id);
       //  $data['cuota'] = $this->Cuotum_model->get_all_deuda($credito_id);
      
        $estado_id = 8;
        $cuota_id = $this->input->post('cuota_id');
         $num = $this->Cuotum_model->numero();
          $maximo = $num[0]['parametro_montomax'];
        $credito_id = $this->input->post('credito_id');
        $credito_tipointeres = $this->input->post('credito_tipointeres');
        $interes = $this->input->post('credito_interesproc');
        $cuota_capital = $this->input->post('cuota_capital');
        $facturado = $this->input->post('factura');
        $banco_id = $this->input->post('forma_pago') != 1 ? $this->input->post('banco'):'0';

        /////////////////la facturaaaa//////////////////
            if($facturado=="on"){
                $dosificacion = $this->Dosificacion_model->get_dosificacion_activa();

  //          if (sizeof($dosificacion)>0){ //si existe una dosificacion activa
                //$fecha = $this->input->post('ingreso_fecha');
                $estado1 = 1; 
                
                $venta_efectivo    = $this->input->post('cuota_cancelado');
                $factura_fechaventa    = date("Y-m-d");
                $factura_fecha         = "date(now())";
                $factura_hora          = "time(now())";
                $factura_subtotal      = $this->input->post('cuota_cancelado');
                $factura_nit           = $this->input->post('cuota_nit');
                $factura_razonsocial   = $this->input->post('cuota_razon');
                $factura_ice           = 0;
                $factura_exento        = 0;
                $factura_descuento     = 0;
                $factura_total         = $this->input->post('cuota_cancelado');
                $factura_numero        = $dosificacion[0]['dosificacion_numfact']+1;
                $factura_autorizacion  = $dosificacion[0]['dosificacion_autorizacion'];
                $factura_llave         = $dosificacion[0]['dosificacion_llave'];
                $factura_fechalimite   = $dosificacion[0]['dosificacion_fechalimite'];
                $factura_codigocontrol = $this->codigo_control($factura_llave, $factura_autorizacion, $factura_numero, $factura_nit, $factura_fechaventa, $factura_total);
                $factura_leyenda1       = $dosificacion[0]['dosificacion_leyenda1'];
                $factura_leyenda2       = $dosificacion[0]['dosificacion_leyenda2'];
                $factura_nitemisor     = $dosificacion[0]['dosificacion_nitemisor'];
                $factura_sucursal      = $dosificacion[0]['dosificacion_sucursal'];
                $factura_sfc           = $dosificacion[0]['dosificacion_sfc'];
                $factura_actividad     = $dosificacion[0]['dosificacion_actividad'];

                $sql = "update dosificacion set dosificacion_numfact = ".$factura_numero;
                $this->Ingreso_model->ejecutar($sql);
                            
                $sql = "insert into factura(estado_id, cuota_id, factura_fechaventa, 
                    factura_fecha, factura_hora, factura_subtotal, 
                    factura_ice, factura_exento, factura_descuento, factura_total, 
                    factura_numero, factura_autorizacion, factura_llave, 
                    factura_fechalimite, factura_codigocontrol, factura_leyenda1, factura_leyenda2,
                    factura_nit, factura_razonsocial, factura_nitemisor, factura_sucursal, factura_sfc, factura_actividad,
                    usuario_id, tipotrans_id, factura_efectivo, factura_cambio) value(".
                    $estado1.",".$cuota_id.",'".$factura_fechaventa."',".
                    $factura_fecha.",".$factura_hora.",".$factura_subtotal.",".
                    $factura_ice.",".$factura_exento.",".$factura_descuento.",".$factura_total.",".
                    $factura_numero.",".$factura_autorizacion.",'".$factura_llave."','".
                    $factura_fechalimite."','".$factura_codigocontrol."','".$factura_leyenda1."','".$factura_leyenda2."',".
                    $factura_nit.",'".$factura_razonsocial."','".$factura_nitemisor."','".
                    $factura_sucursal."','".$factura_sfc."','".$factura_actividad."',".
                    $usuario_id.",1,".$venta_efectivo.",0)";

                $factura_id = $this->Ingreso_model->ejecutar($sql);
               
            
            $producto_id = 0;
            $cantidad = 1;
            $detallefact_codigo = "-";
            $detallefact_cantidad = $cantidad;
            $detallefact_descripcion = $this->input->post('detalle');
            $unidad = "";
            
            $precio = $this->input->post('cuota_cancelado');
            $detallefact_precio = $precio;
            $detallefact_subtotal =  $precio;
            $detallefact_descuento = 0;
            $detallefact_total = $factura_subtotal;
            $detallefact_preferencia =  "";
            $detallefact_caracteristicas = "";
            
            $sql =  "insert into detalle_factura(
            producto_id,
            factura_id,
            detallefact_codigo,
            detallefact_unidad,
            detallefact_cantidad,            
            detallefact_descripcion,
            detallefact_precio,
            detallefact_subtotal,
            detallefact_descuento,
            detallefact_total,                
            detallefact_preferencia,
            detallefact_caracteristicas)
            
            value(
            ".$producto_id.",
            ".$factura_id.",
            '".$detallefact_codigo."',
            '".$unidad."',
            ".$detallefact_cantidad.",            
            '".$detallefact_descripcion."',
            ".$detallefact_precio.",
            ".$detallefact_subtotal.",
            ".$detallefact_descuento.",
            ".$detallefact_total.",                
            '".$detallefact_preferencia."',
            '".$detallefact_caracteristicas."')";

            $this->db->query($sql);
            $this->Ingreso_model->ejecutar($sql); 

            echo'<script type="text/javascript">
        window.open("../../factura/imprimir_factura_id/'.$factura_id.'/1", "_blank");
        </script>'; 


            }
        if($cuota_capital==0){
         $params = array(
                    
                    'usuario_id' => $usuario_id,
                    'estado_id' => $this->input->post('estado_id'),
                   // 'cuota_numcuota' => $this->input->post('cuota_numcuota'),
                    //'cuota_capital' => $this->input->post('cuota_capital'),
                    //'cuota_interes' => $this->input->post('cuota_interes'),
                    //'cuota_moradias' => $this->input->post('cuota_moradias'),
                    //'cuota_multa' => $this->input->post('cuota_multa'),
                   // 'cuota_subtotal' => $this->input->post('cuota_subtotal'),
                   // 'cuota_descuento' => $this->input->post('cuota_descuento'),
                    //'cuota_total' => $this->input->post('cuota_total'),
                   // 'cuota_fechalimite' => $this->input->post('cuota_fechalimite'),
                    'cuota_cancelado' => $this->input->post('cuota_cancelado'),
                    'cuota_fecha' => $this->input->post('cuota_fecha'),
                    'cuota_hora' => date('H:i:s'),
                    'cuota_numercibo' => $this->input->post('cuota_numercibo'),
                   // 'cuota_saldo' => $this->input->post('cuota_saldo'),
                    'cuota_glosa' => $this->input->post('cuota_forma_glosa'),
                    'forma_id' => $this->input->post('forma_pago'),
                    'cuota_forma_glosa' => $this->input->post('cuota_forma_glosa'),
                    'banco_id' => $banco_id,
                );


                $this->Cuotum_model->update_cuotum($cuota_id,$params); 
                 }   
             else{
                 $params = array(
                    
                   'usuario_id' => $usuario_id,
                    'estado_id' => $this->input->post('estado_id'),
                   // 'cuota_numcuota' => $this->input->post('cuota_numcuota'),
                    //'cuota_capital' => $this->input->post('cuota_capital'),
                    //'cuota_interes' => $this->input->post('cuota_interes'),
                    //'cuota_moradias' => $this->input->post('cuota_moradias'),
                    //'cuota_multa' => $this->input->post('cuota_multa'),
                   // 'cuota_subtotal' => $this->input->post('cuota_subtotal'),
                   // 'cuota_descuento' => $this->input->post('cuota_descuento'),
                    //'cuota_total' => $this->input->post('cuota_total'),
                   // 'cuota_fechalimite' => $this->input->post('cuota_fechalimite'),
                    'cuota_cancelado' => $this->input->post('cuota_cancelado'),
                    'cuota_fecha' => $this->input->post('cuota_fecha'),
                    'cuota_hora' => date('H:i:s'),
                    'cuota_numercibo' => $this->input->post('cuota_numercibo'),
                   // 'cuota_saldo' => $this->input->post('cuota_saldo'),
                    'cuota_glosa' => $this->input->post('cuota_glosa'),
                    'forma_id' => $this->input->post('forma_pago'),
                    'cuota_forma_glosa' => $this->input->post('cuota_forma_glosa'),
                    'banco_id' => $banco_id
                );


                $this->Cuotum_model->update_cuotum($cuota_id,$params); 
                 $dias_mora = 0;
                    $multa = 0;
                    $descuento = 0;
                    $cancelado = 0;
                    $credito_fecha = "'".date('d-m-Y')."'";
                    $credito_hora = "'".date('H:i:s')."'";
                    $fechalimite  = $this->input->post('cuota_fechalimite');
                    $credito_fechalimite = "'".$fechalimite."'";
                    $cuota_cancelado = $this->input->post('cuota_cancelado');
           
              if ($credito_tipointeres==1){
                 $cuota_capital = $this->input->post('cuota_capital');
                 $reinteres = $this->input->post('cuota_interes');
                 $capital = $this->input->post('cuota_total');
                 $saldo = $this->input->post('cuota_saldo');
             $fijo = ($cuota_capital * $reinteres)/$capital;
             $cuota_subtotal = $fijo + $cuota_capital + $dias_mora + $multa;

            
                $total =  $cuota_subtotal - $descuento;
              $saldo_deudor = $saldo - $cuota_cancelado + $reinteres;

                $cuota_numcuota = $this->input->post('cuota_numcuota');
                
                  $cuota ="INSERT INTO cuota (credito_id,usuario_id,estado_id,cuota_numcuota,cuota_capital,cuota_interes,cuota_moradias,cuota_multa,cuota_descuento,cuota_cancelado,cuota_total,cuota_subtotal,cuota_fechalimite,cuota_fecha,cuota_saldo,cuota_hora) VALUES (".$credito_id.",".$usuario_id.",".$estado_id.",".$cuota_numcuota.",".$cuota_capital.",".$fijo.",".$dias_mora.",".$multa.",".$descuento.",".$cancelado.",".$total.",".$cuota_subtotal.",".$credito_fechalimite.",".$credito_fecha.",".$saldo_deudor.",".$credito_hora.")";
                $this->db->query($cuota);
  
               
               
              }
                else{
                     $cuota_capital = $this->input->post('cuota_capital');
                    $reinteres = $this->input->post('cuota_interes');
                     $saldo = $this->input->post('cuota_saldo');
                     $saldo_deudor = $saldo - $cuota_cancelado + $reinteres;
                    
            
              
                $variable = $saldo_deudor * ($interes/100);
                $cuota_subtotal = $variable + $cuota_capital + $dias_mora + $multa;
                $cuota_numcuota = $this->input->post('cuota_numcuota');
                $total =  $cuota_subtotal - $descuento;

                 $cuota ="INSERT INTO cuota (credito_id,usuario_id,estado_id,cuota_numcuota,cuota_capital,cuota_interes,cuota_moradias,cuota_multa,cuota_descuento,cuota_cancelado,cuota_total,cuota_subtotal,cuota_fechalimite,cuota_fecha,cuota_saldo,cuota_hora) VALUES (".$credito_id.",".$usuario_id.",".$estado_id.",".$cuota_numcuota.",".$cuota_capital.",".$variable.",".$dias_mora.",".$multa.",".$descuento.",".$cancelado.",".$total.",".$cuota_subtotal.",".$credito_fechalimite.",".$credito_fecha.",".$saldo_deudor.",".$credito_hora.")";
                $this->db->query($cuota);
               
              
                }
            }
    /*} else {
        if ($credito_monto > $maximo){
            $cuota_capital = $credito_monto/$numcuota;
             $fijo = $patron * $credito_monto * ($interes/100/$numcuota);
             $cuota_subtotal = $fijo + $cuota_capital + $dias_mora + $multa;;
             $total = $cuota_subtotal - $descuento;
                $saldo_deudor = $cuota_total;
            
                 $siguiente= 0;
                for ($i=1; $i <= $numcuota; $i++) { 

                $cuota_numcuota = $i;
                $proximo_martes2 = time() + ( ($diasgra+$siguiente-($nroDia-$diapago)) * 24 * 60 * 60 );
                               $credito_fechalimite = "'".date('Y-m-d', $proximo_martes2)."'";
                $cuota ="INSERT INTO cuota (credito_id,usuario_id,estado_id,cuota_numcuota,cuota_capital,cuota_interes,cuota_moradias,cuota_multa,cuota_descuento,cuota_cancelado,cuota_total,cuota_subtotal,cuota_fechalimite,cuota_fecha,cuota_saldo,cuota_hora) VALUES (".$credito_id.",".$usuario_id.",".$estado_id.",".$cuota_numcuota.",".$cuota_capital.",".$fijo.",".$dias_mora.",".$multa.",".$descuento.",".$cancelado.",".$total.",".$cuota_subtotal.",".$credito_fechalimite.",".$credito_fecha.",".$saldo_deudor.",".$credito_hora.")";
                $this->db->query($cuota);
                $siguiente = $siguiente+$periodo;
                $saldo_deudor = $cuota_total - $cuota_capital;
                $cuota_total = $saldo_deudor;
                }
             }
             else{
                $numcuota = 1;
                 $cuota_capital = $credito_monto/$numcuota;
             $fijo = $patron * $credito_monto * ($interes/100/$numcuota);
             $cuota_subtotal = $fijo + $cuota_capital + $dias_mora + $multa;;
             $total = $cuota_subtotal - $descuento;
                $saldo_deudor = $cuota_total;
            
                 $siguiente= 0;
                for ($i=1; $i <= $numcuota; $i++) { 

                $cuota_numcuota = $i;
                $proximo_martes2 = time() + ( ($diasgra+$siguiente-($nroDia-$diapago)) * 24 * 60 * 60 );
                               $credito_fechalimite = "'".date('Y-m-d', $proximo_martes2)."'";
                   $cuota ="INSERT INTO cuota (credito_id,usuario_id,estado_id,cuota_numcuota,cuota_capital,cuota_interes,cuota_moradias,cuota_multa,cuota_descuento,cuota_cancelado,cuota_total,cuota_subtotal,cuota_fechalimite,cuota_fecha,cuota_saldo,cuota_hora) VALUES (".$credito_id.",".$usuario_id.",".$estado_id.",".$cuota_numcuota.",".$cuota_capital.",".$fijo.",".$dias_mora.",".$multa.",".$descuento.",".$cancelado.",".$total.",".$cuota_subtotal.",".$credito_fechalimite.",".$credito_fecha.",".$saldo_deudor.",".$credito_hora.")";
                $this->db->query($cuota);
                $siguiente = $siguiente+$periodo;
                $saldo_deudor = $cuota_total - $cuota_capital;
                $cuota_total = $saldo_deudor;
             }
         }*/

           $credis = "SELECT COUNT(cuota_id) as 'creditango' FROM cuota  WHERE cuota.credito_id = ".$credito_id;
            $credingo = $this->db->query($credis)->result_array();
            $cuotis = "SELECT COUNT(cuota_id) as 'cuotanga' FROM cuota  WHERE cuota.estado_id = 9 and cuota.credito_id = ".$credito_id;
            $cuotinga = $this->db->query($cuotis)->result_array();
           
            


           if($cuotinga[0]['cuotanga'] == $credingo[0]['creditango']){
            $actualizar = "UPDATE credito SET credito.estado_id=9 WHERE credito.credito_id=".$credito_id;
            $this->db->query($actualizar);
            }

              $servi="SELECT servicio_id as 'servico' FROM credito WHERE credito_id=".$credito_id." ";
              $servic=$this->db->query($servi)->result_array();
              if ($servic[0]['servico']>0) {
                 echo'<script type="text/javascript">
                 
        window.location.href="../cuenta_serv/'.$credito_id.'";
        </script>'; 
               } else {
                echo'<script type="text/javascript">
            
        window.location.href="../cuentas/'.$credito_id.'";
        </script>';  
                }
            }
    }

    function codigo_control($dosificacion_llave, $dosificacion_autorizacion, $dosificacion_numfact, $nit,$fecha_trans, $monto)
    {

        //include 'ControlCode.php';

        $code = $this->controlcode->generate($dosificacion_autorizacion,//Numero de autorizacion
                                                   $dosificacion_numfact,//Numero de factura
                                                   $nit,//Número de Identificación Tributaria o Carnet de Identidad
                                                   str_replace('-','',$fecha_trans),//fecha de transaccion de la forma AAAAMMDD
                                                   $monto,//Monto de la transacción
                                                   $dosificacion_llave//Llave de dosificación
                        );        
         return $code;
    }  

    function pendiente($cuota_id,$credito_id,$numcuota)
    {
        $data['sistema'] = $this->sistema;
        $data['parametro'] = $this->parametros;
        
        if($this->acceso(41)){
            $usuario_id = $this->session_data['usuario_id'];
            
            $sql = "UPDATE cuota SET estado_id=8,cuota_cancelado=0,cuota_fecha='0000-00-00', forma_id=null, cuota_numercibo = null, banco_id = 0 WHERE cuota.cuota_id=".$cuota_id." ";
            $this->db->query($sql);
            $ptq="DELETE FROM cuota WHERE cuota.cuota_numcuota = ".$numcuota." and cuota_id > ".$cuota_id." and cuota.credito_id=".$credito_id." and cuota.estado_id=8 ";
            $this->db->query($ptq);
            $credis = "SELECT COUNT(cuota_id) as 'creditango' FROM cuota  WHERE cuota.credito_id = ".$credito_id;
            $credingo = $this->db->query($credis)->result_array();
            $cuotis = "SELECT COUNT(cuota_id) as 'cuotanga' FROM cuota  WHERE cuota.estado_id = 9 and cuota.credito_id = ".$credito_id;
            $cuotinga = $this->db->query($cuotis)->result_array();
            
            


            if($cuotinga[0]['cuotanga'] != $credingo[0]['creditango']){
            $actualizar = "UPDATE credito SET credito.estado_id=8 WHERE credito.credito_id=".$credito_id;
            $this->db->query($actualizar);
            }

            redirect('cuotum/deudas/'.$credito_id);
        }
    }

    function pendiente1($cuota_id,$credito_id,$numcuota)
    {
        $data['sistema'] = $this->sistema;
        $data['parametro'] = $this->parametros;
        
        if($this->acceso(47)){
            $usuario_id = $this->session_data['usuario_id'];
            
            $sql = "UPDATE cuota SET estado_id=8,cuota_cancelado=0,cuota_fecha='0000-00-00', forma_id=null, cuota_numercibo = null, banco_id = 0 WHERE cuota.cuota_id=".$cuota_id." ";
            $this->db->query($sql);
            $ptq="DELETE FROM cuota WHERE cuota.cuota_numcuota = ".$numcuota." and cuota_id > ".$cuota_id." and cuota.credito_id=".$credito_id." and cuota.estado_id=8 ";
            $this->db->query($ptq);
             $credis = "SELECT COUNT(cuota_id) as 'creditango' FROM cuota  WHERE cuota.credito_id = ".$credito_id;
            $credingo = $this->db->query($credis)->result_array();
            $cuotis = "SELECT COUNT(cuota_id) as 'cuotanga' FROM cuota  WHERE cuota.estado_id = 9 and cuota.credito_id = ".$credito_id;
            $cuotinga = $this->db->query($cuotis)->result_array();
            
            


            if($cuotinga[0]['cuotanga'] != $credingo[0]['creditango']){
            $actualizar = "UPDATE credito SET credito.estado_id=8 WHERE credito.credito_id=".$credito_id;
            $this->db->query($actualizar);
            }
           $servi="SELECT servicio_id as 'servico' FROM credito WHERE credito_id=".$credito_id." ";
              $servic=$this->db->query($servi)->result_array();
              if ($servic[0]['servico']!=0) {
                 redirect('cuotum/cuenta_serv/'.$credito_id);
               } else {
                redirect('cuotum/cuentas/'.$credito_id);  
                } 
        }
    }


    function add()
    {
        $data['sistema'] = $this->sistema;
        $data['parametro'] = $this->parametros;
        
        if($this->acceso(41) or $this->acceso(47)){
            $data['page_title'] = "Cuota";
        if(isset($_POST) && count($_POST) > 0)     
        {   
            $params = array(
				'credito_id' => $this->input->post('credito_id'),
				'usuario_id' => $this->input->post('usuario_id'),
				'estado_id' => $this->input->post('estado_id'),
				'cuota_numcuota' => $this->input->post('cuota_numcuota'),
				'cuota_capital' => $this->input->post('cuota_capital'),
				'cuota_interes' => $this->input->post('cuota_interes'),
				'cuota_moradias' => $this->input->post('cuota_moradias'),
				'cuota_multa' => $this->input->post('cuota_multa'),
				'cuota_subtotal' => $this->input->post('cuota_subtotal'),
				'cuota_descuento' => $this->input->post('cuota_descuento'),
				'cuota_total' => $this->input->post('cuota_total'),
				'cuota_fechalimite' => $this->input->post('cuota_fechalimite'),
				'cuota_cancelado' => $this->input->post('cuota_cancelado'),
				'cuota_fecha' => $this->input->post('cuota_fecha'),
				'cuota_hora' => $this->input->post('cuota_hora'),
				'cuota_numercibo' => $this->input->post('cuota_numercibo'),
				'cuota_saldo' => $this->input->post('cuota_saldo'),
				'cuota_glosa' => $this->input->post('cuota_glosa'),
            );
            
            $cuotum_id = $this->Cuotum_model->add_cuotum($params);
            redirect('cuotum/index');
        }
        else
        {
			$this->load->model('Credito_model');
			$data['all_credito'] = $this->Credito_model->get_all_credito();

			$this->load->model('Usuario_model');
			$data['all_usuario'] = $this->Usuario_model->get_all_usuario();

			$this->load->model('Estado_model');
			$data['all_estado'] = $this->Estado_model->get_all_estado();
            
            $data['_view'] = 'cuotum/add';
            $this->load->view('layouts/main',$data);
        }
        }
    }  
    /*
     * Adding a new cuotum
     */
   
    /*
     * Editing a cuotum
     */
    function edit($cuota_id)
    {
        $data['sistema'] = $this->sistema;
        $data['parametro'] = $this->parametros;
        
        
        if($this->acceso(41)){
            $data['page_title'] = "Cuota";
            $usuario_id = $this->session_data['usuario_id'];
        // check if the cuotum exists before trying to edit it
        $data['cuotum'] = $this->Cuotum_model->get_cuotum($cuota_id);
        $credito_id = $this->input->post('credito_id');
        if(isset($data['cuotum']['cuota_id']))
        {
            if(isset($_POST) && count($_POST) > 0)     
            {   
                $params = array(
					'credito_id' => $this->input->post('credito_id'),
					'usuario_id' => $usuario_id,
					'estado_id' => 8,
					'cuota_numcuota' => $this->input->post('cuota_numcuota'),
					'cuota_capital' => $this->input->post('cuota_capital'),
					'cuota_interes' => $this->input->post('cuota_interes'),
					'cuota_moradias' => $this->input->post('cuota_moradias'),
					'cuota_multa' => $this->input->post('cuota_multa'),
					'cuota_subtotal' => $this->input->post('cuota_subtotal'),
					'cuota_descuento' => $this->input->post('cuota_descuento'),
					'cuota_total' => $this->input->post('cuota_total'),
					'cuota_fechalimite' => $this->input->post('cuota_fechalimite'),
					'cuota_cancelado' => $this->input->post('cuota_cancelado'),
					//'cuota_fecha' =>  date('Y-m-d'),
					//'cuota_hora' => date('H:i:s'),
					'cuota_numercibo' => $this->input->post('cuota_numercibo'),
					'cuota_saldo' => $this->input->post('cuota_saldo'),
					'cuota_glosa' => $this->input->post('cuota_glosa'),
                );

                $this->Cuotum_model->update_cuotum($cuota_id,$params);            
                redirect('cuotum/deudas/'.$credito_id); 
            }
            else
            {
				$this->load->model('Credito_model');
				$data['all_credito'] = $this->Credito_model->get_all_credito();

				$this->load->model('Usuario_model');
				$data['all_usuario'] = $this->Usuario_model->get_all_usuario();

				$this->load->model('Estado_model');
				$data['all_estado'] = $this->Estado_model->get_all_estado();

                $data['_view'] = 'cuotum/edit';
                $this->load->view('layouts/main',$data);
            }
        }
        else
            show_error('The cuotum you are trying to edit does not exist.');
    }
    }
    
     function editar($cuota_id)
    {
        $data['sistema'] = $this->sistema;
        $data['parametro'] = $this->parametros;
         
        if($this->acceso(47)){
             $data['page_title'] = "Cuota";
            $usuario_id = $this->session_data['usuario_id'];
     
        // check if the cuotum exists before trying to edit it
        $data['tipo'] = $this->Cuotum_model->get_tipo($cuota_id);
        $data['cuotum'] = $this->Cuotum_model->get_cuotum($cuota_id);
        $credito_id = $this->input->post('credito_id');
        
        if(isset($data['cuotum']['cuota_id']))
        {
            if(isset($_POST) && count($_POST) > 0)     
            {   
                $params = array(
                    'credito_id' => $this->input->post('credito_id'),
                    'usuario_id' => $usuario_id,
                    'estado_id' => 8,
                    'cuota_numcuota' => $this->input->post('cuota_numcuota'),
                    'cuota_capital' => $this->input->post('cuota_capital'),
                    'cuota_interes' => $this->input->post('cuota_interes'),
                    'cuota_moradias' => $this->input->post('cuota_moradias'),
                    'cuota_multa' => $this->input->post('cuota_multa'),
                    'cuota_subtotal' => $this->input->post('cuota_subtotal'),
                    'cuota_descuento' => $this->input->post('cuota_descuento'),
                    'cuota_total' => $this->input->post('cuota_total'),
                    'cuota_fechalimite' => $this->input->post('cuota_fechalimite'),
                    'cuota_cancelado' => $this->input->post('cuota_cancelado'),
                    //'cuota_fecha' =>  date('Y-m-d'),
                    //'cuota_hora' => date('H:i:s'),
                    'cuota_numercibo' => $this->input->post('cuota_numercibo'),
                    'cuota_saldo' => $this->input->post('cuota_saldo'),
                    'cuota_glosa' => $this->input->post('cuota_glosa'),
                );

                $this->Cuotum_model->update_cuotum($cuota_id,$params); 
                if ($data['tipo']['servicio_id']>0) {
                 redirect('cuotum/cuenta_serv/'.$credito_id);
                } else {
                redirect('cuotum/cuentas/'.$credito_id);  
                }           
            }
            else
            {
                $this->load->model('Credito_model');
                $data['all_credito'] = $this->Credito_model->get_all_credito();

                $this->load->model('Usuario_model');
                $data['all_usuario'] = $this->Usuario_model->get_all_usuario();

                $this->load->model('Estado_model');
                $data['all_estado'] = $this->Estado_model->get_all_estado();

                $data['_view'] = 'cuotum/editar';
                $this->load->view('layouts/main',$data);
            }
        }
        else
            show_error('The cuotum you are trying to edit does not exist.');
        }
    }

    function detallecuota()
    {
      $cuota_id = $this->input->post('cuota');
      $cuotum = $this->Cuotum_model->get_cuotum($cuota_id);
      echo json_encode($cuotum);
    }
    /*
     * Deleting cuotum
     */
    function remove($cuota_id,$credito_id)
    {
        $data['parametro'] = $this->parametros;
        $data['sistema'] = $this->sistema;
        
        if($this->acceso(41)){
            $cuotum = $this->Cuotum_model->get_cuotum($cuota_id);

            // check if the cuotum exists before trying to delete it
            if(isset($cuotum['cuota_id']))
            {
                $this->Cuotum_model->delete_cuotum($cuota_id);
                redirect('cuotum/deudas/'.$credito_id);
            }
            else
                show_error('The cuotum you are trying to delete does not exist.');
        }
    }

    function remover($cuota_id,$credito_id)
    {
        if($this->acceso(47)){
            $cuotum = $this->Cuotum_model->get_cuotum($cuota_id);

            // check if the cuotum exists before trying to delete it
            if(isset($cuotum['cuota_id']))
            {
                $this->Cuotum_model->delete_cuotum($cuota_id);
                redirect('cuotum/cuentas/'.$credito_id);
            }
            else
                show_error('The cuotum you are trying to delete does not exist.');
        }
    }
    
}
