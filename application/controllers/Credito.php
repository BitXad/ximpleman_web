<?php
/* 
 * Generated by CRUDigniter v3.2 
 * www.crudigniter.com
 */
 
class Credito extends CI_Controller{
    private $session_data = "";
    private $sistema;
    private $parametros;

    
    function __construct()
    {
        parent::__construct();
        $this->load->model('Credito_model');
        $this->load->model('Empresa_model');
        $this->load->model('Cuotum_model');
        $this->load->model('Compra_model');
        $this->load->model('Usuario_model');
        $this->load->model('Parametro_model');
        if ($this->session->userdata('logged_in')) {
            $this->session_data = $this->session->userdata('logged_in');
        }else {
            redirect('', 'refresh');
        }
        $this->load->model('Sistema_model');
	$this->sistema = $this->Sistema_model->get_sistema();
        $parametro = $this->Parametro_model->get_parametros();
        $this->parametros = $parametro[0];        
        
    }
    /* *****Funcion que verifica el acceso al sistema**** */
    private function acceso($id_rol){
        $data['sistema'] = $this->sistema;
        $rolusuario = $this->session_data['rol'];
        if($rolusuario[$id_rol-1]['rolusuario_asignado'] == 1){
            return true;
        }else{
            $data['_view'] = 'login/mensajeacceso';
            $this->load->view('layouts/main',$data);
        }
    }
    /*
     * Listing of credito
     */
    function index()
    {
        $data['sistema'] = $this->sistema;
        $data['parametro'] =  $this->parametros;
        
        if($this->acceso(41)){
            
            $this->indexDeuda();
            
//            $data['page_title'] = "Creditos";
//            $params['limit'] = RECORDS_PER_PAGE; 
//            $params['offset'] = ($this->input->get('per_page')) ? $this->input->get('per_page') : 0;
//
//            $config = $this->config->item('pagination');
//            $config['base_url'] = site_url('credito/index?');
//            $config['total_rows'] = $this->Credito_model->get_all_credito_count();
//            $this->pagination->initialize($config);
//
//            
//            $credito = $this->Credito_model->get_all_deuda($params);
//            $data['credito'] = $credito;
            
        }
    }

    
    function indexDeuda()
    {
        $data['parametro'] =  $this->parametros;
        $data['sistema'] = $this->sistema;
        $num = $this->Compra_model->numero();
        $permiso = $num[0]['parametro_permisocredito'];
        $usuario_id = $this->session_data['usuario_id'];
        $tipo_usuario = $this->session_data['tipousuario_id'];

        if($this->acceso(41) && $tipo_usuario>1 && $permiso==2){
            $condicion = " and co.usuario_id=".$usuario_id."";
            $data['page_title'] = "Deudas x Pagar";
            $data['rol'] = $this->session_data['rol'];
            $data['cuota'] = $this->Cuotum_model->get_all_cuota();
            $data['empresa'] = $this->Empresa_model->get_empresa(1);
            $data['all_usuario'] = $this->Usuario_model->get_all_usuario_activo();
            $data['_view'] = 'credito/indexDeuda';
            $this->load->view('layouts/main',$data);
        }
        else{
            $condicion = "";
            $data['page_title'] = "Deudas x Pagar";
            $data['rol'] = $this->session_data['rol'];
            $data['cuota'] = $this->Cuotum_model->get_all_cuota();
            $data['empresa'] = $this->Empresa_model->get_empresa(1);
            $data['all_usuario'] = $this->Usuario_model->get_all_usuario_activo();
            $data['_view'] = 'credito/indexDeuda';
            $this->load->view('layouts/main',$data);
        }
    }
    
    function repoDeudas()
    {
        $data['parametro'] =  $this->parametros;
        $data['sistema'] = $this->sistema;
        if($this->acceso(41)){
            $data['page_title'] = "Deudas x Pagar";
            $estado_id = $this->input->post('esti');
            $usu = $this->input->post('usu');
            $feini = $this->input->post('feini');
            $fefin = $this->input->post('fefin');
            $vende = $this->input->post('vendedor');
            $agrupar = $this->input->post('agrupar');
            if ($estado_id ==''){
                $estadosi='';
            }else{
                $estadosi="and c.estado_id = ".$estado_id." ";
            }
            if ($vende ==''){
                $vendedor='';
            }else{
                $vendedor="and co.usuario_id=".$vende." ";
            }
            if ($feini =='' && $fefin ==''){
                $filtro = " p.proveedor_nombre like '%".$usu."%' ".$estadosi." ".$vendedor." ";   
            } else {
                $filtro = " p.proveedor_nombre like '%".$usu."%' ".$estadosi." and c.credito_fecha >= '".$feini."' and c.credito_fecha <= '".$fefin."'  ".$vendedor." ";
            }

            
           
            $data['empresa'] = $this->Empresa_model->get_empresa(1);
            $data['credito'] = $this->Credito_model->filtrodeudas($filtro);
            $data['cuota'] = $this->Cuotum_model->get_cuota_compra();
            $data['agrupar'] = $agrupar;
            $data['_view'] = 'credito/repoDeudas';
            $this->load->view('layouts/main',$data);
        }
    }
    
     function indexCuenta()
    {
        $data['parametro'] =  $this->parametros;
        $data['sistema'] = $this->sistema;
        $num = $this->Compra_model->numero();
        $permiso = $num[0]['parametro_permisocredito'];
        $usuario_id = $this->session_data['usuario_id'];
        $tipo_usuario = $this->session_data['tipousuario_id'];
         if($this->acceso(47) && $tipo_usuario>1 && $permiso==2){
            $condicion = " and ve.usuario_id=".$usuario_id." or s.usuario_id=".$usuario_id." ";
            $data['page_title'] = "Cuentas x Cobrar";
            $data['rol'] = $this->session_data['rol'];
            $data['all_usuario'] = $this->Usuario_model->get_all_usuario_activo();
            $data['cuota'] = $this->Cuotum_model->get_all_cuota();
            $data['empresa'] = $this->Empresa_model->get_empresa(1);
            $data['_view'] = 'credito/indexCuentas';
            $this->load->view('layouts/main',$data);
        }
        else{
           $condicion = "";
           
            $data['page_title'] = "Cuentas x Cobrar";
            $data['rol'] = $this->session_data['rol'];
            $data['all_usuario'] = $this->Usuario_model->get_all_usuario_activo();
            $data['cuota'] = $this->Cuotum_model->get_cuota_venta();
            $data['empresa'] = $this->Empresa_model->get_empresa(1);
            $data['_view'] = 'credito/indexCuentas';
            $this->load->view('layouts/main',$data); 
        }
    }

    function repoCuentas()
    {
        $data['parametro'] =  $this->parametros;
        $data['sistema'] = $this->sistema;
        if($this->acceso(47)){
            $data['page_title'] = "Cuentas x Cobrar";
            $estado_id = $this->input->post('esti');
            $usu = $this->input->post('usu');
            $feini = $this->input->post('feini');
            $fefin = $this->input->post('fefin');
            $vende = $this->input->post('vendedor');
            $agrupar = $this->input->post('agrupar');
            if ($estado_id ==''){
                $estadosi='';
            }else{
                $estadosi="and c.estado_id = ".$estado_id." ";
            }
            if ($vende ==''){
                $vendedor='';
            }else{
                $vendedor="and ve.usuario_id=".$vende." ";
            }
            if ($feini =='' && $fefin ==''){
                $filtro = " (p.cliente_nombre like '%".$usu."%' or r.cliente_nombre  like '%".$usu."%') ".$estadosi."  ".$vendedor." ";   
            } else {
                $filtro = " (p.cliente_nombre like '%".$usu."%' or r.cliente_nombre  like '%".$usu."%')  and c.credito_fecha >= '".$feini."' and c.credito_fecha <= '".$fefin."' ".$estadosi." ".$vendedor." ";
            }
           

            $data['page_title'] = "Reporte"; 
            $data['empresa'] = $this->Empresa_model->get_empresa(1);
            $data['credito'] = $this->Credito_model->filtrocuentas($filtro);
            $data['agrupar'] = $agrupar;
            $data['cuota'] = $this->Cuotum_model->get_cuota_venta();
            $data['_view'] = 'credito/repoCuentas';
            $this->load->view('layouts/main',$data);
        }
    }

    function buscarDeuda()
    {
        $data['parametro'] =  $this->parametros;
        $num = $this->Compra_model->numero();
        $permiso = $num[0]['parametro_permisocredito'];
        $usuario_id = $this->session_data['usuario_id'];
        $tipo_usuario = $this->session_data['tipousuario_id'];
        
        if ($tipo_usuario>1 && $permiso==2) {
           $condicion = " and co.usuario_id=".$usuario_id."";
        }else{
           $condicion = "";
        }
        
         if ($this->input->is_ajax_request()) {  
        $filtro = $this->input->post('filtro');
         
        $datos = $this->Credito_model->get_deudas($filtro,$condicion);
        echo json_encode($datos);
        }     
         
    }

    function buscarDeudaAgrupado()
    {
        $data['parametro'] =  $this->parametros;
        $num = $this->Compra_model->numero();
        $permiso = $num[0]['parametro_permisocredito'];
        $usuario_id = $this->session_data['usuario_id'];
        $tipo_usuario = $this->session_data['tipousuario_id'];
        
        if ($tipo_usuario>1 && $permiso==2) {
           $condicion = " and co.usuario_id=".$usuario_id."";
        }else{
           $condicion = "";
        }
        
         if ($this->input->is_ajax_request()) {  
        $filtro = $this->input->post('filtro');
         
        $datos = $this->Credito_model->get_deudasagrupado($filtro,$condicion);
        echo json_encode($datos);
        }     
         
    }

     function buscarCuenta()
    {
        $data['parametro'] =  $this->parametros;
        $num = $this->Compra_model->numero();
        $permiso = $num[0]['parametro_permisocredito'];
        $usuario_id = $this->session_data['usuario_id'];
        $tipo_usuario = $this->session_data['tipousuario_id'];
        
        if ($tipo_usuario>1 && $permiso==2) {
           $condicion = " and ve.usuario_id=".$usuario_id." or s.usuario_id=".$usuario_id." ";
        }else{
           $condicion = "";
        }
         if ($this->input->is_ajax_request()) {  
        $filtro = $this->input->post('filtro'); 
        $datos = $this->Credito_model->get_cuentas($filtro,$condicion);
     
        echo json_encode($datos);
                   
        }
        
    }

     function buscarCuentaAgrupado()
    {
        $data['parametro'] =  $this->parametros;
        $num = $this->Compra_model->numero();
        $permiso = $num[0]['parametro_permisocredito'];
        $usuario_id = $this->session_data['usuario_id'];
        $tipo_usuario = $this->session_data['tipousuario_id'];
        if ($tipo_usuario>1 && $permiso==2) {
           $condicion = " and ve.usuario_id=".$usuario_id." or s.usuario_id=".$usuario_id." ";
        }else{
           $condicion = "";
        }
         if ($this->input->is_ajax_request()) {  
        $filtro = $this->input->post('filtro'); 
        $datos = $this->Credito_model->get_cuentasagrupado($filtro,$condicion);
     
        echo json_encode($datos);
                   
        }
        
    }
    /*
     * Adding a new credito
     */
    function add()
    {
        $data['parametro'] =  $this->parametros;
        $data['sistema'] = $this->sistema;
        if($this->acceso(41)){
            if(isset($_POST) && count($_POST) > 0)     
            {   
                $params = array(
                    'estado_id' => $this->input->post('estado_id'),
                    'compra_id' => $this->input->post('compra_id'),
                    'venta_id' => $this->input->post('venta_id'),
                    'credito_monto' => $this->input->post('credito_monto'),
                    'credito_cuotainicial' => $this->input->post('credito_cuotainicial'),
                    'credito_interesproc' => $this->input->post('credito_interesproc'),
                    'credito_interesmonto' => $this->input->post('credito_interesmonto'),
                    'credito_numpagos' => $this->input->post('credito_numpagos'),
                    'credito_fecha' => $this->input->post('credito_fecha'),
                    'credito_fechalimite' => $this->input->post('credito_fechalimite'),
                    'credito_hora' => $this->input->post('credito_hora'),
                    'credito_tipo' => $this->input->post('credito_tipo'),
            );
            
                $credito_id = $this->Credito_model->add_credito($params);
                redirect('credito/index');
            }
            else
            {            
                $data['_view'] = 'credito/add';
                $this->load->view('layouts/main',$data);
            }
        }
    } 

    /*
     * Editing a credito
     */
    function edit($credito_id)
    {
        $data['parametro'] =  $this->parametros;
        $data['sistema'] = $this->sistema;
        if($this->acceso(41)){
            // check if the credito exists before trying to edit it
            $data['credito'] = $this->Credito_model->get_credito($credito_id);

            if(isset($data['credito']['credito_id']))
            {
                if(isset($_POST) && count($_POST) > 0)     
                {   
                    $params = array(
                        'estado_id' => $this->input->post('estado_id'),
                        'compra_id' => $this->input->post('compra_id'),
                        'venta_id' => $this->input->post('venta_id'),
                        'credito_monto' => $this->input->post('credito_monto'),
                        'credito_cuotainicial' => $this->input->post('credito_cuotainicial'),
                        'credito_interesproc' => $this->input->post('credito_interesproc'),
                        'credito_interesmonto' => $this->input->post('credito_interesmonto'),
                        'credito_numpagos' => $this->input->post('credito_numpagos'),
                        'credito_fechalimite' => $this->input->post('credito_fechalimite'),
                        'credito_fecha' => $this->input->post('credito_fecha'),
                        'credito_hora' => $this->input->post('credito_hora'),
                        'credito_tipo' => $this->input->post('credito_tipo'),
                    );

                    $this->Credito_model->update_credito($credito_id,$params);            
                    redirect('credito/index');
                }
                else
                {
                    $data['_view'] = 'credito/edit';
                    $this->load->view('layouts/main',$data);
                }
            }
            else
                show_error('The credito you are trying to edit does not exist.');
        }
    } 

    /*
     * Deleting credito
     */
    function remove($credito_id)
    {
        $data['sistema'] = $this->sistema;
        if($this->acceso(41)){
            $credito = $this->Credito_model->get_credito($credito_id);

            // check if the credito exists before trying to delete it
            if(isset($credito['credito_id']))
            {
                $this->Credito_model->delete_credito($credito_id);
                redirect('credito/index');
            }
            else
                show_error('The credito you are trying to delete does not exist.');
        }
    }

    function cargar_factura()
    {
        $venta_id = $this->input->post('venta_id');
         
        $datos = $this->Credito_model->get_ventas($venta_id);
        echo json_encode($datos);
    }
    
}
